import{r as d,j as s}from"./vendor-react-BsSNOS8Q.js";import{c as He,d as Le,z as zt,e as Ve,u as or,A as lr,C as cr,M as nn,t as ke,B as Re,w as xt}from"./index-CXxuRmRL.js";import{b7 as Zr}from"./vendor-icons-BJR3KiwM.js";import{u as ur}from"./useQuery-BAvNBmJW.js";import{S as ln,a as cn,b as un,c as dn,d as Zt}from"./select-Dn4Q1m5w.js";import{o as dr,u as Xr}from"./useOptionChainLive-D8EiNyoD.js";import{u as y,t as Te}from"./trading-Cl8N_6AG.js";import{q as pr,K as fr,W as mr,R as xr,n as Mt,h as Pt}from"./lightweight-charts.production-fmEoZjtL.js";import{a as hn}from"./useMarketStatus-BBZacYB1.js";import{I as kt}from"./input-CId4lT9F.js";import{L as ot}from"./label-Cmj6D9xt.js";import{S as mn}from"./switch-wGsEVPQ-.js";import{a as Qr,r as Jr,b as ei,c as ti}from"./ai-scalper-BjER1TWu.js";import{u as ni}from"./useLivePrice-CI_9vt-K.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function De(e,t="Assertion error"){if(!e)throw Error(t)}function sn({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function Xn(e,t){return t.sort(e==="horizontal"?si:ri)}function si(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function ri(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function hr(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function gr(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function ii({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:c,y:l}=gr(r,o),u=e==="horizontal"?c:l;u<a&&(a=u,i=o)}return De(i,"No rect found"),i}let jn;function ai(){return jn===void 0&&(typeof matchMedia=="function"?jn=!!matchMedia("(pointer:coarse)").matches:jn=!1),jn}function yr(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=Xn(n,Array.from(t.children).filter(hr).map(p=>({element:p}))).map(({element:p})=>p),o=[];let c=!1,l,u=[];for(const p of a)if(p.hasAttribute("data-panel")){const f=r.find(b=>b.element===p);if(f){if(l){const b=l.element.getBoundingClientRect(),g=p.getBoundingClientRect();let h;if(c){const m=n==="horizontal"?new DOMRect(b.right,b.top,0,b.height):new DOMRect(b.left,b.bottom,b.width,0),j=n==="horizontal"?new DOMRect(g.left,g.top,0,g.height):new DOMRect(g.left,g.top,g.width,0);switch(u.length){case 0:{h=[m,j];break}case 1:{const P=u[0],k=ii({orientation:n,rects:[b,g],targetRect:P.element.getBoundingClientRect()});h=[P,k===b?j:m];break}default:{h=u;break}}}else u.length?h=u:h=[n==="horizontal"?new DOMRect(b.right,g.top,g.left-b.right,g.height):new DOMRect(g.left,b.bottom,g.width,g.top-b.bottom)];for(const m of h){let j="width"in m?m:m.element.getBoundingClientRect();const P=ai()?37:27;if(j.width<P){const k=P-j.width;j=new DOMRect(j.x-k/2,j.y,j.width+k,j.height)}if(j.height<P){const k=P-j.height;j=new DOMRect(j.x,j.y-k/2,j.width,j.height+k)}o.push({group:e,groupSize:sn({group:e}),panels:[l,f],separator:"width"in m?void 0:m,rect:j})}}c=!1,l=f,u=[]}}else if(p.hasAttribute("data-separator")){const f=i.find(b=>b.element===p);f?u.push(f):(l=void 0,u=[])}else c=!0;return o}function oi(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function li(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function ci(e){return e/100*window.innerHeight}function ui(e){return e/100*window.innerWidth}function di(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function Nn({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=di(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=li(t,i);break}case"em":{r=oi(t,i);break}case"vh":{r=ci(i);break}case"vw":{r=ui(i);break}}return r}function ht(e){return parseFloat(e.toFixed(3))}function ms(e){const{panels:t}=e,n=sn({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=ht(p/n*100)}let c;if(a.defaultSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.defaultSize});c=ht(p/n*100)}let l=0;if(a.minSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.minSize});l=ht(p/n*100)}let u=100;if(a.maxSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.maxSize});u=ht(p/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:c,minSize:l,maxSize:u,panelId:r.id}})}class pi{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let c=0;c<o.length;c++){const l=o[c];try{l.call(null,n)}catch(u){a===null&&(i=!0,a=u)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function nt(e,t,n=0){return Math.abs(ht(e)-ht(t))<=n}let dt={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const Vt=new pi;function lt(){return dt}function it(e){const t=typeof e=="function"?e(dt):e;if(dt===t)return dt;const n=dt;return dt={...dt,...t},t.cursorFlags!==void 0&&Vt.emit("cursorFlagsChange",dt.cursorFlags),t.interactionState!==void 0&&Vt.emit("interactionStateChange",dt.interactionState),t.mountedGroups!==void 0&&(dt.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const c=nt(a.collapsedSize,r.layout[a.panelId]),l=nt(a.collapsedSize,o[a.panelId]);c&&!l&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),Vt.emit("mountedGroupsChange",dt.mountedGroups)),dt}function fi(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=gr(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function mi(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function xi(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:gs(e),b:gs(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;De(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:hs(xs(n.a)),b:hs(xs(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let c=a.length;for(;c--;){const l=a[c];if(l===o.a)return 1;if(l===o.b)return-1}}return Math.sign(i.a-i.b)}const hi=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function gi(e){const t=getComputedStyle(br(e)??e).display;return t==="flex"||t==="inline-flex"}function yi(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||gi(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||hi.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function xs(e){let t=e.length;for(;t--;){const n=e[t];if(De(n,"Missing node"),yi(n))return n}return null}function hs(e){return e&&Number(getComputedStyle(e).zIndex)||0}function gs(e){const t=[];for(;e;)t.push(e),e=br(e);return t}function br(e){const{parentNode:t}=e;return mi(t)?t.host:t}function bi(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function vi({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!hr(n)||n.contains(e)||e.contains(n))return!0;if(xi(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(bi(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function ns(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=yr(i),o=fi(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&vi({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function Si(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function bn(e,t){return nt(e,t)?0:e>t?1:-1}function tn({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(bn(t,a)<0)if(r){const o=(n+a)/2;bn(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=ht(t),t}function vn({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if(nt(e,0))return t;const o=Object.values(t),c=Object.values(i),l=[...o],[u,p]=r;De(u!=null,"Invalid first pivot index"),De(p!=null,"Invalid second pivot index");let f=0;if(a==="keyboard"){{const h=e<0?p:u,m=n[h];De(m,`Panel constraints not found for index ${h}`);const{collapsedSize:j=0,collapsible:P,minSize:k=0}=m;if(P){const L=o[h];if(De(L!=null,`Previous layout not found for panel index ${h}`),nt(L,j)){const M=k-L;bn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}{const h=e<0?u:p,m=n[h];De(m,`No panel constraints found for index ${h}`);const{collapsedSize:j=0,collapsible:P,minSize:k=0}=m;if(P){const L=o[h];if(De(L!=null,`Previous layout not found for panel index ${h}`),nt(L,k)){const M=L-j;bn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}}{const h=e<0?1:-1;let m=e<0?p:u,j=0;for(;;){const k=o[m];De(k!=null,`Previous layout not found for panel index ${m}`);const L=tn({panelConstraints:n[m],size:100})-k;if(j+=L,m+=h,m<0||m>=n.length)break}const P=Math.min(Math.abs(e),Math.abs(j));e=e<0?0-P:P}{let h=e<0?u:p;for(;h>=0&&h<n.length;){const m=Math.abs(e)-Math.abs(f),j=o[h];De(j!=null,`Previous layout not found for panel index ${h}`);const P=j-m,k=tn({panelConstraints:n[h],size:P});if(!nt(j,k)&&(f+=j-k,l[h]=k,f.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?h--:h++}}if(Si(c,l))return i;{const h=e<0?p:u,m=o[h];De(m!=null,`Previous layout not found for panel index ${h}`);const j=m+f,P=tn({panelConstraints:n[h],size:j});if(l[h]=P,!nt(P,j)){let k=j-P,L=e<0?p:u;for(;L>=0&&L<n.length;){const M=l[L];De(M!=null,`Previous layout not found for panel index ${L}`);const w=M+k,D=tn({panelConstraints:n[L],size:w});if(nt(M,D)||(k-=D-M,l[L]=D),nt(k,0))break;e>0?L--:L++}}}const b=Object.values(l).reduce((h,m)=>m+h,0);if(!nt(b,100,.1))return i;const g=Object.keys(i);return l.reduce((h,m,j)=>(h[g[j]]=m,h),{})}function qt(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||bn(e[n],t[n])!==0)return!1;return!0}function Kt({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,c)=>o+c,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!nt(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const c=n[o];De(c!=null,`No layout data found for index ${o}`);const l=100/r*c;n[o]=l}let i=0;for(let o=0;o<t.length;o++){const c=n[o];De(c!=null,`No layout data found for index ${o}`);const l=tn({panelConstraints:t[o],size:c});c!=l&&(i+=c-l,n[o]=l)}if(!nt(i,0))for(let o=0;o<t.length;o++){const c=n[o];De(c!=null,`No layout data found for index ${o}`);const l=c+i,u=tn({panelConstraints:t[o],size:l});if(c!==u&&(i-=u-c,n[o]=u,nt(i,0)))break}const a=Object.keys(e);return n.reduce((o,c,l)=>(o[a[l]]=c,o),{})}function vr({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:c}=lt();for(const[l,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:f,separatorToPanels:b}]of c)if(l.id===e)return{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:l,layout:f,separatorToPanels:b};throw Error(`Group ${e} not found`)},r=()=>{const c=n().derivedPanelConstraints.find(l=>l.panelId===t);if(c!==void 0)return c;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const c=n().group.panels.find(l=>l.id===t);if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const c=n().layout[t];if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},o=c=>{const l=a();if(c===l)return;const{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:f,layout:b,separatorToPanels:g}=n(),h=f.panels.findIndex(k=>k.id===t),m=h===f.panels.length-1,j=vn({delta:m?l-c:c-l,initialLayout:b,panelConstraints:p,pivotIndices:m?[h-1,h]:[h,h+1],prevLayout:b,trigger:"imperative-api"}),P=Kt({layout:j,panelConstraints:p});qt(b,P)||it(k=>({mountedGroups:new Map(k.mountedGroups).set(f,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:P,separatorToPanels:g})}))};return{collapse:()=>{const{collapsible:c,collapsedSize:l}=r(),{mutableValues:u}=i(),p=a();c&&p!==l&&(u.expandToSize=p,o(l))},expand:()=>{const{collapsible:c,collapsedSize:l,minSize:u}=r(),{mutableValues:p}=i(),f=a();if(c&&f===l){let b=p.expandToSize??u;b===0&&(b=1),o(b)}},getSize:()=>{const{group:c}=n(),l=a(),{element:u}=i(),p=c.orientation==="horizontal"?u.offsetWidth:u.offsetHeight;return{asPercentage:l,inPixels:p}},isCollapsed:()=>{const{collapsible:c,collapsedSize:l}=r(),u=a();return c&&nt(l,u)},resize:c=>{if(a()!==c){let l;switch(typeof c){case"number":{const{group:u}=n(),p=sn({group:u});l=ht(c/p*100);break}case"string":{l=parseFloat(c);break}}o(l)}}}}function ys(e){if(e.defaultPrevented)return;const{mountedGroups:t}=lt(),n=ns(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(c=>c.panelConstraints.defaultSize!==void 0);if(o){const c=o.panelConstraints.defaultSize,l=vr({groupId:a.group.id,panelId:o.id});l&&c!==void 0&&(l.resize(c),e.preventDefault())}}})}function Rn(e){const{mountedGroups:t}=lt();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function Sr({groupId:e}){const t=()=>{const{mountedGroups:n}=lt();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:c}=t(),l=Kt({layout:n,panelConstraints:i});return r?o:(qt(o,l)||it(u=>({mountedGroups:new Map(u.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:l,separatorToPanels:c})})),l)}}}function Pr(e){const{mountedGroups:t}=lt(),n=t.get(e);return De(n,`Mounted Group ${e.id} not found`),n}function Dt(e,t){const n=Rn(e),r=Pr(n),i=n.separators.find(p=>p.element===e);De(i,"Matching separator not found");const a=r.separatorToPanels.get(i);De(a,"Matching panels not found");const o=a.map(p=>n.panels.indexOf(p)),c=Sr({groupId:n.id}).getLayout(),l=vn({delta:t,initialLayout:c,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:c,trigger:"keyboard"}),u=Kt({layout:l,panelConstraints:r.derivedPanelConstraints});qt(c,u)||it(p=>({mountedGroups:new Map(p.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:u,separatorToPanels:r.separatorToPanels})}))}function bs(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=Rn(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&Dt(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&Dt(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&Dt(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&Dt(t,-5);break}case"End":{e.preventDefault(),Dt(t,100);break}case"Enter":{e.preventDefault();const r=Rn(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=Pr(r),c=r.separators.find(f=>f.element===t);De(c,"Matching separator not found");const l=o.get(c);De(l,"Matching panels not found");const u=l[0],p=i.find(f=>f.panelId===u.id);if(De(p,"Panel metadata not found"),p.collapsible){const f=a[u.id],b=p.collapsedSize===f?r.inMemoryLastExpandedPanelSizes[u.id]??p.minSize:p.collapsedSize;Dt(t,b-f)}break}case"F6":{e.preventDefault();const r=Rn(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);De(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),Dt(t,-100);break}}}function vs(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=lt(),n=ns(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let c=!1;n.forEach(l=>{r.add(l.group),l.panels.forEach(p=>{i.add(p)}),l.separator&&(a.add(l.separator),c||(c=!0,l.separator.element.focus()));const u=t.get(l.group);u&&o.set(l.group,u.layout)}),it({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const Pi=e=>e,Vn=()=>{},jr=1,Nr=2,wr=4,kr=8,Ss=3,Ps=12;let wn;function js(){return wn===void 0&&(wn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(wn=!0)),wn}function ji({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&js()){const a=(e&jr)!==0,o=(e&Nr)!==0,c=(e&wr)!==0,l=(e&kr)!==0;if(a)return c?"se-resize":l?"ne-resize":"e-resize";if(o)return c?"sw-resize":l?"nw-resize":"w-resize";if(c)return"s-resize";if(l)return"n-resize"}break}}return js()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const Ns=new WeakMap;function ss(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=Ns.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=lt();switch(i.state){case"active":case"hover":{const a=ji({cursorFlags:r,groups:i.hitRegions.map(c=>c.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}Ns.set(e,{prevStyle:t,styleSheet:n})}function Tr({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let c=0;const l=new Map(i);n.forEach(p=>{const{group:f,groupSize:b}=p,{disableCursor:g,orientation:h,panels:m}=f;let j=0;a?h==="horizontal"?j=(t.clientX-a.x)/b*100:j=(t.clientY-a.y)/b*100:h==="horizontal"?j=t.clientX<0?-100:100:j=t.clientY<0?-100:100;const P=r.get(f),{defaultLayoutDeferred:k,derivedPanelConstraints:L,layout:M,separatorToPanels:w}=i.get(f)??{defaultLayoutDeferred:!1};if(L&&P&&M&&w){const D=vn({delta:j,initialLayout:P,panelConstraints:L,pivotIndices:p.panels.map(O=>m.indexOf(O)),prevLayout:M,trigger:"mouse-or-touch"});if(qt(D,M)){if(j!==0&&!g)switch(h){case"horizontal":{c|=j<0?jr:Nr;break}case"vertical":{c|=j<0?wr:kr;break}}}else{l.set(p.group,{defaultLayoutDeferred:k,derivedPanelConstraints:L,layout:D,separatorToPanels:w});const O=p.group.panels.map(({id:G})=>G).join(",");p.group.inMemoryLayouts[O]=D}}});let u=0;t.movementX===0?u|=o&Ss:u|=c&Ss,t.movementY===0?u|=o&Ps:u|=c&Ps,it({cursorFlags:u,mountedGroups:l}),ss(e)}function ws(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=lt();n.state==="active"&&Tr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function ks(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=lt();switch(n.state){case"active":{if(e.buttons===0){it(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),it(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Tr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=ns(e,r);i.length===0?n.state!=="inactive"&&it({interactionState:{state:"inactive"}}):it({interactionState:{hitRegions:i,state:"hover"}}),ss(e.currentTarget);break}}}function Ts(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=lt();t.state==="active"&&(it({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(ss(e.currentTarget),it(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function Es(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=ht(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=ht((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function Ni(e,t,n){if(!n[0])return;const r=e.panels.find(l=>l.element===t);if(!r||!r.onResize)return;const i=sn({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,c={asPercentage:ht(a/i*100),inPixels:a};r.mutableValues.prevSize=c,r.onResize(c,r.id,o)}function wi(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function ki(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const Xt=new Map;function Ti(e){let t=!0;De(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(h=>{for(const m of h){const{borderBoxSize:j,target:P}=m;if(P===e.element){if(t){if(sn({group:e})===0)return;it(k=>{const L=k.mountedGroups.get(e);if(L){const M=ms(e),w=L.defaultLayoutDeferred?Es(M):L.layout,D=Kt({layout:w,panelConstraints:M});return!L.defaultLayoutDeferred&&qt(w,D)&&wi(L.derivedPanelConstraints,M)?k:{mountedGroups:new Map(k.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:M,layout:D,separatorToPanels:L.separatorToPanels})}}return k})}}else Ni(e,P,j)}});a.observe(e.element),e.panels.forEach(h=>{De(!r.has(h.id),`Panel ids must be unique; id "${h.id}" was used more than once`),r.add(h.id),h.onResize&&a.observe(h.element)});const o=sn({group:e}),c=ms(e),l=e.panels.map(({id:h})=>h).join(",");let u=e.defaultLayout;u&&(ki(e.panels,u)||(u=void 0));const p=e.inMemoryLayouts[l]??u??Es(c),f=Kt({layout:p,panelConstraints:c}),b=yr(e),g=e.element.ownerDocument;return it(h=>{const m=new Map;return Xt.set(g,(Xt.get(g)??0)+1),b.forEach(j=>{j.separator&&m.set(j.separator,j.panels)}),{mountedGroups:new Map(h.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:c,layout:f,separatorToPanels:m})}}),e.separators.forEach(h=>{De(!i.has(h.id),`Separator ids must be unique; id "${h.id}" was used more than once`),i.add(h.id),h.element.addEventListener("keydown",bs)}),Xt.get(g)===1&&(g.addEventListener("dblclick",ys,!0),g.addEventListener("pointerdown",vs,!0),g.addEventListener("pointerleave",ws),g.addEventListener("pointermove",ks),g.addEventListener("pointerup",Ts,!0)),function(){t=!1,Xt.set(g,Math.max(0,(Xt.get(g)??0)-1)),it(h=>{const m=new Map(h.mountedGroups);return m.delete(e),{mountedGroups:m}}),e.separators.forEach(h=>{h.element.removeEventListener("keydown",bs)}),Xt.get(g)||(g.removeEventListener("dblclick",ys,!0),g.removeEventListener("pointerdown",vs,!0),g.removeEventListener("pointerleave",ws),g.removeEventListener("pointermove",ks),g.removeEventListener("pointerup",Ts,!0)),a.disconnect()}}function Er(){const[e,t]=d.useState({}),n=d.useCallback(()=>t({}),[]);return[e,n]}function rs(e){const t=d.useId();return`${e??t}`}const Ut=typeof window<"u"?d.useLayoutEffect:d.useEffect;function gn(e){const t=d.useRef(e);return Ut(()=>{t.current=e},[e]),d.useCallback((...n)=>t.current?.(...n),[t])}function is(...e){return gn(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function Ei(e){const t=d.useRef({...e});return Ut(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const Cr=d.createContext(null);function Ci(e,t){const n=d.useRef({getLayout:()=>({}),setLayout:Pi});d.useImperativeHandle(t,()=>n.current,[]),Ut(()=>{Object.assign(n.current,Sr({groupId:e}))})}function Lr({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:c,onLayoutChange:l,onLayoutChanged:u,orientation:p="horizontal",style:f,...b}){const g=d.useRef({onLayoutChange:{},onLayoutChanged:{}}),h=gn(C=>{qt(g.current.onLayoutChange,C)||(g.current.onLayoutChange=C,l?.(C))}),m=gn(C=>{qt(g.current.onLayoutChanged,C)||(g.current.onLayoutChanged=C,u?.(C))}),j=rs(c),P=d.useRef(null),[k,L]=Er(),M=d.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),w=is(P,a);Ci(j,o);const D=gn((C,E)=>{const{interactionState:Q,mountedGroups:se}=lt();for(const T of se.keys())if(T.id===C){const S=se.get(T);if(S){let W=!1;return Q.state==="active"&&(W=Q.hitRegions.some(N=>N.group===T)),{flexGrow:S.layout[E]??1,pointerEvents:W?"none":void 0}}}return{flexGrow:n?.[E]??1}}),O=d.useMemo(()=>({getPanelStyles:D,id:j,orientation:p,registerPanel:C=>{const E=M.current;return E.panels=Xn(p,[...E.panels,C]),L(),()=>{E.panels=E.panels.filter(Q=>Q!==C),L()}},registerSeparator:C=>{const E=M.current;return E.separators=Xn(p,[...E.separators,C]),L(),()=>{E.separators=E.separators.filter(Q=>Q!==C),L()}}}),[D,j,L,p]),G=Ei({defaultLayout:n,disableCursor:r}),te=d.useRef(null);return Ut(()=>{const C=P.current;if(C===null)return;const E=M.current,Q={defaultLayout:G.defaultLayout,disableCursor:!!G.disableCursor,disabled:!!i,element:C,id:j,inMemoryLastExpandedPanelSizes:M.current.lastExpandedPanelSizes,inMemoryLayouts:M.current.layouts,orientation:p,panels:E.panels,separators:E.separators};te.current=Q;const se=Ti(Q),T=lt().mountedGroups.get(Q);if(T){const{defaultLayoutDeferred:N,derivedPanelConstraints:R,layout:z}=T;!N&&R.length>0&&(h(z),m(z),E.panels.forEach(V=>{V.scheduleUpdate()}))}const S=Vt.addListener("interactionStateChange",()=>{E.panels.forEach(N=>{N.scheduleUpdate()})}),W=Vt.addListener("mountedGroupsChange",N=>{const R=N.get(Q);if(R){const{defaultLayoutDeferred:z,derivedPanelConstraints:V,layout:B}=R;if(z||V.length===0)return;const{interactionState:q}=lt(),x=q.state!=="active";h(B),x&&m(B),E.panels.forEach($=>{$.scheduleUpdate()})}});return()=>{te.current=null,se(),S(),W()}},[i,j,m,h,p,k,G]),d.useEffect(()=>{const C=te.current;C&&(C.defaultLayout=n,C.disableCursor=!!r)}),s.jsx(Cr.Provider,{value:O,children:s.jsx("div",{...b,"aria-orientation":p,className:t,"data-group":!0,"data-testid":j,id:j,ref:w,style:{height:"100%",width:"100%",overflow:"hidden",...f,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}Lr.displayName="Group";function as(){const e=d.useContext(Cr);return De(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Li(e,t){const{id:n}=as(),r=d.useRef({collapse:Vn,expand:Vn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Vn});d.useImperativeHandle(t,()=>r.current,[]),Ut(()=>{Object.assign(r.current,vr({groupId:n,panelId:e}))})}function Mr({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:c="100%",minSize:l="0%",onResize:u,panelRef:p,style:f,...b}){const g=!!o,h=rs(o),m=d.useRef(null),j=is(m,a),[,P]=Er(),{getPanelStyles:k,id:L,registerPanel:M}=as(),w=u!==null,D=gn((G,te,C)=>{u?.(G,o,C)});Ut(()=>{const G=m.current;if(G!==null)return M({element:G,id:h,idIsStable:g,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:w?D:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:c,minSize:l},scheduleUpdate:P})},[n,r,i,P,w,h,g,c,l,D,M]),Li(h,p);const O=k(L,h);return s.jsx("div",{...b,"data-panel":!0,"data-testid":h,id:h,ref:j,style:{...Mi,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...O},children:s.jsx("div",{className:t,style:{flexGrow:1,...f},children:e})})}Mr.displayName="Panel";const Mi={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function Ii({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],c=t.find(l=>l.panelId===n);if(c){const l=c.maxSize,u=a=c.collapsible?c.collapsedSize:c.minSize,p=[r,r+1];a=Kt({layout:vn({delta:u-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=Kt({layout:vn({delta:l-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function Ir({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=rs(r),[c,l]=d.useState({}),[u,p]=d.useState("inactive"),f=d.useRef(null),b=is(f,n),{id:g,orientation:h,registerSeparator:m}=as(),j=h==="horizontal"?"vertical":"horizontal";return Ut(()=>{const P=f.current;if(P!==null){const k={element:P,id:o},L=m(k),M=Vt.addListener("interactionStateChange",D=>{p(D.state!=="inactive"&&D.hitRegions.some(O=>O.separator===k)?D.state:"inactive")}),w=Vt.addListener("mountedGroupsChange",D=>{D.forEach(({derivedPanelConstraints:O,layout:G,separatorToPanels:te},C)=>{if(C.id===g){const E=te.get(k);if(E){const Q=E[0],se=C.panels.indexOf(Q);l(Ii({layout:G,panelConstraints:O,panelId:Q.id,panelIndex:se}))}}})});return()=>{M(),w(),L()}}},[g,o,m]),s.jsx("div",{...a,"aria-controls":c.valueControls,"aria-orientation":j,"aria-valuemax":c.valueMax,"aria-valuemin":c.valueMin,"aria-valuenow":c.valueNow,children:e,className:t,"data-separator":u,"data-testid":o,id:o,ref:b,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}Ir.displayName="Separator";function Qn({className:e,...t}){return s.jsx(Lr,{"data-slot":"resizable-panel-group",className:He("h-full w-full",e),...t})}function _t({className:e,...t}){return s.jsx(Mr,{"data-slot":"resizable-panel",className:He("min-w-0 min-h-0",e),...t})}function Fn({withHandle:e,className:t,...n}){return s.jsx(Ir,{"data-slot":"resizable-handle",className:He("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(Zr,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Ri=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],Ai=[10,15,20,25,30],qn="__none__",Fi=[{value:"auto",label:"Auto (Z->D)"},{value:"zerodha",label:"Zerodha"},{value:"dhan",label:"Dhan"}],Di=[{value:"kotak",label:"Kotak"},{value:"dhan",label:"Dhan"},{value:"zerodha",label:"Zerodha"}];function Oi(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function $i(e){const t=e.trim();return t.length<=10?t:`${t.slice(0,4)}...${t.slice(-4)}`}function zi({liveOpenPnl:e,isLivePnl:t=!1,chartFocusMode:n=!1,onToggleChartFocusMode:r}){const i=Le(S=>S.apiKey),a=Le(S=>S.user?.broker),o=zt(S=>S.unifiedMode),c=zt(S=>S.dataFeed),l=zt(S=>S.executionBroker),u=zt(S=>S.setDataFeed),p=zt(S=>S.setExecutionBroker),f=y(S=>S.underlying),b=y(S=>S.optionExchange),g=y(S=>S.expiryWeek),h=y(S=>S.expiry),m=y(S=>S.expiries),j=y(S=>S.chainStrikeCount),P=y(S=>S.paperMode),k=y(S=>S.sessionPnl),L=y(S=>S.tradeCount),M=y(S=>S.lastOrderAck),w=y(S=>S.setUnderlying),D=y(S=>S.setExpiryWeek),O=y(S=>S.setExpiry),G=y(S=>S.setExpiries),te=y(S=>S.setChainStrikeCount),C=y(S=>S.setPaperMode),E=P?k:e??k,Q=h&&m.includes(h)?h:qn,{data:se}=ur({queryKey:["scalping-expiries",f,b],queryFn:()=>dr.getExpiries(i,f,b),enabled:!!i,staleTime:300*1e3});d.useEffect(()=>{if(se?.status!=="success")return;const S=se.data??[];if(Oi(m,S)||G(S),S.length===0){h&&O("");return}if(!h||!S.includes(h)){const W=g==="next"?Math.min(1,S.length-1):0,N=S[W],R=W<=0?"current":"next";h!==N&&O(N),g!==R&&D(R)}},[se,g,m,h,G,O,D]);const T=S=>{if(S===qn)return;h!==S&&O(S);const N=m.indexOf(S)<=0?"current":"next";g!==N&&D(N)};return s.jsxs("div",{className:"flex flex-wrap items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0 min-w-0 overflow-hidden",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(ln,{value:f,onValueChange:S=>w(S),children:[s.jsx(cn,{className:"h-7 w-[104px] lg:w-[116px] xl:w-[128px] text-xs font-semibold",children:s.jsx(un,{})}),s.jsx(dn,{children:Ri.map(S=>s.jsx(Zt,{value:S,children:S},S))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(ln,{value:Q,onValueChange:T,disabled:m.length===0,children:[s.jsx(cn,{className:"h-7 w-[108px] lg:w-[114px] xl:w-[122px] text-xs font-mono",children:s.jsx(un,{placeholder:"Select expiry"})}),s.jsxs(dn,{children:[s.jsx(Zt,{value:qn,disabled:!0,children:"Select expiry"}),m.map(S=>s.jsx(Zt,{value:S,children:S},S))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(ln,{value:String(j),onValueChange:S=>te(Number(S)),children:[s.jsx(cn,{className:"h-7 w-[82px] lg:w-[88px] xl:w-[94px] text-xs",children:s.jsx(un,{})}),s.jsx(dn,{children:Ai.map(S=>s.jsx(Zt,{value:String(S),children:S},S))})]})]}),s.jsx("div",{className:"flex-1 min-w-[12px]"}),o&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Feed"}),s.jsxs(ln,{value:c,onValueChange:S=>u(S),children:[s.jsx(cn,{className:"h-7 w-[98px] lg:w-[108px] xl:w-[118px] text-xs",children:s.jsx(un,{})}),s.jsx(dn,{children:Fi.map(S=>s.jsx(Zt,{value:S.value,children:S.label},S.value))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Exec"}),s.jsxs(ln,{value:l,onValueChange:S=>p(S),children:[s.jsx(cn,{className:"h-7 w-[84px] lg:w-[90px] xl:w-[96px] text-xs",children:s.jsx(un,{})}),s.jsx(dn,{children:Di.map(S=>s.jsx(Zt,{value:S.value,children:S.label},S.value))})]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsx("button",{type:"button",onClick:r,className:`h-7 px-2 rounded-md border text-xs transition-colors shrink-0 whitespace-nowrap ${n?"border-emerald-500/60 bg-emerald-500/15 text-emerald-400":"border-border/60 bg-muted/20 text-muted-foreground hover:text-foreground"}`,title:n?"Show side panels":"Hide side panels",children:n?"Panels":"Focus"}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>C(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>C(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),o?s.jsxs(Ve,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:["EXEC: ",l.toUpperCase()]}):a&&s.jsx(Ve,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:a}),!P&&M&&s.jsxs(Ve,{variant:"outline",className:"text-xs h-6 font-mono shrink-0 whitespace-nowrap",title:`${M.broker} ${M.action} ${M.symbol}`,children:["ACK: ",$i(M.orderId)]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5 shrink-0 whitespace-nowrap",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${E>0?"text-green-500":E<0?"text-red-500":"text-foreground"}`,children:[E>=0?"+":"",E.toFixed(0)]}),!P&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),L>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",L,")"]})]})]})}function kn(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function Cs({value:e,prevRef:t,className:n,format:r="price"}){const i=d.useRef(null);d.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const c=e>t.current?"flash-green":"flash-red";o.classList.add(c);const l=setTimeout(()=>o.classList.remove(c),300);return t.current=e,()=>clearTimeout(l)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:He("tabular-nums transition-colors",n),children:a})}function Tn({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:He("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function _i(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Bi=d.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:c,onSelectStrike:l,onSelectCE:u,onSelectPE:p}){const f=d.useRef(n?.ltp??0),b=d.useRef(r?.ltp??0),g=Math.min(((n?.oi??0)/o+(n?.volume??0)/c)/2*100,100),h=Math.min(((r?.oi??0)/o+(r?.volume??0)/c)/2*100,100);return s.jsxs("div",{className:He("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(Tn,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(Tn,{value:n?.volume??0,max:c,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${g}%`}}),s.jsx(Cs,{value:n?.ltp,prevRef:f,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:He("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>l(t,n?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${h}%`}}),s.jsx(Cs,{value:r?.ltp,prevRef:b,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(Tn,{value:r?.volume??0,max:c,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(Tn,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(r?.oi)})]})]})},_i);function Ls(e){return(e??"").replace(/-/g,"").toUpperCase()}function Vi(){const e=Le(T=>T.apiKey),t=y(T=>T.underlying),n=y(T=>T.indexExchange),r=y(T=>T.optionExchange),i=y(T=>T.expiry),a=y(T=>T.selectedStrike),o=y(T=>T.selectedCESymbol),c=y(T=>T.selectedPESymbol),l=y(T=>T.chainStrikeCount),u=y(T=>T.setSelectedStrike),p=y(T=>T.setSelectedSymbols),f=y(T=>T.setActiveSide),b=y(T=>T.setLotSize),g=y(T=>T.setOptionChainSnapshot),h=d.useRef(null),m=d.useRef(null),j=d.useRef(!1),{data:P,isLoading:k,isStreaming:L,error:M,streamingSymbols:w,lastUpdate:D}=Xr(e,t,n,r,i,l,{enabled:!!e&&!!i,oiRefreshInterval:15e3,wsMode:"Quote"});d.useEffect(()=>{P&&g(P,D?.getTime()??Date.now(),L)},[P,D,L,g]),d.useEffect(()=>{if(!P?.chain?.length||(P.underlying??"").toUpperCase()!==t.toUpperCase()||i&&Ls(P.expiry_date)!==Ls(i)||j.current)return;let T=null;for(const S of P.chain){const W=Number(S.ce?.lotsize);if(Number.isFinite(W)&&W>0){T=W;break}const N=Number(S.pe?.lotsize);if(Number.isFinite(N)&&N>0){T=N;break}}T!==null&&(b(T),j.current=!0)},[P,b]),d.useEffect(()=>{j.current=!1},[t,i]),d.useEffect(()=>{if(P?.chain&&m.current&&h.current){const T=h.current,S=m.current,W=T.getBoundingClientRect(),N=S.getBoundingClientRect(),R=N.top-W.top-W.height/2+N.height/2;T.scrollTop+=R}},[P?.atm_strike]);const O=d.useCallback((T,S,W)=>{u(T),p(S,W)},[u,p]),G=d.useCallback((T,S)=>{S&&(u(T),p(S,c),f("CE"))},[c,f,u,p]),te=d.useCallback((T,S)=>{S&&(u(T),p(o,S),f("PE"))},[o,f,u,p]),{maxOI:C,maxVol:E}=d.useMemo(()=>{if(!P?.chain?.length)return{maxOI:1,maxVol:1};let T=0,S=0;for(const W of P.chain)W.ce?.oi&&W.ce.oi>T&&(T=W.ce.oi),W.pe?.oi&&W.pe.oi>T&&(T=W.pe.oi),W.ce?.volume&&W.ce.volume>S&&(S=W.ce.volume),W.pe?.volume&&W.pe.volume>S&&(S=W.pe.volume);return{maxOI:T||1,maxVol:S||1}},[P?.chain]),Q=P?.underlying_ltp,se=P?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(Ve,{variant:"outline",className:"text-[10px] h-4 px-1",children:[l," strikes"]}),Q!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:Q.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[L&&s.jsxs(Ve,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),w]}),k&&s.jsx(Ve,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:h,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[M&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:M}),!M&&!k&&P?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),P?.chain?.map(T=>{const S=T.strike===se;return s.jsx("div",{ref:S?m:void 0,children:s.jsx(Bi,{strike:T.strike,ce:T.ce,pe:T.pe,isATM:S,isSelected:T.strike===a,maxOI:C,maxVol:E,onSelectStrike:O,onSelectCE:G,onSelectPE:te})},T.strike)})]})]})}function qi({positions:e,totalPnl:t,isLivePnl:n}){const r=y(o=>o.activeSide),i=y(o=>o.hotkeysEnabled),a=y(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↑"}),s.jsx("span",{children:"CE Mkt Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↓"}),s.jsx("span",{children:"PE Mkt Buy"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const rn=300*60+1800,Ms=1440*60,xn=540*60+900,Is=900*60+1800;function Dn(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function Rr(e){const t=Dn(e)+rn,n=Math.floor(t/Ms)*Ms,r=t-n,i=(n-rn)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function Ki(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),c=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(c))return null;const l=Date.UTC(n,r-1,i,a,o,c)-rn*1e3;return Math.floor(l/1e3)}function Gi(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-rn*1e3;return Math.floor(a/1e3)}function jt(e){if(typeof e=="number")return Dn(e);const t=Gi(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return Dn(r);const i=Ki(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function os(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=Rr(e);if(r===0||r===6)return!1;const i=n>=xn,a=t.includeClose?n<=Is:n<Is;return i&&a}function Ui(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=Rr(e),a=i<=xn?xn:xn+Math.floor((i-xn)/n)*n;return r+a-rn}function Ar(e){const t=(Dn(e)+rn)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function Wi(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?Ui(i,n):Math.floor(i/n)*n,c=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:c},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+c},!1]}const Hi=4e3,Yi=3e3;function Zi(e){const t=e.trim().toUpperCase(),n=new Set;return t&&n.add(t),t==="NSE_INDEX"?n.add("NSE"):t==="BSE_INDEX"?n.add("BSE"):t==="NSE"?n.add("NSE_INDEX"):t==="BSE"&&n.add("BSE_INDEX"),Array.from(n)}function Xi(e,t,n){const r=t.trim().toUpperCase();if(!r)return;const i=Zi(n);for(const l of i){const u=e.get(`${l}:${r}`);if(u)return u}const a=[];for(const[,l]of e)l.symbol.trim().toUpperCase()===r&&a.push(l);if(a.length===0)return;const o=n.trim().toUpperCase();return a.find(l=>{const u=l.exchange.trim().toUpperCase();return u===o||u.includes(o)||o.includes(u)})??a[0]}function pn(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.trim());return Number.isFinite(t)?t:null}return null}function Fr({symbol:e,exchange:t,intervalSec:n=1,mode:r="LTP",enabled:i=!0,useIndiaMarketHours:a=!1,maxCandles:o=500,onCandleUpdate:c}){const l=d.useRef([]),u=d.useRef(null),p=d.useRef(null),f=d.useRef(0),b=d.useRef(!1),g=d.useRef(c);g.current=c;const h=d.useCallback(async()=>{const O=Le.getState().apiKey;if(O)return O;try{const te=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(te.status==="success"&&te.api_key)return Le.getState().setApiKey(te.api_key),te.api_key}catch{}return null},[]),m=d.useCallback(O=>{if(!i||!Number.isFinite(O.ltp)||O.ltp<=0||!Number.isFinite(O.timestamp)||O.timestamp<=0)return!1;const G=Math.floor(O.timestamp/1e3);if(a&&!os(G))return!1;const te=`${O.sourceKey}:${O.timestamp}:${O.ltp}:${O.volume??""}`;if(p.current===te)return!1;p.current=te;const C={price:O.ltp,volume:O.volume??void 0,timestamp:O.timestamp},[E,Q]=Wi(C,u.current,n,{alignToIndiaSession:a});return Q&&u.current&&(l.current.push(u.current),l.current.length>o&&(l.current=l.current.slice(-o))),u.current=E,f.current=Date.now(),g.current?.(E,Q),!0},[i,n,o,a]),j=i&&e?[{symbol:e,exchange:t}]:[],{data:P,isConnected:k,isFallbackMode:L}=hn({symbols:j,mode:r,enabled:i&&!!e});d.useEffect(()=>{if(!i||!e||P.size===0)return;const O=Xi(P,e,t);if(!O?.data?.ltp)return;const G=pn(O.lastUpdate),te=pn(O.data.ltp);G==null||te==null||m({ltp:te,volume:pn(O.data.volume),timestamp:G,sourceKey:`${O.exchange.toUpperCase()}:${O.symbol.toUpperCase()}:WS`})},[P,e,t,m,i]),d.useEffect(()=>{if(!i||!e)return;let O=!1;const G=e.trim().toUpperCase(),te=t.trim().toUpperCase(),C=async()=>{if(O||b.current)return;const Q=f.current,se=Q>0?Date.now()-Q:Number.POSITIVE_INFINITY;if(!k||L||se>=Hi){b.current=!0;try{const S=await h();if(!S||O)return;const W=await Te.getQuotes(S,G,te);if(O||W.status!=="success"||!W.data)return;const N=pn(W.data.ltp);if(N==null||N<=0)return;m({ltp:N,volume:pn(W.data.volume),timestamp:Date.now(),sourceKey:`${te}:${G}:REST`})}catch{}finally{b.current=!1}}};C();const E=setInterval(()=>{C()},Yi);return()=>{O=!0,clearInterval(E),b.current=!1}},[i,e,t,k,L,h,m]);const M=d.useCallback(()=>{const O=[...l.current];return u.current&&O.push(u.current),O},[]),w=d.useCallback(()=>{l.current=[],u.current=null,p.current=null,f.current=0},[]),D=d.useCallback(O=>{if(!O?.length){l.current=[],u.current=null;return}const G=O.slice(-o);if(G.length===1){l.current=[],u.current=G[0];return}l.current=G.slice(0,-1),u.current=G[G.length-1]},[o]);return{getCandles:M,reset:w,seed:D,isConnected:k,isFallbackMode:L}}function On(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function Dr(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=Qi(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const c=e.length-r.length;let l=0,u=0,p=1;for(let f=0;f<r.length;f++){const b=e[c+f],g=(b.high+b.low)/2,h=r[f].value;let m=g+n*h,j=g-n*h;f>0&&(j>u||e[c+f-1].close<u||(j=u),m<l||e[c+f-1].close>l||(m=l));let P=p;f>0&&(p===1&&b.close<j?P=-1:p===-1&&b.close>m&&(P=1));const k=b.time;i.push({time:k,value:m}),a.push({time:k,value:j}),o.push({time:k,value:P===1?j:m}),l=m,u=j,p=P}return{upper:i,lower:a,trend:o}}function Qi(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,c=e[a].low,l=e[a-1].close;r.push(Math.max(o-c,Math.abs(o-l),Math.abs(c-l)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function Or(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}function Ji(e){return!Number.isFinite(e)||e<=0?1:e}function ea(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const n=Math.ceil(e/t)*t;return Math.max(t*2,n)}function $r(e,t){const n=Ji(e),r=ea(t,n);return i=>{const a=i(),o=a?.priceRange;if(!a||!o)return a;const c=o.minValue,l=o.maxValue;if(!Number.isFinite(c)||!Number.isFinite(l))return a;const u=Math.min(c,l),p=Math.max(c,l),f=(u+p)/2;let b=p-u;(!Number.isFinite(b)||b<n)&&(b=n),b<r&&(b=r),b=Math.ceil(b/n)*n;const g=b/2,h=Math.floor((f-g)/n)*n;let m=Math.ceil((f+g)/n)*n;return m-h<b&&(m=h+b),{...a,priceRange:{minValue:h,maxValue:m}}}}const ta=120,an=500,na=1,sa=50,ra=200;function En(e){return e.map(t=>({time:t.time,value:t.value}))}function ia(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function aa(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";case 86400:return"D";default:return"1m"}}function Rs(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Xe(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function ls(e){const t=jt(e);return t??null}function oa(e){if(!e?.length)return[];const t=[];for(const a of e){const o=jt(a.timestamp)??jt(a.time)??jt(a.datetime)??jt(a.date),c=Xe(a.open),l=Xe(a.high),u=Xe(a.low),p=Xe(a.close),f=Xe(a.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-an),i=r.filter(a=>os(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-an)}function Qt(e){return e.map(t=>({...t}))}function la(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-an)}function Kn(e){const t=[];for(const n of e){const r=ls(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function As(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=ls(n.time),i=Xe(n.open),a=Xe(n.high),o=Xe(n.low),c=Xe(n.close),l=Xe(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-an)}function ca({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=d.useRef(null),a=d.useRef(null),o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),f=d.useRef([]),b=d.useRef(new Map),g=d.useRef(null),h=d.useRef(0),m=d.useRef(null),j=d.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),P=Le(N=>N.apiKey),k=Le(N=>N.setApiKey),L=or(N=>N.mode==="dark"),M=y(N=>N.underlying),w=y(N=>N.indexExchange),D=y(N=>N.chartInterval),O=d.useCallback(()=>{const N=f.current,R=j.current,z=N.map(V=>({time:V.time,value:V.close}));c.current&&c.current.setData(R.showEma9?En(On(z,9)):[]),l.current&&l.current.setData(R.showEma21?En(On(z,21)):[]),u.current&&u.current.setData(R.showSupertrend?En(Dr(N,10,3).trend):[]),p.current&&p.current.setData(R.showVwap?En(Or(N)):[])},[]),G=d.useCallback(()=>{m.current===null&&(m.current=setTimeout(()=>{m.current=null,O()},ta))},[O]),te=d.useCallback(()=>{f.current=[],o.current?.setData([]),c.current?.setData([]),l.current?.setData([]),u.current?.setData([]),p.current?.setData([])},[]),C=d.useCallback(N=>{const R=As(N);f.current=Qt(R),o.current?.setData(Kn(R)),G()},[G]),E=d.useCallback(async()=>{if(P)return P;try{const R=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(R.status==="success"&&R.api_key)return k(R.api_key),R.api_key}catch{}return null},[P,k]),Q=d.useCallback((N,R)=>{if(!o.current)return;const z=ls(N.time),V=Xe(N.open),B=Xe(N.high),q=Xe(N.low),x=Xe(N.close),$=Xe(N.volume)??0;if(z==null||V==null||B==null||q==null||x==null)return;const H={time:z,open:V,high:B,low:q,close:x,volume:$},J=Number(H.time),re=f.current.length?Number(f.current[f.current.length-1].time):null;if(re!=null&&Number.isFinite(re)&&Number.isFinite(J)&&J<re)return;try{o.current.update({time:H.time,open:H.open,high:H.high,low:H.low,close:H.close})}catch{const F=As([...f.current,H]);f.current=F,o.current.setData(Kn(F)),G();return}R?(f.current.push(H),f.current.length>an&&(f.current=f.current.slice(-an))):f.current.length>0?f.current[f.current.length-1]=H:f.current.push(H);const de=g.current;de&&b.current.set(de,Qt(f.current)),G()},[G]),{isConnected:se,isFallbackMode:T,reset:S,seed:W}=Fr({symbol:M,exchange:w,intervalSec:D,mode:"LTP",enabled:!!M,useIndiaMarketHours:!1,onCandleUpdate:Q});return d.useEffect(()=>{const N=g.current;if(N&&f.current.length>0&&b.current.set(N,Qt(f.current)),!M){g.current=null,S(),te();return}const R=`${w}:${M}:${D}`;g.current=R;const z=b.current.get(R);if(z&&z.length>0){S(),W(z),C(z);return}S(),te();const V=++h.current,B=aa(D),q=new Date,x=new Date(q.getTime());x.setDate(x.getDate()-na),(async()=>{const H=await E();if(!H){V===h.current&&te();return}try{const J=async()=>{try{const ve=await Te.getQuotes(H,M,w);if(ve.status!=="success"||!ve.data)return null;const A=Xe(ve.data.ltp);if(A==null||A<=0)return null;const ge=Math.floor(Date.now()/1e3);return{time:Math.floor(ge/D)*D,open:A,high:A,low:A,close:A,volume:Xe(ve.data.volume)??0}}catch{return null}},re=async ve=>{try{const A=await Te.getHistory(H,M,w,B,Rs(x),Rs(q),ve);return A.status==="success"?oa(A.data):[]}catch{return[]}},de=await re("api"),F=de.length>0?de:await re("db");if(V!==h.current)return;const ee=g.current===R?Qt(f.current):[],fe=la(F,ee);if(fe.length>0){b.current.set(R,Qt(fe)),W(fe),C(fe);return}const je=await J();if(je&&V===h.current){const ve=[je];b.current.set(R,Qt(ve)),W(ve),C(ve);return}}catch{}V===h.current&&te()})()},[M,w,D,E,S,W,te,C]),d.useEffect(()=>{j.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},c.current?.applyOptions({visible:e}),l.current?.applyOptions({visible:t}),u.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),G()},[e,t,n,r,G]),d.useEffect(()=>{const N=i.current;if(!N)return;const R=ia(L),z=$r(sa,ra),V=pr(N,{width:N.offsetWidth,height:N.offsetHeight,layout:{background:{type:mr.Solid,color:R.bg},textColor:R.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:R.grid},horzLines:{color:R.grid}},rightPriceScale:{borderColor:R.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:R.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:re=>Ar(re)},crosshair:{mode:fr.Normal,vertLine:{width:1,color:R.crosshair,style:2},horzLine:{width:1,color:R.crosshair,style:2}}}),B=V.addSeries(xr,{upColor:R.upColor,downColor:R.downColor,borderVisible:!1,wickUpColor:R.upColor,wickDownColor:R.downColor,autoscaleInfoProvider:z}),q=V.addSeries(Mt,{color:R.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma9,autoscaleInfoProvider:z}),x=V.addSeries(Mt,{color:R.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma21,autoscaleInfoProvider:z}),$=V.addSeries(Mt,{color:R.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showSupertrend,autoscaleInfoProvider:z}),H=V.addSeries(Mt,{color:R.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showVwap,autoscaleInfoProvider:z});a.current=V,o.current=B,c.current=q,l.current=x,u.current=$,p.current=H,f.current.length>0&&(B.setData(Kn(f.current)),G());const J=new ResizeObserver(()=>{if(a.current&&N){const re=N.offsetWidth,de=N.offsetHeight;re>0&&de>0&&a.current.applyOptions({width:re,height:de})}});return J.observe(N),()=>{m.current!==null&&(clearTimeout(m.current),m.current=null),J.disconnect(),V.remove(),a.current=null,o.current=null,c.current=null,l.current=null,u.current=null,p.current=null}},[L,G]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:M}),!se&&!T&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."}),!se&&T&&s.jsx("span",{className:"text-[10px] text-blue-500",children:"REST fallback"})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const xe=lr()(cr((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).filter(i=>i.symbol===n).sort((i,a)=>a.createdAt-i.createdAt)[0],addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Fs=.05,ua=2;function An(e){return Math.round(e/Fs)*Fs}function Bt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:An(e)}async function At({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=Bt(n);if(a!=null)return a;const o=nn.getInstance(),c=Bt(o.getCachedData(e,t)?.data?.ltp);if(c!=null)return c;const l=Bt(r);if(l!=null)return l;if(i)try{const u=await Te.getQuotes(i,e,t),p=Bt(u.data?.ltp);if(p!=null)return p}catch{}return 0}function da({symbol:e,exchange:t,preferredPrice:n,fallbackPrice:r}){const i=Bt(n);if(i!=null)return i;const a=nn.getInstance(),o=Bt(a.getCachedData(e,t)?.data?.ltp);if(o!=null)return o;const c=Bt(r);return c??0}async function Wt({symbol:e,exchange:t,orderId:n=null,preferredPrice:r=null,fallbackPrice:i=null,apiKey:a=null,maxAttempts:o=5,retryDelayMs:c=250}){return da({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:i})}function gt({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:c,slPoints:l,trailDistancePoints:u,createdAt:p=Date.now(),managedBy:f="manual",autoEntryScore:b,autoEntryReason:g}){const h=An(a),m=Number(Math.max(0,c||0).toFixed(2)),j=Number(Math.max(0,l||0).toFixed(2)),P=Number(Math.max(0,u??ua).toFixed(2)),k=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:h,quantity:o,tpPrice:m>0?An(h+(k?m:-m)):null,slPrice:j>0?An(h+(k?-j:j)):null,tpPoints:m,slPoints:j,trailDistancePoints:P,trailStage:f==="auto"?"INITIAL":void 0,createdAt:p,managedBy:f,autoEntryScore:b,autoEntryReason:g}}function zr(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function _r(e){if(typeof e=="number")return Number.isFinite(e)&&e>0?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)&&t>0?t:null}return null}function Br(e){if(!e||typeof e!="object")return null;const t=e;return zr(t.orderid??t.order_id??t.orderId)}function $n(e){if(!Array.isArray(e))return[];const t=[];for(const n of e){if(!n||typeof n!="object")continue;const r=n,i=String(r.status??"").trim().toUpperCase();if(i&&i!=="SUCCESS")continue;const a=Br(r);if(!a)continue;const o=_r(r.quantity)??0;t.push({orderId:a,quantity:o})}return t}function Sn(e){if(!e||typeof e!="object")return[];const t=e,n=[],r=new Set,i=u=>{const p=zr(u);!p||r.has(p)||(r.add(p),n.push(p))};i(t.orderid??t.order_id??t.orderId),i(t.data?.orderid);const a=t.orderids;if(Array.isArray(a))for(const u of a)i(u);const o=t.data?.orderids;if(Array.isArray(o))for(const u of o)i(u);const c=$n(t.split_legs);for(const u of c)i(u.orderId);const l=$n(t.results);for(const u of l)i(u.orderId);return n}function _n(e){if(!e||typeof e!="object")return[];const t=e,n=$n(t.split_legs);if(n.length>0)return n;const r=$n(t.results);if(r.length>0)return r;const i=Br(t),a=_r(t.quantity);return i&&a!=null?[{orderId:i,quantity:a}]:[]}function Gt(e){const t=Sn(e);return t.length>0?t[0]:null}const Ds=.05,pa=150;function Ye(e){return Math.round(e/Ds)*Ds}function Ct(e){return Number(Math.max(0,e).toFixed(2))}function Os(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?Ye(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?Ye(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function fa({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=Le(v=>v.apiKey),a=Le(v=>v.setApiKey),o=y(v=>v.activeSide),c=y(v=>v.orderType),l=y(v=>v.tpPoints),u=y(v=>v.slPoints),p=y(v=>v.trailDistancePoints),f=y(v=>v.limitPrice),b=y(v=>v.pendingEntryAction),g=y(v=>v.pendingLimitPlacement),h=y(v=>v.quantity),m=y(v=>v.lotSize),j=y(v=>v.optionExchange),P=y(v=>v.product),k=y(v=>v.paperMode),L=y(v=>v.incrementTradeCount),M=y(v=>v.setLimitPrice),w=y(v=>v.setTpPoints),D=y(v=>v.setSlPoints),O=y(v=>v.setPendingEntryAction),G=y(v=>v.setPendingLimitPlacement),te=y(v=>v.clearPendingLimitPlacement),C=y(v=>n==="CE"?v.selectedCESymbol:v.selectedPESymbol),E=xe(v=>v.virtualTPSL),Q=xe(v=>v.triggerOrders),se=xe(v=>v.addTriggerOrder),T=xe(v=>v.updateTriggerOrder),S=xe(v=>v.removeTriggerOrder),W=xe(v=>v.setVirtualTPSL),N=xe(v=>v.clearForSymbol),R=xe(v=>v.updateVirtualTPSL),z=d.useRef(null),V=d.useRef(null),B=d.useRef(null),q=d.useRef(null),x=d.useRef(null),$=d.useRef(null),H=d.useRef(null),J=d.useRef(null),[re,de]=d.useState(null),[F,ee]=d.useState(null),[fe,je]=d.useState(null),[ve,A]=d.useState(null),[ge,Ae]=d.useState(!1),ze=d.useRef(!1),I=d.useRef(!1),Se=d.useRef(0),U=d.useRef(null),ie=d.useRef(null),Ne=d.useRef(null),ye=o===n,Fe=c==="LIMIT"||c==="TRIGGER",Ee=d.useMemo(()=>C?Object.values(E).filter(v=>v.symbol===C).sort((v,K)=>K.createdAt-v.createdAt):[],[C,E]),_=Ee[0],oe=d.useMemo(()=>C?Object.values(Q).find(v=>v.symbol===C):void 0,[C,Q]),ce=!!g&&g.symbol===C&&g.side===n,Oe=ce||f!=null,Ge=_?"position":oe?"trigger":ye&&Fe&&Oe?"pending":null,Me=b??g?.action??"BUY";d.useEffect(()=>{if(!_){A(null);return}const v=nn.getInstance(),K=v.getCachedData(_.symbol,_.exchange)?.data?.ltp;K&&K>0&&A(K);const ne=v.subscribe(_.symbol,_.exchange,"LTP",Z=>{const ue=Z.data.ltp;ue&&ue>0&&A(ue)});return()=>ne()},[_]);const qe=d.useMemo(()=>{if(!_||!ve||ve<=0)return null;const v=_.action==="BUY"?ve-_.entryPrice:_.entryPrice-ve,K=v*_.quantity;return{ltp:ve,points:v,pnl:K}},[_,ve]),Qe=d.useMemo(()=>{if(Ee.length===0)return null;const v=Ee.reduce((ne,Z)=>ne+Math.max(Z.quantity,0),0);if(v<=0)return null;const K=Ee.reduce((ne,Z)=>ne+Z.entryPrice*Math.max(Z.quantity,0),0)/v;return Ye(K)},[Ee]),Ze=d.useMemo(()=>{if(!_)return"";const v=`${_.action} Fill @ ${_.entryPrice.toFixed(2)}`,K=Qe!=null?` | Avg ${Qe.toFixed(2)}`:"";if(!qe)return v;const ne=qe.pnl>=0?"+":"";return`${v}${K} | PnL ${ne}${qe.pnl.toFixed(2)}`},[_,qe,Qe]),Y=d.useCallback((v,K)=>{if(v.current){const ne=K.current??t.current;try{ne?.removePriceLine(v.current)}catch{}v.current=null,K.current=null}},[t]),pe=d.useCallback((v,K,ne,Z,ue,he,we)=>{const me=t.current;if(!me)return;const $e="";if(v.current&&K.current&&K.current!==me){try{K.current.removePriceLine(v.current)}catch{}v.current=null,K.current=null}v.current?v.current.applyOptions({price:ne,color:Z,lineStyle:ue,lineWidth:he,title:$e,axisLabelVisible:!0}):(v.current=me.createPriceLine({price:ne,color:Z,lineStyle:ue,lineWidth:he,title:$e,axisLabelVisible:!0}),K.current=me)},[t]),Ce=d.useCallback(v=>{if(!t.current)return null;const K=t.current.priceToCoordinate(v);return K??null},[t]),Ie=d.useCallback(()=>{const v=(K,ne)=>{if(!K.current){ne(null);return}const Z=K.current.options().price,ue=Ce(Z);if(ue==null){ne(null);return}ne({y:ue,price:Z})};v(V,de),v(B,ee),v(q,je)},[Ce]),st=d.useCallback(()=>{if(!C)return null;const K=nn.getInstance().getCachedData(C,j)?.data?.ltp;return!K||K<=0?null:K},[C,j]),yt=d.useCallback(v=>v==="BUY"?"above":"below",[]),pt=d.useCallback((v,K)=>{const ne=st();return ne?v==="BUY"&&K<=ne?{ok:!1,message:`BUY trigger must be above current price (${ne.toFixed(2)})`}:v==="SELL"&&K>=ne?{ok:!1,message:`SELL trigger must be below current price (${ne.toFixed(2)})`}:{ok:!0}:{ok:!0}},[st]),bt=d.useCallback(async()=>{if(i)return i;try{const K=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(K.status==="success"&&K.api_key)return a(K.api_key),K.api_key}catch(v){console.error("[Scalping] Failed to fetch API key:",v)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[i,a]),_e=d.useCallback(v=>{if(Array.isArray(v.splitLegs)&&v.splitLegs.length>0)return v.splitLegs.map(ne=>({orderId:String(ne.orderId??"").trim(),quantity:Math.max(0,Number(ne.quantity)||0)})).filter(ne=>ne.orderId.length>0&&ne.quantity>0);if(Array.isArray(v.orderIds)&&v.orderIds.length>0){const ne=Array.from(new Set(v.orderIds.map(Z=>String(Z??"").trim()).filter(Z=>Z.length>0)));if(ne.length>0){const Z=Math.max(1,Math.floor(Math.max(1,v.quantity)/ne.length));return ne.map(ue=>({orderId:ue,quantity:Z}))}}const K=String(v.orderId??"").trim();return K?[{orderId:K,quantity:Math.max(1,v.quantity)}]:[]},[]),Be=d.useCallback(async()=>{if(I.current)return;const v=ie.current;if(!v)return;const K=Date.now()-Se.current,ne=v.force?0:Math.max(0,pa-K);if(ne>0){if(U.current!=null)return;U.current=window.setTimeout(()=>{U.current=null,Be()},ne);return}ie.current=null,I.current=!0,Se.current=Date.now();try{if(!await bt())return;for(const ue of v.legs)await Te.modifyOrder(ue.orderId,{symbol:v.symbol,exchange:j,action:v.action,product:P,pricetype:"LIMIT",price:v.price,quantity:ue.quantity,trigger_price:0,disclosed_quantity:0})}catch(Z){console.error("[Scalping] Failed to modify pending LIMIT order:",Z)}finally{I.current=!1,ie.current&&Be()}},[bt,j,P]),Ue=d.useCallback((v,K,ne=!1)=>{if(k)return;const Z=_e(v);if(Z.length===0)return;const ue=Ye(K),he=ie.current;ie.current={legs:Z,symbol:v.symbol,action:v.action,price:ue,force:ne||!!he?.force},ne&&U.current!=null&&(window.clearTimeout(U.current),U.current=null),Be()},[k,Be,_e]);d.useEffect(()=>()=>{U.current!=null&&(window.clearTimeout(U.current),U.current=null)},[]);const We=d.useCallback(async(v,K)=>{if(!C||ze.current)return!1;ze.current=!0;try{if(k){const $e=await At({symbol:C,exchange:j,preferredPrice:v});return $e<=0?!1:(W(gt({symbol:C,exchange:j,side:n,action:K,entryPrice:$e,quantity:h*m,tpPoints:l,slPoints:u,trailDistancePoints:p,managedBy:"manual"})),L(),te(),O(null),M(null),!0)}const ne=await bt();if(!ne)return!1;const Z={apikey:ne,strategy:"Scalping",exchange:j,symbol:C,action:K,quantity:h*m,pricetype:"LIMIT",product:P,price:v,trigger_price:0,disclosed_quantity:0},ue=await Te.placeOrder(Z);if(ue.status!=="success")return console.error("[Scalping] LIMIT order rejected:",ue),!1;const he=Gt(ue),we=Sn(ue),me=_n(ue);return G({symbol:C,side:n,action:K,orderId:he,orderIds:we.length>0?we:void 0,splitLegs:me.length>0?me:void 0,quantity:h*m,entryPrice:v,tpPoints:l,slPoints:u,trailDistancePoints:p}),O(null),M(v),!0}catch(ne){return console.error("[Scalping] LIMIT order failed:",ne),!1}finally{ze.current=!1}},[C,k,j,n,h,m,l,u,p,P,bt,W,L,te,O,M,G]);d.useEffect(()=>{const v=e.current,K=t.current;if(!v||!K)return;if(!(ye&&Fe&&!_&&!oe&&!ce&&f==null)){Y(z,x);return}const Z=ue=>{if(!ue.point){Y(z,x);return}const he=K.coordinateToPrice(ue.point.y);if(he==null){Y(z,x);return}const we=Ye(he);pe(z,x,we,"#a1a1aa",Pt.Dashed,1,we.toFixed(2))};return v.subscribeCrosshairMove(Z),()=>{v.unsubscribeCrosshairMove(Z),Y(z,x)}},[e,t,ye,Fe,_,oe,ce,f,Y,pe]),d.useEffect(()=>{const v=e.current,K=t.current;if(!v||!K||!C||!ye||!Fe)return;const ne=Z=>{if(!Z.point)return;const ue=K.coordinateToPrice(Z.point.y);if(ue==null)return;const he=Ye(ue);if(c==="TRIGGER"){const we=b??oe?.action;if(!we){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const me=pt(we,he);if(!me.ok){console.warn(`[Scalping] ${me.message}`);return}const $e=yt(we);oe?T(oe.id,{triggerPrice:he,action:we,direction:$e,quantity:h*m,tpPoints:l,slPoints:u}):se({id:`trigger-${Date.now()}`,symbol:C,exchange:j,side:n,action:we,triggerPrice:he,direction:$e,quantity:h*m,tpPoints:l,slPoints:u,trailDistancePoints:p,createdAt:Date.now()}),M(he),O(null)}else{if(ce){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!b){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(_)return;M(he),We(he,b)}Y(z,x),Ie()};return v.subscribeClick(ne),()=>{v.unsubscribeClick(ne)}},[e,t,C,ye,Fe,c,b,_,oe,ce,h,m,l,u,p,j,n,se,T,M,O,yt,pt,We,Y,Ie]),d.useEffect(()=>{if(!t.current)return;const v=()=>{Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null)};if(_){const K=_.action==="BUY"?"#00ff88":"#ff4560";pe(V,$,Ye(_.entryPrice),K,Pt.Dotted,2,`${_.action} @ ${_.entryPrice.toFixed(2)}`),_.tpPrice!=null?pe(B,H,Ye(_.tpPrice),"#00ff88",Pt.Dashed,1,`TP @ ${_.tpPrice.toFixed(2)}`):Y(B,H),_.slPrice!=null?pe(q,J,Ye(_.slPrice),"#ff4560",Pt.Dashed,1,`SL @ ${_.slPrice.toFixed(2)}`):Y(q,J),Ie();return}if(oe){const{tpPrice:K,slPrice:ne}=Os(oe),Z=Ye(oe.triggerPrice);pe(V,$,Z,"#ffa500",Pt.Dashed,2,`TRIGGER ${oe.action} @ ${Z.toFixed(2)}`),K!=null?pe(B,H,K,"#00ff88",Pt.Dashed,1,`TP @ ${K.toFixed(2)}`):Y(B,H),ne!=null?pe(q,J,ne,"#ff4560",Pt.Dashed,1,`SL @ ${ne.toFixed(2)}`):Y(q,J),Ie();return}if(ye&&Fe&&Oe){const K=Me,ne=ce?g?.tpPoints??l:l,Z=ce?g?.slPoints??u:u,ue=ce?g?.entryPrice??f:f;if(ue==null){v();return}const he=Ye(ue);if(pe(V,$,he,c==="LIMIT"?"#06b6d4":"#ffa500",Pt.Dashed,2,`${c} ${K} @ ${he.toFixed(2)}`),ne>0){const me=Ye(he+(K==="BUY"?ne:-ne));pe(B,H,me,"#00ff88",Pt.Dashed,1,`TP @ ${me.toFixed(2)}`)}else Y(B,H);if(Z>0){const me=Ye(he+(K==="BUY"?-Z:Z));pe(q,J,me,"#ff4560",Pt.Dashed,1,`SL @ ${me.toFixed(2)}`)}else Y(q,J);Ie();return}v()},[t,_,oe,ye,Fe,Oe,f,Me,g,ce,c,l,u,Y,pe,Ie]),d.useEffect(()=>{},[_,Ze]),d.useEffect(()=>{const v=e.current;if(!v)return;const K=()=>Ie();v.subscribeCrosshairMove(K);const ne=v.timeScale();return ne.subscribeVisibleLogicalRangeChange(K),()=>{v.unsubscribeCrosshairMove(K),ne.unsubscribeVisibleLogicalRangeChange(K)}},[e,Ie]),d.useEffect(()=>{const v=r.current;if(!v)return;const K=()=>{!V.current&&!B.current&&!q.current||Ie()},ne=window.setInterval(K,100);return v.addEventListener("wheel",K,{passive:!0}),v.addEventListener("mousemove",K),window.addEventListener("resize",K),()=>{window.clearInterval(ne),v.removeEventListener("wheel",K),v.removeEventListener("mousemove",K),window.removeEventListener("resize",K)}},[r,Ie]),d.useEffect(()=>{_||oe||ce||b==null&&(f==null&&!V.current&&!B.current&&!q.current||(Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null),M(null)))},[_,oe,ce,b,f,Y,M]),d.useEffect(()=>()=>{Y(z,x),Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null)},[C,Y]),d.useEffect(()=>{c==="MARKET"&&(_||oe||(Y(z,x),Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null),M(null),O(null),te()))},[c,_,oe,Y,M,O,te]);const ft=d.useCallback((v,K)=>{if(K.preventDefault(),K.stopPropagation(),!Ge||!(v==="entry"?V:v==="tp"?B:q).current)return;Ne.current={type:v,source:Ge};const Z=he=>{const we=Ne.current,me=t.current,$e=r.current;if(!we||!me||!$e)return;const ae=$e.getBoundingClientRect(),ct=he.clientY-ae.top,mt=me.coordinateToPrice(ct);if(mt==null)return;const be=Ye(mt),Ke=we.type==="entry"?V:we.type==="tp"?B:q;if(Ke.current){if(we.type==="entry"?we.source==="trigger"?`${oe?.action??"BUY"}${be.toFixed(2)}`:we.source==="pending"?`${c}${Me}${be.toFixed(2)}`:we.source==="position"?`${_?.action??Me}${be.toFixed(2)}`:Ke.current.options().title??be.toFixed(2):we.type==="tp"?`${be.toFixed(2)}`:`${be.toFixed(2)}`,Ke.current.applyOptions({price:be,title:""}),we.type==="entry"){const et=we.source==="trigger"?oe?.action??Me:we.source==="position"?_?.action??Me:Me,St=we.source==="trigger"?oe?.tpPoints??0:we.source==="position"?_?.tpPoints??0:l,tt=we.source==="trigger"?oe?.slPoints??0:we.source==="position"?_?.slPoints??0:u;if(St>0&&B.current){const Ft=Ye(be+(et==="BUY"?St:-St));B.current.applyOptions({price:Ft,title:""})}if(tt>0&&q.current){const Ft=Ye(be+(et==="BUY"?-tt:tt));q.current.applyOptions({price:Ft,title:""})}}Ie()}},ue=()=>{const he=Ne.current;if(!he)return;const me=(he.type==="entry"?V:he.type==="tp"?B:q).current?.options().price;if(me!=null){if(he.source==="position"&&_){const $e=he.type==="entry"?{entryPrice:me,tpPrice:_.tpPrice!=null?Ye(_.tpPrice+(me-_.entryPrice)):null,slPrice:_.slPrice!=null?Ye(_.slPrice+(me-_.entryPrice)):null}:he.type==="tp"?{tpPrice:me,tpPoints:Ct(Math.abs(me-_.entryPrice))}:he.type==="sl"?{slPrice:me,slPoints:Ct(Math.abs(_.entryPrice-me))}:null;$e&&R(_.id,$e)}if(he.source==="trigger"&&oe){if(he.type==="entry"){const $e=pt(oe.action,me);if($e.ok)T(oe.id,{triggerPrice:me,direction:yt(oe.action)}),M(me);else{console.warn(`[Scalping] ${$e.message}`);const ae=Ye(oe.triggerPrice);V.current?.applyOptions({price:ae,title:""});const{tpPrice:ct,slPrice:mt}=Os(oe);B.current&&ct!=null&&B.current.applyOptions({price:ct,title:""}),q.current&&mt!=null&&q.current.applyOptions({price:mt,title:""}),M(ae)}}he.type==="tp"&&T(oe.id,{tpPoints:Ct(Math.abs(me-oe.triggerPrice))}),he.type==="sl"&&T(oe.id,{slPoints:Ct(Math.abs(oe.triggerPrice-me))})}if(he.source==="pending"){const $e=V.current?.options().price??f??me;if(ce&&g){const ae={...g};he.type==="entry"&&(ae.entryPrice=me,M(me),Ue({orderId:ae.orderId,orderIds:ae.orderIds,splitLegs:ae.splitLegs,symbol:ae.symbol,action:ae.action,quantity:ae.quantity},me,!0)),he.type==="tp"&&(ae.tpPoints=Ct(Math.abs(me-$e))),he.type==="sl"&&(ae.slPoints=Ct(Math.abs($e-me))),G(ae)}else he.type==="entry"&&M(me),he.type==="tp"&&w(Ct(Math.abs(me-$e))),he.type==="sl"&&D(Ct(Math.abs($e-me)))}}Ie(),Ne.current=null,document.removeEventListener("mousemove",Z),document.removeEventListener("mouseup",ue)};document.addEventListener("mousemove",Z),document.addEventListener("mouseup",ue)},[Ge,t,r,_,oe,Me,c,f,ce,g,l,u,Ue,R,T,yt,pt,Ie,G,M,w,D]),Ht=d.useCallback(async()=>{if(ce&&g&&!k)try{const v=_e(g);if(v.length>0){const ne=(await Promise.allSettled(v.map(Z=>Te.cancelOrder(Z.orderId)))).find(Z=>Z.status!=="fulfilled"||Z.value.status!=="success");if(ne){console.error("[Scalping] Failed to cancel one or more LIMIT slice orders:",ne);return}}}catch(v){console.error("[Scalping] Failed to cancel LIMIT order:",v);return}Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null),_&&N(_.symbol),oe&&S(oe.id),ce&&(g?_e(g):[]).length===0&&!k&&console.warn("[Scalping] Pending LIMIT has no broker order ids; cleared local lines only."),te(),M(null),O(null)},[_,oe,ce,g,k,_e,Y,N,S,te,M,O]),Je=d.useCallback(v=>{if(Y(v==="tp"?B:q,v==="tp"?H:J),v==="tp"?ee(null):je(null),_){R(_.id,v==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(oe){T(oe.id,v==="tp"?{tpPoints:0}:{slPoints:0});return}v==="tp"?w(0):D(0)},[_,oe,Y,w,D,R,T]),on=d.useCallback(async()=>{if(!(!_||ge)){Ae(!0);try{if(k)console.log(`[Paper] Close ${_.action} ${_.symbol}`);else{const v=await Te.closePosition(_.symbol,_.exchange,P);if(v.status!=="success"){console.error("[Scalping] Close position rejected:",v);return}}N(_.symbol),Y(V,$),Y(B,H),Y(q,J),de(null),ee(null),je(null)}catch(v){console.error("[Scalping] Close position failed:",v)}finally{Ae(!1)}}},[_,ge,k,P,N,Y]);if(!r.current)return null;const vt=!!_,Tt=vt?_.action==="BUY"?"green":"red":c==="LIMIT"?"cyan":"orange",Nt=vt?`${_.action} @ ${re?.price.toFixed(2)??"--"}`:oe?`TRIGGER ${oe.action} @ ${re?.price.toFixed(2)??"--"}`:`${c} ${Me} @ ${re?.price.toFixed(2)??"--"}`,Yt={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[Tt],Et={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[Tt],wt=Ge!==null;return s.jsxs(s.Fragment,{children:[re&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:re.y},children:[s.jsx("div",{className:He("absolute left-0 right-0 top-0 h-px -translate-y-1/2",Et)}),s.jsx("div",{className:He("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",wt?"cursor-ns-resize":"cursor-default"),onMouseDown:wt?v=>ft("entry",v):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:He("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Yt),children:Nt}),vt&&qe&&s.jsxs("span",{className:He("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",qe.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",qe.ltp.toFixed(2)," | PnL ",qe.pnl>=0?"+":"",qe.pnl.toFixed(2)]}),vt&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:v=>{v.stopPropagation(),on()},disabled:ge,title:"Close position at market",children:ge?"...":"Close"}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:v=>{v.stopPropagation(),Ht()},title:vt?"Remove virtual position tracking":"Cancel pending order",children:"×"})]})]}),F&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:F.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>ft("tp",v)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",F.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),Je("tp")},title:"Remove TP line",children:"×"})]})]}),fe&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:fe.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>ft("sl",v)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",fe.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),Je("sl")},title:"Remove SL line",children:"×"})]})]})]})}const ma=120,xa=1,ha=10,ga=40,ya=3e4,ba=120,va=5e3,Sa=12e3;function Cn(e){return e.map(t=>({time:t.time,value:t.value}))}function Pa(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function ja(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";case 86400:return"D";default:return"1m"}}function $s(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function le(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Ln(e){if(!Number.isFinite(e))return"0";const t=Math.abs(e);return t>=1e6?`${(e/1e6).toFixed(2)}M`:t>=1e3?`${(e/1e3).toFixed(1)}K`:t>=100?e.toFixed(0):t>=10?e.toFixed(1):t>0?e.toFixed(2):"0"}const zs={buyFlow:0,sellFlow:0,delta:0,cumulativeDelta:0,dominance:"BAL",depthImbalancePct:null,spread:null,flowSource:"EST",lastUpdate:0};function Na(e){return le(e.ltp)??le(e.last_price)??le(e.lp)??le(e.price)??le(e.close)}function wa(e){return le(e.volume)??le(e.total_volume)??le(e.v)??le(e.ttq)}function ka(e){return le(e.bid_price)??le(e.bid)??le(e.bp)??le(e.best_bid_price)??le(e.bp1)}function Ta(e){return le(e.ask_price)??le(e.ask)??le(e.sp)??le(e.best_ask_price)??le(e.sp1)}function Ea(e){return le(e.bid_size)??le(e.bid_qty)??le(e.total_buy_quantity)??le(e.total_buy_qty)??le(e.totalbuyqty)??le(e.buy_quantity)??le(e.tbq)??le(e.bq1)}function Ca(e){return le(e.ask_size)??le(e.ask_qty)??le(e.total_sell_quantity)??le(e.total_sell_qty)??le(e.totalsellqty)??le(e.sell_quantity)??le(e.tsq)??le(e.sq1)}function _s(e){if(!e||typeof e!="object")return 0;const t=e,n=le(t.price)??le(t.px);return n!=null&&n>0?n:0}function Mn(e){if(!e||typeof e!="object")return 0;const t=e,n=le(t.quantity)??le(t.qty)??le(t.size)??le(t.volume);return n!=null&&n>0?n:0}function La(e,t){const n=Math.max(0,t.buyFlow+t.sellFlow);if(n<=0)return{action:"HOLD",label:"HOLD FOR NOW"};const r=Math.abs(t.delta)/Math.max(1,n),i=t.delta===0?!1:Math.sign(t.delta)===Math.sign(t.cumulativeDelta)&&Math.abs(t.cumulativeDelta)>=Math.abs(t.delta)*.35,a=t.flowSource==="VOL"?1e3:250,o=t.flowSource==="VOL"?.12:.22;if(!i||n<a||r<o)return{action:"HOLD",label:"HOLD FOR NOW"};const c=t.delta>0&&t.cumulativeDelta>0,l=t.delta<0&&t.cumulativeDelta<0;return c?e==="CE"?{action:"BUY_CE",label:"BUY CE NOW"}:{action:"BUY_PE",label:"BUY PE NOW"}:l?e==="CE"?{action:"BUY_PE",label:"BUY PE NOW"}:{action:"BUY_CE",label:"BUY CE NOW"}:{action:"HOLD",label:"HOLD FOR NOW"}}function cs(e){const t=jt(e);return t??null}function Ma(e){if(!e?.length)return[];const t=[];for(const a of e){const o=jt(a.timestamp)??jt(a.time)??jt(a.datetime)??jt(a.date),c=le(a.open),l=le(a.high),u=le(a.low),p=le(a.close),f=le(a.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>os(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function Jt(e){return e.map(t=>({...t}))}function Ia(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function Gn(e){const t=[];for(const n of e){const r=cs(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Bs(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=cs(n.time),i=le(n.open),a=le(n.high),o=le(n.low),c=le(n.close),l=le(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function Vs({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i,showOrderFlow:a}){const o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),f=d.useRef(null),b=d.useRef(null),g=d.useRef([]),h=d.useRef(new Map),m=d.useRef(null),j=d.useRef(0),P=d.useRef(null),k=d.useRef({lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0}),[L,M]=d.useState(zs),[w,D]=d.useState(()=>Date.now()),O=d.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),G=Le(U=>U.apiKey),te=Le(U=>U.setApiKey),C=or(U=>U.mode==="dark"),E=y(U=>U.activeSide),Q=y(U=>U.setActiveSide),se=y(U=>U.optionExchange),T=y(U=>U.chartInterval),S=y(U=>e==="CE"?U.selectedCESymbol:U.selectedPESymbol),W=E===e,N=d.useMemo(()=>a&&S?[{symbol:S,exchange:se}]:[],[a,S,se]),{data:R,isFallbackMode:z}=hn({symbols:N,mode:"Quote",enabled:a&&!!S}),{data:V,isFallbackMode:B}=hn({symbols:N,mode:"LTP",enabled:a&&!!S}),{data:q,isFallbackMode:x}=hn({symbols:N,mode:"Depth",enabled:a&&!!S}),$=d.useMemo(()=>a&&S?`${se.toUpperCase()}:${S.toUpperCase()}`:null,[se,a,S]),H=z||B||x,J=d.useMemo(()=>{if(!$)return 0;const U=R.get($)?.lastUpdate??0,ie=V.get($)?.lastUpdate??0,Ne=q.get($)?.lastUpdate??0;return Math.max(0,U,ie,Ne)},[$,q,V,R]),re=d.useMemo(()=>La(e,L),[e,L]),de=d.useMemo(()=>{if(!a||!S||J<=0)return!1;const U=H?Sa:va;return w-J>U},[w,H,J,a,S]);d.useEffect(()=>{if(!a||!S)return;const U=setInterval(()=>D(Date.now()),1e3);return()=>clearInterval(U)},[a,S]),d.useEffect(()=>{k.current={lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0},M(zs)},[a,S,se]),d.useEffect(()=>{if(!a||!S||!$)return;const U=R.get($),ie=V.get($),Ne=q.get($),ye=[U,ie,Ne].filter(Z=>!!Z),Fe=ye.reduce((Z,ue)=>Z?(ue.lastUpdate??0)>=(Z.lastUpdate??0)?ue:Z:ue,ye[0]??null);if(!U?.data&&!ie?.data&&!Ne?.data)return;const Ee={...U?.data??{},...ie?.data??{},...Ne?.data??{}},_=Na({...Ee,...Fe?.data??{}});if(_==null||_<=0)return;const oe=Math.max(Date.now(),Fe?.lastUpdate??0),ce=k.current,Oe=ce.lastLtp,Ge=oe>ce.lastTickAt,Me=wa(Ee),qe=ce.lastVolume;let Qe=[],Ze=[];if(Ee.depth&&typeof Ee.depth=="object"){const Z=Ee.depth;Qe=Array.isArray(Z.buy)?Z.buy:[],Ze=Array.isArray(Z.sell)?Z.sell:[]}const Y=Qe.length>0?_s(Qe[0]):0,pe=Ze.length>0?_s(Ze[0]):0,Ce=ka(Ee)??(Y>0?Y:null),Ie=Ta(Ee)??(pe>0?pe:null),st=Qe.length>0?Mn(Qe[0]):0,yt=Ze.length>0?Mn(Ze[0]):0,pt=Ea(Ee),bt=Ca(Ee),_e=pt!=null&&pt>0?pt:st>0?st:null,Be=bt!=null&&bt>0?bt:yt>0?yt:null;let Ue=0,We=0,ft=!1,Ht=!1,Je=0;if(Me!=null&&qe!=null&&Number.isFinite(Me)&&Number.isFinite(qe)&&Me>=qe?Je=Math.max(0,Me-qe):Me!=null&&qe==null&&(Je=0),Je>0)if(Ht=!0,Oe!=null&&_>Oe)Ue=Je;else if(Oe!=null&&_<Oe)We=Je;else if(Ce!=null&&Ie!=null&&Ie>Ce){const Z=(Ce+Ie)/2;_>=Z?Ue=Je:We=Je}else Ue=Je*.5,We=Je*.5,ft=!0;if(Ue<=0&&We<=0){const Z=ce.lastBidSize,ue=ce.lastAskSize,he=ue!=null&&Be!=null?Math.max(0,ue-Be):0,we=Z!=null&&_e!=null?Math.max(0,Z-_e):0,me=Z!=null&&_e!=null?Math.max(0,_e-Z):0,$e=ue!=null&&Be!=null?Math.max(0,Be-ue):0;let ae=he+me*.35,ct=we+$e*.35;Oe!=null&&_>Oe&&(ae+=1),Oe!=null&&_<Oe&&(ct+=1);const mt=ae+ct;if(mt>0){ft=!0;const be=Math.max(1,Math.min(12,Math.sqrt(mt)));if(ae>ct)Ue=be;else if(ct>ae)We=be;else if(_e!=null&&Be!=null&&_e+Be>0){const Ke=(_e-Be)/(_e+Be);Ke>0?Ue=Math.max(1,be*Math.abs(Ke)):Ke<0&&(We=Math.max(1,be*Math.abs(Ke)))}}}Ue<=0&&We<=0&&Oe!=null&&(ft=!0,_>Oe?Ue=1:_<Oe&&(We=1)),Ue<=0&&We<=0&&Ge&&(ft=!0,Ue=.35,We=.35),ce.lastLtp=_,ce.lastTickAt=oe,Me!=null&&Number.isFinite(Me)&&Me>=0&&(ce.lastVolume=Me),_e!=null&&Number.isFinite(_e)&&_e>=0&&(ce.lastBidSize=_e),Be!=null&&Number.isFinite(Be)&&Be>=0&&(ce.lastAskSize=Be),(Ue>0||We>0)&&(ce.buckets.push({ts:oe,buy:Ue,sell:We}),ce.cumulativeDelta+=Ue-We);const on=oe-ya;ce.buckets=ce.buckets.filter(Z=>Z.ts>=on);const vt=ce.buckets.reduce((Z,ue)=>Z+ue.buy,0),Tt=ce.buckets.reduce((Z,ue)=>Z+ue.sell,0),Nt=vt-Tt,Yt=Nt>0?"BUY":Nt<0?"SELL":"BAL";let Et=0,wt=0;Qe.length||Ze.length?(Et=Qe.slice(0,5).reduce((Z,ue)=>Z+Mn(ue),0),wt=Ze.slice(0,5).reduce((Z,ue)=>Z+Mn(ue),0)):(Et=_e&&_e>0?_e:0,wt=Be&&Be>0?Be:0);const v=Et+wt,K=v>0?(Et-wt)/v*100:null,ne=Ce!=null&&Ie!=null&&Ie>=Ce?Ie-Ce:null;oe-ce.lastEmitAt<ba||(ce.lastEmitAt=oe,M({buyFlow:vt,sellFlow:Tt,delta:Nt,cumulativeDelta:ce.cumulativeDelta,dominance:Yt,depthImbalancePct:K,spread:ne,flowSource:Ht&&!ft?"VOL":"EST",lastUpdate:oe}))},[$,q,V,R,a,S]);const F=d.useCallback(()=>{const U=g.current,ie=O.current,Ne=U.map(ye=>({time:ye.time,value:ye.close}));u.current&&u.current.setData(ie.showEma9?Cn(On(Ne,9)):[]),p.current&&p.current.setData(ie.showEma21?Cn(On(Ne,21)):[]),f.current&&f.current.setData(ie.showSupertrend?Cn(Dr(U,10,3).trend):[]),b.current&&b.current.setData(ie.showVwap?Cn(Or(U)):[])},[]),ee=d.useCallback(()=>{P.current===null&&(P.current=setTimeout(()=>{P.current=null,F()},ma))},[F]),fe=d.useCallback(()=>{g.current=[],l.current?.setData([]),u.current?.setData([]),p.current?.setData([]),f.current?.setData([]),b.current?.setData([])},[]),je=d.useCallback(U=>{const ie=Bs(U);g.current=Jt(ie),l.current?.setData(Gn(ie)),ee()},[ee]),ve=d.useCallback(async()=>{if(G)return G;try{const ie=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(ie.status==="success"&&ie.api_key)return te(ie.api_key),ie.api_key}catch{}return null},[G,te]),A=d.useCallback(()=>{Q(e)},[e,Q]),ge=d.useCallback((U,ie)=>{if(!l.current)return;const Ne=cs(U.time),ye=le(U.open),Fe=le(U.high),Ee=le(U.low),_=le(U.close),oe=le(U.volume)??0;if(Ne==null||ye==null||Fe==null||Ee==null||_==null)return;const ce={time:Ne,open:ye,high:Fe,low:Ee,close:_,volume:oe},Oe=Number(ce.time),Ge=g.current.length?Number(g.current[g.current.length-1].time):null;if(Ge!=null&&Number.isFinite(Ge)&&Number.isFinite(Oe)&&Oe<Ge)return;try{l.current.update({time:ce.time,open:ce.open,high:ce.high,low:ce.low,close:ce.close})}catch{const qe=Bs([...g.current,ce]);g.current=qe,l.current.setData(Gn(qe)),ee();return}ie?(g.current.push(ce),g.current.length>500&&(g.current=g.current.slice(-500))):g.current.length>0?g.current[g.current.length-1]=ce:g.current.push(ce);const Me=m.current;Me&&h.current.set(Me,Jt(g.current)),ee()},[ee]),{isConnected:Ae,isFallbackMode:ze,reset:I,seed:Se}=Fr({symbol:S??"",exchange:se,intervalSec:T,mode:"LTP",enabled:!!S,useIndiaMarketHours:!1,onCandleUpdate:ge});return d.useEffect(()=>{const U=m.current;if(U&&g.current.length>0&&h.current.set(U,Jt(g.current)),!S){m.current=null,I(),fe();return}const ie=`${se}:${S}:${T}`;m.current=ie;const Ne=h.current.get(ie);if(Ne&&Ne.length>0){I(),Se(Ne),je(Ne);return}I(),fe();const ye=++j.current,Fe=ja(T),Ee=new Date,_=new Date(Ee.getTime());_.setDate(_.getDate()-xa),(async()=>{const ce=await ve();if(!ce){ye===j.current&&fe();return}try{const Oe=async()=>{try{const pe=await Te.getQuotes(ce,S,se);if(pe.status!=="success"||!pe.data)return null;const Ce=le(pe.data.ltp);if(Ce==null||Ce<=0)return null;const Ie=Math.floor(Date.now()/1e3);return{time:Math.floor(Ie/T)*T,open:Ce,high:Ce,low:Ce,close:Ce,volume:le(pe.data.volume)??0}}catch{return null}},Ge=async pe=>{try{const Ce=await Te.getHistory(ce,S,se,Fe,$s(_),$s(Ee),pe);return Ce.status==="success"?Ma(Ce.data):[]}catch{return[]}},Me=await Ge("api"),qe=Me.length>0?Me:await Ge("db");if(ye!==j.current)return;const Qe=m.current===ie?Jt(g.current):[],Ze=Ia(qe,Qe);if(Ze.length>0){h.current.set(ie,Jt(Ze)),Se(Ze),je(Ze);return}const Y=await Oe();if(Y&&ye===j.current){const pe=[Y];h.current.set(ie,Jt(pe)),Se(pe),je(pe);return}}catch{}ye===j.current&&fe()})()},[S,se,T,ve,I,Se,fe,je]),d.useEffect(()=>{O.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},u.current?.applyOptions({visible:t}),p.current?.applyOptions({visible:n}),f.current?.applyOptions({visible:r}),b.current?.applyOptions({visible:i}),ee()},[t,n,r,i,ee]),d.useEffect(()=>{const U=o.current;if(!U)return;const ie=Pa(C),Ne=$r(ha,ga),ye=pr(U,{width:U.offsetWidth,height:U.offsetHeight,layout:{background:{type:mr.Solid,color:ie.bg},textColor:ie.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:ie.grid},horzLines:{color:ie.grid}},rightPriceScale:{borderColor:ie.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:ie.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:Ge=>Ar(Ge)},crosshair:{mode:fr.Normal,vertLine:{width:1,color:ie.crosshair,style:2},horzLine:{width:1,color:ie.crosshair,style:2}}}),Fe=ye.addSeries(xr,{upColor:ie.upColor,downColor:ie.downColor,borderVisible:!1,wickUpColor:ie.upColor,wickDownColor:ie.downColor,autoscaleInfoProvider:Ne}),Ee=ye.addSeries(Mt,{color:ie.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:O.current.showEma9,autoscaleInfoProvider:Ne}),_=ye.addSeries(Mt,{color:ie.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:O.current.showEma21,autoscaleInfoProvider:Ne}),oe=ye.addSeries(Mt,{color:ie.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:O.current.showSupertrend,autoscaleInfoProvider:Ne}),ce=ye.addSeries(Mt,{color:ie.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:O.current.showVwap,autoscaleInfoProvider:Ne});c.current=ye,l.current=Fe,u.current=Ee,p.current=_,f.current=oe,b.current=ce,g.current.length>0&&(Fe.setData(Gn(g.current)),ee());const Oe=new ResizeObserver(()=>{if(c.current&&U){const Ge=U.offsetWidth,Me=U.offsetHeight;Ge>0&&Me>0&&c.current.applyOptions({width:Ge,height:Me})}});return Oe.observe(U),()=>{P.current!==null&&(clearTimeout(P.current),P.current=null),Oe.disconnect(),ye.remove(),c.current=null,l.current=null,u.current=null,p.current=null,f.current=null,b.current=null}},[C,ee]),s.jsxs("div",{className:He("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",W&&"ring-1 ring-primary/40"),onClick:A,children:[s.jsx("div",{ref:o,className:"h-full w-full"}),s.jsx(fa,{chartRef:c,seriesRef:l,side:e,containerRef:o}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:He("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),S&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:S}),!S&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),a&&S&&s.jsxs("div",{className:"absolute top-7 left-2 pointer-events-none rounded border border-border/70 bg-background/85 backdrop-blur-[1px] px-2 py-1.5 text-[10px] font-mono leading-tight",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[s.jsx("span",{className:"text-muted-foreground",children:"FLOW 30s"}),s.jsx("span",{className:He(L.flowSource==="VOL"?"text-emerald-500":"text-amber-500"),children:L.flowSource})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-3 gap-y-0.5",children:[s.jsxs("span",{className:"text-green-500",children:["B ",Ln(L.buyFlow)]}),s.jsxs("span",{className:"text-red-500 text-right",children:["S ",Ln(L.sellFlow)]}),s.jsxs("span",{className:He(L.delta>0?"text-green-500":L.delta<0?"text-red-500":"text-muted-foreground"),children:["D ",L.delta>=0?"+":"",Ln(L.delta)]}),s.jsxs("span",{className:He(L.cumulativeDelta>0?"text-green-500":L.cumulativeDelta<0?"text-red-500":"text-muted-foreground","text-right"),children:["CD ",L.cumulativeDelta>=0?"+":"",Ln(L.cumulativeDelta)]}),s.jsx("span",{className:He(L.dominance==="BUY"?"text-green-500":L.dominance==="SELL"?"text-red-500":"text-muted-foreground"),children:L.dominance}),s.jsx("span",{className:He(re.action==="BUY_CE"?"text-green-500":re.action==="BUY_PE"?"text-red-500":"text-amber-400","text-right"),children:re.label}),(L.depthImbalancePct!=null||L.spread!=null)&&s.jsxs("span",{className:He(L.depthImbalancePct==null?"text-muted-foreground":L.depthImbalancePct>=0?"text-green-500":"text-red-500","text-right"),children:["DEPTH ",L.depthImbalancePct==null?"NA":`${L.depthImbalancePct>=0?"+":""}${L.depthImbalancePct.toFixed(0)}%`]}),(L.depthImbalancePct!=null||L.spread!=null)&&s.jsxs("span",{className:"text-muted-foreground col-span-2",children:["SPR ",L.spread==null?"NA":L.spread.toFixed(2)]}),L.depthImbalancePct==null&&L.spread==null&&s.jsx("span",{className:He("col-span-2 text-right",de?"text-amber-500":"text-muted-foreground"),children:de?"WS stale / no recent ticks":"No L2 quote"})]})]}),W&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),S&&!Ae&&!ze&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),S&&!Ae&&ze&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-blue-500",children:"REST fallback"})}),!S&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function Ot(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function Ra(){const e=Le(A=>A.apiKey),t=Le(A=>A.setApiKey),n=y(A=>A.showFloatingWidget),r=y(A=>A.floatingWidgetMinimized),i=y(A=>A.setFloatingWidgetMinimized),a=y(A=>A.activeSide),o=y(A=>A.selectedCESymbol),c=y(A=>A.selectedPESymbol),l=y(A=>A.optionExchange),u=y(A=>A.quantity),p=y(A=>A.lotSize),f=y(A=>A.product),b=y(A=>A.tpPoints),g=y(A=>A.slPoints),h=y(A=>A.trailDistancePoints),m=y(A=>A.orderType),j=y(A=>A.limitPrice),P=y(A=>A.pendingLimitPlacement),k=y(A=>A.setLimitPrice),L=y(A=>A.setPendingEntryAction),M=y(A=>A.setPendingLimitPlacement),w=y(A=>A.clearPendingLimitPlacement),D=y(A=>A.paperMode),O=xe(A=>A.setVirtualTPSL),G=xe(A=>A.clearForSymbol),te=xe(A=>A.triggerOrders),C=xe(A=>A.removeTriggerOrder),E=y(A=>A.ceWidgetPos),Q=y(A=>A.setCeWidgetPos),se=y(A=>A.incrementQuantity),T=y(A=>A.decrementQuantity),S=y(A=>A.setTpPoints),W=y(A=>A.setSlPoints),N=y(A=>A.setTrailDistancePoints),R=y(A=>A.incrementTradeCount),z=a==="CE"?o:c,[V,B]=d.useState(!1),[q,x]=d.useState(null),[$,H]=d.useState(null),J=d.useRef(null),re=d.useRef(null);d.useEffect(()=>{if(!z){x(null),H(null);return}const ge=nn.getInstance().subscribe(z,l,"LTP",Ae=>{const ze=Ae.data.ltp;ze!=null&&ze>0&&(H(q),x(ze))});return()=>{ge()}},[z,l]);const de=d.useCallback(A=>{if(A.target.closest("button, input"))return;A.preventDefault(),J.current={startX:A.clientX,startY:A.clientY,origX:E.x,origY:E.y};const ge=ze=>{if(!J.current)return;const I=ze.clientX-J.current.startX,Se=ze.clientY-J.current.startY;Q({x:Math.max(0,J.current.origX+I),y:Math.max(0,J.current.origY+Se)})},Ae=()=>{J.current=null,document.removeEventListener("mousemove",ge),document.removeEventListener("mouseup",Ae)};document.addEventListener("mousemove",ge),document.addEventListener("mouseup",Ae)},[E,Q]),F=d.useCallback(async()=>{if(e)return e;try{const ge=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(ge.status==="success"&&ge.api_key)return t(ge.api_key),ge.api_key}catch(A){console.error("[Scalping] Failed to fetch API key:",A),ke.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),ke.error("API key missing. Generate one on /apikey"),null},[e,t]),ee=d.useCallback(async A=>{if(!z||V){z||(console.warn("[Scalping] No symbol selected — click a strike first"),ke.error("Select a strike first"));return}if(B(!0),m==="TRIGGER"){const I=Object.values(te).find(Se=>Se.symbol===z&&Se.exchange===l&&Se.side===a);I&&C(I.id),w(),k(null),L(A),console.log(`[Scalping] TRIGGER armed (${A}) — click chart to place trigger line`),B(!1);return}if(m==="LIMIT"&&!j){L(A),console.log(`[Scalping] LIMIT armed (${A}) — click chart to set limit line`),B(!1);return}if(m==="LIMIT"&&P&&P.symbol===z&&P.side===a){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),ke.error("A LIMIT order is already pending for this symbol"),B(!1);return}if(D){if(console.log(`[Paper] ${A} ${a} ${z} qty=${u*p} @ ${m}`),m==="MARKET"||m==="LIMIT"){const I=await At({symbol:z,exchange:l,preferredPrice:m==="LIMIT"?j??q??void 0:q??void 0});I>0&&(O(gt({symbol:z,exchange:l,side:a,action:A,entryPrice:I,quantity:u*p,tpPoints:b,slPoints:g,trailDistancePoints:h,managedBy:"manual"})),m==="LIMIT"&&k(null))}w(),R(),B(!1);return}const ge=await F();if(!ge){B(!1);return}const Ae=m==="LIMIT"?"LIMIT":"MARKET",ze={apikey:ge,strategy:"Scalping",exchange:l,symbol:z,action:A,quantity:u*p,pricetype:Ae,product:f,price:m==="LIMIT"&&j?j:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${A} ${z} qty=${u*p} ${Ae}`);const I=await Te.placeOrder(ze);if(I.status==="success"){const Se=Gt(I);if(console.log(`[Scalping] Order placed: ${A} ${z} id=${Se??"n/a"}`),L(null),Ae==="LIMIT"){const U=j??q??0;U<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state.");const ie=Sn(I),Ne=_n(I);M({symbol:z,side:a,action:A,orderId:Se,orderIds:ie.length>0?ie:void 0,splitLegs:Ne.length>0?Ne:void 0,quantity:u*p,entryPrice:U,tpPoints:b,slPoints:g,trailDistancePoints:h}),U>0&&k(U),B(!1);return}if(w(),R(),Ae==="MARKET"){const U=await At({symbol:z,exchange:l,preferredPrice:q??void 0,apiKey:null}),ie=await Wt({symbol:z,exchange:l,orderId:Se,preferredPrice:U>0?U:q??void 0,apiKey:ge});ie>0&&O(gt({symbol:z,exchange:l,side:a,action:A,entryPrice:ie,quantity:u*p,tpPoints:b,slPoints:g,trailDistancePoints:h,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",I),ke.error(Ot(I,"Order was rejected"))}catch(I){console.error("[Scalping] Order failed:",I),ke.error(Ot(I,"Order placement failed"))}B(!1)},[z,a,u,p,l,f,m,j,P,b,g,h,D,G,te,V,q,F,R,M,O,C,k,L,w]),fe=d.useCallback(async()=>{if(!z||V)return;if(B(!0),D){console.log(`[Paper] Reversal ${a} ${z}`),R(),B(!1);return}const A=await F();if(!A){B(!1);return}try{const ge={apikey:A,strategy:"Scalping",exchange:l,symbol:z,action:"SELL",quantity:u*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},Ae=await Te.placeOrder(ge);if(Ae.status!=="success"){ke.error(Ot(Ae,"Reversal close leg failed")),B(!1);return}const ze={apikey:A,strategy:"Scalping",exchange:l,symbol:z,action:"SELL",quantity:u*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},I=await Te.placeOrder(ze);if(I.status!=="success"){ke.error(Ot(I,"Reversal open leg failed")),B(!1);return}console.log(`[Scalping] Reversed ${a} ${z}`),R()}catch(ge){console.error("[Scalping] Reversal failed:",ge),ke.error(Ot(ge,"Reversal failed"))}B(!1)},[z,a,u,p,l,f,D,V,F,R]),je=d.useCallback(async()=>{if(z){if(D){console.log(`[Paper] Close ${a} ${z}`),G(z),k(null),L(null),w();return}try{const A=await Te.closePosition(z,l,f);A.status==="success"?(console.log(`[Scalping] Closed ${a} ${z}`),G(z),k(null),L(null),w()):(console.error("[Scalping] Close rejected:",A),ke.error(Ot(A,"Close position rejected")))}catch(A){console.error("[Scalping] Close failed:",A),ke.error(Ot(A,"Close position failed"))}}},[z,a,l,f,D,G,k,L,w]);if(!n||!z)return null;const ve=q&&$?q>$?"up":q<$?"down":"flat":"flat";return r?s.jsx("div",{ref:re,onMouseDown:de,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:E.x,top:E.y},children:s.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[s.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:z.slice(-10)}),s.jsx("span",{className:`text-xs font-bold tabular-nums ${ve==="up"?"text-green-500":ve==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(Re,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):s.jsxs("div",{ref:re,onMouseDown:de,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:E.x,top:E.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:z.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${ve==="up"?"text-green-500":ve==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(Re,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(Re,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>ee("BUY"),disabled:V,children:"BUY"}),s.jsx(Re,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>ee("SELL"),disabled:V,children:"SELL"}),s.jsx(Re,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:fe,disabled:V,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:T,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:u}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:se,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:b,onChange:A=>S(Number.parseFloat(A.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:g,onChange:A=>W(Number.parseFloat(A.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-amber-400",children:"TR:"}),s.jsx("input",{type:"number",min:0,step:.5,value:h,onChange:A=>N(Number.parseFloat(A.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:je,children:"x Close"})})]})}const Aa=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600},{label:"1D",sec:86400}];function Fa({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,showOrderFlow:i,onToggleEma9:a,onToggleEma21:o,onToggleSupertrend:c,onToggleVwap:l,onToggleOrderFlow:u}){const p=y(b=>b.chartInterval),f=y(b=>b.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Aa.map(b=>s.jsx(Re,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${p===b.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>f(b.sec),children:b.label},b.sec)),s.jsx(Da,{intervalSec:p}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(fn,{label:"EMA9",active:e,color:"text-amber-500",onClick:a}),s.jsx(fn,{label:"EMA21",active:t,color:"text-violet-500",onClick:o}),s.jsx(fn,{label:"ST",active:n,color:"text-cyan-500",onClick:c}),s.jsx(fn,{label:"VWAP",active:r,color:"text-pink-500",onClick:l}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(fn,{label:"FLOW",active:i,color:"text-emerald-500",onClick:u})]})}function Da({intervalSec:e}){const[t,n]=d.useState(()=>Un(e));d.useEffect(()=>{n(Un(e));const i=setInterval(()=>{n(Un(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:Oa(t,e)})}function Un(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function Oa(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function fn({label:e,active:t,color:n,onClick:r}){return s.jsx(Re,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function qs(){const[e,t]=d.useState(!0),[n,r]=d.useState(!0),[i,a]=d.useState(!0),[o,c]=d.useState(!0),[l,u]=d.useState(!1),p=d.useCallback(()=>t(m=>!m),[]),f=d.useCallback(()=>r(m=>!m),[]),b=d.useCallback(()=>a(m=>!m),[]),g=d.useCallback(()=>c(m=>!m),[]),h=d.useCallback(()=>u(m=>!m),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(Fa,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l,onToggleEma9:p,onToggleEma21:f,onToggleSupertrend:b,onToggleVwap:g,onToggleOrderFlow:h}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs(Qn,{orientation:"vertical",children:[s.jsx(_t,{defaultSize:"40%",minSize:"18%",children:s.jsx(ca,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(Fn,{withHandle:!0}),s.jsx(_t,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs(Qn,{orientation:"horizontal",children:[s.jsx(_t,{defaultSize:"50%",minSize:"20%",children:s.jsx(Vs,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l})}),s.jsx(Fn,{withHandle:!0}),s.jsx(_t,{defaultSize:"50%",minSize:"20%",children:s.jsx(Vs,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l})})]}),s.jsx(Ra,{})]})})]})})]})}function $t(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function $a(){const e=Le(x=>x.apiKey),t=Le(x=>x.setApiKey),n=y(x=>x.activeSide),r=y(x=>x.selectedCESymbol),i=y(x=>x.selectedPESymbol),a=y(x=>x.optionExchange),o=y(x=>x.quantity),c=y(x=>x.lotSize),l=y(x=>x.product),u=y(x=>x.orderType),p=y(x=>x.tpPoints),f=y(x=>x.slPoints),b=y(x=>x.trailDistancePoints),g=y(x=>x.limitPrice),h=y(x=>x.pendingLimitPlacement),m=y(x=>x.setLimitPrice),j=y(x=>x.setPendingEntryAction),P=y(x=>x.setPendingLimitPlacement),k=y(x=>x.clearPendingLimitPlacement),L=y(x=>x.paperMode),M=xe(x=>x.setVirtualTPSL),w=xe(x=>x.clearForSymbol),D=xe(x=>x.clearAll),O=xe(x=>x.triggerOrders),G=xe(x=>x.removeTriggerOrder),te=y(x=>x.setQuantity),C=y(x=>x.incrementQuantity),E=y(x=>x.decrementQuantity),Q=y(x=>x.setOrderType),se=y(x=>x.setProduct),T=y(x=>x.setTpPoints),S=y(x=>x.setSlPoints),W=y(x=>x.setTrailDistancePoints),N=y(x=>x.incrementTradeCount),R=n==="CE"?r:i,z=d.useCallback(async()=>{if(e)return e;try{const $=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if($.status==="success"&&$.api_key)return t($.api_key),$.api_key}catch(x){console.error("[Scalping] Failed to fetch API key:",x),ke.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),ke.error("API key missing. Generate one on /apikey"),null},[e,t]),V=d.useCallback(async x=>{if(!R){console.warn("[Scalping] No symbol selected — click a strike first"),ke.error("Select a strike first");return}if(u==="TRIGGER"){const re=Object.values(O).find(de=>de.symbol===R&&de.exchange===a&&de.side===n);re&&G(re.id),k(),m(null),j(x),console.log(`[Scalping] TRIGGER armed (${x}) — click chart to place trigger line`);return}if(u==="LIMIT"&&!g){j(x),console.log(`[Scalping] LIMIT armed (${x}) — click chart to set limit line`);return}if(u==="LIMIT"&&h&&h.symbol===R&&h.side===n){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),ke.error("A LIMIT order is already pending for this symbol");return}if(L){if(console.log(`[Paper] ${x} ${n} ${R} qty=${o*c} @ ${u}`),u==="MARKET"||u==="LIMIT"){const re=await At({symbol:R,exchange:a,preferredPrice:u==="LIMIT"?g??void 0:void 0});re>0&&(M(gt({symbol:R,exchange:a,side:n,action:x,entryPrice:re,quantity:o*c,tpPoints:p,slPoints:f,trailDistancePoints:b,managedBy:"manual"})),u==="LIMIT"&&m(null))}k(),N();return}const $=await z();if(!$)return;const H=u==="LIMIT"?"LIMIT":"MARKET",J={apikey:$,strategy:"Scalping",exchange:a,symbol:R,action:x,quantity:o*c,pricetype:H,product:l,price:u==="LIMIT"&&g?g:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${x} ${R} qty=${o*c} ${H}`);const re=await Te.placeOrder(J);if(re.status==="success"){const de=Gt(re);if(console.log(`[Scalping] Order placed: ${x} ${R} id=${de??"n/a"}`),j(null),H==="LIMIT"){g==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state.");const F=Sn(re),ee=_n(re);P({symbol:R,side:n,action:x,orderId:de,orderIds:F.length>0?F:void 0,splitLegs:ee.length>0?ee:void 0,quantity:o*c,entryPrice:g??0,tpPoints:p,slPoints:f,trailDistancePoints:b}),g!=null&&m(g);return}if(k(),N(),H==="MARKET"){const F=await At({symbol:R,exchange:a,apiKey:null}),ee=await Wt({symbol:R,exchange:a,orderId:de,preferredPrice:F>0?F:void 0,apiKey:$});ee>0&&M(gt({symbol:R,exchange:a,side:n,action:x,entryPrice:ee,quantity:o*c,tpPoints:p,slPoints:f,trailDistancePoints:b,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",re),ke.error($t(re,"Order was rejected"))}catch(re){console.error("[Scalping] Order failed:",re),ke.error($t(re,"Order placement failed"))}},[R,n,o,c,a,l,u,g,h,p,f,b,L,w,O,z,P,k,N,M,G,m,j]),B=d.useCallback(async()=>{if(R){if(L){console.log(`[Paper] Close ${n} ${R}`),w(R),m(null),j(null),k();return}try{const x=await Te.closePosition(R,a,l);x.status==="success"?(console.log(`[Scalping] Closed ${n} ${R}`),w(R),m(null),j(null),k()):(console.error("[Scalping] Close rejected:",x),ke.error($t(x,"Close position rejected")))}catch(x){console.error("[Scalping] Close failed:",x),ke.error($t(x,"Close position failed"))}}},[R,n,a,l,L,w,m,j,k]),q=d.useCallback(async()=>{if(L){console.log("[Paper] Close all positions"),D(),m(null),j(null),k();return}const x=Te.cancelAllOrders().catch($=>(console.warn("[Scalping] Cancel all orders failed:",$),{status:"error",message:$t($,"Cancel all orders failed")}));try{const $=await Te.closeAllPositions({verify:!1}),H=await x;$.status==="success"||$.status==="info"?(H.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",H),console.log("[Scalping] Closed all positions"),D(),m(null),j(null),k()):(console.error("[Scalping] Close all rejected:",$),ke.error($t($,"Close all rejected")))}catch($){console.error("[Scalping] Close all failed:",$),ke.error($t($,"Close all failed"))}},[L,D,m,j,k]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:R||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(Re,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>V("BUY"),disabled:!R,children:"BUY"}),s.jsx(Re,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>V("SELL"),disabled:!R,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Re,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:E,children:"-"}),s.jsx(kt,{type:"number",min:1,value:o,onChange:x=>te(Number.parseInt(x.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(Re,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:C,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*c," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(x=>s.jsx(Re,{variant:u===x?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>Q(x),children:x},x))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(x=>s.jsx(Re,{variant:l===x?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>se(x),children:x},x))})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(kt,{type:"number",min:0,step:5,value:p,onChange:x=>T(Number.parseFloat(x.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(kt,{type:"number",min:0,step:5,value:f,onChange:x=>S(Number.parseFloat(x.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-xs text-amber-400",children:"Trail SL"}),s.jsx(kt,{type:"number",min:0,step:.5,value:b,onChange:x=>W(Number.parseFloat(x.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(Re,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:B,disabled:!R,children:["Close ",n," Position"]}),s.jsx(Re,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:q,children:"Close All Positions"})]})]})}const yn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},Vr=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"adaptive-scalper",name:"Adaptive Scalper",description:"Aggressive scalping profile with lighter entry gates and faster re-entry.",config:{entryMomentumCount:3,entryMomentumVelocity:2,entryMinScore:4,entryMaxSpread:6,volumeLookbackTicks:14,indexVolumeMinRatio:1,optionVolumeMinRatio:1,sideVolumeDominanceRatio:1,volumeScoreWeight:1.25,trailInitialSL:10,trailBreakevenTrigger:6,trailLockTrigger:12,trailLockAmount:6,trailStartTrigger:15,trailStepSize:3,trailTightTrigger:24,trailTightStep:2,maxTradesPerDay:40,maxTradesPerMinute:10,minGapMs:1500,cooldownAfterLossSec:15,coolingOffAfterLosses:5,indexBiasEnabled:!0,indexBiasWeight:.2,optionsContextEnabled:!0,pcrBullishThreshold:.5,pcrBearishThreshold:1.6,maxPainProximityFilter:10,gexWallFilterEnabled:!1,ivSpikeExitEnabled:!1,respectHotZones:!1,sensitivityMultiplier:1.25,noTradeZoneEnabled:!1,reEntryEnabled:!0,reEntryDelaySec:8,reEntryMaxPerSide:6}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],za=["CE","PE"];function en(e=0){return za.reduce((t,n)=>(t[n]=e,t),{})}const _a=new Set(["1","true","yes","on","enabled"]),Ba=new Set(["0","false","no","off","disabled"]);function Va(e){if(typeof e=="boolean")return e;if(typeof e=="number")return Number.isFinite(e)?e!==0:null;if(typeof e=="string"){const t=e.trim().toLowerCase();if(_a.has(t))return!0;if(Ba.has(t))return!1}return null}function Wn(e){if(!e||typeof e!="object")return{};const t=e,n={};for(const r of Object.keys(yn)){if(!(r in t))continue;const i=yn[r],a=t[r];if(typeof i=="boolean"){const o=Va(a);o!=null&&(n[r]=o);continue}if(typeof i=="number"){const o=typeof a=="number"?a:typeof a=="string"?Number(a):Number.NaN;Number.isFinite(o)&&(n[r]=o)}}return n}const X=lr()(cr(e=>({config:{...yn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:en(),sideLastExitAt:en(),sideLossPnl:en(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...Wn(t)}})),applyPreset:t=>{const n=Vr.find(r=>r.id===t);n&&e({config:{...yn,...Wn(n.config)},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.accountPeakPnl,t),i=Math.max(0,r-t),a=Math.max(n.dailyPeakPnl,t),o=Math.max(0,a-t),c=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered,l=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:a,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:i,lockProfitTriggered:c,killSwitch:n.killSwitch||l}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,c=Math.max(n.dailyPeakPnl,o),l=Math.max(0,c-o),u=Math.max(n.autoPeakPnl,o),p=Math.max(0,u-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:c,dailyDrawdown:l,autoPeakPnl:u,autoDrawdown:p}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),c=Math.max(n.autoPeakPnl,i),l=Math.max(0,c-i),u=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,autoPeakPnl:c,autoDrawdown:l,lockProfitTriggered:u,killSwitch:n.killSwitch}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:en(),sideLastExitAt:en(),sideLossPnl:en(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const n=e??{};return{...t,...n,config:{...yn,...Wn(n.config??{})},activePresetId:n.activePresetId??t.activePresetId}}})),qa="Asia/Kolkata",Ka=new Intl.DateTimeFormat("en-GB",{timeZone:qa,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,hourCycle:"h23"}),Ks={JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12},Ga=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Ua=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function Jn(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Bn(e=new Date){const t={};for(const n of Ka.formatToParts(e))n.type!=="literal"&&(t[n.type]=n.value);return{year:Number(t.year),month:Number(t.month),day:Number(t.day),hours:Number(t.hour),minutes:Number(t.minute),seconds:Number(t.second)}}function Wa(e,t=new Date){const n=e.trim().toUpperCase();if(!n)return null;const r=n.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(r)return{year:Number(r[1]),month:Number(r[2]),day:Number(r[3])};const i=n.match(/^(\d{1,2})-([A-Z]{3})-(\d{2}|\d{4})$/);if(i){const o=Ks[i[2]];if(!o)return null;const c=Number(i[1]),l=i[3];return{year:l.length===2?2e3+Number(l):Number(l),month:o,day:c}}const a=n.match(/^(\d{1,2})-([A-Z]{3})$/);if(a){const o=Ks[a[2]];if(!o)return null;const{year:c}=Bn(t);return{year:c,month:o,day:Number(a[1])}}return null}function us(e=new Date){const{hours:t,minutes:n}=Bn(e);return{hours:t,minutes:n}}function qr(e){return e?Ua:Ga}function es(e=new Date,t=!1){const{hours:n,minutes:r}=us(e),i=n*60+r,a=qr(t);for(const o of a){const c=Jn(o.start),l=Jn(o.end);if(i>=c&&i<l)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function Gs(e=new Date,t=!1){const{hours:n,minutes:r}=us(e),i=n*60+r,a=qr(t);for(const o of a){const c=Jn(o.start);if(c>i)return{nextZone:o,minutesUntil:c-i}}return{nextZone:null,minutesUntil:0}}function Us(e,t=new Date){if(!e)return!1;try{const n=Wa(e,t);if(!n)return!1;const r=Bn(t);return n.year===r.year&&n.month===r.month&&n.day===r.day}catch{return!1}}function Ws(e=new Date){const{hours:t,minutes:n}=us(e),r=t*60+n;return r>=555&&r<930}function Hs(e=new Date){const{hours:t,minutes:n,seconds:r}=Bn(e);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}function Kr(){const e=y(r=>r.expiry),[t,n]=d.useState(()=>{const r=new Date,i=Us(e,r),{zone:a,sensitivity:o}=es(r,i),{nextZone:c,minutesUntil:l}=Gs(r,i);return{currentTime:Hs(r),currentZone:a,sensitivity:o,nextZone:c,minutesToNext:l,isExpiryDay:i,isOpen:Ws(r)}});return d.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Us(e,a),{zone:c,sensitivity:l}=es(a,o),{nextZone:u,minutesUntil:p}=Gs(a,o);n({currentTime:Hs(a),currentZone:c,sensitivity:l,nextZone:u,minutesToNext:p,isExpiryDay:o,isOpen:Ws(a)})},1e3);return()=>clearInterval(i)},[e]),t}function Ha(){const e=X(r=>r.activePresetId),t=X(r=>r.applyPreset),{isExpiryDay:n}=Kr();return s.jsx("div",{className:"space-y-1.5",children:Vr.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(Ve,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(Ve,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function Pe({label:e,field:t,step:n}){const r=X(a=>a.config[t]),i=X(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(ot,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(kt,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function ut({label:e,field:t}){const n=X(i=>i.config[t]),r=X(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(ot,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(mn,{checked:n===!0,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function at({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function Ya(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(at,{title:"Entry Conditions",children:[s.jsx(Pe,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(Pe,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(Pe,{label:"Min Score",field:"entryMinScore"}),s.jsx(Pe,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(at,{title:"Volume Flow",children:[s.jsx(ut,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),s.jsx(Pe,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),s.jsx(Pe,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),s.jsx(Pe,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),s.jsx(Pe,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),s.jsx(Pe,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),s.jsxs(at,{title:"Trailing SL (5-Stage)",children:[s.jsx(Pe,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(Pe,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(Pe,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(Pe,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(Pe,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(Pe,{label:"Trail Step",field:"trailStepSize"}),s.jsx(Pe,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(Pe,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(at,{title:"Breakeven",children:[s.jsx(Pe,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(Pe,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(at,{title:"Risk",children:[s.jsx(Pe,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(Pe,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(Pe,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(Pe,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(Pe,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(Pe,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(Pe,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(Pe,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(at,{title:"Imbalance Filter",children:[s.jsx(ut,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(Pe,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(at,{title:"Regime Detection",children:[s.jsx(Pe,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(Pe,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(at,{title:"Index Bias",children:[s.jsx(ut,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(Pe,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(at,{title:"Options Context",children:[s.jsx(ut,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(Pe,{label:"PCR Bullish ≤",field:"pcrBullishThreshold",step:.1}),s.jsx(Pe,{label:"PCR Bearish ≥",field:"pcrBearishThreshold",step:.1}),s.jsx(Pe,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(ut,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(ut,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(Pe,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(at,{title:"Time-of-Day",children:[s.jsx(ut,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(Pe,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(at,{title:"No-Trade Zone",children:[s.jsx(ut,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(Pe,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(Pe,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(at,{title:"Re-Entry",children:[s.jsx(ut,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(Pe,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(Pe,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(at,{title:"Telegram Alerts",children:[s.jsx(ut,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(ut,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(ut,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Za(){const e=X(r=>r.ghostSignals),t=X(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(Xa,{signal:r},r.id))]})}function Xa({signal:e}){const t=Le(f=>f.apiKey),n=y(f=>f.optionExchange),r=y(f=>f.quantity),i=y(f=>f.lotSize),a=y(f=>f.product),o=y(f=>f.paperMode),c=y(f=>f.incrementTradeCount),l=d.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),c();return}if(!t)return;const f={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const b=await Te.placeOrder(f);b.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${b.data?.orderid}`),c())}catch(b){console.error("[Ghost Take] Failed:",b)}},[e,t,n,r,i,a,o,c]),u=Math.round((Date.now()-e.timestamp)/1e3),p=u<60?`${u}s ago`:`${Math.round(u/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ve,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),s.jsxs(Ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(Re,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:l,children:"Take Trade"})]})]})}function Qa(){const e=X(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(Ve,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const ds={getBotStatus:async()=>(await xt.get("/telegram/bot/status")).data.data,startBot:async()=>(await xt.post("/telegram/bot/start")).data,stopBot:async()=>(await xt.post("/telegram/bot/stop")).data,getConfig:async()=>(await xt.get("/telegram/api/config")).data.data,updateConfig:async e=>(await xt.post("/telegram/config",e)).data,getUsers:async()=>(await xt.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await xt.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await xt.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await xt.post("/telegram/test-message")).data,sendBroadcast:async e=>(await xt.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await xt.post("/telegram/send-message",{telegram_id:e,message:t})).data};function Ja(){const[e,t]=d.useState(!1),[n,r]=d.useState(null),[i,a]=d.useState(null),[o,c]=d.useState(null),l=X(h=>h.updateConfig),u=X(h=>h.config),p=y(h=>h.underlying),f=d.useCallback(async()=>{try{const h=await Qr();r(h.provider||"none"),h.last_run&&a(h.last_run),c(null)}catch{c("Could not reach advisor")}},[]),b=d.useCallback(async()=>{t(!0),c(null);try{const h=await Jr({underlying:p});if(h.status==="success"&&h.run_id){const m=await ei(1);m.runs?.length>0&&a(m.runs[0])}else c(h.message||"Tuning failed")}catch{c("Advisor request failed")}finally{t(!1)}},[p]),g=d.useCallback(async()=>{if(i?.run_id){t(!0);try{await ti(i.run_id);const h=i.recommendations;if(h&&typeof h=="object"){const m={};for(const[j,P]of Object.entries(h)){if(!(j in u))continue;const k=j,L=u[k];if(typeof L=="number"){const M=typeof P=="number"?P:Number(P);Number.isFinite(M)&&(m[k]=M);continue}if(typeof L=="boolean"){let M=null;if(typeof P=="boolean")M=P;else if(typeof P=="number")M=P!==0;else if(typeof P=="string"){const w=P.trim().toLowerCase();["true","1","yes","on","enabled"].includes(w)&&(M=!0),["false","0","no","off","disabled"].includes(w)&&(M=!1)}M!=null&&(m[k]=M)}}if(Object.keys(m).length>0&&(l(m),u.telegramAlertsTune)){const j=Object.keys(m).join(", ");ds.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${j}`}).catch(()=>{})}}a(m=>m&&{...m,applied:!0}),c(null)}catch{c("Failed to apply recommendation")}finally{t(!1)}}},[i,l,u,p]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(Ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(Re,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:f,disabled:e,children:"Check Status"}),s.jsx(Re,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:b,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??"—"})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([h,m])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:h}),s.jsx("span",{className:"font-mono",children:typeof m=="number"?m:String(m)})]},h))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(Re,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:g,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(Ve,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function eo(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function to(){const e=X(x=>x.enabled),t=X(x=>x.mode),n=X(x=>x.replayMode),r=X(x=>x.regime),i=X(x=>x.tradesCount),a=X(x=>x.realizedPnl),o=X(x=>x.consecutiveLosses),c=X(x=>x.killSwitch),l=X(x=>x.lockProfitEnabled),u=X(x=>x.lockProfitTriggered),p=X(x=>x.accountPeakPnl),f=X(x=>x.accountDrawdown),b=X(x=>x.autoPeakPnl),g=X(x=>x.autoDrawdown),h=X(x=>x.sideEntryCount),m=X(x=>x.sideLastExitAt),j=X(x=>x.sideLossPnl),P=X(x=>x.lastDecisionBySide),k=X(x=>x.decisionHistory),L=X(x=>x.executionSamples),M=X(x=>x.config),w=X(x=>x.setEnabled),D=X(x=>x.setMode),O=X(x=>x.setReplayMode),G=X(x=>x.setKillSwitch),te=X(x=>x.setLockProfitEnabled),C=X(x=>x.resetRuntime),E=y(x=>x.activeSide),Q=y(x=>x.paperMode),se=xe(x=>x.virtualTPSL),T=d.useMemo(()=>P[E]??k[k.length-1]??null,[E,k,P]),S=d.useMemo(()=>T?Math.max(0,Math.min(99,Math.round(T.score/Math.max(1,T.minScore)*100))):r==="UNKNOWN"?0:55,[T,r]),W=d.useMemo(()=>Object.values(se).reduce((x,$)=>(x[$.side]+=$.quantity,x),{CE:0,PE:0}),[se]),N=d.useMemo(()=>Object.values(se).reduce((x,$)=>($.managedBy!=="auto"||(x[$.side]+=$.quantity),x),{CE:0,PE:0}),[se]),R=d.useMemo(()=>{const x=L.slice(-10),$=x.filter(F=>F.status==="filled"),H=x.filter(F=>F.status==="rejected"),J=$.length>0?$.reduce((F,ee)=>F+ee.spread,0)/$.length:0,re=$.length>0?$.reduce((F,ee)=>F+ee.expectedSlippage,0)/$.length:0,de=x.length>0?H.length/x.length*100:0;return{recent:x.slice().reverse(),avgSpread:J,avgSlippage:re,rejectRate:de}},[L]),z=T?T.spread<=M.entryMaxSpread*.4?"TIGHT":T.spread<=M.entryMaxSpread?"NORMAL":"WIDE":"NA",V=m[E]>0?Math.max(0,Math.round((Date.now()-m[E])/1e3)):null,B=e&&t==="execute"&&n,q=x=>x<=0?"0":`-${x.toFixed(0)}`;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ot,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(mn,{checked:e,onCheckedChange:w,className:"h-5 w-9"})]}),s.jsx(Ve,{variant:e?t==="execute"&&!n?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?B?"SIM (REPLAY)":t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(Re,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>D("ghost"),children:"Ghost (Signals Only)"}),s.jsx(Re,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>D("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(mn,{checked:n,onCheckedChange:O,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),B&&s.jsx("div",{className:"p-1 bg-amber-500/10 border border-amber-500/30 rounded text-amber-400 text-[10px] text-center font-medium",children:"EXECUTE BLOCKED - Replay/Simulator is ON"}),t==="execute"&&!Q&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(Ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:C,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),T?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[T.side," ",T.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${T.enter?"text-green-500":"text-red-500"}`,children:[T.score.toFixed(1)," / ",T.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:T.reason}),s.jsx("div",{className:"space-y-0.5",children:T.checks.slice(0,8).map(x=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:x.label}),s.jsxs("span",{className:`text-[10px] font-medium ${x.pass?"text-green-500":"text-red-500"}`,children:[x.pass?"PASS":"FAIL",x.value?` (${x.value})`:""]})]},x.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:eo(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[S,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:T&&!T.enter?T.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",E,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:V==null?"—":`${V}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${z==="WIDE"?"text-red-500":z==="TIGHT"?"text-green-500":""}`,children:z})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Execution Gate"}),s.jsx("span",{className:`font-medium ${B?"text-amber-400":t==="execute"?"text-green-500":"text-muted-foreground"}`,children:B?"BLOCKED (Replay)":t==="execute"?"OPEN":"Ghost Mode"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(T?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:T?.depthRatio!=null?T.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:R.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:R.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${R.rejectRate>30?"text-red-500":""}`,children:[R.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[R.recent.slice(0,5).map(x=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[x.side," ",x.symbol.slice(-10)]}),s.jsx("span",{className:x.status==="rejected"?"text-red-500":x.status==="filled"?"text-green-500":"text-muted-foreground",children:x.status})]},`${x.timestamp}-${x.symbol}`)),R.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[c&&s.jsx(Ve,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(mn,{checked:c,onCheckedChange:G,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[u&&s.jsx(Ve,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(mn,{checked:l,onCheckedChange:te,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),s.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),s.jsx("span",{className:`font-mono ${f>0?"text-red-500":""}`,children:f.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),s.jsx("span",{className:"font-mono",children:b.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),s.jsx("span",{className:`font-mono ${g>0?"text-red-500":""}`,children:g.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),s.jsx("span",{className:"font-mono",children:W.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),s.jsx("span",{className:"font-mono",children:W.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),s.jsx("span",{className:"font-mono",children:N.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),s.jsx("span",{className:"font-mono",children:N.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:h.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:h.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsx("span",{className:`font-mono ${j.CE>0?"text-red-500":""}`,children:q(j.CE)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsx("span",{className:`font-mono ${j.PE>0?"text-red-500":""}`,children:q(j.PE)})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Qa,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Za,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Ja,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(Ha,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(Ya,{})]})]})}function no(){const e=Le(f=>f.apiKey),t=y(f=>f.optionExchange),n=xe(f=>f.virtualTPSL),r=xe(f=>f.triggerOrders),i=xe(f=>f.removeVirtualTPSL),a=xe(f=>f.removeTriggerOrder),o=xe(f=>f.clearAll),{data:c}=ur({queryKey:["scalping-orders",t],queryFn:()=>Te.getOrders(e),enabled:!!e,refetchInterval:5e3}),l=(c?.data?.orders??[]).filter(f=>f.exchange===t&&(f.order_status==="open"||f.order_status==="pending"||f.order_status==="trigger pending")),u=Object.values(n),p=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(Ve,{variant:"outline",className:"text-[10px] h-4",children:l.length})]}),l.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:l.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",f.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ve,{variant:"outline",className:"text-[10px] h-4",children:f.order_status}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await Te.cancelOrder(f.orderid)}catch(b){console.error("Cancel failed:",b)}},children:"Cancel"})]})]},f.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(Ve,{variant:"outline",className:"text-[10px] h-4",children:u.length})]}),u.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:u.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.side==="CE"?"text-green-500":"text-red-500",children:f.side})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",f.entryPrice.toFixed(1)," |"," ",f.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",f.tpPrice.toFixed(1)]})," ",f.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",f.slPrice.toFixed(1)]})]})]}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(f.id),children:"Remove"})]},f.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(Ve,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:p.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",f.triggerPrice.toFixed(1)," (",f.direction,") | x",f.quantity]})]}),s.jsx(Re,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(f.id),children:"Remove"})]},f.id))})]}),(u.length>0||p.length>0)&&s.jsx(Re,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function so(e,t){const n=Le(p=>p.apiKey),[r,i]=d.useState(null),[a,o]=d.useState(!1),c=d.useRef(null),l=d.useCallback(async()=>{if(!(!e||!n)){try{const p=await Te.getDepth(n,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}o(!1)}},[e,t,n]);d.useEffect(()=>{if(!e){i(null);return}return o(!0),l(),c.current=setInterval(l,2e3),()=>{c.current&&clearInterval(c.current)}},[e,l]);const u=r?ro(r):null;return{depth:r,analytics:u,levels:5,isLoading:a}}function ro(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((g,h)=>g+h.quantity,0),i=n.reduce((g,h)=>g+h.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,c=t.length>0?t.reduce((g,h)=>h.quantity>g.quantity?h:g,t[0]):null,l=c?{price:c.price,qty:c.quantity}:null,u=n.length>0?n.reduce((g,h)=>h.quantity>g.quantity?h:g,n[0]):null,p=u?{price:u.price,qty:u.quantity}:null,f=r+i,b=f>0?(r-i)/f*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:l,largestAskWall:p,imbalanceScore:b}}function io(){const e=y(c=>c.activeSide),t=y(c=>c.optionExchange),n=y(c=>c.activeSide==="CE"?c.selectedCESymbol:c.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=so(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(Ve,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((c,l)=>{const u=r.bids?.[l],p=r.asks?.[l],f=Math.max(...r.bids?.map(b=>b.quantity)??[0],...r.asks?.map(b=>b.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:u&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${f>0?u.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:u.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:u?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${f>0?p.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},l)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Ys=500;function ao(){const e=d.useRef([]),t=d.useCallback(c=>{const l={...c,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(l),e.current.length>Ys&&(e.current=e.current.slice(-Ys)),l},[]),n=d.useCallback(()=>[...e.current],[]),r=d.useCallback(c=>e.current.slice(-c),[]),i=d.useCallback(()=>{e.current=[]},[]),a=d.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=d.useCallback(()=>{const c=e.current;if(c.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const l=c.filter(b=>b.pnl!==void 0),u=l.filter(b=>(b.pnl??0)>0),p=l.reduce((b,g)=>b+(g.pnl??0),0),f=l.map(b=>b.pnl??0);return{count:c.length,winRate:l.length>0?u.length/l.length*100:0,avgPnl:l.length>0?p/l.length:0,totalPnl:p,bestTrade:f.length>0?Math.max(...f):0,worstTrade:f.length>0?Math.min(...f):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function oo({liveOpenPnl:e,isLivePnl:t=!1}){const n=y(k=>k.sessionPnl),r=y(k=>k.tradeCount),i=y(k=>k.paperMode),a=i?n:e??n,o=Kr(),{getStats:c}=ao(),l=c(),[u,p]=d.useState(5e3),[f,b]=d.useState(500),[g,h]=d.useState(50),[m,j]=d.useState(3),P=a<0&&Math.abs(a)>=u;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsxs("span",{className:"font-mono text-sm font-bold tabular-nums",children:[o.currentTime," IST"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(Ve,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(Ve,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),P&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(kt,{type:"number",value:u,onChange:k=>p(Number(k.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(kt,{type:"number",value:f,onChange:k=>b(Number(k.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(kt,{type:"number",value:g,onChange:k=>h(Number(k.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ot,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(kt,{type:"number",value:m,onChange:k=>j(Number(k.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),l.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[l.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${l.avgPnl>0?"text-green-500":l.avgPnl<0?"text-red-500":""}`,children:[l.avgPnl>=0?"+":"",l.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",l.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:l.worstTrade.toFixed(0)})]})]})]})]})]})}const lo=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function co({liveOpenPnl:e,isLivePnl:t=!1}){const n=y(i=>i.controlTab),r=y(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:lo.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx($a,{}),n==="auto"&&s.jsx(to,{}),n==="risk"&&s.jsx(oo,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(io,{}),n==="orders"&&s.jsx(no,{})]})]})}const uo=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE ↔ PE)"},{key:"↑",description:"CE direct market buy (with virtual TP/SL)"},{key:"↓",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function po({open:e,onClose:t}){return d.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:uo.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function Zs(e,t){if(e&&typeof e=="object"){const n=e.response?.data;if(n&&typeof n=="object"){const i=n.message;if(typeof i=="string"&&i.trim().length>0)return i.trim();const a=n.error;if(typeof a=="string"&&a.trim().length>0)return a.trim()}else if(typeof n=="string"&&n.trim().length>0)return n.trim();const r=e.message;if(typeof r=="string"&&r.trim().length>0)return r.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function fo(e={}){const t=y(N=>N.hotkeysEnabled),n=y(N=>N.activeSide),r=y(N=>N.selectedCESymbol),i=y(N=>N.selectedPESymbol),a=y(N=>N.optionExchange),o=y(N=>N.quantity),c=y(N=>N.lotSize),l=y(N=>N.product),u=y(N=>N.orderType),p=y(N=>N.limitPrice),f=y(N=>N.pendingLimitPlacement),b=y(N=>N.setLimitPrice),g=y(N=>N.setPendingLimitPlacement),h=y(N=>N.clearPendingLimitPlacement),m=y(N=>N.tpPoints),j=y(N=>N.slPoints),P=y(N=>N.trailDistancePoints),k=y(N=>N.setPendingEntryAction),L=y(N=>N.paperMode),M=xe(N=>N.setVirtualTPSL),w=xe(N=>N.triggerOrders),D=xe(N=>N.removeTriggerOrder),O=y(N=>N.setActiveSide),G=y(N=>N.toggleActiveSide),te=y(N=>N.toggleFloatingWidget),C=y(N=>N.setQuantity),E=Le(N=>N.apiKey),Q=Le(N=>N.setApiKey),se=d.useCallback(()=>n==="CE"?r:i,[n,r,i]),T=d.useCallback(N=>N==="CE"?r:i,[r,i]),S=d.useCallback(async()=>{if(E)return E;try{const R=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(R.status==="success"&&R.api_key)return Q(R.api_key),R.api_key}catch(N){console.error("[Scalping] Failed to fetch API key:",N),ke.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),ke.error("API key missing. Generate one on /apikey"),null},[E,Q]),W=d.useCallback(async(N,R,z=!1)=>{const V=R??n,B=T(V),q=z?"MARKET":u;if(!B){console.warn("[Scalping] No symbol selected — click a strike first"),ke.error("Select a strike first");return}if(q==="TRIGGER"){const J=Object.values(w).find(re=>re.symbol===B&&re.exchange===a&&re.side===V);J&&D(J.id),h(),b(null),k(N),console.log(`[Scalping] TRIGGER armed (${N}) — click chart to place trigger line`);return}if(q==="LIMIT"&&!p){k(N),console.log(`[Scalping] LIMIT armed (${N}) — click chart to set limit line`);return}if(q==="LIMIT"&&f&&f.symbol===B&&f.side===V){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),ke.error("A LIMIT order is already pending for this symbol");return}if(L){if(console.log(`[Paper] ${N} ${V} ${B} qty=${o*c} @ ${q}`),q==="MARKET"||q==="LIMIT"){const J=await At({symbol:B,exchange:a,preferredPrice:q==="LIMIT"?p??void 0:void 0});J>0&&(M(gt({symbol:B,exchange:a,side:V,action:N,entryPrice:J,quantity:o*c,tpPoints:m,slPoints:j,trailDistancePoints:P,managedBy:"hotkey"})),q==="LIMIT"&&b(null))}h();return}const x=await S();if(!x)return;const $=q==="LIMIT"?"LIMIT":"MARKET",H={apikey:x,strategy:"Scalping",exchange:a,symbol:B,action:N,quantity:o*c,pricetype:$,product:l,price:q==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${N} ${B} qty=${o*c} ${$}`);const J=await Te.placeOrder(H);if(J.status==="success"){const re=Gt(J);if(console.log(`[Scalping] Order placed: ${N} ${B} id=${re??"n/a"}`),k(null),$==="LIMIT"){p==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state.");const de=Sn(J),F=_n(J);g({symbol:B,side:V,action:N,orderId:re,orderIds:de.length>0?de:void 0,splitLegs:F.length>0?F:void 0,quantity:o*c,entryPrice:p??0,tpPoints:m,slPoints:j,trailDistancePoints:P}),p!=null&&b(p);return}if(h(),$==="MARKET"){const de=await At({symbol:B,exchange:a,apiKey:null}),F=await Wt({symbol:B,exchange:a,orderId:re,preferredPrice:de>0?de:void 0,apiKey:x});F>0&&M(gt({symbol:B,exchange:a,side:V,action:N,entryPrice:F,quantity:o*c,tpPoints:m,slPoints:j,trailDistancePoints:P,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",J),ke.error(Zs(J,"Order was rejected"))}catch(J){console.error("[Scalping] Order failed:",J),ke.error(Zs(J,"Order placement failed"))}},[T,n,o,c,a,l,u,p,f,m,j,P,L,w,S,g,h,M,D,b,k]);d.useEffect(()=>{if(!t)return;const N=R=>{const z=R.target?.tagName;if(z==="INPUT"||z==="TEXTAREA"||z==="SELECT"||R.repeat)return;const V=se();switch(R.key.toLowerCase()){case"b":{R.preventDefault(),V&&(W("BUY"),e.onBuy?.(n,V));break}case"s":{R.preventDefault(),V&&(W("SELL"),e.onSell?.(n,V));break}case"c":{R.preventDefault(),V&&e.onClose?.(n,V);break}case"x":{R.preventDefault(),e.onCloseAll?.();break}case"r":{R.preventDefault(),V&&e.onReversal?.(n,V);break}case"w":{R.preventDefault(),te();break}case"tab":{R.preventDefault(),G();break}case"1":{R.preventDefault(),C(1);break}case"2":{R.preventDefault(),C(2);break}case"3":{R.preventDefault(),C(3);break}case"?":{R.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{R.preventDefault(),r&&(O("CE"),W("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{R.preventDefault(),i&&(O("PE"),W("BUY","PE",!0),e.onBuy?.("PE",i));break}}};return window.addEventListener("keydown",N),()=>window.removeEventListener("keydown",N)},[t,n,se,W,G,O,te,C,r,i,e])}const mo=300,Xs=2e3,Qs=15,Js=8e3,er=15e3;function rt(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function zn(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=rt(n,Number.NaN);return Number.isFinite(r)?r:null}function xo(e,t,n){if(!e.length)return null;const r=e.find(c=>c.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let c=1;c<e.length;c++){const l=Math.abs(e[c].strike-i);l<o&&(a=e[c],o=l)}return a}function ho(e){return rt(e.ce?.oi,0)+rt(e.pe?.oi,0)}function go(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(rt(zn(t,"net_gex"),0))||ho(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function yo(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const c of e){const l=c.strike,u=rt(c.ce?.oi,0),p=rt(c.pe?.oi,0);a>l?o+=(a-l)*u:a<l&&(o+=(l-a)*p)}o<r&&(r=o,n=a)}return n}function bo(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function tr(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!bo(e.topGammaStrikes,t.topGammaStrikes)}function nr(e,t){const n=zn(e,"iv");return n!=null&&n>0?n:t}function vo(e){return e.replace(/-/g,"").toUpperCase()}function sr(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=rt(e.underlying_ltp,0),a=rt(e.atm_strike,0),o=xo(r,a,i),c=r.reduce((D,O)=>(D.ceOi+=rt(O.ce?.oi,0),D.peOi+=rt(O.pe?.oi,0),D.ceVol+=rt(O.ce?.volume,0),D.peVol+=rt(O.pe?.volume,0),D),{ceOi:0,peOi:0,ceVol:0,peVol:0}),l=c.ceOi>0?c.peOi/c.ceOi:1,u=yo(r,o?.strike??a),p=i-u,f=go(r),b=zn(e,"total_net_gex"),g=b??0,h=t?.ceIV??Qs,m=t?.peIV??Qs,j=nr(o?.ce,h),P=nr(o?.pe,m),k=(j+P)/2,L=j-P,M=zn(e,"iv_percentile")??t?.ivPercentile??50,w=rt(o?.ce?.ltp,0)+rt(o?.pe?.ltp,0);return{pcr:l,oiChangeCE:c.ceOi,oiChangePE:c.peOi,maxPainStrike:u,spotVsMaxPain:p,topGammaStrikes:f,gexFlipZones:[],netGEX:g,atmIV:k,ivPercentile:M,ceIV:j,peIV:P,ivSkew:L,straddlePrice:w,lastUpdated:n>0?n:Date.now()}}function So(){const e=Le(m=>m.apiKey),t=y(m=>m.underlying),n=y(m=>m.expiry),r=y(m=>m.indexExchange),i=y(m=>m.chainStrikeCount),a=y(m=>m.optionChainData),o=y(m=>m.optionChainLastUpdate),c=y(m=>m.optionChainIsStreaming),l=X(m=>m.optionsContext),u=X(m=>m.setOptionsContext),p=d.useRef(0),f=d.useRef(!1),b=d.useRef(0),g=d.useRef(null);d.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const m=Date.now();if(m-p.current<mo)return;const j=sr(a,l,o||m);if(!j)return;const P=tr(l,j),k=!l||m-l.lastUpdated>=Xs;!P&&!k||(u(j),p.current=m)},[a,o,l,u]);const h=d.useCallback(async()=>{if(f.current||!e||!t||!n||!r)return;const m=Date.now();if(!(m-b.current<er||a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||m-(o||0)<=Js))){f.current=!0,b.current=m;try{const P=await dr.getOptionChain(e,t,r,vo(n),i);if(P.status!=="success"||!Array.isArray(P.chain)||P.chain.length===0)return;const k=sr(P,l,Date.now());if(!k)return;const L=tr(l,k),M=!l||Date.now()-l.lastUpdated>=Xs;if(!L&&!M)return;u(k),p.current=Date.now()}catch{}finally{f.current=!1}}},[e,t,n,r,i,a,c,o,l,u]);d.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||Date.now()-(o||0)<=Js)){g.current&&(clearInterval(g.current),g.current=null);return}return h(),g.current&&clearInterval(g.current),g.current=setInterval(()=>{h()},er),()=>{g.current&&(clearInterval(g.current),g.current=null)}},[a,c,o,h])}function Po(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let c=1;c<n.length;c++)n[c]>n[c-1]?r++:n[c]<n[c-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function jo(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(u=>u.high),i=n.map(u=>u.low),a=Math.max(...r)-Math.min(...i),o=n.map(u=>u.close),c=Math.abs(o[o.length-1]-o[0]),l=n.reduce((u,p)=>u+(p.high-p.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":c>a*.6?"TRENDING":l>a*.15?"VOLATILE":"RANGING"}function No(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function wo(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1));const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function ko(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function To(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function Eo(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Co(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function Lo(e,t,n,r,i,a,o,c,l,u,p,f=[],b){let g=0;const h=[],m=Date.now(),j=[],P=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,k=n.respectHotZones?l:1,L=Math.max(.25,k*Math.max(.1,n.sensitivityMultiplier)),M=Math.min(10,Math.max(1,n.entryMinScore/L)),w=($,H,J,re)=>{j.push({id:$,label:H,pass:J,value:re})},D=($,H)=>({enter:!1,reason:$,score:g,minScore:Number(M.toFixed(2)),checks:j,blockedBy:H,spread:u,depthRatio:P,expectedSlippage:Math.max(0,u/2)}),O=r.tradesCount<n.maxTradesPerDay;if(w("daily-trades","Daily trade cap",O,`${r.tradesCount}/${n.maxTradesPerDay}`),!O)return D("Max daily trades reached","daily-trades");const G=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(w("daily-loss","Daily loss limit",G,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!G)return D("Daily loss limit reached","daily-loss");const te=r.consecutiveLosses<n.coolingOffAfterLosses;if(w("cooling-off","Consecutive-loss cooling off",te,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!te)return D(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const C=!r.killSwitch;if(w("kill-switch","Kill switch",C),!C)return D("Kill switch active","kill-switch");const E=!n.respectHotZones||k>0;if(w("hot-zone","Market hot-zone timing",E,n.respectHotZones?k.toFixed(2):"OFF"),!E)return D("Outside configured market hot-zone timing","hot-zone");const Q=Math.max(0,r.openSideLots??0),se=r.allowEntryWithOpenSide===!0,T=!r.sideOpen||se;if(w("side-open","No open position on side",T,r.sideOpen?se?`Pyramid allowed (${Q.toFixed(1)} lots open)`:`${Q.toFixed(1)} lots open`:"0 lots"),!T)return D(`Position already open on ${e}`,"side-open");const S=r.reEntryCountForSide??0,W=r.lastExitAtForSide??0,N=n.reEntryEnabled===!0;if(w("reentry-setting","Re-entry",!0,N?"ON":"OFF (first entry only)"),N){if(w("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||S<n.reEntryMaxPerSide,`${S}/${n.reEntryMaxPerSide}`),n.reEntryMaxPerSide>0&&S>=n.reEntryMaxPerSide)return D(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryDelaySec>0&&W>0){const $=m-W,H=n.reEntryDelaySec*1e3,J=$>=H;if(w("reentry-delay","Re-entry delay",J,J?`${n.reEntryDelaySec}s`:`${Math.ceil((H-$)/1e3)}s left`),!J)return D(`Re-entry delay active: ${Math.ceil((H-$)/1e3)}s`,"reentry-delay")}}else{const $=S===0;if(w("reentry-first","First entry only",$,`${S}/1`),!$)return D(`Re-entry disabled for ${e}`,"reentry-first")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return w("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),D(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(w("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const $=r.lastTradePnl>-n.perTradeMaxLoss;if(w("per-trade-loss","Per-trade max loss",$,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!$)return D("Last trade breached per-trade max loss","per-trade-loss")}else w("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const $=m-r.lastTradeTime,H=$>=n.minGapMs;if(w("min-gap","Minimum gap between entries",H,H?`${$}ms`:`${n.minGapMs-$}ms left`),$<n.minGapMs)return D(`Min gap: ${Math.ceil((n.minGapMs-$)/1e3)}s remaining`,"min-gap")}else w("min-gap","Minimum gap between entries",!0);if(w("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return D(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const $=m-r.lastLossTime,H=n.cooldownAfterLossSec*1e3,J=$>=H;if(w("loss-cooldown","Cooldown after loss",J,J?`${n.cooldownAfterLossSec}s`:`${Math.ceil((H-$)/1e3)}s left`),$<H)return D(`Cooldown: ${Math.ceil((H-$)/1e3)}s after loss`,"loss-cooldown")}else w("loss-cooldown","Cooldown after loss",!0);if(p){const $=Co(p.totalBid,p.totalAsk,e,n);if(w("depth-imbalance","Depth imbalance",$.allowed,$.reason),!$.allowed)return D($.reason,"depth-imbalance")}else w("depth-imbalance","Depth imbalance",!0,"No depth data");if(w("spread","Spread gate",u<=n.entryMaxSpread,`${u.toFixed(2)}/${n.entryMaxSpread}`),u>n.entryMaxSpread)return D(`Spread too wide: ${u.toFixed(1)}`,"spread");if(n.volumeInfluenceEnabled){const $=Math.max(.1,n.indexVolumeMinRatio||1),H=Math.max(.1,n.optionVolumeMinRatio||1),J=Math.max(.1,n.sideVolumeDominanceRatio||1),re=Math.max(0,n.volumeScoreWeight||0),de=b?.indexDeltaRatio??null,F=b?.optionDeltaRatio??null,ee=b?.sideDominanceRatio??null,fe=b?.indexDelta,je=b?.optionDelta,ve=b?.oppositeDelta,A=de==null?!0:de>=$,ge=F==null?!0:F>=H,Ae=ee==null?!0:ee>=J;if(w("volume-index","Index volume flow",A,de==null?"NA":`${de.toFixed(2)}x/${$.toFixed(2)}x d:${(fe??0).toFixed(0)}`),w("volume-option",`${e} volume flow`,ge,F==null?"NA":`${F.toFixed(2)}x/${H.toFixed(2)}x d:${(je??0).toFixed(0)}`),w("volume-dominance",`${e} vs opposite volume`,Ae,ee==null?"NA":`${ee.toFixed(2)}x/${J.toFixed(2)}x opp:${(ve??0).toFixed(0)}`),F!=null&&ee!=null&&!ge&&!Ae)return D(`Weak ${e} volume participation`,"volume-option");de!=null&&A&&re>0&&(g+=.5*re,h.push(`IdxVol x${de.toFixed(2)}`)),F!=null&&ge&&re>0&&(g+=1*re,h.push(`${e}Vol x${F.toFixed(2)}`)),ee!=null&&Ae&&re>0&&(g+=.75*re,h.push(`${e}>Opp x${ee.toFixed(2)}`))}else w("volume-influence","Volume influence",!0,"OFF");const R=n.noTradeZoneEnabled&&No(f,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(w("no-trade-zone","No-trade zone filter",!R,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),R)return D(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const z=e==="CE"?"up":"down";w("momentum-direction","Momentum alignment",i.direction===z,`${i.direction} x${i.count}`),i.direction===z&&i.count>=n.entryMomentumCount?(g+=3,h.push(`Momentum ${i.direction} x${i.count}`)):i.direction===z&&(g+=1,h.push(`Weak momentum ${i.direction}`)),w("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(g+=2,h.push(`Velocity ${i.velocity.toFixed(1)}`));let V=!1;a.ema9!==null&&a.ema21!==null&&(V=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,V&&(g+=1,h.push("EMA aligned"))),w("ema","EMA alignment",V,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let B=!1;a.rsi!==null&&(B=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,B&&(g+=1,h.push(`RSI ${a.rsi.toFixed(0)}`))),w("rsi","RSI alignment",B,a.rsi!=null?a.rsi.toFixed(1):"NA");let q=!1;n.indexBiasEnabled&&(q=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",q&&(g+=1,h.push(`Index ${o.direction}`))),w("index-bias","Index bias alignment",n.indexBiasEnabled?q:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const x=ko(e,c,n);return w("options-context","Options context filter",x.allowed,x.reason),x.allowed?(w("score-gate","Final score gate",g>=M,`${g.toFixed(1)}/${M.toFixed(1)}`),{enter:g>=M,reason:h.join(", ")||"No strong signals",score:g,minScore:Number(M.toFixed(2)),checks:j,spread:u,depthRatio:P,expectedSlippage:Math.max(0,u/2)}):D(x.reason,"options-context")}function Mo(e,t,n,r,i,a,o){const c=i?n-t:t-n,l=i?r-t:t-r,u=To(a.trailInitialSL,o,a);if(e==="INITIAL"){const f=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return c>=f?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-u:t+u,newStage:"INITIAL"}}return e==="BREAKEVEN"?l>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?l>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?l>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function Io(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}const Ro=2;function rr(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function Ao(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let l=1;l<=t;l++){const u=e[l]-e[l-1];u>0?n+=u:r+=-u}let i=n/t,a=r/t;for(let l=t+1;l<e.length;l++){const u=e[l]-e[l-1],p=u>0?u:0,f=u<0?-u:0;i=(i*(t-1)+p)/t,a=(a*(t-1)+f)/t}if(a===0)return 100;const c=100-100/(1+i/a);return Number.isFinite(c)?c:null}function ir(e){return{ema9:rr(e,9),ema21:rr(e,21),supertrend:null,rsi:Ao(e,14),vwap:null}}function Hn(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function Yn(e,t,n=360){e.push(t),e.length>n&&e.splice(0,e.length-n)}function Zn(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const n=Math.max(3,t+1),r=e.slice(-n);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const i=[];for(let u=1;u<r.length;u++){const p=r[u]-r[u-1];i.push(p>0&&Number.isFinite(p)?p:0)}if(i.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const a=i[i.length-1],o=i.slice(0,-1),c=o.length>0?o.reduce((u,p)=>u+p,0)/o.length:0,l=c>0?a/c:null;return{latestDelta:a,avgDelta:c>0?c:null,ratio:l}}function Fo(e){return e==="TRAIL"||e==="TIGHT"||e==="ACCELERATED"}function Do(e){const n=Le(I=>I.apiKey),r=Le(I=>I.setApiKey),i=y(I=>I.underlying),a=y(I=>I.indexExchange),o=y(I=>I.selectedCESymbol),c=y(I=>I.selectedPESymbol),l=y(I=>I.optionExchange),u=y(I=>I.quantity),p=y(I=>I.lotSize),f=y(I=>I.product),b=y(I=>I.tpPoints),g=y(I=>I.slPoints),h=y(I=>I.selectedStrike),m=y(I=>I.paperMode),j=X(I=>I.enabled),P=X(I=>I.mode),k=X(I=>I.config),L=X(I=>I.activePresetId),M=X(I=>I.optionsContext),w=X(I=>I.regime),D=X(I=>I.consecutiveLosses),O=X(I=>I.tradesCount),G=X(I=>I.realizedPnl),te=X(I=>I.lastTradePnl),C=X(I=>I.lastTradeTime),E=X(I=>I.tradesThisMinute),Q=X(I=>I.lastLossTime),se=X(I=>I.sideEntryCount),T=X(I=>I.sideLastExitAt),S=X(I=>I.replayMode),W=X(I=>I.killSwitch),N=X(I=>I.setRegime),R=X(I=>I.addGhostSignal),z=X(I=>I.recordTrade),V=X(I=>I.recordAutoEntry),B=X(I=>I.pushDecision),q=X(I=>I.pushExecutionSample),x=xe(I=>I.virtualTPSL),$=xe(I=>I.setVirtualTPSL),H=d.useRef([]),J=d.useRef([]),re=d.useRef([]),de=d.useRef([]),F=d.useRef([]),ee=d.useRef([]),fe=d.useRef(0),je=d.useRef(!1),ve=d.useRef({CE:"",PE:""}),A=d.useRef({CE:0,PE:0}),ge=d.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}}),Ae=d.useRef(0),ze=d.useCallback(async()=>{if(n)return n;try{const Se=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(Se.status==="success"&&Se.api_key)return r(Se.api_key),Se.api_key}catch(I){console.error("[AutoTrade] Failed to fetch API key:",I)}return null},[n,r]);d.useEffect(()=>{if(!j||!e)return;const I=Date.now();if(I-fe.current<100)return;fe.current=I;const Se=o,U=c,ie=e.get(`${a}:${i}`)?.data?.ltp,Ne=Se?e.get(`${l}:${Se}`)?.data?.ltp:void 0,ye=U?e.get(`${l}:${U}`)?.data?.ltp:void 0,Fe=Hn(e.get(`${a}:${i}`)?.data?.volume),Ee=Se?Hn(e.get(`${l}:${Se}`)?.data?.volume):null,_=U?Hn(e.get(`${l}:${U}`)?.data?.volume):null;ie&&(H.current.push(ie),H.current.length>300&&(H.current=H.current.slice(-300))),Ne&&(J.current.push(Ne),J.current.length>300&&(J.current=J.current.slice(-300))),ye&&(re.current.push(ye),re.current.length>300&&(re.current=re.current.slice(-300))),Fe!=null&&Yn(de.current,Fe),Ee!=null&&Yn(F.current,Ee),_!=null&&Yn(ee.current,_);const oe=Math.max(5,Number(k.volumeLookbackTicks)||20),ce=Zn(de.current,oe),Oe=Zn(F.current,oe),Ge=Zn(ee.current,oe),Me=L==="expiry",{sensitivity:qe}=es(new Date,Me),Qe=M&&I-M.lastUpdated<=2e4?M:null;for(const Y of["CE","PE"]){const pe=Y==="CE"?Se:U,Ce=Y==="CE"?Ne:ye,Ie=Y==="CE"?J.current:re.current,st=Object.values(x).filter(be=>be.side===Y),yt=st.filter(be=>be.managedBy==="auto"),pt=st.length>0,bt=st.reduce((be,Ke)=>be+Math.max(0,Ke.quantity||0),0),_e=p>0?bt/p:0,Be=Number.isFinite(_e)?_e:0,Ue=Y==="CE"?Oe:Ge,We=Y==="CE"?Ge:Oe,ft=Ue.latestDelta!=null&&We.latestDelta!=null?Ue.latestDelta/Math.max(1,We.latestDelta):null,Ht={indexDelta:ce.latestDelta,indexDeltaRatio:ce.ratio,optionDelta:Ue.latestDelta,optionDeltaRatio:Ue.ratio,oppositeDelta:We.latestDelta,sideDominanceRatio:ft};if(!pe||!Ce||Ie.length<5)continue;let Je=0;for(const be of st){const Ke=`${be.exchange}:${be.symbol}`,et=e.get(Ke)?.data?.ltp??(be.symbol===pe?Ce:void 0);!et||et<=0||(Je+=be.action==="BUY"?(et-be.entryPrice)*be.quantity:(be.entryPrice-et)*be.quantity)}const on=yt.some(be=>Fo(be.trailStage)),vt=u+Ro,Tt=Math.max(0,Math.floor(vt-Be+1e-6)),Nt=L==="adaptive-scalper"&&pt&&yt.length>0&&on&&Je>0&&Tt>0,Yt=Nt?Math.max(1,Math.min(u,Tt)):u,Et=Po(Ie,k),wt=ir(Ie),v=ir(H.current),K=wo(v,k),ne=`${l}:${pe}`,Z=e.get(ne)?.data?.bid_price,ue=e.get(ne)?.data?.ask_price,he=Z&&ue?ue-Z:2,we=e.get(ne)?.data?.depth;let me;if(we?.buy?.length&&we?.sell?.length){const be=we.buy.reduce((et,St)=>et+(St.quantity||0),0),Ke=we.sell.reduce((et,St)=>et+(St.quantity||0),0);be>0&&Ke>0&&(me={totalBid:be,totalAsk:Ke})}const $e={consecutiveLosses:D,tradesCount:O,realizedPnl:G,lastTradeTime:C,tradesThisMinute:E,lastLossTime:Q,requestedLots:Nt?Be+Yt:u,sideOpen:pt,openSideLots:Be,allowEntryWithOpenSide:Nt,lastExitAtForSide:T[Y],reEntryCountForSide:se[Y],lastTradePnl:te,killSwitch:W},ae=Lo(Y,Ce,k,$e,Et,wt,K,Qe,qe,he,me,Ie,Ht),ct=`${ae.enter}|${ae.blockedBy??""}|${ae.reason}|${ae.score.toFixed(2)}|${ae.minScore.toFixed(2)}`;(ct!==ve.current[Y]||I-A.current[Y]>=1e3)&&(B({timestamp:I,side:Y,symbol:pe,enter:ae.enter,score:ae.score,minScore:ae.minScore,reason:ae.reason,blockedBy:ae.blockedBy,spread:ae.spread,depthRatio:ae.depthRatio,expectedSlippage:ae.expectedSlippage,checks:ae.checks,regime:w}),ve.current[Y]=ct,A.current[Y]=I);const mt=Io(Y,pe,h??0,Ce,ae,w,Qe?.pcr);if(mt){const be=`${pe}|${ae.reason}|${ae.score.toFixed(1)}`,Ke=ge.current[Y];(be!==Ke.sig||I-Ke.at>=2500)&&(R(mt),ge.current[Y]={at:I,sig:be},ke.message(`Signal ${Y} ${pe.slice(-12)}`,{description:`${ae.score.toFixed(1)} / ${ae.minScore.toFixed(1)} | ${ae.reason}`}))}if(P==="execute"&&!S&&ae.enter&&!je.current){je.current=!0;const be="BUY",Ke=Yt*p;(async()=>{const St=()=>{const tt=X.getState();return tt.enabled&&tt.mode==="execute"&&!tt.replayMode&&!tt.killSwitch};try{if(!St()){q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}const tt=m?null:await ze();if(!m&&!tt){q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Missing API key"}),Date.now()-Ae.current>5e3&&(Ae.current=Date.now(),ke.error("Auto execute blocked: API key missing"));return}let Ft=null;if(!m&&tt){const Yr={apikey:tt,strategy:"Scalping-Auto",exchange:l,symbol:pe,action:be,quantity:Ke,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},fs=await Te.placeOrder(Yr);if(fs.status!=="success"){q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Order rejected"});return}Ft=Gt(fs),console.log(`[AutoTrade] ${be} ${pe} id=${Ft??"n/a"} score=${ae.score}`)}else console.log(`[AutoTrade Paper] ${be} ${Y} ${pe} score=${ae.score}`);if(!St()){q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const Pn=m?await At({symbol:pe,exchange:l,preferredPrice:Ce,apiKey:null}):await Wt({symbol:pe,exchange:l,orderId:Ft,preferredPrice:Ce,apiKey:tt}),Gr=Math.max(2,Number(k.trailLockTrigger)||8),Ur=Math.max(2,Number(k.trailInitialSL)||5),Wr=b>0?b:Gr,Hr=g>0?g:Ur;Pn>0&&$(gt({symbol:pe,exchange:l,side:Y,action:be,entryPrice:Pn,quantity:Ke,tpPoints:Wr,slPoints:Hr,managedBy:"auto",autoEntryScore:ae.score,autoEntryReason:ae.reason})),z(0),V(Y),q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:Math.max(0,Math.abs((Pn>0?Pn:Ce)-Ce)),status:"filled",reason:ae.reason}),k.telegramAlertsEntry&&ds.sendBroadcast({message:`[AUTO ENTRY] ${Y} ${pe} qty=${Ke} score=${ae.score.toFixed(1)} reason=${ae.reason}`}).catch(()=>{})}catch(tt){q({timestamp:Date.now(),side:Y,symbol:pe,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",tt)}finally{je.current=!1}})()}}const Ze=H.current.length>=k.regimeDetectionPeriod?H.current:J.current;if(Ze.length>=k.regimeDetectionPeriod){const Y=Ze.slice(-k.regimeDetectionPeriod).map((Ce,Ie,st)=>({high:Math.max(Ce,st[Math.max(0,Ie-1)]??Ce),low:Math.min(Ce,st[Math.max(0,Ie-1)]??Ce),close:Ce})),pe=jo(Y,k);pe!==w&&N(pe)}},[j,e,P,k,L,o,c,M,w,D,O,G,C,E,Q,te,se,T,S,W,ze,l,u,p,f,b,g,m,h,R,z,V,B,q,N,x,$,i,a])}const Oo=3e3;function $o(e){const t=Le(C=>C.apiKey),n=Le(C=>C.setApiKey),r=y(C=>C.paperMode),i=y(C=>C.product),a=y(C=>C.trailDistancePoints),o=y(C=>C.addSessionPnl),c=y(C=>C.incrementTradeCount),l=X(C=>C.config),u=X(C=>C.activePresetId),p=X(C=>C.optionsContext),f=X(C=>C.recordAutoExit),b=X(C=>C.recordTradeOutcome),g=X(C=>C.pushExecutionSample),h=xe(C=>C.virtualTPSL),m=xe(C=>C.triggerOrders),j=xe(C=>C.removeTriggerOrder),P=xe(C=>C.setVirtualTPSL),k=xe(C=>C.removeVirtualTPSL),L=d.useRef(t),M=d.useRef(r),w=d.useRef(i);d.useEffect(()=>{L.current=t},[t]),d.useEffect(()=>{M.current=r},[r]),d.useEffect(()=>{w.current=i},[i]);const D=d.useRef(new Set),O=d.useCallback(async()=>{if(L.current)return L.current;try{const E=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(E.status==="success"&&E.api_key)return L.current=E.api_key,n(E.api_key),E.api_key}catch(C){console.error("[Scalping] Failed to fetch API key:",C)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[n]),G=d.useCallback(async(C,E,Q,se,T)=>{const S=se==="BUY"?"SELL":"BUY";if(M.current)return console.log(`[Paper TP/SL] ${T}: ${S} ${C} qty=${Q}`),!0;const W=await O();if(!W)return!1;const N={apikey:W,strategy:"Scalping",exchange:E,symbol:C,action:S,quantity:Q,pricetype:"MARKET",product:w.current,price:0,trigger_price:0,disclosed_quantity:0};try{const R=await Te.placeOrder(N);if(R.status==="success"){const z=Gt(R);return console.log(`[Scalping TP/SL] ${T}: ${S} ${C} id=${z??"n/a"}`),!0}}catch(R){console.error(`[Scalping TP/SL] ${T} order failed:`,R)}try{if((await Te.closePosition(C,E,w.current)).status==="success")return console.log(`[Scalping TP/SL] ${T}: closePosition fallback ${C}`),!0}catch(R){console.error(`[Scalping TP/SL] ${T} closePosition fallback failed:`,R)}return!1},[O]),te=d.useCallback(async(C,E,Q,se)=>{if(M.current)return console.log(`[Paper Trigger] Entry: ${se} ${C} qty=${Q}`),{ok:!0,orderId:null};const T=await O();if(!T)return{ok:!1,orderId:null};const S={apikey:T,strategy:"Scalping",exchange:E,symbol:C,action:se,quantity:Q,pricetype:"MARKET",product:w.current,price:0,trigger_price:0,disclosed_quantity:0};try{const W=await Te.placeOrder(S);if(W.status==="success"){const N=Gt(W);return console.log(`[Scalping Trigger] Entry: ${se} ${C} id=${N??"n/a"}`),{ok:!0,orderId:N}}}catch(W){console.error("[Scalping Trigger] Entry failed:",W)}return{ok:!1,orderId:null}},[O]);d.useEffect(()=>{if(!e)return;const C=(E,Q,se)=>{D.current.add(E.id);const S=E.action==="BUY"?(Q-E.entryPrice)*E.quantity:(E.entryPrice-Q)*E.quantity;G(E.symbol,E.exchange,E.quantity,E.action,`${se} at ${Q}`).then(W=>{W&&(k(E.id),o(S),c(),E.managedBy==="auto"&&(f(E.side,S),b(S),g({timestamp:Date.now(),side:E.side,symbol:E.symbol,spread:0,expectedSlippage:0,status:"exited",reason:se}),l.telegramAlertsExit&&ds.sendBroadcast({message:`[AUTO EXIT] ${E.side} ${E.symbol} pnl=${S.toFixed(0)} reason=${se}`}).catch(()=>{}))),D.current.delete(E.id)})};for(const E of Object.values(h)){const Q=`${E.exchange}:${E.symbol}`,T=(e.get(Q)??e.get(E.symbol))?.data?.ltp;if(!T||D.current.has(E.id))continue;const S=E.action==="BUY",W=S?(T-E.entryPrice)*E.quantity:(E.entryPrice-T)*E.quantity;if(E.managedBy==="auto"){if(l.perTradeMaxLoss>0&&W<=-l.perTradeMaxLoss){C(E,T,`Per-trade max loss ${l.perTradeMaxLoss}`);continue}if(Math.max(0,Date.now()-(E.createdAt||0))>=Oo){const R=u==="adaptive-scalper"?{...l,ivSpikeExitEnabled:!1}:l,z=Eo(E.side,p,R);if(z.exit){C(E,T,`Options early-exit: ${z.reason}`);continue}}}if(E.tpPrice!==null&&(S?T>=E.tpPrice:T<=E.tpPrice)){C(E,T,"TP hit");continue}E.slPrice!==null&&(S?T<=E.slPrice:T>=E.slPrice)&&C(E,T,"SL hit")}for(const E of Object.values(m)){const Q=`${E.exchange}:${E.symbol}`,T=(e.get(Q)??e.get(E.symbol))?.data?.ltp;if(!T||D.current.has(E.id))continue;(E.direction==="above"?T>=E.triggerPrice:T<=E.triggerPrice)&&(D.current.add(E.id),te(E.symbol,E.exchange,E.quantity,E.action).then(async({ok:W,orderId:N})=>{try{if(W&&(j(E.id),c(),T>0)){const R=L.current,z=M.current?T:await Wt({symbol:E.symbol,exchange:E.exchange,orderId:N,preferredPrice:T,apiKey:R});z>0&&P(gt({symbol:E.symbol,exchange:E.exchange,side:E.side,action:E.action,entryPrice:z,quantity:E.quantity,tpPoints:E.tpPoints,slPoints:E.slPoints,trailDistancePoints:E.trailDistancePoints??a,managedBy:"trigger"}))}}finally{D.current.delete(E.id)}}))}},[e,h,m,G,te,j,P,k,o,c,a,l,u,p,f,b,g])}const zo=2,It=.05;function ts(e){return Math.round(e/It)*It}function _o(e){return e.slPrice==null?!1:e.managedBy==="auto"||e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"}function Bo(e,t){return e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"?!0:e.managedBy==="auto"&&t==="adaptive-scalper"}function ar(e,t){const n={slPrice:t};if(e.tpPrice==null||e.slPrice==null)return n;const r=t-e.slPrice;if(Math.abs(r)<It)return n;const i=ts(e.tpPrice+r),o=e.action==="BUY"?Math.max(e.tpPrice,i):Math.min(e.tpPrice,i);return Math.abs(o-e.tpPrice)>=It&&(n.tpPrice=o),n}function Vo(){const e=X(m=>m.config),t=X(m=>m.activePresetId),n=X(m=>m.optionsContext),r=X(m=>m.setTrailStage),i=X(m=>m.setHighSinceEntry),a=xe(m=>m.virtualTPSL),o=xe(m=>m.updateVirtualTPSL),c=d.useRef(e),l=d.useRef(t),u=d.useRef(n),p=d.useRef({}),f=d.useRef({}),b=d.useRef({}),g=d.useRef({});d.useEffect(()=>{c.current=e},[e]),d.useEffect(()=>{l.current=t},[t]),d.useEffect(()=>{u.current=n},[n]);const h=d.useMemo(()=>Object.values(a).filter(m=>_o(m)),[a]);d.useEffect(()=>{const m=nn.getInstance(),j=new Set(h.map(P=>P.id));for(const[P,k]of Object.entries(g.current))j.has(P)||(k(),delete g.current[P],delete p.current[P],delete f.current[P],delete b.current[P]);for(const P of h)g.current[P.id]||(p.current[P.id]=P.trailStage??"INITIAL",f.current[P.id]=P.entryPrice,b.current[P.id]=P.slPrice??P.entryPrice,g.current[P.id]=m.subscribe(P.symbol,P.exchange,"LTP",k=>{const L=k.data.ltp;if(!L||L<=0)return;const M=xe.getState().virtualTPSL[P.id];if(!M||M.slPrice==null)return;const w=M.managedBy==="auto",D=M.action==="BUY",O=f.current[P.id]??M.entryPrice,G=D?Math.max(O,L):Math.min(O,L);if(G!==O&&(f.current[P.id]=G,w&&i(G)),Bo(M,l.current)){if(!(D?L>M.entryPrice:L<M.entryPrice))return;p.current[P.id]!=="TRAIL"&&(p.current[P.id]="TRAIL",w&&r("TRAIL"),o(P.id,{trailStage:"TRAIL"}));const R=typeof M.trailDistancePoints=="number"&&M.trailDistancePoints>0?M.trailDistancePoints:zo,z=D?L-R:L+R,V=ts(z),B=M.slPrice,q=b.current[P.id],x=D?Math.max(B??V,V):Math.min(B??V,V),$=B==null||Math.abs(x-B)>=It,H=q==null||Math.abs(x-q)>=It;$&&H&&(b.current[P.id]=x,o(P.id,ar(M,x)));return}const te=p.current[P.id]??"INITIAL",C=Mo(te,M.entryPrice,L,G,D,c.current,u.current);C.newStage!==te&&(p.current[P.id]=C.newStage,w&&r(C.newStage),o(P.id,{trailStage:C.newStage}));const E=ts(C.newSL),Q=M.slPrice,se=b.current[P.id],T=D?Math.max(Q??E,E):Math.min(Q??E,E),S=Q==null||Math.abs(T-Q)>=It,W=se==null||Math.abs(T-se)>=It;S&&W&&(b.current[P.id]=T,o(P.id,ar(M,T)))}));return()=>{}},[h,i,r,o]),d.useEffect(()=>()=>{for(const m of Object.values(g.current))m();g.current={},p.current={},f.current={},b.current={}},[])}const qo=1e3,Ko=1500,Go=3e3;function ps(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Rt(e){return ps(e)??0}function Uo(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Wo(e){const t=ps(e.pnl);if(t!==null)return t;const n=Rt(e.ltp),r=Rt(e.average_price),i=Math.abs(Rt(e.quantity));return(Rt(e.quantity)>0?n-r:r-n)*i}function Ho(){const e=Le(w=>w.apiKey),t=Le(w=>w.setApiKey),n=zt(w=>w.unifiedMode),r=zt(w=>w.executionBroker),[i,a]=d.useState([]),[o,c]=d.useState(!1),l=d.useRef(!1),u=d.useCallback(async()=>{if(e)return e;try{const D=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(D.status==="success"&&D.api_key)return t(D.api_key),D.api_key}catch{}return null},[e,t]),p=d.useCallback(async()=>{if(l.current)return;l.current=!0;const w=await u();if(!w){c(!1),l.current=!1;return}c(!0);try{const D=await Te.getPositions(w);D.status==="success"&&D.data&&a(Array.isArray(D.data)?D.data:[])}catch{}finally{c(!1),l.current=!1}},[u]),f=d.useMemo(()=>n?r==="dhan"?Go:Ko:qo,[n,r]);d.useEffect(()=>{p();const w=setInterval(p,f);return()=>clearInterval(w)},[p,f]);const{data:b,isLive:g,isPaused:h}=ni(i,{enabled:!n&&i.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),m=d.useMemo(()=>n?i:b,[n,i,b]),j=d.useMemo(()=>m.flatMap(w=>{const D=Uo(w.symbol);if(!D)return[];const O=Rt(w.quantity),G=Math.abs(O);if(G===0)return[];const te=Rt(w.ltp),C=Rt(w.average_price),E=O>0,Q=E?te-C:C-te,T=ps(w.pnl)??Q*G;return[{symbol:w.symbol,exchange:w.exchange,side:D,action:E?"BUY":"SELL",quantity:G,avgPrice:C,ltp:te,pnl:T,pnlPoints:Q,product:w.product}]}),[m]),P=d.useMemo(()=>i.some(w=>Rt(w.quantity)!==0),[i]),k=d.useMemo(()=>m.reduce((w,D)=>w+Wo(D),0),[m]),L=d.useCallback(w=>j.find(D=>D.side===w),[j]),M=d.useMemo(()=>i.map(w=>({symbol:w.symbol,exchange:w.exchange})),[i]);return{positions:j,totalPnl:k,isLive:!n&&g&&P,isPaused:!n&&h,isLoading:o,refetch:p,getPositionForSide:L,positionSymbols:M}}const Yo=1e3,Zo=100;function In(e){const t=Number(e);return Number.isFinite(t)&&t>0?t:null}function Xo(e){const t=String(e??"").trim().toUpperCase();return t==="BUY"||t==="SELL"?t:null}function Qo(e,t){const n=String(e??"").trim().toUpperCase();return n==="CE"||n==="PE"?n:t.toUpperCase().endsWith("PE")?"PE":"CE"}function Jo(){const e=Le(l=>l.apiKey),t=Le(l=>l.setApiKey),n=y(l=>l.tpPoints),r=y(l=>l.slPoints),i=xe(l=>l.setVirtualTPSL),a=d.useRef(!1),o=d.useCallback(async()=>{if(e)return e;try{const u=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(u.status==="success"&&u.api_key)return t(u.api_key),u.api_key}catch{}return null},[e,t]),c=d.useCallback(async(l,u)=>{const p=Number(l.id);if(!Number.isInteger(p)||p<=0)return!1;const f=String(l.symbol??"").trim().toUpperCase(),b=String(l.exchange??"NFO").trim().toUpperCase(),g=Xo(l.action),h=Math.trunc(In(l.quantity)??0);if(!f||!g||h<=0)return!1;const m=`flow-${p}`;if(xe.getState().virtualTPSL[m])return!0;const P=Qo(l.side,f),k=In(l.tp_points)??n,L=In(l.sl_points)??r,M=In(l.entry_price),w=String(l.order_id??"").trim()||null,D=await Wt({symbol:f,exchange:b,orderId:w,preferredPrice:M,fallbackPrice:M,apiKey:u});if(!(D>0))return!1;const O=Number(l.created_at);return i(gt({id:m,symbol:f,exchange:b,side:P,action:g,entryPrice:D,quantity:h,tpPoints:k,slPoints:L,managedBy:"flow",createdAt:Number.isFinite(O)&&O>0?O:Date.now()})),!0},[n,r,i]);d.useEffect(()=>{let l=!0,u=null;async function p(){if(!l||a.current){f();return}a.current=!0;try{const b=await o();if(!b)return;const g=await Te.getScalpingBridgePending(b,Zo),h=Array.isArray(g.data?.entries)?g.data.entries:[];if(!h.length)return;const m=[];for(const j of h)try{await c(j,b)&&m.push(Number(j.id))}catch{}m.length&&await Te.ackScalpingBridgeEntries(b,m)}catch{}finally{a.current=!1,f()}}function f(){l&&(u=setTimeout(p,Yo))}return p(),()=>{l=!1,u&&clearTimeout(u)}},[c,o])}const el=15e3;function Lt(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function yl(){const[e,t]=d.useState(!1),[n,r]=d.useState(!1),i=d.useRef(!1),a=d.useCallback(()=>t(F=>!F),[]),o=d.useCallback(()=>t(!1),[]),c=d.useCallback(()=>r(F=>!F),[]),l=y(F=>F.paperMode),u=y(F=>F.underlying),p=y(F=>F.indexExchange),f=y(F=>F.optionExchange),b=y(F=>F.product),g=y(F=>F.quantity),h=y(F=>F.lotSize),m=y(F=>F.tpPoints),j=y(F=>F.slPoints),P=y(F=>F.trailDistancePoints),k=y(F=>F.incrementTradeCount),L=y(F=>F.setLimitPrice),M=y(F=>F.setPendingEntryAction),w=y(F=>F.pendingLimitPlacement),D=y(F=>F.clearPendingLimitPlacement),O=y(F=>F.selectedCESymbol),G=y(F=>F.selectedPESymbol),te=xe(F=>F.virtualTPSL),C=xe(F=>F.triggerOrders),E=xe(F=>F.clearAll),Q=xe(F=>F.clearForSymbol),se=xe(F=>F.clearTriggerOrders),T=xe(F=>F.removeVirtualTPSL),S=xe(F=>F.updateVirtualTPSL),W=xe(F=>F.setVirtualTPSL),N=X(F=>F.config.imbalanceFilterEnabled),R=X(F=>F.updateRiskState),z=Le(F=>F.apiKey),V=Le(F=>F.setApiKey),{positions:B,totalPnl:q,isLive:x}=Ho();d.useEffect(()=>{z||fetch("/api/websocket/apikey",{credentials:"include"}).then(F=>F.json()).then(F=>{F.status==="success"&&F.api_key&&V(F.api_key)}).catch(()=>{})},[z,V]),d.useEffect(()=>{se()},[se]);const $=d.useCallback(async(F,ee)=>{if(l){console.log(`[Paper] Close ${F} ${ee}`),Q(ee),L(null),M(null),D();return}try{const fe=B.find(ve=>ve.symbol===ee&&ve.side===F),je=await Te.closePosition(ee,f,b,{knownQuantity:fe?.quantity,knownAction:fe?.action});if(je.status!=="success"&&je.status!=="info"){console.error("[Scalping] Close rejected:",je),ke.error(Lt(je,"Close position rejected"));return}console.log(`[Scalping] Closed ${F} ${ee}`),Q(ee),L(null),M(null),D()}catch(fe){console.error("[Scalping] Close failed:",fe),ke.error(Lt(fe,"Close position failed"))}},[l,f,b,B,Q,L,M,D]),H=d.useCallback(async()=>{if(l){console.log("[Paper] Close all positions"),E(),L(null),M(null),D();return}const F=Te.cancelAllOrders().catch(ee=>(console.warn("[Scalping] Cancel all orders failed:",ee),{status:"error",message:Lt(ee,"Cancel all orders failed")}));try{const ee=await Te.closeAllPositions({verify:!1}),fe=await F;if(ee.status!=="success"&&ee.status!=="info"){console.error("[Scalping] Close all rejected:",ee),ke.error(Lt(ee,"Close all positions rejected"));return}fe.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",fe),console.log("[Scalping] Closed all positions"),E(),L(null),M(null),D()}catch(ee){console.error("[Scalping] Close all failed:",ee),ke.error(Lt(ee,"Close all positions failed"))}},[l,E,L,M,D]),J=d.useCallback(async(F,ee)=>{if(l){console.log(`[Paper] Reverse ${F} ${ee}`);return}if(z)try{const fe=B.find(A=>A.symbol===ee&&A.side===F),je=await Te.closePosition(ee,f,b,{knownQuantity:fe?.quantity,knownAction:fe?.action});if(je.status!=="success"&&je.status!=="info"){console.error("[Scalping] Reversal close rejected:",je),ke.error(Lt(je,"Reversal close failed"));return}const ve=await Te.placeOrder({apikey:z,strategy:"Scalping",exchange:f,symbol:ee,action:"SELL",quantity:g*h,pricetype:"MARKET",product:b,price:0,trigger_price:0,disclosed_quantity:0});if(ve.status!=="success"){console.error("[Scalping] Reversal open rejected:",ve),ke.error(Lt(ve,"Reversal open failed"));return}console.log(`[Scalping] Reversed ${F} ${ee}`)}catch(fe){console.error("[Scalping] Reversal failed:",fe),ke.error(Lt(fe,"Reversal failed"))}},[l,z,f,b,g,h,B]);fo({onToggleHelp:a,onClose:$,onCloseAll:H,onReversal:J}),So();const re=d.useMemo(()=>{const F=[];u&&p&&F.push({symbol:u,exchange:p}),O&&F.push({symbol:O,exchange:f}),G&&F.push({symbol:G,exchange:f});for(const fe of Object.values(te))F.push({symbol:fe.symbol,exchange:fe.exchange});for(const fe of Object.values(C))F.push({symbol:fe.symbol,exchange:fe.exchange});const ee=new Map;for(const fe of F)ee.set(`${fe.exchange}:${fe.symbol}`,fe);return Array.from(ee.values())},[u,p,O,G,f,te,C]),{data:de}=hn({symbols:re,mode:N?"Quote":"LTP",enabled:re.length>0});return Jo(),d.useEffect(()=>{R(q)},[q,R]),d.useEffect(()=>{if(l)return;const F=new Map(B.map(I=>[I.symbol,I])),ee=Object.values(te);for(const I of ee){const Se=F.get(I.symbol);if(!Se){const U=typeof I.createdAt=="number"?I.createdAt:0;if((U>0?Date.now()-U:Number.POSITIVE_INFINITY)<el)continue;T(I.id);continue}(Se.side!==I.side||Se.action!==I.action||I.quantity<=0)&&T(I.id)}const fe=Object.values(xe.getState().virtualTPSL),je=new Map;for(const I of fe){const Se=je.get(I.symbol)??[];Se.push(I),je.set(I.symbol,Se)}for(const[I,Se]of je.entries()){const U=F.get(I);if(!U)continue;const ie=Math.max(0,U.quantity);let ye=Se.reduce((Ee,_)=>Ee+Math.max(0,_.quantity),0)-ie;if(ye<=0)continue;const Fe=[...Se].sort((Ee,_)=>_.createdAt-Ee.createdAt);for(const Ee of Fe){if(ye<=0)break;const _=Math.max(0,Ee.quantity);if(_<=ye+1e-6){T(Ee.id),ye-=_;continue}const oe=Math.max(0,Number((_-ye).toFixed(2)));S(Ee.id,{quantity:oe}),ye=0}}if(!w||i.current)return;const ve=B.filter(I=>I.symbol===w.symbol);if(ve.length===0)return;const A=ve.find(I=>I.side===w.side&&I.action===w.action),ge=A??ve[0],Ae=A?w.side:ge.side,ze=A?w.action:ge.action;i.current=!0,(async()=>{try{const I=ge.avgPrice>0?ge.avgPrice:ge.ltp,Se=w.entryPrice>0?w.entryPrice:I,U=w.orderId??w.orderIds?.[0]??w.splitLegs?.[0]?.orderId??null,ie=await Wt({symbol:w.symbol,exchange:ge.exchange,orderId:U,preferredPrice:Se,fallbackPrice:I,apiKey:z});if(ie<=0){console.warn("[Scalping] Pending LIMIT fill attach skipped: no valid entry price",{symbol:w.symbol,orderId:U,pendingEntry:w.entryPrice,fallbackPrice:I});return}const Ne=Math.max(0,ge.quantity),ye=Math.max(0,w.quantity),Fe=Ne>0?Math.max(1,Math.min(ye,Ne)):ye;if(Fe<=0)return;W(gt({symbol:w.symbol,exchange:ge.exchange,side:Ae,action:ze,entryPrice:ie,quantity:Fe,tpPoints:w.tpPoints>0?w.tpPoints:m,slPoints:w.slPoints>0?w.slPoints:j,trailDistancePoints:w.trailDistancePoints>0?w.trailDistancePoints:P,managedBy:"manual"})),console.info("[Scalping] Pending LIMIT fill attached to virtual TP/SL",{symbol:w.symbol,side:Ae,action:ze,quantity:Fe,entryPrice:ie,orderId:U}),k(),D(),L(null),M(null)}finally{i.current=!1}})()},[l,B,te,w,z,T,S,W,m,j,P,k,D,L,M]),Do(de),Vo(),$o(de),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(zi,{liveOpenPnl:q,isLivePnl:x,chartFocusMode:n,onToggleChartFocusMode:c}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:n?s.jsx("div",{className:"h-full w-full min-w-0",children:s.jsx(qs,{})}):s.jsxs(Qn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(_t,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(Vi,{})}),s.jsx(Fn,{withHandle:!0,className:"bg-border/70"}),s.jsx(_t,{defaultSize:"50%",minSize:"30%",children:s.jsx(qs,{})}),s.jsx(Fn,{withHandle:!0,className:"bg-border/70"}),s.jsx(_t,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx(co,{liveOpenPnl:q,isLivePnl:x})})]})}),s.jsx(qi,{positions:B,totalPnl:q,isLivePnl:x}),s.jsx(po,{open:e,onClose:o})]})}export{yl as default};
