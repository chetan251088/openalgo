import{r as u,j as n}from"./vendor-react-BsSNOS8Q.js";import{c as Ue,d as Ae,z as en,e as Fe,u as nr,A as sr,C as rr,M as nn,t as je,B as Ie,w as pt}from"./index-kkbtP63P.js";import{b7 as Vr}from"./vendor-icons-BJR3KiwM.js";import{u as ir}from"./useQuery-CT15W5nJ.js";import{S as on,a as ln,b as cn,c as un,d as Yt}from"./select-DdhMjOzy.js";import{o as ar,u as qr}from"./useOptionChainLive-y_1gBQeL.js";import{u as b,t as Te}from"./trading-DZ1Q_fF7.js";import{q as or,K as lr,W as cr,R as ur,n as Et,h as yt}from"./lightweight-charts.production-fmEoZjtL.js";import{a as fn}from"./useMarketStatus-Ci3svWVq.js";import{I as jt}from"./input-B1u8FvzQ.js";import{L as at}from"./label-BvDimx5M.js";import{S as pn}from"./switch-CxvL0KJP.js";import{a as Kr,r as Gr,b as Ur,c as Wr}from"./ai-scalper-CqWBevZG.js";import{u as Hr}from"./useLivePrice-CgbJGNBq.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function De(e,t="Assertion error"){if(!e)throw Error(t)}function sn({group:e}){const{orientation:t,panels:s}=e;return s.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function Un(e,t){return t.sort(e==="horizontal"?Yr:Zr)}function Yr(e,t){const s=e.element.offsetLeft-t.element.offsetLeft;return s!==0?s:e.element.offsetWidth-t.element.offsetWidth}function Zr(e,t){const s=e.element.offsetTop-t.element.offsetTop;return s!==0?s:e.element.offsetHeight-t.element.offsetHeight}function dr(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function pr(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Xr({orientation:e,rects:t,targetRect:s}){const r={x:s.x+s.width/2,y:s.y+s.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:c,y:l}=pr(r,o),d=e==="horizontal"?c:l;d<a&&(a=d,i=o)}return De(i,"No rect found"),i}let vn;function Qr(){return vn===void 0&&(typeof matchMedia=="function"?vn=!!matchMedia("(pointer:coarse)").matches:vn=!1),vn}function mr(e){const{element:t,orientation:s,panels:r,separators:i}=e,a=Un(s,Array.from(t.children).filter(dr).map(m=>({element:m}))).map(({element:m})=>m),o=[];let c=!1,l,d=[];for(const m of a)if(m.hasAttribute("data-panel")){const p=r.find(v=>v.element===m);if(p){if(l){const v=l.element.getBoundingClientRect(),g=m.getBoundingClientRect();let h;if(c){const x=s==="horizontal"?new DOMRect(v.right,v.top,0,v.height):new DOMRect(v.left,v.bottom,v.width,0),N=s==="horizontal"?new DOMRect(g.left,g.top,0,g.height):new DOMRect(g.left,g.top,g.width,0);switch(d.length){case 0:{h=[x,N];break}case 1:{const P=d[0],y=Xr({orientation:s,rects:[v,g],targetRect:P.element.getBoundingClientRect()});h=[P,y===v?N:x];break}default:{h=d;break}}}else d.length?h=d:h=[s==="horizontal"?new DOMRect(v.right,g.top,g.left-v.right,g.height):new DOMRect(g.left,v.bottom,g.width,g.top-v.bottom)];for(const x of h){let N="width"in x?x:x.element.getBoundingClientRect();const P=Qr()?37:27;if(N.width<P){const y=P-N.width;N=new DOMRect(N.x-y/2,N.y,N.width+y,N.height)}if(N.height<P){const y=P-N.height;N=new DOMRect(N.x,N.y-y/2,N.width,N.height+y)}o.push({group:e,groupSize:sn({group:e}),panels:[l,p],separator:"width"in x?void 0:x,rect:N})}}c=!1,l=p,d=[]}}else if(m.hasAttribute("data-separator")){const p=i.find(v=>v.element===m);p?d.push(p):(l=void 0,d=[])}else c=!0;return o}function Jr(e,t){const s=getComputedStyle(e),r=parseFloat(s.fontSize);return t*r}function ei(e,t){const s=getComputedStyle(e.ownerDocument.body),r=parseFloat(s.fontSize);return t*r}function ti(e){return e/100*window.innerHeight}function ni(e){return e/100*window.innerWidth}function si(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function Sn({groupSize:e,panelElement:t,styleProp:s}){let r;const[i,a]=si(s);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=ei(t,i);break}case"em":{r=Jr(t,i);break}case"vh":{r=ti(i);break}case"vw":{r=ni(i);break}}return r}function mt(e){return parseFloat(e.toFixed(3))}function cs(e){const{panels:t}=e,s=sn({group:e});return s===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const m=Sn({groupSize:s,panelElement:i,styleProp:a.collapsedSize});o=mt(m/s*100)}let c;if(a.defaultSize!==void 0){const m=Sn({groupSize:s,panelElement:i,styleProp:a.defaultSize});c=mt(m/s*100)}let l=0;if(a.minSize!==void 0){const m=Sn({groupSize:s,panelElement:i,styleProp:a.minSize});l=mt(m/s*100)}let d=100;if(a.maxSize!==void 0){const m=Sn({groupSize:s,panelElement:i,styleProp:a.maxSize});d=mt(m/s*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:c,minSize:l,maxSize:d,panelId:r.id}})}class ri{#e={};addListener(t,s){const r=this.#e[t];return r===void 0?this.#e[t]=[s]:r.includes(s)||r.push(s),()=>{this.removeListener(t,s)}}emit(t,s){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,s);else{let i=!1,a=null;const o=Array.from(r);for(let c=0;c<o.length;c++){const l=o[c];try{l.call(null,s)}catch(d){a===null&&(i=!0,a=d)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,s){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(s);i>=0&&r.splice(i,1)}}}function et(e,t,s=0){return Math.abs(mt(e)-mt(t))<=s}let dt={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const Bt=new ri;function ot(){return dt}function st(e){const t=typeof e=="function"?e(dt):e;if(dt===t)return dt;const s=dt;return dt={...dt,...t},t.cursorFlags!==void 0&&Bt.emit("cursorFlagsChange",dt.cursorFlags),t.interactionState!==void 0&&Bt.emit("interactionStateChange",dt.interactionState),t.mountedGroups!==void 0&&(dt.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=s.mountedGroups.get(i)??{};if(o){const c=et(a.collapsedSize,r.layout[a.panelId]),l=et(a.collapsedSize,o[a.panelId]);c&&!l&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),Bt.emit("mountedGroupsChange",dt.mountedGroups)),dt}function ii(e,t,s){let r,i={x:1/0,y:1/0};for(const a of t){const o=pr(s,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function ai(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function oi(e,t){if(e===t)throw new Error("Cannot compare node with itself");const s={a:ps(e),b:ps(t)};let r;for(;s.a.at(-1)===s.b.at(-1);)e=s.a.pop(),t=s.b.pop(),r=e;De(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:ds(us(s.a)),b:ds(us(s.b))};if(i.a===i.b){const a=r.childNodes,o={a:s.a.at(-1),b:s.b.at(-1)};let c=a.length;for(;c--;){const l=a[c];if(l===o.a)return 1;if(l===o.b)return-1}}return Math.sign(i.a-i.b)}const li=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function ci(e){const t=getComputedStyle(fr(e)??e).display;return t==="flex"||t==="inline-flex"}function ui(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||ci(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||li.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function us(e){let t=e.length;for(;t--;){const s=e[t];if(De(s,"Missing node"),ui(s))return s}return null}function ds(e){return e&&Number(getComputedStyle(e).zIndex)||0}function ps(e){const t=[];for(;e;)t.push(e),e=fr(e);return t}function fr(e){const{parentNode:t}=e;return ai(t)?t.host:t}function di(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function pi({groupElement:e,hitRegion:t,pointerEventTarget:s}){if(!dr(s)||s.contains(e)||e.contains(s))return!0;if(oi(s,e)>0){let r=s;for(;r;){if(r.contains(e))return!0;if(di(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function Xn(e,t){const s=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=mr(i),o=ii(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&pi({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&s.push(o.hitRegion)}),s}function mi(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!=t[s])return!1;return!0}function gn(e,t){return et(e,t)?0:e>t?1:-1}function tn({panelConstraints:e,size:t}){const{collapsedSize:s=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(gn(t,a)<0)if(r){const o=(s+a)/2;gn(t,o)<0?t=s:t=a}else t=a;return t=Math.min(i,t),t=mt(t),t}function yn({delta:e,initialLayout:t,panelConstraints:s,pivotIndices:r,prevLayout:i,trigger:a}){if(et(e,0))return t;const o=Object.values(t),c=Object.values(i),l=[...o],[d,m]=r;De(d!=null,"Invalid first pivot index"),De(m!=null,"Invalid second pivot index");let p=0;if(a==="keyboard"){{const h=e<0?m:d,x=s[h];De(x,`Panel constraints not found for index ${h}`);const{collapsedSize:N=0,collapsible:P,minSize:y=0}=x;if(P){const w=o[h];if(De(w!=null,`Previous layout not found for panel index ${h}`),et(w,N)){const M=y-w;gn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}{const h=e<0?d:m,x=s[h];De(x,`No panel constraints found for index ${h}`);const{collapsedSize:N=0,collapsible:P,minSize:y=0}=x;if(P){const w=o[h];if(De(w!=null,`Previous layout not found for panel index ${h}`),et(w,y)){const M=w-N;gn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}}{const h=e<0?1:-1;let x=e<0?m:d,N=0;for(;;){const y=o[x];De(y!=null,`Previous layout not found for panel index ${x}`);const w=tn({panelConstraints:s[x],size:100})-y;if(N+=w,x+=h,x<0||x>=s.length)break}const P=Math.min(Math.abs(e),Math.abs(N));e=e<0?0-P:P}{let h=e<0?d:m;for(;h>=0&&h<s.length;){const x=Math.abs(e)-Math.abs(p),N=o[h];De(N!=null,`Previous layout not found for panel index ${h}`);const P=N-x,y=tn({panelConstraints:s[h],size:P});if(!et(N,y)&&(p+=N-y,l[h]=y,p.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?h--:h++}}if(mi(c,l))return i;{const h=e<0?m:d,x=o[h];De(x!=null,`Previous layout not found for panel index ${h}`);const N=x+p,P=tn({panelConstraints:s[h],size:N});if(l[h]=P,!et(P,N)){let y=N-P,w=e<0?m:d;for(;w>=0&&w<s.length;){const M=l[w];De(M!=null,`Previous layout not found for panel index ${w}`);const F=M+y,D=tn({panelConstraints:s[w],size:F});if(et(M,D)||(y-=D-M,l[w]=D),et(y,0))break;e>0?w--:w++}}}const v=Object.values(l).reduce((h,x)=>x+h,0);if(!et(v,100,.1))return i;const g=Object.keys(i);return l.reduce((h,x,N)=>(h[g[N]]=x,h),{})}function Vt(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(t[s]===void 0||gn(e[s],t[s])!==0)return!1;return!0}function qt({layout:e,panelConstraints:t}){const s=[...Object.values(e)],r=s.reduce((o,c)=>o+c,0);if(s.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${s.map(o=>`${o}%`).join(", ")}`);if(!et(r,100)&&s.length>0)for(let o=0;o<t.length;o++){const c=s[o];De(c!=null,`No layout data found for index ${o}`);const l=100/r*c;s[o]=l}let i=0;for(let o=0;o<t.length;o++){const c=s[o];De(c!=null,`No layout data found for index ${o}`);const l=tn({panelConstraints:t[o],size:c});c!=l&&(i+=c-l,s[o]=l)}if(!et(i,0))for(let o=0;o<t.length;o++){const c=s[o];De(c!=null,`No layout data found for index ${o}`);const l=c+i,d=tn({panelConstraints:t[o],size:l});if(c!==d&&(i-=d-c,s[o]=d,et(i,0)))break}const a=Object.keys(e);return s.reduce((o,c,l)=>(o[a[l]]=c,o),{})}function xr({groupId:e,panelId:t}){const s=()=>{const{mountedGroups:c}=ot();for(const[l,{defaultLayoutDeferred:d,derivedPanelConstraints:m,layout:p,separatorToPanels:v}]of c)if(l.id===e)return{defaultLayoutDeferred:d,derivedPanelConstraints:m,group:l,layout:p,separatorToPanels:v};throw Error(`Group ${e} not found`)},r=()=>{const c=s().derivedPanelConstraints.find(l=>l.panelId===t);if(c!==void 0)return c;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const c=s().group.panels.find(l=>l.id===t);if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const c=s().layout[t];if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},o=c=>{const l=a();if(c===l)return;const{defaultLayoutDeferred:d,derivedPanelConstraints:m,group:p,layout:v,separatorToPanels:g}=s(),h=p.panels.findIndex(y=>y.id===t),x=h===p.panels.length-1,N=yn({delta:x?l-c:c-l,initialLayout:v,panelConstraints:m,pivotIndices:x?[h-1,h]:[h,h+1],prevLayout:v,trigger:"imperative-api"}),P=qt({layout:N,panelConstraints:m});Vt(v,P)||st(y=>({mountedGroups:new Map(y.mountedGroups).set(p,{defaultLayoutDeferred:d,derivedPanelConstraints:m,layout:P,separatorToPanels:g})}))};return{collapse:()=>{const{collapsible:c,collapsedSize:l}=r(),{mutableValues:d}=i(),m=a();c&&m!==l&&(d.expandToSize=m,o(l))},expand:()=>{const{collapsible:c,collapsedSize:l,minSize:d}=r(),{mutableValues:m}=i(),p=a();if(c&&p===l){let v=m.expandToSize??d;v===0&&(v=1),o(v)}},getSize:()=>{const{group:c}=s(),l=a(),{element:d}=i(),m=c.orientation==="horizontal"?d.offsetWidth:d.offsetHeight;return{asPercentage:l,inPixels:m}},isCollapsed:()=>{const{collapsible:c,collapsedSize:l}=r(),d=a();return c&&et(l,d)},resize:c=>{if(a()!==c){let l;switch(typeof c){case"number":{const{group:d}=s(),m=sn({group:d});l=mt(c/m*100);break}case"string":{l=parseFloat(c);break}}o(l)}}}}function ms(e){if(e.defaultPrevented)return;const{mountedGroups:t}=ot(),s=Xn(e,t),r=new Set,i=new Set;s.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(c=>c.panelConstraints.defaultSize!==void 0);if(o){const c=o.panelConstraints.defaultSize,l=xr({groupId:a.group.id,panelId:o.id});l&&c!==void 0&&(l.resize(c),e.preventDefault())}}})}function Ln(e){const{mountedGroups:t}=ot();for(const[s]of t)if(s.separators.some(r=>r.element===e))return s;throw Error("Could not find parent Group for separator element")}function hr({groupId:e}){const t=()=>{const{mountedGroups:s}=ot();for(const[r,i]of s)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:s,layout:r}=t();return s?{}:r},setLayout(s){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:c}=t(),l=qt({layout:s,panelConstraints:i});return r?o:(Vt(o,l)||st(d=>({mountedGroups:new Map(d.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:l,separatorToPanels:c})})),l)}}}function gr(e){const{mountedGroups:t}=ot(),s=t.get(e);return De(s,`Mounted Group ${e.id} not found`),s}function Dt(e,t){const s=Ln(e),r=gr(s),i=s.separators.find(m=>m.element===e);De(i,"Matching separator not found");const a=r.separatorToPanels.get(i);De(a,"Matching panels not found");const o=a.map(m=>s.panels.indexOf(m)),c=hr({groupId:s.id}).getLayout(),l=yn({delta:t,initialLayout:c,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:c,trigger:"keyboard"}),d=qt({layout:l,panelConstraints:r.derivedPanelConstraints});Vt(c,d)||st(m=>({mountedGroups:new Map(m.mountedGroups).set(s,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:d,separatorToPanels:r.separatorToPanels})}))}function fs(e){if(e.defaultPrevented)return;const t=e.currentTarget,s=Ln(t);if(!s.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),s.orientation==="vertical"&&Dt(t,5);break}case"ArrowLeft":{e.preventDefault(),s.orientation==="horizontal"&&Dt(t,-5);break}case"ArrowRight":{e.preventDefault(),s.orientation==="horizontal"&&Dt(t,5);break}case"ArrowUp":{e.preventDefault(),s.orientation==="vertical"&&Dt(t,-5);break}case"End":{e.preventDefault(),Dt(t,100);break}case"Enter":{e.preventDefault();const r=Ln(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=gr(r),c=r.separators.find(p=>p.element===t);De(c,"Matching separator not found");const l=o.get(c);De(l,"Matching panels not found");const d=l[0],m=i.find(p=>p.panelId===d.id);if(De(m,"Panel metadata not found"),m.collapsible){const p=a[d.id],v=m.collapsedSize===p?r.inMemoryLastExpandedPanelSizes[d.id]??m.minSize:m.collapsedSize;Dt(t,v-p)}break}case"F6":{e.preventDefault();const r=Ln(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);De(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),Dt(t,-100);break}}}function xs(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=ot(),s=Xn(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let c=!1;s.forEach(l=>{r.add(l.group),l.panels.forEach(m=>{i.add(m)}),l.separator&&(a.add(l.separator),c||(c=!0,l.separator.element.focus()));const d=t.get(l.group);d&&o.set(l.group,d.layout)}),st({interactionState:{hitRegions:s,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),s.length&&e.preventDefault()}const fi=e=>e,On=()=>{},yr=1,br=2,vr=4,Sr=8,hs=3,gs=12;let Pn;function ys(){return Pn===void 0&&(Pn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(Pn=!0)),Pn}function xi({cursorFlags:e,groups:t,state:s}){let r=0,i=0;switch(s){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(s){case"active":{if(e&&ys()){const a=(e&yr)!==0,o=(e&br)!==0,c=(e&vr)!==0,l=(e&Sr)!==0;if(a)return c?"se-resize":l?"ne-resize":"e-resize";if(o)return c?"sw-resize":l?"nw-resize":"w-resize";if(c)return"s-resize";if(l)return"n-resize"}break}}return ys()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const bs=new WeakMap;function Qn(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:s}=bs.get(e)??{};s===void 0&&(s=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(s));const{cursorFlags:r,interactionState:i}=ot();switch(i.state){case"active":case"hover":{const a=xi({cursorFlags:r,groups:i.hitRegions.map(c=>c.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?s.cssRules.length===0?s.insertRule(o):s.replaceSync(o):s.cssRules.length===1&&s.deleteRule(0);break}case"inactive":{t=void 0,s.cssRules.length===1&&s.deleteRule(0);break}}bs.set(e,{prevStyle:t,styleSheet:s})}function Pr({document:e,event:t,hitRegions:s,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let c=0;const l=new Map(i);s.forEach(m=>{const{group:p,groupSize:v}=m,{disableCursor:g,orientation:h,panels:x}=p;let N=0;a?h==="horizontal"?N=(t.clientX-a.x)/v*100:N=(t.clientY-a.y)/v*100:h==="horizontal"?N=t.clientX<0?-100:100:N=t.clientY<0?-100:100;const P=r.get(p),{defaultLayoutDeferred:y,derivedPanelConstraints:w,layout:M,separatorToPanels:F}=i.get(p)??{defaultLayoutDeferred:!1};if(w&&P&&M&&F){const D=yn({delta:N,initialLayout:P,panelConstraints:w,pivotIndices:m.panels.map(V=>x.indexOf(V)),prevLayout:M,trigger:"mouse-or-touch"});if(Vt(D,M)){if(N!==0&&!g)switch(h){case"horizontal":{c|=N<0?yr:br;break}case"vertical":{c|=N<0?vr:Sr;break}}}else{l.set(m.group,{defaultLayoutDeferred:y,derivedPanelConstraints:w,layout:D,separatorToPanels:F});const V=m.group.panels.map(({id:X})=>X).join(",");m.group.inMemoryLayouts[V]=D}}});let d=0;t.movementX===0?d|=o&hs:d|=c&hs,t.movementY===0?d|=o&gs:d|=c&gs,st({cursorFlags:d,mountedGroups:l}),Qn(e)}function vs(e){const{cursorFlags:t,interactionState:s,mountedGroups:r}=ot();s.state==="active"&&Pr({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function Ss(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:s,mountedGroups:r}=ot();switch(s.state){case"active":{if(e.buttons===0){st(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),st(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Pr({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:s.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=Xn(e,r);i.length===0?s.state!=="inactive"&&st({interactionState:{state:"inactive"}}):st({interactionState:{hitRegions:i,state:"hover"}}),Qn(e.currentTarget);break}}}function Ps(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=ot();t.state==="active"&&(st({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(Qn(e.currentTarget),st(s=>({mountedGroups:new Map(s.mountedGroups)})),e.preventDefault()))}function js(e){let t=0,s=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=mt(a.defaultSize);s+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=mt((100-s)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function hi(e,t,s){if(!s[0])return;const r=e.panels.find(l=>l.element===t);if(!r||!r.onResize)return;const i=sn({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,c={asPercentage:mt(a/i*100),inPixels:a};r.mutableValues.prevSize=c,r.onResize(c,r.id,o)}function gi(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}function yi(e,t){const s=e.map(i=>i.id),r=Object.keys(t);if(s.length!==r.length)return!1;for(const i of s)if(!r.includes(i))return!1;return!0}const Zt=new Map;function bi(e){let t=!0;De(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const s=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new s(h=>{for(const x of h){const{borderBoxSize:N,target:P}=x;if(P===e.element){if(t){if(sn({group:e})===0)return;st(y=>{const w=y.mountedGroups.get(e);if(w){const M=cs(e),F=w.defaultLayoutDeferred?js(M):w.layout,D=qt({layout:F,panelConstraints:M});return!w.defaultLayoutDeferred&&Vt(F,D)&&gi(w.derivedPanelConstraints,M)?y:{mountedGroups:new Map(y.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:M,layout:D,separatorToPanels:w.separatorToPanels})}}return y})}}else hi(e,P,N)}});a.observe(e.element),e.panels.forEach(h=>{De(!r.has(h.id),`Panel ids must be unique; id "${h.id}" was used more than once`),r.add(h.id),h.onResize&&a.observe(h.element)});const o=sn({group:e}),c=cs(e),l=e.panels.map(({id:h})=>h).join(",");let d=e.defaultLayout;d&&(yi(e.panels,d)||(d=void 0));const m=e.inMemoryLayouts[l]??d??js(c),p=qt({layout:m,panelConstraints:c}),v=mr(e),g=e.element.ownerDocument;return st(h=>{const x=new Map;return Zt.set(g,(Zt.get(g)??0)+1),v.forEach(N=>{N.separator&&x.set(N.separator,N.panels)}),{mountedGroups:new Map(h.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:c,layout:p,separatorToPanels:x})}}),e.separators.forEach(h=>{De(!i.has(h.id),`Separator ids must be unique; id "${h.id}" was used more than once`),i.add(h.id),h.element.addEventListener("keydown",fs)}),Zt.get(g)===1&&(g.addEventListener("dblclick",ms,!0),g.addEventListener("pointerdown",xs,!0),g.addEventListener("pointerleave",vs),g.addEventListener("pointermove",Ss),g.addEventListener("pointerup",Ps,!0)),function(){t=!1,Zt.set(g,Math.max(0,(Zt.get(g)??0)-1)),st(h=>{const x=new Map(h.mountedGroups);return x.delete(e),{mountedGroups:x}}),e.separators.forEach(h=>{h.element.removeEventListener("keydown",fs)}),Zt.get(g)||(g.removeEventListener("dblclick",ms,!0),g.removeEventListener("pointerdown",xs,!0),g.removeEventListener("pointerleave",vs),g.removeEventListener("pointermove",Ss),g.removeEventListener("pointerup",Ps,!0)),a.disconnect()}}function jr(){const[e,t]=u.useState({}),s=u.useCallback(()=>t({}),[]);return[e,s]}function Jn(e){const t=u.useId();return`${e??t}`}const Gt=typeof window<"u"?u.useLayoutEffect:u.useEffect;function xn(e){const t=u.useRef(e);return Gt(()=>{t.current=e},[e]),u.useCallback((...s)=>t.current?.(...s),[t])}function es(...e){return xn(t=>{e.forEach(s=>{if(s)switch(typeof s){case"function":{s(t);break}case"object":{s.current=t;break}}})})}function vi(e){const t=u.useRef({...e});return Gt(()=>{for(const s in e)t.current[s]=e[s]},[e]),t.current}const Nr=u.createContext(null);function Si(e,t){const s=u.useRef({getLayout:()=>({}),setLayout:fi});u.useImperativeHandle(t,()=>s.current,[]),Gt(()=>{Object.assign(s.current,hr({groupId:e}))})}function wr({children:e,className:t,defaultLayout:s,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:c,onLayoutChange:l,onLayoutChanged:d,orientation:m="horizontal",style:p,...v}){const g=u.useRef({onLayoutChange:{},onLayoutChanged:{}}),h=xn(R=>{Vt(g.current.onLayoutChange,R)||(g.current.onLayoutChange=R,l?.(R))}),x=xn(R=>{Vt(g.current.onLayoutChanged,R)||(g.current.onLayoutChanged=R,d?.(R))}),N=Jn(c),P=u.useRef(null),[y,w]=jr(),M=u.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),F=es(P,a);Si(N,o);const D=xn((R,C)=>{const{interactionState:J,mountedGroups:ee}=ot();for(const L of ee.keys())if(L.id===R){const S=ee.get(L);if(S){let O=!1;return J.state==="active"&&(O=J.hitRegions.some(k=>k.group===L)),{flexGrow:S.layout[C]??1,pointerEvents:O?"none":void 0}}}return{flexGrow:s?.[C]??1}}),V=u.useMemo(()=>({getPanelStyles:D,id:N,orientation:m,registerPanel:R=>{const C=M.current;return C.panels=Un(m,[...C.panels,R]),w(),()=>{C.panels=C.panels.filter(J=>J!==R),w()}},registerSeparator:R=>{const C=M.current;return C.separators=Un(m,[...C.separators,R]),w(),()=>{C.separators=C.separators.filter(J=>J!==R),w()}}}),[D,N,w,m]),X=vi({defaultLayout:s,disableCursor:r}),ne=u.useRef(null);return Gt(()=>{const R=P.current;if(R===null)return;const C=M.current,J={defaultLayout:X.defaultLayout,disableCursor:!!X.disableCursor,disabled:!!i,element:R,id:N,inMemoryLastExpandedPanelSizes:M.current.lastExpandedPanelSizes,inMemoryLayouts:M.current.layouts,orientation:m,panels:C.panels,separators:C.separators};ne.current=J;const ee=bi(J),L=ot().mountedGroups.get(J);if(L){const{defaultLayoutDeferred:k,derivedPanelConstraints:$,layout:z}=L;!k&&$.length>0&&(h(z),x(z),C.panels.forEach(W=>{W.scheduleUpdate()}))}const S=Bt.addListener("interactionStateChange",()=>{C.panels.forEach(k=>{k.scheduleUpdate()})}),O=Bt.addListener("mountedGroupsChange",k=>{const $=k.get(J);if($){const{defaultLayoutDeferred:z,derivedPanelConstraints:W,layout:_}=$;if(z||W.length===0)return;const{interactionState:q}=ot(),f=q.state!=="active";h(_),f&&x(_),C.panels.forEach(A=>{A.scheduleUpdate()})}});return()=>{ne.current=null,ee(),S(),O()}},[i,N,x,h,m,y,X]),u.useEffect(()=>{const R=ne.current;R&&(R.defaultLayout=s,R.disableCursor=!!r)}),n.jsx(Nr.Provider,{value:V,children:n.jsx("div",{...v,"aria-orientation":m,className:t,"data-group":!0,"data-testid":N,id:N,ref:F,style:{height:"100%",width:"100%",overflow:"hidden",...p,display:"flex",flexDirection:m==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}wr.displayName="Group";function ts(){const e=u.useContext(Nr);return De(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Pi(e,t){const{id:s}=ts(),r=u.useRef({collapse:On,expand:On,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:On});u.useImperativeHandle(t,()=>r.current,[]),Gt(()=>{Object.assign(r.current,xr({groupId:s,panelId:e}))})}function kr({children:e,className:t,collapsedSize:s="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:c="100%",minSize:l="0%",onResize:d,panelRef:m,style:p,...v}){const g=!!o,h=Jn(o),x=u.useRef(null),N=es(x,a),[,P]=jr(),{getPanelStyles:y,id:w,registerPanel:M}=ts(),F=d!==null,D=xn((X,ne,R)=>{d?.(X,o,R)});Gt(()=>{const X=x.current;if(X!==null)return M({element:X,id:h,idIsStable:g,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:F?D:void 0,panelConstraints:{collapsedSize:s,collapsible:r,defaultSize:i,maxSize:c,minSize:l},scheduleUpdate:P})},[s,r,i,P,F,h,g,c,l,D,M]),Pi(h,m);const V=y(w,h);return n.jsx("div",{...v,"data-panel":!0,"data-testid":h,id:h,ref:N,style:{...ji,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...V},children:n.jsx("div",{className:t,style:{flexGrow:1,...p},children:e})})}kr.displayName="Panel";const ji={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function Ni({layout:e,panelConstraints:t,panelId:s,panelIndex:r}){let i,a;const o=e[s],c=t.find(l=>l.panelId===s);if(c){const l=c.maxSize,d=a=c.collapsible?c.collapsedSize:c.minSize,m=[r,r+1];a=qt({layout:yn({delta:d-o,initialLayout:e,panelConstraints:t,pivotIndices:m,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s],i=qt({layout:yn({delta:l-o,initialLayout:e,panelConstraints:t,pivotIndices:m,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s]}return{valueControls:s,valueMax:i,valueMin:a,valueNow:o}}function Tr({children:e,className:t,elementRef:s,id:r,style:i,...a}){const o=Jn(r),[c,l]=u.useState({}),[d,m]=u.useState("inactive"),p=u.useRef(null),v=es(p,s),{id:g,orientation:h,registerSeparator:x}=ts(),N=h==="horizontal"?"vertical":"horizontal";return Gt(()=>{const P=p.current;if(P!==null){const y={element:P,id:o},w=x(y),M=Bt.addListener("interactionStateChange",D=>{m(D.state!=="inactive"&&D.hitRegions.some(V=>V.separator===y)?D.state:"inactive")}),F=Bt.addListener("mountedGroupsChange",D=>{D.forEach(({derivedPanelConstraints:V,layout:X,separatorToPanels:ne},R)=>{if(R.id===g){const C=ne.get(y);if(C){const J=C[0],ee=R.panels.indexOf(J);l(Ni({layout:X,panelConstraints:V,panelId:J.id,panelIndex:ee}))}}})});return()=>{M(),F(),w()}}},[g,o,x]),n.jsx("div",{...a,"aria-controls":c.valueControls,"aria-orientation":N,"aria-valuemax":c.valueMax,"aria-valuemin":c.valueMin,"aria-valuenow":c.valueNow,children:e,className:t,"data-separator":d,"data-testid":o,id:o,ref:v,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}Tr.displayName="Separator";function Wn({className:e,...t}){return n.jsx(wr,{"data-slot":"resizable-panel-group",className:Ue("h-full w-full",e),...t})}function zt({className:e,...t}){return n.jsx(kr,{"data-slot":"resizable-panel",className:Ue("min-w-0 min-h-0",e),...t})}function Rn({withHandle:e,className:t,...s}){return n.jsx(Tr,{"data-slot":"resizable-handle",className:Ue("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...s,children:e&&n.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:n.jsx(Vr,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const wi=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],ki=[10,15,20,25,30],Fn="__none__",Ti=[{value:"auto",label:"Auto (Z->D)"},{value:"zerodha",label:"Zerodha"},{value:"dhan",label:"Dhan"}],Ei=[{value:"kotak",label:"Kotak"},{value:"dhan",label:"Dhan"},{value:"zerodha",label:"Zerodha"}];function Ci(e,t){return e.length===t.length&&e.every((s,r)=>s===t[r])}function Li(e){const t=e.trim();return t.length<=10?t:`${t.slice(0,4)}...${t.slice(-4)}`}function Mi({liveOpenPnl:e,isLivePnl:t=!1,chartFocusMode:s=!1,onToggleChartFocusMode:r}){const i=Ae(S=>S.apiKey),a=Ae(S=>S.user?.broker),o=en(S=>S.unifiedMode),c=en(S=>S.dataFeed),l=en(S=>S.executionBroker),d=en(S=>S.setDataFeed),m=en(S=>S.setExecutionBroker),p=b(S=>S.underlying),v=b(S=>S.optionExchange),g=b(S=>S.expiryWeek),h=b(S=>S.expiry),x=b(S=>S.expiries),N=b(S=>S.chainStrikeCount),P=b(S=>S.paperMode),y=b(S=>S.sessionPnl),w=b(S=>S.tradeCount),M=b(S=>S.lastOrderAck),F=b(S=>S.setUnderlying),D=b(S=>S.setExpiryWeek),V=b(S=>S.setExpiry),X=b(S=>S.setExpiries),ne=b(S=>S.setChainStrikeCount),R=b(S=>S.setPaperMode),C=P?y:e??y,J=h&&x.includes(h)?h:Fn,{data:ee}=ir({queryKey:["scalping-expiries",p,v],queryFn:()=>ar.getExpiries(i,p,v),enabled:!!i,staleTime:300*1e3});u.useEffect(()=>{if(ee?.status!=="success")return;const S=ee.data??[];if(Ci(x,S)||X(S),S.length===0){h&&V("");return}if(!h||!S.includes(h)){const O=g==="next"?Math.min(1,S.length-1):0,k=S[O],$=O<=0?"current":"next";h!==k&&V(k),g!==$&&D($)}},[ee,g,x,h,X,V,D]);const L=S=>{if(S===Fn)return;h!==S&&V(S);const k=x.indexOf(S)<=0?"current":"next";g!==k&&D(k)};return n.jsxs("div",{className:"flex flex-wrap items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0 min-w-0 overflow-hidden",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),n.jsxs(on,{value:p,onValueChange:S=>F(S),children:[n.jsx(ln,{className:"h-7 w-[104px] lg:w-[116px] xl:w-[128px] text-xs font-semibold",children:n.jsx(cn,{})}),n.jsx(un,{children:wi.map(S=>n.jsx(Yt,{value:S,children:S},S))})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),n.jsxs(on,{value:J,onValueChange:L,disabled:x.length===0,children:[n.jsx(ln,{className:"h-7 w-[108px] lg:w-[114px] xl:w-[122px] text-xs font-mono",children:n.jsx(cn,{placeholder:"Select expiry"})}),n.jsxs(un,{children:[n.jsx(Yt,{value:Fn,disabled:!0,children:"Select expiry"}),x.map(S=>n.jsx(Yt,{value:S,children:S},S))]})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),n.jsxs(on,{value:String(N),onValueChange:S=>ne(Number(S)),children:[n.jsx(ln,{className:"h-7 w-[82px] lg:w-[88px] xl:w-[94px] text-xs",children:n.jsx(cn,{})}),n.jsx(un,{children:ki.map(S=>n.jsx(Yt,{value:String(S),children:S},S))})]})]}),n.jsx("div",{className:"flex-1 min-w-[12px]"}),o&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Feed"}),n.jsxs(on,{value:c,onValueChange:S=>d(S),children:[n.jsx(ln,{className:"h-7 w-[98px] lg:w-[108px] xl:w-[118px] text-xs",children:n.jsx(cn,{})}),n.jsx(un,{children:Ti.map(S=>n.jsx(Yt,{value:S.value,children:S.label},S.value))})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Exec"}),n.jsxs(on,{value:l,onValueChange:S=>m(S),children:[n.jsx(ln,{className:"h-7 w-[84px] lg:w-[90px] xl:w-[96px] text-xs",children:n.jsx(cn,{})}),n.jsx(un,{children:Ei.map(S=>n.jsx(Yt,{value:S.value,children:S.label},S.value))})]})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsx("button",{type:"button",onClick:r,className:`h-7 px-2 rounded-md border text-xs transition-colors shrink-0 whitespace-nowrap ${s?"border-emerald-500/60 bg-emerald-500/15 text-emerald-400":"border-border/60 bg-muted/20 text-muted-foreground hover:text-foreground"}`,title:s?"Show side panels":"Hide side panels",children:s?"Panels":"Focus"}),n.jsx("div",{className:"flex items-center gap-1.5",children:n.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>R(!0),children:"Paper"}),n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>R(!1),children:"Live"})]})}),n.jsx("div",{className:"w-px h-5 bg-border"}),o?n.jsxs(Fe,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:["EXEC: ",l.toUpperCase()]}):a&&n.jsx(Fe,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:a}),!P&&M&&n.jsxs(Fe,{variant:"outline",className:"text-xs h-6 font-mono shrink-0 whitespace-nowrap",title:`${M.broker} ${M.action} ${M.symbol}`,children:["ACK: ",Li(M.orderId)]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5 shrink-0 whitespace-nowrap",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),n.jsxs("span",{className:`text-sm font-bold tabular-nums ${C>0?"text-green-500":C<0?"text-red-500":"text-foreground"}`,children:[C>=0?"+":"",C.toFixed(0)]}),!P&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),w>0&&n.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",w,")"]})]})]})}function jn(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function Ns({value:e,prevRef:t,className:s,format:r="price"}){const i=u.useRef(null);u.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const c=e>t.current?"flash-green":"flash-red";o.classList.add(c);const l=setTimeout(()=>o.classList.remove(c),300);return t.current=e,()=>clearTimeout(l)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return n.jsx("span",{ref:i,className:Ue("tabular-nums transition-colors",s),children:a})}function Nn({value:e,max:t,side:s,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return n.jsx("div",{className:Ue("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",s==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function Ri(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Ii=u.memo(function({strike:t,ce:s,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:c,onSelectStrike:l,onSelectCE:d,onSelectPE:m}){const p=u.useRef(s?.ltp??0),v=u.useRef(r?.ltp??0),g=Math.min(((s?.oi??0)/o+(s?.volume??0)/c)/2*100,100),h=Math.min(((r?.oi??0)/o+(r?.volume??0)/c)/2*100,100);return n.jsxs("div",{className:Ue("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx(Nn,{value:s?.oi??0,max:o,side:"CE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:jn(s?.oi)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx(Nn,{value:s?.volume??0,max:c,side:"CE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:jn(s?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${g}%`}}),n.jsx(Ns,{value:s?.ltp,prevRef:p,className:"relative z-10 font-medium"})]}),n.jsx("div",{className:Ue("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>l(t,s?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>m(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${h}%`}}),n.jsx(Ns,{value:r?.ltp,prevRef:v,className:"relative z-10 font-medium"})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>m(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx(Nn,{value:r?.volume??0,max:c,side:"PE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:jn(r?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>m(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx(Nn,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:jn(r?.oi)})]})]})},Ri);function ws(e){return(e??"").replace(/-/g,"").toUpperCase()}function Ai(){const e=Ae(L=>L.apiKey),t=b(L=>L.underlying),s=b(L=>L.indexExchange),r=b(L=>L.optionExchange),i=b(L=>L.expiry),a=b(L=>L.selectedStrike),o=b(L=>L.selectedCESymbol),c=b(L=>L.selectedPESymbol),l=b(L=>L.chainStrikeCount),d=b(L=>L.setSelectedStrike),m=b(L=>L.setSelectedSymbols),p=b(L=>L.setActiveSide),v=b(L=>L.setLotSize),g=b(L=>L.setOptionChainSnapshot),h=u.useRef(null),x=u.useRef(null),N=u.useRef(!1),{data:P,isLoading:y,isStreaming:w,error:M,streamingSymbols:F,lastUpdate:D}=qr(e,t,s,r,i,l,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});u.useEffect(()=>{P&&g(P,D?.getTime()??Date.now(),w)},[P,D,w,g]),u.useEffect(()=>{if(!P?.chain?.length||(P.underlying??"").toUpperCase()!==t.toUpperCase()||i&&ws(P.expiry_date)!==ws(i)||N.current)return;let L=null;for(const S of P.chain){const O=Number(S.ce?.lotsize);if(Number.isFinite(O)&&O>0){L=O;break}const k=Number(S.pe?.lotsize);if(Number.isFinite(k)&&k>0){L=k;break}}L!==null&&(v(L),N.current=!0)},[P,v]),u.useEffect(()=>{N.current=!1},[t,i]),u.useEffect(()=>{if(P?.chain&&x.current&&h.current){const L=h.current,S=x.current,O=L.getBoundingClientRect(),k=S.getBoundingClientRect(),$=k.top-O.top-O.height/2+k.height/2;L.scrollTop+=$}},[P?.atm_strike]);const V=u.useCallback((L,S,O)=>{d(L),m(S,O)},[d,m]),X=u.useCallback((L,S)=>{S&&(d(L),m(S,c),p("CE"))},[c,p,d,m]),ne=u.useCallback((L,S)=>{S&&(d(L),m(o,S),p("PE"))},[o,p,d,m]),{maxOI:R,maxVol:C}=u.useMemo(()=>{if(!P?.chain?.length)return{maxOI:1,maxVol:1};let L=0,S=0;for(const O of P.chain)O.ce?.oi&&O.ce.oi>L&&(L=O.ce.oi),O.pe?.oi&&O.pe.oi>L&&(L=O.pe.oi),O.ce?.volume&&O.ce.volume>S&&(S=O.ce.volume),O.pe?.volume&&O.pe.volume>S&&(S=O.pe.volume);return{maxOI:L||1,maxVol:S||1}},[P?.chain]),J=P?.underlying_ltp,ee=P?.atm_strike;return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-sm font-bold",children:t}),n.jsxs(Fe,{variant:"outline",className:"text-[10px] h-4 px-1",children:[l," strikes"]}),J!=null&&n.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:J.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[w&&n.jsxs(Fe,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[n.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),F]}),y&&n.jsx(Fe,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),n.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[n.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),n.jsx("div",{className:"text-center",children:"Strike"}),n.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),n.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),n.jsxs("div",{ref:h,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[M&&n.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:M}),!M&&!y&&P?.chain?.length===0&&n.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),P?.chain?.map(L=>{const S=L.strike===ee;return n.jsx("div",{ref:S?x:void 0,children:n.jsx(Ii,{strike:L.strike,ce:L.ce,pe:L.pe,isATM:S,isSelected:L.strike===a,maxOI:R,maxVol:C,onSelectStrike:V,onSelectCE:X,onSelectPE:ne})},L.strike)})]})]})}function $i({positions:e,totalPnl:t,isLivePnl:s}){const r=b(o=>o.activeSide),i=b(o=>o.hotkeysEnabled),a=b(o=>o.paperMode);return n.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[n.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?n.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):n.jsxs(n.Fragment,{children:[e.map(o=>n.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[n.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),n.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),n.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),n.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),n.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),n.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-border",children:"|"}),n.jsx("span",{className:"text-muted-foreground",children:"Total:"}),n.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),n.jsx("span",{className:`text-[10px] ${s?"text-green-500":"text-muted-foreground"}`,children:s?"LIVE":"REST"})]})]})}),n.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&n.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),n.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?n.jsxs(n.Fragment,{children:[n.jsxs("span",{children:["Active: ",n.jsx("span",{className:"text-foreground font-medium",children:r})]}),n.jsx("span",{className:"text-border",children:"|"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),n.jsx("span",{children:"Buy"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),n.jsx("span",{children:"Sell"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),n.jsx("span",{children:"Rev"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),n.jsx("span",{children:"Close"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),n.jsx("span",{children:"All"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),n.jsx("span",{children:"Widget"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),n.jsx("span",{children:"Side"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↑"}),n.jsx("span",{children:"CE Mkt Buy"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↓"}),n.jsx("span",{children:"PE Mkt Buy"})]}):n.jsx("span",{children:"Hotkeys disabled"})})]})}const rn=300*60+1800,ks=1440*60,mn=540*60+900,Ts=900*60+1800;function In(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function Er(e){const t=In(e)+rn,s=Math.floor(t/ks)*ks,r=t-s,i=(s-rn)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:s,secondsOfDay:r,dayOfWeek:a}}function Di(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const s=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),c=Number(t[6]??"0");if(!Number.isFinite(s)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(c))return null;const l=Date.UTC(s,r-1,i,a,o,c)-rn*1e3;return Math.floor(l/1e3)}function Oi(e){if(!e||typeof e!="object")return null;const t=e,s=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(s)||!Number.isFinite(r)||!Number.isFinite(i)||s<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(s),Math.floor(r)-1,Math.floor(i),0,0,0)-rn*1e3;return Math.floor(a/1e3)}function bt(e){if(typeof e=="number")return In(e);const t=Oi(e);if(t!=null)return t;if(typeof e!="string")return null;const s=e.trim();if(s.length===0)return null;const r=Number(s.replace(/,/g,""));if(Number.isFinite(r))return In(r);const i=Di(s);if(i!=null)return i;const a=Date.parse(s);return Number.isFinite(a)?Math.floor(a/1e3):null}function ns(e,t={}){const{secondsOfDay:s,dayOfWeek:r}=Er(e);if(r===0||r===6)return!1;const i=s>=mn,a=t.includeClose?s<=Ts:s<Ts;return i&&a}function Fi(e,t){const s=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=Er(e),a=i<=mn?mn:mn+Math.floor((i-mn)/s)*s;return r+a-rn}function Cr(e){const t=(In(e)+rn)*1e3,s=new Date(t),r=s.getUTCHours().toString().padStart(2,"0"),i=s.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function zi(e,t,s,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?Fi(i,s):Math.floor(i/s)*s,c=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:c},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+c},!1]}function Lr({symbol:e,exchange:t,intervalSec:s=1,mode:r="LTP",enabled:i=!0,useIndiaMarketHours:a=!1,maxCandles:o=500,onCandleUpdate:c}){const l=u.useRef([]),d=u.useRef(null),m=u.useRef(null),p=u.useRef(c);p.current=c;const v=i&&e?[{symbol:e,exchange:t}]:[],{data:g,isConnected:h}=fn({symbols:v,mode:r,enabled:i&&!!e});u.useEffect(()=>{if(!i||!e||g.size===0)return;const y=`${t.toUpperCase()}:${e.toUpperCase()}`,w=g.get(y);if(!w?.data?.ltp)return;const M=w.lastUpdate;if(!M||!Number.isFinite(M))return;const F=Math.floor(M/1e3);if(a&&!ns(F))return;const D=w.data.ltp,V=w.data.volume??"",X=`${y}:${M}:${D}:${V}`;if(m.current===X)return;m.current=X;const ne={price:D,volume:w.data.volume,timestamp:M},[R,C]=zi(ne,d.current,s,{alignToIndiaSession:a});C&&d.current&&(l.current.push(d.current),l.current.length>o&&(l.current=l.current.slice(-o))),d.current=R,p.current?.(R,C)},[g,e,t,s,i,o,a]);const x=u.useCallback(()=>{const y=[...l.current];return d.current&&y.push(d.current),y},[]),N=u.useCallback(()=>{l.current=[],d.current=null,m.current=null},[]),P=u.useCallback(y=>{if(!y?.length){l.current=[],d.current=null;return}const w=y.slice(-o);if(w.length===1){l.current=[],d.current=w[0];return}l.current=w.slice(0,-1),d.current=w[w.length-1]},[o]);return{getCandles:x,reset:N,seed:P,isConnected:h}}function An(e,t){if(e.length<t)return[];const s=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*s+a*(1-s),r.push({time:e[o].time,value:a});return r}function Mr(e,t=10,s=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=_i(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const c=e.length-r.length;let l=0,d=0,m=1;for(let p=0;p<r.length;p++){const v=e[c+p],g=(v.high+v.low)/2,h=r[p].value;let x=g+s*h,N=g-s*h;p>0&&(N>d||e[c+p-1].close<d||(N=d),x<l||e[c+p-1].close>l||(x=l));let P=m;p>0&&(m===1&&v.close<N?P=-1:m===-1&&v.close>x&&(P=1));const y=v.time;i.push({time:y,value:x}),a.push({time:y,value:N}),o.push({time:y,value:P===1?N:x}),l=x,d=N,m=P}return{upper:i,lower:a,trend:o}}function _i(e,t=14){if(e.length<t+1)return[];const s=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,c=e[a].low,l=e[a-1].close;r.push(Math.max(o-c,Math.abs(o-l),Math.abs(c-l)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,s.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,s.push({time:e[a+1].time,value:i});return s}function Rr(e){if(e.length===0)return[];const t=[];let s=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;s+=a*o,r+=o,t.push({time:i.time,value:r>0?s/r:a})}return t}function Bi(e){return!Number.isFinite(e)||e<=0?1:e}function Vi(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const s=Math.ceil(e/t)*t;return Math.max(t*2,s)}function Ir(e,t){const s=Bi(e),r=Vi(t,s);return i=>{const a=i(),o=a?.priceRange;if(!a||!o)return a;const c=o.minValue,l=o.maxValue;if(!Number.isFinite(c)||!Number.isFinite(l))return a;const d=Math.min(c,l),m=Math.max(c,l),p=(d+m)/2;let v=m-d;(!Number.isFinite(v)||v<s)&&(v=s),v<r&&(v=r),v=Math.ceil(v/s)*s;const g=v/2,h=Math.floor((p-g)/s)*s;let x=Math.ceil((p+g)/s)*s;return x-h<v&&(x=h+v),{...a,priceRange:{minValue:h,maxValue:x}}}}const qi=120,an=500,Ki=1,Gi=50,Ui=200;function wn(e){return e.map(t=>({time:t.time,value:t.value}))}function Wi(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Hi(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Es(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function Xe(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function ss(e){const t=bt(e);return t??null}function Yi(e){if(!e?.length)return[];const t=[];for(const a of e){const o=bt(a.timestamp)??bt(a.time)??bt(a.datetime)??bt(a.date),c=Xe(a.open),l=Xe(a.high),d=Xe(a.low),m=Xe(a.close),p=Xe(a.volume)??0;o==null||c==null||l==null||d==null||m==null||t.push({time:o,open:c,high:l,low:d,close:m,volume:p})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const s=new Map;for(const a of t)s.set(Number(a.time),a);const r=Array.from(s.values()).slice(-an),i=r.filter(a=>ns(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-an)}function Xt(e){return e.map(t=>({...t}))}function Zi(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-an)}function zn(e){const t=[];for(const s of e){const r=ss(s.time);r!=null&&t.push({time:r,open:s.open,high:s.high,low:s.low,close:s.close})}return t.sort((s,r)=>Number(s.time)-Number(r.time)),t}function Cs(e){if(!e.length)return[];const t=new Map;for(const s of e){const r=ss(s.time),i=Xe(s.open),a=Xe(s.high),o=Xe(s.low),c=Xe(s.close),l=Xe(s.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((s,r)=>Number(s.time)-Number(r.time)).slice(-an)}function Xi({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}){const i=u.useRef(null),a=u.useRef(null),o=u.useRef(null),c=u.useRef(null),l=u.useRef(null),d=u.useRef(null),m=u.useRef(null),p=u.useRef([]),v=u.useRef(new Map),g=u.useRef(null),h=u.useRef(0),x=u.useRef(null),N=u.useRef({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}),P=Ae(O=>O.apiKey),y=Ae(O=>O.setApiKey),w=nr(O=>O.mode==="dark"),M=b(O=>O.underlying),F=b(O=>O.indexExchange),D=b(O=>O.chartInterval),V=u.useCallback(()=>{const O=p.current,k=N.current,$=O.map(z=>({time:z.time,value:z.close}));c.current&&c.current.setData(k.showEma9?wn(An($,9)):[]),l.current&&l.current.setData(k.showEma21?wn(An($,21)):[]),d.current&&d.current.setData(k.showSupertrend?wn(Mr(O,10,3).trend):[]),m.current&&m.current.setData(k.showVwap?wn(Rr(O)):[])},[]),X=u.useCallback(()=>{x.current===null&&(x.current=setTimeout(()=>{x.current=null,V()},qi))},[V]),ne=u.useCallback(()=>{p.current=[],o.current?.setData([]),c.current?.setData([]),l.current?.setData([]),d.current?.setData([]),m.current?.setData([])},[]),R=u.useCallback(O=>{const k=Cs(O);p.current=Xt(k),o.current?.setData(zn(k)),X()},[X]),C=u.useCallback(async()=>{if(P)return P;try{const k=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(k.status==="success"&&k.api_key)return y(k.api_key),k.api_key}catch{}return null},[P,y]),J=u.useCallback((O,k)=>{if(!o.current)return;const $=ss(O.time),z=Xe(O.open),W=Xe(O.high),_=Xe(O.low),q=Xe(O.close),f=Xe(O.volume)??0;if($==null||z==null||W==null||_==null||q==null)return;const A={time:$,open:z,high:W,low:_,close:q,volume:f},Z=Number(A.time),E=p.current.length?Number(p.current[p.current.length-1].time):null;if(E!=null&&Number.isFinite(E)&&Number.isFinite(Z)&&Z<E)return;try{o.current.update({time:A.time,open:A.open,high:A.high,low:A.low,close:A.close})}catch{const Q=Cs([...p.current,A]);p.current=Q,o.current.setData(zn(Q)),X();return}k?(p.current.push(A),p.current.length>an&&(p.current=p.current.slice(-an))):p.current.length>0?p.current[p.current.length-1]=A:p.current.push(A);const B=g.current;B&&v.current.set(B,Xt(p.current)),X()},[X]),{isConnected:ee,reset:L,seed:S}=Lr({symbol:M,exchange:F,intervalSec:D,mode:"Quote",enabled:!!M,useIndiaMarketHours:!0,onCandleUpdate:J});return u.useEffect(()=>{const O=g.current;if(O&&p.current.length>0&&v.current.set(O,Xt(p.current)),!M){g.current=null,L(),ne();return}const k=`${F}:${M}:${D}`;g.current=k;const $=v.current.get(k);if($&&$.length>0){L(),S($),R($);return}L(),ne();const z=++h.current,W=Hi(D),_=new Date,q=new Date(_.getTime());q.setDate(q.getDate()-Ki),(async()=>{const A=await C();if(!A){z===h.current&&ne();return}try{const Z=async()=>{try{const fe=await Te.getQuotes(A,M,F);if(fe.status!=="success"||!fe.data)return null;const G=Xe(fe.data.ltp);if(G==null||G<=0)return null;const T=Math.floor(Date.now()/1e3);return{time:Math.floor(T/D)*D,open:G,high:G,low:G,close:G,volume:Xe(fe.data.volume)??0}}catch{return null}},E=async fe=>{try{const G=await Te.getHistory(A,M,F,W,Es(q),Es(_),fe);return G.status==="success"?Yi(G.data):[]}catch{return[]}},B=await E("api"),Q=B.length>0?B:await E("db");if(z!==h.current)return;const de=g.current===k?Xt(p.current):[],me=Zi(Q,de);if(me.length>0){v.current.set(k,Xt(me)),S(me),R(me);return}const be=await Z();if(be&&z===h.current){const fe=[be];v.current.set(k,Xt(fe)),S(fe),R(fe);return}}catch{}z===h.current&&ne()})()},[M,F,D,C,L,S,ne,R]),u.useEffect(()=>{N.current={showEma9:e,showEma21:t,showSupertrend:s,showVwap:r},c.current?.applyOptions({visible:e}),l.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:s}),m.current?.applyOptions({visible:r}),X()},[e,t,s,r,X]),u.useEffect(()=>{const O=i.current;if(!O)return;const k=Wi(w),$=Ir(Gi,Ui),z=or(O,{width:O.offsetWidth,height:O.offsetHeight,layout:{background:{type:cr.Solid,color:k.bg},textColor:k.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:k.grid},horzLines:{color:k.grid}},rightPriceScale:{borderColor:k.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:k.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:E=>Cr(E)},crosshair:{mode:lr.Normal,vertLine:{width:1,color:k.crosshair,style:2},horzLine:{width:1,color:k.crosshair,style:2}}}),W=z.addSeries(ur,{upColor:k.upColor,downColor:k.downColor,borderVisible:!1,wickUpColor:k.upColor,wickDownColor:k.downColor,autoscaleInfoProvider:$}),_=z.addSeries(Et,{color:k.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma9,autoscaleInfoProvider:$}),q=z.addSeries(Et,{color:k.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma21,autoscaleInfoProvider:$}),f=z.addSeries(Et,{color:k.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showSupertrend,autoscaleInfoProvider:$}),A=z.addSeries(Et,{color:k.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showVwap,autoscaleInfoProvider:$});a.current=z,o.current=W,c.current=_,l.current=q,d.current=f,m.current=A,p.current.length>0&&(W.setData(zn(p.current)),X());const Z=new ResizeObserver(()=>{if(a.current&&O){const E=O.offsetWidth,B=O.offsetHeight;E>0&&B>0&&a.current.applyOptions({width:E,height:B})}});return Z.observe(O),()=>{x.current!==null&&(clearTimeout(x.current),x.current=null),Z.disconnect(),z.remove(),a.current=null,o.current=null,c.current=null,l.current=null,d.current=null,m.current=null}},[w,X]),n.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[n.jsx("div",{ref:i,className:"h-full w-full"}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:"text-xs font-bold text-foreground/80",children:M}),!ee&&n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),n.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),s&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const ue=sr()(rr((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:s=>e(r=>({virtualTPSL:{...r.virtualTPSL,[s.id]:s}})),removeVirtualTPSL:s=>e(r=>{const{[s]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(s,r)=>e(i=>{const a=i.virtualTPSL[s];return a?{virtualTPSL:{...i.virtualTPSL,[s]:{...a,...r}}}:i}),getTPSLForSymbol:s=>Object.values(t().virtualTPSL).filter(i=>i.symbol===s).sort((i,a)=>a.createdAt-i.createdAt)[0],addTriggerOrder:s=>e(r=>({triggerOrders:{...r.triggerOrders,[s.id]:s}})),removeTriggerOrder:s=>e(r=>{const{[s]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(s,r)=>e(i=>{const a=i.triggerOrders[s];return a?{triggerOrders:{...i.triggerOrders,[s]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:s=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==s)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==s));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Ls=.05,Qi=2;function Mn(e){return Math.round(e/Ls)*Ls}function _t(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:Mn(e)}async function Mt({symbol:e,exchange:t,preferredPrice:s=null,fallbackPrice:r=null,apiKey:i=null}){const a=_t(s);if(a!=null)return a;const o=nn.getInstance(),c=_t(o.getCachedData(e,t)?.data?.ltp);if(c!=null)return c;const l=_t(r);if(l!=null)return l;if(i)try{const d=await Te.getQuotes(i,e,t),m=_t(d.data?.ltp);if(m!=null)return m}catch{}return 0}function Ji({symbol:e,exchange:t,preferredPrice:s,fallbackPrice:r}){const i=_t(s);if(i!=null)return i;const a=nn.getInstance(),o=_t(a.getCachedData(e,t)?.data?.ltp);if(o!=null)return o;const c=_t(r);return c??0}async function Ut({symbol:e,exchange:t,orderId:s=null,preferredPrice:r=null,fallbackPrice:i=null,apiKey:a=null,maxAttempts:o=5,retryDelayMs:c=250}){return Ji({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:i})}function ft({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:s,side:r,action:i,entryPrice:a,quantity:o,tpPoints:c,slPoints:l,trailDistancePoints:d,createdAt:m=Date.now(),managedBy:p="manual",autoEntryScore:v,autoEntryReason:g}){const h=Mn(a),x=Number(Math.max(0,c||0).toFixed(2)),N=Number(Math.max(0,l||0).toFixed(2)),P=Number(Math.max(0,d??Qi).toFixed(2)),y=i==="BUY";return{id:e,symbol:t,exchange:s,side:r,action:i,entryPrice:h,quantity:o,tpPrice:x>0?Mn(h+(y?x:-x)):null,slPrice:N>0?Mn(h+(y?-N:N)):null,tpPoints:x,slPoints:N,trailDistancePoints:P,trailStage:p==="auto"?"INITIAL":void 0,createdAt:m,managedBy:p,autoEntryScore:v,autoEntryReason:g}}function Ms(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function Kt(e){if(!e||typeof e!="object")return null;const t=e,s=Ms(t.orderid??t.order_id),r=t.data;if(!r||typeof r!="object")return s;const i=r;return Ms(i.orderid??i.order_id)??s}const Rs=.05,ea=150;function He(e){return Math.round(e/Rs)*Rs}function kt(e){return Number(Math.max(0,e).toFixed(2))}function Is(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?He(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?He(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function ta({chartRef:e,seriesRef:t,side:s,containerRef:r}){const i=Ae(j=>j.apiKey),a=Ae(j=>j.setApiKey),o=b(j=>j.activeSide),c=b(j=>j.orderType),l=b(j=>j.tpPoints),d=b(j=>j.slPoints),m=b(j=>j.trailDistancePoints),p=b(j=>j.limitPrice),v=b(j=>j.pendingEntryAction),g=b(j=>j.pendingLimitPlacement),h=b(j=>j.quantity),x=b(j=>j.lotSize),N=b(j=>j.optionExchange),P=b(j=>j.product),y=b(j=>j.paperMode),w=b(j=>j.incrementTradeCount),M=b(j=>j.setLimitPrice),F=b(j=>j.setTpPoints),D=b(j=>j.setSlPoints),V=b(j=>j.setPendingEntryAction),X=b(j=>j.setPendingLimitPlacement),ne=b(j=>j.clearPendingLimitPlacement),R=b(j=>s==="CE"?j.selectedCESymbol:j.selectedPESymbol),C=ue(j=>j.virtualTPSL),J=ue(j=>j.triggerOrders),ee=ue(j=>j.addTriggerOrder),L=ue(j=>j.updateTriggerOrder),S=ue(j=>j.removeTriggerOrder),O=ue(j=>j.setVirtualTPSL),k=ue(j=>j.clearForSymbol),$=ue(j=>j.updateVirtualTPSL),z=u.useRef(null),W=u.useRef(null),_=u.useRef(null),q=u.useRef(null),f=u.useRef(null),A=u.useRef(null),Z=u.useRef(null),E=u.useRef(null),[B,Q]=u.useState(null),[de,me]=u.useState(null),[be,fe]=u.useState(null),[G,T]=u.useState(null),[ie,ae]=u.useState(!1),Le=u.useRef(!1),I=u.useRef(!1),oe=u.useRef(0),xe=u.useRef(null),Se=u.useRef(null),Pe=u.useRef(null),Ne=o===s,_e=c==="LIMIT"||c==="TRIGGER",ze=u.useMemo(()=>R?Object.values(C).filter(j=>j.symbol===R).sort((j,K)=>K.createdAt-j.createdAt):[],[R,C]),U=ze[0],se=u.useMemo(()=>R?Object.values(J).find(j=>j.symbol===R):void 0,[R,J]),Re=!!g&&g.symbol===R&&g.side===s,qe=Re||p!=null,Ke=U?"position":se?"trigger":Ne&&_e&&qe?"pending":null,Ge=v??g?.action??"BUY";u.useEffect(()=>{if(!U){T(null);return}const j=nn.getInstance(),K=j.getCachedData(U.symbol,U.exchange)?.data?.ltp;K&&K>0&&T(K);const re=j.subscribe(U.symbol,U.exchange,"LTP",he=>{const we=he.data.ltp;we&&we>0&&T(we)});return()=>re()},[U]);const We=u.useMemo(()=>{if(!U||!G||G<=0)return null;const j=U.action==="BUY"?G-U.entryPrice:U.entryPrice-G,K=j*U.quantity;return{ltp:G,points:j,pnl:K}},[U,G]),vt=u.useMemo(()=>{if(ze.length===0)return null;const j=ze.reduce((re,he)=>re+Math.max(he.quantity,0),0);if(j<=0)return null;const K=ze.reduce((re,he)=>re+he.entryPrice*Math.max(he.quantity,0),0)/j;return He(K)},[ze]),Rt=u.useMemo(()=>{if(!U)return"";const j=`${U.action} Fill @ ${U.entryPrice.toFixed(2)}`,K=vt!=null?` | Avg ${vt.toFixed(2)}`:"";if(!We)return j;const re=We.pnl>=0?"+":"";return`${j}${K} | PnL ${re}${We.pnl.toFixed(2)}`},[U,We,vt]),Y=u.useCallback((j,K)=>{if(j.current){const re=K.current??t.current;try{re?.removePriceLine(j.current)}catch{}j.current=null,K.current=null}},[t]),ge=u.useCallback((j,K,re,he,we,ce,ke)=>{const le=t.current;if(!le)return;const $e="";if(j.current&&K.current&&K.current!==le){try{K.current.removePriceLine(j.current)}catch{}j.current=null,K.current=null}j.current?j.current.applyOptions({price:re,color:he,lineStyle:we,lineWidth:ce,title:$e,axisLabelVisible:!0}):(j.current=le.createPriceLine({price:re,color:he,lineStyle:we,lineWidth:ce,title:$e,axisLabelVisible:!0}),K.current=le)},[t]),Ee=u.useCallback(j=>{if(!t.current)return null;const K=t.current.priceToCoordinate(j);return K??null},[t]),ve=u.useCallback(()=>{const j=(K,re)=>{if(!K.current){re(null);return}const he=K.current.options().price,we=Ee(he);if(we==null){re(null);return}re({y:we,price:he})};j(W,Q),j(_,me),j(q,fe)},[Ee]),Oe=u.useCallback(()=>{if(!R)return null;const K=nn.getInstance().getCachedData(R,N)?.data?.ltp;return!K||K<=0?null:K},[R,N]),Be=u.useCallback(j=>j==="BUY"?"above":"below",[]),rt=u.useCallback((j,K)=>{const re=Oe();return re?j==="BUY"&&K<=re?{ok:!1,message:`BUY trigger must be above current price (${re.toFixed(2)})`}:j==="SELL"&&K>=re?{ok:!1,message:`SELL trigger must be below current price (${re.toFixed(2)})`}:{ok:!0}:{ok:!0}},[Oe]),St=u.useCallback(async()=>{if(i)return i;try{const K=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(K.status==="success"&&K.api_key)return a(K.api_key),K.api_key}catch(j){console.error("[Scalping] Failed to fetch API key:",j)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[i,a]),Ze=u.useCallback(async()=>{if(I.current)return;const j=Se.current;if(!j)return;const K=Date.now()-oe.current,re=j.force?0:Math.max(0,ea-K);if(re>0){if(xe.current!=null)return;xe.current=window.setTimeout(()=>{xe.current=null,Ze()},re);return}Se.current=null,I.current=!0,oe.current=Date.now();try{if(!await St())return;await Te.modifyOrder(j.orderId,{symbol:j.symbol,exchange:N,action:j.action,product:P,pricetype:"LIMIT",price:j.price,quantity:j.quantity,trigger_price:0,disclosed_quantity:0})}catch(he){console.error("[Scalping] Failed to modify pending LIMIT order:",he)}finally{I.current=!1,Se.current&&Ze()}},[St,N,P]),Nt=u.useCallback((j,K,re=!1)=>{if(y||!j.orderId)return;const he=He(K),we=Se.current;Se.current={orderId:j.orderId,symbol:j.symbol,action:j.action,quantity:j.quantity,price:he,force:re||!!we?.force},re&&xe.current!=null&&(window.clearTimeout(xe.current),xe.current=null),Ze()},[y,Ze]);u.useEffect(()=>()=>{xe.current!=null&&(window.clearTimeout(xe.current),xe.current=null)},[]);const xt=u.useCallback(async(j,K)=>{if(!R||Le.current)return!1;Le.current=!0;try{if(y){const ke=await Mt({symbol:R,exchange:N,preferredPrice:j});return ke<=0?!1:(O(ft({symbol:R,exchange:N,side:s,action:K,entryPrice:ke,quantity:h*x,tpPoints:l,slPoints:d,trailDistancePoints:m,managedBy:"manual"})),w(),ne(),V(null),M(null),!0)}const re=await St();if(!re)return!1;const he={apikey:re,strategy:"Scalping",exchange:N,symbol:R,action:K,quantity:h*x,pricetype:"LIMIT",product:P,price:j,trigger_price:0,disclosed_quantity:0},we=await Te.placeOrder(he);if(we.status!=="success")return console.error("[Scalping] LIMIT order rejected:",we),!1;const ce=Kt(we);return X({symbol:R,side:s,action:K,orderId:ce,quantity:h*x,entryPrice:j,tpPoints:l,slPoints:d,trailDistancePoints:m}),V(null),M(j),!0}catch(re){return console.error("[Scalping] LIMIT order failed:",re),!1}finally{Le.current=!1}},[R,y,N,s,h,x,l,d,m,P,St,O,w,ne,V,M,X]);u.useEffect(()=>{const j=e.current,K=t.current;if(!j||!K)return;if(!(Ne&&_e&&!U&&!se&&!Re&&p==null)){Y(z,f);return}const he=we=>{if(!we.point){Y(z,f);return}const ce=K.coordinateToPrice(we.point.y);if(ce==null){Y(z,f);return}const ke=He(ce);ge(z,f,ke,"#a1a1aa",yt.Dashed,1,ke.toFixed(2))};return j.subscribeCrosshairMove(he),()=>{j.unsubscribeCrosshairMove(he),Y(z,f)}},[e,t,Ne,_e,U,se,Re,p,Y,ge]),u.useEffect(()=>{const j=e.current,K=t.current;if(!j||!K||!R||!Ne||!_e)return;const re=he=>{if(!he.point)return;const we=K.coordinateToPrice(he.point.y);if(we==null)return;const ce=He(we);if(c==="TRIGGER"){const ke=v??se?.action;if(!ke){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const le=rt(ke,ce);if(!le.ok){console.warn(`[Scalping] ${le.message}`);return}const $e=Be(ke);se?L(se.id,{triggerPrice:ce,action:ke,direction:$e,quantity:h*x,tpPoints:l,slPoints:d}):ee({id:`trigger-${Date.now()}`,symbol:R,exchange:N,side:s,action:ke,triggerPrice:ce,direction:$e,quantity:h*x,tpPoints:l,slPoints:d,trailDistancePoints:m,createdAt:Date.now()}),M(ce),V(null)}else{if(Re){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!v){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(U)return;M(ce),xt(ce,v)}Y(z,f),ve()};return j.subscribeClick(re),()=>{j.unsubscribeClick(re)}},[e,t,R,Ne,_e,c,v,U,se,Re,h,x,l,d,m,N,s,ee,L,M,V,Be,rt,xt,Y,ve]),u.useEffect(()=>{if(!t.current)return;const j=()=>{Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null)};if(U){const K=U.action==="BUY"?"#00ff88":"#ff4560";ge(W,A,He(U.entryPrice),K,yt.Dotted,2,`${U.action} @ ${U.entryPrice.toFixed(2)}`),U.tpPrice!=null?ge(_,Z,He(U.tpPrice),"#00ff88",yt.Dashed,1,`TP @ ${U.tpPrice.toFixed(2)}`):Y(_,Z),U.slPrice!=null?ge(q,E,He(U.slPrice),"#ff4560",yt.Dashed,1,`SL @ ${U.slPrice.toFixed(2)}`):Y(q,E),ve();return}if(se){const{tpPrice:K,slPrice:re}=Is(se),he=He(se.triggerPrice);ge(W,A,he,"#ffa500",yt.Dashed,2,`TRIGGER ${se.action} @ ${he.toFixed(2)}`),K!=null?ge(_,Z,K,"#00ff88",yt.Dashed,1,`TP @ ${K.toFixed(2)}`):Y(_,Z),re!=null?ge(q,E,re,"#ff4560",yt.Dashed,1,`SL @ ${re.toFixed(2)}`):Y(q,E),ve();return}if(Ne&&_e&&qe){const K=Ge,re=Re?g?.tpPoints??l:l,he=Re?g?.slPoints??d:d,we=Re?g?.entryPrice??p:p;if(we==null){j();return}const ce=He(we);if(ge(W,A,ce,c==="LIMIT"?"#06b6d4":"#ffa500",yt.Dashed,2,`${c} ${K} @ ${ce.toFixed(2)}`),re>0){const le=He(ce+(K==="BUY"?re:-re));ge(_,Z,le,"#00ff88",yt.Dashed,1,`TP @ ${le.toFixed(2)}`)}else Y(_,Z);if(he>0){const le=He(ce+(K==="BUY"?-he:he));ge(q,E,le,"#ff4560",yt.Dashed,1,`SL @ ${le.toFixed(2)}`)}else Y(q,E);ve();return}j()},[t,U,se,Ne,_e,qe,p,Ge,g,Re,c,l,d,Y,ge,ve]),u.useEffect(()=>{},[U,Rt]),u.useEffect(()=>{const j=e.current;if(!j)return;const K=()=>ve();j.subscribeCrosshairMove(K);const re=j.timeScale();return re.subscribeVisibleLogicalRangeChange(K),()=>{j.unsubscribeCrosshairMove(K),re.unsubscribeVisibleLogicalRangeChange(K)}},[e,ve]),u.useEffect(()=>{const j=r.current;if(!j)return;const K=()=>{!W.current&&!_.current&&!q.current||ve()},re=window.setInterval(K,100);return j.addEventListener("wheel",K,{passive:!0}),j.addEventListener("mousemove",K),window.addEventListener("resize",K),()=>{window.clearInterval(re),j.removeEventListener("wheel",K),j.removeEventListener("mousemove",K),window.removeEventListener("resize",K)}},[r,ve]),u.useEffect(()=>{U||se||Re||v==null&&(p==null&&!W.current&&!_.current&&!q.current||(Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null),M(null)))},[U,se,Re,v,p,Y,M]),u.useEffect(()=>()=>{Y(z,f),Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null)},[R,Y]),u.useEffect(()=>{c==="MARKET"&&(U||se||(Y(z,f),Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null),M(null),V(null),ne()))},[c,U,se,Y,M,V,ne]);const ht=u.useCallback((j,K)=>{if(K.preventDefault(),K.stopPropagation(),!Ke||!(j==="entry"?W:j==="tp"?_:q).current)return;Pe.current={type:j,source:Ke};const he=ce=>{const ke=Pe.current,le=t.current,$e=r.current;if(!ke||!le||!$e)return;const Qe=$e.getBoundingClientRect(),pe=ce.clientY-Qe.top,wt=le.coordinateToPrice(pe);if(wt==null)return;const ct=He(wt),Me=ke.type==="entry"?W:ke.type==="tp"?_:q;if(Me.current){if(ke.type==="entry"?ke.source==="trigger"?`${se?.action??"BUY"}${ct.toFixed(2)}`:ke.source==="pending"?`${c}${Ge}${ct.toFixed(2)}`:ke.source==="position"?`${U?.action??Ge}${ct.toFixed(2)}`:Me.current.options().title??ct.toFixed(2):ke.type==="tp"?`${ct.toFixed(2)}`:`${ct.toFixed(2)}`,Me.current.applyOptions({price:ct,title:""}),ke.type==="entry"){const Ye=ke.source==="trigger"?se?.action??Ge:ke.source==="position"?U?.action??Ge:Ge,tt=ke.source==="trigger"?se?.tpPoints??0:ke.source==="position"?U?.tpPoints??0:l,gt=ke.source==="trigger"?se?.slPoints??0:ke.source==="position"?U?.slPoints??0:d;if(tt>0&&_.current){const Je=He(ct+(Ye==="BUY"?tt:-tt));_.current.applyOptions({price:Je,title:""})}if(gt>0&&q.current){const Je=He(ct+(Ye==="BUY"?-gt:gt));q.current.applyOptions({price:Je,title:""})}}ve()}},we=()=>{const ce=Pe.current;if(!ce)return;const le=(ce.type==="entry"?W:ce.type==="tp"?_:q).current?.options().price;if(le!=null){if(ce.source==="position"&&U){const $e=ce.type==="entry"?{entryPrice:le,tpPrice:U.tpPrice!=null?He(U.tpPrice+(le-U.entryPrice)):null,slPrice:U.slPrice!=null?He(U.slPrice+(le-U.entryPrice)):null}:ce.type==="tp"?{tpPrice:le,tpPoints:kt(Math.abs(le-U.entryPrice))}:ce.type==="sl"?{slPrice:le,slPoints:kt(Math.abs(U.entryPrice-le))}:null;$e&&$(U.id,$e)}if(ce.source==="trigger"&&se){if(ce.type==="entry"){const $e=rt(se.action,le);if($e.ok)L(se.id,{triggerPrice:le,direction:Be(se.action)}),M(le);else{console.warn(`[Scalping] ${$e.message}`);const Qe=He(se.triggerPrice);W.current?.applyOptions({price:Qe,title:""});const{tpPrice:pe,slPrice:wt}=Is(se);_.current&&pe!=null&&_.current.applyOptions({price:pe,title:""}),q.current&&wt!=null&&q.current.applyOptions({price:wt,title:""}),M(Qe)}}ce.type==="tp"&&L(se.id,{tpPoints:kt(Math.abs(le-se.triggerPrice))}),ce.type==="sl"&&L(se.id,{slPoints:kt(Math.abs(se.triggerPrice-le))})}if(ce.source==="pending"){const $e=W.current?.options().price??p??le;if(Re&&g){const Qe={...g};ce.type==="entry"&&(Qe.entryPrice=le,M(le),Nt({orderId:Qe.orderId,symbol:Qe.symbol,action:Qe.action,quantity:Qe.quantity},le,!0)),ce.type==="tp"&&(Qe.tpPoints=kt(Math.abs(le-$e))),ce.type==="sl"&&(Qe.slPoints=kt(Math.abs($e-le))),X(Qe)}else ce.type==="entry"&&M(le),ce.type==="tp"&&F(kt(Math.abs(le-$e))),ce.type==="sl"&&D(kt(Math.abs($e-le)))}}ve(),Pe.current=null,document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",we)};document.addEventListener("mousemove",he),document.addEventListener("mouseup",we)},[Ke,t,r,U,se,Ge,c,p,Re,g,l,d,Nt,$,L,Be,rt,ve,X,M,F,D]),It=u.useCallback(async()=>{if(Re&&g?.orderId&&!y)try{const j=await Te.cancelOrder(g.orderId);if(j.status!=="success"){console.error("[Scalping] Failed to cancel LIMIT order:",j);return}}catch(j){console.error("[Scalping] Failed to cancel LIMIT order:",j);return}Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null),U&&k(U.symbol),se&&S(se.id),Re&&!g?.orderId&&!y&&console.warn("[Scalping] Pending LIMIT has no broker orderId; cleared local lines only."),ne(),M(null),V(null)},[U,se,Re,g,y,Y,k,S,ne,M,V]),Wt=u.useCallback(j=>{if(Y(j==="tp"?_:q,j==="tp"?Z:E),j==="tp"?me(null):fe(null),U){$(U.id,j==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(se){L(se.id,j==="tp"?{tpPoints:0}:{slPoints:0});return}j==="tp"?F(0):D(0)},[U,se,Y,F,D,$,L]),Pt=u.useCallback(async()=>{if(!(!U||ie)){ae(!0);try{if(y)console.log(`[Paper] Close ${U.action} ${U.symbol}`);else{const j=await Te.closePosition(U.symbol,U.exchange,P);if(j.status!=="success"){console.error("[Scalping] Close position rejected:",j);return}}k(U.symbol),Y(W,A),Y(_,Z),Y(q,E),Q(null),me(null),fe(null)}catch(j){console.error("[Scalping] Close position failed:",j)}finally{ae(!1)}}},[U,ie,y,P,k,Y]);if(!r.current)return null;const lt=!!U,At=lt?U.action==="BUY"?"green":"red":c==="LIMIT"?"cyan":"orange",Ht=lt?`${U.action} @ ${B?.price.toFixed(2)??"--"}`:se?`TRIGGER ${se.action} @ ${B?.price.toFixed(2)??"--"}`:`${c} ${Ge} @ ${B?.price.toFixed(2)??"--"}`,$t={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[At],Ce={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[At],Ve=Ke!==null;return n.jsxs(n.Fragment,{children:[B&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:B.y},children:[n.jsx("div",{className:Ue("absolute left-0 right-0 top-0 h-px -translate-y-1/2",Ce)}),n.jsx("div",{className:Ue("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",Ve?"cursor-ns-resize":"cursor-default"),onMouseDown:Ve?j=>ht("entry",j):void 0}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsx("span",{className:Ue("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",$t),children:Ht}),lt&&We&&n.jsxs("span",{className:Ue("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",We.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",We.ltp.toFixed(2)," | PnL ",We.pnl>=0?"+":"",We.pnl.toFixed(2)]}),lt&&n.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:j=>{j.stopPropagation(),Pt()},disabled:ie,title:"Close position at market",children:ie?"...":"Close"}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:j=>{j.stopPropagation(),It()},title:lt?"Remove virtual position tracking":"Cancel pending order",children:"×"})]})]}),de&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:de.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:j=>ht("tp",j)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",de.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:j=>{j.stopPropagation(),Wt("tp")},title:"Remove TP line",children:"×"})]})]}),be&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:be.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:j=>ht("sl",j)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",be.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:j=>{j.stopPropagation(),Wt("sl")},title:"Remove SL line",children:"×"})]})]})]})}const na=120,sa=1,ra=10,ia=40,aa=3e4,oa=120,la=5e3;function kn(e){return e.map(t=>({time:t.time,value:t.value}))}function ca(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function ua(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function As(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function te(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Tn(e){if(!Number.isFinite(e))return"0";const t=Math.abs(e);return t>=1e6?`${(e/1e6).toFixed(2)}M`:t>=1e3?`${(e/1e3).toFixed(1)}K`:t>=100?e.toFixed(0):t>=10?e.toFixed(1):t>0?e.toFixed(2):"0"}const $s={buyFlow:0,sellFlow:0,delta:0,cumulativeDelta:0,dominance:"BAL",depthImbalancePct:null,spread:null,flowSource:"EST",lastUpdate:0};function da(e){return te(e.ltp)??te(e.last_price)??te(e.lp)??te(e.price)??te(e.close)}function pa(e){return te(e.volume)??te(e.total_volume)??te(e.v)??te(e.ttq)}function ma(e){return te(e.bid_price)??te(e.bid)??te(e.bp)??te(e.best_bid_price)??te(e.bp1)}function fa(e){return te(e.ask_price)??te(e.ask)??te(e.sp)??te(e.best_ask_price)??te(e.sp1)}function xa(e){return te(e.bid_size)??te(e.bid_qty)??te(e.total_buy_quantity)??te(e.total_buy_qty)??te(e.totalbuyqty)??te(e.buy_quantity)??te(e.tbq)??te(e.bq1)}function ha(e){return te(e.ask_size)??te(e.ask_qty)??te(e.total_sell_quantity)??te(e.total_sell_qty)??te(e.totalsellqty)??te(e.sell_quantity)??te(e.tsq)??te(e.sq1)}function Ds(e){if(!e||typeof e!="object")return 0;const t=e,s=te(t.price)??te(t.px);return s!=null&&s>0?s:0}function En(e){if(!e||typeof e!="object")return 0;const t=e,s=te(t.quantity)??te(t.qty)??te(t.size)??te(t.volume);return s!=null&&s>0?s:0}function ga(e,t){const s=Math.max(0,t.buyFlow+t.sellFlow);if(s<=0)return{action:"HOLD",label:"HOLD FOR NOW"};const r=Math.abs(t.delta)/Math.max(1,s),i=t.delta===0?!1:Math.sign(t.delta)===Math.sign(t.cumulativeDelta)&&Math.abs(t.cumulativeDelta)>=Math.abs(t.delta)*.35,a=t.flowSource==="VOL"?1e3:250,o=t.flowSource==="VOL"?.12:.22;if(!i||s<a||r<o)return{action:"HOLD",label:"HOLD FOR NOW"};const c=t.delta>0&&t.cumulativeDelta>0,l=t.delta<0&&t.cumulativeDelta<0;return c?e==="CE"?{action:"BUY_CE",label:"BUY CE NOW"}:{action:"BUY_PE",label:"BUY PE NOW"}:l?e==="CE"?{action:"BUY_PE",label:"BUY PE NOW"}:{action:"BUY_CE",label:"BUY CE NOW"}:{action:"HOLD",label:"HOLD FOR NOW"}}function rs(e){const t=bt(e);return t??null}function ya(e){if(!e?.length)return[];const t=[];for(const a of e){const o=bt(a.timestamp)??bt(a.time)??bt(a.datetime)??bt(a.date),c=te(a.open),l=te(a.high),d=te(a.low),m=te(a.close),p=te(a.volume)??0;o==null||c==null||l==null||d==null||m==null||t.push({time:o,open:c,high:l,low:d,close:m,volume:p})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const s=new Map;for(const a of t)s.set(Number(a.time),a);const r=Array.from(s.values()).slice(-500),i=r.filter(a=>ns(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function Qt(e){return e.map(t=>({...t}))}function ba(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function _n(e){const t=[];for(const s of e){const r=rs(s.time);r!=null&&t.push({time:r,open:s.open,high:s.high,low:s.low,close:s.close})}return t.sort((s,r)=>Number(s.time)-Number(r.time)),t}function Os(e){if(!e.length)return[];const t=new Map;for(const s of e){const r=rs(s.time),i=te(s.open),a=te(s.high),o=te(s.low),c=te(s.close),l=te(s.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((s,r)=>Number(s.time)-Number(r.time)).slice(-500)}function Fs({side:e,showEma9:t,showEma21:s,showSupertrend:r,showVwap:i,showOrderFlow:a}){const o=u.useRef(null),c=u.useRef(null),l=u.useRef(null),d=u.useRef(null),m=u.useRef(null),p=u.useRef(null),v=u.useRef(null),g=u.useRef([]),h=u.useRef(new Map),x=u.useRef(null),N=u.useRef(0),P=u.useRef(null),y=u.useRef({lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0}),[w,M]=u.useState($s),[F,D]=u.useState(()=>Date.now()),V=u.useRef({showEma9:t,showEma21:s,showSupertrend:r,showVwap:i}),X=Ae(G=>G.apiKey),ne=Ae(G=>G.setApiKey),R=nr(G=>G.mode==="dark"),C=b(G=>G.activeSide),J=b(G=>G.setActiveSide),ee=b(G=>G.optionExchange),L=b(G=>G.chartInterval),S=b(G=>e==="CE"?G.selectedCESymbol:G.selectedPESymbol),O=C===e,k=u.useMemo(()=>a&&S?[{symbol:S,exchange:ee}]:[],[a,S,ee]),{data:$}=fn({symbols:k,mode:"Quote",enabled:a&&!!S}),{data:z}=fn({symbols:k,mode:"LTP",enabled:a&&!!S}),{data:W}=fn({symbols:k,mode:"Depth",enabled:a&&!!S}),_=u.useMemo(()=>ga(e,w),[e,w]),q=u.useMemo(()=>!a||!S||w.lastUpdate<=0?!1:F-w.lastUpdate>la,[F,w.lastUpdate,a,S]);u.useEffect(()=>{if(!a||!S)return;const G=setInterval(()=>D(Date.now()),1e3);return()=>clearInterval(G)},[a,S]),u.useEffect(()=>{y.current={lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0},M($s)},[a,S,ee]),u.useEffect(()=>{if(!a||!S)return;const G=`${ee.toUpperCase()}:${S.toUpperCase()}`,T=$.get(G),ie=z.get(G),ae=W.get(G),Le=[T,ie,ae].filter(Ce=>!!Ce),I=Le.reduce((Ce,Ve)=>Ce?(Ve.lastUpdate??0)>=(Ce.lastUpdate??0)?Ve:Ce:Ve,Le[0]??null);if(!T?.data&&!ie?.data&&!ae?.data)return;const oe={...T?.data??{},...ie?.data??{},...ae?.data??{}},xe=da({...oe,...I?.data??{}});if(xe==null||xe<=0)return;const Se=I?.lastUpdate??Date.now(),Pe=y.current,Ne=Pe.lastLtp,_e=Se>Pe.lastTickAt,ze=pa(oe),U=Pe.lastVolume;let se=[],Re=[];if(oe.depth&&typeof oe.depth=="object"){const Ce=oe.depth;se=Array.isArray(Ce.buy)?Ce.buy:[],Re=Array.isArray(Ce.sell)?Ce.sell:[]}const qe=se.length>0?Ds(se[0]):0,Ke=Re.length>0?Ds(Re[0]):0,Ge=ma(oe)??(qe>0?qe:null),We=fa(oe)??(Ke>0?Ke:null),vt=se.length>0?En(se[0]):0,Rt=Re.length>0?En(Re[0]):0,Y=xa(oe),ge=ha(oe),Ee=Y!=null&&Y>0?Y:vt>0?vt:null,ve=ge!=null&&ge>0?ge:Rt>0?Rt:null;let Oe=0,Be=0,rt=!1,St=!1,Ze=0;if(ze!=null&&U!=null&&Number.isFinite(ze)&&Number.isFinite(U)&&ze>=U?Ze=Math.max(0,ze-U):ze!=null&&U==null&&(Ze=0),Ze>0)if(St=!0,Ne!=null&&xe>Ne)Oe=Ze;else if(Ne!=null&&xe<Ne)Be=Ze;else if(Ge!=null&&We!=null&&We>Ge){const Ce=(Ge+We)/2;xe>=Ce?Oe=Ze:Be=Ze}else Oe=Ze*.5,Be=Ze*.5,rt=!0;if(Oe<=0&&Be<=0){const Ce=Pe.lastBidSize,Ve=Pe.lastAskSize,j=Ve!=null&&ve!=null?Math.max(0,Ve-ve):0,K=Ce!=null&&Ee!=null?Math.max(0,Ce-Ee):0,re=Ce!=null&&Ee!=null?Math.max(0,Ee-Ce):0,he=Ve!=null&&ve!=null?Math.max(0,ve-Ve):0;let we=j+re*.35,ce=K+he*.35;Ne!=null&&xe>Ne&&(we+=1),Ne!=null&&xe<Ne&&(ce+=1);const ke=we+ce;if(ke>0){rt=!0;const le=Math.max(1,Math.min(12,Math.sqrt(ke)));if(we>ce)Oe=le;else if(ce>we)Be=le;else if(Ee!=null&&ve!=null&&Ee+ve>0){const $e=(Ee-ve)/(Ee+ve);$e>0?Oe=Math.max(1,le*Math.abs($e)):$e<0&&(Be=Math.max(1,le*Math.abs($e)))}}}Oe<=0&&Be<=0&&Ne!=null&&(rt=!0,xe>Ne?Oe=1:xe<Ne&&(Be=1)),Oe<=0&&Be<=0&&_e&&(rt=!0,Oe=.35,Be=.35),Pe.lastLtp=xe,Pe.lastTickAt=Se,ze!=null&&Number.isFinite(ze)&&ze>=0&&(Pe.lastVolume=ze),Ee!=null&&Number.isFinite(Ee)&&Ee>=0&&(Pe.lastBidSize=Ee),ve!=null&&Number.isFinite(ve)&&ve>=0&&(Pe.lastAskSize=ve),(Oe>0||Be>0)&&(Pe.buckets.push({ts:Se,buy:Oe,sell:Be}),Pe.cumulativeDelta+=Oe-Be);const Nt=Se-aa;Pe.buckets=Pe.buckets.filter(Ce=>Ce.ts>=Nt);const xt=Pe.buckets.reduce((Ce,Ve)=>Ce+Ve.buy,0),ht=Pe.buckets.reduce((Ce,Ve)=>Ce+Ve.sell,0),It=xt-ht,Wt=It>0?"BUY":It<0?"SELL":"BAL";let Pt=0,lt=0;se.length||Re.length?(Pt=se.slice(0,5).reduce((Ce,Ve)=>Ce+En(Ve),0),lt=Re.slice(0,5).reduce((Ce,Ve)=>Ce+En(Ve),0)):(Pt=Ee&&Ee>0?Ee:0,lt=ve&&ve>0?ve:0);const At=Pt+lt,Ht=At>0?(Pt-lt)/At*100:null,$t=Ge!=null&&We!=null&&We>=Ge?We-Ge:null;Se-Pe.lastEmitAt<oa||(Pe.lastEmitAt=Se,M({buyFlow:xt,sellFlow:ht,delta:It,cumulativeDelta:Pe.cumulativeDelta,dominance:Wt,depthImbalancePct:Ht,spread:$t,flowSource:St&&!rt?"VOL":"EST",lastUpdate:Se}))},[W,z,$,ee,a,S]);const f=u.useCallback(()=>{const G=g.current,T=V.current,ie=G.map(ae=>({time:ae.time,value:ae.close}));d.current&&d.current.setData(T.showEma9?kn(An(ie,9)):[]),m.current&&m.current.setData(T.showEma21?kn(An(ie,21)):[]),p.current&&p.current.setData(T.showSupertrend?kn(Mr(G,10,3).trend):[]),v.current&&v.current.setData(T.showVwap?kn(Rr(G)):[])},[]),A=u.useCallback(()=>{P.current===null&&(P.current=setTimeout(()=>{P.current=null,f()},na))},[f]),Z=u.useCallback(()=>{g.current=[],l.current?.setData([]),d.current?.setData([]),m.current?.setData([]),p.current?.setData([]),v.current?.setData([])},[]),E=u.useCallback(G=>{const T=Os(G);g.current=Qt(T),l.current?.setData(_n(T)),A()},[A]),B=u.useCallback(async()=>{if(X)return X;try{const T=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(T.status==="success"&&T.api_key)return ne(T.api_key),T.api_key}catch{}return null},[X,ne]),Q=u.useCallback(()=>{J(e)},[e,J]),de=u.useCallback((G,T)=>{if(!l.current)return;const ie=rs(G.time),ae=te(G.open),Le=te(G.high),I=te(G.low),oe=te(G.close),xe=te(G.volume)??0;if(ie==null||ae==null||Le==null||I==null||oe==null)return;const Se={time:ie,open:ae,high:Le,low:I,close:oe,volume:xe},Pe=Number(Se.time),Ne=g.current.length?Number(g.current[g.current.length-1].time):null;if(Ne!=null&&Number.isFinite(Ne)&&Number.isFinite(Pe)&&Pe<Ne)return;try{l.current.update({time:Se.time,open:Se.open,high:Se.high,low:Se.low,close:Se.close})}catch{const ze=Os([...g.current,Se]);g.current=ze,l.current.setData(_n(ze)),A();return}T?(g.current.push(Se),g.current.length>500&&(g.current=g.current.slice(-500))):g.current.length>0?g.current[g.current.length-1]=Se:g.current.push(Se);const _e=x.current;_e&&h.current.set(_e,Qt(g.current)),A()},[A]),{isConnected:me,reset:be,seed:fe}=Lr({symbol:S??"",exchange:ee,intervalSec:L,mode:"Quote",enabled:!!S,useIndiaMarketHours:!0,onCandleUpdate:de});return u.useEffect(()=>{const G=x.current;if(G&&g.current.length>0&&h.current.set(G,Qt(g.current)),!S){x.current=null,be(),Z();return}const T=`${ee}:${S}:${L}`;x.current=T;const ie=h.current.get(T);if(ie&&ie.length>0){be(),fe(ie),E(ie);return}be(),Z();const ae=++N.current,Le=ua(L),I=new Date,oe=new Date(I.getTime());oe.setDate(oe.getDate()-sa),(async()=>{const Se=await B();if(!Se){ae===N.current&&Z();return}try{const Pe=async()=>{try{const qe=await Te.getQuotes(Se,S,ee);if(qe.status!=="success"||!qe.data)return null;const Ke=te(qe.data.ltp);if(Ke==null||Ke<=0)return null;const Ge=Math.floor(Date.now()/1e3);return{time:Math.floor(Ge/L)*L,open:Ke,high:Ke,low:Ke,close:Ke,volume:te(qe.data.volume)??0}}catch{return null}},Ne=async qe=>{try{const Ke=await Te.getHistory(Se,S,ee,Le,As(oe),As(I),qe);return Ke.status==="success"?ya(Ke.data):[]}catch{return[]}},_e=await Ne("api"),ze=_e.length>0?_e:await Ne("db");if(ae!==N.current)return;const U=x.current===T?Qt(g.current):[],se=ba(ze,U);if(se.length>0){h.current.set(T,Qt(se)),fe(se),E(se);return}const Re=await Pe();if(Re&&ae===N.current){const qe=[Re];h.current.set(T,Qt(qe)),fe(qe),E(qe);return}}catch{}ae===N.current&&Z()})()},[S,ee,L,B,be,fe,Z,E]),u.useEffect(()=>{V.current={showEma9:t,showEma21:s,showSupertrend:r,showVwap:i},d.current?.applyOptions({visible:t}),m.current?.applyOptions({visible:s}),p.current?.applyOptions({visible:r}),v.current?.applyOptions({visible:i}),A()},[t,s,r,i,A]),u.useEffect(()=>{const G=o.current;if(!G)return;const T=ca(R),ie=Ir(ra,ia),ae=or(G,{width:G.offsetWidth,height:G.offsetHeight,layout:{background:{type:cr.Solid,color:T.bg},textColor:T.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:T.grid},horzLines:{color:T.grid}},rightPriceScale:{borderColor:T.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:T.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:Ne=>Cr(Ne)},crosshair:{mode:lr.Normal,vertLine:{width:1,color:T.crosshair,style:2},horzLine:{width:1,color:T.crosshair,style:2}}}),Le=ae.addSeries(ur,{upColor:T.upColor,downColor:T.downColor,borderVisible:!1,wickUpColor:T.upColor,wickDownColor:T.downColor,autoscaleInfoProvider:ie}),I=ae.addSeries(Et,{color:T.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:V.current.showEma9,autoscaleInfoProvider:ie}),oe=ae.addSeries(Et,{color:T.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:V.current.showEma21,autoscaleInfoProvider:ie}),xe=ae.addSeries(Et,{color:T.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:V.current.showSupertrend,autoscaleInfoProvider:ie}),Se=ae.addSeries(Et,{color:T.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:V.current.showVwap,autoscaleInfoProvider:ie});c.current=ae,l.current=Le,d.current=I,m.current=oe,p.current=xe,v.current=Se,g.current.length>0&&(Le.setData(_n(g.current)),A());const Pe=new ResizeObserver(()=>{if(c.current&&G){const Ne=G.offsetWidth,_e=G.offsetHeight;Ne>0&&_e>0&&c.current.applyOptions({width:Ne,height:_e})}});return Pe.observe(G),()=>{P.current!==null&&(clearTimeout(P.current),P.current=null),Pe.disconnect(),ae.remove(),c.current=null,l.current=null,d.current=null,m.current=null,p.current=null,v.current=null}},[R,A]),n.jsxs("div",{className:Ue("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",O&&"ring-1 ring-primary/40"),onClick:Q,children:[n.jsx("div",{ref:o,className:"h-full w-full"}),n.jsx(ta,{chartRef:c,seriesRef:l,side:e,containerRef:o}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:Ue("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),S&&n.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:S}),!S&&n.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),n.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),s&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),a&&S&&n.jsxs("div",{className:"absolute top-7 left-2 pointer-events-none rounded border border-border/70 bg-background/85 backdrop-blur-[1px] px-2 py-1.5 text-[10px] font-mono leading-tight",children:[n.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[n.jsx("span",{className:"text-muted-foreground",children:"FLOW 30s"}),n.jsx("span",{className:Ue(w.flowSource==="VOL"?"text-emerald-500":"text-amber-500"),children:w.flowSource})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-3 gap-y-0.5",children:[n.jsxs("span",{className:"text-green-500",children:["B ",Tn(w.buyFlow)]}),n.jsxs("span",{className:"text-red-500 text-right",children:["S ",Tn(w.sellFlow)]}),n.jsxs("span",{className:Ue(w.delta>0?"text-green-500":w.delta<0?"text-red-500":"text-muted-foreground"),children:["D ",w.delta>=0?"+":"",Tn(w.delta)]}),n.jsxs("span",{className:Ue(w.cumulativeDelta>0?"text-green-500":w.cumulativeDelta<0?"text-red-500":"text-muted-foreground","text-right"),children:["CD ",w.cumulativeDelta>=0?"+":"",Tn(w.cumulativeDelta)]}),n.jsx("span",{className:Ue(w.dominance==="BUY"?"text-green-500":w.dominance==="SELL"?"text-red-500":"text-muted-foreground"),children:w.dominance}),n.jsx("span",{className:Ue(_.action==="BUY_CE"?"text-green-500":_.action==="BUY_PE"?"text-red-500":"text-amber-400","text-right"),children:_.label}),(w.depthImbalancePct!=null||w.spread!=null)&&n.jsxs("span",{className:Ue(w.depthImbalancePct==null?"text-muted-foreground":w.depthImbalancePct>=0?"text-green-500":"text-red-500","text-right"),children:["DEPTH ",w.depthImbalancePct==null?"NA":`${w.depthImbalancePct>=0?"+":""}${w.depthImbalancePct.toFixed(0)}%`]}),(w.depthImbalancePct!=null||w.spread!=null)&&n.jsxs("span",{className:"text-muted-foreground col-span-2",children:["SPR ",w.spread==null?"NA":w.spread.toFixed(2)]}),w.depthImbalancePct==null&&w.spread==null&&n.jsx("span",{className:Ue("col-span-2 text-right",q?"text-amber-500":"text-muted-foreground"),children:q?"WS stale / no recent ticks":"No L2 quote"})]})]}),O&&n.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),S&&!me&&n.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!S&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function Ot(e,t){if(e&&typeof e=="object"){const s=e.message;if(typeof s=="string"&&s.trim().length>0)return s.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function va(){const e=Ae(T=>T.apiKey),t=Ae(T=>T.setApiKey),s=b(T=>T.showFloatingWidget),r=b(T=>T.floatingWidgetMinimized),i=b(T=>T.setFloatingWidgetMinimized),a=b(T=>T.activeSide),o=b(T=>T.selectedCESymbol),c=b(T=>T.selectedPESymbol),l=b(T=>T.optionExchange),d=b(T=>T.quantity),m=b(T=>T.lotSize),p=b(T=>T.product),v=b(T=>T.tpPoints),g=b(T=>T.slPoints),h=b(T=>T.trailDistancePoints),x=b(T=>T.orderType),N=b(T=>T.limitPrice),P=b(T=>T.pendingLimitPlacement),y=b(T=>T.setLimitPrice),w=b(T=>T.setPendingEntryAction),M=b(T=>T.setPendingLimitPlacement),F=b(T=>T.clearPendingLimitPlacement),D=b(T=>T.paperMode),V=ue(T=>T.setVirtualTPSL),X=ue(T=>T.clearForSymbol),ne=ue(T=>T.triggerOrders),R=ue(T=>T.removeTriggerOrder),C=b(T=>T.ceWidgetPos),J=b(T=>T.setCeWidgetPos),ee=b(T=>T.incrementQuantity),L=b(T=>T.decrementQuantity),S=b(T=>T.setTpPoints),O=b(T=>T.setSlPoints),k=b(T=>T.setTrailDistancePoints),$=b(T=>T.incrementTradeCount),z=a==="CE"?o:c,[W,_]=u.useState(!1),[q,f]=u.useState(null),[A,Z]=u.useState(null),E=u.useRef(null),B=u.useRef(null);u.useEffect(()=>{if(!z){f(null),Z(null);return}const ie=nn.getInstance().subscribe(z,l,"LTP",ae=>{const Le=ae.data.ltp;Le!=null&&Le>0&&(Z(q),f(Le))});return()=>{ie()}},[z,l]);const Q=u.useCallback(T=>{if(T.target.closest("button, input"))return;T.preventDefault(),E.current={startX:T.clientX,startY:T.clientY,origX:C.x,origY:C.y};const ie=Le=>{if(!E.current)return;const I=Le.clientX-E.current.startX,oe=Le.clientY-E.current.startY;J({x:Math.max(0,E.current.origX+I),y:Math.max(0,E.current.origY+oe)})},ae=()=>{E.current=null,document.removeEventListener("mousemove",ie),document.removeEventListener("mouseup",ae)};document.addEventListener("mousemove",ie),document.addEventListener("mouseup",ae)},[C,J]),de=u.useCallback(async()=>{if(e)return e;try{const ie=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(ie.status==="success"&&ie.api_key)return t(ie.api_key),ie.api_key}catch(T){console.error("[Scalping] Failed to fetch API key:",T),je.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),je.error("API key missing. Generate one on /apikey"),null},[e,t]),me=u.useCallback(async T=>{if(!z||W){z||(console.warn("[Scalping] No symbol selected — click a strike first"),je.error("Select a strike first"));return}if(_(!0),x==="TRIGGER"){const I=Object.values(ne).find(oe=>oe.symbol===z&&oe.exchange===l&&oe.side===a);I&&R(I.id),F(),y(null),w(T),console.log(`[Scalping] TRIGGER armed (${T}) — click chart to place trigger line`),_(!1);return}if(x==="LIMIT"&&!N){w(T),console.log(`[Scalping] LIMIT armed (${T}) — click chart to set limit line`),_(!1);return}if(x==="LIMIT"&&P&&P.symbol===z&&P.side===a){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),je.error("A LIMIT order is already pending for this symbol"),_(!1);return}if(D){if(console.log(`[Paper] ${T} ${a} ${z} qty=${d*m} @ ${x}`),x==="MARKET"||x==="LIMIT"){const I=await Mt({symbol:z,exchange:l,preferredPrice:x==="LIMIT"?N??q??void 0:q??void 0});I>0&&(V(ft({symbol:z,exchange:l,side:a,action:T,entryPrice:I,quantity:d*m,tpPoints:v,slPoints:g,trailDistancePoints:h,managedBy:"manual"})),x==="LIMIT"&&y(null))}F(),$(),_(!1);return}const ie=await de();if(!ie){_(!1);return}const ae=x==="LIMIT"?"LIMIT":"MARKET",Le={apikey:ie,strategy:"Scalping",exchange:l,symbol:z,action:T,quantity:d*m,pricetype:ae,product:p,price:x==="LIMIT"&&N?N:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${T} ${z} qty=${d*m} ${ae}`);const I=await Te.placeOrder(Le);if(I.status==="success"){const oe=Kt(I);if(console.log(`[Scalping] Order placed: ${T} ${z} id=${oe??"n/a"}`),w(null),ae==="LIMIT"){const xe=N??q??0;xe<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state."),M({symbol:z,side:a,action:T,orderId:oe,quantity:d*m,entryPrice:xe,tpPoints:v,slPoints:g,trailDistancePoints:h}),xe>0&&y(xe),_(!1);return}if(F(),$(),ae==="MARKET"){const xe=await Mt({symbol:z,exchange:l,preferredPrice:q??void 0,apiKey:null}),Se=await Ut({symbol:z,exchange:l,orderId:oe,preferredPrice:xe>0?xe:q??void 0,apiKey:ie});Se>0&&V(ft({symbol:z,exchange:l,side:a,action:T,entryPrice:Se,quantity:d*m,tpPoints:v,slPoints:g,trailDistancePoints:h,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",I),je.error(Ot(I,"Order was rejected"))}catch(I){console.error("[Scalping] Order failed:",I),je.error(Ot(I,"Order placement failed"))}_(!1)},[z,a,d,m,l,p,x,N,P,v,g,h,D,X,ne,W,q,de,$,M,V,R,y,w,F]),be=u.useCallback(async()=>{if(!z||W)return;if(_(!0),D){console.log(`[Paper] Reversal ${a} ${z}`),$(),_(!1);return}const T=await de();if(!T){_(!1);return}try{const ie={apikey:T,strategy:"Scalping",exchange:l,symbol:z,action:"SELL",quantity:d*m,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},ae=await Te.placeOrder(ie);if(ae.status!=="success"){je.error(Ot(ae,"Reversal close leg failed")),_(!1);return}const Le={apikey:T,strategy:"Scalping",exchange:l,symbol:z,action:"SELL",quantity:d*m,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},I=await Te.placeOrder(Le);if(I.status!=="success"){je.error(Ot(I,"Reversal open leg failed")),_(!1);return}console.log(`[Scalping] Reversed ${a} ${z}`),$()}catch(ie){console.error("[Scalping] Reversal failed:",ie),je.error(Ot(ie,"Reversal failed"))}_(!1)},[z,a,d,m,l,p,D,W,de,$]),fe=u.useCallback(async()=>{if(z){if(D){console.log(`[Paper] Close ${a} ${z}`),X(z),y(null),w(null),F();return}try{const T=await Te.closePosition(z,l,p);T.status==="success"?(console.log(`[Scalping] Closed ${a} ${z}`),X(z),y(null),w(null),F()):(console.error("[Scalping] Close rejected:",T),je.error(Ot(T,"Close position rejected")))}catch(T){console.error("[Scalping] Close failed:",T),je.error(Ot(T,"Close position failed"))}}},[z,a,l,p,D,X,y,w,F]);if(!s||!z)return null;const G=q&&A?q>A?"up":q<A?"down":"flat":"flat";return r?n.jsx("div",{ref:B,onMouseDown:Q,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:C.x,top:C.y},children:n.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[n.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),n.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:z.slice(-10)}),n.jsx("span",{className:`text-xs font-bold tabular-nums ${G==="up"?"text-green-500":G==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),n.jsx(Ie,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):n.jsxs("div",{ref:B,onMouseDown:Q,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:C.x,top:C.y,minWidth:220},children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[n.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),n.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:z.slice(-10)}),n.jsx("span",{className:`text-sm font-bold tabular-nums ${G==="up"?"text-green-500":G==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),n.jsx(Ie,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[n.jsx(Ie,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>me("BUY"),disabled:W,children:"BUY"}),n.jsx(Ie,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>me("SELL"),disabled:W,children:"SELL"}),n.jsx(Ie,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:be,disabled:W,children:"REV"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:L,children:"-"}),n.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:d}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:ee,children:"+"}),n.jsx("div",{className:"flex-1"}),n.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),n.jsx("input",{type:"number",value:v,onChange:T=>S(Number.parseFloat(T.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),n.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),n.jsx("input",{type:"number",value:g,onChange:T=>O(Number.parseFloat(T.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),n.jsx("span",{className:"text-[10px] text-amber-400",children:"TR:"}),n.jsx("input",{type:"number",min:0,step:.5,value:h,onChange:T=>k(Number.parseFloat(T.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),n.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:fe,children:"x Close"})})]})}const Sa=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function Pa({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r,showOrderFlow:i,onToggleEma9:a,onToggleEma21:o,onToggleSupertrend:c,onToggleVwap:l,onToggleOrderFlow:d}){const m=b(v=>v.chartInterval),p=b(v=>v.setChartInterval);return n.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Sa.map(v=>n.jsx(Ie,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${m===v.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>p(v.sec),children:v.label},v.sec)),n.jsx(ja,{intervalSec:m}),n.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),n.jsx(dn,{label:"EMA9",active:e,color:"text-amber-500",onClick:a}),n.jsx(dn,{label:"EMA21",active:t,color:"text-violet-500",onClick:o}),n.jsx(dn,{label:"ST",active:s,color:"text-cyan-500",onClick:c}),n.jsx(dn,{label:"VWAP",active:r,color:"text-pink-500",onClick:l}),n.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),n.jsx(dn,{label:"FLOW",active:i,color:"text-emerald-500",onClick:d})]})}function ja({intervalSec:e}){const[t,s]=u.useState(()=>Bn(e));u.useEffect(()=>{s(Bn(e));const i=setInterval(()=>{s(Bn(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return n.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:Na(t,e)})}function Bn(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function Na(e,t){if(t>=3600){const s=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${s}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const s=Math.floor(e/60),r=e%60;return`${s}:${r.toString().padStart(2,"0")}`}return`${e}s`}function dn({label:e,active:t,color:s,onClick:r}){return n.jsx(Ie,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?s:"text-muted-foreground/50"}`,onClick:r,children:e})}function zs(){const[e,t]=u.useState(!0),[s,r]=u.useState(!0),[i,a]=u.useState(!0),[o,c]=u.useState(!0),[l,d]=u.useState(!1),m=u.useCallback(()=>t(x=>!x),[]),p=u.useCallback(()=>r(x=>!x),[]),v=u.useCallback(()=>a(x=>!x),[]),g=u.useCallback(()=>c(x=>!x),[]),h=u.useCallback(()=>d(x=>!x),[]);return n.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[n.jsx(Pa,{showEma9:e,showEma21:s,showSupertrend:i,showVwap:o,showOrderFlow:l,onToggleEma9:m,onToggleEma21:p,onToggleSupertrend:v,onToggleVwap:g,onToggleOrderFlow:h}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:n.jsxs(Wn,{orientation:"vertical",children:[n.jsx(zt,{defaultSize:"40%",minSize:"18%",children:n.jsx(Xi,{showEma9:e,showEma21:s,showSupertrend:i,showVwap:o})}),n.jsx(Rn,{withHandle:!0}),n.jsx(zt,{defaultSize:"60%",minSize:"24%",children:n.jsxs("div",{className:"relative h-full w-full",children:[n.jsxs(Wn,{orientation:"horizontal",children:[n.jsx(zt,{defaultSize:"50%",minSize:"20%",children:n.jsx(Fs,{side:"CE",showEma9:e,showEma21:s,showSupertrend:i,showVwap:o,showOrderFlow:l})}),n.jsx(Rn,{withHandle:!0}),n.jsx(zt,{defaultSize:"50%",minSize:"20%",children:n.jsx(Fs,{side:"PE",showEma9:e,showEma21:s,showSupertrend:i,showVwap:o,showOrderFlow:l})})]}),n.jsx(va,{})]})})]})})]})}function Ft(e,t){if(e&&typeof e=="object"){const s=e.message;if(typeof s=="string"&&s.trim().length>0)return s.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function wa(){const e=Ae(f=>f.apiKey),t=Ae(f=>f.setApiKey),s=b(f=>f.activeSide),r=b(f=>f.selectedCESymbol),i=b(f=>f.selectedPESymbol),a=b(f=>f.optionExchange),o=b(f=>f.quantity),c=b(f=>f.lotSize),l=b(f=>f.product),d=b(f=>f.orderType),m=b(f=>f.tpPoints),p=b(f=>f.slPoints),v=b(f=>f.trailDistancePoints),g=b(f=>f.limitPrice),h=b(f=>f.pendingLimitPlacement),x=b(f=>f.setLimitPrice),N=b(f=>f.setPendingEntryAction),P=b(f=>f.setPendingLimitPlacement),y=b(f=>f.clearPendingLimitPlacement),w=b(f=>f.paperMode),M=ue(f=>f.setVirtualTPSL),F=ue(f=>f.clearForSymbol),D=ue(f=>f.clearAll),V=ue(f=>f.triggerOrders),X=ue(f=>f.removeTriggerOrder),ne=b(f=>f.setQuantity),R=b(f=>f.incrementQuantity),C=b(f=>f.decrementQuantity),J=b(f=>f.setOrderType),ee=b(f=>f.setProduct),L=b(f=>f.setTpPoints),S=b(f=>f.setSlPoints),O=b(f=>f.setTrailDistancePoints),k=b(f=>f.incrementTradeCount),$=s==="CE"?r:i,z=u.useCallback(async()=>{if(e)return e;try{const A=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(A.status==="success"&&A.api_key)return t(A.api_key),A.api_key}catch(f){console.error("[Scalping] Failed to fetch API key:",f),je.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),je.error("API key missing. Generate one on /apikey"),null},[e,t]),W=u.useCallback(async f=>{if(!$){console.warn("[Scalping] No symbol selected — click a strike first"),je.error("Select a strike first");return}if(d==="TRIGGER"){const B=Object.values(V).find(Q=>Q.symbol===$&&Q.exchange===a&&Q.side===s);B&&X(B.id),y(),x(null),N(f),console.log(`[Scalping] TRIGGER armed (${f}) — click chart to place trigger line`);return}if(d==="LIMIT"&&!g){N(f),console.log(`[Scalping] LIMIT armed (${f}) — click chart to set limit line`);return}if(d==="LIMIT"&&h&&h.symbol===$&&h.side===s){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),je.error("A LIMIT order is already pending for this symbol");return}if(w){if(console.log(`[Paper] ${f} ${s} ${$} qty=${o*c} @ ${d}`),d==="MARKET"||d==="LIMIT"){const B=await Mt({symbol:$,exchange:a,preferredPrice:d==="LIMIT"?g??void 0:void 0});B>0&&(M(ft({symbol:$,exchange:a,side:s,action:f,entryPrice:B,quantity:o*c,tpPoints:m,slPoints:p,trailDistancePoints:v,managedBy:"manual"})),d==="LIMIT"&&x(null))}y(),k();return}const A=await z();if(!A)return;const Z=d==="LIMIT"?"LIMIT":"MARKET",E={apikey:A,strategy:"Scalping",exchange:a,symbol:$,action:f,quantity:o*c,pricetype:Z,product:l,price:d==="LIMIT"&&g?g:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${f} ${$} qty=${o*c} ${Z}`);const B=await Te.placeOrder(E);if(B.status==="success"){const Q=Kt(B);if(console.log(`[Scalping] Order placed: ${f} ${$} id=${Q??"n/a"}`),N(null),Z==="LIMIT"){g==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),P({symbol:$,side:s,action:f,orderId:Q,quantity:o*c,entryPrice:g??0,tpPoints:m,slPoints:p,trailDistancePoints:v}),g!=null&&x(g);return}if(y(),k(),Z==="MARKET"){const de=await Mt({symbol:$,exchange:a,apiKey:null}),me=await Ut({symbol:$,exchange:a,orderId:Q,preferredPrice:de>0?de:void 0,apiKey:A});me>0&&M(ft({symbol:$,exchange:a,side:s,action:f,entryPrice:me,quantity:o*c,tpPoints:m,slPoints:p,trailDistancePoints:v,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",B),je.error(Ft(B,"Order was rejected"))}catch(B){console.error("[Scalping] Order failed:",B),je.error(Ft(B,"Order placement failed"))}},[$,s,o,c,a,l,d,g,h,m,p,v,w,F,V,z,P,y,k,M,X,x,N]),_=u.useCallback(async()=>{if($){if(w){console.log(`[Paper] Close ${s} ${$}`),F($),x(null),N(null),y();return}try{const f=await Te.closePosition($,a,l);f.status==="success"?(console.log(`[Scalping] Closed ${s} ${$}`),F($),x(null),N(null),y()):(console.error("[Scalping] Close rejected:",f),je.error(Ft(f,"Close position rejected")))}catch(f){console.error("[Scalping] Close failed:",f),je.error(Ft(f,"Close position failed"))}}},[$,s,a,l,w,F,x,N,y]),q=u.useCallback(async()=>{if(w){console.log("[Paper] Close all positions"),D(),x(null),N(null),y();return}const f=Te.cancelAllOrders().catch(A=>(console.warn("[Scalping] Cancel all orders failed:",A),{status:"error",message:Ft(A,"Cancel all orders failed")}));try{const A=await Te.closeAllPositions(),Z=await f;A.status==="success"||A.status==="info"?(Z.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",Z),console.log("[Scalping] Closed all positions"),D(),x(null),N(null),y()):(console.error("[Scalping] Close all rejected:",A),je.error(Ft(A,"Close all rejected")))}catch(A){console.error("[Scalping] Close all failed:",A),je.error(Ft(A,"Close all failed"))}},[w,D,x,N,y]);return n.jsxs("div",{className:"p-3 space-y-4",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),n.jsxs("div",{className:"text-sm font-bold",children:[n.jsx("span",{className:s==="CE"?"text-green-500":"text-red-500",children:s})," ",n.jsx("span",{className:"text-foreground font-mono text-xs",children:$||"No strike selected"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx(Ie,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>W("BUY"),disabled:!$,children:"BUY"}),n.jsx(Ie,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>W("SELL"),disabled:!$,children:"SELL"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs",children:"Lots"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(Ie,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:C,children:"-"}),n.jsx(jt,{type:"number",min:1,value:o,onChange:f=>ne(Number.parseInt(f.target.value)||1),className:"h-7 text-center text-sm w-16"}),n.jsx(Ie,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:R,children:"+"}),n.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*c," qty"]})]})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs",children:"Order Type"}),n.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(f=>n.jsx(Ie,{variant:d===f?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>J(f),children:f},f))})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs",children:"Product"}),n.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(f=>n.jsx(Ie,{variant:l===f?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>ee(f),children:f},f))})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs text-green-500",children:"TP Points"}),n.jsx(jt,{type:"number",min:0,step:5,value:m,onChange:f=>L(Number.parseFloat(f.target.value)||0),className:"h-7 text-sm"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs text-red-500",children:"SL Points"}),n.jsx(jt,{type:"number",min:0,step:5,value:p,onChange:f=>S(Number.parseFloat(f.target.value)||0),className:"h-7 text-sm"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-xs text-amber-400",children:"Trail SL"}),n.jsx(jt,{type:"number",min:0,step:.5,value:v,onChange:f=>O(Number.parseFloat(f.target.value)||0),className:"h-7 text-sm"})]})]}),n.jsxs("div",{className:"border-t pt-3 space-y-2",children:[n.jsxs(Ie,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:_,disabled:!$,children:["Close ",s," Position"]}),n.jsx(Ie,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:q,children:"Close All Positions"})]})]})}const hn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},Ar=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"adaptive-scalper",name:"Adaptive Scalper",description:"Aggressive scalping profile with lighter entry gates and faster re-entry.",config:{entryMomentumCount:3,entryMomentumVelocity:2,entryMinScore:4,entryMaxSpread:6,volumeLookbackTicks:14,indexVolumeMinRatio:1,optionVolumeMinRatio:1,sideVolumeDominanceRatio:1,volumeScoreWeight:1.25,trailInitialSL:10,trailBreakevenTrigger:6,trailLockTrigger:12,trailLockAmount:6,trailStartTrigger:15,trailStepSize:3,trailTightTrigger:24,trailTightStep:2,maxTradesPerDay:40,maxTradesPerMinute:10,minGapMs:1500,cooldownAfterLossSec:15,coolingOffAfterLosses:5,indexBiasEnabled:!0,indexBiasWeight:.2,optionsContextEnabled:!0,pcrBullishThreshold:.5,pcrBearishThreshold:1.6,maxPainProximityFilter:10,gexWallFilterEnabled:!1,ivSpikeExitEnabled:!1,respectHotZones:!1,sensitivityMultiplier:1.25,noTradeZoneEnabled:!1,reEntryEnabled:!0,reEntryDelaySec:8,reEntryMaxPerSide:6}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],ka=["CE","PE"];function Jt(e=0){return ka.reduce((t,s)=>(t[s]=e,t),{})}const Ta=new Set(["1","true","yes","on","enabled"]),Ea=new Set(["0","false","no","off","disabled"]);function Ca(e){if(typeof e=="boolean")return e;if(typeof e=="number")return Number.isFinite(e)?e!==0:null;if(typeof e=="string"){const t=e.trim().toLowerCase();if(Ta.has(t))return!0;if(Ea.has(t))return!1}return null}function Vn(e){if(!e||typeof e!="object")return{};const t=e,s={};for(const r of Object.keys(hn)){if(!(r in t))continue;const i=hn[r],a=t[r];if(typeof i=="boolean"){const o=Ca(a);o!=null&&(s[r]=o);continue}if(typeof i=="number"){const o=typeof a=="number"?a:typeof a=="string"?Number(a):Number.NaN;Number.isFinite(o)&&(s[r]=o)}}return s}const H=sr()(rr(e=>({config:{...hn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Jt(),sideLastExitAt:Jt(),sideLossPnl:Jt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(s=>({config:{...s.config,...Vn(t)}})),applyPreset:t=>{const s=Ar.find(r=>r.id===t);s&&e({config:{...hn,...Vn(s.config)},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(s=>({lockProfitEnabled:t,lockProfitTriggered:t?s.lockProfitTriggered:!1})),updateRiskState:t=>e(s=>{const r=Math.max(s.accountPeakPnl,t),i=Math.max(0,r-t),a=Math.max(s.dailyPeakPnl,t),o=Math.max(0,a-t),c=s.lockProfitEnabled&&a>0?s.lockProfitTriggered||o>=a*.4:s.lockProfitTriggered,l=t<0&&Math.abs(t)>=s.config.maxDailyLoss;return{dailyPeakPnl:a,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:i,lockProfitTriggered:c,killSwitch:s.killSwitch||l}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(s=>{const r=Date.now(),i=r-s.lastMinuteReset>6e4?r:s.lastMinuteReset,a=r-s.lastMinuteReset>6e4?1:s.tradesThisMinute+1,o=s.realizedPnl+t,c=Math.max(s.dailyPeakPnl,o),l=Math.max(0,c-o),d=Math.max(s.autoPeakPnl,o),m=Math.max(0,d-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:s.tradesCount+1,consecutiveLosses:t<0?s.consecutiveLosses+1:s.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:s.lastLossTime,dailyPeakPnl:c,dailyDrawdown:l,autoPeakPnl:d,autoDrawdown:m}}),recordTradeOutcome:t=>e(s=>{const r=Date.now(),i=s.realizedPnl+t,a=Math.max(s.dailyPeakPnl,i),o=Math.max(0,a-i),c=Math.max(s.autoPeakPnl,i),l=Math.max(0,c-i),d=s.lockProfitEnabled&&a>0?s.lockProfitTriggered||o>=a*.4:s.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?s.consecutiveLosses+1:0,lastLossTime:t<0?r:s.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,autoPeakPnl:c,autoDrawdown:l,lockProfitTriggered:d,killSwitch:s.killSwitch}}),recordAutoEntry:t=>e(s=>({sideEntryCount:{...s.sideEntryCount,[t]:s.sideEntryCount[t]+1}})),recordAutoExit:(t,s)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:s<0?r.sideLossPnl[t]+Math.abs(s):r.sideLossPnl[t]}})),pushDecision:t=>e(s=>({decisionHistory:[...s.decisionHistory.slice(-119),t],lastDecisionBySide:{...s.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(s=>({executionSamples:[...s.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(s=>({ghostSignals:[...s.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Jt(),sideLastExitAt:Jt(),sideLossPnl:Jt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const s=e??{};return{...t,...s,config:{...hn,...Vn(s.config??{})},activePresetId:s.activePresetId??t.activePresetId}}})),La=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Ma=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function Hn(e){const[t,s]=e.split(":").map(Number);return t*60+s}function is(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return{hours:s.getUTCHours(),minutes:s.getUTCMinutes()}}function $r(e){return e?Ma:La}function Yn(e=new Date,t=!1){const{hours:s,minutes:r}=is(e),i=s*60+r,a=$r(t);for(const o of a){const c=Hn(o.start),l=Hn(o.end);if(i>=c&&i<l)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function _s(e=new Date,t=!1){const{hours:s,minutes:r}=is(e),i=s*60+r,a=$r(t);for(const o of a){const c=Hn(o.start);if(c>i)return{nextZone:o,minutesUntil:c-i}}return{nextZone:null,minutesUntil:0}}function Bs(e,t=new Date){if(!e)return!1;try{const s=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return s.getFullYear()===i.getUTCFullYear()&&s.getMonth()===i.getUTCMonth()&&s.getDate()===i.getUTCDate()}catch{return!1}}function Vs(e=new Date){const{hours:t,minutes:s}=is(e),r=t*60+s;return r>=555&&r<930}function qs(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return`${s.getUTCHours().toString().padStart(2,"0")}:${s.getUTCMinutes().toString().padStart(2,"0")}:${s.getUTCSeconds().toString().padStart(2,"0")}`}function Dr(){const e=b(r=>r.expiry),[t,s]=u.useState(()=>{const r=new Date,i=Bs(e,r),{zone:a,sensitivity:o}=Yn(r,i),{nextZone:c,minutesUntil:l}=_s(r,i);return{currentTime:qs(r),currentZone:a,sensitivity:o,nextZone:c,minutesToNext:l,isExpiryDay:i,isOpen:Vs(r)}});return u.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Bs(e,a),{zone:c,sensitivity:l}=Yn(a,o),{nextZone:d,minutesUntil:m}=_s(a,o);s({currentTime:qs(a),currentZone:c,sensitivity:l,nextZone:d,minutesToNext:m,isExpiryDay:o,isOpen:Vs(a)})},1e3);return()=>clearInterval(i)},[e]),t}function Ra(){const e=H(r=>r.activePresetId),t=H(r=>r.applyPreset),{isExpiryDay:s}=Dr();return n.jsx("div",{className:"space-y-1.5",children:Ar.map(r=>{const i=e===r.id,a=r.id==="expiry";return n.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-xs font-medium",children:r.name}),n.jsxs("div",{className:"flex items-center gap-1",children:[a&&s&&n.jsx(Fe,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&n.jsx(Fe,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function ye({label:e,field:t,step:s}){const r=H(a=>a.config[t]),i=H(a=>a.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(at,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),n.jsx(jt,{type:"number",value:r,step:s??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function ut({label:e,field:t}){const s=H(i=>i.config[t]),r=H(i=>i.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(at,{className:"text-[10px] text-muted-foreground",children:e}),n.jsx(pn,{checked:s===!0,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function it({title:e,children:t}){return n.jsxs("details",{className:"group",children:[n.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),n.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function Ia(){return n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs(it,{title:"Entry Conditions",children:[n.jsx(ye,{label:"Momentum Count",field:"entryMomentumCount"}),n.jsx(ye,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),n.jsx(ye,{label:"Min Score",field:"entryMinScore"}),n.jsx(ye,{label:"Max Spread",field:"entryMaxSpread"})]}),n.jsxs(it,{title:"Volume Flow",children:[n.jsx(ut,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),n.jsx(ye,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),n.jsx(ye,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),n.jsx(ye,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),n.jsx(ye,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),n.jsx(ye,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),n.jsxs(it,{title:"Trailing SL (5-Stage)",children:[n.jsx(ye,{label:"Initial SL (pts)",field:"trailInitialSL"}),n.jsx(ye,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),n.jsx(ye,{label:"Lock Trigger",field:"trailLockTrigger"}),n.jsx(ye,{label:"Lock Amount",field:"trailLockAmount"}),n.jsx(ye,{label:"Trail Start",field:"trailStartTrigger"}),n.jsx(ye,{label:"Trail Step",field:"trailStepSize"}),n.jsx(ye,{label:"Tight Trigger",field:"trailTightTrigger"}),n.jsx(ye,{label:"Tight Step",field:"trailTightStep"})]}),n.jsxs(it,{title:"Breakeven",children:[n.jsx(ye,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),n.jsx(ye,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),n.jsxs(it,{title:"Risk",children:[n.jsx(ye,{label:"Max Daily Loss",field:"maxDailyLoss"}),n.jsx(ye,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),n.jsx(ye,{label:"Max Trades/Day",field:"maxTradesPerDay"}),n.jsx(ye,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),n.jsx(ye,{label:"Min Gap (ms)",field:"minGapMs",step:500}),n.jsx(ye,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),n.jsx(ye,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),n.jsx(ye,{label:"Max Position Size",field:"maxPositionSize"})]}),n.jsxs(it,{title:"Imbalance Filter",children:[n.jsx(ut,{label:"Enabled",field:"imbalanceFilterEnabled"}),n.jsx(ye,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),n.jsxs(it,{title:"Regime Detection",children:[n.jsx(ye,{label:"Detection Period",field:"regimeDetectionPeriod"}),n.jsx(ye,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),n.jsxs(it,{title:"Index Bias",children:[n.jsx(ut,{label:"Enabled",field:"indexBiasEnabled"}),n.jsx(ye,{label:"Weight",field:"indexBiasWeight",step:.1})]}),n.jsxs(it,{title:"Options Context",children:[n.jsx(ut,{label:"Enabled",field:"optionsContextEnabled"}),n.jsx(ye,{label:"PCR Bullish ≤",field:"pcrBullishThreshold",step:.1}),n.jsx(ye,{label:"PCR Bearish ≥",field:"pcrBearishThreshold",step:.1}),n.jsx(ye,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),n.jsx(ut,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),n.jsx(ut,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),n.jsx(ye,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),n.jsxs(it,{title:"Time-of-Day",children:[n.jsx(ut,{label:"Respect Hot Zones",field:"respectHotZones"}),n.jsx(ye,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),n.jsxs(it,{title:"No-Trade Zone",children:[n.jsx(ut,{label:"Enabled",field:"noTradeZoneEnabled"}),n.jsx(ye,{label:"Range (pts)",field:"noTradeZoneRangePts"}),n.jsx(ye,{label:"Period",field:"noTradeZonePeriod"})]}),n.jsxs(it,{title:"Re-Entry",children:[n.jsx(ut,{label:"Enabled",field:"reEntryEnabled"}),n.jsx(ye,{label:"Delay (sec)",field:"reEntryDelaySec"}),n.jsx(ye,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),n.jsxs(it,{title:"Telegram Alerts",children:[n.jsx(ut,{label:"Entry Alerts",field:"telegramAlertsEntry"}),n.jsx(ut,{label:"Exit Alerts",field:"telegramAlertsExit"}),n.jsx(ut,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Aa(){const e=H(r=>r.ghostSignals),t=H(r=>r.clearGhostSignals);if(e.length===0)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const s=e.slice(-10).reverse();return n.jsxs("div",{className:"space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),s.map(r=>n.jsx($a,{signal:r},r.id))]})}function $a({signal:e}){const t=Ae(p=>p.apiKey),s=b(p=>p.optionExchange),r=b(p=>p.quantity),i=b(p=>p.lotSize),a=b(p=>p.product),o=b(p=>p.paperMode),c=b(p=>p.incrementTradeCount),l=u.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),c();return}if(!t)return;const p={apikey:t,strategy:"Scalping-Ghost",exchange:s,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const v=await Te.placeOrder(p);v.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${v.data?.orderid}`),c())}catch(v){console.error("[Ghost Take] Failed:",v)}},[e,t,s,r,i,a,o,c]),d=Math.round((Date.now()-e.timestamp)/1e3),m=d<60?`${d}s ago`:`${Math.round(d/60)}m ago`;return n.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(Fe,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),n.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"text-[9px] text-muted-foreground",children:m}),n.jsxs(Fe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&n.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&n.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),n.jsx(Ie,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:l,children:"Take Trade"})]})]})}function Da(){const e=H(r=>r.optionsContext);if(!e)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),s=t<60?`${t}s`:`${Math.round(t/60)}m`;return n.jsxs("div",{className:"space-y-1.5 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),n.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",s," ago"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PCR"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[n.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),n.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),n.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),n.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",n.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),n.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),n.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),n.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),n.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),n.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),n.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&n.jsxs("div",{children:[n.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),n.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>n.jsx(Fe,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const as={getBotStatus:async()=>(await pt.get("/telegram/bot/status")).data.data,startBot:async()=>(await pt.post("/telegram/bot/start")).data,stopBot:async()=>(await pt.post("/telegram/bot/stop")).data,getConfig:async()=>(await pt.get("/telegram/api/config")).data.data,updateConfig:async e=>(await pt.post("/telegram/config",e)).data,getUsers:async()=>(await pt.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await pt.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await pt.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await pt.post("/telegram/test-message")).data,sendBroadcast:async e=>(await pt.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await pt.post("/telegram/send-message",{telegram_id:e,message:t})).data};function Oa(){const[e,t]=u.useState(!1),[s,r]=u.useState(null),[i,a]=u.useState(null),[o,c]=u.useState(null),l=H(h=>h.updateConfig),d=H(h=>h.config),m=b(h=>h.underlying),p=u.useCallback(async()=>{try{const h=await Kr();r(h.provider||"none"),h.last_run&&a(h.last_run),c(null)}catch{c("Could not reach advisor")}},[]),v=u.useCallback(async()=>{t(!0),c(null);try{const h=await Gr({underlying:m});if(h.status==="success"&&h.run_id){const x=await Ur(1);x.runs?.length>0&&a(x.runs[0])}else c(h.message||"Tuning failed")}catch{c("Advisor request failed")}finally{t(!1)}},[m]),g=u.useCallback(async()=>{if(i?.run_id){t(!0);try{await Wr(i.run_id);const h=i.recommendations;if(h&&typeof h=="object"){const x={};for(const[N,P]of Object.entries(h)){if(!(N in d))continue;const y=N,w=d[y];if(typeof w=="number"){const M=typeof P=="number"?P:Number(P);Number.isFinite(M)&&(x[y]=M);continue}if(typeof w=="boolean"){let M=null;if(typeof P=="boolean")M=P;else if(typeof P=="number")M=P!==0;else if(typeof P=="string"){const F=P.trim().toLowerCase();["true","1","yes","on","enabled"].includes(F)&&(M=!0),["false","0","no","off","disabled"].includes(F)&&(M=!1)}M!=null&&(x[y]=M)}}if(Object.keys(x).length>0&&(l(x),d.telegramAlertsTune)){const N=Object.keys(x).join(", ");as.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${m}: ${N}`}).catch(()=>{})}}a(x=>x&&{...x,applied:!0}),c(null)}catch{c("Failed to apply recommendation")}finally{t(!1)}}},[i,l,d,m]);return n.jsxs("div",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),s&&n.jsx(Fe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:s})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(Ie,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:p,disabled:e,children:"Check Status"}),n.jsx(Ie,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:v,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&n.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&n.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Score"}),n.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??"—"})]}),i.notes&&n.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&n.jsxs("div",{className:"space-y-0.5",children:[n.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([h,x])=>n.jsxs("div",{className:"flex justify-between pl-1",children:[n.jsx("span",{className:"text-muted-foreground",children:h}),n.jsx("span",{className:"font-mono",children:typeof x=="number"?x:String(x)})]},h))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&n.jsx(Ie,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:g,disabled:e,children:"Apply Recommendation"}),i.applied&&n.jsx(Fe,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function Fa(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function za(){const e=H(f=>f.enabled),t=H(f=>f.mode),s=H(f=>f.replayMode),r=H(f=>f.regime),i=H(f=>f.tradesCount),a=H(f=>f.realizedPnl),o=H(f=>f.consecutiveLosses),c=H(f=>f.killSwitch),l=H(f=>f.lockProfitEnabled),d=H(f=>f.lockProfitTriggered),m=H(f=>f.accountPeakPnl),p=H(f=>f.accountDrawdown),v=H(f=>f.autoPeakPnl),g=H(f=>f.autoDrawdown),h=H(f=>f.sideEntryCount),x=H(f=>f.sideLastExitAt),N=H(f=>f.sideLossPnl),P=H(f=>f.lastDecisionBySide),y=H(f=>f.decisionHistory),w=H(f=>f.executionSamples),M=H(f=>f.config),F=H(f=>f.setEnabled),D=H(f=>f.setMode),V=H(f=>f.setReplayMode),X=H(f=>f.setKillSwitch),ne=H(f=>f.setLockProfitEnabled),R=H(f=>f.resetRuntime),C=b(f=>f.activeSide),J=b(f=>f.paperMode),ee=ue(f=>f.virtualTPSL),L=u.useMemo(()=>P[C]??y[y.length-1]??null,[C,y,P]),S=u.useMemo(()=>L?Math.max(0,Math.min(99,Math.round(L.score/Math.max(1,L.minScore)*100))):r==="UNKNOWN"?0:55,[L,r]),O=u.useMemo(()=>Object.values(ee).reduce((f,A)=>(f[A.side]+=A.quantity,f),{CE:0,PE:0}),[ee]),k=u.useMemo(()=>Object.values(ee).reduce((f,A)=>(A.managedBy!=="auto"||(f[A.side]+=A.quantity),f),{CE:0,PE:0}),[ee]),$=u.useMemo(()=>{const f=w.slice(-10),A=f.filter(de=>de.status==="filled"),Z=f.filter(de=>de.status==="rejected"),E=A.length>0?A.reduce((de,me)=>de+me.spread,0)/A.length:0,B=A.length>0?A.reduce((de,me)=>de+me.expectedSlippage,0)/A.length:0,Q=f.length>0?Z.length/f.length*100:0;return{recent:f.slice().reverse(),avgSpread:E,avgSlippage:B,rejectRate:Q}},[w]),z=L?L.spread<=M.entryMaxSpread*.4?"TIGHT":L.spread<=M.entryMaxSpread?"NORMAL":"WIDE":"NA",W=x[C]>0?Math.max(0,Math.round((Date.now()-x[C])/1e3)):null,_=e&&t==="execute"&&s,q=f=>f<=0?"0":`-${f.toFixed(0)}`;return n.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(at,{className:"text-xs font-medium",children:"Auto-Trade"}),n.jsx(pn,{checked:e,onCheckedChange:F,className:"h-5 w-9"})]}),n.jsx(Fe,{variant:e?t==="execute"&&!s?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?_?"SIM (REPLAY)":t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(Ie,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>D("ghost"),children:"Ghost (Signals Only)"}),n.jsx(Ie,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>D("execute"),children:"Execute (Live)"})]}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),n.jsx(pn,{checked:s,onCheckedChange:V,className:"h-4 w-8"})]}),n.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),_&&n.jsx("div",{className:"p-1 bg-amber-500/10 border border-amber-500/30 rounded text-amber-400 text-[10px] text-center font-medium",children:"EXECUTE BLOCKED - Replay/Simulator is ON"}),t==="execute"&&!J&&!s&&n.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Regime"}),n.jsx(Fe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),n.jsx("span",{className:"font-bold",children:i})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),n.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:R,children:"Reset Runtime"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),L?n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-muted-foreground",children:[L.side," ",L.symbol.slice(-12)]}),n.jsxs("span",{className:`font-bold ${L.enter?"text-green-500":"text-red-500"}`,children:[L.score.toFixed(1)," / ",L.minScore.toFixed(1)]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:L.reason}),n.jsx("div",{className:"space-y-0.5",children:L.checks.slice(0,8).map(f=>n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] text-muted-foreground",children:f.label}),n.jsxs("span",{className:`text-[10px] font-medium ${f.pass?"text-green-500":"text-red-500"}`,children:[f.pass?"PASS":"FAIL",f.value?` (${f.value})`:""]})]},f.id))})]}):n.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),n.jsx("span",{className:"font-medium",children:Fa(r)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),n.jsxs("span",{className:"font-bold",children:[S,"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),n.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:L&&!L.enter?L.reason:"None"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",C,")"]}),n.jsx("span",{className:"font-mono text-[10px]",children:W==null?"—":`${W}s ago`})]})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),n.jsx("span",{className:`font-medium ${z==="WIDE"?"text-red-500":z==="TIGHT"?"text-green-500":""}`,children:z})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Execution Gate"}),n.jsx("span",{className:`font-medium ${_?"text-amber-400":t==="execute"?"text-green-500":"text-muted-foreground"}`,children:_?"BLOCKED (Replay)":t==="execute"?"OPEN":"Ghost Mode"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),n.jsx("span",{className:"font-mono",children:(L?.expectedSlippage??0).toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),n.jsx("span",{className:"font-mono",children:L?.depthRatio!=null?L.depthRatio.toFixed(2):"NA"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),n.jsx("span",{className:"font-mono",children:$.avgSpread.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),n.jsx("span",{className:"font-mono",children:$.avgSlippage.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),n.jsxs("span",{className:`font-mono ${$.rejectRate>30?"text-red-500":""}`,children:[$.rejectRate.toFixed(0),"%"]})]}),n.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[$.recent.slice(0,5).map(f=>n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[f.side," ",f.symbol.slice(-10)]}),n.jsx("span",{className:f.status==="rejected"?"text-red-500":f.status==="filled"?"text-green-500":"text-muted-foreground",children:f.status})]},`${f.timestamp}-${f.symbol}`)),$.recent.length===0&&n.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[c&&n.jsx(Fe,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),n.jsx(pn,{checked:c,onCheckedChange:X,className:"h-4 w-8"})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[d&&n.jsx(Fe,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),n.jsx(pn,{checked:l,onCheckedChange:ne,className:"h-4 w-8"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),n.jsx("span",{className:"font-mono",children:m.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),n.jsx("span",{className:`font-mono ${p>0?"text-red-500":""}`,children:p.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),n.jsx("span",{className:"font-mono",children:v.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),n.jsx("span",{className:`font-mono ${g>0?"text-red-500":""}`,children:g.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),n.jsx("span",{className:"font-mono",children:O.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),n.jsx("span",{className:"font-mono",children:O.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),n.jsx("span",{className:"font-mono",children:k.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),n.jsx("span",{className:"font-mono",children:k.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),n.jsx("span",{className:"font-mono",children:h.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),n.jsx("span",{className:"font-mono",children:h.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),n.jsx("span",{className:`font-mono ${N.CE>0?"text-red-500":""}`,children:q(N.CE)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),n.jsx("span",{className:`font-mono ${N.PE>0?"text-red-500":""}`,children:q(N.PE)})]})]})]})]}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Da,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Aa,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Oa,{})}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),n.jsx(Ra,{})]}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),n.jsx(Ia,{})]})]})}function _a(){const e=Ae(p=>p.apiKey),t=b(p=>p.optionExchange),s=ue(p=>p.virtualTPSL),r=ue(p=>p.triggerOrders),i=ue(p=>p.removeVirtualTPSL),a=ue(p=>p.removeTriggerOrder),o=ue(p=>p.clearAll),{data:c}=ir({queryKey:["scalping-orders",t],queryFn:()=>Te.getOrders(e),enabled:!!e,refetchInterval:5e3}),l=(c?.data?.orders??[]).filter(p=>p.exchange===t&&(p.order_status==="open"||p.order_status==="pending"||p.order_status==="trigger pending")),d=Object.values(s),m=Object.values(r);return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),n.jsx(Fe,{variant:"outline",className:"text-[10px] h-4",children:l.length})]}),l.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):n.jsx("div",{className:"space-y-1",children:l.map(p=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:p.action==="BUY"?"text-green-500":"text-red-500",children:p.action})," ",n.jsx("span",{className:"font-mono",children:p.symbol.slice(-10)})," ",n.jsxs("span",{className:"text-muted-foreground",children:["x",p.quantity]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(Fe,{variant:"outline",className:"text-[10px] h-4",children:p.order_status}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await Te.cancelOrder(p.orderid)}catch(v){console.error("Cancel failed:",v)}},children:"Cancel"})]})]},p.orderid))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),n.jsx(Fe,{variant:"outline",className:"text-[10px] h-4",children:d.length})]}),d.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):n.jsx("div",{className:"space-y-1",children:d.map(p=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:p.side==="CE"?"text-green-500":"text-red-500",children:p.side})," ",n.jsx("span",{className:"font-mono",children:p.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",p.entryPrice.toFixed(1)," |"," ",p.tpPrice!==null&&n.jsxs("span",{className:"text-green-500",children:["TP: ",p.tpPrice.toFixed(1)]})," ",p.slPrice!==null&&n.jsxs("span",{className:"text-red-500",children:["SL: ",p.slPrice.toFixed(1)]})]})]}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(p.id),children:"Remove"})]},p.id))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),n.jsx(Fe,{variant:"outline",className:"text-[10px] h-4",children:m.length})]}),m.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):n.jsx("div",{className:"space-y-1",children:m.map(p=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:p.action==="BUY"?"text-green-500":"text-red-500",children:p.action})," ",n.jsx("span",{className:"font-mono",children:p.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",p.triggerPrice.toFixed(1)," (",p.direction,") | x",p.quantity]})]}),n.jsx(Ie,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(p.id),children:"Remove"})]},p.id))})]}),(d.length>0||m.length>0)&&n.jsx(Ie,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function Ba(e,t){const s=Ae(m=>m.apiKey),[r,i]=u.useState(null),[a,o]=u.useState(!1),c=u.useRef(null),l=u.useCallback(async()=>{if(!(!e||!s)){try{const m=await Te.getDepth(s,e,t);m.status==="success"&&m.data&&i(m.data)}catch{}o(!1)}},[e,t,s]);u.useEffect(()=>{if(!e){i(null);return}return o(!0),l(),c.current=setInterval(l,2e3),()=>{c.current&&clearInterval(c.current)}},[e,l]);const d=r?Va(r):null;return{depth:r,analytics:d,levels:5,isLoading:a}}function Va(e){const t=e.bids||[],s=e.asks||[],r=t.reduce((g,h)=>g+h.quantity,0),i=s.reduce((g,h)=>g+h.quantity,0),a=i>0?r/i:r>0?999:1,o=s.length>0&&t.length>0?s[0].price-t[0].price:0,c=t.length>0?t.reduce((g,h)=>h.quantity>g.quantity?h:g,t[0]):null,l=c?{price:c.price,qty:c.quantity}:null,d=s.length>0?s.reduce((g,h)=>h.quantity>g.quantity?h:g,s[0]):null,m=d?{price:d.price,qty:d.quantity}:null,p=r+i,v=p>0?(r-i)/p*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:l,largestAskWall:m,imbalanceScore:v}}function qa(){const e=b(c=>c.activeSide),t=b(c=>c.optionExchange),s=b(c=>c.activeSide==="CE"?c.selectedCESymbol:c.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=Ba(s,t);return s?n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),n.jsx("span",{className:"font-mono text-muted-foreground",children:s.slice(-10)})]}),n.jsxs(Fe,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[n.jsx("span",{className:"text-right",children:"Bid Qty"}),n.jsx("span",{className:"text-center",children:"Bid"}),n.jsx("span",{className:"text-center",children:"Ask"}),n.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((c,l)=>{const d=r.bids?.[l],m=r.asks?.[l],p=Math.max(...r.bids?.map(v=>v.quantity)??[0],...r.asks?.map(v=>v.quantity)??[0]);return n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[n.jsx("div",{className:"flex items-center justify-end",children:n.jsx("div",{className:"relative h-4 w-full",children:d&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${p>0?d.quantity/p*100:0}%`}}),n.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:d.quantity.toLocaleString()})]})})}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:d?.price.toFixed(2)??"--"}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:m?.price.toFixed(2)??"--"}),n.jsx("div",{className:"flex items-center",children:n.jsx("div",{className:"relative h-4 w-full",children:m&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${p>0?m.quantity/p*100:0}%`}}),n.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:m.quantity.toLocaleString()})]})})})]},l)})]}),i&&n.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),n.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Spread"}),n.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),n.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),n.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),n.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),n.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),n.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[n.jsxs("span",{children:["LTP: ",n.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),n.jsxs("span",{children:["Vol: ",n.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),n.jsxs("span",{children:["OI: ",n.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):n.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:n.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Ks=500;function Ka(){const e=u.useRef([]),t=u.useCallback(c=>{const l={...c,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(l),e.current.length>Ks&&(e.current=e.current.slice(-Ks)),l},[]),s=u.useCallback(()=>[...e.current],[]),r=u.useCallback(c=>e.current.slice(-c),[]),i=u.useCallback(()=>{e.current=[]},[]),a=u.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=u.useCallback(()=>{const c=e.current;if(c.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const l=c.filter(v=>v.pnl!==void 0),d=l.filter(v=>(v.pnl??0)>0),m=l.reduce((v,g)=>v+(g.pnl??0),0),p=l.map(v=>v.pnl??0);return{count:c.length,winRate:l.length>0?d.length/l.length*100:0,avgPnl:l.length>0?m/l.length:0,totalPnl:m,bestTrade:p.length>0?Math.max(...p):0,worstTrade:p.length>0?Math.min(...p):0}},[]);return{logTrade:t,getTrades:s,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function Ga({liveOpenPnl:e,isLivePnl:t=!1}){const s=b(y=>y.sessionPnl),r=b(y=>y.tradeCount),i=b(y=>y.paperMode),a=i?s:e??s,o=Dr(),{getStats:c}=Ka(),l=c(),[d,m]=u.useState(5e3),[p,v]=u.useState(500),[g,h]=u.useState(50),[x,N]=u.useState(3),P=a<0&&Math.abs(a)>=d;return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),n.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Status"}),n.jsx(Fe,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Zone"}),n.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),n.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),n.jsxs("span",{children:[o.nextZone.label," ",n.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&n.jsx(Fe,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-2",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),P&&n.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-[10px]",children:"Daily Loss Limit"}),n.jsx(jt,{type:"number",value:d,onChange:y=>m(Number(y.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),n.jsx(jt,{type:"number",value:p,onChange:y=>v(Number(y.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-[10px]",children:"Profit Protection (%)"}),n.jsx(jt,{type:"number",value:g,onChange:y=>h(Number(y.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(at,{className:"text-[10px]",children:"Cooling Off After N Losses"}),n.jsx(jt,{type:"number",value:x,onChange:y=>N(Number(y.target.value)||0),className:"h-6 text-xs"})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),n.jsx("span",{className:"font-bold",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),l.count>0&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),n.jsxs("span",{className:"font-bold",children:[l.winRate.toFixed(0),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${l.avgPnl>0?"text-green-500":l.avgPnl<0?"text-red-500":""}`,children:[l.avgPnl>=0?"+":"",l.avgPnl.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),n.jsxs("span",{children:[n.jsxs("span",{className:"text-green-500",children:["+",l.bestTrade.toFixed(0)]})," / ",n.jsx("span",{className:"text-red-500",children:l.worstTrade.toFixed(0)})]})]})]})]})]})}const Ua=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function Wa({liveOpenPnl:e,isLivePnl:t=!1}){const s=b(i=>i.controlTab),r=b(i=>i.setControlTab);return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:Ua.map(i=>n.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${s===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),n.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[s==="manual"&&n.jsx(wa,{}),s==="auto"&&n.jsx(za,{}),s==="risk"&&n.jsx(Ga,{liveOpenPnl:e,isLivePnl:t}),s==="depth"&&n.jsx(qa,{}),s==="orders"&&n.jsx(_a,{})]})]})}const Ha=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE ↔ PE)"},{key:"↑",description:"CE direct market buy (with virtual TP/SL)"},{key:"↓",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function Ya({open:e,onClose:t}){return u.useEffect(()=>{if(!e)return;const s=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[e,t]),e?n.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:n.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:s=>s.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),n.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),n.jsx("div",{className:"space-y-1",children:Ha.map(({key:s,description:r})=>n.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[n.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:s}),n.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},s))}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function Gs(e,t){if(e&&typeof e=="object"){const s=e.response?.data;if(s&&typeof s=="object"){const i=s.message;if(typeof i=="string"&&i.trim().length>0)return i.trim();const a=s.error;if(typeof a=="string"&&a.trim().length>0)return a.trim()}else if(typeof s=="string"&&s.trim().length>0)return s.trim();const r=e.message;if(typeof r=="string"&&r.trim().length>0)return r.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function Za(e={}){const t=b(k=>k.hotkeysEnabled),s=b(k=>k.activeSide),r=b(k=>k.selectedCESymbol),i=b(k=>k.selectedPESymbol),a=b(k=>k.optionExchange),o=b(k=>k.quantity),c=b(k=>k.lotSize),l=b(k=>k.product),d=b(k=>k.orderType),m=b(k=>k.limitPrice),p=b(k=>k.pendingLimitPlacement),v=b(k=>k.setLimitPrice),g=b(k=>k.setPendingLimitPlacement),h=b(k=>k.clearPendingLimitPlacement),x=b(k=>k.tpPoints),N=b(k=>k.slPoints),P=b(k=>k.trailDistancePoints),y=b(k=>k.setPendingEntryAction),w=b(k=>k.paperMode),M=ue(k=>k.setVirtualTPSL),F=ue(k=>k.triggerOrders),D=ue(k=>k.removeTriggerOrder),V=b(k=>k.setActiveSide),X=b(k=>k.toggleActiveSide),ne=b(k=>k.toggleFloatingWidget),R=b(k=>k.setQuantity),C=Ae(k=>k.apiKey),J=Ae(k=>k.setApiKey),ee=u.useCallback(()=>s==="CE"?r:i,[s,r,i]),L=u.useCallback(k=>k==="CE"?r:i,[r,i]),S=u.useCallback(async()=>{if(C)return C;try{const $=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if($.status==="success"&&$.api_key)return J($.api_key),$.api_key}catch(k){console.error("[Scalping] Failed to fetch API key:",k),je.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),je.error("API key missing. Generate one on /apikey"),null},[C,J]),O=u.useCallback(async(k,$,z=!1)=>{const W=$??s,_=L(W),q=z?"MARKET":d;if(!_){console.warn("[Scalping] No symbol selected — click a strike first"),je.error("Select a strike first");return}if(q==="TRIGGER"){const E=Object.values(F).find(B=>B.symbol===_&&B.exchange===a&&B.side===W);E&&D(E.id),h(),v(null),y(k),console.log(`[Scalping] TRIGGER armed (${k}) — click chart to place trigger line`);return}if(q==="LIMIT"&&!m){y(k),console.log(`[Scalping] LIMIT armed (${k}) — click chart to set limit line`);return}if(q==="LIMIT"&&p&&p.symbol===_&&p.side===W){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),je.error("A LIMIT order is already pending for this symbol");return}if(w){if(console.log(`[Paper] ${k} ${W} ${_} qty=${o*c} @ ${q}`),q==="MARKET"||q==="LIMIT"){const E=await Mt({symbol:_,exchange:a,preferredPrice:q==="LIMIT"?m??void 0:void 0});E>0&&(M(ft({symbol:_,exchange:a,side:W,action:k,entryPrice:E,quantity:o*c,tpPoints:x,slPoints:N,trailDistancePoints:P,managedBy:"hotkey"})),q==="LIMIT"&&v(null))}h();return}const f=await S();if(!f)return;const A=q==="LIMIT"?"LIMIT":"MARKET",Z={apikey:f,strategy:"Scalping",exchange:a,symbol:_,action:k,quantity:o*c,pricetype:A,product:l,price:q==="LIMIT"&&m?m:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${k} ${_} qty=${o*c} ${A}`);const E=await Te.placeOrder(Z);if(E.status==="success"){const B=Kt(E);if(console.log(`[Scalping] Order placed: ${k} ${_} id=${B??"n/a"}`),y(null),A==="LIMIT"){m==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),g({symbol:_,side:W,action:k,orderId:B,quantity:o*c,entryPrice:m??0,tpPoints:x,slPoints:N,trailDistancePoints:P}),m!=null&&v(m);return}if(h(),A==="MARKET"){const Q=await Mt({symbol:_,exchange:a,apiKey:null}),de=await Ut({symbol:_,exchange:a,orderId:B,preferredPrice:Q>0?Q:void 0,apiKey:f});de>0&&M(ft({symbol:_,exchange:a,side:W,action:k,entryPrice:de,quantity:o*c,tpPoints:x,slPoints:N,trailDistancePoints:P,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",E),je.error(Gs(E,"Order was rejected"))}catch(E){console.error("[Scalping] Order failed:",E),je.error(Gs(E,"Order placement failed"))}},[L,s,o,c,a,l,d,m,p,x,N,P,w,F,S,g,h,M,D,v,y]);u.useEffect(()=>{if(!t)return;const k=$=>{const z=$.target?.tagName;if(z==="INPUT"||z==="TEXTAREA"||z==="SELECT")return;const W=ee();switch($.key.toLowerCase()){case"b":{$.preventDefault(),W&&(O("BUY"),e.onBuy?.(s,W));break}case"s":{$.preventDefault(),W&&(O("SELL"),e.onSell?.(s,W));break}case"c":{$.preventDefault(),W&&e.onClose?.(s,W);break}case"x":{$.preventDefault(),e.onCloseAll?.();break}case"r":{$.preventDefault(),W&&e.onReversal?.(s,W);break}case"w":{$.preventDefault(),ne();break}case"tab":{$.preventDefault(),X();break}case"1":{$.preventDefault(),R(1);break}case"2":{$.preventDefault(),R(2);break}case"3":{$.preventDefault(),R(3);break}case"?":{$.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{$.preventDefault(),r&&(V("CE"),O("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{$.preventDefault(),i&&(V("PE"),O("BUY","PE",!0),e.onBuy?.("PE",i));break}}};return window.addEventListener("keydown",k),()=>window.removeEventListener("keydown",k)},[t,s,ee,O,X,V,ne,R,r,i,e])}const Xa=300,Us=2e3,Ws=15,Hs=8e3,Ys=15e3;function nt(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const s=Number(e);return Number.isFinite(s)?s:t}return t}function $n(e,t){if(!e||typeof e!="object")return null;const s=e[t],r=nt(s,Number.NaN);return Number.isFinite(r)?r:null}function Qa(e,t,s){if(!e.length)return null;const r=e.find(c=>c.strike===t);if(r)return r;const i=Number.isFinite(s)&&s>0?s:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let c=1;c<e.length;c++){const l=Math.abs(e[c].strike-i);l<o&&(a=e[c],o=l)}return a}function Ja(e){return nt(e.ce?.oi,0)+nt(e.pe?.oi,0)}function eo(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(nt($n(t,"net_gex"),0))||Ja(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,s)=>s.score-t.score).slice(0,5).map(t=>t.strike)}function to(e,t){if(!e.length)return t;let s=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const c of e){const l=c.strike,d=nt(c.ce?.oi,0),m=nt(c.pe?.oi,0);a>l?o+=(a-l)*d:a<l&&(o+=(l-a)*m)}o<r&&(r=o,s=a)}return s}function no(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}function Zs(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!no(e.topGammaStrikes,t.topGammaStrikes)}function Xs(e,t){const s=$n(e,"iv");return s!=null&&s>0?s:t}function so(e){return e.replace(/-/g,"").toUpperCase()}function Qs(e,t,s){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=nt(e.underlying_ltp,0),a=nt(e.atm_strike,0),o=Qa(r,a,i),c=r.reduce((D,V)=>(D.ceOi+=nt(V.ce?.oi,0),D.peOi+=nt(V.pe?.oi,0),D.ceVol+=nt(V.ce?.volume,0),D.peVol+=nt(V.pe?.volume,0),D),{ceOi:0,peOi:0,ceVol:0,peVol:0}),l=c.ceOi>0?c.peOi/c.ceOi:1,d=to(r,o?.strike??a),m=i-d,p=eo(r),v=$n(e,"total_net_gex"),g=v??0,h=t?.ceIV??Ws,x=t?.peIV??Ws,N=Xs(o?.ce,h),P=Xs(o?.pe,x),y=(N+P)/2,w=N-P,M=$n(e,"iv_percentile")??t?.ivPercentile??50,F=nt(o?.ce?.ltp,0)+nt(o?.pe?.ltp,0);return{pcr:l,oiChangeCE:c.ceOi,oiChangePE:c.peOi,maxPainStrike:d,spotVsMaxPain:m,topGammaStrikes:p,gexFlipZones:[],netGEX:g,atmIV:y,ivPercentile:M,ceIV:N,peIV:P,ivSkew:w,straddlePrice:F,lastUpdated:s>0?s:Date.now()}}function ro(){const e=Ae(x=>x.apiKey),t=b(x=>x.underlying),s=b(x=>x.expiry),r=b(x=>x.indexExchange),i=b(x=>x.chainStrikeCount),a=b(x=>x.optionChainData),o=b(x=>x.optionChainLastUpdate),c=b(x=>x.optionChainIsStreaming),l=H(x=>x.optionsContext),d=H(x=>x.setOptionsContext),m=u.useRef(0),p=u.useRef(!1),v=u.useRef(0),g=u.useRef(null);u.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const x=Date.now();if(x-m.current<Xa)return;const N=Qs(a,l,o||x);if(!N)return;const P=Zs(l,N),y=!l||x-l.lastUpdated>=Us;!P&&!y||(d(N),m.current=x)},[a,o,l,d]);const h=u.useCallback(async()=>{if(p.current||!e||!t||!s||!r)return;const x=Date.now();if(!(x-v.current<Ys||a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||x-(o||0)<=Hs))){p.current=!0,v.current=x;try{const P=await ar.getOptionChain(e,t,r,so(s),i);if(P.status!=="success"||!Array.isArray(P.chain)||P.chain.length===0)return;const y=Qs(P,l,Date.now());if(!y)return;const w=Zs(l,y),M=!l||Date.now()-l.lastUpdated>=Us;if(!w&&!M)return;d(y),m.current=Date.now()}catch{}finally{p.current=!1}}},[e,t,s,r,i,a,c,o,l,d]);u.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||Date.now()-(o||0)<=Hs)){g.current&&(clearInterval(g.current),g.current=null);return}return h(),g.current&&clearInterval(g.current),g.current=setInterval(()=>{h()},Ys),()=>{g.current&&(clearInterval(g.current),g.current=null)}},[a,c,o,h])}function io(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const s=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let c=1;c<s.length;c++)s[c]>s[c-1]?r++:s[c]<s[c-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=s.length>=2?Math.abs(s[s.length-1]-s[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function ao(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const s=e.slice(-t.regimeDetectionPeriod),r=s.map(d=>d.high),i=s.map(d=>d.low),a=Math.max(...r)-Math.min(...i),o=s.map(d=>d.close),c=Math.abs(o[o.length-1]-o[0]),l=s.reduce((d,m)=>d+(m.high-m.low),0)/s.length;return a<t.rangingThresholdPts?"RANGING":c>a*.6?"TRENDING":l>a*.15?"VOLATILE":"RANGING"}function oo(e,t,s){if(e.length<s)return!1;const r=e.slice(-s);return Math.max(...r)-Math.min(...r)<t}function lo(e,t){let s=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?s+=1:s-=1),e.rsi!==null&&(e.rsi>60?s+=1:e.rsi<40&&(s-=1));const r=s*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function co(e,t,s){return!s.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>s.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<s.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<s.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:s.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function uo(e,t,s){if(!s.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function po(e,t,s){if(!s.optionsContextEnabled||!t)return{exit:!1,reason:""};if(s.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>s.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${s.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>s.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<s.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function mo(e,t,s,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=s==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${s==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function fo(e,t,s,r,i,a,o,c,l,d,m,p=[],v){let g=0;const h=[],x=Date.now(),N=[],P=m&&m.totalBid>0&&m.totalAsk>0?e==="CE"?m.totalBid/m.totalAsk:m.totalAsk/m.totalBid:null,y=s.respectHotZones?l:1,w=Math.max(.25,y*Math.max(.1,s.sensitivityMultiplier)),M=Math.min(10,Math.max(1,s.entryMinScore/w)),F=(A,Z,E,B)=>{N.push({id:A,label:Z,pass:E,value:B})},D=(A,Z)=>({enter:!1,reason:A,score:g,minScore:Number(M.toFixed(2)),checks:N,blockedBy:Z,spread:d,depthRatio:P,expectedSlippage:Math.max(0,d/2)}),V=r.tradesCount<s.maxTradesPerDay;if(F("daily-trades","Daily trade cap",V,`${r.tradesCount}/${s.maxTradesPerDay}`),!V)return D("Max daily trades reached","daily-trades");const X=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=s.maxDailyLoss);if(F("daily-loss","Daily loss limit",X,`${r.realizedPnl.toFixed(0)}/${-s.maxDailyLoss}`),!X)return D("Daily loss limit reached","daily-loss");const ne=r.consecutiveLosses<s.coolingOffAfterLosses;if(F("cooling-off","Consecutive-loss cooling off",ne,`${r.consecutiveLosses}/${s.coolingOffAfterLosses}`),!ne)return D(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const R=!r.killSwitch;if(F("kill-switch","Kill switch",R),!R)return D("Kill switch active","kill-switch");const C=!s.respectHotZones||y>0;if(F("hot-zone","Market hot-zone timing",C,s.respectHotZones?y.toFixed(2):"OFF"),!C)return D("Outside configured market hot-zone timing","hot-zone");const J=Math.max(0,r.openSideLots??0),ee=r.allowEntryWithOpenSide===!0,L=!r.sideOpen||ee;if(F("side-open","No open position on side",L,r.sideOpen?ee?`Pyramid allowed (${J.toFixed(1)} lots open)`:`${J.toFixed(1)} lots open`:"0 lots"),!L)return D(`Position already open on ${e}`,"side-open");const S=r.reEntryCountForSide??0,O=r.lastExitAtForSide??0,k=s.reEntryEnabled===!0;if(F("reentry-setting","Re-entry",!0,k?"ON":"OFF (first entry only)"),k){if(F("reentry-count","Re-entry cap",s.reEntryMaxPerSide<=0||S<s.reEntryMaxPerSide,`${S}/${s.reEntryMaxPerSide}`),s.reEntryMaxPerSide>0&&S>=s.reEntryMaxPerSide)return D(`Re-entry cap reached for ${e}`,"reentry-count");if(s.reEntryDelaySec>0&&O>0){const A=x-O,Z=s.reEntryDelaySec*1e3,E=A>=Z;if(F("reentry-delay","Re-entry delay",E,E?`${s.reEntryDelaySec}s`:`${Math.ceil((Z-A)/1e3)}s left`),!E)return D(`Re-entry delay active: ${Math.ceil((Z-A)/1e3)}s`,"reentry-delay")}}else{const A=S===0;if(F("reentry-first","First entry only",A,`${S}/1`),!A)return D(`Re-entry disabled for ${e}`,"reentry-first")}if(s.maxPositionSize>0&&(r.requestedLots??0)>s.maxPositionSize)return F("max-position-size","Max position size",!1,`${r.requestedLots}/${s.maxPositionSize}`),D(`Requested lots ${r.requestedLots} exceeds max ${s.maxPositionSize}`,"max-position-size");if(F("max-position-size","Max position size",!0,`${r.requestedLots??0}/${s.maxPositionSize}`),s.perTradeMaxLoss>0&&r.lastTradePnl!=null){const A=r.lastTradePnl>-s.perTradeMaxLoss;if(F("per-trade-loss","Per-trade max loss",A,`${r.lastTradePnl.toFixed(0)}/${-s.perTradeMaxLoss}`),!A)return D("Last trade breached per-trade max loss","per-trade-loss")}else F("per-trade-loss","Per-trade max loss",!0);if(s.minGapMs>0&&r.lastTradeTime>0){const A=x-r.lastTradeTime,Z=A>=s.minGapMs;if(F("min-gap","Minimum gap between entries",Z,Z?`${A}ms`:`${s.minGapMs-A}ms left`),A<s.minGapMs)return D(`Min gap: ${Math.ceil((s.minGapMs-A)/1e3)}s remaining`,"min-gap")}else F("min-gap","Minimum gap between entries",!0);if(F("per-minute-rate","Per-minute trade rate",s.maxTradesPerMinute<=0||r.tradesThisMinute<s.maxTradesPerMinute,`${r.tradesThisMinute}/${s.maxTradesPerMinute}`),s.maxTradesPerMinute>0&&r.tradesThisMinute>=s.maxTradesPerMinute)return D(`Rate limit: ${r.tradesThisMinute}/${s.maxTradesPerMinute} trades/min`,"per-minute-rate");if(s.cooldownAfterLossSec>0&&r.lastLossTime>0){const A=x-r.lastLossTime,Z=s.cooldownAfterLossSec*1e3,E=A>=Z;if(F("loss-cooldown","Cooldown after loss",E,E?`${s.cooldownAfterLossSec}s`:`${Math.ceil((Z-A)/1e3)}s left`),A<Z)return D(`Cooldown: ${Math.ceil((Z-A)/1e3)}s after loss`,"loss-cooldown")}else F("loss-cooldown","Cooldown after loss",!0);if(m){const A=mo(m.totalBid,m.totalAsk,e,s);if(F("depth-imbalance","Depth imbalance",A.allowed,A.reason),!A.allowed)return D(A.reason,"depth-imbalance")}else F("depth-imbalance","Depth imbalance",!0,"No depth data");if(F("spread","Spread gate",d<=s.entryMaxSpread,`${d.toFixed(2)}/${s.entryMaxSpread}`),d>s.entryMaxSpread)return D(`Spread too wide: ${d.toFixed(1)}`,"spread");if(s.volumeInfluenceEnabled){const A=Math.max(.1,s.indexVolumeMinRatio||1),Z=Math.max(.1,s.optionVolumeMinRatio||1),E=Math.max(.1,s.sideVolumeDominanceRatio||1),B=Math.max(0,s.volumeScoreWeight||0),Q=v?.indexDeltaRatio??null,de=v?.optionDeltaRatio??null,me=v?.sideDominanceRatio??null,be=v?.indexDelta,fe=v?.optionDelta,G=v?.oppositeDelta,T=Q==null?!0:Q>=A,ie=de==null?!0:de>=Z,ae=me==null?!0:me>=E;if(F("volume-index","Index volume flow",T,Q==null?"NA":`${Q.toFixed(2)}x/${A.toFixed(2)}x d:${(be??0).toFixed(0)}`),F("volume-option",`${e} volume flow`,ie,de==null?"NA":`${de.toFixed(2)}x/${Z.toFixed(2)}x d:${(fe??0).toFixed(0)}`),F("volume-dominance",`${e} vs opposite volume`,ae,me==null?"NA":`${me.toFixed(2)}x/${E.toFixed(2)}x opp:${(G??0).toFixed(0)}`),de!=null&&me!=null&&!ie&&!ae)return D(`Weak ${e} volume participation`,"volume-option");Q!=null&&T&&B>0&&(g+=.5*B,h.push(`IdxVol x${Q.toFixed(2)}`)),de!=null&&ie&&B>0&&(g+=1*B,h.push(`${e}Vol x${de.toFixed(2)}`)),me!=null&&ae&&B>0&&(g+=.75*B,h.push(`${e}>Opp x${me.toFixed(2)}`))}else F("volume-influence","Volume influence",!0,"OFF");const $=s.noTradeZoneEnabled&&oo(p,s.noTradeZoneRangePts,s.noTradeZonePeriod);if(F("no-trade-zone","No-trade zone filter",!$,s.noTradeZoneEnabled?`${s.noTradeZonePeriod} bars/${s.noTradeZoneRangePts}pts`:"OFF"),$)return D(`No-trade zone (${s.noTradeZonePeriod} candles in ${s.noTradeZoneRangePts} pts range)`,"no-trade-zone");const z=e==="CE"?"up":"down";F("momentum-direction","Momentum alignment",i.direction===z,`${i.direction} x${i.count}`),i.direction===z&&i.count>=s.entryMomentumCount?(g+=3,h.push(`Momentum ${i.direction} x${i.count}`)):i.direction===z&&(g+=1,h.push(`Weak momentum ${i.direction}`)),F("velocity","Velocity threshold",i.velocity>=s.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${s.entryMomentumVelocity}`),i.velocity>=s.entryMomentumVelocity&&(g+=2,h.push(`Velocity ${i.velocity.toFixed(1)}`));let W=!1;a.ema9!==null&&a.ema21!==null&&(W=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,W&&(g+=1,h.push("EMA aligned"))),F("ema","EMA alignment",W,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let _=!1;a.rsi!==null&&(_=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,_&&(g+=1,h.push(`RSI ${a.rsi.toFixed(0)}`))),F("rsi","RSI alignment",_,a.rsi!=null?a.rsi.toFixed(1):"NA");let q=!1;s.indexBiasEnabled&&(q=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",q&&(g+=1,h.push(`Index ${o.direction}`))),F("index-bias","Index bias alignment",s.indexBiasEnabled?q:!0,s.indexBiasEnabled?`${o.direction}`:"OFF");const f=co(e,c,s);return F("options-context","Options context filter",f.allowed,f.reason),f.allowed?(F("score-gate","Final score gate",g>=M,`${g.toFixed(1)}/${M.toFixed(1)}`),{enter:g>=M,reason:h.join(", ")||"No strong signals",score:g,minScore:Number(M.toFixed(2)),checks:N,spread:d,depthRatio:P,expectedSlippage:Math.max(0,d/2)}):D(f.reason,"options-context")}function xo(e,t,s,r,i,a,o){const c=i?s-t:t-s,l=i?r-t:t-r,d=uo(a.trailInitialSL,o,a);if(e==="INITIAL"){const p=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return c>=p?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-d:t+d,newStage:"INITIAL"}}return e==="BREAKEVEN"?l>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?l>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?l>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function ho(e,t,s,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:s,score:i.score,reason:i.reason,regime:a,pcr:o}}const go=2;function Js(e,t){if(e.length<t)return null;const s=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*s+r*(1-s);return Number.isFinite(r)?r:null}function yo(e,t=14){if(e.length<t+1)return null;let s=0,r=0;for(let l=1;l<=t;l++){const d=e[l]-e[l-1];d>0?s+=d:r+=-d}let i=s/t,a=r/t;for(let l=t+1;l<e.length;l++){const d=e[l]-e[l-1],m=d>0?d:0,p=d<0?-d:0;i=(i*(t-1)+m)/t,a=(a*(t-1)+p)/t}if(a===0)return 100;const c=100-100/(1+i/a);return Number.isFinite(c)?c:null}function er(e){return{ema9:Js(e,9),ema21:Js(e,21),supertrend:null,rsi:yo(e,14),vwap:null}}function qn(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function Kn(e,t,s=360){e.push(t),e.length>s&&e.splice(0,e.length-s)}function Gn(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const s=Math.max(3,t+1),r=e.slice(-s);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const i=[];for(let d=1;d<r.length;d++){const m=r[d]-r[d-1];i.push(m>0&&Number.isFinite(m)?m:0)}if(i.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const a=i[i.length-1],o=i.slice(0,-1),c=o.length>0?o.reduce((d,m)=>d+m,0)/o.length:0,l=c>0?a/c:null;return{latestDelta:a,avgDelta:c>0?c:null,ratio:l}}function bo(e){return e==="TRAIL"||e==="TIGHT"||e==="ACCELERATED"}function vo(e){const s=Ae(I=>I.apiKey),r=Ae(I=>I.setApiKey),i=b(I=>I.underlying),a=b(I=>I.indexExchange),o=b(I=>I.selectedCESymbol),c=b(I=>I.selectedPESymbol),l=b(I=>I.optionExchange),d=b(I=>I.quantity),m=b(I=>I.lotSize),p=b(I=>I.product),v=b(I=>I.tpPoints),g=b(I=>I.slPoints),h=b(I=>I.selectedStrike),x=b(I=>I.paperMode),N=H(I=>I.enabled),P=H(I=>I.mode),y=H(I=>I.config),w=H(I=>I.activePresetId),M=H(I=>I.optionsContext),F=H(I=>I.regime),D=H(I=>I.consecutiveLosses),V=H(I=>I.tradesCount),X=H(I=>I.realizedPnl),ne=H(I=>I.lastTradePnl),R=H(I=>I.lastTradeTime),C=H(I=>I.tradesThisMinute),J=H(I=>I.lastLossTime),ee=H(I=>I.sideEntryCount),L=H(I=>I.sideLastExitAt),S=H(I=>I.replayMode),O=H(I=>I.killSwitch),k=H(I=>I.setRegime),$=H(I=>I.addGhostSignal),z=H(I=>I.recordTrade),W=H(I=>I.recordAutoEntry),_=H(I=>I.pushDecision),q=H(I=>I.pushExecutionSample),f=ue(I=>I.virtualTPSL),A=ue(I=>I.setVirtualTPSL),Z=u.useRef([]),E=u.useRef([]),B=u.useRef([]),Q=u.useRef([]),de=u.useRef([]),me=u.useRef([]),be=u.useRef(0),fe=u.useRef(!1),G=u.useRef({CE:"",PE:""}),T=u.useRef({CE:0,PE:0}),ie=u.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}}),ae=u.useRef(0),Le=u.useCallback(async()=>{if(s)return s;try{const oe=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(oe.status==="success"&&oe.api_key)return r(oe.api_key),oe.api_key}catch(I){console.error("[AutoTrade] Failed to fetch API key:",I)}return null},[s,r]);u.useEffect(()=>{if(!N||!e)return;const I=Date.now();if(I-be.current<100)return;be.current=I;const oe=o,xe=c,Se=e.get(`${a}:${i}`)?.data?.ltp,Pe=oe?e.get(`${l}:${oe}`)?.data?.ltp:void 0,Ne=xe?e.get(`${l}:${xe}`)?.data?.ltp:void 0,_e=qn(e.get(`${a}:${i}`)?.data?.volume),ze=oe?qn(e.get(`${l}:${oe}`)?.data?.volume):null,U=xe?qn(e.get(`${l}:${xe}`)?.data?.volume):null;Se&&(Z.current.push(Se),Z.current.length>300&&(Z.current=Z.current.slice(-300))),Pe&&(E.current.push(Pe),E.current.length>300&&(E.current=E.current.slice(-300))),Ne&&(B.current.push(Ne),B.current.length>300&&(B.current=B.current.slice(-300))),_e!=null&&Kn(Q.current,_e),ze!=null&&Kn(de.current,ze),U!=null&&Kn(me.current,U);const se=Math.max(5,Number(y.volumeLookbackTicks)||20),Re=Gn(Q.current,se),qe=Gn(de.current,se),Ke=Gn(me.current,se),Ge=w==="expiry",{sensitivity:We}=Yn(new Date,Ge),vt=M&&I-M.lastUpdated<=2e4?M:null;for(const Y of["CE","PE"]){const ge=Y==="CE"?oe:xe,Ee=Y==="CE"?Pe:Ne,ve=Y==="CE"?E.current:B.current,Oe=Object.values(f).filter(Me=>Me.side===Y),Be=Oe.filter(Me=>Me.managedBy==="auto"),rt=Oe.length>0,St=Oe.reduce((Me,Ye)=>Me+Math.max(0,Ye.quantity||0),0),Ze=m>0?St/m:0,Nt=Number.isFinite(Ze)?Ze:0,xt=Y==="CE"?qe:Ke,ht=Y==="CE"?Ke:qe,It=xt.latestDelta!=null&&ht.latestDelta!=null?xt.latestDelta/Math.max(1,ht.latestDelta):null,Wt={indexDelta:Re.latestDelta,indexDeltaRatio:Re.ratio,optionDelta:xt.latestDelta,optionDeltaRatio:xt.ratio,oppositeDelta:ht.latestDelta,sideDominanceRatio:It};if(!ge||!Ee||ve.length<5)continue;let Pt=0;for(const Me of Oe){const Ye=`${Me.exchange}:${Me.symbol}`,tt=e.get(Ye)?.data?.ltp??(Me.symbol===ge?Ee:void 0);!tt||tt<=0||(Pt+=Me.action==="BUY"?(tt-Me.entryPrice)*Me.quantity:(Me.entryPrice-tt)*Me.quantity)}const lt=Be.some(Me=>bo(Me.trailStage)),At=d+go,Ht=Math.max(0,Math.floor(At-Nt+1e-6)),$t=w==="adaptive-scalper"&&rt&&Be.length>0&&lt&&Pt>0&&Ht>0,Ce=$t?Math.max(1,Math.min(d,Ht)):d,Ve=io(ve,y),j=er(ve),K=er(Z.current),re=lo(K,y),he=`${l}:${ge}`,we=e.get(he)?.data?.bid_price,ce=e.get(he)?.data?.ask_price,ke=we&&ce?ce-we:2,le=e.get(he)?.data?.depth;let $e;if(le?.buy?.length&&le?.sell?.length){const Me=le.buy.reduce((tt,gt)=>tt+(gt.quantity||0),0),Ye=le.sell.reduce((tt,gt)=>tt+(gt.quantity||0),0);Me>0&&Ye>0&&($e={totalBid:Me,totalAsk:Ye})}const Qe={consecutiveLosses:D,tradesCount:V,realizedPnl:X,lastTradeTime:R,tradesThisMinute:C,lastLossTime:J,requestedLots:$t?Nt+Ce:d,sideOpen:rt,openSideLots:Nt,allowEntryWithOpenSide:$t,lastExitAtForSide:L[Y],reEntryCountForSide:ee[Y],lastTradePnl:ne,killSwitch:O},pe=fo(Y,Ee,y,Qe,Ve,j,re,vt,We,ke,$e,ve,Wt),wt=`${pe.enter}|${pe.blockedBy??""}|${pe.reason}|${pe.score.toFixed(2)}|${pe.minScore.toFixed(2)}`;(wt!==G.current[Y]||I-T.current[Y]>=1e3)&&(_({timestamp:I,side:Y,symbol:ge,enter:pe.enter,score:pe.score,minScore:pe.minScore,reason:pe.reason,blockedBy:pe.blockedBy,spread:pe.spread,depthRatio:pe.depthRatio,expectedSlippage:pe.expectedSlippage,checks:pe.checks,regime:F}),G.current[Y]=wt,T.current[Y]=I);const ct=ho(Y,ge,h??0,Ee,pe,F,vt?.pcr);if(ct){const Me=`${ge}|${pe.reason}|${pe.score.toFixed(1)}`,Ye=ie.current[Y];(Me!==Ye.sig||I-Ye.at>=2500)&&($(ct),ie.current[Y]={at:I,sig:Me},je.message(`Signal ${Y} ${ge.slice(-12)}`,{description:`${pe.score.toFixed(1)} / ${pe.minScore.toFixed(1)} | ${pe.reason}`}))}if(P==="execute"&&!S&&pe.enter&&!fe.current){fe.current=!0;const Me="BUY",Ye=Ce*m;(async()=>{const gt=()=>{const Je=H.getState();return Je.enabled&&Je.mode==="execute"&&!Je.replayMode&&!Je.killSwitch};try{if(!gt()){q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:pe.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}const Je=x?null:await Le();if(!x&&!Je){q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:pe.expectedSlippage,status:"rejected",reason:"Missing API key"}),Date.now()-ae.current>5e3&&(ae.current=Date.now(),je.error("Auto execute blocked: API key missing"));return}let Dn=null;if(!x&&Je){const Br={apikey:Je,strategy:"Scalping-Auto",exchange:l,symbol:ge,action:Me,quantity:Ye,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},ls=await Te.placeOrder(Br);if(ls.status!=="success"){q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:pe.expectedSlippage,status:"rejected",reason:"Order rejected"});return}Dn=Kt(ls),console.log(`[AutoTrade] ${Me} ${ge} id=${Dn??"n/a"} score=${pe.score}`)}else console.log(`[AutoTrade Paper] ${Me} ${Y} ${ge} score=${pe.score}`);if(!gt()){q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:pe.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const bn=x?await Mt({symbol:ge,exchange:l,preferredPrice:Ee,apiKey:null}):await Ut({symbol:ge,exchange:l,orderId:Dn,preferredPrice:Ee,apiKey:Je}),Or=Math.max(2,Number(y.trailLockTrigger)||8),Fr=Math.max(2,Number(y.trailInitialSL)||5),zr=v>0?v:Or,_r=g>0?g:Fr;bn>0&&A(ft({symbol:ge,exchange:l,side:Y,action:Me,entryPrice:bn,quantity:Ye,tpPoints:zr,slPoints:_r,managedBy:"auto",autoEntryScore:pe.score,autoEntryReason:pe.reason})),z(0),W(Y),q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:Math.max(0,Math.abs((bn>0?bn:Ee)-Ee)),status:"filled",reason:pe.reason}),y.telegramAlertsEntry&&as.sendBroadcast({message:`[AUTO ENTRY] ${Y} ${ge} qty=${Ye} score=${pe.score.toFixed(1)} reason=${pe.reason}`}).catch(()=>{})}catch(Je){q({timestamp:Date.now(),side:Y,symbol:ge,spread:pe.spread,expectedSlippage:pe.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",Je)}finally{fe.current=!1}})()}}const Rt=Z.current.length>=y.regimeDetectionPeriod?Z.current:E.current;if(Rt.length>=y.regimeDetectionPeriod){const Y=Rt.slice(-y.regimeDetectionPeriod).map((Ee,ve,Oe)=>({high:Math.max(Ee,Oe[Math.max(0,ve-1)]??Ee),low:Math.min(Ee,Oe[Math.max(0,ve-1)]??Ee),close:Ee})),ge=ao(Y,y);ge!==F&&k(ge)}},[N,e,P,y,w,o,c,M,F,D,V,X,R,C,J,ne,ee,L,S,O,Le,l,d,m,p,v,g,x,h,$,z,W,_,q,k,f,A,i,a])}const So=3e3;function Po(e){const t=Ae(R=>R.apiKey),s=Ae(R=>R.setApiKey),r=b(R=>R.paperMode),i=b(R=>R.product),a=b(R=>R.trailDistancePoints),o=b(R=>R.addSessionPnl),c=b(R=>R.incrementTradeCount),l=H(R=>R.config),d=H(R=>R.activePresetId),m=H(R=>R.optionsContext),p=H(R=>R.recordAutoExit),v=H(R=>R.recordTradeOutcome),g=H(R=>R.pushExecutionSample),h=ue(R=>R.virtualTPSL),x=ue(R=>R.triggerOrders),N=ue(R=>R.removeTriggerOrder),P=ue(R=>R.setVirtualTPSL),y=ue(R=>R.removeVirtualTPSL),w=u.useRef(t),M=u.useRef(r),F=u.useRef(i);u.useEffect(()=>{w.current=t},[t]),u.useEffect(()=>{M.current=r},[r]),u.useEffect(()=>{F.current=i},[i]);const D=u.useRef(new Set),V=u.useCallback(async()=>{if(w.current)return w.current;try{const C=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(C.status==="success"&&C.api_key)return w.current=C.api_key,s(C.api_key),C.api_key}catch(R){console.error("[Scalping] Failed to fetch API key:",R)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[s]),X=u.useCallback(async(R,C,J,ee,L)=>{const S=ee==="BUY"?"SELL":"BUY";if(M.current)return console.log(`[Paper TP/SL] ${L}: ${S} ${R} qty=${J}`),!0;const O=await V();if(!O)return!1;const k={apikey:O,strategy:"Scalping",exchange:C,symbol:R,action:S,quantity:J,pricetype:"MARKET",product:F.current,price:0,trigger_price:0,disclosed_quantity:0};try{const $=await Te.placeOrder(k);if($.status==="success"){const z=Kt($);return console.log(`[Scalping TP/SL] ${L}: ${S} ${R} id=${z??"n/a"}`),!0}}catch($){console.error(`[Scalping TP/SL] ${L} order failed:`,$)}try{if((await Te.closePosition(R,C,F.current)).status==="success")return console.log(`[Scalping TP/SL] ${L}: closePosition fallback ${R}`),!0}catch($){console.error(`[Scalping TP/SL] ${L} closePosition fallback failed:`,$)}return!1},[V]),ne=u.useCallback(async(R,C,J,ee)=>{if(M.current)return console.log(`[Paper Trigger] Entry: ${ee} ${R} qty=${J}`),{ok:!0,orderId:null};const L=await V();if(!L)return{ok:!1,orderId:null};const S={apikey:L,strategy:"Scalping",exchange:C,symbol:R,action:ee,quantity:J,pricetype:"MARKET",product:F.current,price:0,trigger_price:0,disclosed_quantity:0};try{const O=await Te.placeOrder(S);if(O.status==="success"){const k=Kt(O);return console.log(`[Scalping Trigger] Entry: ${ee} ${R} id=${k??"n/a"}`),{ok:!0,orderId:k}}}catch(O){console.error("[Scalping Trigger] Entry failed:",O)}return{ok:!1,orderId:null}},[V]);u.useEffect(()=>{if(!e)return;const R=(C,J,ee)=>{D.current.add(C.id);const S=C.action==="BUY"?(J-C.entryPrice)*C.quantity:(C.entryPrice-J)*C.quantity;X(C.symbol,C.exchange,C.quantity,C.action,`${ee} at ${J}`).then(O=>{O&&(y(C.id),o(S),c(),C.managedBy==="auto"&&(p(C.side,S),v(S),g({timestamp:Date.now(),side:C.side,symbol:C.symbol,spread:0,expectedSlippage:0,status:"exited",reason:ee}),l.telegramAlertsExit&&as.sendBroadcast({message:`[AUTO EXIT] ${C.side} ${C.symbol} pnl=${S.toFixed(0)} reason=${ee}`}).catch(()=>{}))),D.current.delete(C.id)})};for(const C of Object.values(h)){const J=`${C.exchange}:${C.symbol}`,L=(e.get(J)??e.get(C.symbol))?.data?.ltp;if(!L||D.current.has(C.id))continue;const S=C.action==="BUY",O=S?(L-C.entryPrice)*C.quantity:(C.entryPrice-L)*C.quantity;if(C.managedBy==="auto"){if(l.perTradeMaxLoss>0&&O<=-l.perTradeMaxLoss){R(C,L,`Per-trade max loss ${l.perTradeMaxLoss}`);continue}if(Math.max(0,Date.now()-(C.createdAt||0))>=So){const $=d==="adaptive-scalper"?{...l,ivSpikeExitEnabled:!1}:l,z=po(C.side,m,$);if(z.exit){R(C,L,`Options early-exit: ${z.reason}`);continue}}}if(C.tpPrice!==null&&(S?L>=C.tpPrice:L<=C.tpPrice)){R(C,L,"TP hit");continue}C.slPrice!==null&&(S?L<=C.slPrice:L>=C.slPrice)&&R(C,L,"SL hit")}for(const C of Object.values(x)){const J=`${C.exchange}:${C.symbol}`,L=(e.get(J)??e.get(C.symbol))?.data?.ltp;if(!L||D.current.has(C.id))continue;(C.direction==="above"?L>=C.triggerPrice:L<=C.triggerPrice)&&(D.current.add(C.id),ne(C.symbol,C.exchange,C.quantity,C.action).then(async({ok:O,orderId:k})=>{try{if(O&&(N(C.id),c(),L>0)){const $=w.current,z=M.current?L:await Ut({symbol:C.symbol,exchange:C.exchange,orderId:k,preferredPrice:L,apiKey:$});z>0&&P(ft({symbol:C.symbol,exchange:C.exchange,side:C.side,action:C.action,entryPrice:z,quantity:C.quantity,tpPoints:C.tpPoints,slPoints:C.slPoints,trailDistancePoints:C.trailDistancePoints??a,managedBy:"trigger"}))}}finally{D.current.delete(C.id)}}))}},[e,h,x,X,ne,N,P,y,o,c,a,l,d,m,p,v,g])}const jo=2,Ct=.05;function Zn(e){return Math.round(e/Ct)*Ct}function No(e){return e.slPrice==null?!1:e.managedBy==="auto"||e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"}function wo(e,t){return e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"?!0:e.managedBy==="auto"&&t==="adaptive-scalper"}function tr(e,t){const s={slPrice:t};if(e.tpPrice==null||e.slPrice==null)return s;const r=t-e.slPrice;if(Math.abs(r)<Ct)return s;const i=Zn(e.tpPrice+r),o=e.action==="BUY"?Math.max(e.tpPrice,i):Math.min(e.tpPrice,i);return Math.abs(o-e.tpPrice)>=Ct&&(s.tpPrice=o),s}function ko(){const e=H(x=>x.config),t=H(x=>x.activePresetId),s=H(x=>x.optionsContext),r=H(x=>x.setTrailStage),i=H(x=>x.setHighSinceEntry),a=ue(x=>x.virtualTPSL),o=ue(x=>x.updateVirtualTPSL),c=u.useRef(e),l=u.useRef(t),d=u.useRef(s),m=u.useRef({}),p=u.useRef({}),v=u.useRef({}),g=u.useRef({});u.useEffect(()=>{c.current=e},[e]),u.useEffect(()=>{l.current=t},[t]),u.useEffect(()=>{d.current=s},[s]);const h=u.useMemo(()=>Object.values(a).filter(x=>No(x)),[a]);u.useEffect(()=>{const x=nn.getInstance(),N=new Set(h.map(P=>P.id));for(const[P,y]of Object.entries(g.current))N.has(P)||(y(),delete g.current[P],delete m.current[P],delete p.current[P],delete v.current[P]);for(const P of h)g.current[P.id]||(m.current[P.id]=P.trailStage??"INITIAL",p.current[P.id]=P.entryPrice,v.current[P.id]=P.slPrice??P.entryPrice,g.current[P.id]=x.subscribe(P.symbol,P.exchange,"LTP",y=>{const w=y.data.ltp;if(!w||w<=0)return;const M=ue.getState().virtualTPSL[P.id];if(!M||M.slPrice==null)return;const F=M.managedBy==="auto",D=M.action==="BUY",V=p.current[P.id]??M.entryPrice,X=D?Math.max(V,w):Math.min(V,w);if(X!==V&&(p.current[P.id]=X,F&&i(X)),wo(M,l.current)){if(!(D?w>M.entryPrice:w<M.entryPrice))return;m.current[P.id]!=="TRAIL"&&(m.current[P.id]="TRAIL",F&&r("TRAIL"),o(P.id,{trailStage:"TRAIL"}));const $=typeof M.trailDistancePoints=="number"&&M.trailDistancePoints>0?M.trailDistancePoints:jo,z=D?w-$:w+$,W=Zn(z),_=M.slPrice,q=v.current[P.id],f=D?Math.max(_??W,W):Math.min(_??W,W),A=_==null||Math.abs(f-_)>=Ct,Z=q==null||Math.abs(f-q)>=Ct;A&&Z&&(v.current[P.id]=f,o(P.id,tr(M,f)));return}const ne=m.current[P.id]??"INITIAL",R=xo(ne,M.entryPrice,w,X,D,c.current,d.current);R.newStage!==ne&&(m.current[P.id]=R.newStage,F&&r(R.newStage),o(P.id,{trailStage:R.newStage}));const C=Zn(R.newSL),J=M.slPrice,ee=v.current[P.id],L=D?Math.max(J??C,C):Math.min(J??C,C),S=J==null||Math.abs(L-J)>=Ct,O=ee==null||Math.abs(L-ee)>=Ct;S&&O&&(v.current[P.id]=L,o(P.id,tr(M,L)))}));return()=>{}},[h,i,r,o]),u.useEffect(()=>()=>{for(const x of Object.values(g.current))x();g.current={},m.current={},p.current={},v.current={}},[])}const To=1e3;function os(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Lt(e){return os(e)??0}function Eo(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Co(e){const t=os(e.pnl);if(t!==null)return t;const s=Lt(e.ltp),r=Lt(e.average_price),i=Math.abs(Lt(e.quantity));return(Lt(e.quantity)>0?s-r:r-s)*i}function Lo(){const e=Ae(y=>y.apiKey),t=Ae(y=>y.setApiKey),s=en(y=>y.unifiedMode),[r,i]=u.useState([]),[a,o]=u.useState(!1),c=u.useCallback(async()=>{if(e)return e;try{const w=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(w.status==="success"&&w.api_key)return t(w.api_key),w.api_key}catch{}return null},[e,t]),l=u.useCallback(async()=>{const y=await c();if(!y){o(!1);return}o(!0);try{const w=await Te.getPositions(y);w.status==="success"&&w.data&&i(Array.isArray(w.data)?w.data:[])}catch{}finally{o(!1)}},[c]);u.useEffect(()=>{l();const y=setInterval(l,To);return()=>clearInterval(y)},[l]);const{data:d,isLive:m,isPaused:p}=Hr(r,{enabled:!s&&r.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),v=u.useMemo(()=>s?r:d,[s,r,d]),g=u.useMemo(()=>v.flatMap(y=>{const w=Eo(y.symbol);if(!w)return[];const M=Lt(y.quantity),F=Math.abs(M);if(F===0)return[];const D=Lt(y.ltp),V=Lt(y.average_price),X=M>0,ne=X?D-V:V-D,C=os(y.pnl)??ne*F;return[{symbol:y.symbol,exchange:y.exchange,side:w,action:X?"BUY":"SELL",quantity:F,avgPrice:V,ltp:D,pnl:C,pnlPoints:ne,product:y.product}]}),[v]),h=u.useMemo(()=>r.some(y=>Lt(y.quantity)!==0),[r]),x=u.useMemo(()=>v.reduce((y,w)=>y+Co(w),0),[v]),N=u.useCallback(y=>g.find(w=>w.side===y),[g]),P=u.useMemo(()=>r.map(y=>({symbol:y.symbol,exchange:y.exchange})),[r]);return{positions:g,totalPnl:x,isLive:!s&&m&&h,isPaused:!s&&p,isLoading:a,refetch:l,getPositionForSide:N,positionSymbols:P}}const Mo=1e3,Ro=100;function Cn(e){const t=Number(e);return Number.isFinite(t)&&t>0?t:null}function Io(e){const t=String(e??"").trim().toUpperCase();return t==="BUY"||t==="SELL"?t:null}function Ao(e,t){const s=String(e??"").trim().toUpperCase();return s==="CE"||s==="PE"?s:t.toUpperCase().endsWith("PE")?"PE":"CE"}function $o(){const e=Ae(l=>l.apiKey),t=Ae(l=>l.setApiKey),s=b(l=>l.tpPoints),r=b(l=>l.slPoints),i=ue(l=>l.setVirtualTPSL),a=u.useRef(!1),o=u.useCallback(async()=>{if(e)return e;try{const d=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(d.status==="success"&&d.api_key)return t(d.api_key),d.api_key}catch{}return null},[e,t]),c=u.useCallback(async(l,d)=>{const m=Number(l.id);if(!Number.isInteger(m)||m<=0)return!1;const p=String(l.symbol??"").trim().toUpperCase(),v=String(l.exchange??"NFO").trim().toUpperCase(),g=Io(l.action),h=Math.trunc(Cn(l.quantity)??0);if(!p||!g||h<=0)return!1;const x=`flow-${m}`;if(ue.getState().virtualTPSL[x])return!0;const P=Ao(l.side,p),y=Cn(l.tp_points)??s,w=Cn(l.sl_points)??r,M=Cn(l.entry_price),F=String(l.order_id??"").trim()||null,D=await Ut({symbol:p,exchange:v,orderId:F,preferredPrice:M,fallbackPrice:M,apiKey:d});if(!(D>0))return!1;const V=Number(l.created_at);return i(ft({id:x,symbol:p,exchange:v,side:P,action:g,entryPrice:D,quantity:h,tpPoints:y,slPoints:w,managedBy:"flow",createdAt:Number.isFinite(V)&&V>0?V:Date.now()})),!0},[s,r,i]);u.useEffect(()=>{let l=!0,d=null;async function m(){if(!l||a.current){p();return}a.current=!0;try{const v=await o();if(!v)return;const g=await Te.getScalpingBridgePending(v,Ro),h=Array.isArray(g.data?.entries)?g.data.entries:[];if(!h.length)return;const x=[];for(const N of h)try{await c(N,v)&&x.push(Number(N.id))}catch{}x.length&&await Te.ackScalpingBridgeEntries(v,x)}catch{}finally{a.current=!1,p()}}function p(){l&&(d=setTimeout(m,Mo))}return m(),()=>{l=!1,d&&clearTimeout(d)}},[c,o])}const Do=15e3;function Tt(e,t){if(e&&typeof e=="object"){const s=e.message;if(typeof s=="string"&&s.trim().length>0)return s.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function el(){const[e,t]=u.useState(!1),[s,r]=u.useState(!1),i=u.useRef(!1),a=u.useCallback(()=>t(E=>!E),[]),o=u.useCallback(()=>t(!1),[]),c=u.useCallback(()=>r(E=>!E),[]),l=b(E=>E.paperMode),d=b(E=>E.underlying),m=b(E=>E.indexExchange),p=b(E=>E.optionExchange),v=b(E=>E.product),g=b(E=>E.quantity),h=b(E=>E.lotSize),x=b(E=>E.incrementTradeCount),N=b(E=>E.setLimitPrice),P=b(E=>E.setPendingEntryAction),y=b(E=>E.pendingLimitPlacement),w=b(E=>E.clearPendingLimitPlacement),M=b(E=>E.selectedCESymbol),F=b(E=>E.selectedPESymbol),D=ue(E=>E.virtualTPSL),V=ue(E=>E.triggerOrders),X=ue(E=>E.clearAll),ne=ue(E=>E.clearForSymbol),R=ue(E=>E.clearTriggerOrders),C=ue(E=>E.removeVirtualTPSL),J=ue(E=>E.updateVirtualTPSL),ee=ue(E=>E.setVirtualTPSL),L=H(E=>E.config.imbalanceFilterEnabled),S=H(E=>E.updateRiskState),O=Ae(E=>E.apiKey),k=Ae(E=>E.setApiKey);u.useEffect(()=>{O||fetch("/api/websocket/apikey",{credentials:"include"}).then(E=>E.json()).then(E=>{E.status==="success"&&E.api_key&&k(E.api_key)}).catch(()=>{})},[O,k]),u.useEffect(()=>{R()},[R]);const $=u.useCallback(async(E,B)=>{if(l){console.log(`[Paper] Close ${E} ${B}`),ne(B),N(null),P(null),w();return}try{const Q=await Te.closePosition(B,p,v);if(Q.status!=="success"&&Q.status!=="info"){console.error("[Scalping] Close rejected:",Q),je.error(Tt(Q,"Close position rejected"));return}console.log(`[Scalping] Closed ${E} ${B}`),ne(B),N(null),P(null),w()}catch(Q){console.error("[Scalping] Close failed:",Q),je.error(Tt(Q,"Close position failed"))}},[l,p,v,ne,N,P,w]),z=u.useCallback(async()=>{if(l){console.log("[Paper] Close all positions"),X(),N(null),P(null),w();return}const E=Te.cancelAllOrders().catch(B=>(console.warn("[Scalping] Cancel all orders failed:",B),{status:"error",message:Tt(B,"Cancel all orders failed")}));try{const B=await Te.closeAllPositions(),Q=await E;if(B.status!=="success"&&B.status!=="info"){console.error("[Scalping] Close all rejected:",B),je.error(Tt(B,"Close all positions rejected"));return}Q.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",Q),console.log("[Scalping] Closed all positions"),X(),N(null),P(null),w()}catch(B){console.error("[Scalping] Close all failed:",B),je.error(Tt(B,"Close all positions failed"))}},[l,X,N,P,w]),W=u.useCallback(async(E,B)=>{if(l){console.log(`[Paper] Reverse ${E} ${B}`);return}if(O)try{const Q=await Te.closePosition(B,p,v);if(Q.status!=="success"&&Q.status!=="info"){console.error("[Scalping] Reversal close rejected:",Q),je.error(Tt(Q,"Reversal close failed"));return}const de=await Te.placeOrder({apikey:O,strategy:"Scalping",exchange:p,symbol:B,action:"SELL",quantity:g*h,pricetype:"MARKET",product:v,price:0,trigger_price:0,disclosed_quantity:0});if(de.status!=="success"){console.error("[Scalping] Reversal open rejected:",de),je.error(Tt(de,"Reversal open failed"));return}console.log(`[Scalping] Reversed ${E} ${B}`)}catch(Q){console.error("[Scalping] Reversal failed:",Q),je.error(Tt(Q,"Reversal failed"))}},[l,O,p,v,g,h]);Za({onToggleHelp:a,onClose:$,onCloseAll:z,onReversal:W}),ro();const _=u.useMemo(()=>{const E=[];d&&m&&E.push({symbol:d,exchange:m}),M&&E.push({symbol:M,exchange:p}),F&&E.push({symbol:F,exchange:p});for(const Q of Object.values(D))E.push({symbol:Q.symbol,exchange:Q.exchange});for(const Q of Object.values(V))E.push({symbol:Q.symbol,exchange:Q.exchange});const B=new Map;for(const Q of E)B.set(`${Q.exchange}:${Q.symbol}`,Q);return Array.from(B.values())},[d,m,M,F,p,D,V]),{data:q}=fn({symbols:_,mode:L?"Quote":"LTP",enabled:_.length>0}),{positions:f,totalPnl:A,isLive:Z}=Lo();return $o(),u.useEffect(()=>{S(A)},[A,S]),u.useEffect(()=>{if(l)return;const E=new Map(f.map(be=>[be.symbol,be])),B=Object.values(D);for(const be of B){const fe=E.get(be.symbol);if(!fe){const G=typeof be.createdAt=="number"?be.createdAt:0;if((G>0?Date.now()-G:Number.POSITIVE_INFINITY)<Do)continue;C(be.id);continue}(fe.side!==be.side||fe.action!==be.action||be.quantity<=0)&&C(be.id)}const Q=Object.values(ue.getState().virtualTPSL),de=new Map;for(const be of Q){const fe=de.get(be.symbol)??[];fe.push(be),de.set(be.symbol,fe)}for(const[be,fe]of de.entries()){const G=E.get(be);if(!G)continue;const T=Math.max(0,G.quantity);let ae=fe.reduce((I,oe)=>I+Math.max(0,oe.quantity),0)-T;if(ae<=0)continue;const Le=[...fe].sort((I,oe)=>oe.createdAt-I.createdAt);for(const I of Le){if(ae<=0)break;const oe=Math.max(0,I.quantity);if(oe<=ae+1e-6){C(I.id),ae-=oe;continue}const xe=Math.max(0,Number((oe-ae).toFixed(2)));J(I.id,{quantity:xe}),ae=0}}if(!y||i.current)return;const me=E.get(y.symbol);me&&(me.side!==y.side||me.action!==y.action||(i.current=!0,(async()=>{try{const be=await Ut({symbol:y.symbol,exchange:me.exchange,orderId:y.orderId,preferredPrice:y.entryPrice,fallbackPrice:me.avgPrice,apiKey:O});if(be<=0)return;ee(ft({symbol:y.symbol,exchange:me.exchange,side:y.side,action:y.action,entryPrice:be,quantity:y.quantity,tpPoints:y.tpPoints,slPoints:y.slPoints,trailDistancePoints:y.trailDistancePoints,managedBy:"manual"})),x(),w(),N(null),P(null)}finally{i.current=!1}})()))},[l,f,D,y,O,C,J,ee,x,w,N,P]),vo(q),ko(),Po(q),n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsx(Mi,{liveOpenPnl:A,isLivePnl:Z,chartFocusMode:s,onToggleChartFocusMode:c}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:s?n.jsx("div",{className:"h-full w-full min-w-0",children:n.jsx(zs,{})}):n.jsxs(Wn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[n.jsx(zt,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:n.jsx(Ai,{})}),n.jsx(Rn,{withHandle:!0,className:"bg-border/70"}),n.jsx(zt,{defaultSize:"50%",minSize:"30%",children:n.jsx(zs,{})}),n.jsx(Rn,{withHandle:!0,className:"bg-border/70"}),n.jsx(zt,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:n.jsx(Wa,{liveOpenPnl:A,isLivePnl:Z})})]})}),n.jsx($i,{positions:f,totalPnl:A,isLivePnl:Z}),n.jsx(Ya,{open:e,onClose:o})]})}export{el as default};
