import{A as K,C as $,E as g,G as u,H as p,w as A,d as _,z as j}from"./index-C51tMR0S.js";const T={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:20},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}};function G(t){if(typeof t=="string"){const e=t.toUpperCase();if(e in T)return e}return"NIFTY"}const W=K()($(t=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,trailDistancePoints:2,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,lastOrderAck:null,setUnderlying:e=>{const n=T[e];t({underlying:e,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:e=>t(n=>n.expiry===e?n:{expiry:e,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:e=>t(n=>n.expiryWeek===e?n:{expiryWeek:e}),setExpiries:e=>t(n=>n.expiries.length===e.length&&n.expiries.every((i,s)=>i===e[s])?n:{expiries:e}),setChainStrikeCount:e=>t(n=>{const i=Math.max(5,e);return n.chainStrikeCount===i?n:{chainStrikeCount:i}}),setSelectedStrike:e=>t(n=>n.selectedStrike===e?n:{selectedStrike:e}),setActiveSide:e=>t({activeSide:e}),toggleActiveSide:()=>t(e=>({activeSide:e.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(e,n)=>t(i=>i.selectedCESymbol===e&&i.selectedPESymbol===n?i:{selectedCESymbol:e,selectedPESymbol:n}),setOptionChainSnapshot:(e,n,i)=>t(s=>{const r=Number.isFinite(n)?n:Date.now(),o=typeof i=="boolean"?i:s.optionChainIsStreaming;return s.optionChainData===e&&s.optionChainLastUpdate===r&&s.optionChainIsStreaming===o?s:{optionChainData:e,optionChainLastUpdate:r,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>t(e=>e.optionChainData===null&&e.optionChainLastUpdate===0&&!e.optionChainIsStreaming?e:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:e=>t({quantity:Math.max(1,e)}),incrementQuantity:()=>t(e=>({quantity:e.quantity+1})),decrementQuantity:()=>t(e=>({quantity:Math.max(1,e.quantity-1)})),setOrderType:e=>t({orderType:e,...e==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:e=>t({product:e}),setTpPoints:e=>t({tpPoints:Math.max(0,e)}),setSlPoints:e=>t({slPoints:Math.max(0,e)}),setTrailDistancePoints:e=>t({trailDistancePoints:Math.max(0,e)}),setLimitPrice:e=>t(n=>n.limitPrice===e?n:{limitPrice:e}),setPendingEntryAction:e=>t(n=>n.pendingEntryAction===e?n:{pendingEntryAction:e}),setPendingLimitPlacement:e=>t(n=>{if(e===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const i=Array.isArray(e.orderIds)&&e.orderIds.length>0?Array.from(new Set(e.orderIds.map(c=>String(c??"").trim()).filter(c=>c.length>0))):void 0,s=Array.isArray(e.splitLegs)&&e.splitLegs.length>0?e.splitLegs.map(c=>{const y=String(c.orderId??"").trim(),k=Math.max(0,Number(c.quantity)||0);return!y||k<=0?null:{orderId:y,quantity:k}}).filter(c=>c!==null):void 0,r={...e,orderIds:i,splitLegs:s,trailDistancePoints:Math.max(0,Number(e.trailDistancePoints)||0),createdAt:e.createdAt??Date.now()},o=n.pendingLimitPlacement,a=o?.orderIds??[],l=r.orderIds??[],m=o?.splitLegs??[],S=r.splitLegs??[],C=a.length===l.length&&a.every((c,y)=>c===l[y]),x=m.length===S.length&&m.every((c,y)=>c.orderId===S[y].orderId&&c.quantity===S[y].quantity);return o&&o.symbol===r.symbol&&o.side===r.side&&o.action===r.action&&o.orderId===r.orderId&&C&&x&&o.quantity===r.quantity&&o.entryPrice===r.entryPrice&&o.tpPoints===r.tpPoints&&o.slPoints===r.slPoints&&o.trailDistancePoints===r.trailDistancePoints?n:{pendingLimitPlacement:r}}),clearPendingLimitPlacement:()=>t(e=>e.pendingLimitPlacement===null?e:{pendingLimitPlacement:null}),setPaperMode:e=>t(n=>n.paperMode===e?n:{paperMode:e}),setControlTab:e=>t({controlTab:e}),setHotkeysEnabled:e=>t({hotkeysEnabled:e}),setShowFloatingWidget:e=>t({showFloatingWidget:e}),toggleFloatingWidget:()=>t(e=>({showFloatingWidget:!e.showFloatingWidget})),setFloatingWidgetMinimized:e=>t(n=>n.floatingWidgetMinimized===e?n:{floatingWidgetMinimized:e}),toggleFloatingWidgetMinimized:()=>t(e=>({floatingWidgetMinimized:!e.floatingWidgetMinimized})),setChainCollapsed:e=>t({chainCollapsed:e}),setControlCollapsed:e=>t({controlCollapsed:e}),setCeWidgetPos:e=>t({ceWidgetPos:e}),setPeWidgetPos:e=>t({peWidgetPos:e}),setLotSize:e=>t({lotSize:e}),setChartInterval:e=>t({chartInterval:e}),addSessionPnl:e=>t(n=>({sessionPnl:n.sessionPnl+e})),incrementTradeCount:()=>t(e=>({tradeCount:e.tradeCount+1})),setLastOrderAck:e=>t(n=>{if(e===null)return n.lastOrderAck===null?n:{lastOrderAck:null};const i={...e,timestamp:e.timestamp??Date.now()},s=n.lastOrderAck;return s&&s.orderId===i.orderId&&s.broker===i.broker&&s.symbol===i.symbol&&s.action===i.action?n:{lastOrderAck:i}}),clearLastOrderAck:()=>t(e=>e.lastOrderAck===null?e:{lastOrderAck:null}),resetSession:()=>t({sessionPnl:0,tradeCount:0,lastOrderAck:null})}),{name:"openalgo-scalping",partialize:t=>({underlying:t.underlying,expiryWeek:t.expiryWeek,chainStrikeCount:t.chainStrikeCount,quantity:t.quantity,orderType:t.orderType,product:t.product,tpPoints:t.tpPoints,slPoints:t.slPoints,trailDistancePoints:t.trailDistancePoints,paperMode:t.paperMode,hotkeysEnabled:t.hotkeysEnabled,showFloatingWidget:t.showFloatingWidget,floatingWidgetMinimized:t.floatingWidgetMinimized,chartInterval:t.chartInterval,ceWidgetPos:t.ceWidgetPos,peWidgetPos:t.peWidgetPos}),merge:(t,e)=>{const n=t??{},i=G(n.underlying??e.underlying),s=T[i];return{...e,...n,underlying:i,optionExchange:s.optionExchange,indexExchange:s.indexExchange,lotSize:s.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,lastOrderAck:null}}})),h=2,D=10,E=new Map,H=["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","SENSEX","BANKEX","SENSEX50"];function w(t){const e=String(t??"").toUpperCase();return e==="MIS"||e==="NRML"||e==="CNC"?e:"MIS"}function f(t){return String(t??"").trim().toUpperCase()}function F(t){if(typeof t=="number")return Number.isFinite(t)?t:0;if(typeof t=="string"){const e=Number(t.replace(/,/g,"").trim());return Number.isFinite(e)?e:0}return 0}function P(t){if(typeof t=="number"){if(!Number.isFinite(t))return null;const e=Math.floor(t);return e>0?e:null}if(typeof t=="string"){const e=Number(t.replace(/,/g,"").trim());if(!Number.isFinite(e))return null;const n=Math.floor(e);return n>0?n:null}return null}function B(t,e){return`${f(e)}:${f(t)}`}function I(t){const e=f(t);return e?H.some(n=>e.startsWith(n)):!1}function V(t,e){const n=P(e?.lotsize);if(n==null||n<h||!(I(t.symbol)||I(e?.symbol)||I(e?.name)))return null;const s=n*D;return s>=h?s:null}function Q(t){const e=W.getState(),n=P(e.lotSize);if(n==null||n<h||!(I(t.symbol)||I(e.underlying)))return null;const s=n*D;return s>=h?s:null}function Z(t,e){const n=P(e?.lotsize);if(n!=null&&n>0)return n;const i=P(W.getState().lotSize);return i!=null&&i>0&&I(t.symbol)?i:null}function q(t,e,n){const i=Z(t,n);if(i==null||i<=1)return e;const s=Math.floor(e/i)*i;return s>=i?s:i}function J(t){if(!t||typeof t!="object")return null;const e=t,n=f(e.status);if(n&&n!=="SUCCESS")return null;const i=String(e.orderid??"").trim();if(!i)return null;const s=P(e.quantity)??0;return{orderId:i,quantity:s}}function ee(t){if(!t||typeof t!="object")return[];const n=t.results;if(!Array.isArray(n))return[];const i=[];for(const s of n){const r=J(s);r&&i.push(r)}return i}function te(t){if(!t||typeof t!="object")return[];const n=t.results;if(!Array.isArray(n))return[];const i=[];for(const s of n){if(!s||typeof s!="object")continue;const r=s;if(f(r.status)==="SUCCESS")continue;const a=String(r.message??"").trim();a&&i.push(a)}return i}function R(t,e,n){if(!t||typeof t!="object")return{status:"error",message:"Invalid splitorder response"};const i=t;if(String(i.status??"").trim().toLowerCase()==="error")return{status:"error",message:String(i.message??"Split order failed")};const r=ee(t);if(r.length===0){const l=te(t),m=l.length>0?`: ${l[0]}`:"";return{status:"error",message:String(i.message??`Split order returned no successful child orders${m}`)}}const o=r.map(l=>l.orderId),a=o[0];return{status:"success",message:String(i.message??`Split order placed (${r.length} slices of ${e})`),data:{orderid:a},orderid:a,orderids:o,split:!0,split_size:e,split_legs:r,total_quantity:n}}function ne(t){return f(t).startsWith("SCALPING")}function ie(t){if(!ne(t.strategy))return!1;const e=Number(t.quantity);if(!Number.isFinite(e)||e<=1)return!1;const n=E.get(B(t.symbol,t.exchange));if(n!=null&&e<=n)return!1;const i=Q(t);if(i!=null){const s=q(t,i);if(s>=h&&e<=s)return!1}return!0}async function se(t){const e=B(t.symbol,t.exchange);if(E.has(e))return E.get(e)??null;const n=Q(t);try{const i={apikey:t.apikey,symbol:t.symbol,exchange:t.exchange};let s;u()?s=await p("execution","symbol",i):s=(await g.post("/symbol",i)).data;const r=P(s.data?.freeze_qty);if(r!=null&&r>=h){const a=q(t,r,s.data);if(a>=h)return E.set(e,a),a}const o=V(t,s.data);if(o!=null){const a=q(t,o,s.data);if(a>=h)return E.set(e,a),a}}catch(i){console.warn("[Scalping] Auto-slice freeze lookup failed; using local fallback if available.",{symbol:t.symbol,exchange:t.exchange,error:i})}if(n!=null){const i=q(t,n);if(i>=h)return E.set(e,i),i}return null}function b(t){return t==="success"||t==="info"}async function z(){const t=_.getState().apiKey;if(t)return t;try{const n=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(n.status==="success"&&n.api_key)return _.getState().setApiKey(n.api_key),n.api_key}catch{}return null}function re(t){const e=t.orderid;if(typeof e=="string"&&e.trim().length>0)return e.trim();const n=t.orderids;if(Array.isArray(n)){const r=n.find(o=>typeof o=="string"&&o.trim().length>0);if(typeof r=="string")return r.trim()}const i=t.split_legs;if(Array.isArray(i)){const r=i.find(o=>{if(!o||typeof o!="object")return!1;const a=o.orderId;return typeof a=="string"&&a.trim().length>0});if(r?.orderId)return r.orderId.trim()}const s=t.data?.orderid;return typeof s=="string"&&s.trim().length>0?s.trim():""}function oe(t,e){const n=re(e);if(!n)return;const s=u()?j.getState().executionBroker:_.getState().user?.broker??"unknown";W.getState().setLastOrderAck({orderId:n,broker:String(s).toUpperCase(),symbol:t.symbol,action:t.action,timestamp:Date.now()})}const L={getQuotes:async(t,e,n)=>u()?p("feed","quotes",{apikey:t,symbol:e,exchange:n}):(await g.post("/quotes",{apikey:t,symbol:e,exchange:n})).data,getMultiQuotes:async(t,e)=>u()?p("feed","multiquotes",{apikey:t,symbols:e}):(await g.post("/multiquotes",{apikey:t,symbols:e})).data,getHistory:async(t,e,n,i,s,r,o="api")=>u()?p("feed","history",{apikey:t,symbol:e,exchange:n,interval:i,start_date:s,end_date:r,source:o}):(await g.post("/history",{apikey:t,symbol:e,exchange:n,interval:i,start_date:s,end_date:r,source:o})).data,getDepth:async(t,e,n)=>u()?p("feed","depth",{apikey:t,symbol:e,exchange:n}):(await g.post("/depth",{apikey:t,symbol:e,exchange:n})).data,getFunds:async t=>u()?p("execution","funds",{apikey:t}):(await g.post("/funds",{apikey:t})).data,getPositions:async t=>u()?p("execution","positionbook",{apikey:t}):(await g.post("/positionbook",{apikey:t})).data,getOrders:async t=>u()?p("execution","orderbook",{apikey:t}):(await g.post("/orderbook",{apikey:t})).data,getTrades:async t=>u()?p("execution","tradebook",{apikey:t}):(await g.post("/tradebook",{apikey:t})).data,getHoldings:async t=>u()?p("execution","holdings",{apikey:t}):(await g.post("/holdings",{apikey:t})).data,placeOrder:async t=>{let e=null;if(ie(t)){const n=await se(t);if(n!=null&&n>=h&&Number(t.quantity)>n){const i={...t,splitsize:n};try{if(console.info("[Scalping] Auto-slice splitorder route",{symbol:t.symbol,exchange:t.exchange,quantity:Number(t.quantity),splitSize:n}),u()){const s=await p("execution","splitorder",i);e=R(s,n,Number(t.quantity))}else{const s=await g.post("/splitorder",i);e=R(s.data,n,Number(t.quantity))}}catch{console.warn("[Scalping] Auto-slice splitorder failed; falling back to placeorder.",{symbol:t.symbol,exchange:t.exchange,quantity:Number(t.quantity),splitSize:n}),e=null}}}return e==null&&(u()?e=await p("execution","placeorder",t):e=(await g.post("/placeorder",t)).data),e.status==="success"&&oe(t,e),e},modifyOrder:async(t,e)=>{if(u()){const i=await z();return i?p("execution","modifyorder",{apikey:i,strategy:"Scalping",orderid:t,symbol:e.symbol,exchange:e.exchange,action:e.action,product:e.product,pricetype:e.pricetype,price:e.price,quantity:e.quantity,disclosed_quantity:e.disclosed_quantity??0,trigger_price:e.trigger_price??0}):{status:"error",message:"Missing API key"}}return(await A.post("/modify_order",{orderid:t,...e})).data},cancelOrder:async t=>{if(u()){const n=await z();return n?p("execution","cancelorder",{apikey:n,strategy:"Scalping",orderid:t}):{status:"error",message:"Missing API key"}}return(await A.post("/cancel_order",{orderid:t})).data},closePosition:async(t,e,n,i)=>{if(u()){const r=await z();if(!r)return{status:"error",message:"Missing API key"};const o=P(i?.knownQuantity),a=f(i?.knownAction);if(o!=null&&(a==="BUY"||a==="SELL")){const d=a==="BUY"?"SELL":"BUY",M=await L.placeOrder({apikey:r,strategy:"Scalping",exchange:e,symbol:t,action:d,quantity:o,pricetype:"MARKET",product:w(n),price:0,trigger_price:0,disclosed_quantity:0});if(b(M.status))return{status:"success",message:"Position closed"}}const l=await L.getPositions(r);if(!b(l.status))return{status:"error",message:l.message??"Failed to fetch positions before close"};const S=(Array.isArray(l.data)?l.data:[]).filter(d=>F(d.quantity)!==0),C=f(t),x=f(e),c=w(n),y=S.filter(d=>f(d.symbol)===C),k=y.filter(d=>f(d.exchange)===x),N=k.filter(d=>w(d.product)===c),U=N.length>0?N:k.length>0?k:y;if(!U.length)return{status:"success",message:"No open position to close"};const Y=await Promise.allSettled(U.map(d=>{const M=F(d.quantity),v=Math.abs(M),X=M>0?"SELL":"BUY";return L.placeOrder({apikey:r,strategy:"Scalping",exchange:d.exchange||e,symbol:d.symbol||t,action:X,quantity:v,pricetype:"MARKET",product:w(d.product??n),price:0,trigger_price:0,disclosed_quantity:0})}));let O=0;for(const d of Y)(d.status!=="fulfilled"||!b(d.value.status))&&(O+=1);return O>0?{status:"error",message:`Failed to close ${O} position leg(s)`}:{status:"success",message:"Position closed"}}return(await A.post("/close_position",{symbol:t,exchange:e,product:n})).data},closeAllPositions:async t=>{if(u()){const n=await z();if(!n)return{status:"error",message:"Missing API key"};const i=t?.verify!==!1,s=typeof t?.verifyDelayMs=="number"&&Number.isFinite(t.verifyDelayMs)?Math.max(0,Math.floor(t.verifyDelayMs)):120,r=async()=>{const l=await L.getPositions(n);if(!b(l.status))return{status:"error",message:l.message??"Failed to fetch positions before close-all"};const S=(Array.isArray(l.data)?l.data:[]).filter(c=>F(c.quantity)!==0);if(!S.length)return{status:"success",message:"No open positions to close"};const C=await Promise.allSettled(S.map(c=>{const y=F(c.quantity),k=Math.abs(y),N=y>0?"SELL":"BUY";return L.placeOrder({apikey:n,strategy:"Scalping",exchange:c.exchange,symbol:c.symbol,action:N,quantity:k,pricetype:"MARKET",product:w(c.product),price:0,trigger_price:0,disclosed_quantity:0})}));let x=0;for(const c of C)(c.status!=="fulfilled"||!b(c.value.status))&&(x+=1);return x>0?{status:"error",message:`Failed to close ${x} position(s)`}:{status:"success",message:"All positions closed"}};let o="";try{const l=await p("execution","closeposition",{apikey:n,strategy:"Scalping"});if(b(l.status)){if(!i)return{status:"success",message:l.message??"Close-all request submitted"};await new Promise(S=>setTimeout(S,s));const m=await r();return b(m.status)?{status:"success",message:l.message??m.message??"All positions closed"}:m}o=String(l.message??"").trim()}catch(l){l instanceof Error&&(o=l.message)}const a=await r();return b(a.status)?a:o&&a.message?{status:"error",message:`${o}. ${a.message}`}:a}return(await A.post("/close_all_positions",{})).data},cancelAllOrders:async()=>{if(u()){const e=await z();return e?p("execution","cancelallorder",{apikey:e,strategy:"Scalping"}):{status:"error",message:"Missing API key"}}return(await A.post("/cancel_all_orders",{})).data},getScalpingBridgePending:async(t,e=50)=>(await g.post("/scalpingbridge/pending",{apikey:t,limit:e})).data,ackScalpingBridgeEntries:async(t,e)=>{const n=e.map(s=>Number(s)).filter(s=>Number.isInteger(s)&&s>0);return(await g.post("/scalpingbridge/ack",{apikey:t,ids:n})).data}};export{L as t,W as u};
