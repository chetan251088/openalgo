import{A as E,C as b,E as c,G as r,H as a,w as u,d as S,z as A}from"./index-CqJWD5ZF.js";const f={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:20},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}};function I(t){if(typeof t=="string"){const e=t.toUpperCase();if(e in f)return e}return"NIFTY"}const w=E()(b(t=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,lastOrderAck:null,setUnderlying:e=>{const n=f[e];t({underlying:e,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:e=>t(n=>n.expiry===e?n:{expiry:e,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:e=>t(n=>n.expiryWeek===e?n:{expiryWeek:e}),setExpiries:e=>t(n=>n.expiries.length===e.length&&n.expiries.every((o,i)=>o===e[i])?n:{expiries:e}),setChainStrikeCount:e=>t(n=>{const o=Math.max(5,e);return n.chainStrikeCount===o?n:{chainStrikeCount:o}}),setSelectedStrike:e=>t(n=>n.selectedStrike===e?n:{selectedStrike:e}),setActiveSide:e=>t({activeSide:e}),toggleActiveSide:()=>t(e=>({activeSide:e.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(e,n)=>t(o=>o.selectedCESymbol===e&&o.selectedPESymbol===n?o:{selectedCESymbol:e,selectedPESymbol:n}),setOptionChainSnapshot:(e,n,o)=>t(i=>{const l=Number.isFinite(n)?n:Date.now(),s=typeof o=="boolean"?o:i.optionChainIsStreaming;return i.optionChainData===e&&i.optionChainLastUpdate===l&&i.optionChainIsStreaming===s?i:{optionChainData:e,optionChainLastUpdate:l,optionChainIsStreaming:s}}),clearOptionChainSnapshot:()=>t(e=>e.optionChainData===null&&e.optionChainLastUpdate===0&&!e.optionChainIsStreaming?e:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:e=>t({quantity:Math.max(1,e)}),incrementQuantity:()=>t(e=>({quantity:e.quantity+1})),decrementQuantity:()=>t(e=>({quantity:Math.max(1,e.quantity-1)})),setOrderType:e=>t({orderType:e,...e==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:e=>t({product:e}),setTpPoints:e=>t({tpPoints:Math.max(0,e)}),setSlPoints:e=>t({slPoints:Math.max(0,e)}),setLimitPrice:e=>t(n=>n.limitPrice===e?n:{limitPrice:e}),setPendingEntryAction:e=>t(n=>n.pendingEntryAction===e?n:{pendingEntryAction:e}),setPendingLimitPlacement:e=>t(n=>{if(e===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const o={...e,createdAt:e.createdAt??Date.now()},i=n.pendingLimitPlacement;return i&&i.symbol===o.symbol&&i.side===o.side&&i.action===o.action&&i.orderId===o.orderId&&i.quantity===o.quantity&&i.entryPrice===o.entryPrice&&i.tpPoints===o.tpPoints&&i.slPoints===o.slPoints?n:{pendingLimitPlacement:o}}),clearPendingLimitPlacement:()=>t(e=>e.pendingLimitPlacement===null?e:{pendingLimitPlacement:null}),setPaperMode:e=>t(n=>n.paperMode===e?n:{paperMode:e}),setControlTab:e=>t({controlTab:e}),setHotkeysEnabled:e=>t({hotkeysEnabled:e}),setShowFloatingWidget:e=>t({showFloatingWidget:e}),toggleFloatingWidget:()=>t(e=>({showFloatingWidget:!e.showFloatingWidget})),setFloatingWidgetMinimized:e=>t(n=>n.floatingWidgetMinimized===e?n:{floatingWidgetMinimized:e}),toggleFloatingWidgetMinimized:()=>t(e=>({floatingWidgetMinimized:!e.floatingWidgetMinimized})),setChainCollapsed:e=>t({chainCollapsed:e}),setControlCollapsed:e=>t({controlCollapsed:e}),setCeWidgetPos:e=>t({ceWidgetPos:e}),setPeWidgetPos:e=>t({peWidgetPos:e}),setLotSize:e=>t({lotSize:e}),setChartInterval:e=>t({chartInterval:e}),addSessionPnl:e=>t(n=>({sessionPnl:n.sessionPnl+e})),incrementTradeCount:()=>t(e=>({tradeCount:e.tradeCount+1})),setLastOrderAck:e=>t(n=>{if(e===null)return n.lastOrderAck===null?n:{lastOrderAck:null};const o={...e,timestamp:e.timestamp??Date.now()},i=n.lastOrderAck;return i&&i.orderId===o.orderId&&i.broker===o.broker&&i.symbol===o.symbol&&i.action===o.action?n:{lastOrderAck:o}}),clearLastOrderAck:()=>t(e=>e.lastOrderAck===null?e:{lastOrderAck:null}),resetSession:()=>t({sessionPnl:0,tradeCount:0,lastOrderAck:null})}),{name:"openalgo-scalping",partialize:t=>({underlying:t.underlying,expiryWeek:t.expiryWeek,chainStrikeCount:t.chainStrikeCount,quantity:t.quantity,orderType:t.orderType,product:t.product,tpPoints:t.tpPoints,slPoints:t.slPoints,paperMode:t.paperMode,hotkeysEnabled:t.hotkeysEnabled,showFloatingWidget:t.showFloatingWidget,floatingWidgetMinimized:t.floatingWidgetMinimized,chartInterval:t.chartInterval,ceWidgetPos:t.ceWidgetPos,peWidgetPos:t.peWidgetPos}),merge:(t,e)=>{const n=t??{},o=I(n.underlying??e.underlying),i=f[o];return{...e,...n,underlying:o,optionExchange:i.optionExchange,indexExchange:i.indexExchange,lotSize:i.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,lastOrderAck:null}}}));function P(t){const e=String(t??"").toUpperCase();return e==="MIS"||e==="NRML"||e==="CNC"?e:"MIS"}async function g(){const t=S.getState().apiKey;if(t)return t;try{const n=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(n.status==="success"&&n.api_key)return S.getState().setApiKey(n.api_key),n.api_key}catch{}return null}function M(t){const e=t.orderid;if(typeof e=="string"&&e.trim().length>0)return e.trim();const n=t.data?.orderid;return typeof n=="string"&&n.trim().length>0?n.trim():""}function N(t,e){const n=M(e);if(!n)return;const i=r()?A.getState().executionBroker:S.getState().user?.broker??"unknown";w.getState().setLastOrderAck({orderId:n,broker:String(i).toUpperCase(),symbol:t.symbol,action:t.action,timestamp:Date.now()})}const h={getQuotes:async(t,e,n)=>r()?a("feed","quotes",{apikey:t,symbol:e,exchange:n}):(await c.post("/quotes",{apikey:t,symbol:e,exchange:n})).data,getMultiQuotes:async(t,e)=>r()?a("feed","multiquotes",{apikey:t,symbols:e}):(await c.post("/multiquotes",{apikey:t,symbols:e})).data,getHistory:async(t,e,n,o,i,l,s="api")=>r()?a("feed","history",{apikey:t,symbol:e,exchange:n,interval:o,start_date:i,end_date:l,source:s}):(await c.post("/history",{apikey:t,symbol:e,exchange:n,interval:o,start_date:i,end_date:l,source:s})).data,getDepth:async(t,e,n)=>r()?a("feed","depth",{apikey:t,symbol:e,exchange:n}):(await c.post("/depth",{apikey:t,symbol:e,exchange:n})).data,getFunds:async t=>r()?a("execution","funds",{apikey:t}):(await c.post("/funds",{apikey:t})).data,getPositions:async t=>r()?a("execution","positionbook",{apikey:t}):(await c.post("/positionbook",{apikey:t})).data,getOrders:async t=>r()?a("execution","orderbook",{apikey:t}):(await c.post("/orderbook",{apikey:t})).data,getTrades:async t=>r()?a("execution","tradebook",{apikey:t}):(await c.post("/tradebook",{apikey:t})).data,getHoldings:async t=>r()?a("execution","holdings",{apikey:t}):(await c.post("/holdings",{apikey:t})).data,placeOrder:async t=>{let e;return r()?e=await a("execution","placeorder",t):e=(await c.post("/placeorder",t)).data,e.status==="success"&&N(t,e),e},modifyOrder:async(t,e)=>{if(r()){const o=await g();return o?a("execution","modifyorder",{apikey:o,strategy:"Scalping",orderid:t,symbol:e.symbol,exchange:e.exchange,action:e.action,product:e.product,pricetype:e.pricetype,price:e.price,quantity:e.quantity,disclosed_quantity:e.disclosed_quantity??0,trigger_price:e.trigger_price??0}):{status:"error",message:"Missing API key"}}return(await u.post("/modify_order",{orderid:t,...e})).data},cancelOrder:async t=>{if(r()){const n=await g();return n?a("execution","cancelorder",{apikey:n,strategy:"Scalping",orderid:t}):{status:"error",message:"Missing API key"}}return(await u.post("/cancel_order",{orderid:t})).data},closePosition:async(t,e,n)=>{if(r()){const i=await g();if(!i)return{status:"error",message:"Missing API key"};const l=await h.getPositions(i),p=(Array.isArray(l.data)?l.data:[]).find(m=>{const C=Number(m.quantity)||0;return m.symbol===t&&m.exchange===e&&m.product===n&&C!==0});if(!p)return{status:"success",message:"No open position to close"};const d=Number(p.quantity)||0,y=Math.abs(d);if(y<=0)return{status:"success",message:"No open position to close"};const k=d>0?"SELL":"BUY",x=await h.placeOrder({apikey:i,strategy:"Scalping",exchange:e,symbol:t,action:k,quantity:y,pricetype:"MARKET",product:P(n),price:0,trigger_price:0,disclosed_quantity:0});return{status:x.status,message:x.message}}return(await u.post("/close_position",{symbol:t,exchange:e,product:n})).data},closeAllPositions:async()=>{if(r()){const e=await g();if(!e)return{status:"error",message:"Missing API key"};const n=await h.getPositions(e),i=(Array.isArray(n.data)?n.data:[]).filter(s=>(Number(s.quantity)||0)!==0);if(!i.length)return{status:"success",message:"No open positions to close"};let l=0;for(const s of i){const p=Number(s.quantity)||0,d=Math.abs(p);if(d<=0)continue;const y=p>0?"SELL":"BUY";(await h.placeOrder({apikey:e,strategy:"Scalping",exchange:s.exchange,symbol:s.symbol,action:y,quantity:d,pricetype:"MARKET",product:P(s.product),price:0,trigger_price:0,disclosed_quantity:0})).status!=="success"&&(l+=1)}return l>0?{status:"error",message:`Failed to close ${l} position(s)`}:{status:"success",message:"All positions closed"}}return(await u.post("/close_all_positions",{})).data},cancelAllOrders:async()=>{if(r()){const e=await g();return e?a("execution","cancelallorder",{apikey:e,strategy:"Scalping"}):{status:"error",message:"Missing API key"}}return(await u.post("/cancel_all_orders",{})).data},getScalpingBridgePending:async(t,e=50)=>(await c.post("/scalpingbridge/pending",{apikey:t,limit:e})).data,ackScalpingBridgeEntries:async(t,e)=>{const n=e.map(i=>Number(i)).filter(i=>Number.isInteger(i)&&i>0);return(await c.post("/scalpingbridge/ack",{apikey:t,ids:n})).data}};export{h as t,w as u};
