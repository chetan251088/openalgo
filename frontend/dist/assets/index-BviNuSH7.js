import{r as d,j as s}from"./vendor-react-BsSNOS8Q.js";import{c as ze,a2 as _n,a6 as Bn,d as je,E as Tt,e as Ee,u as Bs,M as Ht,B as be,w as Ye,t as es}from"./index-DXDxuD1W.js";import{b7 as Pr}from"./vendor-icons-BJR3KiwM.js";import{u as qs}from"./useQuery-jLmewn9u.js";import{S as zt,a as Vt,b as _t,c as Bt,d as Nt}from"./select-B8Fx4XgN.js";import{o as Gs,u as jr}from"./useOptionChainLive-QI043bdq.js";import{q as Ks,K as Ws,W as Us,R as Hs,n as ct,h as et}from"./lightweight-charts.production-fmEoZjtL.js";import{t as he}from"./trading-DT2FQUYJ.js";import{a as Ys}from"./useMarketStatus-CxSKdq-S.js";import{I as ut}from"./input-DxB1XAze.js";import{L as Ue}from"./label-BadmYA26.js";import{S as qt}from"./switch-CH63JdZG.js";import{a as Nr,r as wr,b as Er,c as Cr}from"./ai-scalper-BCj3g-Tx.js";import{u as kr}from"./useLivePrice-ChbgDv_P.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function Ne(e,t="Assertion error"){if(!e)throw Error(t)}function Mt({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function On(e,t){return t.sort(e==="horizontal"?Tr:Lr)}function Tr(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function Lr(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function Zs(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function Xs(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Mr({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:c,y:l}=Xs(r,o),u=e==="horizontal"?c:l;u<a&&(a=u,i=o)}return Ne(i,"No rect found"),i}let nn;function Ir(){return nn===void 0&&(typeof matchMedia=="function"?nn=!!matchMedia("(pointer:coarse)").matches:nn=!1),nn}function Qs(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=On(n,Array.from(t.children).filter(Zs).map(p=>({element:p}))).map(({element:p})=>p),o=[];let c=!1,l,u=[];for(const p of a)if(p.hasAttribute("data-panel")){const m=r.find(g=>g.element===p);if(m){if(l){const g=l.element.getBoundingClientRect(),b=p.getBoundingClientRect();let h;if(c){const f=n==="horizontal"?new DOMRect(g.right,g.top,0,g.height):new DOMRect(g.left,g.bottom,g.width,0),w=n==="horizontal"?new DOMRect(b.left,b.top,0,b.height):new DOMRect(b.left,b.top,b.width,0);switch(u.length){case 0:{h=[f,w];break}case 1:{const N=u[0],P=Mr({orientation:n,rects:[g,b],targetRect:N.element.getBoundingClientRect()});h=[N,P===g?w:f];break}default:{h=u;break}}}else u.length?h=u:h=[n==="horizontal"?new DOMRect(g.right,b.top,b.left-g.right,b.height):new DOMRect(b.left,g.bottom,b.width,b.top-g.bottom)];for(const f of h){let w="width"in f?f:f.element.getBoundingClientRect();const N=Ir()?37:27;if(w.width<N){const P=N-w.width;w=new DOMRect(w.x-P/2,w.y,w.width+P,w.height)}if(w.height<N){const P=N-w.height;w=new DOMRect(w.x,w.y-P/2,w.width,w.height+P)}o.push({group:e,groupSize:Mt({group:e}),panels:[l,m],separator:"width"in f?void 0:f,rect:w})}}c=!1,l=m,u=[]}}else if(p.hasAttribute("data-separator")){const m=i.find(g=>g.element===p);m?u.push(m):(l=void 0,u=[])}else c=!0;return o}function Rr(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function Ar(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function $r(e){return e/100*window.innerHeight}function Or(e){return e/100*window.innerWidth}function Fr(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function sn({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=Fr(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=Ar(t,i);break}case"em":{r=Rr(t,i);break}case"vh":{r=$r(i);break}case"vw":{r=Or(i);break}}return r}function Ze(e){return parseFloat(e.toFixed(3))}function ts(e){const{panels:t}=e,n=Mt({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const p=sn({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=Ze(p/n*100)}let c;if(a.defaultSize!==void 0){const p=sn({groupSize:n,panelElement:i,styleProp:a.defaultSize});c=Ze(p/n*100)}let l=0;if(a.minSize!==void 0){const p=sn({groupSize:n,panelElement:i,styleProp:a.minSize});l=Ze(p/n*100)}let u=100;if(a.maxSize!==void 0){const p=sn({groupSize:n,panelElement:i,styleProp:a.maxSize});u=Ze(p/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:c,minSize:l,maxSize:u,panelId:r.id}})}class Dr{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let c=0;c<o.length;c++){const l=o[c];try{l.call(null,n)}catch(u){a===null&&(i=!0,a=u)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function $e(e,t,n=0){return Math.abs(Ze(e)-Ze(t))<=n}let We={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const gt=new Dr;function Ve(){return We}function Fe(e){const t=typeof e=="function"?e(We):e;if(We===t)return We;const n=We;return We={...We,...t},t.cursorFlags!==void 0&&gt.emit("cursorFlagsChange",We.cursorFlags),t.interactionState!==void 0&&gt.emit("interactionStateChange",We.interactionState),t.mountedGroups!==void 0&&(We.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const c=$e(a.collapsedSize,r.layout[a.panelId]),l=$e(a.collapsedSize,o[a.panelId]);c&&!l&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),gt.emit("mountedGroupsChange",We.mountedGroups)),We}function zr(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=Xs(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function Vr(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function _r(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:rs(e),b:rs(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;Ne(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:ss(ns(n.a)),b:ss(ns(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let c=a.length;for(;c--;){const l=a[c];if(l===o.a)return 1;if(l===o.b)return-1}}return Math.sign(i.a-i.b)}const Br=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function qr(e){const t=getComputedStyle(Js(e)??e).display;return t==="flex"||t==="inline-flex"}function Gr(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||qr(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||Br.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function ns(e){let t=e.length;for(;t--;){const n=e[t];if(Ne(n,"Missing node"),Gr(n))return n}return null}function ss(e){return e&&Number(getComputedStyle(e).zIndex)||0}function rs(e){const t=[];for(;e;)t.push(e),e=Js(e);return t}function Js(e){const{parentNode:t}=e;return Vr(t)?t.host:t}function Kr(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function Wr({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!Zs(n)||n.contains(e)||e.contains(n))return!0;if(_r(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(Kr(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function qn(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=Qs(i),o=zr(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&Wr({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function Ur(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function Yt(e,t){return $e(e,t)?0:e>t?1:-1}function Lt({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(Yt(t,a)<0)if(r){const o=(n+a)/2;Yt(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=Ze(t),t}function Zt({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if($e(e,0))return t;const o=Object.values(t),c=Object.values(i),l=[...o],[u,p]=r;Ne(u!=null,"Invalid first pivot index"),Ne(p!=null,"Invalid second pivot index");let m=0;if(a==="keyboard"){{const h=e<0?p:u,f=n[h];Ne(f,`Panel constraints not found for index ${h}`);const{collapsedSize:w=0,collapsible:N,minSize:P=0}=f;if(N){const k=o[h];if(Ne(k!=null,`Previous layout not found for panel index ${h}`),$e(k,w)){const R=P-k;Yt(R,Math.abs(e))>0&&(e=e<0?0-R:R)}}}{const h=e<0?u:p,f=n[h];Ne(f,`No panel constraints found for index ${h}`);const{collapsedSize:w=0,collapsible:N,minSize:P=0}=f;if(N){const k=o[h];if(Ne(k!=null,`Previous layout not found for panel index ${h}`),$e(k,P)){const R=k-w;Yt(R,Math.abs(e))>0&&(e=e<0?0-R:R)}}}}{const h=e<0?1:-1;let f=e<0?p:u,w=0;for(;;){const P=o[f];Ne(P!=null,`Previous layout not found for panel index ${f}`);const k=Lt({panelConstraints:n[f],size:100})-P;if(w+=k,f+=h,f<0||f>=n.length)break}const N=Math.min(Math.abs(e),Math.abs(w));e=e<0?0-N:N}{let h=e<0?u:p;for(;h>=0&&h<n.length;){const f=Math.abs(e)-Math.abs(m),w=o[h];Ne(w!=null,`Previous layout not found for panel index ${h}`);const N=w-f,P=Lt({panelConstraints:n[h],size:N});if(!$e(w,P)&&(m+=w-P,l[h]=P,m.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?h--:h++}}if(Ur(c,l))return i;{const h=e<0?p:u,f=o[h];Ne(f!=null,`Previous layout not found for panel index ${h}`);const w=f+m,N=Lt({panelConstraints:n[h],size:w});if(l[h]=N,!$e(N,w)){let P=w-N,k=e<0?p:u;for(;k>=0&&k<n.length;){const R=l[k];Ne(R!=null,`Previous layout not found for panel index ${k}`);const O=R+P,F=Lt({panelConstraints:n[k],size:O});if($e(R,F)||(P-=F-R,l[k]=F),$e(P,0))break;e>0?k--:k++}}}const g=Object.values(l).reduce((h,f)=>f+h,0);if(!$e(g,100,.1))return i;const b=Object.keys(i);return l.reduce((h,f,w)=>(h[b[w]]=f,h),{})}function yt(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||Yt(e[n],t[n])!==0)return!1;return!0}function bt({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,c)=>o+c,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!$e(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const c=n[o];Ne(c!=null,`No layout data found for index ${o}`);const l=100/r*c;n[o]=l}let i=0;for(let o=0;o<t.length;o++){const c=n[o];Ne(c!=null,`No layout data found for index ${o}`);const l=Lt({panelConstraints:t[o],size:c});c!=l&&(i+=c-l,n[o]=l)}if(!$e(i,0))for(let o=0;o<t.length;o++){const c=n[o];Ne(c!=null,`No layout data found for index ${o}`);const l=c+i,u=Lt({panelConstraints:t[o],size:l});if(c!==u&&(i-=u-c,n[o]=u,$e(i,0)))break}const a=Object.keys(e);return n.reduce((o,c,l)=>(o[a[l]]=c,o),{})}function er({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:c}=Ve();for(const[l,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:m,separatorToPanels:g}]of c)if(l.id===e)return{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:l,layout:m,separatorToPanels:g};throw Error(`Group ${e} not found`)},r=()=>{const c=n().derivedPanelConstraints.find(l=>l.panelId===t);if(c!==void 0)return c;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const c=n().group.panels.find(l=>l.id===t);if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const c=n().layout[t];if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},o=c=>{const l=a();if(c===l)return;const{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:m,layout:g,separatorToPanels:b}=n(),h=m.panels.findIndex(P=>P.id===t),f=h===m.panels.length-1,w=Zt({delta:f?l-c:c-l,initialLayout:g,panelConstraints:p,pivotIndices:f?[h-1,h]:[h,h+1],prevLayout:g,trigger:"imperative-api"}),N=bt({layout:w,panelConstraints:p});yt(g,N)||Fe(P=>({mountedGroups:new Map(P.mountedGroups).set(m,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:N,separatorToPanels:b})}))};return{collapse:()=>{const{collapsible:c,collapsedSize:l}=r(),{mutableValues:u}=i(),p=a();c&&p!==l&&(u.expandToSize=p,o(l))},expand:()=>{const{collapsible:c,collapsedSize:l,minSize:u}=r(),{mutableValues:p}=i(),m=a();if(c&&m===l){let g=p.expandToSize??u;g===0&&(g=1),o(g)}},getSize:()=>{const{group:c}=n(),l=a(),{element:u}=i(),p=c.orientation==="horizontal"?u.offsetWidth:u.offsetHeight;return{asPercentage:l,inPixels:p}},isCollapsed:()=>{const{collapsible:c,collapsedSize:l}=r(),u=a();return c&&$e(l,u)},resize:c=>{if(a()!==c){let l;switch(typeof c){case"number":{const{group:u}=n(),p=Mt({group:u});l=Ze(c/p*100);break}case"string":{l=parseFloat(c);break}}o(l)}}}}function is(e){if(e.defaultPrevented)return;const{mountedGroups:t}=Ve(),n=qn(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(c=>c.panelConstraints.defaultSize!==void 0);if(o){const c=o.panelConstraints.defaultSize,l=er({groupId:a.group.id,panelId:o.id});l&&c!==void 0&&(l.resize(c),e.preventDefault())}}})}function pn(e){const{mountedGroups:t}=Ve();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function tr({groupId:e}){const t=()=>{const{mountedGroups:n}=Ve();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:c}=t(),l=bt({layout:n,panelConstraints:i});return r?o:(yt(o,l)||Fe(u=>({mountedGroups:new Map(u.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:l,separatorToPanels:c})})),l)}}}function nr(e){const{mountedGroups:t}=Ve(),n=t.get(e);return Ne(n,`Mounted Group ${e.id} not found`),n}function xt(e,t){const n=pn(e),r=nr(n),i=n.separators.find(p=>p.element===e);Ne(i,"Matching separator not found");const a=r.separatorToPanels.get(i);Ne(a,"Matching panels not found");const o=a.map(p=>n.panels.indexOf(p)),c=tr({groupId:n.id}).getLayout(),l=Zt({delta:t,initialLayout:c,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:c,trigger:"keyboard"}),u=bt({layout:l,panelConstraints:r.derivedPanelConstraints});yt(c,u)||Fe(p=>({mountedGroups:new Map(p.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:u,separatorToPanels:r.separatorToPanels})}))}function as(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=pn(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&xt(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&xt(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&xt(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&xt(t,-5);break}case"End":{e.preventDefault(),xt(t,100);break}case"Enter":{e.preventDefault();const r=pn(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=nr(r),c=r.separators.find(m=>m.element===t);Ne(c,"Matching separator not found");const l=o.get(c);Ne(l,"Matching panels not found");const u=l[0],p=i.find(m=>m.panelId===u.id);if(Ne(p,"Panel metadata not found"),p.collapsible){const m=a[u.id],g=p.collapsedSize===m?r.inMemoryLastExpandedPanelSizes[u.id]??p.minSize:p.collapsedSize;xt(t,g-m)}break}case"F6":{e.preventDefault();const r=pn(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);Ne(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),xt(t,-100);break}}}function os(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=Ve(),n=qn(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let c=!1;n.forEach(l=>{r.add(l.group),l.panels.forEach(p=>{i.add(p)}),l.separator&&(a.add(l.separator),c||(c=!0,l.separator.element.focus()));const u=t.get(l.group);u&&o.set(l.group,u.layout)}),Fe({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const Hr=e=>e,Cn=()=>{},sr=1,rr=2,ir=4,ar=8,ls=3,cs=12;let rn;function us(){return rn===void 0&&(rn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(rn=!0)),rn}function Yr({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&us()){const a=(e&sr)!==0,o=(e&rr)!==0,c=(e&ir)!==0,l=(e&ar)!==0;if(a)return c?"se-resize":l?"ne-resize":"e-resize";if(o)return c?"sw-resize":l?"nw-resize":"w-resize";if(c)return"s-resize";if(l)return"n-resize"}break}}return us()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const ds=new WeakMap;function Gn(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=ds.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=Ve();switch(i.state){case"active":case"hover":{const a=Yr({cursorFlags:r,groups:i.hitRegions.map(c=>c.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}ds.set(e,{prevStyle:t,styleSheet:n})}function or({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let c=0;const l=new Map(i);n.forEach(p=>{const{group:m,groupSize:g}=p,{disableCursor:b,orientation:h,panels:f}=m;let w=0;a?h==="horizontal"?w=(t.clientX-a.x)/g*100:w=(t.clientY-a.y)/g*100:h==="horizontal"?w=t.clientX<0?-100:100:w=t.clientY<0?-100:100;const N=r.get(m),{defaultLayoutDeferred:P,derivedPanelConstraints:k,layout:R,separatorToPanels:O}=i.get(m)??{defaultLayoutDeferred:!1};if(k&&N&&R&&O){const F=Zt({delta:w,initialLayout:N,panelConstraints:k,pivotIndices:p.panels.map(G=>f.indexOf(G)),prevLayout:R,trigger:"mouse-or-touch"});if(yt(F,R)){if(w!==0&&!b)switch(h){case"horizontal":{c|=w<0?sr:rr;break}case"vertical":{c|=w<0?ir:ar;break}}}else{l.set(p.group,{defaultLayoutDeferred:P,derivedPanelConstraints:k,layout:F,separatorToPanels:O});const G=p.group.panels.map(({id:I})=>I).join(",");p.group.inMemoryLayouts[G]=F}}});let u=0;t.movementX===0?u|=o&ls:u|=c&ls,t.movementY===0?u|=o&cs:u|=c&cs,Fe({cursorFlags:u,mountedGroups:l}),Gn(e)}function ps(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=Ve();n.state==="active"&&or({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function ms(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=Ve();switch(n.state){case"active":{if(e.buttons===0){Fe(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),Fe(i=>({mountedGroups:new Map(i.mountedGroups)}));return}or({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=qn(e,r);i.length===0?n.state!=="inactive"&&Fe({interactionState:{state:"inactive"}}):Fe({interactionState:{hitRegions:i,state:"hover"}}),Gn(e.currentTarget);break}}}function fs(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=Ve();t.state==="active"&&(Fe({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(Gn(e.currentTarget),Fe(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function xs(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=Ze(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=Ze((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function Zr(e,t,n){if(!n[0])return;const r=e.panels.find(l=>l.element===t);if(!r||!r.onResize)return;const i=Mt({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,c={asPercentage:Ze(a/i*100),inPixels:a};r.mutableValues.prevSize=c,r.onResize(c,r.id,o)}function Xr(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function Qr(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const wt=new Map;function Jr(e){let t=!0;Ne(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(h=>{for(const f of h){const{borderBoxSize:w,target:N}=f;if(N===e.element){if(t){if(Mt({group:e})===0)return;Fe(P=>{const k=P.mountedGroups.get(e);if(k){const R=ts(e),O=k.defaultLayoutDeferred?xs(R):k.layout,F=bt({layout:O,panelConstraints:R});return!k.defaultLayoutDeferred&&yt(O,F)&&Xr(k.derivedPanelConstraints,R)?P:{mountedGroups:new Map(P.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:R,layout:F,separatorToPanels:k.separatorToPanels})}}return P})}}else Zr(e,N,w)}});a.observe(e.element),e.panels.forEach(h=>{Ne(!r.has(h.id),`Panel ids must be unique; id "${h.id}" was used more than once`),r.add(h.id),h.onResize&&a.observe(h.element)});const o=Mt({group:e}),c=ts(e),l=e.panels.map(({id:h})=>h).join(",");let u=e.defaultLayout;u&&(Qr(e.panels,u)||(u=void 0));const p=e.inMemoryLayouts[l]??u??xs(c),m=bt({layout:p,panelConstraints:c}),g=Qs(e),b=e.element.ownerDocument;return Fe(h=>{const f=new Map;return wt.set(b,(wt.get(b)??0)+1),g.forEach(w=>{w.separator&&f.set(w.separator,w.panels)}),{mountedGroups:new Map(h.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:c,layout:m,separatorToPanels:f})}}),e.separators.forEach(h=>{Ne(!i.has(h.id),`Separator ids must be unique; id "${h.id}" was used more than once`),i.add(h.id),h.element.addEventListener("keydown",as)}),wt.get(b)===1&&(b.addEventListener("dblclick",is,!0),b.addEventListener("pointerdown",os,!0),b.addEventListener("pointerleave",ps),b.addEventListener("pointermove",ms),b.addEventListener("pointerup",fs,!0)),function(){t=!1,wt.set(b,Math.max(0,(wt.get(b)??0)-1)),Fe(h=>{const f=new Map(h.mountedGroups);return f.delete(e),{mountedGroups:f}}),e.separators.forEach(h=>{h.element.removeEventListener("keydown",as)}),wt.get(b)||(b.removeEventListener("dblclick",is,!0),b.removeEventListener("pointerdown",os,!0),b.removeEventListener("pointerleave",ps),b.removeEventListener("pointermove",ms),b.removeEventListener("pointerup",fs,!0)),a.disconnect()}}function lr(){const[e,t]=d.useState({}),n=d.useCallback(()=>t({}),[]);return[e,n]}function Kn(e){const t=d.useId();return`${e??t}`}const St=typeof window<"u"?d.useLayoutEffect:d.useEffect;function Wt(e){const t=d.useRef(e);return St(()=>{t.current=e},[e]),d.useCallback((...n)=>t.current?.(...n),[t])}function Wn(...e){return Wt(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function ei(e){const t=d.useRef({...e});return St(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const cr=d.createContext(null);function ti(e,t){const n=d.useRef({getLayout:()=>({}),setLayout:Hr});d.useImperativeHandle(t,()=>n.current,[]),St(()=>{Object.assign(n.current,tr({groupId:e}))})}function ur({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:c,onLayoutChange:l,onLayoutChanged:u,orientation:p="horizontal",style:m,...g}){const b=d.useRef({onLayoutChange:{},onLayoutChanged:{}}),h=Wt(_=>{yt(b.current.onLayoutChange,_)||(b.current.onLayoutChange=_,l?.(_))}),f=Wt(_=>{yt(b.current.onLayoutChanged,_)||(b.current.onLayoutChanged=_,u?.(_))}),w=Kn(c),N=d.useRef(null),[P,k]=lr(),R=d.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),O=Wn(N,a);ti(w,o);const F=Wt((_,U)=>{const{interactionState:E,mountedGroups:K}=Ve();for(const M of K.keys())if(M.id===_){const H=K.get(M);if(H){let v=!1;return E.state==="active"&&(v=E.hitRegions.some(T=>T.group===M)),{flexGrow:H.layout[U]??1,pointerEvents:v?"none":void 0}}}return{flexGrow:n?.[U]??1}}),G=d.useMemo(()=>({getPanelStyles:F,id:w,orientation:p,registerPanel:_=>{const U=R.current;return U.panels=On(p,[...U.panels,_]),k(),()=>{U.panels=U.panels.filter(E=>E!==_),k()}},registerSeparator:_=>{const U=R.current;return U.separators=On(p,[...U.separators,_]),k(),()=>{U.separators=U.separators.filter(E=>E!==_),k()}}}),[F,w,k,p]),I=ei({defaultLayout:n,disableCursor:r}),C=d.useRef(null);return St(()=>{const _=N.current;if(_===null)return;const U=R.current,E={defaultLayout:I.defaultLayout,disableCursor:!!I.disableCursor,disabled:!!i,element:_,id:w,inMemoryLastExpandedPanelSizes:R.current.lastExpandedPanelSizes,inMemoryLayouts:R.current.layouts,orientation:p,panels:U.panels,separators:U.separators};C.current=E;const K=Jr(E),M=Ve().mountedGroups.get(E);if(M){const{defaultLayoutDeferred:T,derivedPanelConstraints:Z,layout:V}=M;!T&&Z.length>0&&(h(V),f(V),U.panels.forEach(q=>{q.scheduleUpdate()}))}const H=gt.addListener("interactionStateChange",()=>{U.panels.forEach(T=>{T.scheduleUpdate()})}),v=gt.addListener("mountedGroupsChange",T=>{const Z=T.get(E);if(Z){const{defaultLayoutDeferred:V,derivedPanelConstraints:q,layout:y}=Z;if(V||q.length===0)return;const{interactionState:$}=Ve(),x=$.state!=="active";h(y),x&&f(y),U.panels.forEach(D=>{D.scheduleUpdate()})}});return()=>{C.current=null,K(),H(),v()}},[i,w,f,h,p,P,I]),d.useEffect(()=>{const _=C.current;_&&(_.defaultLayout=n,_.disableCursor=!!r)}),s.jsx(cr.Provider,{value:G,children:s.jsx("div",{...g,"aria-orientation":p,className:t,"data-group":!0,"data-testid":w,id:w,ref:O,style:{height:"100%",width:"100%",overflow:"hidden",...m,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}ur.displayName="Group";function Un(){const e=d.useContext(cr);return Ne(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function ni(e,t){const{id:n}=Un(),r=d.useRef({collapse:Cn,expand:Cn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Cn});d.useImperativeHandle(t,()=>r.current,[]),St(()=>{Object.assign(r.current,er({groupId:n,panelId:e}))})}function dr({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:c="100%",minSize:l="0%",onResize:u,panelRef:p,style:m,...g}){const b=!!o,h=Kn(o),f=d.useRef(null),w=Wn(f,a),[,N]=lr(),{getPanelStyles:P,id:k,registerPanel:R}=Un(),O=u!==null,F=Wt((I,C,_)=>{u?.(I,o,_)});St(()=>{const I=f.current;if(I!==null)return R({element:I,id:h,idIsStable:b,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:O?F:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:c,minSize:l},scheduleUpdate:N})},[n,r,i,N,O,h,b,c,l,F,R]),ni(h,p);const G=P(k,h);return s.jsx("div",{...g,"data-panel":!0,"data-testid":h,id:h,ref:w,style:{...si,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...G},children:s.jsx("div",{className:t,style:{flexGrow:1,...m},children:e})})}dr.displayName="Panel";const si={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function ri({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],c=t.find(l=>l.panelId===n);if(c){const l=c.maxSize,u=a=c.collapsible?c.collapsedSize:c.minSize,p=[r,r+1];a=bt({layout:Zt({delta:u-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=bt({layout:Zt({delta:l-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function pr({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=Kn(r),[c,l]=d.useState({}),[u,p]=d.useState("inactive"),m=d.useRef(null),g=Wn(m,n),{id:b,orientation:h,registerSeparator:f}=Un(),w=h==="horizontal"?"vertical":"horizontal";return St(()=>{const N=m.current;if(N!==null){const P={element:N,id:o},k=f(P),R=gt.addListener("interactionStateChange",F=>{p(F.state!=="inactive"&&F.hitRegions.some(G=>G.separator===P)?F.state:"inactive")}),O=gt.addListener("mountedGroupsChange",F=>{F.forEach(({derivedPanelConstraints:G,layout:I,separatorToPanels:C},_)=>{if(_.id===b){const U=C.get(P);if(U){const E=U[0],K=_.panels.indexOf(E);l(ri({layout:I,panelConstraints:G,panelId:E.id,panelIndex:K}))}}})});return()=>{R(),O(),k()}}},[b,o,f]),s.jsx("div",{...a,"aria-controls":c.valueControls,"aria-orientation":w,"aria-valuemax":c.valueMax,"aria-valuemin":c.valueMin,"aria-valuenow":c.valueNow,children:e,className:t,"data-separator":u,"data-testid":o,id:o,ref:g,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}pr.displayName="Separator";function Fn({className:e,...t}){return s.jsx(ur,{"data-slot":"resizable-panel-group",className:ze("h-full w-full",e),...t})}function ht({className:e,...t}){return s.jsx(dr,{"data-slot":"resizable-panel",className:ze("min-w-0 min-h-0",e),...t})}function fn({withHandle:e,className:t,...n}){return s.jsx(pr,{"data-slot":"resizable-handle",className:ze("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(Pr,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Dn={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:20},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}};function ii(e){if(typeof e=="string"){const t=e.toUpperCase();if(t in Dn)return t}return"NIFTY"}const S=_n()(Bn(e=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,setUnderlying:t=>{const n=Dn[t];e({underlying:t,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:t=>e(n=>n.expiry===t?n:{expiry:t,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:t=>e(n=>n.expiryWeek===t?n:{expiryWeek:t}),setExpiries:t=>e(n=>n.expiries.length===t.length&&n.expiries.every((r,i)=>r===t[i])?n:{expiries:t}),setChainStrikeCount:t=>e(n=>{const r=Math.max(5,t);return n.chainStrikeCount===r?n:{chainStrikeCount:r}}),setSelectedStrike:t=>e(n=>n.selectedStrike===t?n:{selectedStrike:t}),setActiveSide:t=>e({activeSide:t}),toggleActiveSide:()=>e(t=>({activeSide:t.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(t,n)=>e(r=>r.selectedCESymbol===t&&r.selectedPESymbol===n?r:{selectedCESymbol:t,selectedPESymbol:n}),setOptionChainSnapshot:(t,n,r)=>e(i=>{const a=Number.isFinite(n)?n:Date.now(),o=typeof r=="boolean"?r:i.optionChainIsStreaming;return i.optionChainData===t&&i.optionChainLastUpdate===a&&i.optionChainIsStreaming===o?i:{optionChainData:t,optionChainLastUpdate:a,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>e(t=>t.optionChainData===null&&t.optionChainLastUpdate===0&&!t.optionChainIsStreaming?t:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:t=>e({quantity:Math.max(1,t)}),incrementQuantity:()=>e(t=>({quantity:t.quantity+1})),decrementQuantity:()=>e(t=>({quantity:Math.max(1,t.quantity-1)})),setOrderType:t=>e({orderType:t,...t==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:t=>e({product:t}),setTpPoints:t=>e({tpPoints:Math.max(0,t)}),setSlPoints:t=>e({slPoints:Math.max(0,t)}),setLimitPrice:t=>e(n=>n.limitPrice===t?n:{limitPrice:t}),setPendingEntryAction:t=>e(n=>n.pendingEntryAction===t?n:{pendingEntryAction:t}),setPendingLimitPlacement:t=>e(n=>{if(t===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const r={...t,createdAt:t.createdAt??Date.now()},i=n.pendingLimitPlacement;return i&&i.symbol===r.symbol&&i.side===r.side&&i.action===r.action&&i.orderId===r.orderId&&i.quantity===r.quantity&&i.entryPrice===r.entryPrice&&i.tpPoints===r.tpPoints&&i.slPoints===r.slPoints?n:{pendingLimitPlacement:r}}),clearPendingLimitPlacement:()=>e(t=>t.pendingLimitPlacement===null?t:{pendingLimitPlacement:null}),setPaperMode:t=>e(n=>n.paperMode===t?n:{paperMode:t}),setControlTab:t=>e({controlTab:t}),setHotkeysEnabled:t=>e({hotkeysEnabled:t}),setShowFloatingWidget:t=>e({showFloatingWidget:t}),toggleFloatingWidget:()=>e(t=>({showFloatingWidget:!t.showFloatingWidget})),setFloatingWidgetMinimized:t=>e(n=>n.floatingWidgetMinimized===t?n:{floatingWidgetMinimized:t}),toggleFloatingWidgetMinimized:()=>e(t=>({floatingWidgetMinimized:!t.floatingWidgetMinimized})),setChainCollapsed:t=>e({chainCollapsed:t}),setControlCollapsed:t=>e({controlCollapsed:t}),setCeWidgetPos:t=>e({ceWidgetPos:t}),setPeWidgetPos:t=>e({peWidgetPos:t}),setLotSize:t=>e({lotSize:t}),setChartInterval:t=>e({chartInterval:t}),addSessionPnl:t=>e(n=>({sessionPnl:n.sessionPnl+t})),incrementTradeCount:()=>e(t=>({tradeCount:t.tradeCount+1})),resetSession:()=>e({sessionPnl:0,tradeCount:0})}),{name:"openalgo-scalping",partialize:e=>({underlying:e.underlying,expiryWeek:e.expiryWeek,chainStrikeCount:e.chainStrikeCount,quantity:e.quantity,orderType:e.orderType,product:e.product,tpPoints:e.tpPoints,slPoints:e.slPoints,paperMode:e.paperMode,hotkeysEnabled:e.hotkeysEnabled,showFloatingWidget:e.showFloatingWidget,floatingWidgetMinimized:e.floatingWidgetMinimized,chartInterval:e.chartInterval,ceWidgetPos:e.ceWidgetPos,peWidgetPos:e.peWidgetPos}),merge:(e,t)=>{const n=e??{},r=ii(n.underlying??t.underlying),i=Dn[r];return{...t,...n,underlying:r,optionExchange:i.optionExchange,indexExchange:i.indexExchange,lotSize:i.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}}})),ai=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],oi=[10,15,20,25,30],kn="__none__",li=[{value:"auto",label:"Auto (Z->D)"},{value:"zerodha",label:"Zerodha"},{value:"dhan",label:"Dhan"}],ci=[{value:"kotak",label:"Kotak"},{value:"dhan",label:"Dhan"},{value:"zerodha",label:"Zerodha"}];function ui(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function di({liveOpenPnl:e,isLivePnl:t=!1}){const n=je(E=>E.apiKey),r=je(E=>E.user?.broker),i=Tt(E=>E.unifiedMode),a=Tt(E=>E.dataFeed),o=Tt(E=>E.executionBroker),c=Tt(E=>E.setDataFeed),l=Tt(E=>E.setExecutionBroker),u=S(E=>E.underlying),p=S(E=>E.optionExchange),m=S(E=>E.expiryWeek),g=S(E=>E.expiry),b=S(E=>E.expiries),h=S(E=>E.chainStrikeCount),f=S(E=>E.paperMode),w=S(E=>E.sessionPnl),N=S(E=>E.tradeCount),P=S(E=>E.setUnderlying),k=S(E=>E.setExpiryWeek),R=S(E=>E.setExpiry),O=S(E=>E.setExpiries),F=S(E=>E.setChainStrikeCount),G=S(E=>E.setPaperMode),I=f?w:e??w,C=g&&b.includes(g)?g:kn,{data:_}=qs({queryKey:["scalping-expiries",u,p],queryFn:()=>Gs.getExpiries(n,u,p),enabled:!!n,staleTime:300*1e3});d.useEffect(()=>{if(_?.status!=="success")return;const E=_.data??[];if(ui(b,E)||O(E),E.length===0){g&&R("");return}if(!g||!E.includes(g)){const K=m==="next"?Math.min(1,E.length-1):0,M=E[K],H=K<=0?"current":"next";g!==M&&R(M),m!==H&&k(H)}},[_,m,b,g,O,R,k]);const U=E=>{if(E===kn)return;g!==E&&R(E);const M=b.indexOf(E)<=0?"current":"next";m!==M&&k(M)};return s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(zt,{value:u,onValueChange:E=>P(E),children:[s.jsx(Vt,{className:"h-7 w-[128px] text-xs font-semibold",children:s.jsx(_t,{})}),s.jsx(Bt,{children:ai.map(E=>s.jsx(Nt,{value:E,children:E},E))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(zt,{value:C,onValueChange:U,disabled:b.length===0,children:[s.jsx(Vt,{className:"h-7 w-[122px] text-xs font-mono",children:s.jsx(_t,{placeholder:"Select expiry"})}),s.jsxs(Bt,{children:[s.jsx(Nt,{value:kn,disabled:!0,children:"Select expiry"}),b.map(E=>s.jsx(Nt,{value:E,children:E},E))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(zt,{value:String(h),onValueChange:E=>F(Number(E)),children:[s.jsx(Vt,{className:"h-7 w-[94px] text-xs",children:s.jsx(_t,{})}),s.jsx(Bt,{children:oi.map(E=>s.jsx(Nt,{value:String(E),children:E},E))})]})]}),s.jsx("div",{className:"flex-1"}),i&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Feed"}),s.jsxs(zt,{value:a,onValueChange:E=>c(E),children:[s.jsx(Vt,{className:"h-7 w-[118px] text-xs",children:s.jsx(_t,{})}),s.jsx(Bt,{children:li.map(E=>s.jsx(Nt,{value:E.value,children:E.label},E.value))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Exec"}),s.jsxs(zt,{value:o,onValueChange:E=>l(E),children:[s.jsx(Vt,{className:"h-7 w-[96px] text-xs",children:s.jsx(_t,{})}),s.jsx(Bt,{children:ci.map(E=>s.jsx(Nt,{value:E.value,children:E.label},E.value))})]})]})]}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${f?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>G(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${f?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>G(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),i?s.jsxs(Ee,{variant:"outline",className:"text-xs h-6",children:["EXEC: ",o.toUpperCase()]}):r&&s.jsx(Ee,{variant:"outline",className:"text-xs h-6",children:r}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${I>0?"text-green-500":I<0?"text-red-500":"text-foreground"}`,children:[I>=0?"+":"",I.toFixed(0)]}),!f&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),N>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",N,")"]})]})]})}function an(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function hs({value:e,prevRef:t,className:n,format:r="price"}){const i=d.useRef(null);d.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const c=e>t.current?"flash-green":"flash-red";o.classList.add(c);const l=setTimeout(()=>o.classList.remove(c),300);return t.current=e,()=>clearTimeout(l)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:ze("tabular-nums transition-colors",n),children:a})}function on({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:ze("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function pi(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const mi=d.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:c,onSelectStrike:l,onSelectCE:u,onSelectPE:p}){const m=d.useRef(n?.ltp??0),g=d.useRef(r?.ltp??0),b=Math.min(((n?.oi??0)/o+(n?.volume??0)/c)/2*100,100),h=Math.min(((r?.oi??0)/o+(r?.volume??0)/c)/2*100,100);return s.jsxs("div",{className:ze("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(on,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:an(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(on,{value:n?.volume??0,max:c,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:an(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${b}%`}}),s.jsx(hs,{value:n?.ltp,prevRef:m,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:ze("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>l(t,n?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${h}%`}}),s.jsx(hs,{value:r?.ltp,prevRef:g,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(on,{value:r?.volume??0,max:c,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:an(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(on,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:an(r?.oi)})]})]})},pi);function gs(e){return(e??"").replace(/-/g,"").toUpperCase()}function fi(){const e=je(M=>M.apiKey),t=S(M=>M.underlying),n=S(M=>M.indexExchange),r=S(M=>M.optionExchange),i=S(M=>M.expiry),a=S(M=>M.selectedStrike),o=S(M=>M.selectedCESymbol),c=S(M=>M.selectedPESymbol),l=S(M=>M.chainStrikeCount),u=S(M=>M.setSelectedStrike),p=S(M=>M.setSelectedSymbols),m=S(M=>M.setActiveSide),g=S(M=>M.setLotSize),b=S(M=>M.setOptionChainSnapshot),h=d.useRef(null),f=d.useRef(null),w=d.useRef(!1),{data:N,isLoading:P,isStreaming:k,error:R,streamingSymbols:O,lastUpdate:F}=jr(e,t,n,r,i,l,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});d.useEffect(()=>{N&&b(N,F?.getTime()??Date.now(),k)},[N,F,k,b]),d.useEffect(()=>{if(!N?.chain?.length||(N.underlying??"").toUpperCase()!==t.toUpperCase()||i&&gs(N.expiry_date)!==gs(i)||w.current)return;let M=null;for(const H of N.chain){const v=Number(H.ce?.lotsize);if(Number.isFinite(v)&&v>0){M=v;break}const T=Number(H.pe?.lotsize);if(Number.isFinite(T)&&T>0){M=T;break}}M!==null&&(g(M),w.current=!0)},[N,g]),d.useEffect(()=>{w.current=!1},[t,i]),d.useEffect(()=>{if(N?.chain&&f.current&&h.current){const M=h.current,H=f.current,v=M.getBoundingClientRect(),T=H.getBoundingClientRect(),Z=T.top-v.top-v.height/2+T.height/2;M.scrollTop+=Z}},[N?.atm_strike]);const G=d.useCallback((M,H,v)=>{u(M),p(H,v)},[u,p]),I=d.useCallback((M,H)=>{H&&(u(M),p(H,c),m("CE"))},[c,m,u,p]),C=d.useCallback((M,H)=>{H&&(u(M),p(o,H),m("PE"))},[o,m,u,p]),{maxOI:_,maxVol:U}=d.useMemo(()=>{if(!N?.chain?.length)return{maxOI:1,maxVol:1};let M=0,H=0;for(const v of N.chain)v.ce?.oi&&v.ce.oi>M&&(M=v.ce.oi),v.pe?.oi&&v.pe.oi>M&&(M=v.pe.oi),v.ce?.volume&&v.ce.volume>H&&(H=v.ce.volume),v.pe?.volume&&v.pe.volume>H&&(H=v.pe.volume);return{maxOI:M||1,maxVol:H||1}},[N?.chain]),E=N?.underlying_ltp,K=N?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(Ee,{variant:"outline",className:"text-[10px] h-4 px-1",children:[l," strikes"]}),E!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:E.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[k&&s.jsxs(Ee,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),O]}),P&&s.jsx(Ee,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:h,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[R&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:R}),!R&&!P&&N?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),N?.chain?.map(M=>{const H=M.strike===K;return s.jsx("div",{ref:H?f:void 0,children:s.jsx(mi,{strike:M.strike,ce:M.ce,pe:M.pe,isATM:H,isSelected:M.strike===a,maxOI:_,maxVol:U,onSelectStrike:G,onSelectCE:I,onSelectPE:C})},M.strike)})]})]})}function xi({positions:e,totalPnl:t,isLivePnl:n}){const r=S(o=>o.activeSide),i=S(o=>o.hotkeysEnabled),a=S(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:""}),s.jsx("span",{children:"CE Mkt Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:""}),s.jsx("span",{children:"PE Mkt Buy"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const It=300*60+1800,ys=1440*60,Gt=540*60+900,bs=900*60+1800;function xn(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function mr(e){const t=xn(e)+It,n=Math.floor(t/ys)*ys,r=t-n,i=(n-It)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function hi(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),c=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(c))return null;const l=Date.UTC(n,r-1,i,a,o,c)-It*1e3;return Math.floor(l/1e3)}function gi(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-It*1e3;return Math.floor(a/1e3)}function tt(e){if(typeof e=="number")return xn(e);const t=gi(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return xn(r);const i=hi(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function Hn(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=mr(e);if(r===0||r===6)return!1;const i=n>=Gt,a=t.includeClose?n<=bs:n<bs;return i&&a}function yi(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=mr(e),a=i<=Gt?Gt:Gt+Math.floor((i-Gt)/n)*n;return r+a-It}function fr(e){const t=(xn(e)+It)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function bi(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?yi(i,n):Math.floor(i/n)*n,c=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:c},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+c},!1]}function xr({symbol:e,exchange:t,intervalSec:n=1,enabled:r=!0,useIndiaMarketHours:i=!1,maxCandles:a=500,onCandleUpdate:o}){const c=d.useRef([]),l=d.useRef(null),u=d.useRef(null),p=d.useRef(o);p.current=o;const m=r&&e?[{symbol:e,exchange:t}]:[],{data:g,isConnected:b}=Ys({symbols:m,mode:"LTP",enabled:r&&!!e});d.useEffect(()=>{if(!r||!e||g.size===0)return;const N=`${t}:${e}`,P=g.get(N);if(!P?.data?.ltp)return;const k=P.lastUpdate;if(!k||!Number.isFinite(k))return;const R=Math.floor(k/1e3);if(i&&!Hn(R))return;const O=`${N}:${k}`;if(u.current===O)return;u.current=O;const F={price:P.data.ltp,volume:P.data.volume,timestamp:k},[G,I]=bi(F,l.current,n,{alignToIndiaSession:i});I&&l.current&&(c.current.push(l.current),c.current.length>a&&(c.current=c.current.slice(-a))),l.current=G,p.current?.(G,I)},[g,e,t,n,r,a,i]);const h=d.useCallback(()=>{const N=[...c.current];return l.current&&N.push(l.current),N},[]),f=d.useCallback(()=>{c.current=[],l.current=null,u.current=null},[]),w=d.useCallback(N=>{if(!N?.length){c.current=[],l.current=null;return}const P=N.slice(-a);if(P.length===1){c.current=[],l.current=P[0];return}c.current=P.slice(0,-1),l.current=P[P.length-1]},[a]);return{getCandles:h,reset:f,seed:w,isConnected:b}}function hn(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function hr(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=vi(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const c=e.length-r.length;let l=0,u=0,p=1;for(let m=0;m<r.length;m++){const g=e[c+m],b=(g.high+g.low)/2,h=r[m].value;let f=b+n*h,w=b-n*h;m>0&&(w>u||e[c+m-1].close<u||(w=u),f<l||e[c+m-1].close>l||(f=l));let N=p;m>0&&(p===1&&g.close<w?N=-1:p===-1&&g.close>f&&(N=1));const P=g.time;i.push({time:P,value:f}),a.push({time:P,value:w}),o.push({time:P,value:N===1?w:f}),l=f,u=w,p=N}return{upper:i,lower:a,trend:o}}function vi(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,c=e[a].low,l=e[a-1].close;r.push(Math.max(o-c,Math.abs(o-l),Math.abs(c-l)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function gr(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}function Si(e){return!Number.isFinite(e)||e<=0?1:e}function Pi(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const n=Math.ceil(e/t)*t;return Math.max(t*2,n)}function yr(e,t){const n=Si(e),r=Pi(t,n);return i=>{const a=i(),o=a?.priceRange;if(!a||!o)return a;const c=o.minValue,l=o.maxValue;if(!Number.isFinite(c)||!Number.isFinite(l))return a;const u=Math.min(c,l),p=Math.max(c,l),m=(u+p)/2;let g=p-u;(!Number.isFinite(g)||g<n)&&(g=n),g<r&&(g=r),g=Math.ceil(g/n)*n;const b=g/2,h=Math.floor((m-b)/n)*n;let f=Math.ceil((m+b)/n)*n;return f-h<g&&(f=h+g),{...a,priceRange:{minValue:h,maxValue:f}}}}const ji=120,Rt=500,Ni=1,wi=50,Ei=200;function ln(e){return e.map(t=>({time:t.time,value:t.value}))}function Ci(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function ki(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function vs(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Me(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Yn(e){const t=tt(e);return t??null}function Ti(e){if(!e?.length)return[];const t=[];for(const a of e){const o=tt(a.timestamp)??tt(a.time)??tt(a.datetime)??tt(a.date),c=Me(a.open),l=Me(a.high),u=Me(a.low),p=Me(a.close),m=Me(a.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:m})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-Rt),i=r.filter(a=>Hn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-Rt)}function Et(e){return e.map(t=>({...t}))}function Li(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-Rt)}function Tn(e){const t=[];for(const n of e){const r=Yn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Ss(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=Yn(n.time),i=Me(n.open),a=Me(n.high),o=Me(n.low),c=Me(n.close),l=Me(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-Rt)}function Mi({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=d.useRef(null),a=d.useRef(null),o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),m=d.useRef([]),g=d.useRef(new Map),b=d.useRef(null),h=d.useRef(0),f=d.useRef(null),w=d.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),N=je(v=>v.apiKey),P=je(v=>v.setApiKey),k=Bs(v=>v.mode==="dark"),R=S(v=>v.underlying),O=S(v=>v.indexExchange),F=S(v=>v.chartInterval),G=d.useCallback(()=>{const v=m.current,T=w.current,Z=v.map(V=>({time:V.time,value:V.close}));c.current&&c.current.setData(T.showEma9?ln(hn(Z,9)):[]),l.current&&l.current.setData(T.showEma21?ln(hn(Z,21)):[]),u.current&&u.current.setData(T.showSupertrend?ln(hr(v,10,3).trend):[]),p.current&&p.current.setData(T.showVwap?ln(gr(v)):[])},[]),I=d.useCallback(()=>{f.current===null&&(f.current=setTimeout(()=>{f.current=null,G()},ji))},[G]),C=d.useCallback(()=>{m.current=[],o.current?.setData([]),c.current?.setData([]),l.current?.setData([]),u.current?.setData([]),p.current?.setData([])},[]),_=d.useCallback(v=>{const T=Ss(v);m.current=Et(T),o.current?.setData(Tn(T)),I()},[I]),U=d.useCallback(async()=>{if(N)return N;try{const T=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(T.status==="success"&&T.api_key)return P(T.api_key),T.api_key}catch{}return null},[N,P]),E=d.useCallback((v,T)=>{if(!o.current)return;const Z=Yn(v.time),V=Me(v.open),q=Me(v.high),y=Me(v.low),$=Me(v.close),x=Me(v.volume)??0;if(Z==null||V==null||q==null||y==null||$==null)return;const D={time:Z,open:V,high:q,low:y,close:$,volume:x},B=Number(D.time),X=m.current.length?Number(m.current[m.current.length-1].time):null;if(X!=null&&Number.isFinite(X)&&Number.isFinite(B)&&B<X)return;try{o.current.update({time:D.time,open:D.open,high:D.high,low:D.low,close:D.close})}catch{const ee=Ss([...m.current,D]);m.current=ee,o.current.setData(Tn(ee)),I();return}T?(m.current.push(D),m.current.length>Rt&&(m.current=m.current.slice(-Rt))):m.current.length>0?m.current[m.current.length-1]=D:m.current.push(D);const Q=b.current;Q&&g.current.set(Q,Et(m.current)),I()},[I]),{isConnected:K,reset:M,seed:H}=xr({symbol:R,exchange:O,intervalSec:F,enabled:!!R,useIndiaMarketHours:!0,onCandleUpdate:E});return d.useEffect(()=>{const v=b.current;if(v&&m.current.length>0&&g.current.set(v,Et(m.current)),!R){b.current=null,M(),C();return}const T=`${O}:${R}:${F}`;b.current=T;const Z=g.current.get(T);if(Z&&Z.length>0){M(),H(Z),_(Z);return}M(),C();const V=++h.current,q=ki(F),y=new Date,$=new Date(y.getTime());$.setDate($.getDate()-Ni),(async()=>{const D=await U();if(!D){V===h.current&&C();return}try{const B=async()=>{try{const L=await he.getQuotes(D,R,O);if(L.status!=="success"||!L.data)return null;const ne=Me(L.data.ltp);if(ne==null||ne<=0)return null;const ve=Math.floor(Date.now()/1e3);return{time:Math.floor(ve/F)*F,open:ne,high:ne,low:ne,close:ne,volume:Me(L.data.volume)??0}}catch{return null}},X=async L=>{try{const ne=await he.getHistory(D,R,O,q,vs($),vs(y),L);return ne.status==="success"?Ti(ne.data):[]}catch{return[]}},Q=await X("api"),ee=Q.length>0?Q:await X("db");if(V!==h.current)return;const te=b.current===T?Et(m.current):[],fe=Li(ee,te);if(fe.length>0){g.current.set(T,Et(fe)),H(fe),_(fe);return}const de=await B();if(de&&V===h.current){const L=[de];g.current.set(T,Et(L)),H(L),_(L);return}}catch{}V===h.current&&C()})()},[R,O,F,U,M,H,C,_]),d.useEffect(()=>{w.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},c.current?.applyOptions({visible:e}),l.current?.applyOptions({visible:t}),u.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),I()},[e,t,n,r,I]),d.useEffect(()=>{const v=i.current;if(!v)return;const T=Ci(k),Z=yr(wi,Ei),V=Ks(v,{width:v.offsetWidth,height:v.offsetHeight,layout:{background:{type:Us.Solid,color:T.bg},textColor:T.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:T.grid},horzLines:{color:T.grid}},rightPriceScale:{borderColor:T.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:T.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:X=>fr(X)},crosshair:{mode:Ws.Normal,vertLine:{width:1,color:T.crosshair,style:2},horzLine:{width:1,color:T.crosshair,style:2}}}),q=V.addSeries(Hs,{upColor:T.upColor,downColor:T.downColor,borderVisible:!1,wickUpColor:T.upColor,wickDownColor:T.downColor,autoscaleInfoProvider:Z}),y=V.addSeries(ct,{color:T.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:w.current.showEma9,autoscaleInfoProvider:Z}),$=V.addSeries(ct,{color:T.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:w.current.showEma21,autoscaleInfoProvider:Z}),x=V.addSeries(ct,{color:T.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:w.current.showSupertrend,autoscaleInfoProvider:Z}),D=V.addSeries(ct,{color:T.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:w.current.showVwap,autoscaleInfoProvider:Z});a.current=V,o.current=q,c.current=y,l.current=$,u.current=x,p.current=D,m.current.length>0&&(q.setData(Tn(m.current)),I());const B=new ResizeObserver(()=>{if(a.current&&v){const X=v.offsetWidth,Q=v.offsetHeight;X>0&&Q>0&&a.current.applyOptions({width:X,height:Q})}});return B.observe(v),()=>{f.current!==null&&(clearTimeout(f.current),f.current=null),B.disconnect(),V.remove(),a.current=null,o.current=null,c.current=null,l.current=null,u.current=null,p.current=null}},[k,I]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:R}),!K&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const re=_n()(Bn((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).filter(i=>i.symbol===n).sort((i,a)=>a.createdAt-i.createdAt)[0],addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Ps=.05;function mn(e){return Math.round(e/Ps)*Ps}function Kt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:mn(e)}async function At({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=Kt(n);if(a!=null)return a;const o=Ht.getInstance(),c=Kt(o.getCachedData(e,t)?.data?.ltp);if(c!=null)return c;const l=Kt(r);if(l!=null)return l;if(i)try{const u=await he.getQuotes(i,e,t),p=Kt(u.data?.ltp);if(p!=null)return p}catch{}return 0}function Ii(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Ri(e){return gn(e.orderid??e.order_id)}function Ai(e){const t=e.order_status??e.status??"";return String(t).trim().toUpperCase()}function $i(e){const t=[e.average_price,e.averageprice,e.fill_price,e.fillprice,e.traded_price,e.tradedprice,e.price];for(const n of t){const r=Kt(Ii(n));if(r!=null)return r}return null}function Oi(e){return new Promise(t=>{setTimeout(t,e)})}async function Pt({symbol:e,exchange:t,orderId:n=null,preferredPrice:r=null,fallbackPrice:i=null,apiKey:a=null,maxAttempts:o=5,retryDelayMs:c=250}){const l=gn(n);if(a&&l)for(let u=0;u<o;u+=1){try{const m=(await he.getOrders(a)).data?.orders;if(Array.isArray(m)){const g=m.find(b=>!b||typeof b!="object"?!1:Ri(b)===l);if(g&&typeof g=="object"){const b=g,h=Ai(b),f=$i(b),w=h.includes("COMPLETE")||h.includes("FILLED")||h.includes("EXECUTED")||h.includes("TRADED");if(f!=null&&(w||u===o-1))return f}}}catch{}u<o-1&&await Oi(c)}return At({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:i,apiKey:a})}function Xe({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:c,slPoints:l,createdAt:u=Date.now(),managedBy:p="manual",autoEntryScore:m,autoEntryReason:g}){const b=mn(a),h=Number(Math.max(0,c||0).toFixed(2)),f=Number(Math.max(0,l||0).toFixed(2)),w=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:b,quantity:o,tpPrice:h>0?mn(b+(w?h:-h)):null,slPrice:f>0?mn(b+(w?-f:f)):null,tpPoints:h,slPoints:f,createdAt:u,managedBy:p,autoEntryScore:m,autoEntryReason:g}}function gn(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function vt(e){if(!e||typeof e!="object")return null;const t=e,n=gn(t.orderid??t.order_id),r=t.data;if(!r||typeof r!="object")return n;const i=r;return gn(i.orderid??i.order_id)??n}const js=.05,Fi=150;function ke(e){return Math.round(e/js)*js}function lt(e){return Number(Math.max(0,e).toFixed(2))}function Ns(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?ke(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?ke(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function Di({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=je(j=>j.apiKey),a=je(j=>j.setApiKey),o=S(j=>j.activeSide),c=S(j=>j.orderType),l=S(j=>j.tpPoints),u=S(j=>j.slPoints),p=S(j=>j.limitPrice),m=S(j=>j.pendingEntryAction),g=S(j=>j.pendingLimitPlacement),b=S(j=>j.quantity),h=S(j=>j.lotSize),f=S(j=>j.optionExchange),w=S(j=>j.product),N=S(j=>j.paperMode),P=S(j=>j.incrementTradeCount),k=S(j=>j.setLimitPrice),R=S(j=>j.setTpPoints),O=S(j=>j.setSlPoints),F=S(j=>j.setPendingEntryAction),G=S(j=>j.setPendingLimitPlacement),I=S(j=>j.clearPendingLimitPlacement),C=S(j=>n==="CE"?j.selectedCESymbol:j.selectedPESymbol),_=re(j=>j.virtualTPSL),U=re(j=>j.triggerOrders),E=re(j=>j.addTriggerOrder),K=re(j=>j.updateTriggerOrder),M=re(j=>j.removeTriggerOrder),H=re(j=>j.setVirtualTPSL),v=re(j=>j.clearForSymbol),T=re(j=>j.updateVirtualTPSL),Z=d.useRef(null),V=d.useRef(null),q=d.useRef(null),y=d.useRef(null),$=d.useRef(null),x=d.useRef(null),D=d.useRef(null),B=d.useRef(null),[X,Q]=d.useState(null),[ee,te]=d.useState(null),[fe,de]=d.useState(null),[L,ne]=d.useState(null),[ve,Se]=d.useState(!1),ye=d.useRef(!1),Pe=d.useRef(!1),we=d.useRef(0),z=d.useRef(null),Te=d.useRef(null),Qe=d.useRef(null),Je=o===n,He=c==="LIMIT"||c==="TRIGGER",nt=d.useMemo(()=>C?Object.values(_).filter(j=>j.symbol===C).sort((j,A)=>A.createdAt-j.createdAt):[],[C,_]),Y=nt[0],oe=d.useMemo(()=>C?Object.values(U).find(j=>j.symbol===C):void 0,[C,U]),Ce=!!g&&g.symbol===C&&g.side===n,pt=Ce||p!=null,mt=Y?"position":oe?"trigger":Je&&He&&pt?"pending":null,_e=m??g?.action??"BUY";d.useEffect(()=>{if(!Y){ne(null);return}const j=Ht.getInstance(),A=j.getCachedData(Y.symbol,Y.exchange)?.data?.ltp;A&&A>0&&ne(A);const J=j.subscribe(Y.symbol,Y.exchange,"LTP",ue=>{const le=ue.data.ltp;le&&le>0&&ne(le)});return()=>J()},[Y]);const Be=d.useMemo(()=>{if(!Y||!L||L<=0)return null;const j=Y.action==="BUY"?L-Y.entryPrice:Y.entryPrice-L,A=j*Y.quantity;return{ltp:L,points:j,pnl:A}},[Y,L]),$t=d.useMemo(()=>{if(nt.length===0)return null;const j=nt.reduce((J,ue)=>J+Math.max(ue.quantity,0),0);if(j<=0)return null;const A=nt.reduce((J,ue)=>J+ue.entryPrice*Math.max(ue.quantity,0),0)/j;return ke(A)},[nt]),bn=d.useMemo(()=>{if(!Y)return"";const j=`${Y.action} Fill @ ${Y.entryPrice.toFixed(2)}`,A=$t!=null?` | Avg ${$t.toFixed(2)}`:"";if(!Be)return j;const J=Be.pnl>=0?"+":"";return`${j}${A} | PnL ${J}${Be.pnl.toFixed(2)}`},[Y,Be,$t]),ae=d.useCallback((j,A)=>{if(j.current){const J=A.current??t.current;try{J?.removePriceLine(j.current)}catch{}j.current=null,A.current=null}},[t]),Ae=d.useCallback((j,A,J,ue,le,se,me)=>{const ie=t.current;if(!ie)return;const ge="";if(j.current&&A.current&&A.current!==ie){try{A.current.removePriceLine(j.current)}catch{}j.current=null,A.current=null}j.current?j.current.applyOptions({price:J,color:ue,lineStyle:le,lineWidth:se,title:ge,axisLabelVisible:!0}):(j.current=ie.createPriceLine({price:J,color:ue,lineStyle:le,lineWidth:se,title:ge,axisLabelVisible:!0}),A.current=ie)},[t]),xe=d.useCallback(j=>{if(!t.current)return null;const A=t.current.priceToCoordinate(j);return A??null},[t]),pe=d.useCallback(()=>{const j=(A,J)=>{if(!A.current){J(null);return}const ue=A.current.options().price,le=xe(ue);if(le==null){J(null);return}J({y:le,price:ue})};j(V,Q),j(q,te),j(y,de)},[xe]),Re=d.useCallback(()=>{if(!C)return null;const A=Ht.getInstance().getCachedData(C,f)?.data?.ltp;return!A||A<=0?null:A},[C,f]),qe=d.useCallback(j=>j==="BUY"?"above":"below",[]),st=d.useCallback((j,A)=>{const J=Re();return J?j==="BUY"&&A<=J?{ok:!1,message:`BUY trigger must be above current price (${J.toFixed(2)})`}:j==="SELL"&&A>=J?{ok:!1,message:`SELL trigger must be below current price (${J.toFixed(2)})`}:{ok:!0}:{ok:!0}},[Re]),rt=d.useCallback(async()=>{if(i)return i;try{const A=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(A.status==="success"&&A.api_key)return a(A.api_key),A.api_key}catch(j){console.error("[Scalping] Failed to fetch API key:",j)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[i,a]),ot=d.useCallback(async()=>{if(Pe.current)return;const j=Te.current;if(!j)return;const A=Date.now()-we.current,J=j.force?0:Math.max(0,Fi-A);if(J>0){if(z.current!=null)return;z.current=window.setTimeout(()=>{z.current=null,ot()},J);return}Te.current=null,Pe.current=!0,we.current=Date.now();try{if(!await rt())return;await he.modifyOrder(j.orderId,{symbol:j.symbol,exchange:f,action:j.action,product:w,pricetype:"LIMIT",price:j.price,quantity:j.quantity,trigger_price:0,disclosed_quantity:0})}catch(ue){console.error("[Scalping] Failed to modify pending LIMIT order:",ue)}finally{Pe.current=!1,Te.current&&ot()}},[rt,f,w]),Xt=d.useCallback((j,A,J=!1)=>{if(N||!j.orderId)return;const ue=ke(A),le=Te.current;Te.current={orderId:j.orderId,symbol:j.symbol,action:j.action,quantity:j.quantity,price:ue,force:J||!!le?.force},J&&z.current!=null&&(window.clearTimeout(z.current),z.current=null),ot()},[N,ot]);d.useEffect(()=>()=>{z.current!=null&&(window.clearTimeout(z.current),z.current=null)},[]);const Qt=d.useCallback(async(j,A)=>{if(!C||ye.current)return!1;ye.current=!0;try{if(N){const me=await At({symbol:C,exchange:f,preferredPrice:j});return me<=0?!1:(H(Xe({symbol:C,exchange:f,side:n,action:A,entryPrice:me,quantity:b*h,tpPoints:l,slPoints:u,managedBy:"manual"})),P(),I(),F(null),k(null),!0)}const J=await rt();if(!J)return!1;const ue={apikey:J,strategy:"Scalping",exchange:f,symbol:C,action:A,quantity:b*h,pricetype:"LIMIT",product:w,price:j,trigger_price:0,disclosed_quantity:0},le=await he.placeOrder(ue);if(le.status!=="success")return console.error("[Scalping] LIMIT order rejected:",le),!1;const se=vt(le);return G({symbol:C,side:n,action:A,orderId:se,quantity:b*h,entryPrice:j,tpPoints:l,slPoints:u}),F(null),k(j),!0}catch(J){return console.error("[Scalping] LIMIT order failed:",J),!1}finally{ye.current=!1}},[C,N,f,n,b,h,l,u,w,rt,H,P,I,F,k,G]);d.useEffect(()=>{const j=e.current,A=t.current;if(!j||!A)return;if(!(Je&&He&&!Y&&!oe&&!Ce&&p==null)){ae(Z,$);return}const ue=le=>{if(!le.point){ae(Z,$);return}const se=A.coordinateToPrice(le.point.y);if(se==null){ae(Z,$);return}const me=ke(se);Ae(Z,$,me,"#a1a1aa",et.Dashed,1,me.toFixed(2))};return j.subscribeCrosshairMove(ue),()=>{j.unsubscribeCrosshairMove(ue),ae(Z,$)}},[e,t,Je,He,Y,oe,Ce,p,ae,Ae]),d.useEffect(()=>{const j=e.current,A=t.current;if(!j||!A||!C||!Je||!He)return;const J=ue=>{if(!ue.point)return;const le=A.coordinateToPrice(ue.point.y);if(le==null)return;const se=ke(le);if(c==="TRIGGER"){const me=m??oe?.action;if(!me){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const ie=st(me,se);if(!ie.ok){console.warn(`[Scalping] ${ie.message}`);return}const ge=qe(me);oe?K(oe.id,{triggerPrice:se,action:me,direction:ge,quantity:b*h,tpPoints:l,slPoints:u}):E({id:`trigger-${Date.now()}`,symbol:C,exchange:f,side:n,action:me,triggerPrice:se,direction:ge,quantity:b*h,tpPoints:l,slPoints:u,createdAt:Date.now()}),k(se),F(null)}else{if(Ce){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!m){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(Y)return;k(se),Qt(se,m)}ae(Z,$),pe()};return j.subscribeClick(J),()=>{j.unsubscribeClick(J)}},[e,t,C,Je,He,c,m,Y,oe,Ce,b,h,l,u,f,n,E,K,k,F,qe,st,Qt,ae,pe]),d.useEffect(()=>{if(!t.current)return;const j=()=>{ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null)};if(Y){const A=Y.action==="BUY"?"#00ff88":"#ff4560";Ae(V,x,ke(Y.entryPrice),A,et.Dotted,2,`${Y.action} @ ${Y.entryPrice.toFixed(2)}`),Y.tpPrice!=null?Ae(q,D,ke(Y.tpPrice),"#00ff88",et.Dashed,1,`TP @ ${Y.tpPrice.toFixed(2)}`):ae(q,D),Y.slPrice!=null?Ae(y,B,ke(Y.slPrice),"#ff4560",et.Dashed,1,`SL @ ${Y.slPrice.toFixed(2)}`):ae(y,B),pe();return}if(oe){const{tpPrice:A,slPrice:J}=Ns(oe),ue=ke(oe.triggerPrice);Ae(V,x,ue,"#ffa500",et.Dashed,2,`TRIGGER ${oe.action} @ ${ue.toFixed(2)}`),A!=null?Ae(q,D,A,"#00ff88",et.Dashed,1,`TP @ ${A.toFixed(2)}`):ae(q,D),J!=null?Ae(y,B,J,"#ff4560",et.Dashed,1,`SL @ ${J.toFixed(2)}`):ae(y,B),pe();return}if(Je&&He&&pt){const A=_e,J=Ce?g?.tpPoints??l:l,ue=Ce?g?.slPoints??u:u,le=Ce?g?.entryPrice??p:p;if(le==null){j();return}const se=ke(le);if(Ae(V,x,se,c==="LIMIT"?"#06b6d4":"#ffa500",et.Dashed,2,`${c} ${A} @ ${se.toFixed(2)}`),J>0){const ie=ke(se+(A==="BUY"?J:-J));Ae(q,D,ie,"#00ff88",et.Dashed,1,`TP @ ${ie.toFixed(2)}`)}else ae(q,D);if(ue>0){const ie=ke(se+(A==="BUY"?-ue:ue));Ae(y,B,ie,"#ff4560",et.Dashed,1,`SL @ ${ie.toFixed(2)}`)}else ae(y,B);pe();return}j()},[t,Y,oe,Je,He,pt,p,_e,g,Ce,c,l,u,ae,Ae,pe]),d.useEffect(()=>{},[Y,bn]),d.useEffect(()=>{const j=e.current;if(!j)return;const A=()=>pe();j.subscribeCrosshairMove(A);const J=j.timeScale();return J.subscribeVisibleLogicalRangeChange(A),()=>{j.unsubscribeCrosshairMove(A),J.unsubscribeVisibleLogicalRangeChange(A)}},[e,pe]),d.useEffect(()=>{const j=r.current;if(!j)return;const A=()=>{!V.current&&!q.current&&!y.current||pe()},J=window.setInterval(A,100);return j.addEventListener("wheel",A,{passive:!0}),j.addEventListener("mousemove",A),window.addEventListener("resize",A),()=>{window.clearInterval(J),j.removeEventListener("wheel",A),j.removeEventListener("mousemove",A),window.removeEventListener("resize",A)}},[r,pe]),d.useEffect(()=>{Y||oe||Ce||m==null&&(p==null&&!V.current&&!q.current&&!y.current||(ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null),k(null)))},[Y,oe,Ce,m,p,ae,k]),d.useEffect(()=>()=>{ae(Z,$),ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null)},[C,ae]),d.useEffect(()=>{c==="MARKET"&&(Y||oe||(ae(Z,$),ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null),k(null),F(null),I()))},[c,Y,oe,ae,k,F,I]);const Ot=d.useCallback((j,A)=>{if(A.preventDefault(),A.stopPropagation(),!mt||!(j==="entry"?V:j==="tp"?q:y).current)return;Qe.current={type:j,source:mt};const ue=se=>{const me=Qe.current,ie=t.current,ge=r.current;if(!me||!ie||!ge)return;const Le=ge.getBoundingClientRect(),at=se.clientY-Le.top,ft=ie.coordinateToPrice(at);if(ft==null)return;const Ge=ke(ft),jn=me.type==="entry"?V:me.type==="tp"?q:y;if(jn.current){if(me.type==="entry"?me.source==="trigger"?`${oe?.action??"BUY"}${Ge.toFixed(2)}`:me.source==="pending"?`${c}${_e}${Ge.toFixed(2)}`:me.source==="position"?`${Y?.action??_e}${Ge.toFixed(2)}`:jn.current.options().title??Ge.toFixed(2):me.type==="tp"?`${Ge.toFixed(2)}`:`${Ge.toFixed(2)}`,jn.current.applyOptions({price:Ge,title:""}),me.type==="entry"){const tn=me.source==="trigger"?oe?.action??_e:me.source==="position"?Y?.action??_e:_e,Nn=me.source==="trigger"?oe?.tpPoints??0:me.source==="position"?Y?.tpPoints??0:l,wn=me.source==="trigger"?oe?.slPoints??0:me.source==="position"?Y?.slPoints??0:u;if(Nn>0&&q.current){const En=ke(Ge+(tn==="BUY"?Nn:-Nn));q.current.applyOptions({price:En,title:""})}if(wn>0&&y.current){const En=ke(Ge+(tn==="BUY"?-wn:wn));y.current.applyOptions({price:En,title:""})}}pe()}},le=()=>{const se=Qe.current;if(!se)return;const ie=(se.type==="entry"?V:se.type==="tp"?q:y).current?.options().price;if(ie!=null){if(se.source==="position"&&Y){const ge=se.type==="entry"?{entryPrice:ie,tpPrice:Y.tpPrice!=null?ke(Y.tpPrice+(ie-Y.entryPrice)):null,slPrice:Y.slPrice!=null?ke(Y.slPrice+(ie-Y.entryPrice)):null}:se.type==="tp"?{tpPrice:ie,tpPoints:lt(Math.abs(ie-Y.entryPrice))}:se.type==="sl"?{slPrice:ie,slPoints:lt(Math.abs(Y.entryPrice-ie))}:null;ge&&T(Y.id,ge)}if(se.source==="trigger"&&oe){if(se.type==="entry"){const ge=st(oe.action,ie);if(ge.ok)K(oe.id,{triggerPrice:ie,direction:qe(oe.action)}),k(ie);else{console.warn(`[Scalping] ${ge.message}`);const Le=ke(oe.triggerPrice);V.current?.applyOptions({price:Le,title:""});const{tpPrice:at,slPrice:ft}=Ns(oe);q.current&&at!=null&&q.current.applyOptions({price:at,title:""}),y.current&&ft!=null&&y.current.applyOptions({price:ft,title:""}),k(Le)}}se.type==="tp"&&K(oe.id,{tpPoints:lt(Math.abs(ie-oe.triggerPrice))}),se.type==="sl"&&K(oe.id,{slPoints:lt(Math.abs(oe.triggerPrice-ie))})}if(se.source==="pending"){const ge=V.current?.options().price??p??ie;if(Ce&&g){const Le={...g};se.type==="entry"&&(Le.entryPrice=ie,k(ie),Xt({orderId:Le.orderId,symbol:Le.symbol,action:Le.action,quantity:Le.quantity},ie,!0)),se.type==="tp"&&(Le.tpPoints=lt(Math.abs(ie-ge))),se.type==="sl"&&(Le.slPoints=lt(Math.abs(ge-ie))),G(Le)}else se.type==="entry"&&k(ie),se.type==="tp"&&R(lt(Math.abs(ie-ge))),se.type==="sl"&&O(lt(Math.abs(ge-ie)))}}pe(),Qe.current=null,document.removeEventListener("mousemove",ue),document.removeEventListener("mouseup",le)};document.addEventListener("mousemove",ue),document.addEventListener("mouseup",le)},[mt,t,r,Y,oe,_e,c,p,Ce,g,l,u,Xt,T,K,qe,st,pe,G,k,R,O]),vn=d.useCallback(async()=>{if(Ce&&g?.orderId&&!N)try{const j=await he.cancelOrder(g.orderId);if(j.status!=="success"){console.error("[Scalping] Failed to cancel LIMIT order:",j);return}}catch(j){console.error("[Scalping] Failed to cancel LIMIT order:",j);return}ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null),Y&&v(Y.symbol),oe&&M(oe.id),Ce&&!g?.orderId&&!N&&console.warn("[Scalping] Pending LIMIT has no broker orderId; cleared local lines only."),I(),k(null),F(null)},[Y,oe,Ce,g,N,ae,v,M,I,k,F]),Jt=d.useCallback(j=>{if(ae(j==="tp"?q:y,j==="tp"?D:B),j==="tp"?te(null):de(null),Y){T(Y.id,j==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(oe){K(oe.id,j==="tp"?{tpPoints:0}:{slPoints:0});return}j==="tp"?R(0):O(0)},[Y,oe,ae,R,O,T,K]),Sn=d.useCallback(async()=>{if(!(!Y||ve)){Se(!0);try{if(N)console.log(`[Paper] Close ${Y.action} ${Y.symbol}`);else{const j=await he.closePosition(Y.symbol,Y.exchange,w);if(j.status!=="success"){console.error("[Scalping] Close position rejected:",j);return}}v(Y.symbol),ae(V,x),ae(q,D),ae(y,B),Q(null),te(null),de(null)}catch(j){console.error("[Scalping] Close position failed:",j)}finally{Se(!1)}}},[Y,ve,N,w,v,ae]);if(!r.current)return null;const it=!!Y,Ft=it?Y.action==="BUY"?"green":"red":c==="LIMIT"?"cyan":"orange",en=it?`${Y.action} @ ${X?.price.toFixed(2)??"--"}`:oe?`TRIGGER ${oe.action} @ ${X?.price.toFixed(2)??"--"}`:`${c} ${_e} @ ${X?.price.toFixed(2)??"--"}`,Pn={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[Ft],jt={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[Ft],Dt=mt!==null;return s.jsxs(s.Fragment,{children:[X&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:X.y},children:[s.jsx("div",{className:ze("absolute left-0 right-0 top-0 h-px -translate-y-1/2",jt)}),s.jsx("div",{className:ze("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",Dt?"cursor-ns-resize":"cursor-default"),onMouseDown:Dt?j=>Ot("entry",j):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:ze("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Pn),children:en}),it&&Be&&s.jsxs("span",{className:ze("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Be.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",Be.ltp.toFixed(2)," | PnL ",Be.pnl>=0?"+":"",Be.pnl.toFixed(2)]}),it&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:j=>{j.stopPropagation(),Sn()},disabled:ve,title:"Close position at market",children:ve?"...":"Close"}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:j=>{j.stopPropagation(),vn()},title:it?"Remove virtual position tracking":"Cancel pending order",children:""})]})]}),ee&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ee.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:j=>Ot("tp",j)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",ee.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:j=>{j.stopPropagation(),Jt("tp")},title:"Remove TP line",children:""})]})]}),fe&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:fe.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:j=>Ot("sl",j)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",fe.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:j=>{j.stopPropagation(),Jt("sl")},title:"Remove SL line",children:""})]})]})]})}const zi=120,Vi=1,_i=10,Bi=40;function cn(e){return e.map(t=>({time:t.time,value:t.value}))}function qi(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Gi(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function ws(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Ie(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Zn(e){const t=tt(e);return t??null}function Ki(e){if(!e?.length)return[];const t=[];for(const a of e){const o=tt(a.timestamp)??tt(a.time)??tt(a.datetime)??tt(a.date),c=Ie(a.open),l=Ie(a.high),u=Ie(a.low),p=Ie(a.close),m=Ie(a.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:m})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>Hn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function Ct(e){return e.map(t=>({...t}))}function Wi(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function Ln(e){const t=[];for(const n of e){const r=Zn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Es(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=Zn(n.time),i=Ie(n.open),a=Ie(n.high),o=Ie(n.low),c=Ie(n.close),l=Ie(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function Cs({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}){const a=d.useRef(null),o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),m=d.useRef(null),g=d.useRef([]),b=d.useRef(new Map),h=d.useRef(null),f=d.useRef(0),w=d.useRef(null),N=d.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),P=je(y=>y.apiKey),k=je(y=>y.setApiKey),R=Bs(y=>y.mode==="dark"),O=S(y=>y.activeSide),F=S(y=>y.setActiveSide),G=S(y=>y.optionExchange),I=S(y=>y.chartInterval),C=S(y=>e==="CE"?y.selectedCESymbol:y.selectedPESymbol),_=O===e,U=d.useCallback(()=>{const y=g.current,$=N.current,x=y.map(D=>({time:D.time,value:D.close}));l.current&&l.current.setData($.showEma9?cn(hn(x,9)):[]),u.current&&u.current.setData($.showEma21?cn(hn(x,21)):[]),p.current&&p.current.setData($.showSupertrend?cn(hr(y,10,3).trend):[]),m.current&&m.current.setData($.showVwap?cn(gr(y)):[])},[]),E=d.useCallback(()=>{w.current===null&&(w.current=setTimeout(()=>{w.current=null,U()},zi))},[U]),K=d.useCallback(()=>{g.current=[],c.current?.setData([]),l.current?.setData([]),u.current?.setData([]),p.current?.setData([]),m.current?.setData([])},[]),M=d.useCallback(y=>{const $=Es(y);g.current=Ct($),c.current?.setData(Ln($)),E()},[E]),H=d.useCallback(async()=>{if(P)return P;try{const $=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if($.status==="success"&&$.api_key)return k($.api_key),$.api_key}catch{}return null},[P,k]),v=d.useCallback(()=>{F(e)},[e,F]),T=d.useCallback((y,$)=>{if(!c.current)return;const x=Zn(y.time),D=Ie(y.open),B=Ie(y.high),X=Ie(y.low),Q=Ie(y.close),ee=Ie(y.volume)??0;if(x==null||D==null||B==null||X==null||Q==null)return;const te={time:x,open:D,high:B,low:X,close:Q,volume:ee},fe=Number(te.time),de=g.current.length?Number(g.current[g.current.length-1].time):null;if(de!=null&&Number.isFinite(de)&&Number.isFinite(fe)&&fe<de)return;try{c.current.update({time:te.time,open:te.open,high:te.high,low:te.low,close:te.close})}catch{const ne=Es([...g.current,te]);g.current=ne,c.current.setData(Ln(ne)),E();return}$?(g.current.push(te),g.current.length>500&&(g.current=g.current.slice(-500))):g.current.length>0?g.current[g.current.length-1]=te:g.current.push(te);const L=h.current;L&&b.current.set(L,Ct(g.current)),E()},[E]),{isConnected:Z,reset:V,seed:q}=xr({symbol:C??"",exchange:G,intervalSec:I,enabled:!!C,useIndiaMarketHours:!0,onCandleUpdate:T});return d.useEffect(()=>{const y=h.current;if(y&&g.current.length>0&&b.current.set(y,Ct(g.current)),!C){h.current=null,V(),K();return}const $=`${G}:${C}:${I}`;h.current=$;const x=b.current.get($);if(x&&x.length>0){V(),q(x),M(x);return}V(),K();const D=++f.current,B=Gi(I),X=new Date,Q=new Date(X.getTime());Q.setDate(Q.getDate()-Vi),(async()=>{const te=await H();if(!te){D===f.current&&K();return}try{const fe=async()=>{try{const Pe=await he.getQuotes(te,C,G);if(Pe.status!=="success"||!Pe.data)return null;const we=Ie(Pe.data.ltp);if(we==null||we<=0)return null;const z=Math.floor(Date.now()/1e3);return{time:Math.floor(z/I)*I,open:we,high:we,low:we,close:we,volume:Ie(Pe.data.volume)??0}}catch{return null}},de=async Pe=>{try{const we=await he.getHistory(te,C,G,B,ws(Q),ws(X),Pe);return we.status==="success"?Ki(we.data):[]}catch{return[]}},L=await de("api"),ne=L.length>0?L:await de("db");if(D!==f.current)return;const ve=h.current===$?Ct(g.current):[],Se=Wi(ne,ve);if(Se.length>0){b.current.set($,Ct(Se)),q(Se),M(Se);return}const ye=await fe();if(ye&&D===f.current){const Pe=[ye];b.current.set($,Ct(Pe)),q(Pe),M(Pe);return}}catch{}D===f.current&&K()})()},[C,G,I,H,V,q,K,M]),d.useEffect(()=>{N.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},l.current?.applyOptions({visible:t}),u.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),m.current?.applyOptions({visible:i}),E()},[t,n,r,i,E]),d.useEffect(()=>{const y=a.current;if(!y)return;const $=qi(R),x=yr(_i,Bi),D=Ks(y,{width:y.offsetWidth,height:y.offsetHeight,layout:{background:{type:Us.Solid,color:$.bg},textColor:$.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:$.grid},horzLines:{color:$.grid}},rightPriceScale:{borderColor:$.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:$.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:de=>fr(de)},crosshair:{mode:Ws.Normal,vertLine:{width:1,color:$.crosshair,style:2},horzLine:{width:1,color:$.crosshair,style:2}}}),B=D.addSeries(Hs,{upColor:$.upColor,downColor:$.downColor,borderVisible:!1,wickUpColor:$.upColor,wickDownColor:$.downColor,autoscaleInfoProvider:x}),X=D.addSeries(ct,{color:$.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma9,autoscaleInfoProvider:x}),Q=D.addSeries(ct,{color:$.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma21,autoscaleInfoProvider:x}),ee=D.addSeries(ct,{color:$.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showSupertrend,autoscaleInfoProvider:x}),te=D.addSeries(ct,{color:$.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showVwap,autoscaleInfoProvider:x});o.current=D,c.current=B,l.current=X,u.current=Q,p.current=ee,m.current=te,g.current.length>0&&(B.setData(Ln(g.current)),E());const fe=new ResizeObserver(()=>{if(o.current&&y){const de=y.offsetWidth,L=y.offsetHeight;de>0&&L>0&&o.current.applyOptions({width:de,height:L})}});return fe.observe(y),()=>{w.current!==null&&(clearTimeout(w.current),w.current=null),fe.disconnect(),D.remove(),o.current=null,c.current=null,l.current=null,u.current=null,p.current=null,m.current=null}},[R,E]),s.jsxs("div",{className:ze("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",_&&"ring-1 ring-primary/40"),onClick:v,children:[s.jsx("div",{ref:a,className:"h-full w-full"}),s.jsx(Di,{chartRef:o,seriesRef:c,side:e,containerRef:a}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:ze("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),C&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:C}),!C&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),_&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),C&&!Z&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!C&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function Ui(){const e=je(L=>L.apiKey),t=je(L=>L.setApiKey),n=S(L=>L.showFloatingWidget),r=S(L=>L.floatingWidgetMinimized),i=S(L=>L.setFloatingWidgetMinimized),a=S(L=>L.activeSide),o=S(L=>L.selectedCESymbol),c=S(L=>L.selectedPESymbol),l=S(L=>L.optionExchange),u=S(L=>L.quantity),p=S(L=>L.lotSize),m=S(L=>L.product),g=S(L=>L.tpPoints),b=S(L=>L.slPoints),h=S(L=>L.orderType),f=S(L=>L.limitPrice),w=S(L=>L.pendingLimitPlacement),N=S(L=>L.setLimitPrice),P=S(L=>L.setPendingEntryAction),k=S(L=>L.setPendingLimitPlacement),R=S(L=>L.clearPendingLimitPlacement),O=S(L=>L.paperMode),F=re(L=>L.setVirtualTPSL),G=re(L=>L.clearForSymbol),I=re(L=>L.triggerOrders),C=re(L=>L.removeTriggerOrder),_=S(L=>L.ceWidgetPos),U=S(L=>L.setCeWidgetPos),E=S(L=>L.incrementQuantity),K=S(L=>L.decrementQuantity),M=S(L=>L.setTpPoints),H=S(L=>L.setSlPoints),v=S(L=>L.incrementTradeCount),T=a==="CE"?o:c,[Z,V]=d.useState(!1),[q,y]=d.useState(null),[$,x]=d.useState(null),D=d.useRef(null),B=d.useRef(null);d.useEffect(()=>{if(!T){y(null),x(null);return}const ne=Ht.getInstance().subscribe(T,l,"LTP",ve=>{const Se=ve.data.ltp;Se!=null&&Se>0&&(x(q),y(Se))});return()=>{ne()}},[T,l]);const X=d.useCallback(L=>{if(L.target.closest("button, input"))return;L.preventDefault(),D.current={startX:L.clientX,startY:L.clientY,origX:_.x,origY:_.y};const ne=Se=>{if(!D.current)return;const ye=Se.clientX-D.current.startX,Pe=Se.clientY-D.current.startY;U({x:Math.max(0,D.current.origX+ye),y:Math.max(0,D.current.origY+Pe)})},ve=()=>{D.current=null,document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",ve)};document.addEventListener("mousemove",ne),document.addEventListener("mouseup",ve)},[_,U]),Q=d.useCallback(async()=>{if(e)return e;try{const ne=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(ne.status==="success"&&ne.api_key)return t(ne.api_key),ne.api_key}catch(L){console.error("[Scalping] Failed to fetch API key:",L)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),ee=d.useCallback(async L=>{if(!T||Z){T||console.warn("[Scalping] No symbol selected  click a strike first");return}if(V(!0),h==="TRIGGER"){const ye=Object.values(I).find(Pe=>Pe.symbol===T&&Pe.exchange===l&&Pe.side===a);ye&&C(ye.id),R(),N(null),P(L),console.log(`[Scalping] TRIGGER armed (${L})  click chart to place trigger line`),V(!1);return}if(h==="LIMIT"&&!f){P(L),console.log(`[Scalping] LIMIT armed (${L})  click chart to set limit line`),V(!1);return}if(h==="LIMIT"&&w&&w.symbol===T&&w.side===a){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),V(!1);return}if(O){if(console.log(`[Paper] ${L} ${a} ${T} qty=${u*p} @ ${h}`),h==="MARKET"||h==="LIMIT"){const ye=await At({symbol:T,exchange:l,preferredPrice:h==="LIMIT"?f??q??void 0:q??void 0});ye>0&&(F(Xe({symbol:T,exchange:l,side:a,action:L,entryPrice:ye,quantity:u*p,tpPoints:g,slPoints:b,managedBy:"manual"})),h==="LIMIT"&&N(null))}R(),v(),V(!1);return}const ne=await Q();if(!ne){V(!1);return}const ve=h==="LIMIT"?"LIMIT":"MARKET",Se={apikey:ne,strategy:"Scalping",exchange:l,symbol:T,action:L,quantity:u*p,pricetype:ve,product:m,price:h==="LIMIT"&&f?f:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${L} ${T} qty=${u*p} ${ve}`);const ye=await he.placeOrder(Se);if(ye.status==="success"){const Pe=vt(ye);if(console.log(`[Scalping] Order placed: ${L} ${T} id=${Pe??"n/a"}`),P(null),ve==="LIMIT"){const we=f??q??0;we<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state."),k({symbol:T,side:a,action:L,orderId:Pe,quantity:u*p,entryPrice:we,tpPoints:g,slPoints:b}),we>0&&N(we),V(!1);return}if(R(),v(),ve==="MARKET"){const we=await Pt({symbol:T,exchange:l,orderId:Pe,preferredPrice:q??void 0,apiKey:ne});we>0&&F(Xe({symbol:T,exchange:l,side:a,action:L,entryPrice:we,quantity:u*p,tpPoints:g,slPoints:b,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",ye)}catch(ye){console.error("[Scalping] Order failed:",ye)}V(!1)},[T,a,u,p,l,m,h,f,w,g,b,O,G,I,Z,q,Q,v,k,F,C,N,P,R]),te=d.useCallback(async()=>{if(!T||Z)return;if(V(!0),O){console.log(`[Paper] Reversal ${a} ${T}`),v(),V(!1);return}const L=await Q();if(!L){V(!1);return}try{const ne={apikey:L,strategy:"Scalping",exchange:l,symbol:T,action:"SELL",quantity:u*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await he.placeOrder(ne);const ve={apikey:L,strategy:"Scalping",exchange:l,symbol:T,action:"SELL",quantity:u*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await he.placeOrder(ve),console.log(`[Scalping] Reversed ${a} ${T}`),v()}catch(ne){console.error("[Scalping] Reversal failed:",ne)}V(!1)},[T,a,u,p,l,m,O,Z,Q,v]),fe=d.useCallback(async()=>{if(T){if(O){console.log(`[Paper] Close ${a} ${T}`),G(T),N(null),P(null),R();return}try{const L=await he.closePosition(T,l,m);L.status==="success"?(console.log(`[Scalping] Closed ${a} ${T}`),G(T),N(null),P(null),R()):console.error("[Scalping] Close rejected:",L)}catch(L){console.error("[Scalping] Close failed:",L)}}},[T,a,l,m,O,G,N,P,R]);if(!n||!T)return null;const de=q&&$?q>$?"up":q<$?"down":"flat":"flat";return r?s.jsx("div",{ref:B,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:_.x,top:_.y},children:s.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[s.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:T.slice(-10)}),s.jsx("span",{className:`text-xs font-bold tabular-nums ${de==="up"?"text-green-500":de==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(be,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):s.jsxs("div",{ref:B,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:_.x,top:_.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:T.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${de==="up"?"text-green-500":de==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(be,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(be,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>ee("BUY"),disabled:Z,children:"BUY"}),s.jsx(be,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>ee("SELL"),disabled:Z,children:"SELL"}),s.jsx(be,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:te,disabled:Z,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:K,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:u}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:E,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:g,onChange:L=>M(Number.parseFloat(L.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:b,onChange:L=>H(Number.parseFloat(L.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:fe,children:"x Close"})})]})}const Hi=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function Yi({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,onToggleEma9:i,onToggleEma21:a,onToggleSupertrend:o,onToggleVwap:c}){const l=S(p=>p.chartInterval),u=S(p=>p.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Hi.map(p=>s.jsx(be,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${l===p.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>u(p.sec),children:p.label},p.sec)),s.jsx(Zi,{intervalSec:l}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(un,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),s.jsx(un,{label:"EMA21",active:t,color:"text-violet-500",onClick:a}),s.jsx(un,{label:"ST",active:n,color:"text-cyan-500",onClick:o}),s.jsx(un,{label:"VWAP",active:r,color:"text-pink-500",onClick:c})]})}function Zi({intervalSec:e}){const[t,n]=d.useState(()=>Mn(e));d.useEffect(()=>{n(Mn(e));const i=setInterval(()=>{n(Mn(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:Xi(t,e)})}function Mn(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function Xi(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function un({label:e,active:t,color:n,onClick:r}){return s.jsx(be,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function Qi(){const[e,t]=d.useState(!0),[n,r]=d.useState(!0),[i,a]=d.useState(!0),[o,c]=d.useState(!0),l=d.useCallback(()=>t(g=>!g),[]),u=d.useCallback(()=>r(g=>!g),[]),p=d.useCallback(()=>a(g=>!g),[]),m=d.useCallback(()=>c(g=>!g),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(Yi,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,onToggleEma9:l,onToggleEma21:u,onToggleSupertrend:p,onToggleVwap:m}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs(Fn,{orientation:"vertical",children:[s.jsx(ht,{defaultSize:"40%",minSize:"18%",children:s.jsx(Mi,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(fn,{withHandle:!0}),s.jsx(ht,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs(Fn,{orientation:"horizontal",children:[s.jsx(ht,{defaultSize:"50%",minSize:"20%",children:s.jsx(Cs,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(fn,{withHandle:!0}),s.jsx(ht,{defaultSize:"50%",minSize:"20%",children:s.jsx(Cs,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})})]}),s.jsx(Ui,{})]})})]})})]})}function Ji(){const e=je(y=>y.apiKey),t=je(y=>y.setApiKey),n=S(y=>y.activeSide),r=S(y=>y.selectedCESymbol),i=S(y=>y.selectedPESymbol),a=S(y=>y.optionExchange),o=S(y=>y.quantity),c=S(y=>y.lotSize),l=S(y=>y.product),u=S(y=>y.orderType),p=S(y=>y.tpPoints),m=S(y=>y.slPoints),g=S(y=>y.limitPrice),b=S(y=>y.pendingLimitPlacement),h=S(y=>y.setLimitPrice),f=S(y=>y.setPendingEntryAction),w=S(y=>y.setPendingLimitPlacement),N=S(y=>y.clearPendingLimitPlacement),P=S(y=>y.paperMode),k=re(y=>y.setVirtualTPSL),R=re(y=>y.clearForSymbol),O=re(y=>y.clearAll),F=re(y=>y.triggerOrders),G=re(y=>y.removeTriggerOrder),I=S(y=>y.setQuantity),C=S(y=>y.incrementQuantity),_=S(y=>y.decrementQuantity),U=S(y=>y.setOrderType),E=S(y=>y.setProduct),K=S(y=>y.setTpPoints),M=S(y=>y.setSlPoints),H=S(y=>y.incrementTradeCount),v=n==="CE"?r:i,T=d.useCallback(async()=>{if(e)return e;try{const $=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if($.status==="success"&&$.api_key)return t($.api_key),$.api_key}catch(y){console.error("[Scalping] Failed to fetch API key:",y)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),Z=d.useCallback(async y=>{if(!v){console.warn("[Scalping] No symbol selected  click a strike first");return}if(u==="TRIGGER"){const B=Object.values(F).find(X=>X.symbol===v&&X.exchange===a&&X.side===n);B&&G(B.id),N(),h(null),f(y),console.log(`[Scalping] TRIGGER armed (${y})  click chart to place trigger line`);return}if(u==="LIMIT"&&!g){f(y),console.log(`[Scalping] LIMIT armed (${y})  click chart to set limit line`);return}if(u==="LIMIT"&&b&&b.symbol===v&&b.side===n){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another.");return}if(P){if(console.log(`[Paper] ${y} ${n} ${v} qty=${o*c} @ ${u}`),u==="MARKET"||u==="LIMIT"){const B=await At({symbol:v,exchange:a,preferredPrice:u==="LIMIT"?g??void 0:void 0});B>0&&(k(Xe({symbol:v,exchange:a,side:n,action:y,entryPrice:B,quantity:o*c,tpPoints:p,slPoints:m,managedBy:"manual"})),u==="LIMIT"&&h(null))}N(),H();return}const $=await T();if(!$)return;const x=u==="LIMIT"?"LIMIT":"MARKET",D={apikey:$,strategy:"Scalping",exchange:a,symbol:v,action:y,quantity:o*c,pricetype:x,product:l,price:u==="LIMIT"&&g?g:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${y} ${v} qty=${o*c} ${x}`);const B=await he.placeOrder(D);if(B.status==="success"){const X=vt(B);if(console.log(`[Scalping] Order placed: ${y} ${v} id=${X??"n/a"}`),f(null),x==="LIMIT"){g==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),w({symbol:v,side:n,action:y,orderId:X,quantity:o*c,entryPrice:g??0,tpPoints:p,slPoints:m}),g!=null&&h(g);return}if(N(),H(),x==="MARKET"){const Q=await Pt({symbol:v,exchange:a,orderId:X,preferredPrice:void 0,apiKey:$});Q>0&&k(Xe({symbol:v,exchange:a,side:n,action:y,entryPrice:Q,quantity:o*c,tpPoints:p,slPoints:m,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",B)}catch(B){console.error("[Scalping] Order failed:",B)}},[v,n,o,c,a,l,u,g,b,p,m,P,R,F,T,w,N,H,k,G,h,f]),V=d.useCallback(async()=>{if(v){if(P){console.log(`[Paper] Close ${n} ${v}`),R(v),h(null),f(null),N();return}try{const y=await he.closePosition(v,a,l);y.status==="success"?(console.log(`[Scalping] Closed ${n} ${v}`),R(v),h(null),f(null),N()):console.error("[Scalping] Close rejected:",y)}catch(y){console.error("[Scalping] Close failed:",y)}}},[v,n,a,l,P,R,h,f,N]),q=d.useCallback(async()=>{if(P){console.log("[Paper] Close all positions"),O(),h(null),f(null),N();return}try{await he.closeAllPositions(),console.log("[Scalping] Closed all positions"),O(),h(null),f(null),N()}catch(y){console.error("[Scalping] Close all failed:",y)}},[P,O,h,f,N]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:v||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(be,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>Z("BUY"),disabled:!v,children:"BUY"}),s.jsx(be,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>Z("SELL"),disabled:!v,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(be,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:_,children:"-"}),s.jsx(ut,{type:"number",min:1,value:o,onChange:y=>I(Number.parseInt(y.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(be,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:C,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*c," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(y=>s.jsx(be,{variant:u===y?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>U(y),children:y},y))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(y=>s.jsx(be,{variant:l===y?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>E(y),children:y},y))})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(ut,{type:"number",min:0,step:5,value:p,onChange:y=>K(Number.parseFloat(y.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(ut,{type:"number",min:0,step:5,value:m,onChange:y=>M(Number.parseFloat(y.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(be,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:V,disabled:!v,children:["Close ",n," Position"]}),s.jsx(be,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:q,children:"Close All Positions"})]})]})}const Ut={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},br=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],ea=["CE","PE"];function kt(e=0){return ea.reduce((t,n)=>(t[n]=e,t),{})}const ta=new Set(["1","true","yes","on","enabled"]),na=new Set(["0","false","no","off","disabled"]);function sa(e){if(typeof e=="boolean")return e;if(typeof e=="number")return Number.isFinite(e)?e!==0:null;if(typeof e=="string"){const t=e.trim().toLowerCase();if(ta.has(t))return!0;if(na.has(t))return!1}return null}function In(e){if(!e||typeof e!="object")return{};const t=e,n={};for(const r of Object.keys(Ut)){if(!(r in t))continue;const i=Ut[r],a=t[r];if(typeof i=="boolean"){const o=sa(a);o!=null&&(n[r]=o);continue}if(typeof i=="number"){const o=typeof a=="number"?a:typeof a=="string"?Number(a):Number.NaN;Number.isFinite(o)&&(n[r]=o)}}return n}const W=_n()(Bn(e=>({config:{...Ut},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:kt(),sideLastExitAt:kt(),sideLossPnl:kt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...In(t)}})),applyPreset:t=>{const n=br.find(r=>r.id===t);n&&e({config:{...Ut,...In(n.config)},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.accountPeakPnl,t),i=Math.max(0,r-t),a=Math.max(n.dailyPeakPnl,t),o=Math.max(0,a-t),c=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered,l=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:a,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:i,lockProfitTriggered:c,killSwitch:n.killSwitch||l||c}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,c=Math.max(n.dailyPeakPnl,o),l=Math.max(0,c-o),u=Math.max(n.autoPeakPnl,o),p=Math.max(0,u-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:c,dailyDrawdown:l,autoPeakPnl:u,autoDrawdown:p}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),c=Math.max(n.autoPeakPnl,i),l=Math.max(0,c-i),u=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,autoPeakPnl:c,autoDrawdown:l,lockProfitTriggered:u,killSwitch:n.killSwitch||u}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:kt(),sideLastExitAt:kt(),sideLossPnl:kt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const n=e??{};return{...t,...n,config:{...Ut,...In(n.config??{})},activePresetId:n.activePresetId??t.activePresetId}}})),ra=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],ia=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function zn(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Xn(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return{hours:n.getUTCHours(),minutes:n.getUTCMinutes()}}function vr(e){return e?ia:ra}function Vn(e=new Date,t=!1){const{hours:n,minutes:r}=Xn(e),i=n*60+r,a=vr(t);for(const o of a){const c=zn(o.start),l=zn(o.end);if(i>=c&&i<l)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function ks(e=new Date,t=!1){const{hours:n,minutes:r}=Xn(e),i=n*60+r,a=vr(t);for(const o of a){const c=zn(o.start);if(c>i)return{nextZone:o,minutesUntil:c-i}}return{nextZone:null,minutesUntil:0}}function Ts(e,t=new Date){if(!e)return!1;try{const n=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return n.getFullYear()===i.getUTCFullYear()&&n.getMonth()===i.getUTCMonth()&&n.getDate()===i.getUTCDate()}catch{return!1}}function Ls(e=new Date){const{hours:t,minutes:n}=Xn(e),r=t*60+n;return r>=555&&r<930}function Ms(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return`${n.getUTCHours().toString().padStart(2,"0")}:${n.getUTCMinutes().toString().padStart(2,"0")}:${n.getUTCSeconds().toString().padStart(2,"0")}`}function Sr(){const e=S(r=>r.expiry),[t,n]=d.useState(()=>{const r=new Date,i=Ts(e,r),{zone:a,sensitivity:o}=Vn(r,i),{nextZone:c,minutesUntil:l}=ks(r,i);return{currentTime:Ms(r),currentZone:a,sensitivity:o,nextZone:c,minutesToNext:l,isExpiryDay:i,isOpen:Ls(r)}});return d.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Ts(e,a),{zone:c,sensitivity:l}=Vn(a,o),{nextZone:u,minutesUntil:p}=ks(a,o);n({currentTime:Ms(a),currentZone:c,sensitivity:l,nextZone:u,minutesToNext:p,isExpiryDay:o,isOpen:Ls(a)})},1e3);return()=>clearInterval(i)},[e]),t}function aa(){const e=W(r=>r.activePresetId),t=W(r=>r.applyPreset),{isExpiryDay:n}=Sr();return s.jsx("div",{className:"space-y-1.5",children:br.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(Ee,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(Ee,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function ce({label:e,field:t,step:n}){const r=W(a=>a.config[t]),i=W(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Ue,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(ut,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function Ke({label:e,field:t}){const n=W(i=>i.config[t]),r=W(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Ue,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(qt,{checked:n===!0,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function De({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function oa(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(De,{title:"Entry Conditions",children:[s.jsx(ce,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(ce,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(ce,{label:"Min Score",field:"entryMinScore"}),s.jsx(ce,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(De,{title:"Volume Flow",children:[s.jsx(Ke,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),s.jsx(ce,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),s.jsx(ce,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),s.jsx(ce,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),s.jsx(ce,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),s.jsx(ce,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),s.jsxs(De,{title:"Trailing SL (5-Stage)",children:[s.jsx(ce,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(ce,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(ce,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(ce,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(ce,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(ce,{label:"Trail Step",field:"trailStepSize"}),s.jsx(ce,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(ce,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(De,{title:"Breakeven",children:[s.jsx(ce,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(ce,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(De,{title:"Risk",children:[s.jsx(ce,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(ce,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(ce,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(ce,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(ce,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(ce,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(ce,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(ce,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(De,{title:"Imbalance Filter",children:[s.jsx(Ke,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(ce,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(De,{title:"Regime Detection",children:[s.jsx(ce,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(ce,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(De,{title:"Index Bias",children:[s.jsx(Ke,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(ce,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(De,{title:"Options Context",children:[s.jsx(Ke,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(ce,{label:"PCR Bullish ",field:"pcrBullishThreshold",step:.1}),s.jsx(ce,{label:"PCR Bearish ",field:"pcrBearishThreshold",step:.1}),s.jsx(ce,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(Ke,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(Ke,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(ce,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(De,{title:"Time-of-Day",children:[s.jsx(Ke,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(ce,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(De,{title:"No-Trade Zone",children:[s.jsx(Ke,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(ce,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(ce,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(De,{title:"Re-Entry",children:[s.jsx(Ke,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(ce,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(ce,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(De,{title:"Telegram Alerts",children:[s.jsx(Ke,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(Ke,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(Ke,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function la(){const e=W(r=>r.ghostSignals),t=W(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(ca,{signal:r},r.id))]})}function ca({signal:e}){const t=je(m=>m.apiKey),n=S(m=>m.optionExchange),r=S(m=>m.quantity),i=S(m=>m.lotSize),a=S(m=>m.product),o=S(m=>m.paperMode),c=S(m=>m.incrementTradeCount),l=d.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),c();return}if(!t)return;const m={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const g=await he.placeOrder(m);g.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${g.data?.orderid}`),c())}catch(g){console.error("[Ghost Take] Failed:",g)}},[e,t,n,r,i,a,o,c]),u=Math.round((Date.now()-e.timestamp)/1e3),p=u<60?`${u}s ago`:`${Math.round(u/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ee,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),s.jsxs(Ee,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(be,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:l,children:"Take Trade"})]})]})}function ua(){const e=W(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(Ee,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const Qn={getBotStatus:async()=>(await Ye.get("/telegram/bot/status")).data.data,startBot:async()=>(await Ye.post("/telegram/bot/start")).data,stopBot:async()=>(await Ye.post("/telegram/bot/stop")).data,getConfig:async()=>(await Ye.get("/telegram/api/config")).data.data,updateConfig:async e=>(await Ye.post("/telegram/config",e)).data,getUsers:async()=>(await Ye.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await Ye.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await Ye.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await Ye.post("/telegram/test-message")).data,sendBroadcast:async e=>(await Ye.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await Ye.post("/telegram/send-message",{telegram_id:e,message:t})).data};function da(){const[e,t]=d.useState(!1),[n,r]=d.useState(null),[i,a]=d.useState(null),[o,c]=d.useState(null),l=W(h=>h.updateConfig),u=W(h=>h.config),p=S(h=>h.underlying),m=d.useCallback(async()=>{try{const h=await Nr();r(h.provider||"none"),h.last_run&&a(h.last_run),c(null)}catch{c("Could not reach advisor")}},[]),g=d.useCallback(async()=>{t(!0),c(null);try{const h=await wr({underlying:p});if(h.status==="success"&&h.run_id){const f=await Er(1);f.runs?.length>0&&a(f.runs[0])}else c(h.message||"Tuning failed")}catch{c("Advisor request failed")}finally{t(!1)}},[p]),b=d.useCallback(async()=>{if(i?.run_id){t(!0);try{await Cr(i.run_id);const h=i.recommendations;if(h&&typeof h=="object"){const f={};for(const[w,N]of Object.entries(h)){if(!(w in u))continue;const P=w,k=u[P];if(typeof k=="number"){const R=typeof N=="number"?N:Number(N);Number.isFinite(R)&&(f[P]=R);continue}if(typeof k=="boolean"){let R=null;if(typeof N=="boolean")R=N;else if(typeof N=="number")R=N!==0;else if(typeof N=="string"){const O=N.trim().toLowerCase();["true","1","yes","on","enabled"].includes(O)&&(R=!0),["false","0","no","off","disabled"].includes(O)&&(R=!1)}R!=null&&(f[P]=R)}}if(Object.keys(f).length>0&&(l(f),u.telegramAlertsTune)){const w=Object.keys(f).join(", ");Qn.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${w}`}).catch(()=>{})}}a(f=>f&&{...f,applied:!0}),c(null)}catch{c("Failed to apply recommendation")}finally{t(!1)}}},[i,l,u,p]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(Ee,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(be,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:m,disabled:e,children:"Check Status"}),s.jsx(be,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:g,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??""})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([h,f])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:h}),s.jsx("span",{className:"font-mono",children:typeof f=="number"?f:String(f)})]},h))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(be,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:b,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(Ee,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function pa(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function ma(){const e=W(x=>x.enabled),t=W(x=>x.mode),n=W(x=>x.replayMode),r=W(x=>x.regime),i=W(x=>x.tradesCount),a=W(x=>x.realizedPnl),o=W(x=>x.consecutiveLosses),c=W(x=>x.killSwitch),l=W(x=>x.lockProfitEnabled),u=W(x=>x.lockProfitTriggered),p=W(x=>x.accountPeakPnl),m=W(x=>x.accountDrawdown),g=W(x=>x.autoPeakPnl),b=W(x=>x.autoDrawdown),h=W(x=>x.sideEntryCount),f=W(x=>x.sideLastExitAt),w=W(x=>x.sideLossPnl),N=W(x=>x.lastDecisionBySide),P=W(x=>x.decisionHistory),k=W(x=>x.executionSamples),R=W(x=>x.config),O=W(x=>x.setEnabled),F=W(x=>x.setMode),G=W(x=>x.setReplayMode),I=W(x=>x.setKillSwitch),C=W(x=>x.setLockProfitEnabled),_=W(x=>x.resetRuntime),U=S(x=>x.activeSide),E=S(x=>x.paperMode),K=re(x=>x.virtualTPSL),M=d.useMemo(()=>N[U]??P[P.length-1]??null,[U,P,N]),H=d.useMemo(()=>M?Math.max(0,Math.min(99,Math.round(M.score/Math.max(1,M.minScore)*100))):r==="UNKNOWN"?0:55,[M,r]),v=d.useMemo(()=>Object.values(K).reduce((x,D)=>(x[D.side]+=D.quantity,x),{CE:0,PE:0}),[K]),T=d.useMemo(()=>Object.values(K).reduce((x,D)=>(D.managedBy!=="auto"||(x[D.side]+=D.quantity),x),{CE:0,PE:0}),[K]),Z=d.useMemo(()=>{const x=k.slice(-10),D=x.filter(te=>te.status==="filled"),B=x.filter(te=>te.status==="rejected"),X=D.length>0?D.reduce((te,fe)=>te+fe.spread,0)/D.length:0,Q=D.length>0?D.reduce((te,fe)=>te+fe.expectedSlippage,0)/D.length:0,ee=x.length>0?B.length/x.length*100:0;return{recent:x.slice().reverse(),avgSpread:X,avgSlippage:Q,rejectRate:ee}},[k]),V=M?M.spread<=R.entryMaxSpread*.4?"TIGHT":M.spread<=R.entryMaxSpread?"NORMAL":"WIDE":"NA",q=f[U]>0?Math.max(0,Math.round((Date.now()-f[U])/1e3)):null,y=e&&t==="execute"&&n,$=x=>x<=0?"0":`-${x.toFixed(0)}`;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ue,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(qt,{checked:e,onCheckedChange:O,className:"h-5 w-9"})]}),s.jsx(Ee,{variant:e?t==="execute"&&!n?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?y?"SIM (REPLAY)":t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(be,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>F("ghost"),children:"Ghost (Signals Only)"}),s.jsx(be,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>F("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(qt,{checked:n,onCheckedChange:G,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),y&&s.jsx("div",{className:"p-1 bg-amber-500/10 border border-amber-500/30 rounded text-amber-400 text-[10px] text-center font-medium",children:"EXECUTE BLOCKED - Replay/Simulator is ON"}),t==="execute"&&!E&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(Ee,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:_,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),M?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[M.side," ",M.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${M.enter?"text-green-500":"text-red-500"}`,children:[M.score.toFixed(1)," / ",M.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:M.reason}),s.jsx("div",{className:"space-y-0.5",children:M.checks.slice(0,8).map(x=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:x.label}),s.jsxs("span",{className:`text-[10px] font-medium ${x.pass?"text-green-500":"text-red-500"}`,children:[x.pass?"PASS":"FAIL",x.value?` (${x.value})`:""]})]},x.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:pa(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[H,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:M&&!M.enter?M.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",U,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:q==null?"":`${q}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${V==="WIDE"?"text-red-500":V==="TIGHT"?"text-green-500":""}`,children:V})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Execution Gate"}),s.jsx("span",{className:`font-medium ${y?"text-amber-400":t==="execute"?"text-green-500":"text-muted-foreground"}`,children:y?"BLOCKED (Replay)":t==="execute"?"OPEN":"Ghost Mode"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(M?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:M?.depthRatio!=null?M.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:Z.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:Z.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${Z.rejectRate>30?"text-red-500":""}`,children:[Z.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[Z.recent.slice(0,5).map(x=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[x.side," ",x.symbol.slice(-10)]}),s.jsx("span",{className:x.status==="rejected"?"text-red-500":x.status==="filled"?"text-green-500":"text-muted-foreground",children:x.status})]},`${x.timestamp}-${x.symbol}`)),Z.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[c&&s.jsx(Ee,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(qt,{checked:c,onCheckedChange:I,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[u&&s.jsx(Ee,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(qt,{checked:l,onCheckedChange:C,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),s.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),s.jsx("span",{className:`font-mono ${m>0?"text-red-500":""}`,children:m.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),s.jsx("span",{className:"font-mono",children:g.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),s.jsx("span",{className:`font-mono ${b>0?"text-red-500":""}`,children:b.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),s.jsx("span",{className:"font-mono",children:v.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),s.jsx("span",{className:"font-mono",children:v.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),s.jsx("span",{className:"font-mono",children:T.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),s.jsx("span",{className:"font-mono",children:T.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:h.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:h.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsx("span",{className:`font-mono ${w.CE>0?"text-red-500":""}`,children:$(w.CE)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsx("span",{className:`font-mono ${w.PE>0?"text-red-500":""}`,children:$(w.PE)})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(ua,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(la,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(da,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(aa,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(oa,{})]})]})}function fa(){const e=je(m=>m.apiKey),t=S(m=>m.optionExchange),n=re(m=>m.virtualTPSL),r=re(m=>m.triggerOrders),i=re(m=>m.removeVirtualTPSL),a=re(m=>m.removeTriggerOrder),o=re(m=>m.clearAll),{data:c}=qs({queryKey:["scalping-orders",t],queryFn:()=>he.getOrders(e),enabled:!!e,refetchInterval:5e3}),l=(c?.data?.orders??[]).filter(m=>m.exchange===t&&(m.order_status==="open"||m.order_status==="pending"||m.order_status==="trigger pending")),u=Object.values(n),p=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(Ee,{variant:"outline",className:"text-[10px] h-4",children:l.length})]}),l.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:l.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",m.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ee,{variant:"outline",className:"text-[10px] h-4",children:m.order_status}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await he.cancelOrder(m.orderid)}catch(g){console.error("Cancel failed:",g)}},children:"Cancel"})]})]},m.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(Ee,{variant:"outline",className:"text-[10px] h-4",children:u.length})]}),u.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:u.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.side==="CE"?"text-green-500":"text-red-500",children:m.side})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",m.entryPrice.toFixed(1)," |"," ",m.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",m.tpPrice.toFixed(1)]})," ",m.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",m.slPrice.toFixed(1)]})]})]}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(m.id),children:"Remove"})]},m.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(Ee,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:p.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",m.triggerPrice.toFixed(1)," (",m.direction,") | x",m.quantity]})]}),s.jsx(be,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(m.id),children:"Remove"})]},m.id))})]}),(u.length>0||p.length>0)&&s.jsx(be,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function xa(e,t){const n=je(p=>p.apiKey),[r,i]=d.useState(null),[a,o]=d.useState(!1),c=d.useRef(null),l=d.useCallback(async()=>{if(!(!e||!n)){try{const p=await he.getDepth(n,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}o(!1)}},[e,t,n]);d.useEffect(()=>{if(!e){i(null);return}return o(!0),l(),c.current=setInterval(l,2e3),()=>{c.current&&clearInterval(c.current)}},[e,l]);const u=r?ha(r):null;return{depth:r,analytics:u,levels:5,isLoading:a}}function ha(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((b,h)=>b+h.quantity,0),i=n.reduce((b,h)=>b+h.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,c=t.length>0?t.reduce((b,h)=>h.quantity>b.quantity?h:b,t[0]):null,l=c?{price:c.price,qty:c.quantity}:null,u=n.length>0?n.reduce((b,h)=>h.quantity>b.quantity?h:b,n[0]):null,p=u?{price:u.price,qty:u.quantity}:null,m=r+i,g=m>0?(r-i)/m*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:l,largestAskWall:p,imbalanceScore:g}}function ga(){const e=S(c=>c.activeSide),t=S(c=>c.optionExchange),n=S(c=>c.activeSide==="CE"?c.selectedCESymbol:c.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=xa(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(Ee,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((c,l)=>{const u=r.bids?.[l],p=r.asks?.[l],m=Math.max(...r.bids?.map(g=>g.quantity)??[0],...r.asks?.map(g=>g.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:u&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${m>0?u.quantity/m*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:u.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:u?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${m>0?p.quantity/m*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},l)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Is=500;function ya(){const e=d.useRef([]),t=d.useCallback(c=>{const l={...c,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(l),e.current.length>Is&&(e.current=e.current.slice(-Is)),l},[]),n=d.useCallback(()=>[...e.current],[]),r=d.useCallback(c=>e.current.slice(-c),[]),i=d.useCallback(()=>{e.current=[]},[]),a=d.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=d.useCallback(()=>{const c=e.current;if(c.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const l=c.filter(g=>g.pnl!==void 0),u=l.filter(g=>(g.pnl??0)>0),p=l.reduce((g,b)=>g+(b.pnl??0),0),m=l.map(g=>g.pnl??0);return{count:c.length,winRate:l.length>0?u.length/l.length*100:0,avgPnl:l.length>0?p/l.length:0,totalPnl:p,bestTrade:m.length>0?Math.max(...m):0,worstTrade:m.length>0?Math.min(...m):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function ba({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(P=>P.sessionPnl),r=S(P=>P.tradeCount),i=S(P=>P.paperMode),a=i?n:e??n,o=Sr(),{getStats:c}=ya(),l=c(),[u,p]=d.useState(5e3),[m,g]=d.useState(500),[b,h]=d.useState(50),[f,w]=d.useState(3),N=a<0&&Math.abs(a)>=u;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(Ee,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(Ee,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),N&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(ut,{type:"number",value:u,onChange:P=>p(Number(P.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(ut,{type:"number",value:m,onChange:P=>g(Number(P.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(ut,{type:"number",value:b,onChange:P=>h(Number(P.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ue,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(ut,{type:"number",value:f,onChange:P=>w(Number(P.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),l.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[l.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${l.avgPnl>0?"text-green-500":l.avgPnl<0?"text-red-500":""}`,children:[l.avgPnl>=0?"+":"",l.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",l.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:l.worstTrade.toFixed(0)})]})]})]})]})]})}const va=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function Sa({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(i=>i.controlTab),r=S(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:va.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx(Ji,{}),n==="auto"&&s.jsx(ma,{}),n==="risk"&&s.jsx(ba,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(ga,{}),n==="orders"&&s.jsx(fa,{})]})]})}const Pa=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE  PE)"},{key:"",description:"CE direct market buy (with virtual TP/SL)"},{key:"",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function ja({open:e,onClose:t}){return d.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:Pa.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function Na(e={}){const t=S(v=>v.hotkeysEnabled),n=S(v=>v.activeSide),r=S(v=>v.selectedCESymbol),i=S(v=>v.selectedPESymbol),a=S(v=>v.optionExchange),o=S(v=>v.quantity),c=S(v=>v.lotSize),l=S(v=>v.product),u=S(v=>v.orderType),p=S(v=>v.limitPrice),m=S(v=>v.pendingLimitPlacement),g=S(v=>v.setLimitPrice),b=S(v=>v.setPendingLimitPlacement),h=S(v=>v.clearPendingLimitPlacement),f=S(v=>v.tpPoints),w=S(v=>v.slPoints),N=S(v=>v.setPendingEntryAction),P=S(v=>v.paperMode),k=re(v=>v.setVirtualTPSL),R=re(v=>v.triggerOrders),O=re(v=>v.removeTriggerOrder),F=S(v=>v.setActiveSide),G=S(v=>v.toggleActiveSide),I=S(v=>v.toggleFloatingWidget),C=S(v=>v.setQuantity),_=je(v=>v.apiKey),U=je(v=>v.setApiKey),E=d.useCallback(()=>n==="CE"?r:i,[n,r,i]),K=d.useCallback(v=>v==="CE"?r:i,[r,i]),M=d.useCallback(async()=>{if(_)return _;try{const T=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(T.status==="success"&&T.api_key)return U(T.api_key),T.api_key}catch(v){console.error("[Scalping] Failed to fetch API key:",v)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[_,U]),H=d.useCallback(async(v,T,Z=!1)=>{const V=T??n,q=K(V),y=Z?"MARKET":u;if(!q){console.warn("[Scalping] No symbol selected  click a strike first");return}if(y==="TRIGGER"){const B=Object.values(R).find(X=>X.symbol===q&&X.exchange===a&&X.side===V);B&&O(B.id),h(),g(null),N(v),console.log(`[Scalping] TRIGGER armed (${v})  click chart to place trigger line`);return}if(y==="LIMIT"&&!p){N(v),console.log(`[Scalping] LIMIT armed (${v})  click chart to set limit line`);return}if(y==="LIMIT"&&m&&m.symbol===q&&m.side===V){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another.");return}if(P){if(console.log(`[Paper] ${v} ${V} ${q} qty=${o*c} @ ${y}`),y==="MARKET"||y==="LIMIT"){const B=await At({symbol:q,exchange:a,preferredPrice:y==="LIMIT"?p??void 0:void 0});B>0&&(k(Xe({symbol:q,exchange:a,side:V,action:v,entryPrice:B,quantity:o*c,tpPoints:f,slPoints:w,managedBy:"hotkey"})),y==="LIMIT"&&g(null))}h();return}const $=await M();if(!$)return;const x=y==="LIMIT"?"LIMIT":"MARKET",D={apikey:$,strategy:"Scalping",exchange:a,symbol:q,action:v,quantity:o*c,pricetype:x,product:l,price:y==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${v} ${q} qty=${o*c} ${x}`);const B=await he.placeOrder(D);if(B.status==="success"){const X=vt(B);if(console.log(`[Scalping] Order placed: ${v} ${q} id=${X??"n/a"}`),N(null),x==="LIMIT"){p==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),b({symbol:q,side:V,action:v,orderId:X,quantity:o*c,entryPrice:p??0,tpPoints:f,slPoints:w}),p!=null&&g(p);return}if(h(),x==="MARKET"){const Q=await Pt({symbol:q,exchange:a,orderId:X,preferredPrice:void 0,apiKey:$});Q>0&&k(Xe({symbol:q,exchange:a,side:V,action:v,entryPrice:Q,quantity:o*c,tpPoints:f,slPoints:w,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",B)}catch(B){console.error("[Scalping] Order failed:",B)}},[K,n,o,c,a,l,u,p,m,f,w,P,R,M,b,h,k,O,g,N]);d.useEffect(()=>{if(!t)return;const v=T=>{const Z=T.target?.tagName;if(Z==="INPUT"||Z==="TEXTAREA"||Z==="SELECT")return;const V=E();switch(T.key.toLowerCase()){case"b":{T.preventDefault(),V&&(H("BUY"),e.onBuy?.(n,V));break}case"s":{T.preventDefault(),V&&(H("SELL"),e.onSell?.(n,V));break}case"c":{T.preventDefault(),V&&e.onClose?.(n,V);break}case"x":{T.preventDefault(),e.onCloseAll?.();break}case"r":{T.preventDefault(),V&&e.onReversal?.(n,V);break}case"w":{T.preventDefault(),I();break}case"tab":{T.preventDefault(),G();break}case"1":{T.preventDefault(),C(1);break}case"2":{T.preventDefault(),C(2);break}case"3":{T.preventDefault(),C(3);break}case"?":{T.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{T.preventDefault(),r&&(F("CE"),H("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{T.preventDefault(),i&&(F("PE"),H("BUY","PE",!0),e.onBuy?.("PE",i));break}}};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[t,n,E,H,G,F,I,C,r,i,e])}const wa=300,Rs=2e3,As=15,$s=8e3,Os=15e3;function Oe(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function yn(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=Oe(n,Number.NaN);return Number.isFinite(r)?r:null}function Ea(e,t,n){if(!e.length)return null;const r=e.find(c=>c.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let c=1;c<e.length;c++){const l=Math.abs(e[c].strike-i);l<o&&(a=e[c],o=l)}return a}function Ca(e){return Oe(e.ce?.oi,0)+Oe(e.pe?.oi,0)}function ka(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(Oe(yn(t,"net_gex"),0))||Ca(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function Ta(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const c of e){const l=c.strike,u=Oe(c.ce?.oi,0),p=Oe(c.pe?.oi,0);a>l?o+=(a-l)*u:a<l&&(o+=(l-a)*p)}o<r&&(r=o,n=a)}return n}function La(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function Fs(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!La(e.topGammaStrikes,t.topGammaStrikes)}function Ds(e,t){const n=yn(e,"iv");return n!=null&&n>0?n:t}function Ma(e){return e.replace(/-/g,"").toUpperCase()}function zs(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=Oe(e.underlying_ltp,0),a=Oe(e.atm_strike,0),o=Ea(r,a,i),c=r.reduce((F,G)=>(F.ceOi+=Oe(G.ce?.oi,0),F.peOi+=Oe(G.pe?.oi,0),F.ceVol+=Oe(G.ce?.volume,0),F.peVol+=Oe(G.pe?.volume,0),F),{ceOi:0,peOi:0,ceVol:0,peVol:0}),l=c.ceOi>0?c.peOi/c.ceOi:1,u=Ta(r,o?.strike??a),p=i-u,m=ka(r),g=yn(e,"total_net_gex"),b=g??0,h=t?.ceIV??As,f=t?.peIV??As,w=Ds(o?.ce,h),N=Ds(o?.pe,f),P=(w+N)/2,k=w-N,R=yn(e,"iv_percentile")??t?.ivPercentile??50,O=Oe(o?.ce?.ltp,0)+Oe(o?.pe?.ltp,0);return{pcr:l,oiChangeCE:c.ceOi,oiChangePE:c.peOi,maxPainStrike:u,spotVsMaxPain:p,topGammaStrikes:m,gexFlipZones:[],netGEX:b,atmIV:P,ivPercentile:R,ceIV:w,peIV:N,ivSkew:k,straddlePrice:O,lastUpdated:n>0?n:Date.now()}}function Ia(){const e=je(f=>f.apiKey),t=S(f=>f.underlying),n=S(f=>f.expiry),r=S(f=>f.indexExchange),i=S(f=>f.chainStrikeCount),a=S(f=>f.optionChainData),o=S(f=>f.optionChainLastUpdate),c=S(f=>f.optionChainIsStreaming),l=W(f=>f.optionsContext),u=W(f=>f.setOptionsContext),p=d.useRef(0),m=d.useRef(!1),g=d.useRef(0),b=d.useRef(null);d.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const f=Date.now();if(f-p.current<wa)return;const w=zs(a,l,o||f);if(!w)return;const N=Fs(l,w),P=!l||f-l.lastUpdated>=Rs;!N&&!P||(u(w),p.current=f)},[a,o,l,u]);const h=d.useCallback(async()=>{if(m.current||!e||!t||!n||!r)return;const f=Date.now();if(!(f-g.current<Os||a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||f-(o||0)<=$s))){m.current=!0,g.current=f;try{const N=await Gs.getOptionChain(e,t,r,Ma(n),i);if(N.status!=="success"||!Array.isArray(N.chain)||N.chain.length===0)return;const P=zs(N,l,Date.now());if(!P)return;const k=Fs(l,P),R=!l||Date.now()-l.lastUpdated>=Rs;if(!k&&!R)return;u(P),p.current=Date.now()}catch{}finally{m.current=!1}}},[e,t,n,r,i,a,c,o,l,u]);d.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||Date.now()-(o||0)<=$s)){b.current&&(clearInterval(b.current),b.current=null);return}return h(),b.current&&clearInterval(b.current),b.current=setInterval(()=>{h()},Os),()=>{b.current&&(clearInterval(b.current),b.current=null)}},[a,c,o,h])}function Ra(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let c=1;c<n.length;c++)n[c]>n[c-1]?r++:n[c]<n[c-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function Aa(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(u=>u.high),i=n.map(u=>u.low),a=Math.max(...r)-Math.min(...i),o=n.map(u=>u.close),c=Math.abs(o[o.length-1]-o[0]),l=n.reduce((u,p)=>u+(p.high-p.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":c>a*.6?"TRENDING":l>a*.15?"VOLATILE":"RANGING"}function $a(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function Oa(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1));const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function Fa(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function Da(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function za(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Va(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function _a(e,t,n,r,i,a,o,c,l,u,p,m=[],g){let b=0;const h=[],f=Date.now(),w=[],N=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,P=n.respectHotZones?l:1,k=Math.max(.25,P*Math.max(.1,n.sensitivityMultiplier)),R=Math.min(10,Math.max(1,n.entryMinScore/k)),O=($,x,D,B)=>{w.push({id:$,label:x,pass:D,value:B})},F=($,x)=>({enter:!1,reason:$,score:b,minScore:Number(R.toFixed(2)),checks:w,blockedBy:x,spread:u,depthRatio:N,expectedSlippage:Math.max(0,u/2)}),G=r.tradesCount<n.maxTradesPerDay;if(O("daily-trades","Daily trade cap",G,`${r.tradesCount}/${n.maxTradesPerDay}`),!G)return F("Max daily trades reached","daily-trades");const I=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(O("daily-loss","Daily loss limit",I,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!I)return F("Daily loss limit reached","daily-loss");const C=r.consecutiveLosses<n.coolingOffAfterLosses;if(O("cooling-off","Consecutive-loss cooling off",C,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!C)return F(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const _=!r.killSwitch;if(O("kill-switch","Kill switch",_),!_)return F("Kill switch active","kill-switch");const U=!n.respectHotZones||P>0;if(O("hot-zone","Market hot-zone timing",U,n.respectHotZones?P.toFixed(2):"OFF"),!U)return F("Outside configured market hot-zone timing","hot-zone");const E=!r.sideOpen;if(O("side-open","No open position on side",E),!E)return F(`Position already open on ${e}`,"side-open");const K=r.reEntryCountForSide??0,M=r.lastExitAtForSide??0,H=n.reEntryEnabled===!0;if(O("reentry-setting","Re-entry",!0,H?"ON":"OFF (first entry only)"),H){if(O("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||K<n.reEntryMaxPerSide,`${K}/${n.reEntryMaxPerSide}`),n.reEntryMaxPerSide>0&&K>=n.reEntryMaxPerSide)return F(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryDelaySec>0&&M>0){const $=f-M,x=n.reEntryDelaySec*1e3,D=$>=x;if(O("reentry-delay","Re-entry delay",D,D?`${n.reEntryDelaySec}s`:`${Math.ceil((x-$)/1e3)}s left`),!D)return F(`Re-entry delay active: ${Math.ceil((x-$)/1e3)}s`,"reentry-delay")}}else{const $=K===0;if(O("reentry-first","First entry only",$,`${K}/1`),!$)return F(`Re-entry disabled for ${e}`,"reentry-first")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return O("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),F(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(O("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const $=r.lastTradePnl>-n.perTradeMaxLoss;if(O("per-trade-loss","Per-trade max loss",$,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!$)return F("Last trade breached per-trade max loss","per-trade-loss")}else O("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const $=f-r.lastTradeTime,x=$>=n.minGapMs;if(O("min-gap","Minimum gap between entries",x,x?`${$}ms`:`${n.minGapMs-$}ms left`),$<n.minGapMs)return F(`Min gap: ${Math.ceil((n.minGapMs-$)/1e3)}s remaining`,"min-gap")}else O("min-gap","Minimum gap between entries",!0);if(O("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return F(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const $=f-r.lastLossTime,x=n.cooldownAfterLossSec*1e3,D=$>=x;if(O("loss-cooldown","Cooldown after loss",D,D?`${n.cooldownAfterLossSec}s`:`${Math.ceil((x-$)/1e3)}s left`),$<x)return F(`Cooldown: ${Math.ceil((x-$)/1e3)}s after loss`,"loss-cooldown")}else O("loss-cooldown","Cooldown after loss",!0);if(p){const $=Va(p.totalBid,p.totalAsk,e,n);if(O("depth-imbalance","Depth imbalance",$.allowed,$.reason),!$.allowed)return F($.reason,"depth-imbalance")}else O("depth-imbalance","Depth imbalance",!0,"No depth data");if(O("spread","Spread gate",u<=n.entryMaxSpread,`${u.toFixed(2)}/${n.entryMaxSpread}`),u>n.entryMaxSpread)return F(`Spread too wide: ${u.toFixed(1)}`,"spread");if(n.volumeInfluenceEnabled){const $=Math.max(.1,n.indexVolumeMinRatio||1),x=Math.max(.1,n.optionVolumeMinRatio||1),D=Math.max(.1,n.sideVolumeDominanceRatio||1),B=Math.max(0,n.volumeScoreWeight||0),X=g?.indexDeltaRatio??null,Q=g?.optionDeltaRatio??null,ee=g?.sideDominanceRatio??null,te=g?.indexDelta,fe=g?.optionDelta,de=g?.oppositeDelta,L=X==null?!0:X>=$,ne=Q==null?!0:Q>=x,ve=ee==null?!0:ee>=D;if(O("volume-index","Index volume flow",L,X==null?"NA":`${X.toFixed(2)}x/${$.toFixed(2)}x d:${(te??0).toFixed(0)}`),O("volume-option",`${e} volume flow`,ne,Q==null?"NA":`${Q.toFixed(2)}x/${x.toFixed(2)}x d:${(fe??0).toFixed(0)}`),O("volume-dominance",`${e} vs opposite volume`,ve,ee==null?"NA":`${ee.toFixed(2)}x/${D.toFixed(2)}x opp:${(de??0).toFixed(0)}`),Q!=null&&ee!=null&&!ne&&!ve)return F(`Weak ${e} volume participation`,"volume-option");X!=null&&L&&B>0&&(b+=.5*B,h.push(`IdxVol x${X.toFixed(2)}`)),Q!=null&&ne&&B>0&&(b+=1*B,h.push(`${e}Vol x${Q.toFixed(2)}`)),ee!=null&&ve&&B>0&&(b+=.75*B,h.push(`${e}>Opp x${ee.toFixed(2)}`))}else O("volume-influence","Volume influence",!0,"OFF");const v=n.noTradeZoneEnabled&&$a(m,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(O("no-trade-zone","No-trade zone filter",!v,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),v)return F(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const T=e==="CE"?"up":"down";O("momentum-direction","Momentum alignment",i.direction===T,`${i.direction} x${i.count}`),i.direction===T&&i.count>=n.entryMomentumCount?(b+=3,h.push(`Momentum ${i.direction} x${i.count}`)):i.direction===T&&(b+=1,h.push(`Weak momentum ${i.direction}`)),O("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(b+=2,h.push(`Velocity ${i.velocity.toFixed(1)}`));let Z=!1;a.ema9!==null&&a.ema21!==null&&(Z=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,Z&&(b+=1,h.push("EMA aligned"))),O("ema","EMA alignment",Z,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let V=!1;a.rsi!==null&&(V=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,V&&(b+=1,h.push(`RSI ${a.rsi.toFixed(0)}`))),O("rsi","RSI alignment",V,a.rsi!=null?a.rsi.toFixed(1):"NA");let q=!1;n.indexBiasEnabled&&(q=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",q&&(b+=1,h.push(`Index ${o.direction}`))),O("index-bias","Index bias alignment",n.indexBiasEnabled?q:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const y=Fa(e,c,n);return O("options-context","Options context filter",y.allowed,y.reason),y.allowed?(O("score-gate","Final score gate",b>=R,`${b.toFixed(1)}/${R.toFixed(1)}`),{enter:b>=R,reason:h.join(", ")||"No strong signals",score:b,minScore:Number(R.toFixed(2)),checks:w,spread:u,depthRatio:N,expectedSlippage:Math.max(0,u/2)}):F(y.reason,"options-context")}function Ba(e,t,n,r,i,a,o){const c=i?n-t:t-n,l=i?r-t:t-r,u=Da(a.trailInitialSL,o,a);if(e==="INITIAL"){const m=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return c>=m?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-u:t+u,newStage:"INITIAL"}}return e==="BREAKEVEN"?l>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?l>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?l>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function qa(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}function Vs(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function Ga(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let l=1;l<=t;l++){const u=e[l]-e[l-1];u>0?n+=u:r+=-u}let i=n/t,a=r/t;for(let l=t+1;l<e.length;l++){const u=e[l]-e[l-1],p=u>0?u:0,m=u<0?-u:0;i=(i*(t-1)+p)/t,a=(a*(t-1)+m)/t}if(a===0)return 100;const c=100-100/(1+i/a);return Number.isFinite(c)?c:null}function _s(e){return{ema9:Vs(e,9),ema21:Vs(e,21),supertrend:null,rsi:Ga(e,14),vwap:null}}function Rn(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function An(e,t,n=360){e.push(t),e.length>n&&e.splice(0,e.length-n)}function $n(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const n=Math.max(3,t+1),r=e.slice(-n);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const i=[];for(let u=1;u<r.length;u++){const p=r[u]-r[u-1];i.push(p>0&&Number.isFinite(p)?p:0)}if(i.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const a=i[i.length-1],o=i.slice(0,-1),c=o.length>0?o.reduce((u,p)=>u+p,0)/o.length:0,l=c>0?a/c:null;return{latestDelta:a,avgDelta:c>0?c:null,ratio:l}}function Ka(e){const n=je(z=>z.apiKey),r=je(z=>z.setApiKey),i=S(z=>z.underlying),a=S(z=>z.indexExchange),o=S(z=>z.selectedCESymbol),c=S(z=>z.selectedPESymbol),l=S(z=>z.optionExchange),u=S(z=>z.quantity),p=S(z=>z.lotSize),m=S(z=>z.product),g=S(z=>z.tpPoints),b=S(z=>z.slPoints),h=S(z=>z.selectedStrike),f=S(z=>z.paperMode),w=W(z=>z.enabled),N=W(z=>z.mode),P=W(z=>z.config),k=W(z=>z.activePresetId),R=W(z=>z.optionsContext),O=W(z=>z.regime),F=W(z=>z.consecutiveLosses),G=W(z=>z.tradesCount),I=W(z=>z.realizedPnl),C=W(z=>z.lastTradePnl),_=W(z=>z.lastTradeTime),U=W(z=>z.tradesThisMinute),E=W(z=>z.lastLossTime),K=W(z=>z.sideEntryCount),M=W(z=>z.sideLastExitAt),H=W(z=>z.replayMode),v=W(z=>z.killSwitch),T=W(z=>z.lockProfitTriggered),Z=W(z=>z.setRegime),V=W(z=>z.addGhostSignal),q=W(z=>z.recordTrade),y=W(z=>z.recordAutoEntry),$=W(z=>z.pushDecision),x=W(z=>z.pushExecutionSample),D=re(z=>z.virtualTPSL),B=re(z=>z.setVirtualTPSL),X=d.useRef([]),Q=d.useRef([]),ee=d.useRef([]),te=d.useRef([]),fe=d.useRef([]),de=d.useRef([]),L=d.useRef(0),ne=d.useRef(!1),ve=d.useRef({CE:"",PE:""}),Se=d.useRef({CE:0,PE:0}),ye=d.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}}),Pe=d.useRef(0),we=d.useCallback(async()=>{if(n)return n;try{const Te=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(Te.status==="success"&&Te.api_key)return r(Te.api_key),Te.api_key}catch(z){console.error("[AutoTrade] Failed to fetch API key:",z)}return null},[n,r]);d.useEffect(()=>{if(!w||!e)return;const z=Date.now();if(z-L.current<100)return;L.current=z;const Te=o,Qe=c,Je=e.get(`${a}:${i}`)?.data?.ltp,He=Te?e.get(`${l}:${Te}`)?.data?.ltp:void 0,nt=Qe?e.get(`${l}:${Qe}`)?.data?.ltp:void 0,Y=Rn(e.get(`${a}:${i}`)?.data?.volume),oe=Te?Rn(e.get(`${l}:${Te}`)?.data?.volume):null,Ce=Qe?Rn(e.get(`${l}:${Qe}`)?.data?.volume):null;Je&&(X.current.push(Je),X.current.length>300&&(X.current=X.current.slice(-300))),He&&(Q.current.push(He),Q.current.length>300&&(Q.current=Q.current.slice(-300))),nt&&(ee.current.push(nt),ee.current.length>300&&(ee.current=ee.current.slice(-300))),Y!=null&&An(te.current,Y),oe!=null&&An(fe.current,oe),Ce!=null&&An(de.current,Ce);const pt=Math.max(5,Number(P.volumeLookbackTicks)||20),mt=$n(te.current,pt),_e=$n(fe.current,pt),Be=$n(de.current,pt),$t=k==="expiry",{sensitivity:bn}=Vn(new Date,$t),ae=R&&z-R.lastUpdated<=2e4?R:null;for(const xe of["CE","PE"]){const pe=xe==="CE"?Te:Qe,Re=xe==="CE"?He:nt,qe=xe==="CE"?Q.current:ee.current,st=Object.values(D).some(le=>le.side===xe),rt=xe==="CE"?_e:Be,ot=xe==="CE"?Be:_e,Xt=rt.latestDelta!=null&&ot.latestDelta!=null?rt.latestDelta/Math.max(1,ot.latestDelta):null,Qt={indexDelta:mt.latestDelta,indexDeltaRatio:mt.ratio,optionDelta:rt.latestDelta,optionDeltaRatio:rt.ratio,oppositeDelta:ot.latestDelta,sideDominanceRatio:Xt};if(!pe||!Re||qe.length<5)continue;const Ot=Ra(qe,P),vn=_s(qe),Jt=_s(X.current),Sn=Oa(Jt,P),it=`${l}:${pe}`,Ft=e.get(it)?.data?.bid_price,en=e.get(it)?.data?.ask_price,Pn=Ft&&en?en-Ft:2,jt=e.get(it)?.data?.depth;let Dt;if(jt?.buy?.length&&jt?.sell?.length){const le=jt.buy.reduce((me,ie)=>me+(ie.quantity||0),0),se=jt.sell.reduce((me,ie)=>me+(ie.quantity||0),0);le>0&&se>0&&(Dt={totalBid:le,totalAsk:se})}const j={consecutiveLosses:F,tradesCount:G,realizedPnl:I,lastTradeTime:_,tradesThisMinute:U,lastLossTime:E,requestedLots:u,sideOpen:st,lastExitAtForSide:M[xe],reEntryCountForSide:K[xe],lastTradePnl:C,killSwitch:v||T},A=_a(xe,Re,P,j,Ot,vn,Sn,ae,bn,Pn,Dt,qe,Qt),J=`${A.enter}|${A.blockedBy??""}|${A.reason}|${A.score.toFixed(2)}|${A.minScore.toFixed(2)}`;(J!==ve.current[xe]||z-Se.current[xe]>=1e3)&&($({timestamp:z,side:xe,symbol:pe,enter:A.enter,score:A.score,minScore:A.minScore,reason:A.reason,blockedBy:A.blockedBy,spread:A.spread,depthRatio:A.depthRatio,expectedSlippage:A.expectedSlippage,checks:A.checks,regime:O}),ve.current[xe]=J,Se.current[xe]=z);const ue=qa(xe,pe,h??0,Re,A,O,ae?.pcr);if(ue){const le=`${pe}|${A.reason}|${A.score.toFixed(1)}`,se=ye.current[xe];(le!==se.sig||z-se.at>=2500)&&(V(ue),ye.current[xe]={at:z,sig:le},es.message(`Signal ${xe} ${pe.slice(-12)}`,{description:`${A.score.toFixed(1)} / ${A.minScore.toFixed(1)} | ${A.reason}`}))}if(N==="execute"&&!H&&A.enter&&!ne.current){ne.current=!0;const le="BUY",se=u*p;(async()=>{const ie=()=>{const ge=W.getState();return ge.enabled&&ge.mode==="execute"&&!ge.replayMode&&!(ge.killSwitch||ge.lockProfitTriggered)};try{if(!ie()){x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:A.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}const ge=f?null:await we();if(!f&&!ge){x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:A.expectedSlippage,status:"rejected",reason:"Missing API key"}),Date.now()-Pe.current>5e3&&(Pe.current=Date.now(),es.error("Auto execute blocked: API key missing"));return}let Le=null;if(!f&&ge){const ft={apikey:ge,strategy:"Scalping-Auto",exchange:l,symbol:pe,action:le,quantity:se,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0},Ge=await he.placeOrder(ft);if(Ge.status!=="success"){x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:A.expectedSlippage,status:"rejected",reason:"Order rejected"});return}Le=vt(Ge),console.log(`[AutoTrade] ${le} ${pe} id=${Le??"n/a"} score=${A.score}`)}else console.log(`[AutoTrade Paper] ${le} ${xe} ${pe} score=${A.score}`);if(!ie()){x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:A.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const at=f?await At({symbol:pe,exchange:l,preferredPrice:Re,apiKey:null}):await Pt({symbol:pe,exchange:l,orderId:Le,preferredPrice:Re,apiKey:ge});at>0&&B(Xe({symbol:pe,exchange:l,side:xe,action:le,entryPrice:at,quantity:se,tpPoints:g,slPoints:b,managedBy:"auto",autoEntryScore:A.score,autoEntryReason:A.reason})),q(0),y(xe),x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:Math.max(0,Math.abs((at>0?at:Re)-Re)),status:"filled",reason:A.reason}),P.telegramAlertsEntry&&Qn.sendBroadcast({message:`[AUTO ENTRY] ${xe} ${pe} qty=${se} score=${A.score.toFixed(1)} reason=${A.reason}`}).catch(()=>{})}catch(ge){x({timestamp:Date.now(),side:xe,symbol:pe,spread:A.spread,expectedSlippage:A.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",ge)}finally{ne.current=!1}})()}}const Ae=X.current.length>=P.regimeDetectionPeriod?X.current:Q.current;if(Ae.length>=P.regimeDetectionPeriod){const xe=Ae.slice(-P.regimeDetectionPeriod).map((Re,qe,st)=>({high:Math.max(Re,st[Math.max(0,qe-1)]??Re),low:Math.min(Re,st[Math.max(0,qe-1)]??Re),close:Re})),pe=Aa(xe,P);pe!==O&&Z(pe)}},[w,e,N,P,k,o,c,R,O,F,G,I,_,U,E,C,K,M,H,v,T,we,l,u,p,m,g,b,f,h,V,q,y,$,x,Z,D,B,i,a])}function Wa(e){const t=je(I=>I.apiKey),n=je(I=>I.setApiKey),r=S(I=>I.paperMode),i=S(I=>I.product),a=S(I=>I.addSessionPnl),o=S(I=>I.incrementTradeCount),c=W(I=>I.config),l=W(I=>I.optionsContext),u=W(I=>I.recordAutoExit),p=W(I=>I.recordTradeOutcome),m=W(I=>I.pushExecutionSample),g=re(I=>I.virtualTPSL),b=re(I=>I.triggerOrders),h=re(I=>I.removeTriggerOrder),f=re(I=>I.setVirtualTPSL),w=re(I=>I.removeVirtualTPSL),N=d.useRef(t),P=d.useRef(r),k=d.useRef(i);d.useEffect(()=>{N.current=t},[t]),d.useEffect(()=>{P.current=r},[r]),d.useEffect(()=>{k.current=i},[i]);const R=d.useRef(new Set),O=d.useCallback(async()=>{if(N.current)return N.current;try{const C=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(C.status==="success"&&C.api_key)return N.current=C.api_key,n(C.api_key),C.api_key}catch(I){console.error("[Scalping] Failed to fetch API key:",I)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[n]),F=d.useCallback(async(I,C,_,U,E)=>{const K=U==="BUY"?"SELL":"BUY";if(P.current)return console.log(`[Paper TP/SL] ${E}: ${K} ${I} qty=${_}`),!0;const M=await O();if(!M)return!1;const H={apikey:M,strategy:"Scalping",exchange:C,symbol:I,action:K,quantity:_,pricetype:"MARKET",product:k.current,price:0,trigger_price:0,disclosed_quantity:0};try{const v=await he.placeOrder(H);if(v.status==="success"){const T=vt(v);return console.log(`[Scalping TP/SL] ${E}: ${K} ${I} id=${T??"n/a"}`),!0}}catch(v){console.error(`[Scalping TP/SL] ${E} order failed:`,v)}try{if((await he.closePosition(I,C,k.current)).status==="success")return console.log(`[Scalping TP/SL] ${E}: closePosition fallback ${I}`),!0}catch(v){console.error(`[Scalping TP/SL] ${E} closePosition fallback failed:`,v)}return!1},[O]),G=d.useCallback(async(I,C,_,U)=>{if(P.current)return console.log(`[Paper Trigger] Entry: ${U} ${I} qty=${_}`),{ok:!0,orderId:null};const E=await O();if(!E)return{ok:!1,orderId:null};const K={apikey:E,strategy:"Scalping",exchange:C,symbol:I,action:U,quantity:_,pricetype:"MARKET",product:k.current,price:0,trigger_price:0,disclosed_quantity:0};try{const M=await he.placeOrder(K);if(M.status==="success"){const H=vt(M);return console.log(`[Scalping Trigger] Entry: ${U} ${I} id=${H??"n/a"}`),{ok:!0,orderId:H}}}catch(M){console.error("[Scalping Trigger] Entry failed:",M)}return{ok:!1,orderId:null}},[O]);d.useEffect(()=>{if(!e)return;const I=(C,_,U)=>{R.current.add(C.id);const K=C.action==="BUY"?(_-C.entryPrice)*C.quantity:(C.entryPrice-_)*C.quantity;F(C.symbol,C.exchange,C.quantity,C.action,`${U} at ${_}`).then(M=>{M&&(w(C.id),a(K),o(),C.managedBy==="auto"&&(u(C.side,K),p(K),m({timestamp:Date.now(),side:C.side,symbol:C.symbol,spread:0,expectedSlippage:0,status:"exited",reason:U}),c.telegramAlertsExit&&Qn.sendBroadcast({message:`[AUTO EXIT] ${C.side} ${C.symbol} pnl=${K.toFixed(0)} reason=${U}`}).catch(()=>{}))),R.current.delete(C.id)})};for(const C of Object.values(g)){const _=`${C.exchange}:${C.symbol}`,E=(e.get(_)??e.get(C.symbol))?.data?.ltp;if(!E||R.current.has(C.id))continue;const K=C.action==="BUY",M=K?(E-C.entryPrice)*C.quantity:(C.entryPrice-E)*C.quantity;if(C.managedBy==="auto"){if(c.perTradeMaxLoss>0&&M<=-c.perTradeMaxLoss){I(C,E,`Per-trade max loss ${c.perTradeMaxLoss}`);continue}const H=za(C.side,l,c);if(H.exit){I(C,E,`Options early-exit: ${H.reason}`);continue}}if(C.tpPrice!==null&&(K?E>=C.tpPrice:E<=C.tpPrice)){I(C,E,"TP hit");continue}C.slPrice!==null&&(K?E<=C.slPrice:E>=C.slPrice)&&I(C,E,"SL hit")}for(const C of Object.values(b)){const _=`${C.exchange}:${C.symbol}`,E=(e.get(_)??e.get(C.symbol))?.data?.ltp;if(!E||R.current.has(C.id))continue;(C.direction==="above"?E>=C.triggerPrice:E<=C.triggerPrice)&&(R.current.add(C.id),G(C.symbol,C.exchange,C.quantity,C.action).then(async({ok:M,orderId:H})=>{try{if(M&&(h(C.id),o(),E>0)){const v=N.current,T=P.current?E:await Pt({symbol:C.symbol,exchange:C.exchange,orderId:H,preferredPrice:E,apiKey:v});T>0&&f(Xe({symbol:C.symbol,exchange:C.exchange,side:C.side,action:C.action,entryPrice:T,quantity:C.quantity,tpPoints:C.tpPoints,slPoints:C.slPoints,managedBy:"trigger"}))}}finally{R.current.delete(C.id)}}))}},[e,g,b,F,G,h,f,w,a,o,c,l,u,p,m])}function Ua(){const e=W(b=>b.config),t=W(b=>b.optionsContext),n=W(b=>b.setTrailStage),r=W(b=>b.setHighSinceEntry),i=re(b=>b.virtualTPSL),a=re(b=>b.updateVirtualTPSL),o=d.useRef(e),c=d.useRef(t),l=d.useRef({}),u=d.useRef({}),p=d.useRef({}),m=d.useRef({});d.useEffect(()=>{o.current=e},[e]),d.useEffect(()=>{c.current=t},[t]);const g=d.useMemo(()=>Object.values(i).filter(b=>b.managedBy==="auto"&&b.slPrice!=null),[i]);d.useEffect(()=>{const b=Ht.getInstance(),h=new Set(g.map(f=>f.id));for(const[f,w]of Object.entries(m.current))h.has(f)||(w(),delete m.current[f],delete l.current[f],delete u.current[f],delete p.current[f]);for(const f of g)m.current[f.id]||(l.current[f.id]="INITIAL",u.current[f.id]=f.entryPrice,p.current[f.id]=f.slPrice??f.entryPrice,m.current[f.id]=b.subscribe(f.symbol,f.exchange,"LTP",w=>{const N=w.data.ltp;if(!N||N<=0)return;const P=re.getState().virtualTPSL[f.id];if(!P||P.slPrice==null)return;const k=P.action==="BUY",R=u.current[f.id]??P.entryPrice,O=k?Math.max(R,N):Math.min(R,N);O!==R&&(u.current[f.id]=O,r(O));const F=l.current[f.id]??"INITIAL",G=Ba(F,P.entryPrice,N,O,k,o.current,c.current);G.newStage!==F&&(l.current[f.id]=G.newStage,n(G.newStage));const I=Math.round(G.newSL/.05)*.05,C=P.slPrice,_=p.current[f.id],U=k?Math.max(C??I,I):Math.min(C??I,I),E=C==null||Math.abs(U-C)>=.05,K=_==null||Math.abs(U-_)>=.05;E&&K&&(p.current[f.id]=U,a(f.id,{slPrice:U}))}));return()=>{}},[g,r,n,a]),d.useEffect(()=>()=>{for(const b of Object.values(m.current))b();m.current={},l.current={},u.current={},p.current={}},[])}const Ha=2500;function Jn(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function dt(e){return Jn(e)??0}function Ya(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Za(e){const t=Jn(e.pnl);if(t!==null)return t;const n=dt(e.ltp),r=dt(e.average_price),i=Math.abs(dt(e.quantity));return(dt(e.quantity)>0?n-r:r-n)*i}function Xa(){const e=je(P=>P.apiKey),t=je(P=>P.setApiKey),n=Tt(P=>P.unifiedMode),[r,i]=d.useState([]),[a,o]=d.useState(!1),c=d.useCallback(async()=>{if(e)return e;try{const k=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(k.status==="success"&&k.api_key)return t(k.api_key),k.api_key}catch{}return null},[e,t]),l=d.useCallback(async()=>{const P=await c();if(!P){o(!1);return}o(!0);try{const k=await he.getPositions(P);k.status==="success"&&k.data&&i(Array.isArray(k.data)?k.data:[])}catch{}finally{o(!1)}},[c]);d.useEffect(()=>{l();const P=setInterval(l,Ha);return()=>clearInterval(P)},[l]);const{data:u,isLive:p,isPaused:m}=kr(r,{enabled:!n&&r.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),g=d.useMemo(()=>n?r:u,[n,r,u]),b=d.useMemo(()=>g.flatMap(P=>{const k=Ya(P.symbol);if(!k)return[];const R=dt(P.quantity),O=Math.abs(R);if(O===0)return[];const F=dt(P.ltp),G=dt(P.average_price),I=R>0,C=I?F-G:G-F,U=Jn(P.pnl)??C*O;return[{symbol:P.symbol,exchange:P.exchange,side:k,action:I?"BUY":"SELL",quantity:O,avgPrice:G,ltp:F,pnl:U,pnlPoints:C,product:P.product}]}),[g]),h=d.useMemo(()=>r.some(P=>dt(P.quantity)!==0),[r]),f=d.useMemo(()=>g.reduce((P,k)=>P+Za(k),0),[g]),w=d.useCallback(P=>b.find(k=>k.side===P),[b]),N=d.useMemo(()=>r.map(P=>({symbol:P.symbol,exchange:P.exchange})),[r]);return{positions:b,totalPnl:f,isLive:!n&&p&&h,isPaused:!n&&m,isLoading:a,refetch:l,getPositionForSide:w,positionSymbols:N}}const Qa=1e3,Ja=100;function dn(e){const t=Number(e);return Number.isFinite(t)&&t>0?t:null}function eo(e){const t=String(e??"").trim().toUpperCase();return t==="BUY"||t==="SELL"?t:null}function to(e,t){const n=String(e??"").trim().toUpperCase();return n==="CE"||n==="PE"?n:t.toUpperCase().endsWith("PE")?"PE":"CE"}function no(){const e=je(l=>l.apiKey),t=je(l=>l.setApiKey),n=S(l=>l.tpPoints),r=S(l=>l.slPoints),i=re(l=>l.setVirtualTPSL),a=d.useRef(!1),o=d.useCallback(async()=>{if(e)return e;try{const u=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(u.status==="success"&&u.api_key)return t(u.api_key),u.api_key}catch{}return null},[e,t]),c=d.useCallback(async(l,u)=>{const p=Number(l.id);if(!Number.isInteger(p)||p<=0)return!1;const m=String(l.symbol??"").trim().toUpperCase(),g=String(l.exchange??"NFO").trim().toUpperCase(),b=eo(l.action),h=Math.trunc(dn(l.quantity)??0);if(!m||!b||h<=0)return!1;const f=`flow-${p}`;if(re.getState().virtualTPSL[f])return!0;const N=to(l.side,m),P=dn(l.tp_points)??n,k=dn(l.sl_points)??r,R=dn(l.entry_price),O=String(l.order_id??"").trim()||null,F=await Pt({symbol:m,exchange:g,orderId:O,preferredPrice:R,fallbackPrice:R,apiKey:u});if(!(F>0))return!1;const G=Number(l.created_at);return i(Xe({id:f,symbol:m,exchange:g,side:N,action:b,entryPrice:F,quantity:h,tpPoints:P,slPoints:k,managedBy:"flow",createdAt:Number.isFinite(G)&&G>0?G:Date.now()})),!0},[n,r,i]);d.useEffect(()=>{let l=!0,u=null;async function p(){if(!l||a.current){m();return}a.current=!0;try{const g=await o();if(!g)return;const b=await he.getScalpingBridgePending(g,Ja),h=Array.isArray(b.data?.entries)?b.data.entries:[];if(!h.length)return;const f=[];for(const w of h)try{await c(w,g)&&f.push(Number(w.id))}catch{}f.length&&await he.ackScalpingBridgeEntries(g,f)}catch{}finally{a.current=!1,m()}}function m(){l&&(u=setTimeout(p,Qa))}return p(),()=>{l=!1,u&&clearTimeout(u)}},[c,o])}const so=15e3;function Po(){const[e,t]=d.useState(!1),n=d.useRef(!1),r=d.useCallback(()=>t(x=>!x),[]),i=d.useCallback(()=>t(!1),[]),a=S(x=>x.paperMode),o=S(x=>x.underlying),c=S(x=>x.indexExchange),l=S(x=>x.optionExchange),u=S(x=>x.product),p=S(x=>x.quantity),m=S(x=>x.lotSize),g=S(x=>x.incrementTradeCount),b=S(x=>x.setLimitPrice),h=S(x=>x.setPendingEntryAction),f=S(x=>x.pendingLimitPlacement),w=S(x=>x.clearPendingLimitPlacement),N=S(x=>x.selectedCESymbol),P=S(x=>x.selectedPESymbol),k=re(x=>x.virtualTPSL),R=re(x=>x.triggerOrders),O=re(x=>x.clearAll),F=re(x=>x.clearForSymbol),G=re(x=>x.clearTriggerOrders),I=re(x=>x.removeVirtualTPSL),C=re(x=>x.updateVirtualTPSL),_=re(x=>x.setVirtualTPSL),U=W(x=>x.config.imbalanceFilterEnabled),E=W(x=>x.updateRiskState),K=je(x=>x.apiKey),M=je(x=>x.setApiKey);d.useEffect(()=>{K||fetch("/api/websocket/apikey",{credentials:"include"}).then(x=>x.json()).then(x=>{x.status==="success"&&x.api_key&&M(x.api_key)}).catch(()=>{})},[K,M]),d.useEffect(()=>{G()},[G]);const H=d.useCallback(async(x,D)=>{if(a){console.log(`[Paper] Close ${x} ${D}`),F(D),b(null),h(null),w();return}try{await he.closePosition(D,l,u),console.log(`[Scalping] Closed ${x} ${D}`),F(D),b(null),h(null),w()}catch(B){console.error("[Scalping] Close failed:",B)}},[a,l,u,F,b,h,w]),v=d.useCallback(async()=>{if(a){console.log("[Paper] Close all positions"),O(),b(null),h(null),w();return}try{await he.closeAllPositions(),console.log("[Scalping] Closed all positions"),O(),b(null),h(null),w()}catch(x){console.error("[Scalping] Close all failed:",x)}},[a,O,b,h,w]),T=d.useCallback(async(x,D)=>{if(a){console.log(`[Paper] Reverse ${x} ${D}`);return}if(K)try{await he.closePosition(D,l,u),await he.placeOrder({apikey:K,strategy:"Scalping",exchange:l,symbol:D,action:"SELL",quantity:p*m,pricetype:"MARKET",product:u,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${x} ${D}`)}catch(B){console.error("[Scalping] Reversal failed:",B)}},[a,K,l,u,p,m]);Na({onToggleHelp:r,onClose:H,onCloseAll:v,onReversal:T}),Ia();const Z=d.useMemo(()=>{const x=[];o&&c&&x.push({symbol:o,exchange:c}),N&&x.push({symbol:N,exchange:l}),P&&x.push({symbol:P,exchange:l});for(const B of Object.values(k))x.push({symbol:B.symbol,exchange:B.exchange});for(const B of Object.values(R))x.push({symbol:B.symbol,exchange:B.exchange});const D=new Map;for(const B of x)D.set(`${B.exchange}:${B.symbol}`,B);return Array.from(D.values())},[o,c,N,P,l,k,R]),{data:V}=Ys({symbols:Z,mode:U?"Quote":"LTP",enabled:Z.length>0}),{positions:q,totalPnl:y,isLive:$}=Xa();return no(),d.useEffect(()=>{E(y)},[y,E]),d.useEffect(()=>{if(a)return;const x=new Map(q.map(ee=>[ee.symbol,ee])),D=Object.values(k);for(const ee of D){const te=x.get(ee.symbol);if(!te){const fe=typeof ee.createdAt=="number"?ee.createdAt:0;if((fe>0?Date.now()-fe:Number.POSITIVE_INFINITY)<so)continue;I(ee.id);continue}(te.side!==ee.side||te.action!==ee.action||ee.quantity<=0)&&I(ee.id)}const B=Object.values(re.getState().virtualTPSL),X=new Map;for(const ee of B){const te=X.get(ee.symbol)??[];te.push(ee),X.set(ee.symbol,te)}for(const[ee,te]of X.entries()){const fe=x.get(ee);if(!fe)continue;const de=Math.max(0,fe.quantity);let ne=te.reduce((Se,ye)=>Se+Math.max(0,ye.quantity),0)-de;if(ne<=0)continue;const ve=[...te].sort((Se,ye)=>ye.createdAt-Se.createdAt);for(const Se of ve){if(ne<=0)break;const ye=Math.max(0,Se.quantity);if(ye<=ne+1e-6){I(Se.id),ne-=ye;continue}const Pe=Math.max(0,Number((ye-ne).toFixed(2)));C(Se.id,{quantity:Pe}),ne=0}}if(!f||n.current)return;const Q=x.get(f.symbol);Q&&(Q.side!==f.side||Q.action!==f.action||(n.current=!0,(async()=>{try{const ee=await Pt({symbol:f.symbol,exchange:Q.exchange,orderId:f.orderId,preferredPrice:f.entryPrice,fallbackPrice:Q.avgPrice,apiKey:K});if(ee<=0)return;_(Xe({symbol:f.symbol,exchange:Q.exchange,side:f.side,action:f.action,entryPrice:ee,quantity:f.quantity,tpPoints:f.tpPoints,slPoints:f.slPoints,managedBy:"manual"})),g(),w(),b(null),h(null)}finally{n.current=!1}})()))},[a,q,k,f,K,I,C,_,g,w,b,h]),Ka(V),Ua(),Wa(V),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(di,{liveOpenPnl:y,isLivePnl:$}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:s.jsxs(Fn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(ht,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(fi,{})}),s.jsx(fn,{withHandle:!0,className:"bg-border/70"}),s.jsx(ht,{defaultSize:"50%",minSize:"30%",children:s.jsx(Qi,{})}),s.jsx(fn,{withHandle:!0,className:"bg-border/70"}),s.jsx(ht,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx(Sa,{liveOpenPnl:y,isLivePnl:$})})]})}),s.jsx(xi,{positions:q,totalPnl:y,isLivePnl:$}),s.jsx(ja,{open:e,onClose:i})]})}export{Po as default};
