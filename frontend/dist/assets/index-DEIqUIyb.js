import{r as u,j as s}from"./vendor-react-CCyQGCED.js";import{c as Re,v as Tn,$ as fn,a3 as mn,d as ve,e as Ne,u as ms,M as Pt,B as fe,w as Ve,t as Hs}from"./index-CFMiBD1J.js";import{aU as Ys}from"./vendor-icons-CCn_k3dF.js";import{u as xs}from"./useQuery-Ckcoc2BT.js";import{S as Jt,a as en,b as tn,c as nn,d as Rt}from"./select-CAAD4orC.js";import{u as Zs}from"./useOptionChainLive-B3oW_P8C.js";import{q as hs,K as gs,W as ys,R as bs,n as Ye,h as Ke}from"./lightweight-charts.production-fmEoZjtL.js";import{t as ye}from"./trading-Bx4J4I-b.js";import{a as vs}from"./useMarketStatus-A2KdFaNs.js";import{I as Ze}from"./input-D0kO4NxT.js";import{L as Fe}from"./label-CeQ_CNqx.js";import{S as St}from"./switch-D1rquEq9.js";import{f as Xs,r as Qs,a as Js,b as er}from"./ai-scalper-BMNqFgIA.js";import{u as tr}from"./useLivePrice-B9XXJjq0.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";function ge(e,t="Assertion error"){if(!e)throw Error(t)}function mt({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function cn(e,t){return t.sort(e==="horizontal"?nr:sr)}function nr(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function sr(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function Ss(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function js(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function rr({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:l,y:c}=js(r,o),d=e==="horizontal"?l:c;d<a&&(a=d,i=o)}return ge(i,"No rect found"),i}let $t;function ir(){return $t===void 0&&(typeof matchMedia=="function"?$t=!!matchMedia("(pointer:coarse)").matches:$t=!1),$t}function Ns(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=cn(n,Array.from(t.children).filter(Ss).map(p=>({element:p}))).map(({element:p})=>p),o=[];let l=!1,c,d=[];for(const p of a)if(p.hasAttribute("data-panel")){const f=r.find(b=>b.element===p);if(f){if(c){const b=c.element.getBoundingClientRect(),j=p.getBoundingClientRect();let m;if(l){const h=n==="horizontal"?new DOMRect(b.right,b.top,0,b.height):new DOMRect(b.left,b.bottom,b.width,0),v=n==="horizontal"?new DOMRect(j.left,j.top,0,j.height):new DOMRect(j.left,j.top,j.width,0);switch(d.length){case 0:{m=[h,v];break}case 1:{const N=d[0],C=rr({orientation:n,rects:[b,j],targetRect:N.element.getBoundingClientRect()});m=[N,C===b?v:h];break}default:{m=d;break}}}else d.length?m=d:m=[n==="horizontal"?new DOMRect(b.right,j.top,j.left-b.right,j.height):new DOMRect(j.left,b.bottom,j.width,j.top-b.bottom)];for(const h of m){let v="width"in h?h:h.element.getBoundingClientRect();const N=ir()?37:27;if(v.width<N){const C=N-v.width;v=new DOMRect(v.x-C/2,v.y,v.width+C,v.height)}if(v.height<N){const C=N-v.height;v=new DOMRect(v.x,v.y-C/2,v.width,v.height+C)}o.push({group:e,groupSize:mt({group:e}),panels:[c,f],separator:"width"in h?void 0:h,rect:v})}}l=!1,c=f,d=[]}}else if(p.hasAttribute("data-separator")){const f=i.find(b=>b.element===p);f?d.push(f):(c=void 0,d=[])}else l=!0;return o}function ar(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function or(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function lr(e){return e/100*window.innerHeight}function cr(e){return e/100*window.innerWidth}function dr(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function It({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=dr(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=or(t,i);break}case"em":{r=ar(t,i);break}case"vh":{r=lr(i);break}case"vw":{r=cr(i);break}}return r}function Be(e){return parseFloat(e.toFixed(3))}function En(e){const{panels:t}=e,n=mt({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const p=It({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=Be(p/n*100)}let l;if(a.defaultSize!==void 0){const p=It({groupSize:n,panelElement:i,styleProp:a.defaultSize});l=Be(p/n*100)}let c=0;if(a.minSize!==void 0){const p=It({groupSize:n,panelElement:i,styleProp:a.minSize});c=Be(p/n*100)}let d=100;if(a.maxSize!==void 0){const p=It({groupSize:n,panelElement:i,styleProp:a.maxSize});d=Be(p/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:l,minSize:c,maxSize:d,panelId:r.id}})}class ur{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let l=0;l<o.length;l++){const c=o[l];try{c.call(null,n)}catch(d){a===null&&(i=!0,a=d)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function ke(e,t,n=0){return Math.abs(Be(e)-Be(t))<=n}let ze={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const st=new ur;function $e(){return ze}function Me(e){const t=typeof e=="function"?e(ze):e;if(ze===t)return ze;const n=ze;return ze={...ze,...t},t.cursorFlags!==void 0&&st.emit("cursorFlagsChange",ze.cursorFlags),t.interactionState!==void 0&&st.emit("interactionStateChange",ze.interactionState),t.mountedGroups!==void 0&&(ze.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const l=ke(a.collapsedSize,r.layout[a.panelId]),c=ke(a.collapsedSize,o[a.panelId]);l&&!c&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),st.emit("mountedGroupsChange",ze.mountedGroups)),ze}function pr(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=js(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function fr(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function mr(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:Mn(e),b:Mn(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;ge(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:Ln(kn(n.a)),b:Ln(kn(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let l=a.length;for(;l--;){const c=a[l];if(c===o.a)return 1;if(c===o.b)return-1}}return Math.sign(i.a-i.b)}const xr=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function hr(e){const t=getComputedStyle(Ps(e)??e).display;return t==="flex"||t==="inline-flex"}function gr(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||hr(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||xr.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function kn(e){let t=e.length;for(;t--;){const n=e[t];if(ge(n,"Missing node"),gr(n))return n}return null}function Ln(e){return e&&Number(getComputedStyle(e).zIndex)||0}function Mn(e){const t=[];for(;e;)t.push(e),e=Ps(e);return t}function Ps(e){const{parentNode:t}=e;return fr(t)?t.host:t}function yr(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function br({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!Ss(n)||n.contains(e)||e.contains(n))return!0;if(mr(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(yr(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function xn(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=Ns(i),o=pr(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&br({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function vr(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function wt(e,t){return ke(e,t)?0:e>t?1:-1}function ft({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(wt(t,a)<0)if(r){const o=(n+a)/2;wt(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=Be(t),t}function Ct({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if(ke(e,0))return t;const o=Object.values(t),l=Object.values(i),c=[...o],[d,p]=r;ge(d!=null,"Invalid first pivot index"),ge(p!=null,"Invalid second pivot index");let f=0;if(a==="keyboard"){{const m=e<0?p:d,h=n[m];ge(h,`Panel constraints not found for index ${m}`);const{collapsedSize:v=0,collapsible:N,minSize:C=0}=h;if(N){const I=o[m];if(ge(I!=null,`Previous layout not found for panel index ${m}`),ke(I,v)){const E=C-I;wt(E,Math.abs(e))>0&&(e=e<0?0-E:E)}}}{const m=e<0?d:p,h=n[m];ge(h,`No panel constraints found for index ${m}`);const{collapsedSize:v=0,collapsible:N,minSize:C=0}=h;if(N){const I=o[m];if(ge(I!=null,`Previous layout not found for panel index ${m}`),ke(I,C)){const E=I-v;wt(E,Math.abs(e))>0&&(e=e<0?0-E:E)}}}}{const m=e<0?1:-1;let h=e<0?p:d,v=0;for(;;){const C=o[h];ge(C!=null,`Previous layout not found for panel index ${h}`);const I=ft({panelConstraints:n[h],size:100})-C;if(v+=I,h+=m,h<0||h>=n.length)break}const N=Math.min(Math.abs(e),Math.abs(v));e=e<0?0-N:N}{let m=e<0?d:p;for(;m>=0&&m<n.length;){const h=Math.abs(e)-Math.abs(f),v=o[m];ge(v!=null,`Previous layout not found for panel index ${m}`);const N=v-h,C=ft({panelConstraints:n[m],size:N});if(!ke(v,C)&&(f+=v-C,c[m]=C,f.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?m--:m++}}if(vr(l,c))return i;{const m=e<0?p:d,h=o[m];ge(h!=null,`Previous layout not found for panel index ${m}`);const v=h+f,N=ft({panelConstraints:n[m],size:v});if(c[m]=N,!ke(N,v)){let C=v-N,I=e<0?p:d;for(;I>=0&&I<n.length;){const E=c[I];ge(E!=null,`Previous layout not found for panel index ${I}`);const z=E+C,O=ft({panelConstraints:n[I],size:z});if(ke(E,O)||(C-=O-E,c[I]=O),ke(C,0))break;e>0?I--:I++}}}const b=Object.values(c).reduce((m,h)=>h+m,0);if(!ke(b,100,.1))return i;const j=Object.keys(i);return c.reduce((m,h,v)=>(m[j[v]]=h,m),{})}function rt(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||wt(e[n],t[n])!==0)return!1;return!0}function it({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,l)=>o+l,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!ke(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const l=n[o];ge(l!=null,`No layout data found for index ${o}`);const c=100/r*l;n[o]=c}let i=0;for(let o=0;o<t.length;o++){const l=n[o];ge(l!=null,`No layout data found for index ${o}`);const c=ft({panelConstraints:t[o],size:l});l!=c&&(i+=l-c,n[o]=c)}if(!ke(i,0))for(let o=0;o<t.length;o++){const l=n[o];ge(l!=null,`No layout data found for index ${o}`);const c=l+i,d=ft({panelConstraints:t[o],size:c});if(l!==d&&(i-=d-l,n[o]=d,ke(i,0)))break}const a=Object.keys(e);return n.reduce((o,l,c)=>(o[a[c]]=l,o),{})}function ws({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:l}=$e();for(const[c,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:f,separatorToPanels:b}]of l)if(c.id===e)return{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:c,layout:f,separatorToPanels:b};throw Error(`Group ${e} not found`)},r=()=>{const l=n().derivedPanelConstraints.find(c=>c.panelId===t);if(l!==void 0)return l;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const l=n().group.panels.find(c=>c.id===t);if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const l=n().layout[t];if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},o=l=>{const c=a();if(l===c)return;const{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:f,layout:b,separatorToPanels:j}=n(),m=f.panels.findIndex(C=>C.id===t),h=m===f.panels.length-1,v=Ct({delta:h?c-l:l-c,initialLayout:b,panelConstraints:p,pivotIndices:h?[m-1,m]:[m,m+1],prevLayout:b,trigger:"imperative-api"}),N=it({layout:v,panelConstraints:p});rt(b,N)||Me(C=>({mountedGroups:new Map(C.mountedGroups).set(f,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:N,separatorToPanels:j})}))};return{collapse:()=>{const{collapsible:l,collapsedSize:c}=r(),{mutableValues:d}=i(),p=a();l&&p!==c&&(d.expandToSize=p,o(c))},expand:()=>{const{collapsible:l,collapsedSize:c,minSize:d}=r(),{mutableValues:p}=i(),f=a();if(l&&f===c){let b=p.expandToSize??d;b===0&&(b=1),o(b)}},getSize:()=>{const{group:l}=n(),c=a(),{element:d}=i(),p=l.orientation==="horizontal"?d.offsetWidth:d.offsetHeight;return{asPercentage:c,inPixels:p}},isCollapsed:()=>{const{collapsible:l,collapsedSize:c}=r(),d=a();return l&&ke(c,d)},resize:l=>{if(a()!==l){let c;switch(typeof l){case"number":{const{group:d}=n(),p=mt({group:d});c=Be(l/p*100);break}case"string":{c=parseFloat(l);break}}o(c)}}}}function Rn(e){if(e.defaultPrevented)return;const{mountedGroups:t}=$e(),n=xn(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(l=>l.panelConstraints.defaultSize!==void 0);if(o){const l=o.panelConstraints.defaultSize,c=ws({groupId:a.group.id,panelId:o.id});c&&l!==void 0&&(c.resize(l),e.preventDefault())}}})}function Bt(e){const{mountedGroups:t}=$e();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function Cs({groupId:e}){const t=()=>{const{mountedGroups:n}=$e();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:l}=t(),c=it({layout:n,panelConstraints:i});return r?o:(rt(o,c)||Me(d=>({mountedGroups:new Map(d.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:c,separatorToPanels:l})})),c)}}}function Ts(e){const{mountedGroups:t}=$e(),n=t.get(e);return ge(n,`Mounted Group ${e.id} not found`),n}function tt(e,t){const n=Bt(e),r=Ts(n),i=n.separators.find(p=>p.element===e);ge(i,"Matching separator not found");const a=r.separatorToPanels.get(i);ge(a,"Matching panels not found");const o=a.map(p=>n.panels.indexOf(p)),l=Cs({groupId:n.id}).getLayout(),c=Ct({delta:t,initialLayout:l,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:l,trigger:"keyboard"}),d=it({layout:c,panelConstraints:r.derivedPanelConstraints});rt(l,d)||Me(p=>({mountedGroups:new Map(p.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:d,separatorToPanels:r.separatorToPanels})}))}function $n(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=Bt(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&tt(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&tt(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&tt(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&tt(t,-5);break}case"End":{e.preventDefault(),tt(t,100);break}case"Enter":{e.preventDefault();const r=Bt(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=Ts(r),l=r.separators.find(f=>f.element===t);ge(l,"Matching separator not found");const c=o.get(l);ge(c,"Matching panels not found");const d=c[0],p=i.find(f=>f.panelId===d.id);if(ge(p,"Panel metadata not found"),p.collapsible){const f=a[d.id],b=p.collapsedSize===f?r.inMemoryLastExpandedPanelSizes[d.id]??p.minSize:p.collapsedSize;tt(t,b-f)}break}case"F6":{e.preventDefault();const r=Bt(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);ge(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),tt(t,-100);break}}}function In(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=$e(),n=xn(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let l=!1;n.forEach(c=>{r.add(c.group),c.panels.forEach(p=>{i.add(p)}),c.separator&&(a.add(c.separator),l||(l=!0,c.separator.element.focus()));const d=t.get(c.group);d&&o.set(c.group,d.layout)}),Me({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const Sr=e=>e,sn=()=>{},Es=1,ks=2,Ls=4,Ms=8,An=3,On=12;let At;function zn(){return At===void 0&&(At=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(At=!0)),At}function jr({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&zn()){const a=(e&Es)!==0,o=(e&ks)!==0,l=(e&Ls)!==0,c=(e&Ms)!==0;if(a)return l?"se-resize":c?"ne-resize":"e-resize";if(o)return l?"sw-resize":c?"nw-resize":"w-resize";if(l)return"s-resize";if(c)return"n-resize"}break}}return zn()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const Fn=new WeakMap;function hn(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=Fn.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=$e();switch(i.state){case"active":case"hover":{const a=jr({cursorFlags:r,groups:i.hitRegions.map(l=>l.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}Fn.set(e,{prevStyle:t,styleSheet:n})}function Rs({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let l=0;const c=new Map(i);n.forEach(p=>{const{group:f,groupSize:b}=p,{disableCursor:j,orientation:m,panels:h}=f;let v=0;a?m==="horizontal"?v=(t.clientX-a.x)/b*100:v=(t.clientY-a.y)/b*100:m==="horizontal"?v=t.clientX<0?-100:100:v=t.clientY<0?-100:100;const N=r.get(f),{defaultLayoutDeferred:C,derivedPanelConstraints:I,layout:E,separatorToPanels:z}=i.get(f)??{defaultLayoutDeferred:!1};if(I&&N&&E&&z){const O=Ct({delta:v,initialLayout:N,panelConstraints:I,pivotIndices:p.panels.map(L=>h.indexOf(L)),prevLayout:E,trigger:"mouse-or-touch"});if(rt(O,E)){if(v!==0&&!j)switch(m){case"horizontal":{l|=v<0?Es:ks;break}case"vertical":{l|=v<0?Ls:Ms;break}}}else{c.set(p.group,{defaultLayoutDeferred:C,derivedPanelConstraints:I,layout:O,separatorToPanels:z});const L=p.group.panels.map(({id:W})=>W).join(",");p.group.inMemoryLayouts[L]=O}}});let d=0;t.movementX===0?d|=o&An:d|=l&An,t.movementY===0?d|=o&On:d|=l&On,Me({cursorFlags:d,mountedGroups:c}),hn(e)}function Dn(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=$e();n.state==="active"&&Rs({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function Vn(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=$e();switch(n.state){case"active":{if(e.buttons===0){Me(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),Me(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Rs({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=xn(e,r);i.length===0?n.state!=="inactive"&&Me({interactionState:{state:"inactive"}}):Me({interactionState:{hitRegions:i,state:"hover"}}),hn(e.currentTarget);break}}}function _n(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=$e();t.state==="active"&&(Me({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(hn(e.currentTarget),Me(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function Bn(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=Be(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=Be((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function Nr(e,t,n){if(!n[0])return;const r=e.panels.find(c=>c.element===t);if(!r||!r.onResize)return;const i=mt({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,l={asPercentage:Be(a/i*100),inPixels:a};r.mutableValues.prevSize=l,r.onResize(l,r.id,o)}function Pr(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function wr(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const lt=new Map;function Cr(e){let t=!0;ge(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(m=>{for(const h of m){const{borderBoxSize:v,target:N}=h;if(N===e.element){if(t){if(mt({group:e})===0)return;Me(C=>{const I=C.mountedGroups.get(e);if(I){const E=En(e),z=I.defaultLayoutDeferred?Bn(E):I.layout,O=it({layout:z,panelConstraints:E});return!I.defaultLayoutDeferred&&rt(z,O)&&Pr(I.derivedPanelConstraints,E)?C:{mountedGroups:new Map(C.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:E,layout:O,separatorToPanels:I.separatorToPanels})}}return C})}}else Nr(e,N,v)}});a.observe(e.element),e.panels.forEach(m=>{ge(!r.has(m.id),`Panel ids must be unique; id "${m.id}" was used more than once`),r.add(m.id),m.onResize&&a.observe(m.element)});const o=mt({group:e}),l=En(e),c=e.panels.map(({id:m})=>m).join(",");let d=e.defaultLayout;d&&(wr(e.panels,d)||(d=void 0));const p=e.inMemoryLayouts[c]??d??Bn(l),f=it({layout:p,panelConstraints:l}),b=Ns(e),j=e.element.ownerDocument;return Me(m=>{const h=new Map;return lt.set(j,(lt.get(j)??0)+1),b.forEach(v=>{v.separator&&h.set(v.separator,v.panels)}),{mountedGroups:new Map(m.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:l,layout:f,separatorToPanels:h})}}),e.separators.forEach(m=>{ge(!i.has(m.id),`Separator ids must be unique; id "${m.id}" was used more than once`),i.add(m.id),m.element.addEventListener("keydown",$n)}),lt.get(j)===1&&(j.addEventListener("dblclick",Rn,!0),j.addEventListener("pointerdown",In,!0),j.addEventListener("pointerleave",Dn),j.addEventListener("pointermove",Vn),j.addEventListener("pointerup",_n,!0)),function(){t=!1,lt.set(j,Math.max(0,(lt.get(j)??0)-1)),Me(m=>{const h=new Map(m.mountedGroups);return h.delete(e),{mountedGroups:h}}),e.separators.forEach(m=>{m.element.removeEventListener("keydown",$n)}),lt.get(j)||(j.removeEventListener("dblclick",Rn,!0),j.removeEventListener("pointerdown",In,!0),j.removeEventListener("pointerleave",Dn),j.removeEventListener("pointermove",Vn),j.removeEventListener("pointerup",_n,!0)),a.disconnect()}}function $s(){const[e,t]=u.useState({}),n=u.useCallback(()=>t({}),[]);return[e,n]}function gn(e){const t=u.useId();return`${e??t}`}const at=typeof window<"u"?u.useLayoutEffect:u.useEffect;function Nt(e){const t=u.useRef(e);return at(()=>{t.current=e},[e]),u.useCallback((...n)=>t.current?.(...n),[t])}function yn(...e){return Nt(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function Tr(e){const t=u.useRef({...e});return at(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const Is=u.createContext(null);function Er(e,t){const n=u.useRef({getLayout:()=>({}),setLayout:Sr});u.useImperativeHandle(t,()=>n.current,[]),at(()=>{Object.assign(n.current,Cs({groupId:e}))})}function As({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:l,onLayoutChange:c,onLayoutChanged:d,orientation:p="horizontal",style:f,...b}){const j=u.useRef({onLayoutChange:{},onLayoutChanged:{}}),m=Nt(B=>{rt(j.current.onLayoutChange,B)||(j.current.onLayoutChange=B,c?.(B))}),h=Nt(B=>{rt(j.current.onLayoutChanged,B)||(j.current.onLayoutChanged=B,d?.(B))}),v=gn(l),N=u.useRef(null),[C,I]=$s(),E=u.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),z=yn(N,a);Er(v,o);const O=Nt((B,Y)=>{const{interactionState:G,mountedGroups:w}=$e();for(const g of w.keys())if(g.id===B){const R=w.get(g);if(R){let x=!1;return G.state==="active"&&(x=G.hitRegions.some(k=>k.group===g)),{flexGrow:R.layout[Y]??1,pointerEvents:x?"none":void 0}}}return{flexGrow:n?.[Y]??1}}),L=u.useMemo(()=>({getPanelStyles:O,id:v,orientation:p,registerPanel:B=>{const Y=E.current;return Y.panels=cn(p,[...Y.panels,B]),I(),()=>{Y.panels=Y.panels.filter(G=>G!==B),I()}},registerSeparator:B=>{const Y=E.current;return Y.separators=cn(p,[...Y.separators,B]),I(),()=>{Y.separators=Y.separators.filter(G=>G!==B),I()}}}),[O,v,I,p]),W=Tr({defaultLayout:n,disableCursor:r}),K=u.useRef(null);return at(()=>{const B=N.current;if(B===null)return;const Y=E.current,G={defaultLayout:W.defaultLayout,disableCursor:!!W.disableCursor,disabled:!!i,element:B,id:v,inMemoryLastExpandedPanelSizes:E.current.lastExpandedPanelSizes,inMemoryLayouts:E.current.layouts,orientation:p,panels:Y.panels,separators:Y.separators};K.current=G;const w=Cr(G),g=$e().mountedGroups.get(G);if(g){const{defaultLayoutDeferred:k,derivedPanelConstraints:y,layout:M}=g;!k&&y.length>0&&(m(M),h(M),Y.panels.forEach(P=>{P.scheduleUpdate()}))}const R=st.addListener("interactionStateChange",()=>{Y.panels.forEach(k=>{k.scheduleUpdate()})}),x=st.addListener("mountedGroupsChange",k=>{const y=k.get(G);if(y){const{defaultLayoutDeferred:M,derivedPanelConstraints:P,layout:F}=y;if(M||P.length===0)return;const{interactionState:D}=$e(),Z=D.state!=="active";m(F),Z&&h(F),Y.panels.forEach(U=>{U.scheduleUpdate()})}});return()=>{K.current=null,w(),R(),x()}},[i,v,h,m,p,C,W]),u.useEffect(()=>{const B=K.current;B&&(B.defaultLayout=n,B.disableCursor=!!r)}),s.jsx(Is.Provider,{value:L,children:s.jsx("div",{...b,"aria-orientation":p,className:t,"data-group":!0,"data-testid":v,id:v,ref:z,style:{height:"100%",width:"100%",overflow:"hidden",...f,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}As.displayName="Group";function bn(){const e=u.useContext(Is);return ge(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function kr(e,t){const{id:n}=bn(),r=u.useRef({collapse:sn,expand:sn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:sn});u.useImperativeHandle(t,()=>r.current,[]),at(()=>{Object.assign(r.current,ws({groupId:n,panelId:e}))})}function Os({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:l="100%",minSize:c="0%",onResize:d,panelRef:p,style:f,...b}){const j=!!o,m=gn(o),h=u.useRef(null),v=yn(h,a),[,N]=$s(),{getPanelStyles:C,id:I,registerPanel:E}=bn(),z=d!==null,O=Nt((W,K,B)=>{d?.(W,o,B)});at(()=>{const W=h.current;if(W!==null)return E({element:W,id:m,idIsStable:j,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:z?O:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:l,minSize:c},scheduleUpdate:N})},[n,r,i,N,z,m,j,l,c,O,E]),kr(m,p);const L=C(I,m);return s.jsx("div",{...b,"data-panel":!0,"data-testid":m,id:m,ref:v,style:{...Lr,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...L},children:s.jsx("div",{className:t,style:{flexGrow:1,...f},children:e})})}Os.displayName="Panel";const Lr={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function Mr({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],l=t.find(c=>c.panelId===n);if(l){const c=l.maxSize,d=a=l.collapsible?l.collapsedSize:l.minSize,p=[r,r+1];a=it({layout:Ct({delta:d-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=it({layout:Ct({delta:c-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function zs({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=gn(r),[l,c]=u.useState({}),[d,p]=u.useState("inactive"),f=u.useRef(null),b=yn(f,n),{id:j,orientation:m,registerSeparator:h}=bn(),v=m==="horizontal"?"vertical":"horizontal";return at(()=>{const N=f.current;if(N!==null){const C={element:N,id:o},I=h(C),E=st.addListener("interactionStateChange",O=>{p(O.state!=="inactive"&&O.hitRegions.some(L=>L.separator===C)?O.state:"inactive")}),z=st.addListener("mountedGroupsChange",O=>{O.forEach(({derivedPanelConstraints:L,layout:W,separatorToPanels:K},B)=>{if(B.id===j){const Y=K.get(C);if(Y){const G=Y[0],w=B.panels.indexOf(G);c(Mr({layout:W,panelConstraints:L,panelId:G.id,panelIndex:w}))}}})});return()=>{E(),z(),I()}}},[j,o,h]),s.jsx("div",{...a,"aria-controls":l.valueControls,"aria-orientation":v,"aria-valuemax":l.valueMax,"aria-valuemin":l.valueMin,"aria-valuenow":l.valueNow,children:e,className:t,"data-separator":d,"data-testid":o,id:o,ref:b,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}zs.displayName="Separator";function dn({className:e,...t}){return s.jsx(As,{"data-slot":"resizable-panel-group",className:Re("h-full w-full",e),...t})}function nt({className:e,...t}){return s.jsx(Os,{"data-slot":"resizable-panel",className:Re("min-w-0 min-h-0",e),...t})}function Kt({withHandle:e,className:t,...n}){return s.jsx(zs,{"data-slot":"resizable-handle",className:Re("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(Ys,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Rr={getOptionChain:async(e,t,n,r,i)=>(await Tn.post("/optionchain",{apikey:e,underlying:t,exchange:n,expiry_date:r,strike_count:i??20})).data,getExpiries:async(e,t,n,r="options")=>(await Tn.post("/expiry",{apikey:e,symbol:t,exchange:n,instrumenttype:r})).data},$r={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:10},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}},S=fn()(mn(e=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,setUnderlying:t=>{const n=$r[t];e({underlying:t,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:t=>e(n=>n.expiry===t?n:{expiry:t,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:t=>e(n=>n.expiryWeek===t?n:{expiryWeek:t}),setExpiries:t=>e(n=>n.expiries.length===t.length&&n.expiries.every((r,i)=>r===t[i])?n:{expiries:t}),setChainStrikeCount:t=>e(n=>{const r=Math.max(5,t);return n.chainStrikeCount===r?n:{chainStrikeCount:r}}),setSelectedStrike:t=>e(n=>n.selectedStrike===t?n:{selectedStrike:t}),setActiveSide:t=>e({activeSide:t}),toggleActiveSide:()=>e(t=>({activeSide:t.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(t,n)=>e(r=>r.selectedCESymbol===t&&r.selectedPESymbol===n?r:{selectedCESymbol:t,selectedPESymbol:n}),setOptionChainSnapshot:(t,n,r)=>e(i=>{const a=Number.isFinite(n)?n:Date.now(),o=typeof r=="boolean"?r:i.optionChainIsStreaming;return i.optionChainData===t&&i.optionChainLastUpdate===a&&i.optionChainIsStreaming===o?i:{optionChainData:t,optionChainLastUpdate:a,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>e(t=>t.optionChainData===null&&t.optionChainLastUpdate===0&&!t.optionChainIsStreaming?t:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:t=>e({quantity:Math.max(1,t)}),incrementQuantity:()=>e(t=>({quantity:t.quantity+1})),decrementQuantity:()=>e(t=>({quantity:Math.max(1,t.quantity-1)})),setOrderType:t=>e({orderType:t,...t==="MARKET"?{limitPrice:null,pendingEntryAction:null}:{}}),setProduct:t=>e({product:t}),setTpPoints:t=>e({tpPoints:Math.max(0,t)}),setSlPoints:t=>e({slPoints:Math.max(0,t)}),setLimitPrice:t=>e(n=>n.limitPrice===t?n:{limitPrice:t}),setPendingEntryAction:t=>e(n=>n.pendingEntryAction===t?n:{pendingEntryAction:t}),setPaperMode:t=>e(n=>n.paperMode===t?n:{paperMode:t}),setControlTab:t=>e({controlTab:t}),setHotkeysEnabled:t=>e({hotkeysEnabled:t}),setShowFloatingWidget:t=>e({showFloatingWidget:t}),toggleFloatingWidget:()=>e(t=>({showFloatingWidget:!t.showFloatingWidget})),setFloatingWidgetMinimized:t=>e(n=>n.floatingWidgetMinimized===t?n:{floatingWidgetMinimized:t}),toggleFloatingWidgetMinimized:()=>e(t=>({floatingWidgetMinimized:!t.floatingWidgetMinimized})),setChainCollapsed:t=>e({chainCollapsed:t}),setControlCollapsed:t=>e({controlCollapsed:t}),setCeWidgetPos:t=>e({ceWidgetPos:t}),setPeWidgetPos:t=>e({peWidgetPos:t}),setLotSize:t=>e({lotSize:t}),setChartInterval:t=>e({chartInterval:t}),addSessionPnl:t=>e(n=>({sessionPnl:n.sessionPnl+t})),incrementTradeCount:()=>e(t=>({tradeCount:t.tradeCount+1})),resetSession:()=>e({sessionPnl:0,tradeCount:0})}),{name:"openalgo-scalping",partialize:e=>({underlying:e.underlying,expiryWeek:e.expiryWeek,chainStrikeCount:e.chainStrikeCount,quantity:e.quantity,orderType:e.orderType,product:e.product,tpPoints:e.tpPoints,slPoints:e.slPoints,paperMode:e.paperMode,hotkeysEnabled:e.hotkeysEnabled,showFloatingWidget:e.showFloatingWidget,floatingWidgetMinimized:e.floatingWidgetMinimized,chartInterval:e.chartInterval,ceWidgetPos:e.ceWidgetPos,peWidgetPos:e.peWidgetPos})})),Ir=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],Ar=[10,15,20,25,30],rn="__none__";function Or(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function zr({liveOpenPnl:e,isLivePnl:t=!1}){const n=ve(L=>L.apiKey),r=ve(L=>L.user?.broker),i=S(L=>L.underlying),a=S(L=>L.optionExchange),o=S(L=>L.expiryWeek),l=S(L=>L.expiry),c=S(L=>L.expiries),d=S(L=>L.chainStrikeCount),p=S(L=>L.paperMode),f=S(L=>L.sessionPnl),b=S(L=>L.tradeCount),j=S(L=>L.setUnderlying),m=S(L=>L.setExpiryWeek),h=S(L=>L.setExpiry),v=S(L=>L.setExpiries),N=S(L=>L.setChainStrikeCount),C=S(L=>L.setPaperMode),I=p?f:e??f,E=l&&c.includes(l)?l:rn,{data:z}=xs({queryKey:["scalping-expiries",i,a],queryFn:()=>Rr.getExpiries(n,i,a),enabled:!!n,staleTime:300*1e3});u.useEffect(()=>{if(z?.status!=="success")return;const L=z.data??[];if(Or(c,L)||v(L),L.length===0){l&&h("");return}if(!l||!L.includes(l)){const W=o==="next"?Math.min(1,L.length-1):0,K=L[W],B=W<=0?"current":"next";l!==K&&h(K),o!==B&&m(B)}},[z,o,c,l,v,h,m]);const O=L=>{if(L===rn)return;l!==L&&h(L);const K=c.indexOf(L)<=0?"current":"next";o!==K&&m(K)};return s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(Jt,{value:i,onValueChange:L=>j(L),children:[s.jsx(en,{className:"h-7 w-[128px] text-xs font-semibold",children:s.jsx(tn,{})}),s.jsx(nn,{children:Ir.map(L=>s.jsx(Rt,{value:L,children:L},L))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(Jt,{value:E,onValueChange:O,disabled:c.length===0,children:[s.jsx(en,{className:"h-7 w-[122px] text-xs font-mono",children:s.jsx(tn,{placeholder:"Select expiry"})}),s.jsxs(nn,{children:[s.jsx(Rt,{value:rn,disabled:!0,children:"Select expiry"}),c.map(L=>s.jsx(Rt,{value:L,children:L},L))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(Jt,{value:String(d),onValueChange:L=>N(Number(L)),children:[s.jsx(en,{className:"h-7 w-[94px] text-xs",children:s.jsx(tn,{})}),s.jsx(nn,{children:Ar.map(L=>s.jsx(Rt,{value:String(L),children:L},L))})]})]}),s.jsx("div",{className:"flex-1"}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>C(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>C(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),r&&s.jsx(Ne,{variant:"outline",className:"text-xs h-6",children:r}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${I>0?"text-green-500":I<0?"text-red-500":"text-foreground"}`,children:[I>=0?"+":"",I.toFixed(0)]}),!p&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),b>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",b,")"]})]})]})}function Ot(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function Gn({value:e,prevRef:t,className:n,format:r="price"}){const i=u.useRef(null);u.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const l=e>t.current?"flash-green":"flash-red";o.classList.add(l);const c=setTimeout(()=>o.classList.remove(l),300);return t.current=e,()=>clearTimeout(c)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:Re("tabular-nums transition-colors",n),children:a})}function zt({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:Re("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function Fr(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Dr=u.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:l,onSelectStrike:c,onSelectCE:d,onSelectPE:p}){const f=u.useRef(n?.ltp??0),b=u.useRef(r?.ltp??0),j=Math.min(((n?.oi??0)/o+(n?.volume??0)/l)/2*100,100),m=Math.min(((r?.oi??0)/o+(r?.volume??0)/l)/2*100,100);return s.jsxs("div",{className:Re("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(zt,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Ot(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(zt,{value:n?.volume??0,max:l,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Ot(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${j}%`}}),s.jsx(Gn,{value:n?.ltp,prevRef:f,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:Re("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>c(t,n?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${m}%`}}),s.jsx(Gn,{value:r?.ltp,prevRef:b,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(zt,{value:r?.volume??0,max:l,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Ot(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(zt,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Ot(r?.oi)})]})]})},Fr);function Vr(){const e=ve(g=>g.apiKey),t=S(g=>g.underlying),n=S(g=>g.indexExchange),r=S(g=>g.optionExchange),i=S(g=>g.expiry),a=S(g=>g.selectedStrike),o=S(g=>g.selectedCESymbol),l=S(g=>g.selectedPESymbol),c=S(g=>g.chainStrikeCount),d=S(g=>g.setSelectedStrike),p=S(g=>g.setSelectedSymbols),f=S(g=>g.setActiveSide),b=S(g=>g.setLotSize),j=S(g=>g.setOptionChainSnapshot),m=u.useRef(null),h=u.useRef(null),v=u.useRef(!1),{data:N,isLoading:C,isStreaming:I,error:E,streamingSymbols:z,lastUpdate:O}=Zs(e,t,n,r,i,c,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});u.useEffect(()=>{N&&j(N,O?.getTime()??Date.now(),I)},[N,O,I,j]),u.useEffect(()=>{if(!N?.chain?.length||v.current)return;const g=N.chain[0],R=g.ce?.lotsize??g.pe?.lotsize;R&&R>0&&(b(R),v.current=!0)},[N,b]),u.useEffect(()=>{v.current=!1},[t,i]),u.useEffect(()=>{if(N?.chain&&h.current&&m.current){const g=m.current,R=h.current,x=g.getBoundingClientRect(),k=R.getBoundingClientRect(),y=k.top-x.top-x.height/2+k.height/2;g.scrollTop+=y}},[N?.atm_strike]);const L=u.useCallback((g,R,x)=>{d(g),p(R,x)},[d,p]),W=u.useCallback((g,R)=>{R&&(d(g),p(R,l),f("CE"))},[l,f,d,p]),K=u.useCallback((g,R)=>{R&&(d(g),p(o,R),f("PE"))},[o,f,d,p]),{maxOI:B,maxVol:Y}=u.useMemo(()=>{if(!N?.chain?.length)return{maxOI:1,maxVol:1};let g=0,R=0;for(const x of N.chain)x.ce?.oi&&x.ce.oi>g&&(g=x.ce.oi),x.pe?.oi&&x.pe.oi>g&&(g=x.pe.oi),x.ce?.volume&&x.ce.volume>R&&(R=x.ce.volume),x.pe?.volume&&x.pe.volume>R&&(R=x.pe.volume);return{maxOI:g||1,maxVol:R||1}},[N?.chain]),G=N?.underlying_ltp,w=N?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(Ne,{variant:"outline",className:"text-[10px] h-4 px-1",children:[c," strikes"]}),G!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:G.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[I&&s.jsxs(Ne,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),z]}),C&&s.jsx(Ne,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:m,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[E&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:E}),!E&&!C&&N?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),N?.chain?.map(g=>{const R=g.strike===w;return s.jsx("div",{ref:R?h:void 0,children:s.jsx(Dr,{strike:g.strike,ce:g.ce,pe:g.pe,isATM:R,isSelected:g.strike===a,maxOI:B,maxVol:Y,onSelectStrike:L,onSelectCE:W,onSelectPE:K})},g.strike)})]})]})}function _r({positions:e,totalPnl:t,isLivePnl:n}){const r=S(o=>o.activeSide),i=S(o=>o.hotkeysEnabled),a=S(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const xt=300*60+1800,Kn=1440*60,jt=540*60+900,qn=900*60+1800;function qt(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function Fs(e){const t=qt(e)+xt,n=Math.floor(t/Kn)*Kn,r=t-n,i=(n-xt)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function Br(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),l=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(l))return null;const c=Date.UTC(n,r-1,i,a,o,l)-xt*1e3;return Math.floor(c/1e3)}function Gr(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-xt*1e3;return Math.floor(a/1e3)}function qe(e){if(typeof e=="number")return qt(e);const t=Gr(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return qt(r);const i=Br(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function vn(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=Fs(e);if(r===0||r===6)return!1;const i=n>=jt,a=t.includeClose?n<=qn:n<qn;return i&&a}function Kr(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=Fs(e),a=i<=jt?jt:jt+Math.floor((i-jt)/n)*n;return r+a-xt}function Ds(e){const t=(qt(e)+xt)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function qr(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?Kr(i,n):Math.floor(i/n)*n,l=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:l},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+l},!1]}function Vs({symbol:e,exchange:t,intervalSec:n=1,enabled:r=!0,useIndiaMarketHours:i=!1,maxCandles:a=500,onCandleUpdate:o}){const l=u.useRef([]),c=u.useRef(null),d=u.useRef(null),p=u.useRef(o);p.current=o;const f=r&&e?[{symbol:e,exchange:t}]:[],{data:b,isConnected:j}=vs({symbols:f,mode:"LTP",enabled:r&&!!e});u.useEffect(()=>{if(!r||!e||b.size===0)return;const N=`${t}:${e}`,C=b.get(N);if(!C?.data?.ltp)return;const I=C.lastUpdate;if(!I||!Number.isFinite(I))return;const E=Math.floor(I/1e3);if(i&&!vn(E))return;const z=`${N}:${I}`;if(d.current===z)return;d.current=z;const O={price:C.data.ltp,volume:C.data.volume,timestamp:I},[L,W]=qr(O,c.current,n,{alignToIndiaSession:i});W&&c.current&&(l.current.push(c.current),l.current.length>a&&(l.current=l.current.slice(-a))),c.current=L,p.current?.(L,W)},[b,e,t,n,r,a,i]);const m=u.useCallback(()=>{const N=[...l.current];return c.current&&N.push(c.current),N},[]),h=u.useCallback(()=>{l.current=[],c.current=null,d.current=null},[]),v=u.useCallback(N=>{if(!N?.length){l.current=[],c.current=null;return}const C=N.slice(-a);if(C.length===1){l.current=[],c.current=C[0];return}l.current=C.slice(0,-1),c.current=C[C.length-1]},[a]);return{getCandles:m,reset:h,seed:v,isConnected:j}}function Wt(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function _s(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=Wr(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const l=e.length-r.length;let c=0,d=0,p=1;for(let f=0;f<r.length;f++){const b=e[l+f],j=(b.high+b.low)/2,m=r[f].value;let h=j+n*m,v=j-n*m;f>0&&(v>d||e[l+f-1].close<d||(v=d),h<c||e[l+f-1].close>c||(h=c));let N=p;f>0&&(p===1&&b.close<v?N=-1:p===-1&&b.close>h&&(N=1));const C=b.time;i.push({time:C,value:h}),a.push({time:C,value:v}),o.push({time:C,value:N===1?v:h}),c=h,d=v,p=N}return{upper:i,lower:a,trend:o}}function Wr(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,l=e[a].low,c=e[a-1].close;r.push(Math.max(o-l,Math.abs(o-c),Math.abs(l-c)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function Bs(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}const Ur=120,ht=500,Hr=1;function Ft(e){return e.map(t=>({time:t.time,value:t.value}))}function Yr(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Zr(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Wn(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Ce(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Sn(e){const t=qe(e);return t??null}function Xr(e){if(!e?.length)return[];const t=[];for(const a of e){const o=qe(a.timestamp)??qe(a.time)??qe(a.datetime)??qe(a.date),l=Ce(a.open),c=Ce(a.high),d=Ce(a.low),p=Ce(a.close),f=Ce(a.volume)??0;o==null||l==null||c==null||d==null||p==null||t.push({time:o,open:l,high:c,low:d,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-ht),i=r.filter(a=>vn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-ht)}function ct(e){return e.map(t=>({...t}))}function Qr(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-ht)}function an(e){const t=[];for(const n of e){const r=Sn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Un(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=Sn(n.time),i=Ce(n.open),a=Ce(n.high),o=Ce(n.low),l=Ce(n.close),c=Ce(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-ht)}function Jr({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=u.useRef(null),a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),d=u.useRef(null),p=u.useRef(null),f=u.useRef([]),b=u.useRef(new Map),j=u.useRef(null),m=u.useRef(0),h=u.useRef(null),v=u.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),N=ve(x=>x.apiKey),C=ve(x=>x.setApiKey),I=ms(x=>x.mode==="dark"),E=S(x=>x.underlying),z=S(x=>x.indexExchange),O=S(x=>x.chartInterval),L=u.useCallback(()=>{const x=f.current,k=v.current,y=x.map(M=>({time:M.time,value:M.close}));l.current&&l.current.setData(k.showEma9?Ft(Wt(y,9)):[]),c.current&&c.current.setData(k.showEma21?Ft(Wt(y,21)):[]),d.current&&d.current.setData(k.showSupertrend?Ft(_s(x,10,3).trend):[]),p.current&&p.current.setData(k.showVwap?Ft(Bs(x)):[])},[]),W=u.useCallback(()=>{h.current===null&&(h.current=setTimeout(()=>{h.current=null,L()},Ur))},[L]),K=u.useCallback(()=>{f.current=[],o.current?.setData([]),l.current?.setData([]),c.current?.setData([]),d.current?.setData([]),p.current?.setData([])},[]),B=u.useCallback(x=>{const k=Un(x);f.current=ct(k),o.current?.setData(an(k)),W()},[W]),Y=u.useCallback(async()=>{if(N)return N;try{const k=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(k.status==="success"&&k.api_key)return C(k.api_key),k.api_key}catch{}return null},[N,C]),G=u.useCallback((x,k)=>{if(!o.current)return;const y=Sn(x.time),M=Ce(x.open),P=Ce(x.high),F=Ce(x.low),D=Ce(x.close),Z=Ce(x.volume)??0;if(y==null||M==null||P==null||F==null||D==null)return;const U={time:y,open:M,high:P,low:F,close:D,volume:Z},ee=Number(U.time),ne=f.current.length?Number(f.current[f.current.length-1].time):null;if(ne!=null&&Number.isFinite(ne)&&Number.isFinite(ee)&&ee<ne)return;try{o.current.update({time:U.time,open:U.open,high:U.high,low:U.low,close:U.close})}catch{const Pe=Un([...f.current,U]);f.current=Pe,o.current.setData(an(Pe)),W();return}k?(f.current.push(U),f.current.length>ht&&(f.current=f.current.slice(-ht))):f.current.length>0?f.current[f.current.length-1]=U:f.current.push(U);const le=j.current;le&&b.current.set(le,ct(f.current)),W()},[W]),{isConnected:w,reset:g,seed:R}=Vs({symbol:E,exchange:z,intervalSec:O,enabled:!!E,useIndiaMarketHours:!0,onCandleUpdate:G});return u.useEffect(()=>{const x=j.current;if(x&&f.current.length>0&&b.current.set(x,ct(f.current)),!E){j.current=null,g(),K();return}const k=`${z}:${E}:${O}`;j.current=k;const y=b.current.get(k);if(y&&y.length>0){g(),R(y),B(y);return}g(),K();const M=++m.current,P=Zr(O),F=new Date,D=new Date(F.getTime());D.setDate(D.getDate()-Hr),(async()=>{const U=await Y();if(!U){M===m.current&&K();return}try{const ee=async()=>{try{const J=await ye.getQuotes(U,E,z);if(J.status!=="success"||!J.data)return null;const se=Ce(J.data.ltp);if(se==null||se<=0)return null;const A=Math.floor(Date.now()/1e3);return{time:Math.floor(A/O)*O,open:se,high:se,low:se,close:se,volume:Ce(J.data.volume)??0}}catch{return null}},ne=async J=>{try{const se=await ye.getHistory(U,E,z,P,Wn(D),Wn(F),J);return se.status==="success"?Xr(se.data):[]}catch{return[]}},le=await ne("api"),Pe=le.length>0?le:await ne("db");if(M!==m.current)return;const ce=j.current===k?ct(f.current):[],pe=Qr(Pe,ce);if(pe.length>0){b.current.set(k,ct(pe)),R(pe),B(pe);return}const $=await ee();if($&&M===m.current){const J=[$];b.current.set(k,ct(J)),R(J),B(J);return}}catch{}M===m.current&&K()})()},[E,z,O,Y,g,R,K,B]),u.useEffect(()=>{v.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},l.current?.applyOptions({visible:e}),c.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),W()},[e,t,n,r,W]),u.useEffect(()=>{const x=i.current;if(!x)return;const k=Yr(I),y=hs(x,{width:x.offsetWidth,height:x.offsetHeight,layout:{background:{type:ys.Solid,color:k.bg},textColor:k.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:k.grid},horzLines:{color:k.grid}},rightPriceScale:{borderColor:k.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:k.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:ee=>Ds(ee)},crosshair:{mode:gs.Normal,vertLine:{width:1,color:k.crosshair,style:2},horzLine:{width:1,color:k.crosshair,style:2}}}),M=y.addSeries(bs,{upColor:k.upColor,downColor:k.downColor,borderVisible:!1,wickUpColor:k.upColor,wickDownColor:k.downColor}),P=y.addSeries(Ye,{color:k.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showEma9}),F=y.addSeries(Ye,{color:k.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showEma21}),D=y.addSeries(Ye,{color:k.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showSupertrend}),Z=y.addSeries(Ye,{color:k.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showVwap});a.current=y,o.current=M,l.current=P,c.current=F,d.current=D,p.current=Z,f.current.length>0&&(M.setData(an(f.current)),W());const U=new ResizeObserver(()=>{if(a.current&&x){const ee=x.offsetWidth,ne=x.offsetHeight;ee>0&&ne>0&&a.current.applyOptions({width:ee,height:ne})}});return U.observe(x),()=>{h.current!==null&&(clearTimeout(h.current),h.current=null),U.disconnect(),y.remove(),a.current=null,o.current=null,l.current=null,c.current=null,d.current=null,p.current=null}},[I,W]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:E}),!w&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const X=fn()(mn((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).find(i=>i.symbol===n),addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Hn=.05;function Gt(e){return Math.round(e/Hn)*Hn}function Dt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:Gt(e)}async function He({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=Dt(n);if(a!=null)return a;const o=Pt.getInstance(),l=Dt(o.getCachedData(e,t)?.data?.ltp);if(l!=null)return l;const c=Dt(r);if(c!=null)return c;if(i)try{const d=await ye.getQuotes(i,e,t),p=Dt(d.data?.ltp);if(p!=null)return p}catch{}return 0}function We({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:l,slPoints:c,createdAt:d=Date.now(),managedBy:p="manual",autoEntryScore:f,autoEntryReason:b}){const j=Gt(a),m=Number(Math.max(0,l||0).toFixed(2)),h=Number(Math.max(0,c||0).toFixed(2)),v=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:j,quantity:o,tpPrice:m>0?Gt(j+(v?m:-m)):null,slPrice:h>0?Gt(j+(v?-h:h)):null,tpPoints:m,slPoints:h,createdAt:d,managedBy:p,autoEntryScore:f,autoEntryReason:b}}const Yn=.05;function Ee(e){return Math.round(e/Yn)*Yn}function dt(e){return Number(Math.max(0,e).toFixed(2))}function ei(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?Ee(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?Ee(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function ti({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=ve(T=>T.apiKey),a=ve(T=>T.setApiKey),o=S(T=>T.activeSide),l=S(T=>T.orderType),c=S(T=>T.tpPoints),d=S(T=>T.slPoints),p=S(T=>T.limitPrice),f=S(T=>T.pendingEntryAction),b=S(T=>T.quantity),j=S(T=>T.lotSize),m=S(T=>T.optionExchange),h=S(T=>T.product),v=S(T=>T.paperMode),N=S(T=>T.incrementTradeCount),C=S(T=>T.setLimitPrice),I=S(T=>T.setTpPoints),E=S(T=>T.setSlPoints),z=S(T=>T.setPendingEntryAction),O=S(T=>n==="CE"?T.selectedCESymbol:T.selectedPESymbol),L=X(T=>T.virtualTPSL),W=X(T=>T.triggerOrders),K=X(T=>T.addTriggerOrder),B=X(T=>T.updateTriggerOrder),Y=X(T=>T.removeTriggerOrder),G=X(T=>T.setVirtualTPSL),w=X(T=>T.getTPSLForSymbol),g=X(T=>T.updateVirtualTPSL),R=X(T=>T.removeVirtualTPSL),x=u.useRef(null),k=u.useRef(null),y=u.useRef(null),M=u.useRef(null),P=u.useRef(null),F=u.useRef(null),D=u.useRef(null),Z=u.useRef(null),[U,ee]=u.useState(null),[ne,le]=u.useState(null),[Pe,ce]=u.useState(null),[pe,$]=u.useState(null),[J,se]=u.useState(!1),A=u.useRef(!1),me=u.useRef(null),be=o===n,je=l==="LIMIT"||l==="TRIGGER",V=u.useMemo(()=>O?Object.values(L).find(T=>T.symbol===O):void 0,[O,L]),te=u.useMemo(()=>O?Object.values(W).find(T=>T.symbol===O):void 0,[O,W]),Qe=V?"position":te?"trigger":be&&je&&p!=null?"pending":null,Ie=f??"BUY";u.useEffect(()=>{if(!V){$(null);return}const T=Pt.getInstance(),_=T.getCachedData(V.symbol,V.exchange)?.data?.ltp;_&&_>0&&$(_);const Q=T.subscribe(V.symbol,V.exchange,"LTP",xe=>{const re=xe.data.ltp;re&&re>0&&$(re)});return()=>Q()},[V]);const Ae=u.useMemo(()=>{if(!V||!pe||pe<=0)return null;const T=V.action==="BUY"?pe-V.entryPrice:V.entryPrice-pe,_=T*V.quantity;return{ltp:pe,points:T,pnl:_}},[V,pe]),he=u.useMemo(()=>{if(!V)return"";const T=`${V.action} @ ${V.entryPrice.toFixed(2)}`;if(!Ae)return T;const _=Ae.pnl>=0?"+":"";return`${T} | PnL ${_}${Ae.pnl.toFixed(2)}`},[V,Ae]),H=u.useCallback((T,_)=>{if(T.current){const Q=_.current??t.current;try{Q?.removePriceLine(T.current)}catch{}T.current=null,_.current=null}},[t]),Se=u.useCallback((T,_,Q,xe,re,ie,de)=>{const ue=t.current;if(!ue)return;const De="";if(T.current&&_.current&&_.current!==ue){try{_.current.removePriceLine(T.current)}catch{}T.current=null,_.current=null}T.current?T.current.applyOptions({price:Q,color:xe,lineStyle:re,lineWidth:ie,title:De,axisLabelVisible:!0}):(T.current=ue.createPriceLine({price:Q,color:xe,lineStyle:re,lineWidth:ie,title:De,axisLabelVisible:!0}),_.current=ue)},[t]),Ge=u.useCallback(T=>{if(!t.current)return null;const _=t.current.priceToCoordinate(T);return _??null},[t]),we=u.useCallback(()=>{const T=(_,Q)=>{if(!_.current){Q(null);return}const xe=_.current.options().price,re=Ge(xe);if(re==null){Q(null);return}Q({y:re,price:xe})};T(k,ee),T(y,le),T(M,ce)},[Ge]),ot=u.useCallback(T=>{if(!O)return"above";const Q=Pt.getInstance().getCachedData(O,m)?.data?.ltp;return!Q||Q<=0||T>=Q?"above":"below"},[O,m]),Tt=u.useCallback(async()=>{if(i)return i;try{const _=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(_.status==="success"&&_.api_key)return a(_.api_key),_.api_key}catch(T){console.error("[Scalping] Failed to fetch API key:",T)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[i,a]),Et=u.useCallback(async(T,_)=>{if(!O||A.current)return!1;A.current=!0;try{if(v){const de=await He({symbol:O,exchange:m,preferredPrice:T});if(de<=0)return!1;const ue=w(O);return ue&&R(ue.id),G(We({symbol:O,exchange:m,side:n,action:_,entryPrice:de,quantity:b*j,tpPoints:c,slPoints:d})),N(),z(null),C(null),!0}const Q=await Tt();if(!Q)return!1;const xe={apikey:Q,strategy:"Scalping",exchange:m,symbol:O,action:_,quantity:b*j,pricetype:"LIMIT",product:h,price:T,trigger_price:0,disclosed_quantity:0},re=await ye.placeOrder(xe);if(re.status!=="success")return console.error("[Scalping] LIMIT order rejected:",re),!1;const ie=await He({symbol:O,exchange:m,preferredPrice:T,apiKey:Q});if(ie>0){const de=w(O);de&&R(de.id),G(We({symbol:O,exchange:m,side:n,action:_,entryPrice:ie,quantity:b*j,tpPoints:c,slPoints:d}))}return N(),z(null),C(null),!0}catch(Q){return console.error("[Scalping] LIMIT order failed:",Q),!1}finally{A.current=!1}},[O,v,m,n,b,j,c,d,h,Tt,w,R,G,N,z,C]);u.useEffect(()=>{const T=e.current,_=t.current;if(!T||!_)return;if(!(be&&je&&!V&&!te&&p==null)){H(x,P);return}const xe=re=>{if(!re.point){H(x,P);return}const ie=_.coordinateToPrice(re.point.y);if(ie==null){H(x,P);return}const de=Ee(ie);Se(x,P,de,"#a1a1aa",Ke.Dashed,1,de.toFixed(2))};return T.subscribeCrosshairMove(xe),()=>{T.unsubscribeCrosshairMove(xe),H(x,P)}},[e,t,be,je,V,te,p,H,Se]),u.useEffect(()=>{const T=e.current,_=t.current;if(!T||!_||!O||!be||!je)return;const Q=xe=>{if(!xe.point)return;const re=_.coordinateToPrice(xe.point.y);if(re==null)return;const ie=Ee(re);if(l==="TRIGGER"){const de=f??te?.action;if(!de){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const ue=ot(ie);te?B(te.id,{triggerPrice:ie,action:de,direction:ue,quantity:b*j,tpPoints:c,slPoints:d}):K({id:`trigger-${Date.now()}`,symbol:O,exchange:m,side:n,action:de,triggerPrice:ie,direction:ue,quantity:b*j,tpPoints:c,slPoints:d,createdAt:Date.now()}),C(ie),z(null)}else{if(!f){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(V)return;C(ie),Et(ie,f)}H(x,P),we()};return T.subscribeClick(Q),()=>{T.unsubscribeClick(Q)}},[e,t,O,be,je,l,f,p,V,te,b,j,c,d,m,n,K,B,C,z,ot,Et,H,we]),u.useEffect(()=>{if(!t.current)return;const T=()=>{H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null)};if(V){const _=V.action==="BUY"?"#00ff88":"#ff4560";Se(k,F,Ee(V.entryPrice),_,Ke.Dotted,2,`${V.action} @ ${V.entryPrice.toFixed(2)}`),V.tpPrice!=null?Se(y,D,Ee(V.tpPrice),"#00ff88",Ke.Dashed,1,`TP @ ${V.tpPrice.toFixed(2)}`):H(y,D),V.slPrice!=null?Se(M,Z,Ee(V.slPrice),"#ff4560",Ke.Dashed,1,`SL @ ${V.slPrice.toFixed(2)}`):H(M,Z),we();return}if(te){const{tpPrice:_,slPrice:Q}=ei(te),xe=Ee(te.triggerPrice);Se(k,F,xe,"#ffa500",Ke.Dashed,2,`TRIGGER ${te.action} @ ${xe.toFixed(2)}`),_!=null?Se(y,D,_,"#00ff88",Ke.Dashed,1,`TP @ ${_.toFixed(2)}`):H(y,D),Q!=null?Se(M,Z,Q,"#ff4560",Ke.Dashed,1,`SL @ ${Q.toFixed(2)}`):H(M,Z),we();return}if(be&&je&&p!=null){const _=Ie,Q=Ee(p);if(Se(k,F,Q,l==="LIMIT"?"#06b6d4":"#ffa500",Ke.Dashed,2,`${l} ${_} @ ${Q.toFixed(2)}`),c>0){const re=Ee(Q+(_==="BUY"?c:-c));Se(y,D,re,"#00ff88",Ke.Dashed,1,`TP @ ${re.toFixed(2)}`)}else H(y,D);if(d>0){const re=Ee(Q+(_==="BUY"?-d:d));Se(M,Z,re,"#ff4560",Ke.Dashed,1,`SL @ ${re.toFixed(2)}`)}else H(M,Z);we();return}T()},[t,V,te,be,je,p,Ie,l,c,d,H,Se,we]),u.useEffect(()=>{},[V,he]),u.useEffect(()=>{const T=e.current;if(!T)return;const _=()=>we();T.subscribeCrosshairMove(_);const Q=T.timeScale();return Q.subscribeVisibleLogicalRangeChange(_),()=>{T.unsubscribeCrosshairMove(_),Q.unsubscribeVisibleLogicalRangeChange(_)}},[e,we]),u.useEffect(()=>{const T=r.current;if(!T)return;const _=()=>{!k.current&&!y.current&&!M.current||we()},Q=window.setInterval(_,100);return T.addEventListener("wheel",_,{passive:!0}),T.addEventListener("mousemove",_),window.addEventListener("resize",_),()=>{window.clearInterval(Q),T.removeEventListener("wheel",_),T.removeEventListener("mousemove",_),window.removeEventListener("resize",_)}},[r,we]),u.useEffect(()=>{V||te||f==null&&(p==null&&!k.current&&!y.current&&!M.current||(H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null),C(null)))},[V,te,f,p,H,C]),u.useEffect(()=>()=>{H(x,P),H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null)},[O,H]),u.useEffect(()=>{l==="MARKET"&&(V||te||(H(x,P),H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null),C(null),z(null)))},[l,V,te,H,C,z]);const gt=u.useCallback((T,_)=>{if(_.preventDefault(),_.stopPropagation(),!Qe||!(T==="entry"?k:T==="tp"?y:M).current)return;me.current={type:T,source:Qe};const xe=ie=>{const de=me.current,ue=t.current,De=r.current;if(!de||!ue||!De)return;const Ws=De.getBoundingClientRect(),Us=ie.clientY-Ws.top,Cn=ue.coordinateToPrice(Us);if(Cn==null)return;const Ue=Ee(Cn),Yt=de.type==="entry"?k:de.type==="tp"?y:M;if(Yt.current){if(de.type==="entry"?de.source==="trigger"?`${te?.action??"BUY"}${Ue.toFixed(2)}`:de.source==="pending"?`${l}${Ie}${Ue.toFixed(2)}`:de.source==="position"?`${V?.action??Ie}${Ue.toFixed(2)}`:Yt.current.options().title??Ue.toFixed(2):de.type==="tp"?`${Ue.toFixed(2)}`:`${Ue.toFixed(2)}`,Yt.current.applyOptions({price:Ue,title:""}),de.type==="entry"){const Mt=de.source==="trigger"?te?.action??Ie:de.source==="position"?V?.action??Ie:Ie,Zt=de.source==="trigger"?te?.tpPoints??0:de.source==="position"?V?.tpPoints??0:c,Xt=de.source==="trigger"?te?.slPoints??0:de.source==="position"?V?.slPoints??0:d;if(Zt>0&&y.current){const Qt=Ee(Ue+(Mt==="BUY"?Zt:-Zt));y.current.applyOptions({price:Qt,title:""})}if(Xt>0&&M.current){const Qt=Ee(Ue+(Mt==="BUY"?-Xt:Xt));M.current.applyOptions({price:Qt,title:""})}}we()}},re=()=>{const ie=me.current;if(!ie)return;const ue=(ie.type==="entry"?k:ie.type==="tp"?y:M).current?.options().price;if(ue!=null){if(ie.source==="position"&&V){const De=ie.type==="entry"?{entryPrice:ue,tpPrice:V.tpPrice!=null?Ee(V.tpPrice+(ue-V.entryPrice)):null,slPrice:V.slPrice!=null?Ee(V.slPrice+(ue-V.entryPrice)):null}:ie.type==="tp"?{tpPrice:ue,tpPoints:dt(Math.abs(ue-V.entryPrice))}:ie.type==="sl"?{slPrice:ue,slPoints:dt(Math.abs(V.entryPrice-ue))}:null;De&&g(V.id,De)}if(ie.source==="trigger"&&te&&(ie.type==="entry"&&(B(te.id,{triggerPrice:ue,direction:ot(ue)}),C(ue)),ie.type==="tp"&&B(te.id,{tpPoints:dt(Math.abs(ue-te.triggerPrice))}),ie.type==="sl"&&B(te.id,{slPoints:dt(Math.abs(te.triggerPrice-ue))})),ie.source==="pending"){const De=k.current?.options().price??p??ue;ie.type==="entry"&&C(ue),ie.type==="tp"&&I(dt(Math.abs(ue-De))),ie.type==="sl"&&E(dt(Math.abs(De-ue)))}}we(),me.current=null,document.removeEventListener("mousemove",xe),document.removeEventListener("mouseup",re)};document.addEventListener("mousemove",xe),document.addEventListener("mouseup",re)},[Qe,t,r,V,te,Ie,l,p,c,d,g,B,ot,we,C,I,E]),yt=u.useCallback(()=>{H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null),V&&R(V.id),te&&Y(te.id),C(null),z(null)},[V,te,H,R,Y,C,z]),bt=u.useCallback(T=>{if(H(T==="tp"?y:M,T==="tp"?D:Z),T==="tp"?le(null):ce(null),V){g(V.id,T==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(te){B(te.id,T==="tp"?{tpPoints:0}:{slPoints:0});return}T==="tp"?I(0):E(0)},[V,te,H,I,E,g,B]),kt=u.useCallback(async()=>{if(!(!V||J)){se(!0);try{if(v)console.log(`[Paper] Close ${V.action} ${V.symbol}`);else{const T=await ye.closePosition(V.symbol,V.exchange,h);if(T.status!=="success"){console.error("[Scalping] Close position rejected:",T);return}}R(V.id),H(k,F),H(y,D),H(M,Z),ee(null),le(null),ce(null)}catch(T){console.error("[Scalping] Close position failed:",T)}finally{se(!1)}}},[V,J,v,h,R,H]);if(!r.current)return null;const Je=!!V,et=Je?V.action==="BUY"?"green":"red":l==="LIMIT"?"cyan":"orange",Lt=Je?`${V.action} @ ${U?.price.toFixed(2)??"--"}`:te?`TRIGGER ${te.action} @ ${U?.price.toFixed(2)??"--"}`:`${l} ${Ie} @ ${U?.price.toFixed(2)??"--"}`,Ht={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[et],ae={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[et],vt=Qe!==null;return s.jsxs(s.Fragment,{children:[U&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:U.y},children:[s.jsx("div",{className:Re("absolute left-0 right-0 top-0 h-px -translate-y-1/2",ae)}),s.jsx("div",{className:Re("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",vt?"cursor-ns-resize":"cursor-default"),onMouseDown:vt?T=>gt("entry",T):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:Re("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Ht),children:Lt}),Je&&Ae&&s.jsxs("span",{className:Re("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Ae.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",Ae.ltp.toFixed(2)," | PnL ",Ae.pnl>=0?"+":"",Ae.pnl.toFixed(2)]}),Je&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:T=>{T.stopPropagation(),kt()},disabled:J,title:"Close position at market",children:J?"...":"Close"}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:T=>{T.stopPropagation(),yt()},title:Je?"Remove virtual position tracking":"Cancel pending order",children:""})]})]}),ne&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ne.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:T=>gt("tp",T)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",ne.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:T=>{T.stopPropagation(),bt("tp")},title:"Remove TP line",children:""})]})]}),Pe&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:Pe.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:T=>gt("sl",T)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",Pe.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:T=>{T.stopPropagation(),bt("sl")},title:"Remove SL line",children:""})]})]})]})}const ni=120,si=1;function Vt(e){return e.map(t=>({time:t.time,value:t.value}))}function ri(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function ii(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Zn(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Te(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function jn(e){const t=qe(e);return t??null}function ai(e){if(!e?.length)return[];const t=[];for(const a of e){const o=qe(a.timestamp)??qe(a.time)??qe(a.datetime)??qe(a.date),l=Te(a.open),c=Te(a.high),d=Te(a.low),p=Te(a.close),f=Te(a.volume)??0;o==null||l==null||c==null||d==null||p==null||t.push({time:o,open:l,high:c,low:d,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>vn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function ut(e){return e.map(t=>({...t}))}function oi(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function on(e){const t=[];for(const n of e){const r=jn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Xn(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=jn(n.time),i=Te(n.open),a=Te(n.high),o=Te(n.low),l=Te(n.close),c=Te(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function Qn({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}){const a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),d=u.useRef(null),p=u.useRef(null),f=u.useRef(null),b=u.useRef([]),j=u.useRef(new Map),m=u.useRef(null),h=u.useRef(0),v=u.useRef(null),N=u.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),C=ve(F=>F.apiKey),I=ve(F=>F.setApiKey),E=ms(F=>F.mode==="dark"),z=S(F=>F.activeSide),O=S(F=>F.setActiveSide),L=S(F=>F.optionExchange),W=S(F=>F.chartInterval),K=S(F=>e==="CE"?F.selectedCESymbol:F.selectedPESymbol),B=z===e,Y=u.useCallback(()=>{const F=b.current,D=N.current,Z=F.map(U=>({time:U.time,value:U.close}));c.current&&c.current.setData(D.showEma9?Vt(Wt(Z,9)):[]),d.current&&d.current.setData(D.showEma21?Vt(Wt(Z,21)):[]),p.current&&p.current.setData(D.showSupertrend?Vt(_s(F,10,3).trend):[]),f.current&&f.current.setData(D.showVwap?Vt(Bs(F)):[])},[]),G=u.useCallback(()=>{v.current===null&&(v.current=setTimeout(()=>{v.current=null,Y()},ni))},[Y]),w=u.useCallback(()=>{b.current=[],l.current?.setData([]),c.current?.setData([]),d.current?.setData([]),p.current?.setData([]),f.current?.setData([])},[]),g=u.useCallback(F=>{const D=Xn(F);b.current=ut(D),l.current?.setData(on(D)),G()},[G]),R=u.useCallback(async()=>{if(C)return C;try{const D=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(D.status==="success"&&D.api_key)return I(D.api_key),D.api_key}catch{}return null},[C,I]),x=u.useCallback(()=>{O(e)},[e,O]),k=u.useCallback((F,D)=>{if(!l.current)return;const Z=jn(F.time),U=Te(F.open),ee=Te(F.high),ne=Te(F.low),le=Te(F.close),Pe=Te(F.volume)??0;if(Z==null||U==null||ee==null||ne==null||le==null)return;const ce={time:Z,open:U,high:ee,low:ne,close:le,volume:Pe},pe=Number(ce.time),$=b.current.length?Number(b.current[b.current.length-1].time):null;if($!=null&&Number.isFinite($)&&Number.isFinite(pe)&&pe<$)return;try{l.current.update({time:ce.time,open:ce.open,high:ce.high,low:ce.low,close:ce.close})}catch{const se=Xn([...b.current,ce]);b.current=se,l.current.setData(on(se)),G();return}D?(b.current.push(ce),b.current.length>500&&(b.current=b.current.slice(-500))):b.current.length>0?b.current[b.current.length-1]=ce:b.current.push(ce);const J=m.current;J&&j.current.set(J,ut(b.current)),G()},[G]),{isConnected:y,reset:M,seed:P}=Vs({symbol:K??"",exchange:L,intervalSec:W,enabled:!!K,useIndiaMarketHours:!0,onCandleUpdate:k});return u.useEffect(()=>{const F=m.current;if(F&&b.current.length>0&&j.current.set(F,ut(b.current)),!K){m.current=null,M(),w();return}const D=`${L}:${K}:${W}`;m.current=D;const Z=j.current.get(D);if(Z&&Z.length>0){M(),P(Z),g(Z);return}M(),w();const U=++h.current,ee=ii(W),ne=new Date,le=new Date(ne.getTime());le.setDate(le.getDate()-si),(async()=>{const ce=await R();if(!ce){U===h.current&&w();return}try{const pe=async()=>{try{const je=await ye.getQuotes(ce,K,L);if(je.status!=="success"||!je.data)return null;const V=Te(je.data.ltp);if(V==null||V<=0)return null;const te=Math.floor(Date.now()/1e3);return{time:Math.floor(te/W)*W,open:V,high:V,low:V,close:V,volume:Te(je.data.volume)??0}}catch{return null}},$=async je=>{try{const V=await ye.getHistory(ce,K,L,ee,Zn(le),Zn(ne),je);return V.status==="success"?ai(V.data):[]}catch{return[]}},J=await $("api"),se=J.length>0?J:await $("db");if(U!==h.current)return;const A=m.current===D?ut(b.current):[],me=oi(se,A);if(me.length>0){j.current.set(D,ut(me)),P(me),g(me);return}const be=await pe();if(be&&U===h.current){const je=[be];j.current.set(D,ut(je)),P(je),g(je);return}}catch{}U===h.current&&w()})()},[K,L,W,R,M,P,w,g]),u.useEffect(()=>{N.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},c.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),f.current?.applyOptions({visible:i}),G()},[t,n,r,i,G]),u.useEffect(()=>{const F=a.current;if(!F)return;const D=ri(E),Z=hs(F,{width:F.offsetWidth,height:F.offsetHeight,layout:{background:{type:ys.Solid,color:D.bg},textColor:D.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:D.grid},horzLines:{color:D.grid}},rightPriceScale:{borderColor:D.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:D.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:pe=>Ds(pe)},crosshair:{mode:gs.Normal,vertLine:{width:1,color:D.crosshair,style:2},horzLine:{width:1,color:D.crosshair,style:2}}}),U=Z.addSeries(bs,{upColor:D.upColor,downColor:D.downColor,borderVisible:!1,wickUpColor:D.upColor,wickDownColor:D.downColor}),ee=Z.addSeries(Ye,{color:D.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma9}),ne=Z.addSeries(Ye,{color:D.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showEma21}),le=Z.addSeries(Ye,{color:D.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showSupertrend}),Pe=Z.addSeries(Ye,{color:D.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:N.current.showVwap});o.current=Z,l.current=U,c.current=ee,d.current=ne,p.current=le,f.current=Pe,b.current.length>0&&(U.setData(on(b.current)),G());const ce=new ResizeObserver(()=>{if(o.current&&F){const pe=F.offsetWidth,$=F.offsetHeight;pe>0&&$>0&&o.current.applyOptions({width:pe,height:$})}});return ce.observe(F),()=>{v.current!==null&&(clearTimeout(v.current),v.current=null),ce.disconnect(),Z.remove(),o.current=null,l.current=null,c.current=null,d.current=null,p.current=null,f.current=null}},[E,G]),s.jsxs("div",{className:Re("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",B&&"ring-1 ring-primary/40"),onClick:x,children:[s.jsx("div",{ref:a,className:"h-full w-full"}),s.jsx(ti,{chartRef:o,seriesRef:l,side:e,containerRef:a}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:Re("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),K&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:K}),!K&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),B&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),K&&!y&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!K&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function li(){const e=ve($=>$.apiKey),t=ve($=>$.setApiKey),n=S($=>$.showFloatingWidget),r=S($=>$.floatingWidgetMinimized),i=S($=>$.setFloatingWidgetMinimized),a=S($=>$.activeSide),o=S($=>$.selectedCESymbol),l=S($=>$.selectedPESymbol),c=S($=>$.optionExchange),d=S($=>$.quantity),p=S($=>$.lotSize),f=S($=>$.product),b=S($=>$.tpPoints),j=S($=>$.slPoints),m=S($=>$.orderType),h=S($=>$.limitPrice),v=S($=>$.setLimitPrice),N=S($=>$.setPendingEntryAction),C=S($=>$.paperMode),I=X($=>$.setVirtualTPSL),E=X($=>$.getTPSLForSymbol),z=X($=>$.removeVirtualTPSL),O=X($=>$.clearForSymbol),L=X($=>$.triggerOrders),W=X($=>$.removeTriggerOrder),K=S($=>$.ceWidgetPos),B=S($=>$.setCeWidgetPos),Y=S($=>$.incrementQuantity),G=S($=>$.decrementQuantity),w=S($=>$.setTpPoints),g=S($=>$.setSlPoints),R=S($=>$.incrementTradeCount),x=a==="CE"?o:l,[k,y]=u.useState(!1),[M,P]=u.useState(null),[F,D]=u.useState(null),Z=u.useRef(null),U=u.useRef(null);u.useEffect(()=>{if(!x){P(null),D(null);return}const J=Pt.getInstance().subscribe(x,c,"LTP",se=>{const A=se.data.ltp;A!=null&&A>0&&(D(M),P(A))});return()=>{J()}},[x,c]);const ee=u.useCallback($=>{if($.target.closest("button, input"))return;$.preventDefault(),Z.current={startX:$.clientX,startY:$.clientY,origX:K.x,origY:K.y};const J=A=>{if(!Z.current)return;const me=A.clientX-Z.current.startX,be=A.clientY-Z.current.startY;B({x:Math.max(0,Z.current.origX+me),y:Math.max(0,Z.current.origY+be)})},se=()=>{Z.current=null,document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",se)};document.addEventListener("mousemove",J),document.addEventListener("mouseup",se)},[K,B]),ne=u.useCallback(async()=>{if(e)return e;try{const J=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(J.status==="success"&&J.api_key)return t(J.api_key),J.api_key}catch($){console.error("[Scalping] Failed to fetch API key:",$)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),le=u.useCallback(async $=>{if(!x||k){x||console.warn("[Scalping] No symbol selected  click a strike first");return}if(y(!0),m==="TRIGGER"){const me=Object.values(L).find(be=>be.symbol===x&&be.exchange===c&&be.side===a);me&&W(me.id),v(null),N($),console.log(`[Scalping] TRIGGER armed (${$})  click chart to place trigger line`),y(!1);return}if(m==="LIMIT"&&!h){N($),console.log(`[Scalping] LIMIT armed (${$})  click chart to set limit line`),y(!1);return}if(C){if(console.log(`[Paper] ${$} ${a} ${x} qty=${d*p} @ ${m}`),m==="MARKET"||m==="LIMIT"){const me=await He({symbol:x,exchange:c,preferredPrice:m==="LIMIT"?h??M??void 0:M??void 0});if(me>0){const be=E(x);be&&z(be.id),I(We({symbol:x,exchange:c,side:a,action:$,entryPrice:me,quantity:d*p,tpPoints:b,slPoints:j})),m==="LIMIT"&&v(null)}}R(),y(!1);return}const J=await ne();if(!J){y(!1);return}const se=m==="LIMIT"?"LIMIT":"MARKET",A={apikey:J,strategy:"Scalping",exchange:c,symbol:x,action:$,quantity:d*p,pricetype:se,product:f,price:m==="LIMIT"&&h?h:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${$} ${x} qty=${d*p} ${se}`);const me=await ye.placeOrder(A);if(me.status==="success"){if(console.log(`[Scalping] Order placed: ${$} ${x} id=${me.data?.orderid}`),N(null),R(),se==="MARKET"||se==="LIMIT"){const be=await He({symbol:x,exchange:c,preferredPrice:se==="LIMIT"?h??void 0:M??void 0,apiKey:J});if(be>0){const je=E(x);je&&z(je.id),I(We({symbol:x,exchange:c,side:a,action:$,entryPrice:be,quantity:d*p,tpPoints:b,slPoints:j})),se==="LIMIT"&&v(null)}}}else console.error("[Scalping] Order rejected:",me)}catch(me){console.error("[Scalping] Order failed:",me)}y(!1)},[x,a,d,p,c,f,m,h,b,j,C,E,z,L,k,M,ne,R,I,W,v,N]),Pe=u.useCallback(async()=>{if(!x||k)return;if(y(!0),C){console.log(`[Paper] Reversal ${a} ${x}`),R(),y(!1);return}const $=await ne();if(!$){y(!1);return}try{const J={apikey:$,strategy:"Scalping",exchange:c,symbol:x,action:"SELL",quantity:d*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0};await ye.placeOrder(J);const se={apikey:$,strategy:"Scalping",exchange:c,symbol:x,action:"SELL",quantity:d*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0};await ye.placeOrder(se),console.log(`[Scalping] Reversed ${a} ${x}`),R()}catch(J){console.error("[Scalping] Reversal failed:",J)}y(!1)},[x,a,d,p,c,f,C,k,ne,R]),ce=u.useCallback(async()=>{if(!x)return;if(C){console.log(`[Paper] Close ${a} ${x}`),O(x),v(null),N(null);return}const $=await ne();if($)try{const J={apikey:$,strategy:"Scalping",exchange:c,symbol:x,action:"SELL",quantity:d*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},se=await ye.placeOrder(J);se.status==="success"?(console.log(`[Scalping] Closed ${a} ${x} id=${se.data?.orderid}`),O(x),v(null),N(null)):console.error("[Scalping] Close rejected:",se)}catch(J){console.error("[Scalping] Close failed:",J)}},[x,a,d,p,c,f,C,ne,O,v,N]);if(!n||!x)return null;const pe=M&&F?M>F?"up":M<F?"down":"flat":"flat";return r?s.jsx("div",{ref:U,onMouseDown:ee,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:K.x,top:K.y},children:s.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[s.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:x.slice(-10)}),s.jsx("span",{className:`text-xs font-bold tabular-nums ${pe==="up"?"text-green-500":pe==="down"?"text-red-500":"text-foreground"}`,children:M?.toFixed(2)??"--"}),s.jsx(fe,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):s.jsxs("div",{ref:U,onMouseDown:ee,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:K.x,top:K.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:x.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${pe==="up"?"text-green-500":pe==="down"?"text-red-500":"text-foreground"}`,children:M?.toFixed(2)??"--"}),s.jsx(fe,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(fe,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>le("BUY"),disabled:k,children:"BUY"}),s.jsx(fe,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>le("SELL"),disabled:k,children:"SELL"}),s.jsx(fe,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:Pe,disabled:k,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:G,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:d}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:Y,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:b,onChange:$=>w(Number.parseFloat($.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:j,onChange:$=>g(Number.parseFloat($.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:ce,children:"x Close"})})]})}const ci=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function di({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,onToggleEma9:i,onToggleEma21:a,onToggleSupertrend:o,onToggleVwap:l}){const c=S(p=>p.chartInterval),d=S(p=>p.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[ci.map(p=>s.jsx(fe,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${c===p.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>d(p.sec),children:p.label},p.sec)),s.jsx(ui,{intervalSec:c}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(_t,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),s.jsx(_t,{label:"EMA21",active:t,color:"text-violet-500",onClick:a}),s.jsx(_t,{label:"ST",active:n,color:"text-cyan-500",onClick:o}),s.jsx(_t,{label:"VWAP",active:r,color:"text-pink-500",onClick:l})]})}function ui({intervalSec:e}){const[t,n]=u.useState(()=>ln(e));u.useEffect(()=>{n(ln(e));const i=setInterval(()=>{n(ln(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:pi(t,e)})}function ln(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function pi(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function _t({label:e,active:t,color:n,onClick:r}){return s.jsx(fe,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function fi(){const[e,t]=u.useState(!0),[n,r]=u.useState(!0),[i,a]=u.useState(!0),[o,l]=u.useState(!0),c=u.useCallback(()=>t(b=>!b),[]),d=u.useCallback(()=>r(b=>!b),[]),p=u.useCallback(()=>a(b=>!b),[]),f=u.useCallback(()=>l(b=>!b),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(di,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,onToggleEma9:c,onToggleEma21:d,onToggleSupertrend:p,onToggleVwap:f}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs(dn,{orientation:"vertical",children:[s.jsx(nt,{defaultSize:"40%",minSize:"18%",children:s.jsx(Jr,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(Kt,{withHandle:!0}),s.jsx(nt,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs(dn,{orientation:"horizontal",children:[s.jsx(nt,{defaultSize:"50%",minSize:"20%",children:s.jsx(Qn,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(Kt,{withHandle:!0}),s.jsx(nt,{defaultSize:"50%",minSize:"20%",children:s.jsx(Qn,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})})]}),s.jsx(li,{})]})})]})})]})}function mi(){const e=ve(P=>P.apiKey),t=ve(P=>P.setApiKey),n=S(P=>P.activeSide),r=S(P=>P.selectedCESymbol),i=S(P=>P.selectedPESymbol),a=S(P=>P.optionExchange),o=S(P=>P.quantity),l=S(P=>P.lotSize),c=S(P=>P.product),d=S(P=>P.orderType),p=S(P=>P.tpPoints),f=S(P=>P.slPoints),b=S(P=>P.limitPrice),j=S(P=>P.setLimitPrice),m=S(P=>P.setPendingEntryAction),h=S(P=>P.paperMode),v=X(P=>P.setVirtualTPSL),N=X(P=>P.getTPSLForSymbol),C=X(P=>P.removeVirtualTPSL),I=X(P=>P.clearForSymbol),E=X(P=>P.clearAll),z=X(P=>P.triggerOrders),O=X(P=>P.removeTriggerOrder),L=S(P=>P.setQuantity),W=S(P=>P.incrementQuantity),K=S(P=>P.decrementQuantity),B=S(P=>P.setOrderType),Y=S(P=>P.setProduct),G=S(P=>P.setTpPoints),w=S(P=>P.setSlPoints),g=S(P=>P.incrementTradeCount),R=n==="CE"?r:i,x=u.useCallback(async()=>{if(e)return e;try{const F=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(F.status==="success"&&F.api_key)return t(F.api_key),F.api_key}catch(P){console.error("[Scalping] Failed to fetch API key:",P)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),k=u.useCallback(async P=>{if(!R){console.warn("[Scalping] No symbol selected  click a strike first");return}if(d==="TRIGGER"){const U=Object.values(z).find(ee=>ee.symbol===R&&ee.exchange===a&&ee.side===n);U&&O(U.id),j(null),m(P),console.log(`[Scalping] TRIGGER armed (${P})  click chart to place trigger line`);return}if(d==="LIMIT"&&!b){m(P),console.log(`[Scalping] LIMIT armed (${P})  click chart to set limit line`);return}if(h){if(console.log(`[Paper] ${P} ${n} ${R} qty=${o*l} @ ${d}`),d==="MARKET"||d==="LIMIT"){const U=await He({symbol:R,exchange:a,preferredPrice:d==="LIMIT"?b??void 0:void 0});if(U>0){const ee=N(R);ee&&C(ee.id),v(We({symbol:R,exchange:a,side:n,action:P,entryPrice:U,quantity:o*l,tpPoints:p,slPoints:f})),d==="LIMIT"&&j(null)}}g();return}const F=await x();if(!F)return;const D=d==="LIMIT"?"LIMIT":"MARKET",Z={apikey:F,strategy:"Scalping",exchange:a,symbol:R,action:P,quantity:o*l,pricetype:D,product:c,price:d==="LIMIT"&&b?b:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${P} ${R} qty=${o*l} ${D}`);const U=await ye.placeOrder(Z);if(U.status==="success"){if(console.log(`[Scalping] Order placed: ${P} ${R} id=${U.data?.orderid}`),m(null),g(),D==="MARKET"||D==="LIMIT"){const ee=await He({symbol:R,exchange:a,preferredPrice:D==="LIMIT"?b??void 0:void 0,apiKey:F});if(ee>0){const ne=N(R);ne&&C(ne.id),v(We({symbol:R,exchange:a,side:n,action:P,entryPrice:ee,quantity:o*l,tpPoints:p,slPoints:f})),D==="LIMIT"&&j(null)}}}else console.error("[Scalping] Order rejected:",U)}catch(U){console.error("[Scalping] Order failed:",U)}},[R,n,o,l,a,c,d,b,p,f,h,N,C,z,x,g,v,O,j,m]),y=u.useCallback(async()=>{if(!R)return;if(h){console.log(`[Paper] Close ${n} ${R}`),I(R),j(null),m(null);return}const P=await x();if(P)try{const F={apikey:P,strategy:"Scalping",exchange:a,symbol:R,action:"SELL",quantity:o*l,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0},D=await ye.placeOrder(F);D.status==="success"?(console.log(`[Scalping] Closed ${n} ${R} id=${D.data?.orderid}`),I(R),j(null),m(null)):console.error("[Scalping] Close rejected:",D)}catch(F){console.error("[Scalping] Close failed:",F)}},[R,n,o,l,a,c,h,x,I,j,m]),M=u.useCallback(async()=>{if(h){console.log("[Paper] Close all positions"),E(),j(null),m(null);return}try{await ye.closeAllPositions(),console.log("[Scalping] Closed all positions"),E(),j(null),m(null)}catch(P){console.error("[Scalping] Close all failed:",P)}},[h,E,j,m]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:R||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(fe,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>k("BUY"),disabled:!R,children:"BUY"}),s.jsx(fe,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>k("SELL"),disabled:!R,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(fe,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:K,children:"-"}),s.jsx(Ze,{type:"number",min:1,value:o,onChange:P=>L(Number.parseInt(P.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(fe,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:W,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*l," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(P=>s.jsx(fe,{variant:d===P?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>B(P),children:P},P))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(P=>s.jsx(fe,{variant:c===P?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>Y(P),children:P},P))})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(Ze,{type:"number",min:0,step:5,value:p,onChange:P=>G(Number.parseFloat(P.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(Ze,{type:"number",min:0,step:5,value:f,onChange:P=>w(Number.parseFloat(P.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(fe,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:y,disabled:!R,children:["Close ",n," Position"]}),s.jsx(fe,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:M,children:"Close All Positions"})]})]})}const Jn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},Gs=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],xi=["CE","PE"];function pt(e=0){return xi.reduce((t,n)=>(t[n]=e,t),{})}const q=fn()(mn(e=>({config:{...Jn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:pt(),sideLastExitAt:pt(),sideLossPnl:pt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...t}})),applyPreset:t=>{const n=Gs.find(r=>r.id===t);n&&e({config:{...Jn,...n.config},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.dailyPeakPnl,t),i=Math.max(0,r-t),a=n.lockProfitEnabled&&r>0?n.lockProfitTriggered||i>=r*.4:n.lockProfitTriggered,o=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:r,dailyDrawdown:i,lockProfitTriggered:a,killSwitch:n.killSwitch||o||a}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,l=Math.max(n.dailyPeakPnl,o),c=Math.max(0,l-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:l,dailyDrawdown:c}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),l=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,lockProfitTriggered:l,killSwitch:n.killSwitch||l}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:pt(),sideLastExitAt:pt(),sideLossPnl:pt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId})})),hi=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],gi=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function un(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Nn(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return{hours:n.getUTCHours(),minutes:n.getUTCMinutes()}}function Ks(e){return e?gi:hi}function pn(e=new Date,t=!1){const{hours:n,minutes:r}=Nn(e),i=n*60+r,a=Ks(t);for(const o of a){const l=un(o.start),c=un(o.end);if(i>=l&&i<c)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function es(e=new Date,t=!1){const{hours:n,minutes:r}=Nn(e),i=n*60+r,a=Ks(t);for(const o of a){const l=un(o.start);if(l>i)return{nextZone:o,minutesUntil:l-i}}return{nextZone:null,minutesUntil:0}}function ts(e,t=new Date){if(!e)return!1;try{const n=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return n.getFullYear()===i.getUTCFullYear()&&n.getMonth()===i.getUTCMonth()&&n.getDate()===i.getUTCDate()}catch{return!1}}function ns(e=new Date){const{hours:t,minutes:n}=Nn(e),r=t*60+n;return r>=555&&r<930}function ss(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return`${n.getUTCHours().toString().padStart(2,"0")}:${n.getUTCMinutes().toString().padStart(2,"0")}:${n.getUTCSeconds().toString().padStart(2,"0")}`}function qs(){const e=S(r=>r.expiry),[t,n]=u.useState(()=>{const r=new Date,i=ts(e,r),{zone:a,sensitivity:o}=pn(r,i),{nextZone:l,minutesUntil:c}=es(r,i);return{currentTime:ss(r),currentZone:a,sensitivity:o,nextZone:l,minutesToNext:c,isExpiryDay:i,isOpen:ns(r)}});return u.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=ts(e,a),{zone:l,sensitivity:c}=pn(a,o),{nextZone:d,minutesUntil:p}=es(a,o);n({currentTime:ss(a),currentZone:l,sensitivity:c,nextZone:d,minutesToNext:p,isExpiryDay:o,isOpen:ns(a)})},1e3);return()=>clearInterval(i)},[e]),t}function yi(){const e=q(r=>r.activePresetId),t=q(r=>r.applyPreset),{isExpiryDay:n}=qs();return s.jsx("div",{className:"space-y-1.5",children:Gs.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(Ne,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(Ne,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function oe({label:e,field:t,step:n}){const r=q(a=>a.config[t]),i=q(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Fe,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(Ze,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function _e({label:e,field:t}){const n=q(i=>i.config[t]),r=q(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Fe,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(St,{checked:n,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function Oe({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function bi(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(Oe,{title:"Entry Conditions",children:[s.jsx(oe,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(oe,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(oe,{label:"Min Score",field:"entryMinScore"}),s.jsx(oe,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(Oe,{title:"Trailing SL (5-Stage)",children:[s.jsx(oe,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(oe,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(oe,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(oe,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(oe,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(oe,{label:"Trail Step",field:"trailStepSize"}),s.jsx(oe,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(oe,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(Oe,{title:"Breakeven",children:[s.jsx(oe,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(oe,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(Oe,{title:"Risk",children:[s.jsx(oe,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(oe,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(oe,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(oe,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(oe,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(oe,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(oe,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(oe,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(Oe,{title:"Imbalance Filter",children:[s.jsx(_e,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(oe,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(Oe,{title:"Regime Detection",children:[s.jsx(oe,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(oe,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(Oe,{title:"Index Bias",children:[s.jsx(_e,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(oe,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(Oe,{title:"Options Context",children:[s.jsx(_e,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(oe,{label:"PCR Bullish ",field:"pcrBullishThreshold",step:.1}),s.jsx(oe,{label:"PCR Bearish ",field:"pcrBearishThreshold",step:.1}),s.jsx(oe,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(_e,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(_e,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(oe,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(Oe,{title:"Time-of-Day",children:[s.jsx(_e,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(oe,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(Oe,{title:"No-Trade Zone",children:[s.jsx(_e,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(oe,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(oe,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(Oe,{title:"Re-Entry",children:[s.jsx(_e,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(oe,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(oe,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(Oe,{title:"Telegram Alerts",children:[s.jsx(_e,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(_e,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(_e,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function vi(){const e=q(r=>r.ghostSignals),t=q(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(Si,{signal:r},r.id))]})}function Si({signal:e}){const t=ve(f=>f.apiKey),n=S(f=>f.optionExchange),r=S(f=>f.quantity),i=S(f=>f.lotSize),a=S(f=>f.product),o=S(f=>f.paperMode),l=S(f=>f.incrementTradeCount),c=u.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),l();return}if(!t)return;const f={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const b=await ye.placeOrder(f);b.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${b.data?.orderid}`),l())}catch(b){console.error("[Ghost Take] Failed:",b)}},[e,t,n,r,i,a,o,l]),d=Math.round((Date.now()-e.timestamp)/1e3),p=d<60?`${d}s ago`:`${Math.round(d/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ne,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),s.jsxs(Ne,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(fe,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:c,children:"Take Trade"})]})]})}function ji(){const e=q(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(Ne,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const Pn={getBotStatus:async()=>(await Ve.get("/telegram/bot/status")).data.data,startBot:async()=>(await Ve.post("/telegram/bot/start")).data,stopBot:async()=>(await Ve.post("/telegram/bot/stop")).data,getConfig:async()=>(await Ve.get("/telegram/api/config")).data.data,updateConfig:async e=>(await Ve.post("/telegram/config",e)).data,getUsers:async()=>(await Ve.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await Ve.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await Ve.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await Ve.post("/telegram/test-message")).data,sendBroadcast:async e=>(await Ve.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await Ve.post("/telegram/send-message",{telegram_id:e,message:t})).data};function Ni(){const[e,t]=u.useState(!1),[n,r]=u.useState(null),[i,a]=u.useState(null),[o,l]=u.useState(null),c=q(m=>m.updateConfig),d=q(m=>m.config),p=S(m=>m.underlying),f=u.useCallback(async()=>{try{const m=await Xs();r(m.provider||"none"),m.last_run&&a(m.last_run),l(null)}catch{l("Could not reach advisor")}},[]),b=u.useCallback(async()=>{t(!0),l(null);try{const m=await Qs({underlying:p});if(m.status==="success"&&m.run_id){const h=await Js(1);h.runs?.length>0&&a(h.runs[0])}else l(m.message||"Tuning failed")}catch{l("Advisor request failed")}finally{t(!1)}},[p]),j=u.useCallback(async()=>{if(i?.run_id){t(!0);try{await er(i.run_id);const m=i.recommendations;if(m&&typeof m=="object"){const h={};for(const[v,N]of Object.entries(m)){if(!(v in d))continue;const C=v,I=d[C];if(typeof I=="number"){const E=typeof N=="number"?N:Number(N);Number.isFinite(E)&&(h[C]=E);continue}if(typeof I=="boolean"){let E=null;if(typeof N=="boolean")E=N;else if(typeof N=="number")E=N!==0;else if(typeof N=="string"){const z=N.trim().toLowerCase();["true","1","yes","on","enabled"].includes(z)&&(E=!0),["false","0","no","off","disabled"].includes(z)&&(E=!1)}E!=null&&(h[C]=E)}}if(Object.keys(h).length>0&&(c(h),d.telegramAlertsTune)){const v=Object.keys(h).join(", ");Pn.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${v}`}).catch(()=>{})}}a(h=>h&&{...h,applied:!0}),l(null)}catch{l("Failed to apply recommendation")}finally{t(!1)}}},[i,c,d,p]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(Ne,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(fe,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:f,disabled:e,children:"Check Status"}),s.jsx(fe,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:b,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??""})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([m,h])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:m}),s.jsx("span",{className:"font-mono",children:typeof h=="number"?h:String(h)})]},m))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(fe,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:j,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(Ne,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function Pi(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function wi(){const e=q(y=>y.enabled),t=q(y=>y.mode),n=q(y=>y.replayMode),r=q(y=>y.regime),i=q(y=>y.tradesCount),a=q(y=>y.realizedPnl),o=q(y=>y.consecutiveLosses),l=q(y=>y.killSwitch),c=q(y=>y.lockProfitEnabled),d=q(y=>y.lockProfitTriggered),p=q(y=>y.dailyPeakPnl),f=q(y=>y.dailyDrawdown),b=q(y=>y.sideEntryCount),j=q(y=>y.sideLastExitAt),m=q(y=>y.sideLossPnl),h=q(y=>y.lastDecisionBySide),v=q(y=>y.decisionHistory),N=q(y=>y.executionSamples),C=q(y=>y.config),I=q(y=>y.setEnabled),E=q(y=>y.setMode),z=q(y=>y.setReplayMode),O=q(y=>y.setKillSwitch),L=q(y=>y.setLockProfitEnabled),W=q(y=>y.resetRuntime),K=S(y=>y.activeSide),B=S(y=>y.paperMode),Y=X(y=>y.virtualTPSL),G=u.useMemo(()=>h[K]??v[v.length-1]??null,[K,v,h]),w=u.useMemo(()=>G?Math.max(0,Math.min(99,Math.round(G.score/Math.max(1,G.minScore)*100))):r==="UNKNOWN"?0:55,[G,r]),g=u.useMemo(()=>Object.values(Y).reduce((y,M)=>(y[M.side]+=M.quantity,y),{CE:0,PE:0}),[Y]),R=u.useMemo(()=>{const y=N.slice(-10),M=y.filter(U=>U.status==="filled"),P=y.filter(U=>U.status==="rejected"),F=M.length>0?M.reduce((U,ee)=>U+ee.spread,0)/M.length:0,D=M.length>0?M.reduce((U,ee)=>U+ee.expectedSlippage,0)/M.length:0,Z=y.length>0?P.length/y.length*100:0;return{recent:y.slice().reverse(),avgSpread:F,avgSlippage:D,rejectRate:Z}},[N]),x=G?G.spread<=C.entryMaxSpread*.4?"TIGHT":G.spread<=C.entryMaxSpread?"NORMAL":"WIDE":"NA",k=j[K]>0?Math.max(0,Math.round((Date.now()-j[K])/1e3)):null;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Fe,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(St,{checked:e,onCheckedChange:I,className:"h-5 w-9"})]}),s.jsx(Ne,{variant:e?t==="execute"?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(fe,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>E("ghost"),children:"Ghost (Signals Only)"}),s.jsx(fe,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>E("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(St,{checked:n,onCheckedChange:z,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),t==="execute"&&!B&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(Ne,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:W,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),G?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[G.side," ",G.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${G.enter?"text-green-500":"text-red-500"}`,children:[G.score.toFixed(1)," / ",G.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:G.reason}),s.jsx("div",{className:"space-y-0.5",children:G.checks.slice(0,8).map(y=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:y.label}),s.jsxs("span",{className:`text-[10px] font-medium ${y.pass?"text-green-500":"text-red-500"}`,children:[y.pass?"PASS":"FAIL",y.value?` (${y.value})`:""]})]},y.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:Pi(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[w,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:G&&!G.enter?G.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",K,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:k==null?"":`${k}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${x==="WIDE"?"text-red-500":x==="TIGHT"?"text-green-500":""}`,children:x})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(G?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:G?.depthRatio!=null?G.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:R.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:R.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${R.rejectRate>30?"text-red-500":""}`,children:[R.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[R.recent.slice(0,5).map(y=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[y.side," ",y.symbol.slice(-10)]}),s.jsx("span",{className:y.status==="rejected"?"text-red-500":y.status==="filled"?"text-green-500":"text-muted-foreground",children:y.status})]},`${y.timestamp}-${y.symbol}`)),R.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[l&&s.jsx(Ne,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(St,{checked:l,onCheckedChange:O,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[d&&s.jsx(Ne,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(St,{checked:c,onCheckedChange:L,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L"}),s.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown"}),s.jsx("span",{className:`font-mono ${f>0?"text-red-500":""}`,children:f.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE"}),s.jsx("span",{className:"font-mono",children:g.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE"}),s.jsx("span",{className:"font-mono",children:g.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:b.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:b.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsxs("span",{className:"font-mono text-red-500",children:["-",m.CE.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsxs("span",{className:"font-mono text-red-500",children:["-",m.PE.toFixed(0)]})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(ji,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(vi,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Ni,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(yi,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(bi,{})]})]})}function Ci(){const e=ve(f=>f.apiKey),t=S(f=>f.optionExchange),n=X(f=>f.virtualTPSL),r=X(f=>f.triggerOrders),i=X(f=>f.removeVirtualTPSL),a=X(f=>f.removeTriggerOrder),o=X(f=>f.clearAll),{data:l}=xs({queryKey:["scalping-orders",t],queryFn:()=>ye.getOrders(e),enabled:!!e,refetchInterval:5e3}),c=(l?.data?.orders??[]).filter(f=>f.exchange===t&&(f.order_status==="open"||f.order_status==="pending"||f.order_status==="trigger pending")),d=Object.values(n),p=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(Ne,{variant:"outline",className:"text-[10px] h-4",children:c.length})]}),c.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:c.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",f.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ne,{variant:"outline",className:"text-[10px] h-4",children:f.order_status}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await ye.cancelOrder(f.orderid)}catch(b){console.error("Cancel failed:",b)}},children:"Cancel"})]})]},f.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(Ne,{variant:"outline",className:"text-[10px] h-4",children:d.length})]}),d.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:d.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.side==="CE"?"text-green-500":"text-red-500",children:f.side})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",f.entryPrice.toFixed(1)," |"," ",f.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",f.tpPrice.toFixed(1)]})," ",f.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",f.slPrice.toFixed(1)]})]})]}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(f.id),children:"Remove"})]},f.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(Ne,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:p.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",f.triggerPrice.toFixed(1)," (",f.direction,") | x",f.quantity]})]}),s.jsx(fe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(f.id),children:"Remove"})]},f.id))})]}),(d.length>0||p.length>0)&&s.jsx(fe,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function Ti(e,t){const n=ve(p=>p.apiKey),[r,i]=u.useState(null),[a,o]=u.useState(!1),l=u.useRef(null),c=u.useCallback(async()=>{if(!(!e||!n)){try{const p=await ye.getDepth(n,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}o(!1)}},[e,t,n]);u.useEffect(()=>{if(!e){i(null);return}return o(!0),c(),l.current=setInterval(c,2e3),()=>{l.current&&clearInterval(l.current)}},[e,c]);const d=r?Ei(r):null;return{depth:r,analytics:d,levels:5,isLoading:a}}function Ei(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((j,m)=>j+m.quantity,0),i=n.reduce((j,m)=>j+m.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,l=t.length>0?t.reduce((j,m)=>m.quantity>j.quantity?m:j,t[0]):null,c=l?{price:l.price,qty:l.quantity}:null,d=n.length>0?n.reduce((j,m)=>m.quantity>j.quantity?m:j,n[0]):null,p=d?{price:d.price,qty:d.quantity}:null,f=r+i,b=f>0?(r-i)/f*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:c,largestAskWall:p,imbalanceScore:b}}function ki(){const e=S(l=>l.activeSide),t=S(l=>l.optionExchange),n=S(l=>l.activeSide==="CE"?l.selectedCESymbol:l.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=Ti(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(Ne,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((l,c)=>{const d=r.bids?.[c],p=r.asks?.[c],f=Math.max(...r.bids?.map(b=>b.quantity)??[0],...r.asks?.map(b=>b.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:d&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${f>0?d.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:d.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:d?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${f>0?p.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},c)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const rs=500;function Li(){const e=u.useRef([]),t=u.useCallback(l=>{const c={...l,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(c),e.current.length>rs&&(e.current=e.current.slice(-rs)),c},[]),n=u.useCallback(()=>[...e.current],[]),r=u.useCallback(l=>e.current.slice(-l),[]),i=u.useCallback(()=>{e.current=[]},[]),a=u.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=u.useCallback(()=>{const l=e.current;if(l.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const c=l.filter(b=>b.pnl!==void 0),d=c.filter(b=>(b.pnl??0)>0),p=c.reduce((b,j)=>b+(j.pnl??0),0),f=c.map(b=>b.pnl??0);return{count:l.length,winRate:c.length>0?d.length/c.length*100:0,avgPnl:c.length>0?p/c.length:0,totalPnl:p,bestTrade:f.length>0?Math.max(...f):0,worstTrade:f.length>0?Math.min(...f):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function Mi({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(C=>C.sessionPnl),r=S(C=>C.tradeCount),i=S(C=>C.paperMode),a=i?n:e??n,o=qs(),{getStats:l}=Li(),c=l(),[d,p]=u.useState(5e3),[f,b]=u.useState(500),[j,m]=u.useState(50),[h,v]=u.useState(3),N=a<0&&Math.abs(a)>=d;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(Ne,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(Ne,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),N&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(Ze,{type:"number",value:d,onChange:C=>p(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(Ze,{type:"number",value:f,onChange:C=>b(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(Ze,{type:"number",value:j,onChange:C=>m(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(Ze,{type:"number",value:h,onChange:C=>v(Number(C.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),c.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[c.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${c.avgPnl>0?"text-green-500":c.avgPnl<0?"text-red-500":""}`,children:[c.avgPnl>=0?"+":"",c.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",c.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:c.worstTrade.toFixed(0)})]})]})]})]})]})}const Ri=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function $i({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(i=>i.controlTab),r=S(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:Ri.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx(mi,{}),n==="auto"&&s.jsx(wi,{}),n==="risk"&&s.jsx(Mi,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(ki,{}),n==="orders"&&s.jsx(Ci,{})]})]})}const Ii=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE  PE)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function Ai({open:e,onClose:t}){return u.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:Ii.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function Oi(e={}){const t=S(w=>w.hotkeysEnabled),n=S(w=>w.activeSide),r=S(w=>w.selectedCESymbol),i=S(w=>w.selectedPESymbol),a=S(w=>w.optionExchange),o=S(w=>w.quantity),l=S(w=>w.lotSize),c=S(w=>w.product),d=S(w=>w.orderType),p=S(w=>w.limitPrice),f=S(w=>w.setLimitPrice),b=S(w=>w.tpPoints),j=S(w=>w.slPoints),m=S(w=>w.setPendingEntryAction),h=S(w=>w.paperMode),v=X(w=>w.setVirtualTPSL),N=X(w=>w.getTPSLForSymbol),C=X(w=>w.removeVirtualTPSL),I=X(w=>w.triggerOrders),E=X(w=>w.removeTriggerOrder),z=S(w=>w.toggleActiveSide),O=S(w=>w.toggleFloatingWidget),L=S(w=>w.setQuantity),W=ve(w=>w.apiKey),K=ve(w=>w.setApiKey),B=u.useCallback(()=>n==="CE"?r:i,[n,r,i]),Y=u.useCallback(async()=>{if(W)return W;try{const g=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(g.status==="success"&&g.api_key)return K(g.api_key),g.api_key}catch(w){console.error("[Scalping] Failed to fetch API key:",w)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[W,K]),G=u.useCallback(async w=>{const g=B();if(!g){console.warn("[Scalping] No symbol selected  click a strike first");return}if(d==="TRIGGER"){const y=Object.values(I).find(M=>M.symbol===g&&M.exchange===a&&M.side===n);y&&E(y.id),f(null),m(w),console.log(`[Scalping] TRIGGER armed (${w})  click chart to place trigger line`);return}if(d==="LIMIT"&&!p){m(w),console.log(`[Scalping] LIMIT armed (${w})  click chart to set limit line`);return}if(h){if(console.log(`[Paper] ${w} ${n} ${g} qty=${o*l} @ ${d}`),d==="MARKET"||d==="LIMIT"){const y=await He({symbol:g,exchange:a,preferredPrice:d==="LIMIT"?p??void 0:void 0});if(y>0){const M=N(g);M&&C(M.id),v(We({symbol:g,exchange:a,side:n,action:w,entryPrice:y,quantity:o*l,tpPoints:b,slPoints:j})),d==="LIMIT"&&f(null)}}return}const R=await Y();if(!R)return;const x=d==="LIMIT"?"LIMIT":"MARKET",k={apikey:R,strategy:"Scalping",exchange:a,symbol:g,action:w,quantity:o*l,pricetype:x,product:c,price:d==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${w} ${g} qty=${o*l} ${x}`);const y=await ye.placeOrder(k);if(y.status==="success"){if(console.log(`[Scalping] Order placed: ${w} ${g} id=${y.data?.orderid}`),m(null),x==="MARKET"||x==="LIMIT"){const M=await He({symbol:g,exchange:a,preferredPrice:x==="LIMIT"?p??void 0:void 0,apiKey:R});if(M>0){const P=N(g);P&&C(P.id),v(We({symbol:g,exchange:a,side:n,action:w,entryPrice:M,quantity:o*l,tpPoints:b,slPoints:j})),x==="LIMIT"&&f(null)}}}else console.error("[Scalping] Order rejected:",y)}catch(y){console.error("[Scalping] Order failed:",y)}},[B,n,o,l,a,c,d,p,b,j,h,N,C,I,Y,v,E,f,m]);u.useEffect(()=>{if(!t)return;const w=g=>{const R=g.target?.tagName;if(R==="INPUT"||R==="TEXTAREA"||R==="SELECT")return;const x=B();switch(g.key.toLowerCase()){case"b":{g.preventDefault(),x&&(G("BUY"),e.onBuy?.(n,x));break}case"s":{g.preventDefault(),x&&(G("SELL"),e.onSell?.(n,x));break}case"c":{g.preventDefault(),x&&e.onClose?.(n,x);break}case"x":{g.preventDefault(),e.onCloseAll?.();break}case"r":{g.preventDefault(),x&&e.onReversal?.(n,x);break}case"w":{g.preventDefault(),O();break}case"tab":{g.preventDefault(),z();break}case"1":{g.preventDefault(),L(1);break}case"2":{g.preventDefault(),L(2);break}case"3":{g.preventDefault(),L(3);break}case"?":{g.preventDefault(),e.onToggleHelp?.();break}}};return window.addEventListener("keydown",w),()=>window.removeEventListener("keydown",w)},[t,n,B,G,z,O,L,e])}const zi=300,is=2e3,as=15,os=8e3,ls=15e3;function Le(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function Ut(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=Le(n,Number.NaN);return Number.isFinite(r)?r:null}function Fi(e,t,n){if(!e.length)return null;const r=e.find(l=>l.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let l=1;l<e.length;l++){const c=Math.abs(e[l].strike-i);c<o&&(a=e[l],o=c)}return a}function Di(e){return Le(e.ce?.oi,0)+Le(e.pe?.oi,0)}function Vi(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(Le(Ut(t,"net_gex"),0))||Di(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function _i(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const l of e){const c=l.strike,d=Le(l.ce?.oi,0),p=Le(l.pe?.oi,0);a>c?o+=(a-c)*d:a<c&&(o+=(c-a)*p)}o<r&&(r=o,n=a)}return n}function Bi(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function cs(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!Bi(e.topGammaStrikes,t.topGammaStrikes)}function ds(e,t){const n=Ut(e,"iv");return n!=null&&n>0?n:t}function Gi(e){return e.replace(/-/g,"").toUpperCase()}function us(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=Le(e.underlying_ltp,0),a=Le(e.atm_strike,0),o=Fi(r,a,i),l=r.reduce((O,L)=>(O.ceOi+=Le(L.ce?.oi,0),O.peOi+=Le(L.pe?.oi,0),O.ceVol+=Le(L.ce?.volume,0),O.peVol+=Le(L.pe?.volume,0),O),{ceOi:0,peOi:0,ceVol:0,peVol:0}),c=l.ceOi>0?l.peOi/l.ceOi:1,d=_i(r,o?.strike??a),p=i-d,f=Vi(r),b=Ut(e,"total_net_gex"),j=b??0,m=t?.ceIV??as,h=t?.peIV??as,v=ds(o?.ce,m),N=ds(o?.pe,h),C=(v+N)/2,I=v-N,E=Ut(e,"iv_percentile")??t?.ivPercentile??50,z=Le(o?.ce?.ltp,0)+Le(o?.pe?.ltp,0);return{pcr:c,oiChangeCE:l.ceOi,oiChangePE:l.peOi,maxPainStrike:d,spotVsMaxPain:p,topGammaStrikes:f,gexFlipZones:[],netGEX:j,atmIV:C,ivPercentile:E,ceIV:v,peIV:N,ivSkew:I,straddlePrice:z,lastUpdated:n>0?n:Date.now()}}function Ki(){const e=ve(h=>h.apiKey),t=S(h=>h.underlying),n=S(h=>h.expiry),r=S(h=>h.indexExchange),i=S(h=>h.chainStrikeCount),a=S(h=>h.optionChainData),o=S(h=>h.optionChainLastUpdate),l=S(h=>h.optionChainIsStreaming),c=q(h=>h.optionsContext),d=q(h=>h.setOptionsContext),p=u.useRef(0),f=u.useRef(!1),b=u.useRef(0),j=u.useRef(null);u.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const h=Date.now();if(h-p.current<zi)return;const v=us(a,c,o||h);if(!v)return;const N=cs(c,v),C=!c||h-c.lastUpdated>=is;!N&&!C||(d(v),p.current=h)},[a,o,c,d]);const m=u.useCallback(async()=>{if(f.current||!e||!t||!n||!r)return;const h=Date.now();if(!(h-b.current<ls||a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||h-(o||0)<=os))){f.current=!0,b.current=h;try{const N=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,underlying:t,exchange:r,expiry_date:Gi(n),strike_count:i})});if(!N.ok)return;const C=await N.json();if(C.status!=="success"||!Array.isArray(C.chain)||C.chain.length===0)return;const I=us(C,c,Date.now());if(!I)return;const E=cs(c,I),z=!c||Date.now()-c.lastUpdated>=is;if(!E&&!z)return;d(I),p.current=Date.now()}catch{}finally{f.current=!1}}},[e,t,n,r,i,a,l,o,c,d]);u.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||Date.now()-(o||0)<=os)){j.current&&(clearInterval(j.current),j.current=null);return}return m(),j.current&&clearInterval(j.current),j.current=setInterval(()=>{m()},ls),()=>{j.current&&(clearInterval(j.current),j.current=null)}},[a,l,o,m])}function qi(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let l=1;l<n.length;l++)n[l]>n[l-1]?r++:n[l]<n[l-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function Wi(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(d=>d.high),i=n.map(d=>d.low),a=Math.max(...r)-Math.min(...i),o=n.map(d=>d.close),l=Math.abs(o[o.length-1]-o[0]),c=n.reduce((d,p)=>d+(p.high-p.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":l>a*.6?"TRENDING":c>a*.15?"VOLATILE":"RANGING"}function Ui(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function Hi(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1));const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function Yi(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function Zi(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function Xi(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Qi(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function Ji(e,t,n,r,i,a,o,l,c,d,p,f=[]){let b=0;const j=[],m=Date.now(),h=[],v=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,N=n.respectHotZones?c:1,C=Math.max(.1,N*Math.max(.1,n.sensitivityMultiplier)),I=n.entryMinScore/C,E=(M,P,F,D)=>{h.push({id:M,label:P,pass:F,value:D})},z=(M,P)=>({enter:!1,reason:M,score:b,minScore:Number(I.toFixed(2)),checks:h,blockedBy:P,spread:d,depthRatio:v,expectedSlippage:Math.max(0,d/2)}),O=r.tradesCount<n.maxTradesPerDay;if(E("daily-trades","Daily trade cap",O,`${r.tradesCount}/${n.maxTradesPerDay}`),!O)return z("Max daily trades reached","daily-trades");const L=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(E("daily-loss","Daily loss limit",L,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!L)return z("Daily loss limit reached","daily-loss");const W=r.consecutiveLosses<n.coolingOffAfterLosses;if(E("cooling-off","Consecutive-loss cooling off",W,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!W)return z(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const K=!r.killSwitch;if(E("kill-switch","Kill switch",K),!K)return z("Kill switch active","kill-switch");const B=!r.sideOpen;if(E("side-open","No open position on side",B),!B)return z(`Position already open on ${e}`,"side-open");const Y=r.reEntryCountForSide??0,G=r.lastExitAtForSide??0;if(!n.reEntryEnabled&&Y>0)return E("reentry-enabled","Re-entry enabled",!1,"OFF"),z(`Re-entry disabled for ${e}`,"reentry-enabled");if(E("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||Y<n.reEntryMaxPerSide,`${Y}/${n.reEntryMaxPerSide}`),n.reEntryEnabled&&n.reEntryMaxPerSide>0&&Y>=n.reEntryMaxPerSide)return z(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryEnabled&&n.reEntryDelaySec>0&&G>0){const M=m-G,P=n.reEntryDelaySec*1e3,F=M>=P;if(E("reentry-delay","Re-entry delay",F,F?`${n.reEntryDelaySec}s`:`${Math.ceil((P-M)/1e3)}s left`),!F)return z(`Re-entry delay active: ${Math.ceil((P-M)/1e3)}s`,"reentry-delay")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return E("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),z(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(E("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const M=r.lastTradePnl>-n.perTradeMaxLoss;if(E("per-trade-loss","Per-trade max loss",M,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!M)return z("Last trade breached per-trade max loss","per-trade-loss")}else E("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const M=m-r.lastTradeTime,P=M>=n.minGapMs;if(E("min-gap","Minimum gap between entries",P,P?`${M}ms`:`${n.minGapMs-M}ms left`),M<n.minGapMs)return z(`Min gap: ${Math.ceil((n.minGapMs-M)/1e3)}s remaining`,"min-gap")}else E("min-gap","Minimum gap between entries",!0);if(E("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return z(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const M=m-r.lastLossTime,P=n.cooldownAfterLossSec*1e3,F=M>=P;if(E("loss-cooldown","Cooldown after loss",F,F?`${n.cooldownAfterLossSec}s`:`${Math.ceil((P-M)/1e3)}s left`),M<P)return z(`Cooldown: ${Math.ceil((P-M)/1e3)}s after loss`,"loss-cooldown")}else E("loss-cooldown","Cooldown after loss",!0);if(p){const M=Qi(p.totalBid,p.totalAsk,e,n);if(E("depth-imbalance","Depth imbalance",M.allowed,M.reason),!M.allowed)return z(M.reason,"depth-imbalance")}else E("depth-imbalance","Depth imbalance",!0,"No depth data");if(E("spread","Spread gate",d<=n.entryMaxSpread,`${d.toFixed(2)}/${n.entryMaxSpread}`),d>n.entryMaxSpread)return z(`Spread too wide: ${d.toFixed(1)}`,"spread");const w=n.noTradeZoneEnabled&&Ui(f,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(E("no-trade-zone","No-trade zone filter",!w,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),w)return z(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const g=e==="CE"?"up":"down";E("momentum-direction","Momentum alignment",i.direction===g,`${i.direction} x${i.count}`),i.direction===g&&i.count>=n.entryMomentumCount?(b+=3,j.push(`Momentum ${i.direction} x${i.count}`)):i.direction===g&&(b+=1,j.push(`Weak momentum ${i.direction}`)),E("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(b+=2,j.push(`Velocity ${i.velocity.toFixed(1)}`));let R=!1;a.ema9!==null&&a.ema21!==null&&(R=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,R&&(b+=1,j.push("EMA aligned"))),E("ema","EMA alignment",R,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let x=!1;a.rsi!==null&&(x=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,x&&(b+=1,j.push(`RSI ${a.rsi.toFixed(0)}`))),E("rsi","RSI alignment",x,a.rsi!=null?a.rsi.toFixed(1):"NA");let k=!1;n.indexBiasEnabled&&(k=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",k&&(b+=1,j.push(`Index ${o.direction}`))),E("index-bias","Index bias alignment",n.indexBiasEnabled?k:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const y=Yi(e,l,n);return E("options-context","Options context filter",y.allowed,y.reason),y.allowed?(E("score-gate","Final score gate",b>=I,`${b.toFixed(1)}/${I.toFixed(1)}`),{enter:b>=I,reason:j.join(", ")||"No strong signals",score:b,minScore:Number(I.toFixed(2)),checks:h,spread:d,depthRatio:v,expectedSlippage:Math.max(0,d/2)}):z(y.reason,"options-context")}function ea(e,t,n,r,i,a,o){const l=i?n-t:t-n,c=i?r-t:t-r,d=Zi(a.trailInitialSL,o,a);if(e==="INITIAL"){const f=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return l>=f?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-d:t+d,newStage:"INITIAL"}}return e==="BREAKEVEN"?c>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?c>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?c>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function ta(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}function ps(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function na(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let c=1;c<=t;c++){const d=e[c]-e[c-1];d>0?n+=d:r+=-d}let i=n/t,a=r/t;for(let c=t+1;c<e.length;c++){const d=e[c]-e[c-1],p=d>0?d:0,f=d<0?-d:0;i=(i*(t-1)+p)/t,a=(a*(t-1)+f)/t}if(a===0)return 100;const l=100-100/(1+i/a);return Number.isFinite(l)?l:null}function fs(e){return{ema9:ps(e,9),ema21:ps(e,21),supertrend:null,rsi:na(e,14),vwap:null}}function sa(e){const n=ve(A=>A.apiKey),r=S(A=>A.underlying),i=S(A=>A.indexExchange),a=S(A=>A.selectedCESymbol),o=S(A=>A.selectedPESymbol),l=S(A=>A.optionExchange),c=S(A=>A.quantity),d=S(A=>A.lotSize),p=S(A=>A.product),f=S(A=>A.tpPoints),b=S(A=>A.slPoints),j=S(A=>A.selectedStrike),m=S(A=>A.paperMode),h=q(A=>A.enabled),v=q(A=>A.mode),N=q(A=>A.config),C=q(A=>A.optionsContext),I=q(A=>A.regime),E=q(A=>A.consecutiveLosses),z=q(A=>A.tradesCount),O=q(A=>A.realizedPnl),L=q(A=>A.lastTradePnl),W=q(A=>A.lastTradeTime),K=q(A=>A.tradesThisMinute),B=q(A=>A.lastLossTime),Y=q(A=>A.sideEntryCount),G=q(A=>A.sideLastExitAt),w=q(A=>A.replayMode),g=q(A=>A.killSwitch),R=q(A=>A.lockProfitTriggered),x=q(A=>A.setRegime),k=q(A=>A.addGhostSignal),y=q(A=>A.recordTrade),M=q(A=>A.recordAutoEntry),P=q(A=>A.pushDecision),F=q(A=>A.pushExecutionSample),D=X(A=>A.virtualTPSL),Z=X(A=>A.setVirtualTPSL),U=X(A=>A.getTPSLForSymbol),ee=X(A=>A.removeVirtualTPSL),ne=u.useRef([]),le=u.useRef([]),Pe=u.useRef([]),ce=u.useRef(0),pe=u.useRef(!1),$=u.useRef({CE:"",PE:""}),J=u.useRef({CE:0,PE:0}),se=u.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}});u.useEffect(()=>{if(!h||!e)return;const A=Date.now();if(A-ce.current<100)return;ce.current=A;const me=a,be=o,je=e.get(`${i}:${r}`)?.data?.ltp,V=me?e.get(`${l}:${me}`)?.data?.ltp:void 0,te=be?e.get(`${l}:${be}`)?.data?.ltp:void 0;je&&(ne.current.push(je),ne.current.length>300&&(ne.current=ne.current.slice(-300))),V&&(le.current.push(V),le.current.length>300&&(le.current=le.current.slice(-300))),te&&(Pe.current.push(te),Pe.current.length>300&&(Pe.current=Pe.current.slice(-300)));const{sensitivity:Qe}=pn(new Date,!1),Ie=C&&A-C.lastUpdated<=2e4?C:null;for(const he of["CE","PE"]){const H=he==="CE"?me:be,Se=he==="CE"?V:te,Ge=he==="CE"?le.current:Pe.current,we=Object.values(D).some(_=>_.side===he);if(!H||!Se||Ge.length<5)continue;const ot=qi(Ge,N),Tt=fs(Ge),Et=fs(ne.current),gt=Hi(Et,N),yt=`${l}:${H}`,bt=e.get(yt)?.data?.bid_price,kt=e.get(yt)?.data?.ask_price,Je=bt&&kt?kt-bt:2,et=e.get(yt)?.data?.depth;let Lt;if(et?.buy?.length&&et?.sell?.length){const _=et.buy.reduce((xe,re)=>xe+(re.quantity||0),0),Q=et.sell.reduce((xe,re)=>xe+(re.quantity||0),0);_>0&&Q>0&&(Lt={totalBid:_,totalAsk:Q})}const Ht={consecutiveLosses:E,tradesCount:z,realizedPnl:O,lastTradeTime:W,tradesThisMinute:K,lastLossTime:B,requestedLots:c,sideOpen:we,lastExitAtForSide:G[he],reEntryCountForSide:Y[he],lastTradePnl:L,killSwitch:g||R},ae=Ji(he,Se,N,Ht,ot,Tt,gt,Ie,Qe,Je,Lt,Ge),vt=`${ae.enter}|${ae.blockedBy??""}|${ae.reason}|${ae.score.toFixed(2)}|${ae.minScore.toFixed(2)}`;(vt!==$.current[he]||A-J.current[he]>=1e3)&&(P({timestamp:A,side:he,symbol:H,enter:ae.enter,score:ae.score,minScore:ae.minScore,reason:ae.reason,blockedBy:ae.blockedBy,spread:ae.spread,depthRatio:ae.depthRatio,expectedSlippage:ae.expectedSlippage,checks:ae.checks,regime:I}),$.current[he]=vt,J.current[he]=A);const T=ta(he,H,j??0,Se,ae,I,Ie?.pcr);if(T){const _=`${H}|${ae.reason}|${ae.score.toFixed(1)}`,Q=se.current[he];(_!==Q.sig||A-Q.at>=2500)&&(k(T),se.current[he]={at:A,sig:_},Hs.message(`Signal ${he} ${H.slice(-12)}`,{description:`${ae.score.toFixed(1)} / ${ae.minScore.toFixed(1)} | ${ae.reason}`}))}if(v==="execute"&&!w&&ae.enter&&!pe.current){pe.current=!0;const _="BUY",Q=c*d;(async()=>{try{if(!m&&!n)return;if(!m&&n){const ie={apikey:n,strategy:"Scalping-Auto",exchange:l,symbol:H,action:_,quantity:Q,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},de=await ye.placeOrder(ie);if(de.status!=="success"){F({timestamp:Date.now(),side:he,symbol:H,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Order rejected"});return}console.log(`[AutoTrade] ${_} ${H} id=${de.data?.orderid} score=${ae.score}`)}else console.log(`[AutoTrade Paper] ${_} ${he} ${H} score=${ae.score}`);const re=await He({symbol:H,exchange:l,preferredPrice:Se,apiKey:m?null:n});if(re>0){const ie=U(H);ie&&ee(ie.id),Z(We({symbol:H,exchange:l,side:he,action:_,entryPrice:re,quantity:Q,tpPoints:f,slPoints:b,managedBy:"auto",autoEntryScore:ae.score,autoEntryReason:ae.reason}))}y(0),M(he),F({timestamp:Date.now(),side:he,symbol:H,spread:ae.spread,expectedSlippage:Math.max(0,Math.abs((re>0?re:Se)-Se)),status:"filled",reason:ae.reason}),N.telegramAlertsEntry&&Pn.sendBroadcast({message:`[AUTO ENTRY] ${he} ${H} qty=${Q} score=${ae.score.toFixed(1)} reason=${ae.reason}`}).catch(()=>{})}catch(re){F({timestamp:Date.now(),side:he,symbol:H,spread:ae.spread,expectedSlippage:ae.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",re)}finally{pe.current=!1}})()}}const Ae=ne.current.length>=N.regimeDetectionPeriod?ne.current:le.current;if(Ae.length>=N.regimeDetectionPeriod){const he=Ae.slice(-N.regimeDetectionPeriod).map((Se,Ge,we)=>({high:Math.max(Se,we[Math.max(0,Ge-1)]??Se),low:Math.min(Se,we[Math.max(0,Ge-1)]??Se),close:Se})),H=Wi(he,N);H!==I&&x(H)}},[h,e,v,N,a,o,C,I,E,z,O,W,K,B,L,Y,G,w,g,R,n,l,c,d,p,f,b,m,j,k,y,M,P,F,x,D,Z,U,ee,r,i])}function ra(e){const t=ve(w=>w.apiKey),n=ve(w=>w.setApiKey),r=S(w=>w.paperMode),i=S(w=>w.optionExchange),a=S(w=>w.product),o=S(w=>w.lotSize),l=S(w=>w.addSessionPnl),c=S(w=>w.incrementTradeCount),d=q(w=>w.config),p=q(w=>w.optionsContext),f=q(w=>w.recordAutoExit),b=q(w=>w.recordTradeOutcome),j=q(w=>w.pushExecutionSample),m=X(w=>w.virtualTPSL),h=X(w=>w.triggerOrders),v=X(w=>w.getTPSLForSymbol),N=X(w=>w.removeVirtualTPSL),C=X(w=>w.removeTriggerOrder),I=X(w=>w.setVirtualTPSL),E=u.useRef(t),z=u.useRef(r),O=u.useRef(i),L=u.useRef(a),W=u.useRef(o);u.useEffect(()=>{E.current=t},[t]),u.useEffect(()=>{z.current=r},[r]),u.useEffect(()=>{O.current=i},[i]),u.useEffect(()=>{L.current=a},[a]),u.useEffect(()=>{W.current=o},[o]);const K=u.useRef(new Set),B=u.useCallback(async()=>{if(E.current)return E.current;try{const g=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(g.status==="success"&&g.api_key)return E.current=g.api_key,n(g.api_key),g.api_key}catch(w){console.error("[Scalping] Failed to fetch API key:",w)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[n]),Y=u.useCallback(async(w,g,R,x)=>{const k=R==="BUY"?"SELL":"BUY";if(z.current)return console.log(`[Paper TP/SL] ${x}: ${k} ${w} qty=${g}`),!0;const y=await B();if(!y)return!1;const M={apikey:y,strategy:"Scalping",exchange:O.current,symbol:w,action:k,quantity:g,pricetype:"MARKET",product:L.current,price:0,trigger_price:0,disclosed_quantity:0};try{const P=await ye.placeOrder(M);if(P.status==="success")return console.log(`[Scalping TP/SL] ${x}: ${k} ${w} id=${P.data?.orderid}`),!0}catch(P){console.error(`[Scalping TP/SL] ${x} order failed:`,P)}return!1},[B]),G=u.useCallback(async(w,g,R)=>{if(z.current)return console.log(`[Paper Trigger] Entry: ${R} ${w} qty=${g}`),!0;const x=await B();if(!x)return!1;const k={apikey:x,strategy:"Scalping",exchange:O.current,symbol:w,action:R,quantity:g,pricetype:"MARKET",product:L.current,price:0,trigger_price:0,disclosed_quantity:0};try{const y=await ye.placeOrder(k);if(y.status==="success")return console.log(`[Scalping Trigger] Entry: ${R} ${w} id=${y.data?.orderid}`),!0}catch(y){console.error("[Scalping Trigger] Entry failed:",y)}return!1},[B]);u.useEffect(()=>{if(!e)return;const w=(g,R,x)=>{K.current.add(g.id);const y=g.action==="BUY"?(R-g.entryPrice)*g.quantity:(g.entryPrice-R)*g.quantity;Y(g.symbol,g.quantity,g.action,`${x} at ${R}`).then(M=>{M&&(N(g.id),l(y),c(),g.managedBy==="auto"&&(f(g.side,y),b(y),j({timestamp:Date.now(),side:g.side,symbol:g.symbol,spread:0,expectedSlippage:0,status:"exited",reason:x}),d.telegramAlertsExit&&Pn.sendBroadcast({message:`[AUTO EXIT] ${g.side} ${g.symbol} pnl=${y.toFixed(0)} reason=${x}`}).catch(()=>{}))),K.current.delete(g.id)})};for(const g of Object.values(m)){const R=`${g.exchange}:${g.symbol}`,k=(e.get(R)??e.get(g.symbol))?.data?.ltp;if(!k||K.current.has(g.id))continue;const y=g.action==="BUY",M=y?(k-g.entryPrice)*g.quantity:(g.entryPrice-k)*g.quantity;if(g.managedBy==="auto"){if(d.perTradeMaxLoss>0&&M<=-d.perTradeMaxLoss){w(g,k,`Per-trade max loss ${d.perTradeMaxLoss}`);continue}const P=Xi(g.side,p,d);if(P.exit){w(g,k,`Options early-exit: ${P.reason}`);continue}}if(g.tpPrice!==null&&(y?k>=g.tpPrice:k<=g.tpPrice)){w(g,k,"TP hit");continue}g.slPrice!==null&&(y?k<=g.slPrice:k>=g.slPrice)&&w(g,k,"SL hit")}for(const g of Object.values(h)){const R=`${g.exchange}:${g.symbol}`,k=(e.get(R)??e.get(g.symbol))?.data?.ltp;if(!k||K.current.has(g.id))continue;(g.direction==="above"?k>=g.triggerPrice:k<=g.triggerPrice)&&(K.current.add(g.id),G(g.symbol,g.quantity,g.action).then(M=>{if(M&&(C(g.id),c(),k>0)){const P=v(g.symbol);P&&N(P.id),I(We({symbol:g.symbol,exchange:g.exchange,side:g.side,action:g.action,entryPrice:k,quantity:g.quantity,tpPoints:g.tpPoints,slPoints:g.slPoints,managedBy:"trigger"}))}K.current.delete(g.id)}))}},[e,m,h,Y,G,v,N,C,I,l,c,d,p,f,b,j])}function ia(){const e=q(j=>j.config),t=q(j=>j.optionsContext),n=q(j=>j.setTrailStage),r=q(j=>j.setHighSinceEntry),i=X(j=>j.virtualTPSL),a=X(j=>j.updateVirtualTPSL),o=u.useRef(e),l=u.useRef(t),c=u.useRef({}),d=u.useRef({}),p=u.useRef({}),f=u.useRef({});u.useEffect(()=>{o.current=e},[e]),u.useEffect(()=>{l.current=t},[t]);const b=u.useMemo(()=>Object.values(i).filter(j=>j.slPrice!=null),[i]);u.useEffect(()=>{const j=Pt.getInstance(),m=new Set(b.map(h=>h.id));for(const[h,v]of Object.entries(f.current))m.has(h)||(v(),delete f.current[h],delete c.current[h],delete d.current[h],delete p.current[h]);for(const h of b)f.current[h.id]||(c.current[h.id]="INITIAL",d.current[h.id]=h.entryPrice,p.current[h.id]=h.slPrice??h.entryPrice,f.current[h.id]=j.subscribe(h.symbol,h.exchange,"LTP",v=>{const N=v.data.ltp;if(!N||N<=0)return;const C=X.getState().virtualTPSL[h.id];if(!C||C.slPrice==null)return;const I=C.action==="BUY",E=d.current[h.id]??C.entryPrice,z=I?Math.max(E,N):Math.min(E,N);z!==E&&(d.current[h.id]=z,r(z));const O=c.current[h.id]??"INITIAL",L=ea(O,C.entryPrice,N,z,I,o.current,l.current);L.newStage!==O&&(c.current[h.id]=L.newStage,n(L.newStage));const W=Math.round(L.newSL/.05)*.05,K=C.slPrice,B=p.current[h.id],Y=K==null||Math.abs(W-K)>=.05,G=B==null||Math.abs(W-B)>=.05;Y&&G&&(p.current[h.id]=W,a(h.id,{slPrice:W}))}));return()=>{}},[b,r,n,a]),u.useEffect(()=>()=>{for(const j of Object.values(f.current))j();f.current={},c.current={},d.current={},p.current={}},[])}function wn(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Xe(e){return wn(e)??0}function aa(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function oa(e){const t=wn(e.pnl);if(t!==null)return t;const n=Xe(e.ltp),r=Xe(e.average_price),i=Math.abs(Xe(e.quantity));return(Xe(e.quantity)>0?n-r:r-n)*i}function la(){const e=ve(v=>v.apiKey),t=ve(v=>v.setApiKey),[n,r]=u.useState([]),[i,a]=u.useState(!1),o=u.useCallback(async()=>{if(e)return e;try{const N=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(N.status==="success"&&N.api_key)return t(N.api_key),N.api_key}catch{}return null},[e,t]),l=u.useCallback(async()=>{const v=await o();if(!v){a(!1);return}a(!0);try{const N=await ye.getPositions(v);N.status==="success"&&N.data&&r(Array.isArray(N.data)?N.data:[])}catch{}finally{a(!1)}},[o]);u.useEffect(()=>{l();const v=setInterval(l,1e4);return()=>clearInterval(v)},[l]);const{data:c,isLive:d,isPaused:p}=tr(n,{enabled:n.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),f=u.useMemo(()=>c.flatMap(v=>{const N=aa(v.symbol);if(!N)return[];const C=Xe(v.quantity),I=Math.abs(C);if(I===0)return[];const E=Xe(v.ltp),z=Xe(v.average_price),O=C>0,L=O?E-z:z-E,K=wn(v.pnl)??L*I;return[{symbol:v.symbol,exchange:v.exchange,side:N,action:O?"BUY":"SELL",quantity:I,avgPrice:z,ltp:E,pnl:K,pnlPoints:L,product:v.product}]}),[c]),b=u.useMemo(()=>n.some(v=>Xe(v.quantity)!==0),[n]),j=u.useMemo(()=>c.reduce((v,N)=>v+oa(N),0),[c]),m=u.useCallback(v=>f.find(N=>N.side===v),[f]),h=u.useMemo(()=>n.map(v=>({symbol:v.symbol,exchange:v.exchange})),[n]);return{positions:f,totalPnl:j,isLive:d&&b,isPaused:p,isLoading:i,refetch:l,getPositionForSide:m,positionSymbols:h}}function Ca(){const[e,t]=u.useState(!1),n=u.useCallback(()=>t(x=>!x),[]),r=u.useCallback(()=>t(!1),[]),i=S(x=>x.paperMode),a=S(x=>x.underlying),o=S(x=>x.indexExchange),l=S(x=>x.optionExchange),c=S(x=>x.product),d=S(x=>x.quantity),p=S(x=>x.lotSize),f=S(x=>x.setLimitPrice),b=S(x=>x.setPendingEntryAction),j=S(x=>x.selectedCESymbol),m=S(x=>x.selectedPESymbol),h=X(x=>x.virtualTPSL),v=X(x=>x.triggerOrders),N=X(x=>x.clearAll),C=X(x=>x.clearForSymbol),I=X(x=>x.clearTriggerOrders),E=q(x=>x.config.imbalanceFilterEnabled),z=q(x=>x.updateRiskState),O=ve(x=>x.apiKey),L=ve(x=>x.setApiKey);u.useEffect(()=>{O||fetch("/api/websocket/apikey",{credentials:"include"}).then(x=>x.json()).then(x=>{x.status==="success"&&x.api_key&&L(x.api_key)}).catch(()=>{})},[O,L]),u.useEffect(()=>{I()},[I]);const W=u.useCallback(async(x,k)=>{if(i){console.log(`[Paper] Close ${x} ${k}`),C(k),f(null),b(null);return}try{await ye.closePosition(k,l,c),console.log(`[Scalping] Closed ${x} ${k}`),C(k),f(null),b(null)}catch(y){console.error("[Scalping] Close failed:",y)}},[i,l,c,C,f,b]),K=u.useCallback(async()=>{if(i){console.log("[Paper] Close all positions"),N(),f(null),b(null);return}try{await ye.closeAllPositions(),console.log("[Scalping] Closed all positions"),N(),f(null),b(null)}catch(x){console.error("[Scalping] Close all failed:",x)}},[i,N,f,b]),B=u.useCallback(async(x,k)=>{if(i){console.log(`[Paper] Reverse ${x} ${k}`);return}if(O)try{await ye.closePosition(k,l,c),await ye.placeOrder({apikey:O,strategy:"Scalping",exchange:l,symbol:k,action:"SELL",quantity:d*p,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${x} ${k}`)}catch(y){console.error("[Scalping] Reversal failed:",y)}},[i,O,l,c,d,p]);Oi({onToggleHelp:n,onClose:W,onCloseAll:K,onReversal:B}),Ki();const Y=u.useMemo(()=>{const x=[];a&&o&&x.push({symbol:a,exchange:o}),j&&x.push({symbol:j,exchange:l}),m&&x.push({symbol:m,exchange:l});for(const y of Object.values(h))x.push({symbol:y.symbol,exchange:y.exchange});for(const y of Object.values(v))x.push({symbol:y.symbol,exchange:y.exchange});const k=new Map;for(const y of x)k.set(`${y.exchange}:${y.symbol}`,y);return Array.from(k.values())},[a,o,j,m,l,h,v]),{data:G}=vs({symbols:Y,mode:E?"Quote":"LTP",enabled:Y.length>0}),{positions:w,totalPnl:g,isLive:R}=la();return u.useEffect(()=>{z(g)},[g,z]),sa(G),ia(),ra(G),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(zr,{liveOpenPnl:g,isLivePnl:R}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:s.jsxs(dn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(nt,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(Vr,{})}),s.jsx(Kt,{withHandle:!0,className:"bg-border/70"}),s.jsx(nt,{defaultSize:"50%",minSize:"30%",children:s.jsx(fi,{})}),s.jsx(Kt,{withHandle:!0,className:"bg-border/70"}),s.jsx(nt,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx($i,{liveOpenPnl:g,isLivePnl:R})})]})}),s.jsx(_r,{positions:w,totalPnl:g,isLivePnl:R}),s.jsx(Ai,{open:e,onClose:r})]})}export{Ca as default};
