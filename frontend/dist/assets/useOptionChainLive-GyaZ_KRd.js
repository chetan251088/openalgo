import{r as s}from"./vendor-react-BsSNOS8Q.js";import{G as q,H as J,E as Q,g as ce}from"./index-CqJWD5ZF.js";import{a as de}from"./useMarketStatus-ySaLBNq7.js";const fe={getOptionChain:async(n,t,u,o,m)=>q()?J("feed","optionchain",{apikey:n,underlying:t,exchange:u,expiry_date:o,strike_count:m??20}):(await Q.post("/optionchain",{apikey:n,underlying:t,exchange:u,expiry_date:o,strike_count:m??20})).data,getExpiries:async(n,t,u,o="options")=>q()?J("feed","expiry",{apikey:n,symbol:t,exchange:u,instrumenttype:o}):(await Q.post("/expiry",{apikey:n,symbol:t,exchange:u,instrumenttype:o})).data};function pe(n,t,u,o,m,R={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:N,refreshInterval:h=3e4,pauseWhenHidden:w=!0}=R,{isVisible:T}=ce(),_=h>0,[F,d]=s.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),f=s.useRef(null),a=s.useRef(null),p=N&&(!w||T),y=s.useCallback(async()=>{if(!(!n||!t||!u||!o)&&!a.current){d(l=>({...l,isLoading:!0}));try{const l=new AbortController;a.current=l;const v=o.replace(/-/g,"").toUpperCase(),P=await fe.getOptionChain(n,t,u,v,m);P.status==="success"?d(L=>({...L,data:P,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):d(L=>({...L,isLoading:!1,error:P.message||"Failed to fetch option chain"}))}catch(l){l instanceof Error&&(l.name==="AbortError"?a.current===null&&d(v=>({...v,isLoading:!1})):d(v=>({...v,isLoading:!1,error:l.message||"Connection error",isConnected:!1})))}finally{a.current=null}}},[n,t,u,o,m]);s.useEffect(()=>{if(!p){f.current&&(clearInterval(f.current),f.current=null),d(l=>({...l,isPaused:!!N}));return}return d(l=>({...l,isConnected:!0,isPaused:!1})),y(),_&&(f.current=setInterval(y,h)),()=>{f.current&&(clearInterval(f.current),f.current=null),a.current&&(a.current.abort(),a.current=null)}},[p,y,h,N,_]);const i=s.useCallback(()=>{y()},[y]);return{...F,refetch:i}}const me=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),he=new Set(["SENSEX","BANKEX","SENSEX50"]);function Z(n,t){return me.has(n)?"NSE_INDEX":he.has(n)?"BSE_INDEX":t==="BFO"?"BSE":"NSE"}function k(n,t){if(n!=null)return!t||t<=0?n:Number((Math.round(n/t)*t).toFixed(2))}const ye=100;function Ee(n,t,u,o,m,R,N={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const h=o.toUpperCase(),w=t.toUpperCase(),{enabled:T,oiRefreshInterval:_=3e4,wsMode:F="LTP",pauseWhenHidden:d=!0}=N,[f,a]=s.useState(null),[p,y]=s.useState(null),{data:i,isLoading:l,isConnected:v,isPaused:P,error:L,lastUpdate:S,refetch:ee}=pe(n,t,u,m,R,{enabled:T,refreshInterval:_,pauseWhenHidden:d}),M=s.useMemo(()=>{const c=[],g=Z(t,o);if(c.push({symbol:t,exchange:g}),i?.chain)for(const I of i.chain)I.ce?.symbol&&c.push({symbol:I.ce.symbol,exchange:o}),I.pe?.symbol&&c.push({symbol:I.pe.symbol,exchange:o});return c},[i?.chain,o,t]),{data:A,isConnected:te,isAuthenticated:ne,isPaused:se}=de({symbols:M,mode:F,enabled:T&&M.length>0}),$=s.useRef(0),E=s.useRef(null),K=s.useRef(A),z=s.useRef(i);K.current=A,z.current=i;const G=s.useMemo(()=>()=>{E.current=null;const c=z.current,g=K.current;if(!c){a(null);return}if(g.size===0){a(c);return}const I=c.chain.map(e=>{let U=!1,D=!1,B=e.ce?.ltp,O=e.pe?.ltp,W=e.ce?.volume,Y=e.pe?.volume,X=e.ce?.oi,x=e.pe?.oi;if(e.ce?.symbol){const V=`${h}:${e.ce.symbol.toUpperCase()}`,r=g.get(V)?.data;if(r?.ltp!==void 0){const C=k(r.ltp,e.ce.tick_size);C!==void 0&&C!==e.ce.ltp&&(B=C,U=!0)}r?.volume!==void 0&&r.volume!==e.ce.volume&&(W=r.volume,U=!0);const b=r?.oi??r?.open_interest;b!==void 0&&b!==e.ce.oi&&(X=b,U=!0)}if(e.pe?.symbol){const V=`${h}:${e.pe.symbol.toUpperCase()}`,r=g.get(V)?.data;if(r?.ltp!==void 0){const C=k(r.ltp,e.pe.tick_size);C!==void 0&&C!==e.pe.ltp&&(O=C,D=!0)}r?.volume!==void 0&&r.volume!==e.pe.volume&&(Y=r.volume,D=!0);const b=r?.oi??r?.open_interest;b!==void 0&&b!==e.pe.oi&&(x=b,D=!0)}if(!U&&!D)return e;const H={...e};return U&&e.ce&&(H.ce={...e.ce,...B!==void 0?{ltp:B}:{},...W!==void 0?{volume:W}:{},...X!==void 0?{oi:X}:{}}),D&&e.pe&&(H.pe={...e.pe,...O!==void 0?{ltp:O}:{},...Y!==void 0?{volume:Y}:{},...x!==void 0?{oi:x}:{}}),H});let j=!1;for(const[,e]of g)if(e.lastUpdate&&e.lastUpdate>$.current){j=!0,$.current=e.lastUpdate;break}j&&y(new Date);const le=`${Z(w,h).toUpperCase()}:${w}`,ue=g.get(le)?.data?.ltp??c.underlying_ltp;a({...c,underlying_ltp:ue,chain:I})},[h,w]);s.useEffect(()=>{if(!i){a(null);return}if(A.size===0){a(i);return}return E.current===null&&(E.current=setTimeout(G,ye)),()=>{E.current!==null&&(clearTimeout(E.current),E.current=null)}},[i,A,G]);const oe=te&&ne&&M.length>0,re=P||se,ae=s.useMemo(()=>!S&&!p?null:S?p&&p>S?p:S:p,[S,p]);return{data:f,isLoading:l,isConnected:v,isStreaming:oe,isPaused:re,error:L,lastUpdate:ae,streamingSymbols:M.length,refetch:ee}}export{fe as o,Ee as u};
