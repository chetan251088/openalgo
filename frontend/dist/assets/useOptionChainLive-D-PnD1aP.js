import{r as n}from"./vendor-react-CCyQGCED.js";import{g as oe}from"./index-D1Y9pl7A.js";import{a as le}from"./useMarketStatus-DwZVpzMD.js";function ae(l,t,N,u,T,R={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:P,refreshInterval:g=3e4,pauseWhenHidden:_=!0}=R,{isVisible:U}=oe(),D=g>0,[F,a]=n.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),r=n.useRef(null),f=n.useRef(null),c=P&&(!_||U),m=n.useCallback(async()=>{if(!(!l||!t||!N||!u)&&!f.current){a(o=>({...o,isLoading:!0}));try{const o=new AbortController;f.current=o;const h=u.replace(/-/g,"").toUpperCase(),i=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:l,underlying:t,exchange:N,expiry_date:h,strike_count:T}),signal:o.signal});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const w=await i.json();w.status==="success"?a(p=>({...p,data:w,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):a(p=>({...p,isLoading:!1,error:w.message||"Failed to fetch option chain"}))}catch(o){o instanceof Error&&(o.name==="AbortError"?f.current===null&&a(h=>({...h,isLoading:!1})):a(h=>({...h,isLoading:!1,error:o.message||"Connection error",isConnected:!1})))}finally{f.current=null}}},[l,t,N,u,T]);n.useEffect(()=>{if(!c){r.current&&(clearInterval(r.current),r.current=null),a(o=>({...o,isPaused:!!P}));return}return a(o=>({...o,isConnected:!0,isPaused:!1})),m(),D&&(r.current=setInterval(m,g)),()=>{r.current&&(clearInterval(r.current),r.current=null),f.current&&(f.current.abort(),f.current=null)}},[c,m,g,P,D]);const M=n.useCallback(()=>{m()},[m]);return{...F,refetch:M}}const ue=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),ce=new Set(["SENSEX","BANKEX","SENSEX50"]);function G(l,t){return ue.has(l)?"NSE_INDEX":ce.has(l)?"BSE_INDEX":t==="BFO"?"BSE":"NSE"}function J(l,t){if(l!=null)return!t||t<=0?l:Number((Math.round(l/t)*t).toFixed(2))}const ie=100;function ve(l,t,N,u,T,R,P={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:g,oiRefreshInterval:_=3e4,wsMode:U="LTP",pauseWhenHidden:D=!0}=P,[F,a]=n.useState(null),[r,f]=n.useState(null),{data:c,isLoading:m,isConnected:M,isPaused:o,error:h,lastUpdate:i,refetch:w}=ae(l,t,N,T,R,{enabled:g,refreshInterval:_,pauseWhenHidden:D}),p=n.useMemo(()=>{const d=[],v=G(t,u);if(d.push({symbol:t,exchange:v}),c?.chain)for(const I of c.chain)I.ce?.symbol&&d.push({symbol:I.ce.symbol,exchange:u}),I.pe?.symbol&&d.push({symbol:I.pe.symbol,exchange:u});return d},[c?.chain,u,t]),{data:L,isConnected:q,isAuthenticated:Q,isPaused:Z}=le({symbols:p,mode:U,enabled:g&&p.length>0}),V=n.useRef(0),S=n.useRef(null),K=n.useRef(L),j=n.useRef(c);K.current=L,j.current=c;const z=n.useMemo(()=>()=>{S.current=null;const d=j.current,v=K.current;if(!d){a(null);return}if(v.size===0){a(d);return}const I=d.chain.map(e=>{let C=!1,E=!1,A=e.ce?.ltp,O=e.pe?.ltp,W=e.ce?.volume,Y=e.pe?.volume,B=e.ce?.oi,X=e.pe?.oi;if(e.ce?.symbol){const H=`${u}:${e.ce.symbol}`,s=v.get(H)?.data;if(s?.ltp!==void 0){const y=J(s.ltp,e.ce.tick_size);y!==void 0&&y!==e.ce.ltp&&(A=y,C=!0)}s?.volume!==void 0&&s.volume!==e.ce.volume&&(W=s.volume,C=!0);const b=s?.oi??s?.open_interest;b!==void 0&&b!==e.ce.oi&&(B=b,C=!0)}if(e.pe?.symbol){const H=`${u}:${e.pe.symbol}`,s=v.get(H)?.data;if(s?.ltp!==void 0){const y=J(s.ltp,e.pe.tick_size);y!==void 0&&y!==e.pe.ltp&&(O=y,E=!0)}s?.volume!==void 0&&s.volume!==e.pe.volume&&(Y=s.volume,E=!0);const b=s?.oi??s?.open_interest;b!==void 0&&b!==e.pe.oi&&(X=b,E=!0)}if(!C&&!E)return e;const $={...e};return C&&e.ce&&($.ce={...e.ce,...A!==void 0?{ltp:A}:{},...W!==void 0?{volume:W}:{},...B!==void 0?{oi:B}:{}}),E&&e.pe&&($.pe={...e.pe,...O!==void 0?{ltp:O}:{},...Y!==void 0?{volume:Y}:{},...X!==void 0?{oi:X}:{}}),$});let x=!1;for(const[,e]of v)if(e.lastUpdate&&e.lastUpdate>V.current){x=!0,V.current=e.lastUpdate;break}x&&f(new Date);const ne=`${G(t,u)}:${t}`,se=v.get(ne)?.data?.ltp??d.underlying_ltp;a({...d,underlying_ltp:se,chain:I})},[u,t]);n.useEffect(()=>{if(!c){a(null);return}if(L.size===0){a(c);return}return S.current===null&&(S.current=setTimeout(z,ie)),()=>{S.current!==null&&(clearTimeout(S.current),S.current=null)}},[c,L,z]);const k=q&&Q&&p.length>0,ee=o||Z,te=n.useMemo(()=>!i&&!r?null:i?r&&r>i?r:i:r,[i,r]);return{data:F,isLoading:m,isConnected:M,isStreaming:k,isPaused:ee,error:h,lastUpdate:te,streamingSymbols:p.length,refetch:w}}export{ve as u};
