import{r as d,j as n}from"./vendor-react-CCyQGCED.js";import{c as Se,v as en,$ as _t,a3 as Vt,d as le,e as xe,u as $n,M as rt,B as te}from"./index-CxWIdu9R.js";import{aU as bs}from"./vendor-icons-CCn_k3dF.js";import{u as zn}from"./useQuery-CUC3XmjK.js";import{S as kt,a as Lt,b as Mt,c as Rt,d as dt}from"./select-Danji5be.js";import{u as vs}from"./useOptionChainLive-BM2dJ9g5.js";import{q as In,K as On,W as An,R as Fn,n as Re,h as ke}from"./lightweight-charts.production-fmEoZjtL.js";import{t as oe}from"./trading-DnzbYX--.js";import{a as Dn}from"./useMarketStatus-C495_HHr.js";import{I as $e}from"./input-DVWRbPng.js";import{L as Ce}from"./label-yqvBNmh9.js";import{S as _n}from"./switch-CN7izT9z.js";import{f as Ss,r as js,a as Ns,b as Ps}from"./ai-scalper-CdxRdRC_.js";import{u as Cs}from"./useLivePrice-C0vt3ppn.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";function ne(e,t="Assertion error"){if(!e)throw Error(t)}function Ue({group:e}){const{orientation:t,panels:s}=e;return s.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function Ot(e,t){return t.sort(e==="horizontal"?Ts:ws)}function Ts(e,t){const s=e.element.offsetLeft-t.element.offsetLeft;return s!==0?s:e.element.offsetWidth-t.element.offsetWidth}function ws(e,t){const s=e.element.offsetTop-t.element.offsetTop;return s!==0?s:e.element.offsetHeight-t.element.offsetHeight}function Vn(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function Gn(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Es({orientation:e,rects:t,targetRect:s}){const r={x:s.x+s.width/2,y:s.y+s.height/2};let i,o=Number.MAX_VALUE;for(const a of t){const{x:l,y:c}=Gn(r,a),m=e==="horizontal"?l:c;m<o&&(o=m,i=a)}return ne(i,"No rect found"),i}let ut;function ks(){return ut===void 0&&(typeof matchMedia=="function"?ut=!!matchMedia("(pointer:coarse)").matches:ut=!1),ut}function qn(e){const{element:t,orientation:s,panels:r,separators:i}=e,o=Ot(s,Array.from(t.children).filter(Vn).map(p=>({element:p}))).map(({element:p})=>p),a=[];let l=!1,c,m=[];for(const p of o)if(p.hasAttribute("data-panel")){const u=r.find(y=>y.element===p);if(u){if(c){const y=c.element.getBoundingClientRect(),v=p.getBoundingClientRect();let h;if(l){const P=s==="horizontal"?new DOMRect(y.right,y.top,0,y.height):new DOMRect(y.left,y.bottom,y.width,0),g=s==="horizontal"?new DOMRect(v.left,v.top,0,v.height):new DOMRect(v.left,v.top,v.width,0);switch(m.length){case 0:{h=[P,g];break}case 1:{const C=m[0],T=Es({orientation:s,rects:[y,v],targetRect:C.element.getBoundingClientRect()});h=[C,T===y?g:P];break}default:{h=m;break}}}else m.length?h=m:h=[s==="horizontal"?new DOMRect(y.right,v.top,v.left-y.right,v.height):new DOMRect(v.left,y.bottom,v.width,v.top-y.bottom)];for(const P of h){let g="width"in P?P:P.element.getBoundingClientRect();const C=ks()?37:27;if(g.width<C){const T=C-g.width;g=new DOMRect(g.x-T/2,g.y,g.width+T,g.height)}if(g.height<C){const T=C-g.height;g=new DOMRect(g.x,g.y-T/2,g.width,g.height+T)}a.push({group:e,groupSize:Ue({group:e}),panels:[c,u],separator:"width"in P?void 0:P,rect:g})}}l=!1,c=u,m=[]}}else if(p.hasAttribute("data-separator")){const u=i.find(y=>y.element===p);u?m.push(u):(c=void 0,m=[])}else l=!0;return a}function Ls(e,t){const s=getComputedStyle(e),r=parseFloat(s.fontSize);return t*r}function Ms(e,t){const s=getComputedStyle(e.ownerDocument.body),r=parseFloat(s.fontSize);return t*r}function Rs(e){return e/100*window.innerHeight}function $s(e){return e/100*window.innerWidth}function zs(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function pt({groupSize:e,panelElement:t,styleProp:s}){let r;const[i,o]=zs(s);switch(o){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=Ms(t,i);break}case"em":{r=Ls(t,i);break}case"vh":{r=Rs(i);break}case"vw":{r=$s(i);break}}return r}function Ee(e){return parseFloat(e.toFixed(3))}function tn(e){const{panels:t}=e,s=Ue({group:e});return s===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:o}=r;let a=0;if(o.collapsedSize!==void 0){const p=pt({groupSize:s,panelElement:i,styleProp:o.collapsedSize});a=Ee(p/s*100)}let l;if(o.defaultSize!==void 0){const p=pt({groupSize:s,panelElement:i,styleProp:o.defaultSize});l=Ee(p/s*100)}let c=0;if(o.minSize!==void 0){const p=pt({groupSize:s,panelElement:i,styleProp:o.minSize});c=Ee(p/s*100)}let m=100;if(o.maxSize!==void 0){const p=pt({groupSize:s,panelElement:i,styleProp:o.maxSize});m=Ee(p/s*100)}return{collapsedSize:a,collapsible:o.collapsible===!0,defaultSize:l,minSize:c,maxSize:m,panelId:r.id}})}class Is{#e={};addListener(t,s){const r=this.#e[t];return r===void 0?this.#e[t]=[s]:r.includes(s)||r.push(s),()=>{this.removeListener(t,s)}}emit(t,s){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,s);else{let i=!1,o=null;const a=Array.from(r);for(let l=0;l<a.length;l++){const c=a[l];try{c.call(null,s)}catch(m){o===null&&(i=!0,o=m)}}if(i)throw o}}removeAllListeners(){this.#e={}}removeListener(t,s){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(s);i>=0&&r.splice(i,1)}}}function be(e,t,s=0){return Math.abs(Ee(e)-Ee(t))<=s}let Pe={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const De=new Is;function je(){return Pe}function ve(e){const t=typeof e=="function"?e(Pe):e;if(Pe===t)return Pe;const s=Pe;return Pe={...Pe,...t},t.cursorFlags!==void 0&&De.emit("cursorFlagsChange",Pe.cursorFlags),t.interactionState!==void 0&&De.emit("interactionStateChange",Pe.interactionState),t.mountedGroups!==void 0&&(Pe.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(o=>{if(o.collapsible){const{layout:a}=s.mountedGroups.get(i)??{};if(a){const l=be(o.collapsedSize,r.layout[o.panelId]),c=be(o.collapsedSize,a[o.panelId]);l&&!c&&(i.inMemoryLastExpandedPanelSizes[o.panelId]=a[o.panelId])}}})}),De.emit("mountedGroupsChange",Pe.mountedGroups)),Pe}function Os(e,t,s){let r,i={x:1/0,y:1/0};for(const o of t){const a=Gn(s,o.rect);switch(e){case"horizontal":{a.x<=i.x&&(r=o,i=a);break}case"vertical":{a.y<=i.y&&(r=o,i=a);break}}}return r?{distance:i,hitRegion:r}:void 0}function As(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function Fs(e,t){if(e===t)throw new Error("Cannot compare node with itself");const s={a:rn(e),b:rn(t)};let r;for(;s.a.at(-1)===s.b.at(-1);)e=s.a.pop(),t=s.b.pop(),r=e;ne(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:sn(nn(s.a)),b:sn(nn(s.b))};if(i.a===i.b){const o=r.childNodes,a={a:s.a.at(-1),b:s.b.at(-1)};let l=o.length;for(;l--;){const c=o[l];if(c===a.a)return 1;if(c===a.b)return-1}}return Math.sign(i.a-i.b)}const Ds=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function _s(e){const t=getComputedStyle(Bn(e)??e).display;return t==="flex"||t==="inline-flex"}function Vs(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||_s(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||Ds.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function nn(e){let t=e.length;for(;t--;){const s=e[t];if(ne(s,"Missing node"),Vs(s))return s}return null}function sn(e){return e&&Number(getComputedStyle(e).zIndex)||0}function rn(e){const t=[];for(;e;)t.push(e),e=Bn(e);return t}function Bn(e){const{parentNode:t}=e;return As(t)?t.host:t}function Gs(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function qs({groupElement:e,hitRegion:t,pointerEventTarget:s}){if(!Vn(s)||s.contains(e)||e.contains(s))return!0;if(Fs(s,e)>0){let r=s;for(;r;){if(r.contains(e))return!0;if(Gs(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function Gt(e,t){const s=[];return t.forEach((r,i)=>{if(i.disabled)return;const o=qn(i),a=Os(i.orientation,o,{x:e.clientX,y:e.clientY});a&&a.distance.x<=0&&a.distance.y<=0&&qs({groupElement:i.element,hitRegion:a.hitRegion.rect,pointerEventTarget:e.target})&&s.push(a.hitRegion)}),s}function Bs(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!=t[s])return!1;return!0}function it(e,t){return be(e,t)?0:e>t?1:-1}function We({panelConstraints:e,size:t}){const{collapsedSize:s=0,collapsible:r,maxSize:i=100,minSize:o=0}=e;if(it(t,o)<0)if(r){const a=(s+o)/2;it(t,a)<0?t=s:t=o}else t=o;return t=Math.min(i,t),t=Ee(t),t}function at({delta:e,initialLayout:t,panelConstraints:s,pivotIndices:r,prevLayout:i,trigger:o}){if(be(e,0))return t;const a=Object.values(t),l=Object.values(i),c=[...a],[m,p]=r;ne(m!=null,"Invalid first pivot index"),ne(p!=null,"Invalid second pivot index");let u=0;if(o==="keyboard"){{const h=e<0?p:m,P=s[h];ne(P,`Panel constraints not found for index ${h}`);const{collapsedSize:g=0,collapsible:C,minSize:T=0}=P;if(C){const k=a[h];if(ne(k!=null,`Previous layout not found for panel index ${h}`),be(k,g)){const M=T-k;it(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}{const h=e<0?m:p,P=s[h];ne(P,`No panel constraints found for index ${h}`);const{collapsedSize:g=0,collapsible:C,minSize:T=0}=P;if(C){const k=a[h];if(ne(k!=null,`Previous layout not found for panel index ${h}`),be(k,T)){const M=k-g;it(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}}{const h=e<0?1:-1;let P=e<0?p:m,g=0;for(;;){const T=a[P];ne(T!=null,`Previous layout not found for panel index ${P}`);const k=We({panelConstraints:s[P],size:100})-T;if(g+=k,P+=h,P<0||P>=s.length)break}const C=Math.min(Math.abs(e),Math.abs(g));e=e<0?0-C:C}{let h=e<0?m:p;for(;h>=0&&h<s.length;){const P=Math.abs(e)-Math.abs(u),g=a[h];ne(g!=null,`Previous layout not found for panel index ${h}`);const C=g-P,T=We({panelConstraints:s[h],size:C});if(!be(g,T)&&(u+=g-T,c[h]=T,u.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?h--:h++}}if(Bs(l,c))return i;{const h=e<0?p:m,P=a[h];ne(P!=null,`Previous layout not found for panel index ${h}`);const g=P+u,C=We({panelConstraints:s[h],size:g});if(c[h]=C,!be(C,g)){let T=g-C,k=e<0?p:m;for(;k>=0&&k<s.length;){const M=c[k];ne(M!=null,`Previous layout not found for panel index ${k}`);const V=M+T,F=We({panelConstraints:s[k],size:V});if(be(M,F)||(T-=F-M,c[k]=F),be(T,0))break;e>0?k--:k++}}}const y=Object.values(c).reduce((h,P)=>P+h,0);if(!be(y,100,.1))return i;const v=Object.keys(i);return c.reduce((h,P,g)=>(h[v[g]]=P,h),{})}function _e(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(t[s]===void 0||it(e[s],t[s])!==0)return!1;return!0}function Ve({layout:e,panelConstraints:t}){const s=[...Object.values(e)],r=s.reduce((a,l)=>a+l,0);if(s.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${s.map(a=>`${a}%`).join(", ")}`);if(!be(r,100)&&s.length>0)for(let a=0;a<t.length;a++){const l=s[a];ne(l!=null,`No layout data found for index ${a}`);const c=100/r*l;s[a]=c}let i=0;for(let a=0;a<t.length;a++){const l=s[a];ne(l!=null,`No layout data found for index ${a}`);const c=We({panelConstraints:t[a],size:l});l!=c&&(i+=l-c,s[a]=c)}if(!be(i,0))for(let a=0;a<t.length;a++){const l=s[a];ne(l!=null,`No layout data found for index ${a}`);const c=l+i,m=We({panelConstraints:t[a],size:c});if(l!==m&&(i-=m-l,s[a]=m,be(i,0)))break}const o=Object.keys(e);return s.reduce((a,l,c)=>(a[o[c]]=l,a),{})}function Kn({groupId:e,panelId:t}){const s=()=>{const{mountedGroups:l}=je();for(const[c,{defaultLayoutDeferred:m,derivedPanelConstraints:p,layout:u,separatorToPanels:y}]of l)if(c.id===e)return{defaultLayoutDeferred:m,derivedPanelConstraints:p,group:c,layout:u,separatorToPanels:y};throw Error(`Group ${e} not found`)},r=()=>{const l=s().derivedPanelConstraints.find(c=>c.panelId===t);if(l!==void 0)return l;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const l=s().group.panels.find(c=>c.id===t);if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},o=()=>{const l=s().layout[t];if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},a=l=>{const c=o();if(l===c)return;const{defaultLayoutDeferred:m,derivedPanelConstraints:p,group:u,layout:y,separatorToPanels:v}=s(),h=u.panels.findIndex(T=>T.id===t),P=h===u.panels.length-1,g=at({delta:P?c-l:l-c,initialLayout:y,panelConstraints:p,pivotIndices:P?[h-1,h]:[h,h+1],prevLayout:y,trigger:"imperative-api"}),C=Ve({layout:g,panelConstraints:p});_e(y,C)||ve(T=>({mountedGroups:new Map(T.mountedGroups).set(u,{defaultLayoutDeferred:m,derivedPanelConstraints:p,layout:C,separatorToPanels:v})}))};return{collapse:()=>{const{collapsible:l,collapsedSize:c}=r(),{mutableValues:m}=i(),p=o();l&&p!==c&&(m.expandToSize=p,a(c))},expand:()=>{const{collapsible:l,collapsedSize:c,minSize:m}=r(),{mutableValues:p}=i(),u=o();if(l&&u===c){let y=p.expandToSize??m;y===0&&(y=1),a(y)}},getSize:()=>{const{group:l}=s(),c=o(),{element:m}=i(),p=l.orientation==="horizontal"?m.offsetWidth:m.offsetHeight;return{asPercentage:c,inPixels:p}},isCollapsed:()=>{const{collapsible:l,collapsedSize:c}=r(),m=o();return l&&be(c,m)},resize:l=>{if(o()!==l){let c;switch(typeof l){case"number":{const{group:m}=s(),p=Ue({group:m});c=Ee(l/p*100);break}case"string":{c=parseFloat(l);break}}a(c)}}}}function an(e){if(e.defaultPrevented)return;const{mountedGroups:t}=je(),s=Gt(e,t),r=new Set,i=new Set;s.forEach(o=>{if(r.add(o.group),o.panels.forEach(a=>{i.add(a)}),o.separator){const a=o.panels.find(l=>l.panelConstraints.defaultSize!==void 0);if(a){const l=a.panelConstraints.defaultSize,c=Kn({groupId:o.group.id,panelId:a.id});c&&l!==void 0&&(c.resize(l),e.preventDefault())}}})}function vt(e){const{mountedGroups:t}=je();for(const[s]of t)if(s.separators.some(r=>r.element===e))return s;throw Error("Could not find parent Group for separator element")}function Wn({groupId:e}){const t=()=>{const{mountedGroups:s}=je();for(const[r,i]of s)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:s,layout:r}=t();return s?{}:r},setLayout(s){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:o,layout:a,separatorToPanels:l}=t(),c=Ve({layout:s,panelConstraints:i});return r?a:(_e(a,c)||ve(m=>({mountedGroups:new Map(m.mountedGroups).set(o,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:c,separatorToPanels:l})})),c)}}}function Un(e){const{mountedGroups:t}=je(),s=t.get(e);return ne(s,`Mounted Group ${e.id} not found`),s}function Ae(e,t){const s=vt(e),r=Un(s),i=s.separators.find(p=>p.element===e);ne(i,"Matching separator not found");const o=r.separatorToPanels.get(i);ne(o,"Matching panels not found");const a=o.map(p=>s.panels.indexOf(p)),l=Wn({groupId:s.id}).getLayout(),c=at({delta:t,initialLayout:l,panelConstraints:r.derivedPanelConstraints,pivotIndices:a,prevLayout:l,trigger:"keyboard"}),m=Ve({layout:c,panelConstraints:r.derivedPanelConstraints});_e(l,m)||ve(p=>({mountedGroups:new Map(p.mountedGroups).set(s,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:m,separatorToPanels:r.separatorToPanels})}))}function on(e){if(e.defaultPrevented)return;const t=e.currentTarget,s=vt(t);if(!s.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),s.orientation==="vertical"&&Ae(t,5);break}case"ArrowLeft":{e.preventDefault(),s.orientation==="horizontal"&&Ae(t,-5);break}case"ArrowRight":{e.preventDefault(),s.orientation==="horizontal"&&Ae(t,5);break}case"ArrowUp":{e.preventDefault(),s.orientation==="vertical"&&Ae(t,-5);break}case"End":{e.preventDefault(),Ae(t,100);break}case"Enter":{e.preventDefault();const r=vt(t),{derivedPanelConstraints:i,layout:o,separatorToPanels:a}=Un(r),l=r.separators.find(u=>u.element===t);ne(l,"Matching separator not found");const c=a.get(l);ne(c,"Matching panels not found");const m=c[0],p=i.find(u=>u.panelId===m.id);if(ne(p,"Panel metadata not found"),p.collapsible){const u=o[m.id],y=p.collapsedSize===u?r.inMemoryLastExpandedPanelSizes[m.id]??p.minSize:p.collapsedSize;Ae(t,y-u)}break}case"F6":{e.preventDefault();const r=vt(t).separators.map(a=>a.element),i=Array.from(r).findIndex(a=>a===e.currentTarget);ne(i!==null,"Index not found");const o=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[o].focus();break}case"Home":{e.preventDefault(),Ae(t,-100);break}}}function ln(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=je(),s=Gt(e,t),r=new Set,i=new Set,o=new Set,a=new Map;let l=!1;s.forEach(c=>{r.add(c.group),c.panels.forEach(p=>{i.add(p)}),c.separator&&(o.add(c.separator),l||(l=!0,c.separator.element.focus()));const m=t.get(c.group);m&&a.set(c.group,m.layout)}),ve({interactionState:{hitRegions:s,initialLayoutMap:a,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),s.length&&e.preventDefault()}const Ks=e=>e,$t=()=>{},Hn=1,Yn=2,Xn=4,Zn=8,cn=3,dn=12;let ft;function un(){return ft===void 0&&(ft=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(ft=!0)),ft}function Ws({cursorFlags:e,groups:t,state:s}){let r=0,i=0;switch(s){case"active":case"hover":t.forEach(o=>{if(!o.disableCursor)switch(o.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(s){case"active":{if(e&&un()){const o=(e&Hn)!==0,a=(e&Yn)!==0,l=(e&Xn)!==0,c=(e&Zn)!==0;if(o)return l?"se-resize":c?"ne-resize":"e-resize";if(a)return l?"sw-resize":c?"nw-resize":"w-resize";if(l)return"s-resize";if(c)return"n-resize"}break}}return un()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const pn=new WeakMap;function qt(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:s}=pn.get(e)??{};s===void 0&&(s=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(s));const{cursorFlags:r,interactionState:i}=je();switch(i.state){case"active":case"hover":{const o=Ws({cursorFlags:r,groups:i.hitRegions.map(l=>l.group),state:i.state}),a=`*, *:hover {cursor: ${o} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===a)return;t=a,o?s.cssRules.length===0?s.insertRule(a):s.replaceSync(a):s.cssRules.length===1&&s.deleteRule(0);break}case"inactive":{t=void 0,s.cssRules.length===1&&s.deleteRule(0);break}}pn.set(e,{prevStyle:t,styleSheet:s})}function Qn({document:e,event:t,hitRegions:s,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:o,prevCursorFlags:a}){let l=0;const c=new Map(i);s.forEach(p=>{const{group:u,groupSize:y}=p,{disableCursor:v,orientation:h,panels:P}=u;let g=0;o?h==="horizontal"?g=(t.clientX-o.x)/y*100:g=(t.clientY-o.y)/y*100:h==="horizontal"?g=t.clientX<0?-100:100:g=t.clientY<0?-100:100;const C=r.get(u),{defaultLayoutDeferred:T,derivedPanelConstraints:k,layout:M,separatorToPanels:V}=i.get(u)??{defaultLayoutDeferred:!1};if(k&&C&&M&&V){const F=at({delta:g,initialLayout:C,panelConstraints:k,pivotIndices:p.panels.map(S=>P.indexOf(S)),prevLayout:M,trigger:"mouse-or-touch"});if(_e(F,M)){if(g!==0&&!v)switch(h){case"horizontal":{l|=g<0?Hn:Yn;break}case"vertical":{l|=g<0?Xn:Zn;break}}}else{c.set(p.group,{defaultLayoutDeferred:T,derivedPanelConstraints:k,layout:F,separatorToPanels:V});const S=p.group.panels.map(({id:x})=>x).join(",");p.group.inMemoryLayouts[S]=F}}});let m=0;t.movementX===0?m|=a&cn:m|=l&cn,t.movementY===0?m|=a&dn:m|=l&dn,ve({cursorFlags:m,mountedGroups:c}),qt(e)}function fn(e){const{cursorFlags:t,interactionState:s,mountedGroups:r}=je();s.state==="active"&&Qn({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function mn(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:s,mountedGroups:r}=je();switch(s.state){case"active":{if(e.buttons===0){ve(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),ve(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Qn({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:s.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=Gt(e,r);i.length===0?s.state!=="inactive"&&ve({interactionState:{state:"inactive"}}):ve({interactionState:{hitRegions:i,state:"hover"}}),qt(e.currentTarget);break}}}function xn(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=je();t.state==="active"&&(ve({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(qt(e.currentTarget),ve(s=>({mountedGroups:new Map(s.mountedGroups)})),e.preventDefault()))}function hn(e){let t=0,s=0;const r={};for(const o of e)if(o.defaultSize!==void 0){t++;const a=Ee(o.defaultSize);s+=a,r[o.panelId]=a}else r[o.panelId]=void 0;const i=e.length-t;if(i!==0){const o=Ee((100-s)/i);for(const a of e)a.defaultSize===void 0&&(r[a.panelId]=o)}return r}function Us(e,t,s){if(!s[0])return;const r=e.panels.find(c=>c.element===t);if(!r||!r.onResize)return;const i=Ue({group:e}),o=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,a=r.mutableValues.prevSize,l={asPercentage:Ee(o/i*100),inPixels:o};r.mutableValues.prevSize=l,r.onResize(l,r.id,a)}function Hs(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}function Ys(e,t){const s=e.map(i=>i.id),r=Object.keys(t);if(s.length!==r.length)return!1;for(const i of s)if(!r.includes(i))return!1;return!0}const Be=new Map;function Xs(e){let t=!0;ne(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const s=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,o=new s(h=>{for(const P of h){const{borderBoxSize:g,target:C}=P;if(C===e.element){if(t){if(Ue({group:e})===0)return;ve(T=>{const k=T.mountedGroups.get(e);if(k){const M=tn(e),V=k.defaultLayoutDeferred?hn(M):k.layout,F=Ve({layout:V,panelConstraints:M});return!k.defaultLayoutDeferred&&_e(V,F)&&Hs(k.derivedPanelConstraints,M)?T:{mountedGroups:new Map(T.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:M,layout:F,separatorToPanels:k.separatorToPanels})}}return T})}}else Us(e,C,g)}});o.observe(e.element),e.panels.forEach(h=>{ne(!r.has(h.id),`Panel ids must be unique; id "${h.id}" was used more than once`),r.add(h.id),h.onResize&&o.observe(h.element)});const a=Ue({group:e}),l=tn(e),c=e.panels.map(({id:h})=>h).join(",");let m=e.defaultLayout;m&&(Ys(e.panels,m)||(m=void 0));const p=e.inMemoryLayouts[c]??m??hn(l),u=Ve({layout:p,panelConstraints:l}),y=qn(e),v=e.element.ownerDocument;return ve(h=>{const P=new Map;return Be.set(v,(Be.get(v)??0)+1),y.forEach(g=>{g.separator&&P.set(g.separator,g.panels)}),{mountedGroups:new Map(h.mountedGroups).set(e,{defaultLayoutDeferred:a===0,derivedPanelConstraints:l,layout:u,separatorToPanels:P})}}),e.separators.forEach(h=>{ne(!i.has(h.id),`Separator ids must be unique; id "${h.id}" was used more than once`),i.add(h.id),h.element.addEventListener("keydown",on)}),Be.get(v)===1&&(v.addEventListener("dblclick",an,!0),v.addEventListener("pointerdown",ln,!0),v.addEventListener("pointerleave",fn),v.addEventListener("pointermove",mn),v.addEventListener("pointerup",xn,!0)),function(){t=!1,Be.set(v,Math.max(0,(Be.get(v)??0)-1)),ve(h=>{const P=new Map(h.mountedGroups);return P.delete(e),{mountedGroups:P}}),e.separators.forEach(h=>{h.element.removeEventListener("keydown",on)}),Be.get(v)||(v.removeEventListener("dblclick",an,!0),v.removeEventListener("pointerdown",ln,!0),v.removeEventListener("pointerleave",fn),v.removeEventListener("pointermove",mn),v.removeEventListener("pointerup",xn,!0)),o.disconnect()}}function Jn(){const[e,t]=d.useState({}),s=d.useCallback(()=>t({}),[]);return[e,s]}function Bt(e){const t=d.useId();return`${e??t}`}const qe=typeof window<"u"?d.useLayoutEffect:d.useEffect;function nt(e){const t=d.useRef(e);return qe(()=>{t.current=e},[e]),d.useCallback((...s)=>t.current?.(...s),[t])}function Kt(...e){return nt(t=>{e.forEach(s=>{if(s)switch(typeof s){case"function":{s(t);break}case"object":{s.current=t;break}}})})}function Zs(e){const t=d.useRef({...e});return qe(()=>{for(const s in e)t.current[s]=e[s]},[e]),t.current}const es=d.createContext(null);function Qs(e,t){const s=d.useRef({getLayout:()=>({}),setLayout:Ks});d.useImperativeHandle(t,()=>s.current,[]),qe(()=>{Object.assign(s.current,Wn({groupId:e}))})}function ts({children:e,className:t,defaultLayout:s,disableCursor:r,disabled:i,elementRef:o,groupRef:a,id:l,onLayoutChange:c,onLayoutChanged:m,orientation:p="horizontal",style:u,...y}){const v=d.useRef({onLayoutChange:{},onLayoutChanged:{}}),h=nt(R=>{_e(v.current.onLayoutChange,R)||(v.current.onLayoutChange=R,c?.(R))}),P=nt(R=>{_e(v.current.onLayoutChanged,R)||(v.current.onLayoutChanged=R,m?.(R))}),g=Bt(l),C=d.useRef(null),[T,k]=Jn(),M=d.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),V=Kt(C,o);Qs(g,a);const F=nt((R,z)=>{const{interactionState:I,mountedGroups:f}=je();for(const L of f.keys())if(L.id===R){const q=f.get(L);if(q){let $=!1;return I.state==="active"&&($=I.hitRegions.some(G=>G.group===L)),{flexGrow:q.layout[z]??1,pointerEvents:$?"none":void 0}}}return{flexGrow:s?.[z]??1}}),S=d.useMemo(()=>({getPanelStyles:F,id:g,orientation:p,registerPanel:R=>{const z=M.current;return z.panels=Ot(p,[...z.panels,R]),k(),()=>{z.panels=z.panels.filter(I=>I!==R),k()}},registerSeparator:R=>{const z=M.current;return z.separators=Ot(p,[...z.separators,R]),k(),()=>{z.separators=z.separators.filter(I=>I!==R),k()}}}),[F,g,k,p]),x=Zs({defaultLayout:s,disableCursor:r}),E=d.useRef(null);return qe(()=>{const R=C.current;if(R===null)return;const z=M.current,I={defaultLayout:x.defaultLayout,disableCursor:!!x.disableCursor,disabled:!!i,element:R,id:g,inMemoryLastExpandedPanelSizes:M.current.lastExpandedPanelSizes,inMemoryLayouts:M.current.layouts,orientation:p,panels:z.panels,separators:z.separators};E.current=I;const f=Xs(I),L=je().mountedGroups.get(I);if(L){const{defaultLayoutDeferred:G,derivedPanelConstraints:N,layout:D}=L;!G&&N.length>0&&(h(D),P(D),z.panels.forEach(B=>{B.scheduleUpdate()}))}const q=De.addListener("interactionStateChange",()=>{z.panels.forEach(G=>{G.scheduleUpdate()})}),$=De.addListener("mountedGroupsChange",G=>{const N=G.get(I);if(N){const{defaultLayoutDeferred:D,derivedPanelConstraints:B,layout:O}=N;if(D||B.length===0)return;const{interactionState:A}=je(),K=A.state!=="active";h(O),K&&P(O),z.panels.forEach(Z=>{Z.scheduleUpdate()})}});return()=>{E.current=null,f(),q(),$()}},[i,g,P,h,p,T,x]),d.useEffect(()=>{const R=E.current;R&&(R.defaultLayout=s,R.disableCursor=!!r)}),n.jsx(es.Provider,{value:S,children:n.jsx("div",{...y,"aria-orientation":p,className:t,"data-group":!0,"data-testid":g,id:g,ref:V,style:{height:"100%",width:"100%",overflow:"hidden",...u,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}ts.displayName="Group";function Wt(){const e=d.useContext(es);return ne(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Js(e,t){const{id:s}=Wt(),r=d.useRef({collapse:$t,expand:$t,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:$t});d.useImperativeHandle(t,()=>r.current,[]),qe(()=>{Object.assign(r.current,Kn({groupId:s,panelId:e}))})}function ns({children:e,className:t,collapsedSize:s="0%",collapsible:r=!1,defaultSize:i,elementRef:o,id:a,maxSize:l="100%",minSize:c="0%",onResize:m,panelRef:p,style:u,...y}){const v=!!a,h=Bt(a),P=d.useRef(null),g=Kt(P,o),[,C]=Jn(),{getPanelStyles:T,id:k,registerPanel:M}=Wt(),V=m!==null,F=nt((x,E,R)=>{m?.(x,a,R)});qe(()=>{const x=P.current;if(x!==null)return M({element:x,id:h,idIsStable:v,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:V?F:void 0,panelConstraints:{collapsedSize:s,collapsible:r,defaultSize:i,maxSize:l,minSize:c},scheduleUpdate:C})},[s,r,i,C,V,h,v,l,c,F,M]),Js(h,p);const S=T(k,h);return n.jsx("div",{...y,"data-panel":!0,"data-testid":h,id:h,ref:g,style:{...er,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...S},children:n.jsx("div",{className:t,style:{flexGrow:1,...u},children:e})})}ns.displayName="Panel";const er={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function tr({layout:e,panelConstraints:t,panelId:s,panelIndex:r}){let i,o;const a=e[s],l=t.find(c=>c.panelId===s);if(l){const c=l.maxSize,m=o=l.collapsible?l.collapsedSize:l.minSize,p=[r,r+1];o=Ve({layout:at({delta:m-a,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s],i=Ve({layout:at({delta:c-a,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s]}return{valueControls:s,valueMax:i,valueMin:o,valueNow:a}}function ss({children:e,className:t,elementRef:s,id:r,style:i,...o}){const a=Bt(r),[l,c]=d.useState({}),[m,p]=d.useState("inactive"),u=d.useRef(null),y=Kt(u,s),{id:v,orientation:h,registerSeparator:P}=Wt(),g=h==="horizontal"?"vertical":"horizontal";return qe(()=>{const C=u.current;if(C!==null){const T={element:C,id:a},k=P(T),M=De.addListener("interactionStateChange",F=>{p(F.state!=="inactive"&&F.hitRegions.some(S=>S.separator===T)?F.state:"inactive")}),V=De.addListener("mountedGroupsChange",F=>{F.forEach(({derivedPanelConstraints:S,layout:x,separatorToPanels:E},R)=>{if(R.id===v){const z=E.get(T);if(z){const I=z[0],f=R.panels.indexOf(I);c(tr({layout:x,panelConstraints:S,panelId:I.id,panelIndex:f}))}}})});return()=>{M(),V(),k()}}},[v,a,P]),n.jsx("div",{...o,"aria-controls":l.valueControls,"aria-orientation":g,"aria-valuemax":l.valueMax,"aria-valuemin":l.valueMin,"aria-valuenow":l.valueNow,children:e,className:t,"data-separator":m,"data-testid":a,id:a,ref:y,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}ss.displayName="Separator";function At({className:e,...t}){return n.jsx(ts,{"data-slot":"resizable-panel-group",className:Se("h-full w-full",e),...t})}function Fe({className:e,...t}){return n.jsx(ns,{"data-slot":"resizable-panel",className:Se("min-w-0 min-h-0",e),...t})}function jt({withHandle:e,className:t,...s}){return n.jsx(ss,{"data-slot":"resizable-handle",className:Se("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...s,children:e&&n.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:n.jsx(bs,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const nr={getOptionChain:async(e,t,s,r,i)=>(await en.post("/optionchain",{apikey:e,underlying:t,exchange:s,expiry_date:r,strike_count:i??20})).data,getExpiries:async(e,t,s,r="options")=>(await en.post("/expiry",{apikey:e,symbol:t,exchange:s,instrumenttype:r})).data},sr={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:10},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}},j=_t()(Vt(e=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,setUnderlying:t=>{const s=sr[t];e({underlying:t,optionExchange:s.optionExchange,indexExchange:s.indexExchange,lotSize:s.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[]})},setExpiry:t=>e(s=>s.expiry===t?s:{expiry:t}),setExpiryWeek:t=>e(s=>s.expiryWeek===t?s:{expiryWeek:t}),setExpiries:t=>e(s=>s.expiries.length===t.length&&s.expiries.every((r,i)=>r===t[i])?s:{expiries:t}),setChainStrikeCount:t=>e(s=>{const r=Math.max(5,t);return s.chainStrikeCount===r?s:{chainStrikeCount:r}}),setSelectedStrike:t=>e(s=>s.selectedStrike===t?s:{selectedStrike:t}),setActiveSide:t=>e({activeSide:t}),toggleActiveSide:()=>e(t=>({activeSide:t.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(t,s)=>e(r=>r.selectedCESymbol===t&&r.selectedPESymbol===s?r:{selectedCESymbol:t,selectedPESymbol:s}),setQuantity:t=>e({quantity:Math.max(1,t)}),incrementQuantity:()=>e(t=>({quantity:t.quantity+1})),decrementQuantity:()=>e(t=>({quantity:Math.max(1,t.quantity-1)})),setOrderType:t=>e({orderType:t,...t==="MARKET"?{limitPrice:null,pendingEntryAction:null}:{}}),setProduct:t=>e({product:t}),setTpPoints:t=>e({tpPoints:Math.max(0,t)}),setSlPoints:t=>e({slPoints:Math.max(0,t)}),setLimitPrice:t=>e(s=>s.limitPrice===t?s:{limitPrice:t}),setPendingEntryAction:t=>e(s=>s.pendingEntryAction===t?s:{pendingEntryAction:t}),setPaperMode:t=>e(s=>s.paperMode===t?s:{paperMode:t}),setControlTab:t=>e({controlTab:t}),setHotkeysEnabled:t=>e({hotkeysEnabled:t}),setShowFloatingWidget:t=>e({showFloatingWidget:t}),toggleFloatingWidget:()=>e(t=>({showFloatingWidget:!t.showFloatingWidget})),setChainCollapsed:t=>e({chainCollapsed:t}),setControlCollapsed:t=>e({controlCollapsed:t}),setCeWidgetPos:t=>e({ceWidgetPos:t}),setPeWidgetPos:t=>e({peWidgetPos:t}),setLotSize:t=>e({lotSize:t}),setChartInterval:t=>e({chartInterval:t}),addSessionPnl:t=>e(s=>({sessionPnl:s.sessionPnl+t})),incrementTradeCount:()=>e(t=>({tradeCount:t.tradeCount+1})),resetSession:()=>e({sessionPnl:0,tradeCount:0})}),{name:"openalgo-scalping",partialize:e=>({underlying:e.underlying,expiryWeek:e.expiryWeek,chainStrikeCount:e.chainStrikeCount,quantity:e.quantity,orderType:e.orderType,product:e.product,tpPoints:e.tpPoints,slPoints:e.slPoints,paperMode:e.paperMode,hotkeysEnabled:e.hotkeysEnabled,showFloatingWidget:e.showFloatingWidget,chartInterval:e.chartInterval,ceWidgetPos:e.ceWidgetPos,peWidgetPos:e.peWidgetPos})})),rr=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],ir=[10,15,20,25,30],zt="__none__";function ar(e,t){return e.length===t.length&&e.every((s,r)=>s===t[r])}function or({liveOpenPnl:e,isLivePnl:t=!1}){const s=le(S=>S.apiKey),r=le(S=>S.user?.broker),i=j(S=>S.underlying),o=j(S=>S.optionExchange),a=j(S=>S.expiryWeek),l=j(S=>S.expiry),c=j(S=>S.expiries),m=j(S=>S.chainStrikeCount),p=j(S=>S.paperMode),u=j(S=>S.sessionPnl),y=j(S=>S.tradeCount),v=j(S=>S.setUnderlying),h=j(S=>S.setExpiryWeek),P=j(S=>S.setExpiry),g=j(S=>S.setExpiries),C=j(S=>S.setChainStrikeCount),T=j(S=>S.setPaperMode),k=p?u:e??u,M=l&&c.includes(l)?l:zt,{data:V}=zn({queryKey:["scalping-expiries",i,o],queryFn:()=>nr.getExpiries(s,i,o),enabled:!!s,staleTime:300*1e3});d.useEffect(()=>{if(V?.status!=="success")return;const S=V.data??[];if(ar(c,S)||g(S),S.length===0){l&&P("");return}if(!l||!S.includes(l)){const x=a==="next"?Math.min(1,S.length-1):0,E=S[x],R=x<=0?"current":"next";l!==E&&P(E),a!==R&&h(R)}},[V,a,c,l,g,P,h]);const F=S=>{if(S===zt)return;l!==S&&P(S);const E=c.indexOf(S)<=0?"current":"next";a!==E&&h(E)};return n.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),n.jsxs(kt,{value:i,onValueChange:S=>v(S),children:[n.jsx(Lt,{className:"h-7 w-[128px] text-xs font-semibold",children:n.jsx(Mt,{})}),n.jsx(Rt,{children:rr.map(S=>n.jsx(dt,{value:S,children:S},S))})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),n.jsxs(kt,{value:M,onValueChange:F,disabled:c.length===0,children:[n.jsx(Lt,{className:"h-7 w-[122px] text-xs font-mono",children:n.jsx(Mt,{placeholder:"Select expiry"})}),n.jsxs(Rt,{children:[n.jsx(dt,{value:zt,disabled:!0,children:"Select expiry"}),c.map(S=>n.jsx(dt,{value:S,children:S},S))]})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),n.jsxs(kt,{value:String(m),onValueChange:S=>C(Number(S)),children:[n.jsx(Lt,{className:"h-7 w-[94px] text-xs",children:n.jsx(Mt,{})}),n.jsx(Rt,{children:ir.map(S=>n.jsx(dt,{value:String(S),children:S},S))})]})]}),n.jsx("div",{className:"flex-1"}),n.jsx("div",{className:"flex items-center gap-1.5",children:n.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>T(!0),children:"Paper"}),n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>T(!1),children:"Live"})]})}),n.jsx("div",{className:"w-px h-5 bg-border"}),r&&n.jsx(xe,{variant:"outline",className:"text-xs h-6",children:r}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),n.jsxs("span",{className:`text-sm font-bold tabular-nums ${k>0?"text-green-500":k<0?"text-red-500":"text-foreground"}`,children:[k>=0?"+":"",k.toFixed(0)]}),!p&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),y>0&&n.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",y,")"]})]})]})}function mt(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function gn({value:e,prevRef:t,className:s,format:r="price"}){const i=d.useRef(null);d.useEffect(()=>{if(e==null||e===t.current)return;const a=i.current;if(!a)return;const l=e>t.current?"flash-green":"flash-red";a.classList.add(l);const c=setTimeout(()=>a.classList.remove(l),300);return t.current=e,()=>clearTimeout(c)},[e,t]);const o=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return n.jsx("span",{ref:i,className:Se("tabular-nums transition-colors",s),children:o})}function xt({value:e,max:t,side:s,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),o=Math.min(.2+i/180,.75);return n.jsx("div",{className:Se("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",s==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:o}})}function lr(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const cr=d.memo(function({strike:t,ce:s,pe:r,isATM:i,isSelected:o,maxOI:a,maxVol:l,onSelectStrike:c}){const m=d.useRef(s?.ltp??0),p=d.useRef(r?.ltp??0),u=Math.min(((s?.oi??0)/a+(s?.volume??0)/l)/2*100,100),y=Math.min(((r?.oi??0)/a+(r?.volume??0)/l)/2*100,100);return n.jsxs("div",{className:Se("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs cursor-pointer hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",o&&"bg-primary/10 ring-1 ring-primary/30"),onClick:()=>c(t,s?.symbol??null,r?.symbol??null),children:[n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[n.jsx(xt,{value:s?.oi??0,max:a,side:"CE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:mt(s?.oi)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[n.jsx(xt,{value:s?.volume??0,max:l,side:"CE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:mt(s?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[n.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${u}%`}}),n.jsx(gn,{value:s?.ltp,prevRef:m,className:"relative z-10 font-medium"})]}),n.jsx("div",{className:Se("text-center font-bold tabular-nums px-1",i&&"text-yellow-500"),children:t}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[n.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${y}%`}}),n.jsx(gn,{value:r?.ltp,prevRef:p,className:"relative z-10 font-medium"})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[n.jsx(xt,{value:r?.volume??0,max:l,side:"PE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:mt(r?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[n.jsx(xt,{value:r?.oi??0,max:a,side:"PE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:mt(r?.oi)})]})]})},lr);function dr(){const e=le(S=>S.apiKey),t=j(S=>S.underlying),s=j(S=>S.indexExchange),r=j(S=>S.optionExchange),i=j(S=>S.expiry),o=j(S=>S.selectedStrike),a=j(S=>S.chainStrikeCount),l=j(S=>S.setSelectedStrike),c=j(S=>S.setSelectedSymbols),m=j(S=>S.setLotSize),p=d.useRef(null),u=d.useRef(null),y=d.useRef(!1),{data:v,isLoading:h,isStreaming:P,error:g,streamingSymbols:C}=vs(e,t,s,r,i,a,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});d.useEffect(()=>{if(!v?.chain?.length||y.current)return;const S=v.chain[0],x=S.ce?.lotsize??S.pe?.lotsize;x&&x>0&&(m(x),y.current=!0)},[v,m]),d.useEffect(()=>{y.current=!1},[t,i]),d.useEffect(()=>{if(v?.chain&&u.current&&p.current){const S=p.current,x=u.current,E=S.getBoundingClientRect(),R=x.getBoundingClientRect(),z=R.top-E.top-E.height/2+R.height/2;S.scrollTop+=z}},[v?.atm_strike]);const T=d.useCallback((S,x,E)=>{l(S),c(x,E)},[l,c]),{maxOI:k,maxVol:M}=d.useMemo(()=>{if(!v?.chain?.length)return{maxOI:1,maxVol:1};let S=0,x=0;for(const E of v.chain)E.ce?.oi&&E.ce.oi>S&&(S=E.ce.oi),E.pe?.oi&&E.pe.oi>S&&(S=E.pe.oi),E.ce?.volume&&E.ce.volume>x&&(x=E.ce.volume),E.pe?.volume&&E.pe.volume>x&&(x=E.pe.volume);return{maxOI:S||1,maxVol:x||1}},[v?.chain]),V=v?.underlying_ltp,F=v?.atm_strike;return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-sm font-bold",children:t}),n.jsxs(xe,{variant:"outline",className:"text-[10px] h-4 px-1",children:[a," strikes"]}),V!=null&&n.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:V.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[P&&n.jsxs(xe,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[n.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),C]}),h&&n.jsx(xe,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),n.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[n.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),n.jsx("div",{className:"text-center",children:"Strike"}),n.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),n.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),n.jsxs("div",{ref:p,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[g&&n.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:g}),!g&&!h&&v?.chain?.length===0&&n.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),v?.chain?.map(S=>{const x=S.strike===F;return n.jsx("div",{ref:x?u:void 0,children:n.jsx(cr,{strike:S.strike,ce:S.ce,pe:S.pe,isATM:x,isSelected:S.strike===o,maxOI:k,maxVol:M,onSelectStrike:T})},S.strike)})]})]})}function ur({positions:e,totalPnl:t,isLivePnl:s}){const r=j(a=>a.activeSide),i=j(a=>a.hotkeysEnabled),o=j(a=>a.paperMode);return n.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[n.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?n.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):n.jsxs(n.Fragment,{children:[e.map(a=>n.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[n.jsx("span",{className:a.side==="CE"?"text-green-500":"text-red-500",children:a.side}),n.jsx("span",{className:"font-mono",children:a.symbol.slice(-10)}),n.jsxs("span",{className:"text-muted-foreground",children:["x",a.quantity]}),n.jsxs("span",{className:"text-muted-foreground",children:["@",a.avgPrice.toFixed(1)]}),n.jsxs("span",{className:`font-bold tabular-nums ${a.pnl>0?"text-green-500":a.pnl<0?"text-red-500":"text-foreground"}`,children:[a.pnl>=0?"+":"",a.pnl.toFixed(0),n.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",a.pnlPoints>=0?"+":"",a.pnlPoints.toFixed(1),"pts)"]})]})]},a.symbol)),e.length>0&&n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-border",children:"|"}),n.jsx("span",{className:"text-muted-foreground",children:"Total:"}),n.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),n.jsx("span",{className:`text-[10px] ${s?"text-green-500":"text-muted-foreground"}`,children:s?"LIVE":"REST"})]})]})}),n.jsx("div",{className:"flex items-center gap-2 shrink-0",children:o&&n.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),n.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?n.jsxs(n.Fragment,{children:[n.jsxs("span",{children:["Active: ",n.jsx("span",{className:"text-foreground font-medium",children:r})]}),n.jsx("span",{className:"text-border",children:"|"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),n.jsx("span",{children:"Buy"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),n.jsx("span",{children:"Sell"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),n.jsx("span",{children:"Rev"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),n.jsx("span",{children:"Close"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),n.jsx("span",{children:"All"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),n.jsx("span",{children:"Widget"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),n.jsx("span",{children:"Side"})]}):n.jsx("span",{children:"Hotkeys disabled"})})]})}const ot=300*60+1800,yn=1440*60,tt=540*60+900,bn=900*60+1800;function Nt(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function rs(e){const t=Nt(e)+ot,s=Math.floor(t/yn)*yn,r=t-s,i=(s-ot)*1e3,o=new Date(i).getUTCDay();return{dayStartIstSeconds:s,secondsOfDay:r,dayOfWeek:o}}function pr(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const s=Number(t[1]),r=Number(t[2]),i=Number(t[3]),o=Number(t[4]??"0"),a=Number(t[5]??"0"),l=Number(t[6]??"0");if(!Number.isFinite(s)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(o)||!Number.isFinite(a)||!Number.isFinite(l))return null;const c=Date.UTC(s,r-1,i,o,a,l)-ot*1e3;return Math.floor(c/1e3)}function ze(e){if(typeof e=="number")return Nt(e);if(typeof e!="string")return null;const t=e.trim();if(t.length===0)return null;const s=Number(t.replace(/,/g,""));if(Number.isFinite(s))return Nt(s);const r=pr(t);if(r!=null)return r;const i=Date.parse(t);return Number.isFinite(i)?Math.floor(i/1e3):null}function Ut(e,t={}){const{secondsOfDay:s,dayOfWeek:r}=rs(e);if(r===0||r===6)return!1;const i=s>=tt,o=t.includeClose?s<=bn:s<bn;return i&&o}function fr(e,t){const s=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=rs(e),o=i<=tt?tt:tt+Math.floor((i-tt)/s)*s;return r+o-ot}function is(e){const t=(Nt(e)+ot)*1e3,s=new Date(t),r=s.getUTCHours().toString().padStart(2,"0"),i=s.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function mr(e,t,s,r={}){const i=Math.floor(e.timestamp/1e3),a=r.alignToIndiaSession?fr(i,s):Math.floor(i/s)*s,l=e.volume??0;return!t||t.time!==a?[{time:a,open:e.price,high:e.price,low:e.price,close:e.price,volume:l},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+l},!1]}function as({symbol:e,exchange:t,intervalSec:s=1,enabled:r=!0,useIndiaMarketHours:i=!1,maxCandles:o=500,onCandleUpdate:a}){const l=d.useRef([]),c=d.useRef(null),m=d.useRef(null),p=d.useRef(a);p.current=a;const u=r&&e?[{symbol:e,exchange:t}]:[],{data:y,isConnected:v}=Dn({symbols:u,mode:"LTP",enabled:r&&!!e});d.useEffect(()=>{if(!r||!e||y.size===0)return;const C=`${t}:${e}`,T=y.get(C);if(!T?.data?.ltp)return;const k=T.lastUpdate;if(!k||!Number.isFinite(k))return;const M=Math.floor(k/1e3);if(i&&!Ut(M))return;const V=`${C}:${k}`;if(m.current===V)return;m.current=V;const F={price:T.data.ltp,volume:T.data.volume,timestamp:k},[S,x]=mr(F,c.current,s,{alignToIndiaSession:i});x&&c.current&&(l.current.push(c.current),l.current.length>o&&(l.current=l.current.slice(-o))),c.current=S,p.current?.(S,x)},[y,e,t,s,r,o,i]);const h=d.useCallback(()=>{const C=[...l.current];return c.current&&C.push(c.current),C},[]),P=d.useCallback(()=>{l.current=[],c.current=null},[]),g=d.useCallback(C=>{if(!C?.length){l.current=[],c.current=null;return}const T=C.slice(-o);if(T.length===1){l.current=[],c.current=T[0];return}l.current=T.slice(0,-1),c.current=T[T.length-1]},[o]);return{getCandles:h,reset:P,seed:g,isConnected:v}}function Pt(e,t){if(e.length<t)return[];const s=2/(t+1),r=[];let i=0;for(let a=0;a<t;a++)i+=e[a].value;let o=i/t;r.push({time:e[t-1].time,value:o});for(let a=t;a<e.length;a++)o=e[a].value*s+o*(1-s),r.push({time:e[a].time,value:o});return r}function os(e,t=10,s=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=xr(e,t),i=[],o=[],a=[];if(r.length===0)return{upper:i,lower:o,trend:a};const l=e.length-r.length;let c=0,m=0,p=1;for(let u=0;u<r.length;u++){const y=e[l+u],v=(y.high+y.low)/2,h=r[u].value;let P=v+s*h,g=v-s*h;u>0&&(g>m||e[l+u-1].close<m||(g=m),P<c||e[l+u-1].close>c||(P=c));let C=p;u>0&&(p===1&&y.close<g?C=-1:p===-1&&y.close>P&&(C=1));const T=y.time;i.push({time:T,value:P}),o.push({time:T,value:g}),a.push({time:T,value:C===1?g:P}),c=P,m=g,p=C}return{upper:i,lower:o,trend:a}}function xr(e,t=14){if(e.length<t+1)return[];const s=[],r=[];for(let o=1;o<e.length;o++){const a=e[o].high,l=e[o].low,c=e[o-1].close;r.push(Math.max(a-l,Math.abs(a-c),Math.abs(l-c)))}let i=0;for(let o=0;o<t;o++)i+=r[o];i/=t,s.push({time:e[t].time,value:i});for(let o=t;o<r.length;o++)i=(i*(t-1)+r[o])/t,s.push({time:e[o+1].time,value:i});return s}function ls(e){if(e.length===0)return[];const t=[];let s=0,r=0;for(const i of e){const o=(i.high+i.low+i.close)/3,a=i.volume||1;s+=o*a,r+=a,t.push({time:i.time,value:r>0?s/r:o})}return t}const hr=120,st=500,gr=1;function ht(e){return e.map(t=>({time:t.time,value:t.value}))}function yr(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function br(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function vn(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function Ze(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function vr(e){if(!e?.length)return[];const t=[];for(const r of e){const i=ze(r.timestamp)??ze(r.time)??ze(r.datetime)??ze(r.date),o=Ze(r.open),a=Ze(r.high),l=Ze(r.low),c=Ze(r.close),m=Ze(r.volume)??0;i==null||o==null||a==null||l==null||c==null||Ut(i,{includeClose:!0})&&t.push({time:i,open:o,high:a,low:l,close:c,volume:m})}t.sort((r,i)=>Number(r.time)-Number(i.time));const s=new Map;for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).slice(-st)}function Qe(e){return e.map(t=>({...t}))}function Sr(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-st)}function Sn(e){return e.map(t=>({time:t.time,open:t.open,high:t.high,low:t.low,close:t.close}))}function jr({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}){const i=d.useRef(null),o=d.useRef(null),a=d.useRef(null),l=d.useRef(null),c=d.useRef(null),m=d.useRef(null),p=d.useRef(null),u=d.useRef([]),y=d.useRef(new Map),v=d.useRef(null),h=d.useRef(0),P=d.useRef(null),g=d.useRef({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}),C=le($=>$.apiKey),T=le($=>$.setApiKey),k=$n($=>$.mode==="dark"),M=j($=>$.underlying),V=j($=>$.indexExchange),F=j($=>$.chartInterval),S=d.useCallback(()=>{const $=u.current,G=g.current,N=$.map(D=>({time:D.time,value:D.close}));l.current&&l.current.setData(G.showEma9?ht(Pt(N,9)):[]),c.current&&c.current.setData(G.showEma21?ht(Pt(N,21)):[]),m.current&&m.current.setData(G.showSupertrend?ht(os($,10,3).trend):[]),p.current&&p.current.setData(G.showVwap?ht(ls($)):[])},[]),x=d.useCallback(()=>{P.current===null&&(P.current=setTimeout(()=>{P.current=null,S()},hr))},[S]),E=d.useCallback(()=>{u.current=[],a.current?.setData([]),l.current?.setData([]),c.current?.setData([]),m.current?.setData([]),p.current?.setData([])},[]),R=d.useCallback($=>{const G=$.slice(-st);u.current=Qe(G),a.current?.setData(Sn(G)),x()},[x]),z=d.useCallback(async()=>{if(C)return C;try{const G=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(G.status==="success"&&G.api_key)return T(G.api_key),G.api_key}catch{}return null},[C,T]),I=d.useCallback(($,G)=>{if(!a.current)return;const N=Number($.time),D=u.current.length?Number(u.current[u.current.length-1].time):null;if(D!=null&&Number.isFinite(D)&&Number.isFinite(N)&&N<D)return;try{a.current.update({time:$.time,open:$.open,high:$.high,low:$.low,close:$.close})}catch{return}G?(u.current.push($),u.current.length>st&&(u.current=u.current.slice(-st))):u.current.length>0?u.current[u.current.length-1]=$:u.current.push($);const B=v.current;B&&y.current.set(B,Qe(u.current)),x()},[x]),{isConnected:f,reset:L,seed:q}=as({symbol:M,exchange:V,intervalSec:F,enabled:!!M,useIndiaMarketHours:!0,onCandleUpdate:I});return d.useEffect(()=>{const $=v.current;if($&&u.current.length>0&&y.current.set($,Qe(u.current)),!M){v.current=null,L(),E();return}const G=`${V}:${M}:${F}`;v.current=G;const N=y.current.get(G);if(N&&N.length>0){L(),q(N),R(N);return}L(),E();const D=++h.current,B=br(F),O=new Date,A=new Date(O.getTime());A.setDate(A.getDate()-gr),(async()=>{const Z=await z();if(!Z){D===h.current&&E();return}try{const ce=await oe.getHistory(Z,M,V,B,vn(A),vn(O));if(D!==h.current)return;const de=ce.status==="success"?vr(ce.data):[],fe=v.current===G?Qe(u.current):[],b=Sr(de,fe);if(b.length>0){y.current.set(G,Qe(b)),q(b),R(b);return}}catch{}D===h.current&&E()})()},[M,V,F,z,L,q,E,R]),d.useEffect(()=>{g.current={showEma9:e,showEma21:t,showSupertrend:s,showVwap:r},l.current?.applyOptions({visible:e}),c.current?.applyOptions({visible:t}),m.current?.applyOptions({visible:s}),p.current?.applyOptions({visible:r}),x()},[e,t,s,r,x]),d.useEffect(()=>{const $=i.current;if(!$)return;const G=yr(k),N=In($,{width:$.offsetWidth,height:$.offsetHeight,layout:{background:{type:An.Solid,color:G.bg},textColor:G.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:G.grid},horzLines:{color:G.grid}},rightPriceScale:{borderColor:G.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:G.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:ce=>is(ce)},crosshair:{mode:On.Normal,vertLine:{width:1,color:G.crosshair,style:2},horzLine:{width:1,color:G.crosshair,style:2}}}),D=N.addSeries(Fn,{upColor:G.upColor,downColor:G.downColor,borderVisible:!1,wickUpColor:G.upColor,wickDownColor:G.downColor}),B=N.addSeries(Re,{color:G.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:g.current.showEma9}),O=N.addSeries(Re,{color:G.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:g.current.showEma21}),A=N.addSeries(Re,{color:G.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:g.current.showSupertrend}),K=N.addSeries(Re,{color:G.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:g.current.showVwap});o.current=N,a.current=D,l.current=B,c.current=O,m.current=A,p.current=K,u.current.length>0&&(D.setData(Sn(u.current)),x());const Z=new ResizeObserver(()=>{if(o.current&&$){const ce=$.offsetWidth,de=$.offsetHeight;ce>0&&de>0&&o.current.applyOptions({width:ce,height:de})}});return Z.observe($),()=>{P.current!==null&&(clearTimeout(P.current),P.current=null),Z.disconnect(),N.remove(),o.current=null,a.current=null,l.current=null,c.current=null,m.current=null,p.current=null}},[k,x]),n.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[n.jsx("div",{ref:i,className:"h-full w-full"}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:"text-xs font-bold text-foreground/80",children:M}),!f&&n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),n.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),s&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const Y=_t()(Vt((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:s=>e(r=>({virtualTPSL:{...r.virtualTPSL,[s.id]:s}})),removeVirtualTPSL:s=>e(r=>{const{[s]:i,...o}=r.virtualTPSL;return{virtualTPSL:o}}),updateVirtualTPSL:(s,r)=>e(i=>{const o=i.virtualTPSL[s];return o?{virtualTPSL:{...i.virtualTPSL,[s]:{...o,...r}}}:i}),getTPSLForSymbol:s=>Object.values(t().virtualTPSL).find(i=>i.symbol===s),addTriggerOrder:s=>e(r=>({triggerOrders:{...r.triggerOrders,[s.id]:s}})),removeTriggerOrder:s=>e(r=>{const{[s]:i,...o}=r.triggerOrders;return{triggerOrders:o}}),updateTriggerOrder:(s,r)=>e(i=>{const o=i.triggerOrders[s];return o?{triggerOrders:{...i.triggerOrders,[s]:{...o,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:s=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,a])=>a.symbol!==s)),o=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,a])=>a.symbol!==s));return{virtualTPSL:i,triggerOrders:o}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),jn=.05;function ge(e){return Math.round(e/jn)*jn}function Ke(e){return Number(Math.max(0,e).toFixed(2))}function Nr(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?ge(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?ge(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function Pr({chartRef:e,seriesRef:t,side:s,containerRef:r}){const i=j(w=>w.activeSide),o=j(w=>w.orderType),a=j(w=>w.tpPoints),l=j(w=>w.slPoints),c=j(w=>w.limitPrice),m=j(w=>w.pendingEntryAction),p=j(w=>w.quantity),u=j(w=>w.lotSize),y=j(w=>w.optionExchange),v=j(w=>w.product),h=j(w=>w.paperMode),P=j(w=>w.setLimitPrice),g=j(w=>w.setTpPoints),C=j(w=>w.setSlPoints),T=j(w=>w.setPendingEntryAction),k=j(w=>s==="CE"?w.selectedCESymbol:w.selectedPESymbol),M=Y(w=>w.virtualTPSL),V=Y(w=>w.triggerOrders),F=Y(w=>w.addTriggerOrder),S=Y(w=>w.updateTriggerOrder),x=Y(w=>w.removeTriggerOrder),E=Y(w=>w.updateVirtualTPSL),R=Y(w=>w.removeVirtualTPSL),z=d.useRef(null),I=d.useRef(null),f=d.useRef(null),L=d.useRef(null),[q,$]=d.useState(null),[G,N]=d.useState(null),[D,B]=d.useState(null),[O,A]=d.useState(null),[K,Z]=d.useState(!1),ce=d.useRef(null),de=i===s,fe=o==="LIMIT"||o==="TRIGGER",b=d.useMemo(()=>k?Object.values(M).find(w=>w.symbol===k):void 0,[k,M]),_=d.useMemo(()=>k?Object.values(V).find(w=>w.symbol===k):void 0,[k,V]),Q=b?"position":_?"trigger":de&&fe&&c!=null?"pending":null,se=m??"BUY";d.useEffect(()=>{if(!b){A(null);return}const w=rt.getInstance(),U=w.getCachedData(b.symbol,b.exchange)?.data?.ltp;U&&U>0&&A(U);const J=w.subscribe(b.symbol,b.exchange,"LTP",me=>{const ae=me.data.ltp;ae&&ae>0&&A(ae)});return()=>J()},[b]);const re=d.useMemo(()=>{if(!b||!O||O<=0)return null;const w=b.action==="BUY"?O-b.entryPrice:b.entryPrice-O,U=w*b.quantity;return{ltp:O,points:w,pnl:U}},[b,O]),ie=d.useMemo(()=>{if(!b)return"";const w=`${b.action} @ ${b.entryPrice.toFixed(2)}`;if(!re)return w;const U=re.pnl>=0?"+":"";return`${w} | PnL ${U}${re.pnl.toFixed(2)}`},[b,re]),W=d.useCallback(w=>{if(w.current&&t.current){try{t.current.removePriceLine(w.current)}catch{}w.current=null}},[t]),he=d.useCallback((w,U,J,me,ae,ee)=>{t.current&&(w.current?w.current.applyOptions({price:U,color:J,lineStyle:me,lineWidth:ae,title:ee,axisLabelVisible:!0}):w.current=t.current.createPriceLine({price:U,color:J,lineStyle:me,lineWidth:ae,title:ee,axisLabelVisible:!0}))},[t]),Te=d.useCallback(w=>{if(!t.current)return null;const U=t.current.priceToCoordinate(w);return U??null},[t]),ye=d.useCallback(()=>{const w=(U,J)=>{if(!U.current){J(null);return}const me=U.current.options().price,ae=Te(me);if(ae==null){J(null);return}J({y:ae,price:me})};w(I,$),w(f,N),w(L,B)},[Te]),lt=d.useCallback(w=>{if(!k)return"above";const J=rt.getInstance().getCachedData(k,y)?.data?.ltp;return!J||J<=0||w>=J?"above":"below"},[k,y]);d.useEffect(()=>{const w=e.current,U=t.current;if(!w||!U)return;if(!(de&&fe&&!b&&!_&&c==null)){W(z);return}const me=ae=>{if(!ae.point){W(z);return}const ee=U.coordinateToPrice(ae.point.y);if(ee==null){W(z);return}const ue=ge(ee);he(z,ue,"#a1a1aa",ke.Dashed,1,ue.toFixed(2))};return w.subscribeCrosshairMove(me),()=>{w.unsubscribeCrosshairMove(me),W(z)}},[e,t,de,fe,b,_,c,W,he]),d.useEffect(()=>{const w=e.current,U=t.current;if(!w||!U||!k||!de||!fe)return;const J=me=>{if(!me.point)return;const ae=U.coordinateToPrice(me.point.y);if(ae==null)return;const ee=ge(ae);if(o==="TRIGGER"){const ue=m??_?.action;if(!ue){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const pe=lt(ee);_?S(_.id,{triggerPrice:ee,action:ue,direction:pe,quantity:p*u,tpPoints:a,slPoints:l}):F({id:`trigger-${Date.now()}`,symbol:k,exchange:y,side:s,action:ue,triggerPrice:ee,direction:pe,quantity:p*u,tpPoints:a,slPoints:l,createdAt:Date.now()}),P(ee),T(null)}else{if(!m&&c==null){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}P(ee),m||T("BUY")}W(z),ye()};return w.subscribeClick(J),()=>{w.unsubscribeClick(J)}},[e,t,k,de,fe,o,m,c,_,p,u,a,l,y,s,F,S,P,T,lt,W,ye]),d.useEffect(()=>{if(!t.current)return;const w=()=>{W(I),W(f),W(L),$(null),N(null),B(null)};if(b){const U=b.action==="BUY"?"#00ff88":"#ff4560";he(I,ge(b.entryPrice),U,ke.Dotted,2,`${b.action} @ ${b.entryPrice.toFixed(2)}`),b.tpPrice!=null?he(f,ge(b.tpPrice),"#00ff88",ke.Dashed,1,`TP @ ${b.tpPrice.toFixed(2)}`):W(f),b.slPrice!=null?he(L,ge(b.slPrice),"#ff4560",ke.Dashed,1,`SL @ ${b.slPrice.toFixed(2)}`):W(L),ye();return}if(_){const{tpPrice:U,slPrice:J}=Nr(_),me=ge(_.triggerPrice);he(I,me,"#ffa500",ke.Dashed,2,`TRIGGER ${_.action} @ ${me.toFixed(2)}`),U!=null?he(f,U,"#00ff88",ke.Dashed,1,`TP @ ${U.toFixed(2)}`):W(f),J!=null?he(L,J,"#ff4560",ke.Dashed,1,`SL @ ${J.toFixed(2)}`):W(L),ye();return}if(de&&fe&&c!=null){const U=se,J=ge(c);if(he(I,J,o==="LIMIT"?"#06b6d4":"#ffa500",ke.Dashed,2,`${o} ${U} @ ${J.toFixed(2)}`),a>0){const ae=ge(J+(U==="BUY"?a:-a));he(f,ae,"#00ff88",ke.Dashed,1,`TP @ ${ae.toFixed(2)}`)}else W(f);if(l>0){const ae=ge(J+(U==="BUY"?-l:l));he(L,ae,"#ff4560",ke.Dashed,1,`SL @ ${ae.toFixed(2)}`)}else W(L);ye();return}w()},[t,b,_,de,fe,c,se,o,a,l,W,he,ye]),d.useEffect(()=>{!b||!I.current||I.current.applyOptions({title:ie})},[b,ie]),d.useEffect(()=>{const w=e.current;if(!w)return;const U=()=>ye();w.subscribeCrosshairMove(U);const J=w.timeScale();return J.subscribeVisibleLogicalRangeChange(U),()=>{w.unsubscribeCrosshairMove(U),J.unsubscribeVisibleLogicalRangeChange(U)}},[e,ye]),d.useEffect(()=>()=>{W(z),W(I),W(f),W(L),$(null),N(null),B(null)},[k,W]),d.useEffect(()=>{o==="MARKET"&&(b||_||(W(z),W(I),W(f),W(L),$(null),N(null),B(null),P(null),T(null)))},[o,b,_,W,P,T]);const Ct=d.useCallback((w,U)=>{if(U.preventDefault(),U.stopPropagation(),!Q||!(w==="entry"?I:w==="tp"?f:L).current)return;ce.current={type:w,source:Q};const me=ee=>{const ue=ce.current,pe=t.current,Me=r.current;if(!ue||!pe||!Me)return;const gs=Me.getBoundingClientRect(),ys=ee.clientY-gs.top,Jt=pe.coordinateToPrice(ys);if(Jt==null)return;const Le=ge(Jt),Tt=ue.type==="entry"?I:ue.type==="tp"?f:L;if(!Tt.current)return;let Oe="";if(ue.type==="entry"?ue.source==="trigger"?Oe=`TRIGGER ${_?.action??"BUY"} @ ${Le.toFixed(2)}`:ue.source==="pending"?Oe=`${o} ${se} @ ${Le.toFixed(2)}`:ue.source==="position"?Oe=`${b?.action??se} @ ${Le.toFixed(2)}`:Oe=Tt.current.options().title??Le.toFixed(2):ue.type==="tp"?Oe=`TP @ ${Le.toFixed(2)}`:Oe=`SL @ ${Le.toFixed(2)}`,Tt.current.applyOptions({price:Le,title:Oe}),ue.type==="entry"){const ct=ue.source==="trigger"?_?.action??se:ue.source==="position"?b?.action??se:se,wt=ue.source==="trigger"?_?.tpPoints??0:ue.source==="position"?b?.tpPoints??0:a,Et=ue.source==="trigger"?_?.slPoints??0:ue.source==="position"?b?.slPoints??0:l;if(wt>0&&f.current){const Xe=ge(Le+(ct==="BUY"?wt:-wt));f.current.applyOptions({price:Xe,title:`TP @ ${Xe.toFixed(2)}`})}if(Et>0&&L.current){const Xe=ge(Le+(ct==="BUY"?-Et:Et));L.current.applyOptions({price:Xe,title:`SL @ ${Xe.toFixed(2)}`})}}ye()},ae=()=>{const ee=ce.current;if(!ee)return;const pe=(ee.type==="entry"?I:ee.type==="tp"?f:L).current?.options().price;if(pe!=null){if(ee.source==="position"&&b){const Me=ee.type==="entry"?{entryPrice:pe,tpPrice:b.tpPrice!=null?ge(b.tpPrice+(pe-b.entryPrice)):null,slPrice:b.slPrice!=null?ge(b.slPrice+(pe-b.entryPrice)):null}:ee.type==="tp"?{tpPrice:pe,tpPoints:Ke(Math.abs(pe-b.entryPrice))}:ee.type==="sl"?{slPrice:pe,slPoints:Ke(Math.abs(b.entryPrice-pe))}:null;Me&&E(b.id,Me)}if(ee.source==="trigger"&&_&&(ee.type==="entry"&&(S(_.id,{triggerPrice:pe,direction:lt(pe)}),P(pe)),ee.type==="tp"&&S(_.id,{tpPoints:Ke(Math.abs(pe-_.triggerPrice))}),ee.type==="sl"&&S(_.id,{slPoints:Ke(Math.abs(_.triggerPrice-pe))})),ee.source==="pending"){const Me=I.current?.options().price??c??pe;ee.type==="entry"&&P(pe),ee.type==="tp"&&g(Ke(Math.abs(pe-Me))),ee.type==="sl"&&C(Ke(Math.abs(Me-pe)))}}ye(),ce.current=null,document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",ae)};document.addEventListener("mousemove",me),document.addEventListener("mouseup",ae)},[Q,t,r,b,_,se,o,c,a,l,E,S,lt,ye,P,g,C]),ps=d.useCallback(()=>{W(I),W(f),W(L),$(null),N(null),B(null),b&&R(b.id),_&&x(_.id),P(null),T(null)},[b,_,W,R,x,P,T]),Xt=d.useCallback(w=>{if(W(w==="tp"?f:L),w==="tp"?N(null):B(null),b){E(b.id,w==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(_){S(_.id,w==="tp"?{tpPoints:0}:{slPoints:0});return}w==="tp"?g(0):C(0)},[b,_,W,g,C,E,S]),fs=d.useCallback(async()=>{if(!(!b||K)){Z(!0);try{if(h)console.log(`[Paper] Close ${b.action} ${b.symbol}`);else{const w=await oe.closePosition(b.symbol,b.exchange,v);if(w.status!=="success"){console.error("[Scalping] Close position rejected:",w);return}}R(b.id),W(I),W(f),W(L),$(null),N(null),B(null)}catch(w){console.error("[Scalping] Close position failed:",w)}finally{Z(!1)}}},[b,K,h,v,R,W]);if(!r.current)return null;const Ye=!!b,Zt=Ye?b.action==="BUY"?"green":"red":o==="LIMIT"?"cyan":"orange",ms=Ye?`${b.action} @ ${q?.price.toFixed(2)??"--"}`:_?`TRIGGER ${_.action} @ ${q?.price.toFixed(2)??"--"}`:`${o} ${se} @ ${q?.price.toFixed(2)??"--"}`,xs={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[Zt],hs={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[Zt],Qt=Q!==null;return n.jsxs(n.Fragment,{children:[q&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:q.y},children:[n.jsx("div",{className:Se("absolute left-0 right-0 top-0 h-px -translate-y-1/2",hs)}),n.jsx("div",{className:Se("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",Qt?"cursor-ns-resize":"cursor-default"),onMouseDown:Qt?w=>Ct("entry",w):void 0}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsx("span",{className:Se("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",xs),children:ms}),Ye&&re&&n.jsxs("span",{className:Se("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",re.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",re.ltp.toFixed(2)," | PnL ",re.pnl>=0?"+":"",re.pnl.toFixed(2)]}),Ye&&n.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:w=>{w.stopPropagation(),fs()},disabled:K,title:"Close position at market",children:K?"...":"Close"}),n.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-foreground/60 hover:text-foreground hover:bg-muted/50",onClick:w=>{w.stopPropagation(),ps()},title:Ye?"Remove virtual position tracking":"Cancel pending order",children:"x"})]})]}),G&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:G.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:w=>Ct("tp",w)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",G.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-green-400/60 hover:text-green-400 hover:bg-muted/50",onClick:w=>{w.stopPropagation(),Xt("tp")},title:"Remove TP line",children:"x"})]})]}),D&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:D.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:w=>Ct("sl",w)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",D.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-red-400/60 hover:text-red-400 hover:bg-muted/50",onClick:w=>{w.stopPropagation(),Xt("sl")},title:"Remove SL line",children:"x"})]})]})]})}const Cr=120,Tr=1;function gt(e){return e.map(t=>({time:t.time,value:t.value}))}function wr(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Er(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Nn(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function Je(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function kr(e){if(!e?.length)return[];const t=[];for(const r of e){const i=ze(r.timestamp)??ze(r.time)??ze(r.datetime)??ze(r.date),o=Je(r.open),a=Je(r.high),l=Je(r.low),c=Je(r.close),m=Je(r.volume)??0;i==null||o==null||a==null||l==null||c==null||Ut(i,{includeClose:!0})&&t.push({time:i,open:o,high:a,low:l,close:c,volume:m})}t.sort((r,i)=>Number(r.time)-Number(i.time));const s=new Map;for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).slice(-500)}function et(e){return e.map(t=>({...t}))}function Lr(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function Pn(e){return e.map(t=>({time:t.time,open:t.open,high:t.high,low:t.low,close:t.close}))}function Cn({side:e,showEma9:t,showEma21:s,showSupertrend:r,showVwap:i}){const o=d.useRef(null),a=d.useRef(null),l=d.useRef(null),c=d.useRef(null),m=d.useRef(null),p=d.useRef(null),u=d.useRef(null),y=d.useRef([]),v=d.useRef(new Map),h=d.useRef(null),P=d.useRef(0),g=d.useRef(null),C=d.useRef({showEma9:t,showEma21:s,showSupertrend:r,showVwap:i}),T=le(O=>O.apiKey),k=le(O=>O.setApiKey),M=$n(O=>O.mode==="dark"),V=j(O=>O.activeSide),F=j(O=>O.setActiveSide),S=j(O=>O.optionExchange),x=j(O=>O.chartInterval),E=j(O=>e==="CE"?O.selectedCESymbol:O.selectedPESymbol),R=V===e,z=d.useCallback(()=>{const O=y.current,A=C.current,K=O.map(Z=>({time:Z.time,value:Z.close}));c.current&&c.current.setData(A.showEma9?gt(Pt(K,9)):[]),m.current&&m.current.setData(A.showEma21?gt(Pt(K,21)):[]),p.current&&p.current.setData(A.showSupertrend?gt(os(O,10,3).trend):[]),u.current&&u.current.setData(A.showVwap?gt(ls(O)):[])},[]),I=d.useCallback(()=>{g.current===null&&(g.current=setTimeout(()=>{g.current=null,z()},Cr))},[z]),f=d.useCallback(()=>{y.current=[],l.current?.setData([]),c.current?.setData([]),m.current?.setData([]),p.current?.setData([]),u.current?.setData([])},[]),L=d.useCallback(O=>{const A=O.slice(-500);y.current=et(A),l.current?.setData(Pn(A)),I()},[I]),q=d.useCallback(async()=>{if(T)return T;try{const A=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(A.status==="success"&&A.api_key)return k(A.api_key),A.api_key}catch{}return null},[T,k]),$=d.useCallback(()=>{F(e)},[e,F]),G=d.useCallback((O,A)=>{if(!l.current)return;const K=Number(O.time),Z=y.current.length?Number(y.current[y.current.length-1].time):null;if(Z!=null&&Number.isFinite(Z)&&Number.isFinite(K)&&K<Z)return;try{l.current.update({time:O.time,open:O.open,high:O.high,low:O.low,close:O.close})}catch{return}A?(y.current.push(O),y.current.length>500&&(y.current=y.current.slice(-500))):y.current.length>0?y.current[y.current.length-1]=O:y.current.push(O);const ce=h.current;ce&&v.current.set(ce,et(y.current)),I()},[I]),{isConnected:N,reset:D,seed:B}=as({symbol:E??"",exchange:S,intervalSec:x,enabled:!!E,useIndiaMarketHours:!0,onCandleUpdate:G});return d.useEffect(()=>{const O=h.current;if(O&&y.current.length>0&&v.current.set(O,et(y.current)),!E){h.current=null,D(),f();return}const A=`${S}:${E}:${x}`;h.current=A;const K=v.current.get(A);if(K&&K.length>0){D(),B(K),L(K);return}D(),f();const Z=++P.current,ce=Er(x),de=new Date,fe=new Date(de.getTime());fe.setDate(fe.getDate()-Tr),(async()=>{const _=await q();if(!_){Z===P.current&&f();return}try{const Q=await oe.getHistory(_,E,S,ce,Nn(fe),Nn(de));if(Z!==P.current)return;const se=Q.status==="success"?kr(Q.data):[],re=h.current===A?et(y.current):[],ie=Lr(se,re);if(ie.length>0){v.current.set(A,et(ie)),B(ie),L(ie);return}}catch{}Z===P.current&&f()})()},[E,S,x,q,D,B,f,L]),d.useEffect(()=>{C.current={showEma9:t,showEma21:s,showSupertrend:r,showVwap:i},c.current?.applyOptions({visible:t}),m.current?.applyOptions({visible:s}),p.current?.applyOptions({visible:r}),u.current?.applyOptions({visible:i}),I()},[t,s,r,i,I]),d.useEffect(()=>{const O=o.current;if(!O)return;const A=wr(M),K=In(O,{width:O.offsetWidth,height:O.offsetHeight,layout:{background:{type:An.Solid,color:A.bg},textColor:A.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:A.grid},horzLines:{color:A.grid}},rightPriceScale:{borderColor:A.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:A.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:Q=>is(Q)},crosshair:{mode:On.Normal,vertLine:{width:1,color:A.crosshair,style:2},horzLine:{width:1,color:A.crosshair,style:2}}}),Z=K.addSeries(Fn,{upColor:A.upColor,downColor:A.downColor,borderVisible:!1,wickUpColor:A.upColor,wickDownColor:A.downColor}),ce=K.addSeries(Re,{color:A.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:C.current.showEma9}),de=K.addSeries(Re,{color:A.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:C.current.showEma21}),fe=K.addSeries(Re,{color:A.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:C.current.showSupertrend}),b=K.addSeries(Re,{color:A.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:C.current.showVwap});a.current=K,l.current=Z,c.current=ce,m.current=de,p.current=fe,u.current=b,y.current.length>0&&(Z.setData(Pn(y.current)),I());const _=new ResizeObserver(()=>{if(a.current&&O){const Q=O.offsetWidth,se=O.offsetHeight;Q>0&&se>0&&a.current.applyOptions({width:Q,height:se})}});return _.observe(O),()=>{g.current!==null&&(clearTimeout(g.current),g.current=null),_.disconnect(),K.remove(),a.current=null,l.current=null,c.current=null,m.current=null,p.current=null,u.current=null}},[M,I]),n.jsxs("div",{className:Se("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",R&&"ring-1 ring-primary/40"),onClick:$,children:[n.jsx("div",{ref:o,className:"h-full w-full"}),n.jsx(Pr,{chartRef:a,seriesRef:l,side:e,containerRef:o}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:Se("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),E&&n.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:E}),!E&&n.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),n.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),s&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),R&&n.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),E&&!N&&n.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!E&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}const Tn=.05;function St(e){return Math.round(e/Tn)*Tn}function yt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:St(e)}async function He({symbol:e,exchange:t,preferredPrice:s=null,fallbackPrice:r=null,apiKey:i=null}){const o=yt(s);if(o!=null)return o;const a=rt.getInstance(),l=yt(a.getCachedData(e,t)?.data?.ltp);if(l!=null)return l;const c=yt(r);if(c!=null)return c;if(i)try{const m=await oe.getQuotes(i,e,t),p=yt(m.data?.ltp);if(p!=null)return p}catch{}return 0}function Ge({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:s,side:r,action:i,entryPrice:o,quantity:a,tpPoints:l,slPoints:c,createdAt:m=Date.now()}){const p=St(o),u=Number(Math.max(0,l||0).toFixed(2)),y=Number(Math.max(0,c||0).toFixed(2)),v=i==="BUY";return{id:e,symbol:t,exchange:s,side:r,action:i,entryPrice:p,quantity:a,tpPrice:u>0?St(p+(v?u:-u)):null,slPrice:y>0?St(p+(v?-y:y)):null,tpPoints:u,slPoints:y,createdAt:m}}function Mr(){const e=le(b=>b.apiKey),t=le(b=>b.setApiKey),s=j(b=>b.showFloatingWidget),r=j(b=>b.activeSide),i=j(b=>b.selectedCESymbol),o=j(b=>b.selectedPESymbol),a=j(b=>b.optionExchange),l=j(b=>b.quantity),c=j(b=>b.lotSize),m=j(b=>b.product),p=j(b=>b.tpPoints),u=j(b=>b.slPoints),y=j(b=>b.orderType),v=j(b=>b.limitPrice),h=j(b=>b.setLimitPrice),P=j(b=>b.setPendingEntryAction),g=j(b=>b.paperMode),C=Y(b=>b.setVirtualTPSL),T=Y(b=>b.getTPSLForSymbol),k=Y(b=>b.removeVirtualTPSL),M=Y(b=>b.triggerOrders),V=Y(b=>b.removeTriggerOrder),F=j(b=>b.ceWidgetPos),S=j(b=>b.setCeWidgetPos),x=j(b=>b.incrementQuantity),E=j(b=>b.decrementQuantity),R=j(b=>b.setTpPoints),z=j(b=>b.setSlPoints),I=j(b=>b.incrementTradeCount),f=r==="CE"?i:o,[L,q]=d.useState(!1),[$,G]=d.useState(null),[N,D]=d.useState(null),B=d.useRef(null),O=d.useRef(null);d.useEffect(()=>{if(!f){G(null),D(null);return}const _=rt.getInstance().subscribe(f,a,"LTP",Q=>{const se=Q.data.ltp;se!=null&&se>0&&(D($),G(se))});return()=>{_()}},[f,a]);const A=d.useCallback(b=>{if(b.target.closest("button, input"))return;b.preventDefault(),B.current={startX:b.clientX,startY:b.clientY,origX:F.x,origY:F.y};const _=se=>{if(!B.current)return;const re=se.clientX-B.current.startX,ie=se.clientY-B.current.startY;S({x:Math.max(0,B.current.origX+re),y:Math.max(0,B.current.origY+ie)})},Q=()=>{B.current=null,document.removeEventListener("mousemove",_),document.removeEventListener("mouseup",Q)};document.addEventListener("mousemove",_),document.addEventListener("mouseup",Q)},[F,S]),K=d.useCallback(async()=>{if(e)return e;try{const _=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(_.status==="success"&&_.api_key)return t(_.api_key),_.api_key}catch(b){console.error("[Scalping] Failed to fetch API key:",b)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),Z=d.useCallback(async b=>{if(!f||L){f||console.warn("[Scalping] No symbol selected  click a strike first");return}if(q(!0),y==="TRIGGER"){const re=Object.values(M).find(ie=>ie.symbol===f&&ie.exchange===a&&ie.side===r);re&&V(re.id),h(null),P(b),console.log(`[Scalping] TRIGGER armed (${b})  click chart to place trigger line`),q(!1);return}if(y==="LIMIT"&&!v){P(b),console.log(`[Scalping] LIMIT armed (${b})  click chart to set limit line`),q(!1);return}if(g){if(console.log(`[Paper] ${b} ${r} ${f} qty=${l*c} @ ${y}`),y==="MARKET"){const re=await He({symbol:f,exchange:a,preferredPrice:$});if(re>0){const ie=T(f);ie&&k(ie.id),C(Ge({symbol:f,exchange:a,side:r,action:b,entryPrice:re,quantity:l*c,tpPoints:p,slPoints:u}))}}I(),q(!1);return}const _=await K();if(!_){q(!1);return}const Q=y==="LIMIT"?"LIMIT":"MARKET",se={apikey:_,strategy:"Scalping",exchange:a,symbol:f,action:b,quantity:l*c,pricetype:Q,product:m,price:y==="LIMIT"&&v?v:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${b} ${f} qty=${l*c} ${Q}`);const re=await oe.placeOrder(se);if(re.status==="success"){if(console.log(`[Scalping] Order placed: ${b} ${f} id=${re.data?.orderid}`),P(null),I(),Q==="MARKET"){const ie=await He({symbol:f,exchange:a,preferredPrice:$,apiKey:_});if(ie>0){const W=T(f);W&&k(W.id),C(Ge({symbol:f,exchange:a,side:r,action:b,entryPrice:ie,quantity:l*c,tpPoints:p,slPoints:u}))}}}else console.error("[Scalping] Order rejected:",re)}catch(re){console.error("[Scalping] Order failed:",re)}q(!1)},[f,r,l,c,a,m,y,v,p,u,g,T,k,M,L,$,K,I,C,V,h,P]),ce=d.useCallback(async()=>{if(!f||L)return;if(q(!0),g){console.log(`[Paper] Reversal ${r} ${f}`),I(),q(!1);return}const b=await K();if(!b){q(!1);return}try{const _={apikey:b,strategy:"Scalping",exchange:a,symbol:f,action:"SELL",quantity:l*c,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await oe.placeOrder(_);const Q={apikey:b,strategy:"Scalping",exchange:a,symbol:f,action:"SELL",quantity:l*c,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await oe.placeOrder(Q),console.log(`[Scalping] Reversed ${r} ${f}`),I()}catch(_){console.error("[Scalping] Reversal failed:",_)}q(!1)},[f,r,l,c,a,m,g,L,K,I]),de=d.useCallback(async()=>{if(!f)return;if(g){console.log(`[Paper] Close ${r} ${f}`);return}const b=await K();if(b)try{const _={apikey:b,strategy:"Scalping",exchange:a,symbol:f,action:"SELL",quantity:l*c,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0},Q=await oe.placeOrder(_);Q.status==="success"?console.log(`[Scalping] Closed ${r} ${f} id=${Q.data?.orderid}`):console.error("[Scalping] Close rejected:",Q)}catch(_){console.error("[Scalping] Close failed:",_)}},[f,r,l,c,a,m,g,K]);if(!s||!f)return null;const fe=$&&N?$>N?"up":$<N?"down":"flat":"flat";return n.jsxs("div",{ref:O,onMouseDown:A,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:F.x,top:F.y,minWidth:220},children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[n.jsx("span",{className:`text-xs font-bold ${r==="CE"?"text-green-500":"text-red-500"}`,children:r}),n.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:f.slice(-10)}),n.jsx("span",{className:`text-sm font-bold tabular-nums ${fe==="up"?"text-green-500":fe==="down"?"text-red-500":"text-foreground"}`,children:$?.toFixed(2)??"--"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[n.jsx(te,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>Z("BUY"),disabled:L,children:"BUY"}),n.jsx(te,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>Z("SELL"),disabled:L,children:"SELL"}),n.jsx(te,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:ce,disabled:L,children:"REV"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:E,children:"-"}),n.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:l}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:x,children:"+"}),n.jsx("div",{className:"flex-1"}),n.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),n.jsx("input",{type:"number",value:p,onChange:b=>R(Number.parseFloat(b.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),n.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),n.jsx("input",{type:"number",value:u,onChange:b=>z(Number.parseFloat(b.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),n.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:de,children:"x Close"})})]})}const Rr=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function $r({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r,onToggleEma9:i,onToggleEma21:o,onToggleSupertrend:a,onToggleVwap:l}){const c=j(p=>p.chartInterval),m=j(p=>p.setChartInterval);return n.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Rr.map(p=>n.jsx(te,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${c===p.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>m(p.sec),children:p.label},p.sec)),n.jsx(zr,{intervalSec:c}),n.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),n.jsx(bt,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),n.jsx(bt,{label:"EMA21",active:t,color:"text-violet-500",onClick:o}),n.jsx(bt,{label:"ST",active:s,color:"text-cyan-500",onClick:a}),n.jsx(bt,{label:"VWAP",active:r,color:"text-pink-500",onClick:l})]})}function zr({intervalSec:e}){const[t,s]=d.useState(()=>It(e));d.useEffect(()=>{s(It(e));const i=setInterval(()=>{s(It(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return n.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:Ir(t,e)})}function It(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function Ir(e,t){if(t>=3600){const s=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${s}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const s=Math.floor(e/60),r=e%60;return`${s}:${r.toString().padStart(2,"0")}`}return`${e}s`}function bt({label:e,active:t,color:s,onClick:r}){return n.jsx(te,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?s:"text-muted-foreground/50"}`,onClick:r,children:e})}function Or(){const[e,t]=d.useState(!0),[s,r]=d.useState(!0),[i,o]=d.useState(!0),[a,l]=d.useState(!0),c=d.useCallback(()=>t(y=>!y),[]),m=d.useCallback(()=>r(y=>!y),[]),p=d.useCallback(()=>o(y=>!y),[]),u=d.useCallback(()=>l(y=>!y),[]);return n.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[n.jsx($r,{showEma9:e,showEma21:s,showSupertrend:i,showVwap:a,onToggleEma9:c,onToggleEma21:m,onToggleSupertrend:p,onToggleVwap:u}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:n.jsxs(At,{orientation:"vertical",children:[n.jsx(Fe,{defaultSize:40,minSize:18,children:n.jsx(jr,{showEma9:e,showEma21:s,showSupertrend:i,showVwap:a})}),n.jsx(jt,{withHandle:!0}),n.jsx(Fe,{defaultSize:60,minSize:24,children:n.jsxs("div",{className:"relative h-full w-full",children:[n.jsxs(At,{orientation:"horizontal",children:[n.jsx(Fe,{defaultSize:50,minSize:20,children:n.jsx(Cn,{side:"CE",showEma9:e,showEma21:s,showSupertrend:i,showVwap:a})}),n.jsx(jt,{withHandle:!0}),n.jsx(Fe,{defaultSize:50,minSize:20,children:n.jsx(Cn,{side:"PE",showEma9:e,showEma21:s,showSupertrend:i,showVwap:a})})]}),n.jsx(Mr,{})]})})]})})]})}function Ar(){const e=le(N=>N.apiKey),t=le(N=>N.setApiKey),s=j(N=>N.activeSide),r=j(N=>N.selectedCESymbol),i=j(N=>N.selectedPESymbol),o=j(N=>N.optionExchange),a=j(N=>N.quantity),l=j(N=>N.lotSize),c=j(N=>N.product),m=j(N=>N.orderType),p=j(N=>N.tpPoints),u=j(N=>N.slPoints),y=j(N=>N.limitPrice),v=j(N=>N.setLimitPrice),h=j(N=>N.setPendingEntryAction),P=j(N=>N.paperMode),g=Y(N=>N.setVirtualTPSL),C=Y(N=>N.getTPSLForSymbol),T=Y(N=>N.removeVirtualTPSL),k=Y(N=>N.triggerOrders),M=Y(N=>N.removeTriggerOrder),V=j(N=>N.setQuantity),F=j(N=>N.incrementQuantity),S=j(N=>N.decrementQuantity),x=j(N=>N.setOrderType),E=j(N=>N.setProduct),R=j(N=>N.setTpPoints),z=j(N=>N.setSlPoints),I=j(N=>N.incrementTradeCount),f=s==="CE"?r:i,L=d.useCallback(async()=>{if(e)return e;try{const D=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(D.status==="success"&&D.api_key)return t(D.api_key),D.api_key}catch(N){console.error("[Scalping] Failed to fetch API key:",N)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),q=d.useCallback(async N=>{if(!f){console.warn("[Scalping] No symbol selected  click a strike first");return}if(m==="TRIGGER"){const A=Object.values(k).find(K=>K.symbol===f&&K.exchange===o&&K.side===s);A&&M(A.id),v(null),h(N),console.log(`[Scalping] TRIGGER armed (${N})  click chart to place trigger line`);return}if(m==="LIMIT"&&!y){h(N),console.log(`[Scalping] LIMIT armed (${N})  click chart to set limit line`);return}if(P){if(console.log(`[Paper] ${N} ${s} ${f} qty=${a*l} @ ${m}`),m==="MARKET"){const A=await He({symbol:f,exchange:o});if(A>0){const K=C(f);K&&T(K.id),g(Ge({symbol:f,exchange:o,side:s,action:N,entryPrice:A,quantity:a*l,tpPoints:p,slPoints:u}))}}I();return}const D=await L();if(!D)return;const B=m==="LIMIT"?"LIMIT":"MARKET",O={apikey:D,strategy:"Scalping",exchange:o,symbol:f,action:N,quantity:a*l,pricetype:B,product:c,price:m==="LIMIT"&&y?y:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${N} ${f} qty=${a*l} ${B}`);const A=await oe.placeOrder(O);if(A.status==="success"){if(console.log(`[Scalping] Order placed: ${N} ${f} id=${A.data?.orderid}`),h(null),I(),B==="MARKET"){const K=await He({symbol:f,exchange:o,apiKey:D});if(K>0){const Z=C(f);Z&&T(Z.id),g(Ge({symbol:f,exchange:o,side:s,action:N,entryPrice:K,quantity:a*l,tpPoints:p,slPoints:u}))}}}else console.error("[Scalping] Order rejected:",A)}catch(A){console.error("[Scalping] Order failed:",A)}},[f,s,a,l,o,c,m,y,p,u,P,C,T,k,L,I,g,M,v,h]),$=d.useCallback(async()=>{if(!f)return;if(P){console.log(`[Paper] Close ${s} ${f}`);return}const N=await L();if(N)try{const D={apikey:N,strategy:"Scalping",exchange:o,symbol:f,action:"SELL",quantity:a*l,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0},B=await oe.placeOrder(D);B.status==="success"?console.log(`[Scalping] Closed ${s} ${f} id=${B.data?.orderid}`):console.error("[Scalping] Close rejected:",B)}catch(D){console.error("[Scalping] Close failed:",D)}},[f,s,a,l,o,c,P,L]),G=d.useCallback(async()=>{if(P){console.log("[Paper] Close all positions");return}try{await oe.closeAllPositions(),console.log("[Scalping] Closed all positions")}catch(N){console.error("[Scalping] Close all failed:",N)}},[P]);return n.jsxs("div",{className:"p-3 space-y-4",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),n.jsxs("div",{className:"text-sm font-bold",children:[n.jsx("span",{className:s==="CE"?"text-green-500":"text-red-500",children:s})," ",n.jsx("span",{className:"text-foreground font-mono text-xs",children:f||"No strike selected"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx(te,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>q("BUY"),disabled:!f,children:"BUY"}),n.jsx(te,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>q("SELL"),disabled:!f,children:"SELL"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-xs",children:"Lots"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(te,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:S,children:"-"}),n.jsx($e,{type:"number",min:1,value:a,onChange:N=>V(Number.parseInt(N.target.value)||1),className:"h-7 text-center text-sm w-16"}),n.jsx(te,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:F,children:"+"}),n.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",a*l," qty"]})]})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-xs",children:"Order Type"}),n.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(N=>n.jsx(te,{variant:m===N?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>x(N),children:N},N))})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-xs",children:"Product"}),n.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(N=>n.jsx(te,{variant:c===N?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>E(N),children:N},N))})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-xs text-green-500",children:"TP Points"}),n.jsx($e,{type:"number",min:0,step:5,value:p,onChange:N=>R(Number.parseFloat(N.target.value)||0),className:"h-7 text-sm"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-xs text-red-500",children:"SL Points"}),n.jsx($e,{type:"number",min:0,step:5,value:u,onChange:N=>z(Number.parseFloat(N.target.value)||0),className:"h-7 text-sm"})]})]}),n.jsxs("div",{className:"border-t pt-3 space-y-2",children:[n.jsxs(te,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:$,disabled:!f,children:["Close ",s," Position"]}),n.jsx(te,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:G,children:"Close All Positions"})]})]})}const wn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},cs=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],H=_t()(Vt(e=>({config:{...wn},activePresetId:"balanced",enabled:!1,mode:"ghost",realizedPnl:0,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,updateConfig:t=>e(s=>({config:{...s.config,...t}})),applyPreset:t=>{const s=cs.find(r=>r.id===t);s&&e({config:{...wn,...s.config},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(s=>{const r=Date.now(),i=r-s.lastMinuteReset>6e4?r:s.lastMinuteReset,o=r-s.lastMinuteReset>6e4?1:s.tradesThisMinute+1;return{realizedPnl:s.realizedPnl+t,tradesCount:s.tradesCount+1,consecutiveLosses:t<0?s.consecutiveLosses+1:0,lastTradeTime:r,tradesThisMinute:o,lastMinuteReset:i,lastLossTime:t<0?r:s.lastLossTime}}),addGhostSignal:t=>e(s=>({ghostSignals:[...s.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({realizedPnl:0,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId})})),Fr=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Dr=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function Ft(e){const[t,s]=e.split(":").map(Number);return t*60+s}function Ht(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return{hours:s.getUTCHours(),minutes:s.getUTCMinutes()}}function ds(e){return e?Dr:Fr}function Dt(e=new Date,t=!1){const{hours:s,minutes:r}=Ht(e),i=s*60+r,o=ds(t);for(const a of o){const l=Ft(a.start),c=Ft(a.end);if(i>=l&&i<c)return{zone:a,sensitivity:a.sensitivity}}return{zone:null,sensitivity:0}}function En(e=new Date,t=!1){const{hours:s,minutes:r}=Ht(e),i=s*60+r,o=ds(t);for(const a of o){const l=Ft(a.start);if(l>i)return{nextZone:a,minutesUntil:l-i}}return{nextZone:null,minutesUntil:0}}function kn(e,t=new Date){if(!e)return!1;try{const s=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return s.getFullYear()===i.getUTCFullYear()&&s.getMonth()===i.getUTCMonth()&&s.getDate()===i.getUTCDate()}catch{return!1}}function Ln(e=new Date){const{hours:t,minutes:s}=Ht(e),r=t*60+s;return r>=555&&r<930}function Mn(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return`${s.getUTCHours().toString().padStart(2,"0")}:${s.getUTCMinutes().toString().padStart(2,"0")}:${s.getUTCSeconds().toString().padStart(2,"0")}`}function us(){const e=j(r=>r.expiry),[t,s]=d.useState(()=>{const r=new Date,i=kn(e,r),{zone:o,sensitivity:a}=Dt(r,i),{nextZone:l,minutesUntil:c}=En(r,i);return{currentTime:Mn(r),currentZone:o,sensitivity:a,nextZone:l,minutesToNext:c,isExpiryDay:i,isOpen:Ln(r)}});return d.useEffect(()=>{const i=setInterval(()=>{const o=new Date,a=kn(e,o),{zone:l,sensitivity:c}=Dt(o,a),{nextZone:m,minutesUntil:p}=En(o,a);s({currentTime:Mn(o),currentZone:l,sensitivity:c,nextZone:m,minutesToNext:p,isExpiryDay:a,isOpen:Ln(o)})},1e3);return()=>clearInterval(i)},[e]),t}function _r(){const e=H(r=>r.activePresetId),t=H(r=>r.applyPreset),{isExpiryDay:s}=us();return n.jsx("div",{className:"space-y-1.5",children:cs.map(r=>{const i=e===r.id,o=r.id==="expiry";return n.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-xs font-medium",children:r.name}),n.jsxs("div",{className:"flex items-center gap-1",children:[o&&s&&n.jsx(xe,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&n.jsx(xe,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function X({label:e,field:t,step:s}){const r=H(o=>o.config[t]),i=H(o=>o.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(Ce,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),n.jsx($e,{type:"number",value:r,step:s??1,onChange:o=>i({[t]:Number(o.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function we({label:e,field:t}){const s=H(i=>i.config[t]),r=H(i=>i.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(Ce,{className:"text-[10px] text-muted-foreground",children:e}),n.jsx(_n,{checked:s,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function Ne({title:e,children:t}){return n.jsxs("details",{className:"group",children:[n.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),n.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function Vr(){return n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs(Ne,{title:"Entry Conditions",children:[n.jsx(X,{label:"Momentum Count",field:"entryMomentumCount"}),n.jsx(X,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),n.jsx(X,{label:"Min Score",field:"entryMinScore"}),n.jsx(X,{label:"Max Spread",field:"entryMaxSpread"})]}),n.jsxs(Ne,{title:"Trailing SL (5-Stage)",children:[n.jsx(X,{label:"Initial SL (pts)",field:"trailInitialSL"}),n.jsx(X,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),n.jsx(X,{label:"Lock Trigger",field:"trailLockTrigger"}),n.jsx(X,{label:"Lock Amount",field:"trailLockAmount"}),n.jsx(X,{label:"Trail Start",field:"trailStartTrigger"}),n.jsx(X,{label:"Trail Step",field:"trailStepSize"}),n.jsx(X,{label:"Tight Trigger",field:"trailTightTrigger"}),n.jsx(X,{label:"Tight Step",field:"trailTightStep"})]}),n.jsxs(Ne,{title:"Breakeven",children:[n.jsx(X,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),n.jsx(X,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),n.jsxs(Ne,{title:"Risk",children:[n.jsx(X,{label:"Max Daily Loss",field:"maxDailyLoss"}),n.jsx(X,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),n.jsx(X,{label:"Max Trades/Day",field:"maxTradesPerDay"}),n.jsx(X,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),n.jsx(X,{label:"Min Gap (ms)",field:"minGapMs",step:500}),n.jsx(X,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),n.jsx(X,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),n.jsx(X,{label:"Max Position Size",field:"maxPositionSize"})]}),n.jsxs(Ne,{title:"Imbalance Filter",children:[n.jsx(we,{label:"Enabled",field:"imbalanceFilterEnabled"}),n.jsx(X,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),n.jsxs(Ne,{title:"Regime Detection",children:[n.jsx(X,{label:"Detection Period",field:"regimeDetectionPeriod"}),n.jsx(X,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),n.jsxs(Ne,{title:"Index Bias",children:[n.jsx(we,{label:"Enabled",field:"indexBiasEnabled"}),n.jsx(X,{label:"Weight",field:"indexBiasWeight",step:.1})]}),n.jsxs(Ne,{title:"Options Context",children:[n.jsx(we,{label:"Enabled",field:"optionsContextEnabled"}),n.jsx(X,{label:"PCR Bullish ",field:"pcrBullishThreshold",step:.1}),n.jsx(X,{label:"PCR Bearish ",field:"pcrBearishThreshold",step:.1}),n.jsx(X,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),n.jsx(we,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),n.jsx(we,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),n.jsx(X,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),n.jsxs(Ne,{title:"Time-of-Day",children:[n.jsx(we,{label:"Respect Hot Zones",field:"respectHotZones"}),n.jsx(X,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),n.jsxs(Ne,{title:"No-Trade Zone",children:[n.jsx(we,{label:"Enabled",field:"noTradeZoneEnabled"}),n.jsx(X,{label:"Range (pts)",field:"noTradeZoneRangePts"}),n.jsx(X,{label:"Period",field:"noTradeZonePeriod"})]}),n.jsxs(Ne,{title:"Re-Entry",children:[n.jsx(we,{label:"Enabled",field:"reEntryEnabled"}),n.jsx(X,{label:"Delay (sec)",field:"reEntryDelaySec"}),n.jsx(X,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),n.jsxs(Ne,{title:"Telegram Alerts",children:[n.jsx(we,{label:"Entry Alerts",field:"telegramAlertsEntry"}),n.jsx(we,{label:"Exit Alerts",field:"telegramAlertsExit"}),n.jsx(we,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Gr(){const e=H(r=>r.ghostSignals),t=H(r=>r.clearGhostSignals);if(e.length===0)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const s=e.slice(-10).reverse();return n.jsxs("div",{className:"space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),s.map(r=>n.jsx(qr,{signal:r},r.id))]})}function qr({signal:e}){const t=le(u=>u.apiKey),s=j(u=>u.optionExchange),r=j(u=>u.quantity),i=j(u=>u.lotSize),o=j(u=>u.product),a=j(u=>u.paperMode),l=j(u=>u.incrementTradeCount),c=d.useCallback(async()=>{if(a){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),l();return}if(!t)return;const u={apikey:t,strategy:"Scalping-Ghost",exchange:s,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:o};try{const y=await oe.placeOrder(u);y.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${y.data?.orderid}`),l())}catch(y){console.error("[Ghost Take] Failed:",y)}},[e,t,s,r,i,o,a,l]),m=Math.round((Date.now()-e.timestamp)/1e3),p=m<60?`${m}s ago`:`${Math.round(m/60)}m ago`;return n.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(xe,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),n.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),n.jsxs(xe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&n.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&n.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),n.jsx(te,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:c,children:"Take Trade"})]})]})}function Br(){const e=H(r=>r.optionsContext);if(!e)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),s=t<60?`${t}s`:`${Math.round(t/60)}m`;return n.jsxs("div",{className:"space-y-1.5 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),n.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",s," ago"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PCR"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[n.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),n.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),n.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),n.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",n.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),n.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),n.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),n.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),n.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),n.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),n.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&n.jsxs("div",{children:[n.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),n.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>n.jsx(xe,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}function Kr(){const[e,t]=d.useState(!1),[s,r]=d.useState(null),[i,o]=d.useState(null),[a,l]=d.useState(null),c=H(v=>v.updateConfig),m=j(v=>v.underlying),p=d.useCallback(async()=>{try{const v=await Ss();r(v.provider||"none"),v.last_run&&o(v.last_run),l(null)}catch{l("Could not reach advisor")}},[]),u=d.useCallback(async()=>{t(!0),l(null);try{const v=await js({underlying:m});if(v.status==="success"&&v.run_id){const h=await Ns(1);h.runs?.length>0&&o(h.runs[0])}else l(v.message||"Tuning failed")}catch{l("Advisor request failed")}finally{t(!1)}},[m]),y=d.useCallback(async()=>{if(i?.run_id){t(!0);try{await Ps(i.run_id);const v=i.recommendations;if(v&&typeof v=="object"){const h={};for(const[P,g]of Object.entries(v))typeof g=="number"&&(h[P]=g);c(h)}o(h=>h&&{...h,applied:!0}),l(null)}catch{l("Failed to apply recommendation")}finally{t(!1)}}},[i,c]);return n.jsxs("div",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),s&&n.jsx(xe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:s})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(te,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:p,disabled:e,children:"Check Status"}),n.jsx(te,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:u,disabled:e,children:e?"Running...":"Tune Config"})]}),a&&n.jsx("div",{className:"text-[9px] text-red-500 px-1",children:a}),i&&n.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Score"}),n.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??""})]}),i.notes&&n.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&n.jsxs("div",{className:"space-y-0.5",children:[n.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([v,h])=>n.jsxs("div",{className:"flex justify-between pl-1",children:[n.jsx("span",{className:"text-muted-foreground",children:v}),n.jsx("span",{className:"font-mono",children:typeof h=="number"?h:String(h)})]},v))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&n.jsx(te,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:y,disabled:e,children:"Apply Recommendation"}),i.applied&&n.jsx(xe,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function Wr(){const e=H(p=>p.enabled),t=H(p=>p.mode),s=H(p=>p.regime),r=H(p=>p.tradesCount),i=H(p=>p.realizedPnl),o=H(p=>p.consecutiveLosses),a=H(p=>p.setEnabled),l=H(p=>p.setMode),c=H(p=>p.resetRuntime),m=j(p=>p.paperMode);return n.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Ce,{className:"text-xs font-medium",children:"Auto-Trade"}),n.jsx(_n,{checked:e,onCheckedChange:a,className:"h-5 w-9"})]}),n.jsx(xe,{variant:e?t==="execute"?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(te,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>l("ghost"),children:"Ghost (Signals Only)"}),n.jsx(te,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>l("execute"),children:"Execute (Live)"})]}),t==="execute"&&!m&&n.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Regime"}),n.jsx(xe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:s})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Trades"}),n.jsx("span",{className:"font-bold",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${i>0?"text-green-500":i<0?"text-red-500":""}`,children:[i>=0?"+":"",i.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),n.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:c,children:"Reset Runtime"})]}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Br,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Gr,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Kr,{})}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),n.jsx(_r,{})]}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),n.jsx(Vr,{})]})]})}function Ur(){const e=le(u=>u.apiKey),t=j(u=>u.optionExchange),s=Y(u=>u.virtualTPSL),r=Y(u=>u.triggerOrders),i=Y(u=>u.removeVirtualTPSL),o=Y(u=>u.removeTriggerOrder),a=Y(u=>u.clearAll),{data:l}=zn({queryKey:["scalping-orders",t],queryFn:()=>oe.getOrders(e),enabled:!!e,refetchInterval:5e3}),c=(l?.data?.orders??[]).filter(u=>u.exchange===t&&(u.order_status==="open"||u.order_status==="pending"||u.order_status==="trigger pending")),m=Object.values(s),p=Object.values(r);return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),n.jsx(xe,{variant:"outline",className:"text-[10px] h-4",children:c.length})]}),c.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):n.jsx("div",{className:"space-y-1",children:c.map(u=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:u.action==="BUY"?"text-green-500":"text-red-500",children:u.action})," ",n.jsx("span",{className:"font-mono",children:u.symbol.slice(-10)})," ",n.jsxs("span",{className:"text-muted-foreground",children:["x",u.quantity]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(xe,{variant:"outline",className:"text-[10px] h-4",children:u.order_status}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await oe.cancelOrder(u.orderid)}catch(y){console.error("Cancel failed:",y)}},children:"Cancel"})]})]},u.orderid))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),n.jsx(xe,{variant:"outline",className:"text-[10px] h-4",children:m.length})]}),m.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):n.jsx("div",{className:"space-y-1",children:m.map(u=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:u.side==="CE"?"text-green-500":"text-red-500",children:u.side})," ",n.jsx("span",{className:"font-mono",children:u.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",u.entryPrice.toFixed(1)," |"," ",u.tpPrice!==null&&n.jsxs("span",{className:"text-green-500",children:["TP: ",u.tpPrice.toFixed(1)]})," ",u.slPrice!==null&&n.jsxs("span",{className:"text-red-500",children:["SL: ",u.slPrice.toFixed(1)]})]})]}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(u.id),children:"Remove"})]},u.id))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),n.jsx(xe,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):n.jsx("div",{className:"space-y-1",children:p.map(u=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:u.action==="BUY"?"text-green-500":"text-red-500",children:u.action})," ",n.jsx("span",{className:"font-mono",children:u.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",u.triggerPrice.toFixed(1)," (",u.direction,") | x",u.quantity]})]}),n.jsx(te,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>o(u.id),children:"Remove"})]},u.id))})]}),(m.length>0||p.length>0)&&n.jsx(te,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:a,children:"Clear All Virtual Orders"})]})}function Hr(e,t){const s=le(p=>p.apiKey),[r,i]=d.useState(null),[o,a]=d.useState(!1),l=d.useRef(null),c=d.useCallback(async()=>{if(!(!e||!s)){try{const p=await oe.getDepth(s,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}a(!1)}},[e,t,s]);d.useEffect(()=>{if(!e){i(null);return}return a(!0),c(),l.current=setInterval(c,2e3),()=>{l.current&&clearInterval(l.current)}},[e,c]);const m=r?Yr(r):null;return{depth:r,analytics:m,levels:5,isLoading:o}}function Yr(e){const t=e.bids||[],s=e.asks||[],r=t.reduce((v,h)=>v+h.quantity,0),i=s.reduce((v,h)=>v+h.quantity,0),o=i>0?r/i:r>0?999:1,a=s.length>0&&t.length>0?s[0].price-t[0].price:0,l=t.length>0?t.reduce((v,h)=>h.quantity>v.quantity?h:v,t[0]):null,c=l?{price:l.price,qty:l.quantity}:null,m=s.length>0?s.reduce((v,h)=>h.quantity>v.quantity?h:v,s[0]):null,p=m?{price:m.price,qty:m.quantity}:null,u=r+i,y=u>0?(r-i)/u*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:o,spread:a,largestBidWall:c,largestAskWall:p,imbalanceScore:y}}function Xr(){const e=j(l=>l.activeSide),t=j(l=>l.optionExchange),s=j(l=>l.activeSide==="CE"?l.selectedCESymbol:l.selectedPESymbol),{depth:r,analytics:i,levels:o,isLoading:a}=Hr(s,t);return s?n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),n.jsx("span",{className:"font-mono text-muted-foreground",children:s.slice(-10)})]}),n.jsxs(xe,{variant:"outline",className:"text-[10px] h-4",children:[o,"-Level"]})]}),a&&!r?n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[n.jsx("span",{className:"text-right",children:"Bid Qty"}),n.jsx("span",{className:"text-center",children:"Bid"}),n.jsx("span",{className:"text-center",children:"Ask"}),n.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((l,c)=>{const m=r.bids?.[c],p=r.asks?.[c],u=Math.max(...r.bids?.map(y=>y.quantity)??[0],...r.asks?.map(y=>y.quantity)??[0]);return n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[n.jsx("div",{className:"flex items-center justify-end",children:n.jsx("div",{className:"relative h-4 w-full",children:m&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${u>0?m.quantity/u*100:0}%`}}),n.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:m.quantity.toLocaleString()})]})})}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:m?.price.toFixed(2)??"--"}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),n.jsx("div",{className:"flex items-center",children:n.jsx("div",{className:"relative h-4 w-full",children:p&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${u>0?p.quantity/u*100:0}%`}}),n.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},c)})]}),i&&n.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),n.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Spread"}),n.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),n.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),n.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),n.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),n.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),n.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[n.jsxs("span",{children:["LTP: ",n.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),n.jsxs("span",{children:["Vol: ",n.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),n.jsxs("span",{children:["OI: ",n.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):n.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:n.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Rn=500;function Zr(){const e=d.useRef([]),t=d.useCallback(l=>{const c={...l,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(c),e.current.length>Rn&&(e.current=e.current.slice(-Rn)),c},[]),s=d.useCallback(()=>[...e.current],[]),r=d.useCallback(l=>e.current.slice(-l),[]),i=d.useCallback(()=>{e.current=[]},[]),o=d.useCallback(()=>JSON.stringify(e.current,null,2),[]),a=d.useCallback(()=>{const l=e.current;if(l.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const c=l.filter(y=>y.pnl!==void 0),m=c.filter(y=>(y.pnl??0)>0),p=c.reduce((y,v)=>y+(v.pnl??0),0),u=c.map(y=>y.pnl??0);return{count:l.length,winRate:c.length>0?m.length/c.length*100:0,avgPnl:c.length>0?p/c.length:0,totalPnl:p,bestTrade:u.length>0?Math.max(...u):0,worstTrade:u.length>0?Math.min(...u):0}},[]);return{logTrade:t,getTrades:s,getRecentTrades:r,clearTrades:i,exportAsJSON:o,getStats:a}}function Qr({liveOpenPnl:e,isLivePnl:t=!1}){const s=j(T=>T.sessionPnl),r=j(T=>T.tradeCount),i=j(T=>T.paperMode),o=i?s:e??s,a=us(),{getStats:l}=Zr(),c=l(),[m,p]=d.useState(5e3),[u,y]=d.useState(500),[v,h]=d.useState(50),[P,g]=d.useState(3),C=o<0&&Math.abs(o)>=m;return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),n.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:a.currentTime})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Status"}),n.jsx(xe,{variant:a.isOpen?"default":"secondary",className:"text-[10px] h-4",children:a.isOpen?"OPEN":"CLOSED"})]}),a.currentZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Zone"}),n.jsx("span",{className:"font-medium",children:a.currentZone.label})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${a.sensitivity>=1.5?"bg-red-500":a.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,a.sensitivity*50)}%`}})}),n.jsxs("span",{className:"tabular-nums",children:[a.sensitivity.toFixed(1),"x"]})]})]}),a.nextZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),n.jsxs("span",{children:[a.nextZone.label," ",n.jsxs("span",{className:"text-muted-foreground",children:["in ",a.minutesToNext,"m"]})]})]}),a.isExpiryDay&&n.jsx(xe,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-2",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),C&&n.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-[10px]",children:"Daily Loss Limit"}),n.jsx($e,{type:"number",value:m,onChange:T=>p(Number(T.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),n.jsx($e,{type:"number",value:u,onChange:T=>y(Number(T.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-[10px]",children:"Profit Protection (%)"}),n.jsx($e,{type:"number",value:v,onChange:T=>h(Number(T.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(Ce,{className:"text-[10px]",children:"Cooling Off After N Losses"}),n.jsx($e,{type:"number",value:P,onChange:T=>g(Number(T.target.value)||0),className:"h-6 text-xs"})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),n.jsx("span",{className:"font-bold",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsxs("span",{className:`font-bold tabular-nums ${o>0?"text-green-500":o<0?"text-red-500":""}`,children:[o>=0?"+":"",o.toFixed(0)]}),!i&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),c.count>0&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),n.jsxs("span",{className:"font-bold",children:[c.winRate.toFixed(0),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${c.avgPnl>0?"text-green-500":c.avgPnl<0?"text-red-500":""}`,children:[c.avgPnl>=0?"+":"",c.avgPnl.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),n.jsxs("span",{children:[n.jsxs("span",{className:"text-green-500",children:["+",c.bestTrade.toFixed(0)]})," / ",n.jsx("span",{className:"text-red-500",children:c.worstTrade.toFixed(0)})]})]})]})]})]})}const Jr=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function ei({liveOpenPnl:e,isLivePnl:t=!1}){const s=j(i=>i.controlTab),r=j(i=>i.setControlTab);return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:Jr.map(i=>n.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${s===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),n.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[s==="manual"&&n.jsx(Ar,{}),s==="auto"&&n.jsx(Wr,{}),s==="risk"&&n.jsx(Qr,{liveOpenPnl:e,isLivePnl:t}),s==="depth"&&n.jsx(Xr,{}),s==="orders"&&n.jsx(Ur,{})]})]})}const ti=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE  PE)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function ni({open:e,onClose:t}){return d.useEffect(()=>{if(!e)return;const s=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[e,t]),e?n.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:n.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:s=>s.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),n.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),n.jsx("div",{className:"space-y-1",children:ti.map(({key:s,description:r})=>n.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[n.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:s}),n.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},s))}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function si(e={}){const t=j(f=>f.hotkeysEnabled),s=j(f=>f.activeSide),r=j(f=>f.selectedCESymbol),i=j(f=>f.selectedPESymbol),o=j(f=>f.optionExchange),a=j(f=>f.quantity),l=j(f=>f.lotSize),c=j(f=>f.product),m=j(f=>f.orderType),p=j(f=>f.limitPrice),u=j(f=>f.setLimitPrice),y=j(f=>f.tpPoints),v=j(f=>f.slPoints),h=j(f=>f.setPendingEntryAction),P=j(f=>f.paperMode),g=Y(f=>f.setVirtualTPSL),C=Y(f=>f.getTPSLForSymbol),T=Y(f=>f.removeVirtualTPSL),k=Y(f=>f.triggerOrders),M=Y(f=>f.removeTriggerOrder),V=j(f=>f.toggleActiveSide),F=j(f=>f.toggleFloatingWidget),S=j(f=>f.setQuantity),x=le(f=>f.apiKey),E=le(f=>f.setApiKey),R=d.useCallback(()=>s==="CE"?r:i,[s,r,i]),z=d.useCallback(async()=>{if(x)return x;try{const L=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(L.status==="success"&&L.api_key)return E(L.api_key),L.api_key}catch(f){console.error("[Scalping] Failed to fetch API key:",f)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[x,E]),I=d.useCallback(async f=>{const L=R();if(!L){console.warn("[Scalping] No symbol selected  click a strike first");return}if(m==="TRIGGER"){const N=Object.values(k).find(D=>D.symbol===L&&D.exchange===o&&D.side===s);N&&M(N.id),u(null),h(f),console.log(`[Scalping] TRIGGER armed (${f})  click chart to place trigger line`);return}if(m==="LIMIT"&&!p){h(f),console.log(`[Scalping] LIMIT armed (${f})  click chart to set limit line`);return}if(P){if(console.log(`[Paper] ${f} ${s} ${L} qty=${a*l} @ ${m}`),m==="MARKET"){const N=await He({symbol:L,exchange:o});if(N>0){const D=C(L);D&&T(D.id),g(Ge({symbol:L,exchange:o,side:s,action:f,entryPrice:N,quantity:a*l,tpPoints:y,slPoints:v}))}}return}const q=await z();if(!q)return;const $=m==="LIMIT"?"LIMIT":"MARKET",G={apikey:q,strategy:"Scalping",exchange:o,symbol:L,action:f,quantity:a*l,pricetype:$,product:c,price:m==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${f} ${L} qty=${a*l} ${$}`);const N=await oe.placeOrder(G);if(N.status==="success"){if(console.log(`[Scalping] Order placed: ${f} ${L} id=${N.data?.orderid}`),h(null),$==="MARKET"){const D=await He({symbol:L,exchange:o,apiKey:q});if(D>0){const B=C(L);B&&T(B.id),g(Ge({symbol:L,exchange:o,side:s,action:f,entryPrice:D,quantity:a*l,tpPoints:y,slPoints:v}))}}}else console.error("[Scalping] Order rejected:",N)}catch(N){console.error("[Scalping] Order failed:",N)}},[R,s,a,l,o,c,m,p,y,v,P,C,T,k,z,g,M,u,h]);d.useEffect(()=>{if(!t)return;const f=L=>{const q=L.target?.tagName;if(q==="INPUT"||q==="TEXTAREA"||q==="SELECT")return;const $=R();switch(L.key.toLowerCase()){case"b":{L.preventDefault(),$&&(I("BUY"),e.onBuy?.(s,$));break}case"s":{L.preventDefault(),$&&(I("SELL"),e.onSell?.(s,$));break}case"c":{L.preventDefault(),$&&e.onClose?.(s,$);break}case"x":{L.preventDefault(),e.onCloseAll?.();break}case"r":{L.preventDefault(),$&&e.onReversal?.(s,$);break}case"w":{L.preventDefault(),F();break}case"tab":{L.preventDefault(),V();break}case"1":{L.preventDefault(),S(1);break}case"2":{L.preventDefault(),S(2);break}case"3":{L.preventDefault(),S(3);break}case"?":{L.preventDefault(),e.onToggleHelp?.();break}}};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[t,s,R,I,V,F,S,e])}const ri=45e3;function ii(){const e=le(a=>a.apiKey),t=j(a=>a.underlying),s=j(a=>a.expiry),r=j(a=>a.optionExchange),i=H(a=>a.setOptionsContext),o=d.useRef(null);d.useEffect(()=>{if(!e||!s)return;const a=async()=>{try{const l=await ai(e,t,s,r);l&&i(l)}catch(l){console.warn("[OptionsContext] Fetch failed:",l)}};return a(),o.current=setInterval(a,ri),()=>{o.current&&clearInterval(o.current)}},[e,t,s,r,i])}async function ai(e,t,s,r){const i="/api/v1";try{const[o,a,l,c,m]=await Promise.allSettled([fetch(`${i}/oi_tracker`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,symbol:t,exchange:r,expiry:s})}).then(P=>P.json()),fetch(`${i}/max_pain`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,symbol:t,exchange:r,expiry:s})}).then(P=>P.json()),fetch(`${i}/gex`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,symbol:t,exchange:r,expiry:s})}).then(P=>P.json()),fetch(`${i}/iv_chart`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,symbol:t,exchange:r,expiry:s})}).then(P=>P.json()),fetch(`${i}/straddle_chart`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,symbol:t,exchange:r,expiry:s})}).then(P=>P.json())]),p=o.status==="fulfilled"?o.value:null,u=a.status==="fulfilled"?a.value:null,y=l.status==="fulfilled"?l.value:null,v=c.status==="fulfilled"?c.value:null,h=m.status==="fulfilled"?m.value:null;return{pcr:p?.data?.pcr??1,oiChangeCE:p?.data?.ce_oi_change??0,oiChangePE:p?.data?.pe_oi_change??0,maxPainStrike:u?.data?.max_pain_strike??0,spotVsMaxPain:u?.data?.spot_vs_max_pain??0,topGammaStrikes:y?.data?.top_gamma_strikes??[],gexFlipZones:y?.data?.flip_zones??[],netGEX:y?.data?.net_gex??0,atmIV:v?.data?.atm_iv??15,ivPercentile:v?.data?.iv_percentile??50,ceIV:v?.data?.ce_iv??15,peIV:v?.data?.pe_iv??15,ivSkew:(v?.data?.ce_iv??15)-(v?.data?.pe_iv??15),straddlePrice:h?.data?.straddle_price??0,lastUpdated:Date.now()}}catch{return null}}function oi(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const s=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let l=1;l<s.length;l++)s[l]>s[l-1]?r++:s[l]<s[l-1]&&i++;const o=r>i?"up":i>r?"down":"flat",a=s.length>=2?Math.abs(s[s.length-1]-s[0]):0;return{direction:o,count:Math.max(r,i),velocity:a}}function li(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const s=e.slice(-t.regimeDetectionPeriod),r=s.map(m=>m.high),i=s.map(m=>m.low),o=Math.max(...r)-Math.min(...i),a=s.map(m=>m.close),l=Math.abs(a[a.length-1]-a[0]),c=s.reduce((m,p)=>m+(p.high-p.low),0)/s.length;return o<t.rangingThresholdPts?"RANGING":l>o*.6?"TRENDING":c>o*.15?"VOLATILE":"RANGING"}function ci(e,t){const r=0*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function di(e,t,s){return!s.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>s.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<s.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<s.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:s.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function ui(e,t,s){if(!s.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function pi(e,t,s,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=s==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${s==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function fi(e,t,s,r,i,o,a,l,c,m,p){let u=0;const y=[],v=Date.now();if(r.tradesCount>=s.maxTradesPerDay)return{enter:!1,reason:"Max daily trades reached",score:0};if(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=s.maxDailyLoss)return{enter:!1,reason:"Daily loss limit reached",score:0};if(r.consecutiveLosses>=s.coolingOffAfterLosses)return{enter:!1,reason:`Cooling off (${r.consecutiveLosses} losses)`,score:0};if(s.perTradeMaxLoss>0&&r.consecutiveLosses>0,s.minGapMs>0&&r.lastTradeTime>0){const C=v-r.lastTradeTime;if(C<s.minGapMs)return{enter:!1,reason:`Min gap: ${Math.ceil((s.minGapMs-C)/1e3)}s remaining`,score:0}}if(s.maxTradesPerMinute>0&&r.tradesThisMinute>=s.maxTradesPerMinute)return{enter:!1,reason:`Rate limit: ${r.tradesThisMinute}/${s.maxTradesPerMinute} trades/min`,score:0};if(s.cooldownAfterLossSec>0&&r.lastLossTime>0){const C=v-r.lastLossTime,T=s.cooldownAfterLossSec*1e3;if(C<T)return{enter:!1,reason:`Cooldown: ${Math.ceil((T-C)/1e3)}s after loss`,score:0}}if(p){const C=pi(p.totalBid,p.totalAsk,e,s);if(!C.allowed)return{enter:!1,reason:C.reason,score:0}}if(m>s.entryMaxSpread)return{enter:!1,reason:`Spread too wide: ${m.toFixed(1)}`,score:0};const h=e==="CE"?"up":"down";i.direction===h&&i.count>=s.entryMomentumCount?(u+=3,y.push(`Momentum ${i.direction} x${i.count}`)):i.direction===h&&(u+=1,y.push(`Weak momentum ${i.direction}`)),i.velocity>=s.entryMomentumVelocity&&(u+=2,y.push(`Velocity ${i.velocity.toFixed(1)}`)),s.indexBiasEnabled&&(e==="CE"&&a.direction==="bullish"||e==="PE"&&a.direction==="bearish")&&(u+=1,y.push(`Index ${a.direction}`));const P=di(e,l,s);if(!P.allowed)return{enter:!1,reason:P.reason,score:u};const g=s.entryMinScore/(c*s.sensitivityMultiplier);return{enter:u>=g,reason:y.join(", ")||"No strong signals",score:u}}function mi(e,t,s,r,i,o,a){const l=i?s-t:t-s,c=i?r-t:t-r,m=ui(o.trailInitialSL,a,o);return e==="INITIAL"?l>=o.trailBreakevenTrigger?{newSL:t+(i?o.breakevenBuffer:-o.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-m:t+m,newStage:"INITIAL"}:e==="BREAKEVEN"?c>=o.trailLockTrigger?{newSL:i?t+o.trailLockAmount:t-o.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?o.breakevenBuffer:-o.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?c>=o.trailStartTrigger?{newSL:i?r-o.trailStepSize:r+o.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+o.trailLockAmount:t-o.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?c>=o.trailTightTrigger?{newSL:i?r-o.trailTightStep:r+o.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-o.trailStepSize:r+o.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-o.trailTightStep:r+o.trailTightStep,newStage:"TIGHT"}}function xi(e,t,s,r,i,o,a){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:s,score:i.score,reason:i.reason,regime:o,pcr:a}}function hi(e){const t=le(f=>f.apiKey),s=j(f=>f.activeSide),r=j(f=>f.selectedCESymbol),i=j(f=>f.selectedPESymbol),o=j(f=>f.optionExchange),a=j(f=>f.quantity),l=j(f=>f.lotSize),c=j(f=>f.product),m=j(f=>f.selectedStrike),p=j(f=>f.paperMode),u=H(f=>f.enabled),y=H(f=>f.mode),v=H(f=>f.config),h=H(f=>f.optionsContext),P=H(f=>f.regime),g=H(f=>f.consecutiveLosses),C=H(f=>f.tradesCount),T=H(f=>f.realizedPnl),k=H(f=>f.lastTradeTime),M=H(f=>f.tradesThisMinute),V=H(f=>f.lastLossTime),F=H(f=>f.setRegime),S=H(f=>f.addGhostSignal),x=H(f=>f.recordTrade),E=d.useRef([]),R=d.useRef([]),z=d.useRef(0),I=d.useRef(!1);d.useEffect(()=>{if(!u||!e)return;const f=Date.now();if(f-z.current<100)return;z.current=f;const L=r,q=i,$=L?e.get(`${o}:${L}`)?.data?.ltp:void 0,G=q?e.get(`${o}:${q}`)?.data?.ltp:void 0;$&&(E.current.push($),E.current.length>100&&(E.current=E.current.slice(-100))),G&&(R.current.push(G),R.current.length>100&&(R.current=R.current.slice(-100)));const{sensitivity:N}=Dt(new Date,!1);for(const D of["CE","PE"]){const B=D==="CE"?L:q,O=D==="CE"?$:G,A=D==="CE"?E.current:R.current;if(!B||!O||A.length<5)continue;const K=oi(A,v),Z={},ce=ci(Z,v),de=`${o}:${B}`,fe=e.get(de)?.data?.bid_price,b=e.get(de)?.data?.ask_price,_=fe&&b?b-fe:2,Q=e.get(de)?.data?.depth;let se;if(Q?.buy?.length&&Q?.sell?.length){const W=Q.buy.reduce((Te,ye)=>Te+(ye.quantity||0),0),he=Q.sell.reduce((Te,ye)=>Te+(ye.quantity||0),0);W>0&&he>0&&(se={totalBid:W,totalAsk:he})}const ie=fi(D,O,v,{consecutiveLosses:g,tradesCount:C,realizedPnl:T,lastTradeTime:k,tradesThisMinute:M,lastLossTime:V},K,Z,ce,h,N,_,se);if(y==="ghost"){const W=xi(D,B,m??0,O,ie,P,h?.pcr);W&&S(W)}else if(y==="execute"&&ie.enter&&!I.current){I.current=!0;const W="BUY";if(p)console.log(`[AutoTrade Paper] ${W} ${D} ${B} score=${ie.score}`),x(0),I.current=!1;else if(t){const he={apikey:t,strategy:"Scalping-Auto",exchange:o,symbol:B,action:W,quantity:a*l,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0};oe.placeOrder(he).then(Te=>{Te.status==="success"&&console.log(`[AutoTrade] ${W} ${B} id=${Te.data?.orderid} score=${ie.score}`)}).catch(Te=>console.error("[AutoTrade] Order failed:",Te)).finally(()=>{I.current=!1})}else I.current=!1}}if(E.current.length>=v.regimeDetectionPeriod){const D=E.current.slice(-v.regimeDetectionPeriod).map((O,A,K)=>({high:Math.max(O,K[Math.max(0,A-1)]??O),low:Math.min(O,K[Math.max(0,A-1)]??O),close:O})),B=li(D,v);B!==P&&F(B)}},[u,e,y,v,r,i,h,P,g,C,T,k,M,V,t,o,a,l,c,p,m,S,x,F,s])}function gi(e){const t=le(x=>x.apiKey),s=le(x=>x.setApiKey),r=j(x=>x.paperMode),i=j(x=>x.optionExchange),o=j(x=>x.product),a=j(x=>x.lotSize),l=j(x=>x.addSessionPnl),c=j(x=>x.incrementTradeCount),m=Y(x=>x.virtualTPSL),p=Y(x=>x.triggerOrders),u=Y(x=>x.getTPSLForSymbol),y=Y(x=>x.removeVirtualTPSL),v=Y(x=>x.removeTriggerOrder),h=Y(x=>x.setVirtualTPSL),P=d.useRef(t),g=d.useRef(r),C=d.useRef(i),T=d.useRef(o),k=d.useRef(a);d.useEffect(()=>{P.current=t},[t]),d.useEffect(()=>{g.current=r},[r]),d.useEffect(()=>{C.current=i},[i]),d.useEffect(()=>{T.current=o},[o]),d.useEffect(()=>{k.current=a},[a]);const M=d.useRef(new Set),V=d.useCallback(async()=>{if(P.current)return P.current;try{const E=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(E.status==="success"&&E.api_key)return P.current=E.api_key,s(E.api_key),E.api_key}catch(x){console.error("[Scalping] Failed to fetch API key:",x)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[s]),F=d.useCallback(async(x,E,R,z)=>{const I=R==="BUY"?"SELL":"BUY";if(g.current)return console.log(`[Paper TP/SL] ${z}: ${I} ${x} qty=${E}`),!0;const f=await V();if(!f)return!1;const L={apikey:f,strategy:"Scalping",exchange:C.current,symbol:x,action:I,quantity:E,pricetype:"MARKET",product:T.current,price:0,trigger_price:0,disclosed_quantity:0};try{const q=await oe.placeOrder(L);if(q.status==="success")return console.log(`[Scalping TP/SL] ${z}: ${I} ${x} id=${q.data?.orderid}`),!0}catch(q){console.error(`[Scalping TP/SL] ${z} order failed:`,q)}return!1},[V]),S=d.useCallback(async(x,E,R)=>{if(g.current)return console.log(`[Paper Trigger] Entry: ${R} ${x} qty=${E}`),!0;const z=await V();if(!z)return!1;const I={apikey:z,strategy:"Scalping",exchange:C.current,symbol:x,action:R,quantity:E,pricetype:"MARKET",product:T.current,price:0,trigger_price:0,disclosed_quantity:0};try{const f=await oe.placeOrder(I);if(f.status==="success")return console.log(`[Scalping Trigger] Entry: ${R} ${x} id=${f.data?.orderid}`),!0}catch(f){console.error("[Scalping Trigger] Entry failed:",f)}return!1},[V]);d.useEffect(()=>{if(e){for(const x of Object.values(m)){const E=`${x.exchange}:${x.symbol}`,z=(e.get(E)??e.get(x.symbol))?.data?.ltp;if(!z||M.current.has(x.id))continue;const I=x.action==="BUY";if(x.tpPrice!==null&&(I?z>=x.tpPrice:z<=x.tpPrice)){M.current.add(x.id);const L=I?(z-x.entryPrice)*x.quantity:(x.entryPrice-z)*x.quantity;F(x.symbol,x.quantity,x.action,`TP hit at ${z}`).then(q=>{q&&(y(x.id),l(L),c()),M.current.delete(x.id)});continue}if(x.slPrice!==null&&(I?z<=x.slPrice:z>=x.slPrice)){M.current.add(x.id);const L=I?(z-x.entryPrice)*x.quantity:(x.entryPrice-z)*x.quantity;F(x.symbol,x.quantity,x.action,`SL hit at ${z}`).then(q=>{q&&(y(x.id),l(L),c()),M.current.delete(x.id)})}}for(const x of Object.values(p)){const E=`${x.exchange}:${x.symbol}`,z=(e.get(E)??e.get(x.symbol))?.data?.ltp;if(!z||M.current.has(x.id))continue;(x.direction==="above"?z>=x.triggerPrice:z<=x.triggerPrice)&&(M.current.add(x.id),S(x.symbol,x.quantity,x.action).then(f=>{if(f&&(v(x.id),c(),z>0)){const L=u(x.symbol);L&&y(L.id),h(Ge({symbol:x.symbol,exchange:x.exchange,side:x.side,action:x.action,entryPrice:z,quantity:x.quantity,tpPoints:x.tpPoints,slPoints:x.slPoints}))}M.current.delete(x.id)}))}}},[e,m,p,F,S,u,y,v,h,l,c])}function yi(){const e=j(g=>g.optionExchange),t=H(g=>g.config),s=H(g=>g.trailStage),r=H(g=>g.highSinceEntry),i=H(g=>g.optionsContext),o=H(g=>g.setTrailStage),a=H(g=>g.setHighSinceEntry),l=Y(g=>g.virtualTPSL),c=Y(g=>g.updateVirtualTPSL),m=d.useRef(t),p=d.useRef(s),u=d.useRef(r),y=d.useRef(i),v=d.useRef(null);d.useEffect(()=>{m.current=t},[t]),d.useEffect(()=>{p.current=s},[s]),d.useEffect(()=>{u.current=r},[r]),d.useEffect(()=>{y.current=i},[i]);const h=Object.values(l)[0],P=h?`${h.id}:${h.symbol}:${h.entryPrice}:${h.action}`:"";d.useEffect(()=>{if(!h||h.slPrice==null)return;v.current=h.slPrice,(!u.current||u.current<=0)&&(u.current=h.entryPrice);const g=h.action==="BUY",T=rt.getInstance().subscribe(h.symbol,e,"LTP",k=>{const M=k.data.ltp;if(!M||M<=0)return;const V=g?Math.max(u.current||h.entryPrice,M):Math.min(u.current||h.entryPrice,M);V!==u.current&&(u.current=V,a(V));const F=p.current,S=mi(F,h.entryPrice,M,V,g,m.current,y.current);S.newStage!==F&&(p.current=S.newStage,o(S.newStage));const x=Math.round(S.newSL/.05)*.05,E=Y.getState().virtualTPSL[h.id]?.slPrice??null,R=E==null||Math.abs(x-E)>=.05,z=v.current==null||Math.abs(x-v.current)>=.05;R&&z&&(v.current=x,c(h.id,{slPrice:x}))});return()=>{T(),v.current=null}},[h,P,e,o,a,c])}function Yt(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Ie(e){return Yt(e)??0}function bi(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function vi(e){const t=Yt(e.pnl);if(t!==null)return t;const s=Ie(e.ltp),r=Ie(e.average_price),i=Math.abs(Ie(e.quantity));return(Ie(e.quantity)>0?s-r:r-s)*i}function Si(){const e=le(g=>g.apiKey),t=le(g=>g.setApiKey),[s,r]=d.useState([]),[i,o]=d.useState(!1),a=d.useCallback(async()=>{if(e)return e;try{const C=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(C.status==="success"&&C.api_key)return t(C.api_key),C.api_key}catch{}return null},[e,t]),l=d.useCallback(async()=>{const g=await a();if(!g){o(!1);return}o(!0);try{const C=await oe.getPositions(g);C.status==="success"&&C.data&&r(Array.isArray(C.data)?C.data:[])}catch{}finally{o(!1)}},[a]);d.useEffect(()=>{l();const g=setInterval(l,1e4);return()=>clearInterval(g)},[l]);const{data:c,isLive:m,isPaused:p}=Cs(s,{enabled:s.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),u=d.useMemo(()=>c.flatMap(g=>{const C=bi(g.symbol);if(!C)return[];const T=Ie(g.quantity),k=Math.abs(T);if(k===0)return[];const M=Ie(g.ltp),V=Ie(g.average_price),F=T>0,S=F?M-V:V-M,E=Yt(g.pnl)??S*k;return[{symbol:g.symbol,exchange:g.exchange,side:C,action:F?"BUY":"SELL",quantity:k,avgPrice:V,ltp:M,pnl:E,pnlPoints:S,product:g.product}]}),[c]),y=d.useMemo(()=>s.some(g=>Ie(g.quantity)!==0),[s]),v=d.useMemo(()=>c.reduce((g,C)=>g+vi(C),0),[c]),h=d.useCallback(g=>u.find(C=>C.side===g),[u]),P=d.useMemo(()=>s.map(g=>({symbol:g.symbol,exchange:g.exchange})),[s]);return{positions:u,totalPnl:v,isLive:m&&y,isPaused:p,isLoading:i,refetch:l,getPositionForSide:h,positionSymbols:P}}function Di(){const[e,t]=d.useState(!1),s=d.useCallback(()=>t(x=>!x),[]),r=d.useCallback(()=>t(!1),[]),i=j(x=>x.paperMode),o=j(x=>x.optionExchange),a=j(x=>x.product),l=j(x=>x.quantity),c=j(x=>x.lotSize),m=j(x=>x.selectedCESymbol),p=j(x=>x.selectedPESymbol),u=Y(x=>x.virtualTPSL),y=Y(x=>x.triggerOrders),v=Y(x=>x.clearTriggerOrders),h=le(x=>x.apiKey),P=le(x=>x.setApiKey);d.useEffect(()=>{h||fetch("/api/websocket/apikey",{credentials:"include"}).then(x=>x.json()).then(x=>{x.status==="success"&&x.api_key&&P(x.api_key)}).catch(()=>{})},[h,P]),d.useEffect(()=>{v()},[v]);const g=d.useCallback(async(x,E)=>{if(i){console.log(`[Paper] Close ${x} ${E}`);return}try{await oe.closePosition(E,o,a),console.log(`[Scalping] Closed ${x} ${E}`)}catch(R){console.error("[Scalping] Close failed:",R)}},[i,o,a]),C=d.useCallback(async()=>{if(i){console.log("[Paper] Close all positions");return}try{await oe.closeAllPositions(),console.log("[Scalping] Closed all positions")}catch(x){console.error("[Scalping] Close all failed:",x)}},[i]),T=d.useCallback(async(x,E)=>{if(i){console.log(`[Paper] Reverse ${x} ${E}`);return}if(h)try{await oe.closePosition(E,o,a),await oe.placeOrder({apikey:h,strategy:"Scalping",exchange:o,symbol:E,action:"SELL",quantity:l*c,pricetype:"MARKET",product:a,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${x} ${E}`)}catch(R){console.error("[Scalping] Reversal failed:",R)}},[i,h,o,a,l,c]);si({onToggleHelp:s,onClose:g,onCloseAll:C,onReversal:T}),ii();const k=d.useMemo(()=>{const x=[];m&&x.push({symbol:m,exchange:o}),p&&x.push({symbol:p,exchange:o});for(const R of Object.values(u))x.push({symbol:R.symbol,exchange:R.exchange});for(const R of Object.values(y))x.push({symbol:R.symbol,exchange:R.exchange});const E=new Map;for(const R of x)E.set(`${R.exchange}:${R.symbol}`,R);return Array.from(E.values())},[m,p,o,u,y]),{data:M}=Dn({symbols:k,mode:"LTP",enabled:k.length>0}),{positions:V,totalPnl:F,isLive:S}=Si();return hi(M),yi(),gi(M),n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsx(or,{liveOpenPnl:F,isLivePnl:S}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:n.jsxs(At,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[n.jsx(Fe,{defaultSize:20,minSize:12,maxSize:36,children:n.jsx(dr,{})}),n.jsx(jt,{withHandle:!0,className:"bg-border/70"}),n.jsx(Fe,{defaultSize:50,minSize:30,children:n.jsx(Or,{})}),n.jsx(jt,{withHandle:!0,className:"bg-border/70"}),n.jsx(Fe,{defaultSize:30,minSize:18,maxSize:42,children:n.jsx(ei,{liveOpenPnl:F,isLivePnl:S})})]})}),n.jsx(ur,{positions:V,totalPnl:F,isLivePnl:S}),n.jsx(ni,{open:e,onClose:r})]})}export{Di as default};
