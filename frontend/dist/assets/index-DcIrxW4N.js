import{r as u,j as s}from"./vendor-react-CCyQGCED.js";import{c as De,v as Zn,$ as Fn,a3 as Dn,d as Ne,e as Ce,u as Fs,M as qt,B as ge,w as We,t as hr}from"./index-C6mW-S7J.js";import{aU as gr}from"./vendor-icons-CCn_k3dF.js";import{u as Ds}from"./useQuery-Dyi4lDFD.js";import{S as vn,a as Sn,b as Pn,c as jn,d as Qt}from"./select-CFgpE2WL.js";import{u as yr}from"./useOptionChainLive-B1bJW7x5.js";import{q as zs,K as Vs,W as _s,R as Bs,n as it,h as Xe}from"./lightweight-charts.production-fmEoZjtL.js";import{t as he}from"./trading-BQsFIo0D.js";import{a as qs}from"./useMarketStatus-Uz9bTNzH.js";import{I as at}from"./input-QT7OR2Db.js";import{L as qe}from"./label-gJML_ITX.js";import{S as zt}from"./switch-DVkWqy4N.js";import{f as br,r as vr,a as Sr,b as Pr}from"./ai-scalper-BCssOHnB.js";import{u as jr}from"./useLivePrice-CR8WGgUB.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";function ve(e,t="Assertion error"){if(!e)throw Error(t)}function kt({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function In(e,t){return t.sort(e==="horizontal"?Nr:wr)}function Nr(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function wr(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function Gs(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function Ws(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Cr({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:l,y:c}=Ws(r,o),d=e==="horizontal"?l:c;d<a&&(a=d,i=o)}return ve(i,"No rect found"),i}let Jt;function Er(){return Jt===void 0&&(typeof matchMedia=="function"?Jt=!!matchMedia("(pointer:coarse)").matches:Jt=!1),Jt}function Ks(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=In(n,Array.from(t.children).filter(Gs).map(p=>({element:p}))).map(({element:p})=>p),o=[];let l=!1,c,d=[];for(const p of a)if(p.hasAttribute("data-panel")){const m=r.find(g=>g.element===p);if(m){if(c){const g=c.element.getBoundingClientRect(),P=p.getBoundingClientRect();let x;if(l){const f=n==="horizontal"?new DOMRect(g.right,g.top,0,g.height):new DOMRect(g.left,g.bottom,g.width,0),v=n==="horizontal"?new DOMRect(P.left,P.top,0,P.height):new DOMRect(P.left,P.top,P.width,0);switch(d.length){case 0:{x=[f,v];break}case 1:{const j=d[0],E=Cr({orientation:n,rects:[g,P],targetRect:j.element.getBoundingClientRect()});x=[j,E===g?v:f];break}default:{x=d;break}}}else d.length?x=d:x=[n==="horizontal"?new DOMRect(g.right,P.top,P.left-g.right,P.height):new DOMRect(P.left,g.bottom,P.width,P.top-g.bottom)];for(const f of x){let v="width"in f?f:f.element.getBoundingClientRect();const j=Er()?37:27;if(v.width<j){const E=j-v.width;v=new DOMRect(v.x-E/2,v.y,v.width+E,v.height)}if(v.height<j){const E=j-v.height;v=new DOMRect(v.x,v.y-E/2,v.width,v.height+E)}o.push({group:e,groupSize:kt({group:e}),panels:[c,m],separator:"width"in f?void 0:f,rect:v})}}l=!1,c=m,d=[]}}else if(p.hasAttribute("data-separator")){const m=i.find(g=>g.element===p);m?d.push(m):(c=void 0,d=[])}else l=!0;return o}function Tr(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function kr(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function Lr(e){return e/100*window.innerHeight}function Mr(e){return e/100*window.innerWidth}function Rr(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function en({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=Rr(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=kr(t,i);break}case"em":{r=Tr(t,i);break}case"vh":{r=Lr(i);break}case"vw":{r=Mr(i);break}}return r}function Ke(e){return parseFloat(e.toFixed(3))}function Xn(e){const{panels:t}=e,n=kt({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const p=en({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=Ke(p/n*100)}let l;if(a.defaultSize!==void 0){const p=en({groupSize:n,panelElement:i,styleProp:a.defaultSize});l=Ke(p/n*100)}let c=0;if(a.minSize!==void 0){const p=en({groupSize:n,panelElement:i,styleProp:a.minSize});c=Ke(p/n*100)}let d=100;if(a.maxSize!==void 0){const p=en({groupSize:n,panelElement:i,styleProp:a.maxSize});d=Ke(p/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:l,minSize:c,maxSize:d,panelId:r.id}})}class Ir{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let l=0;l<o.length;l++){const c=o[l];try{c.call(null,n)}catch(d){a===null&&(i=!0,a=d)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function Re(e,t,n=0){return Math.abs(Ke(e)-Ke(t))<=n}let Be={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const mt=new Ir;function ze(){return Be}function Ae(e){const t=typeof e=="function"?e(Be):e;if(Be===t)return Be;const n=Be;return Be={...Be,...t},t.cursorFlags!==void 0&&mt.emit("cursorFlagsChange",Be.cursorFlags),t.interactionState!==void 0&&mt.emit("interactionStateChange",Be.interactionState),t.mountedGroups!==void 0&&(Be.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const l=Re(a.collapsedSize,r.layout[a.panelId]),c=Re(a.collapsedSize,o[a.panelId]);l&&!c&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),mt.emit("mountedGroupsChange",Be.mountedGroups)),Be}function $r(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=Ws(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function Ar(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function Or(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:es(e),b:es(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;ve(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:Jn(Qn(n.a)),b:Jn(Qn(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let l=a.length;for(;l--;){const c=a[l];if(c===o.a)return 1;if(c===o.b)return-1}}return Math.sign(i.a-i.b)}const Fr=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function Dr(e){const t=getComputedStyle(Us(e)??e).display;return t==="flex"||t==="inline-flex"}function zr(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||Dr(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||Fr.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function Qn(e){let t=e.length;for(;t--;){const n=e[t];if(ve(n,"Missing node"),zr(n))return n}return null}function Jn(e){return e&&Number(getComputedStyle(e).zIndex)||0}function es(e){const t=[];for(;e;)t.push(e),e=Us(e);return t}function Us(e){const{parentNode:t}=e;return Ar(t)?t.host:t}function Vr(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function _r({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!Gs(n)||n.contains(e)||e.contains(n))return!0;if(Or(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(Vr(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function zn(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=Ks(i),o=$r(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&_r({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function Br(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function Gt(e,t){return Re(e,t)?0:e>t?1:-1}function Tt({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(Gt(t,a)<0)if(r){const o=(n+a)/2;Gt(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=Ke(t),t}function Wt({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if(Re(e,0))return t;const o=Object.values(t),l=Object.values(i),c=[...o],[d,p]=r;ve(d!=null,"Invalid first pivot index"),ve(p!=null,"Invalid second pivot index");let m=0;if(a==="keyboard"){{const x=e<0?p:d,f=n[x];ve(f,`Panel constraints not found for index ${x}`);const{collapsedSize:v=0,collapsible:j,minSize:E=0}=f;if(j){const M=o[x];if(ve(M!=null,`Previous layout not found for panel index ${x}`),Re(M,v)){const $=E-M;Gt($,Math.abs(e))>0&&(e=e<0?0-$:$)}}}{const x=e<0?d:p,f=n[x];ve(f,`No panel constraints found for index ${x}`);const{collapsedSize:v=0,collapsible:j,minSize:E=0}=f;if(j){const M=o[x];if(ve(M!=null,`Previous layout not found for panel index ${x}`),Re(M,E)){const $=M-v;Gt($,Math.abs(e))>0&&(e=e<0?0-$:$)}}}}{const x=e<0?1:-1;let f=e<0?p:d,v=0;for(;;){const E=o[f];ve(E!=null,`Previous layout not found for panel index ${f}`);const M=Tt({panelConstraints:n[f],size:100})-E;if(v+=M,f+=x,f<0||f>=n.length)break}const j=Math.min(Math.abs(e),Math.abs(v));e=e<0?0-j:j}{let x=e<0?d:p;for(;x>=0&&x<n.length;){const f=Math.abs(e)-Math.abs(m),v=o[x];ve(v!=null,`Previous layout not found for panel index ${x}`);const j=v-f,E=Tt({panelConstraints:n[x],size:j});if(!Re(v,E)&&(m+=v-E,c[x]=E,m.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?x--:x++}}if(Br(l,c))return i;{const x=e<0?p:d,f=o[x];ve(f!=null,`Previous layout not found for panel index ${x}`);const v=f+m,j=Tt({panelConstraints:n[x],size:v});if(c[x]=j,!Re(j,v)){let E=v-j,M=e<0?p:d;for(;M>=0&&M<n.length;){const $=c[M];ve($!=null,`Previous layout not found for panel index ${M}`);const O=$+E,F=Tt({panelConstraints:n[M],size:O});if(Re($,F)||(E-=F-$,c[M]=F),Re(E,0))break;e>0?M--:M++}}}const g=Object.values(c).reduce((x,f)=>f+x,0);if(!Re(g,100,.1))return i;const P=Object.keys(i);return c.reduce((x,f,v)=>(x[P[v]]=f,x),{})}function ft(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||Gt(e[n],t[n])!==0)return!1;return!0}function xt({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,l)=>o+l,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!Re(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const l=n[o];ve(l!=null,`No layout data found for index ${o}`);const c=100/r*l;n[o]=c}let i=0;for(let o=0;o<t.length;o++){const l=n[o];ve(l!=null,`No layout data found for index ${o}`);const c=Tt({panelConstraints:t[o],size:l});l!=c&&(i+=l-c,n[o]=c)}if(!Re(i,0))for(let o=0;o<t.length;o++){const l=n[o];ve(l!=null,`No layout data found for index ${o}`);const c=l+i,d=Tt({panelConstraints:t[o],size:c});if(l!==d&&(i-=d-l,n[o]=d,Re(i,0)))break}const a=Object.keys(e);return n.reduce((o,l,c)=>(o[a[c]]=l,o),{})}function Hs({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:l}=ze();for(const[c,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:m,separatorToPanels:g}]of l)if(c.id===e)return{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:c,layout:m,separatorToPanels:g};throw Error(`Group ${e} not found`)},r=()=>{const l=n().derivedPanelConstraints.find(c=>c.panelId===t);if(l!==void 0)return l;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const l=n().group.panels.find(c=>c.id===t);if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const l=n().layout[t];if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},o=l=>{const c=a();if(l===c)return;const{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:m,layout:g,separatorToPanels:P}=n(),x=m.panels.findIndex(E=>E.id===t),f=x===m.panels.length-1,v=Wt({delta:f?c-l:l-c,initialLayout:g,panelConstraints:p,pivotIndices:f?[x-1,x]:[x,x+1],prevLayout:g,trigger:"imperative-api"}),j=xt({layout:v,panelConstraints:p});ft(g,j)||Ae(E=>({mountedGroups:new Map(E.mountedGroups).set(m,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:j,separatorToPanels:P})}))};return{collapse:()=>{const{collapsible:l,collapsedSize:c}=r(),{mutableValues:d}=i(),p=a();l&&p!==c&&(d.expandToSize=p,o(c))},expand:()=>{const{collapsible:l,collapsedSize:c,minSize:d}=r(),{mutableValues:p}=i(),m=a();if(l&&m===c){let g=p.expandToSize??d;g===0&&(g=1),o(g)}},getSize:()=>{const{group:l}=n(),c=a(),{element:d}=i(),p=l.orientation==="horizontal"?d.offsetWidth:d.offsetHeight;return{asPercentage:c,inPixels:p}},isCollapsed:()=>{const{collapsible:l,collapsedSize:c}=r(),d=a();return l&&Re(c,d)},resize:l=>{if(a()!==l){let c;switch(typeof l){case"number":{const{group:d}=n(),p=kt({group:d});c=Ke(l/p*100);break}case"string":{c=parseFloat(l);break}}o(c)}}}}function ts(e){if(e.defaultPrevented)return;const{mountedGroups:t}=ze(),n=zn(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(l=>l.panelConstraints.defaultSize!==void 0);if(o){const l=o.panelConstraints.defaultSize,c=Hs({groupId:a.group.id,panelId:o.id});c&&l!==void 0&&(c.resize(l),e.preventDefault())}}})}function ln(e){const{mountedGroups:t}=ze();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function Ys({groupId:e}){const t=()=>{const{mountedGroups:n}=ze();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:l}=t(),c=xt({layout:n,panelConstraints:i});return r?o:(ft(o,c)||Ae(d=>({mountedGroups:new Map(d.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:c,separatorToPanels:l})})),c)}}}function Zs(e){const{mountedGroups:t}=ze(),n=t.get(e);return ve(n,`Mounted Group ${e.id} not found`),n}function ut(e,t){const n=ln(e),r=Zs(n),i=n.separators.find(p=>p.element===e);ve(i,"Matching separator not found");const a=r.separatorToPanels.get(i);ve(a,"Matching panels not found");const o=a.map(p=>n.panels.indexOf(p)),l=Ys({groupId:n.id}).getLayout(),c=Wt({delta:t,initialLayout:l,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:l,trigger:"keyboard"}),d=xt({layout:c,panelConstraints:r.derivedPanelConstraints});ft(l,d)||Ae(p=>({mountedGroups:new Map(p.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:d,separatorToPanels:r.separatorToPanels})}))}function ns(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=ln(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&ut(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&ut(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&ut(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&ut(t,-5);break}case"End":{e.preventDefault(),ut(t,100);break}case"Enter":{e.preventDefault();const r=ln(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=Zs(r),l=r.separators.find(m=>m.element===t);ve(l,"Matching separator not found");const c=o.get(l);ve(c,"Matching panels not found");const d=c[0],p=i.find(m=>m.panelId===d.id);if(ve(p,"Panel metadata not found"),p.collapsible){const m=a[d.id],g=p.collapsedSize===m?r.inMemoryLastExpandedPanelSizes[d.id]??p.minSize:p.collapsedSize;ut(t,g-m)}break}case"F6":{e.preventDefault();const r=ln(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);ve(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),ut(t,-100);break}}}function ss(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=ze(),n=zn(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let l=!1;n.forEach(c=>{r.add(c.group),c.panels.forEach(p=>{i.add(p)}),c.separator&&(a.add(c.separator),l||(l=!0,c.separator.element.focus()));const d=t.get(c.group);d&&o.set(c.group,d.layout)}),Ae({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const qr=e=>e,Nn=()=>{},Xs=1,Qs=2,Js=4,er=8,rs=3,is=12;let tn;function as(){return tn===void 0&&(tn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(tn=!0)),tn}function Gr({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&as()){const a=(e&Xs)!==0,o=(e&Qs)!==0,l=(e&Js)!==0,c=(e&er)!==0;if(a)return l?"se-resize":c?"ne-resize":"e-resize";if(o)return l?"sw-resize":c?"nw-resize":"w-resize";if(l)return"s-resize";if(c)return"n-resize"}break}}return as()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const os=new WeakMap;function Vn(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=os.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=ze();switch(i.state){case"active":case"hover":{const a=Gr({cursorFlags:r,groups:i.hitRegions.map(l=>l.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}os.set(e,{prevStyle:t,styleSheet:n})}function tr({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let l=0;const c=new Map(i);n.forEach(p=>{const{group:m,groupSize:g}=p,{disableCursor:P,orientation:x,panels:f}=m;let v=0;a?x==="horizontal"?v=(t.clientX-a.x)/g*100:v=(t.clientY-a.y)/g*100:x==="horizontal"?v=t.clientX<0?-100:100:v=t.clientY<0?-100:100;const j=r.get(m),{defaultLayoutDeferred:E,derivedPanelConstraints:M,layout:$,separatorToPanels:O}=i.get(m)??{defaultLayoutDeferred:!1};if(M&&j&&$&&O){const F=Wt({delta:v,initialLayout:j,panelConstraints:M,pivotIndices:p.panels.map(L=>f.indexOf(L)),prevLayout:$,trigger:"mouse-or-touch"});if(ft(F,$)){if(v!==0&&!P)switch(x){case"horizontal":{l|=v<0?Xs:Qs;break}case"vertical":{l|=v<0?Js:er;break}}}else{c.set(p.group,{defaultLayoutDeferred:E,derivedPanelConstraints:M,layout:F,separatorToPanels:O});const L=p.group.panels.map(({id:I})=>I).join(",");p.group.inMemoryLayouts[L]=F}}});let d=0;t.movementX===0?d|=o&rs:d|=l&rs,t.movementY===0?d|=o&is:d|=l&is,Ae({cursorFlags:d,mountedGroups:c}),Vn(e)}function ls(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=ze();n.state==="active"&&tr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function cs(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=ze();switch(n.state){case"active":{if(e.buttons===0){Ae(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),Ae(i=>({mountedGroups:new Map(i.mountedGroups)}));return}tr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=zn(e,r);i.length===0?n.state!=="inactive"&&Ae({interactionState:{state:"inactive"}}):Ae({interactionState:{hitRegions:i,state:"hover"}}),Vn(e.currentTarget);break}}}function ds(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=ze();t.state==="active"&&(Ae({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(Vn(e.currentTarget),Ae(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function us(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=Ke(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=Ke((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function Wr(e,t,n){if(!n[0])return;const r=e.panels.find(c=>c.element===t);if(!r||!r.onResize)return;const i=kt({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,l={asPercentage:Ke(a/i*100),inPixels:a};r.mutableValues.prevSize=l,r.onResize(l,r.id,o)}function Kr(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function Ur(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const Nt=new Map;function Hr(e){let t=!0;ve(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(x=>{for(const f of x){const{borderBoxSize:v,target:j}=f;if(j===e.element){if(t){if(kt({group:e})===0)return;Ae(E=>{const M=E.mountedGroups.get(e);if(M){const $=Xn(e),O=M.defaultLayoutDeferred?us($):M.layout,F=xt({layout:O,panelConstraints:$});return!M.defaultLayoutDeferred&&ft(O,F)&&Kr(M.derivedPanelConstraints,$)?E:{mountedGroups:new Map(E.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:$,layout:F,separatorToPanels:M.separatorToPanels})}}return E})}}else Wr(e,j,v)}});a.observe(e.element),e.panels.forEach(x=>{ve(!r.has(x.id),`Panel ids must be unique; id "${x.id}" was used more than once`),r.add(x.id),x.onResize&&a.observe(x.element)});const o=kt({group:e}),l=Xn(e),c=e.panels.map(({id:x})=>x).join(",");let d=e.defaultLayout;d&&(Ur(e.panels,d)||(d=void 0));const p=e.inMemoryLayouts[c]??d??us(l),m=xt({layout:p,panelConstraints:l}),g=Ks(e),P=e.element.ownerDocument;return Ae(x=>{const f=new Map;return Nt.set(P,(Nt.get(P)??0)+1),g.forEach(v=>{v.separator&&f.set(v.separator,v.panels)}),{mountedGroups:new Map(x.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:l,layout:m,separatorToPanels:f})}}),e.separators.forEach(x=>{ve(!i.has(x.id),`Separator ids must be unique; id "${x.id}" was used more than once`),i.add(x.id),x.element.addEventListener("keydown",ns)}),Nt.get(P)===1&&(P.addEventListener("dblclick",ts,!0),P.addEventListener("pointerdown",ss,!0),P.addEventListener("pointerleave",ls),P.addEventListener("pointermove",cs),P.addEventListener("pointerup",ds,!0)),function(){t=!1,Nt.set(P,Math.max(0,(Nt.get(P)??0)-1)),Ae(x=>{const f=new Map(x.mountedGroups);return f.delete(e),{mountedGroups:f}}),e.separators.forEach(x=>{x.element.removeEventListener("keydown",ns)}),Nt.get(P)||(P.removeEventListener("dblclick",ts,!0),P.removeEventListener("pointerdown",ss,!0),P.removeEventListener("pointerleave",ls),P.removeEventListener("pointermove",cs),P.removeEventListener("pointerup",ds,!0)),a.disconnect()}}function nr(){const[e,t]=u.useState({}),n=u.useCallback(()=>t({}),[]);return[e,n]}function _n(e){const t=u.useId();return`${e??t}`}const gt=typeof window<"u"?u.useLayoutEffect:u.useEffect;function Bt(e){const t=u.useRef(e);return gt(()=>{t.current=e},[e]),u.useCallback((...n)=>t.current?.(...n),[t])}function Bn(...e){return Bt(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function Yr(e){const t=u.useRef({...e});return gt(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const sr=u.createContext(null);function Zr(e,t){const n=u.useRef({getLayout:()=>({}),setLayout:qr});u.useImperativeHandle(t,()=>n.current,[]),gt(()=>{Object.assign(n.current,Ys({groupId:e}))})}function rr({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:l,onLayoutChange:c,onLayoutChanged:d,orientation:p="horizontal",style:m,...g}){const P=u.useRef({onLayoutChange:{},onLayoutChanged:{}}),x=Bt(B=>{ft(P.current.onLayoutChange,B)||(P.current.onLayoutChange=B,c?.(B))}),f=Bt(B=>{ft(P.current.onLayoutChanged,B)||(P.current.onLayoutChanged=B,d?.(B))}),v=_n(l),j=u.useRef(null),[E,M]=nr(),$=u.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),O=Bn(j,a);Zr(v,o);const F=Bt((B,H)=>{const{interactionState:G,mountedGroups:Y}=ze();for(const R of Y.keys())if(R.id===B){const U=Y.get(R);if(U){let y=!1;return G.state==="active"&&(y=G.hitRegions.some(k=>k.group===R)),{flexGrow:U.layout[H]??1,pointerEvents:y?"none":void 0}}}return{flexGrow:n?.[H]??1}}),L=u.useMemo(()=>({getPanelStyles:F,id:v,orientation:p,registerPanel:B=>{const H=$.current;return H.panels=In(p,[...H.panels,B]),M(),()=>{H.panels=H.panels.filter(G=>G!==B),M()}},registerSeparator:B=>{const H=$.current;return H.separators=In(p,[...H.separators,B]),M(),()=>{H.separators=H.separators.filter(G=>G!==B),M()}}}),[F,v,M,p]),I=Yr({defaultLayout:n,disableCursor:r}),w=u.useRef(null);return gt(()=>{const B=j.current;if(B===null)return;const H=$.current,G={defaultLayout:I.defaultLayout,disableCursor:!!I.disableCursor,disabled:!!i,element:B,id:v,inMemoryLastExpandedPanelSizes:$.current.lastExpandedPanelSizes,inMemoryLayouts:$.current.layouts,orientation:p,panels:H.panels,separators:H.separators};w.current=G;const Y=Hr(G),R=ze().mountedGroups.get(G);if(R){const{defaultLayoutDeferred:k,derivedPanelConstraints:Z,layout:z}=R;!k&&Z.length>0&&(x(z),f(z),H.panels.forEach(q=>{q.scheduleUpdate()}))}const U=mt.addListener("interactionStateChange",()=>{H.panels.forEach(k=>{k.scheduleUpdate()})}),y=mt.addListener("mountedGroupsChange",k=>{const Z=k.get(G);if(Z){const{defaultLayoutDeferred:z,derivedPanelConstraints:q,layout:h}=Z;if(z||q.length===0)return;const{interactionState:b}=ze(),C=b.state!=="active";x(h),C&&f(h),H.panels.forEach(D=>{D.scheduleUpdate()})}});return()=>{w.current=null,Y(),U(),y()}},[i,v,f,x,p,E,I]),u.useEffect(()=>{const B=w.current;B&&(B.defaultLayout=n,B.disableCursor=!!r)}),s.jsx(sr.Provider,{value:L,children:s.jsx("div",{...g,"aria-orientation":p,className:t,"data-group":!0,"data-testid":v,id:v,ref:O,style:{height:"100%",width:"100%",overflow:"hidden",...m,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}rr.displayName="Group";function qn(){const e=u.useContext(sr);return ve(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Xr(e,t){const{id:n}=qn(),r=u.useRef({collapse:Nn,expand:Nn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Nn});u.useImperativeHandle(t,()=>r.current,[]),gt(()=>{Object.assign(r.current,Hs({groupId:n,panelId:e}))})}function ir({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:l="100%",minSize:c="0%",onResize:d,panelRef:p,style:m,...g}){const P=!!o,x=_n(o),f=u.useRef(null),v=Bn(f,a),[,j]=nr(),{getPanelStyles:E,id:M,registerPanel:$}=qn(),O=d!==null,F=Bt((I,w,B)=>{d?.(I,o,B)});gt(()=>{const I=f.current;if(I!==null)return $({element:I,id:x,idIsStable:P,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:O?F:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:l,minSize:c},scheduleUpdate:j})},[n,r,i,j,O,x,P,l,c,F,$]),Xr(x,p);const L=E(M,x);return s.jsx("div",{...g,"data-panel":!0,"data-testid":x,id:x,ref:v,style:{...Qr,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...L},children:s.jsx("div",{className:t,style:{flexGrow:1,...m},children:e})})}ir.displayName="Panel";const Qr={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function Jr({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],l=t.find(c=>c.panelId===n);if(l){const c=l.maxSize,d=a=l.collapsible?l.collapsedSize:l.minSize,p=[r,r+1];a=xt({layout:Wt({delta:d-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=xt({layout:Wt({delta:c-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function ar({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=_n(r),[l,c]=u.useState({}),[d,p]=u.useState("inactive"),m=u.useRef(null),g=Bn(m,n),{id:P,orientation:x,registerSeparator:f}=qn(),v=x==="horizontal"?"vertical":"horizontal";return gt(()=>{const j=m.current;if(j!==null){const E={element:j,id:o},M=f(E),$=mt.addListener("interactionStateChange",F=>{p(F.state!=="inactive"&&F.hitRegions.some(L=>L.separator===E)?F.state:"inactive")}),O=mt.addListener("mountedGroupsChange",F=>{F.forEach(({derivedPanelConstraints:L,layout:I,separatorToPanels:w},B)=>{if(B.id===P){const H=w.get(E);if(H){const G=H[0],Y=B.panels.indexOf(G);c(Jr({layout:I,panelConstraints:L,panelId:G.id,panelIndex:Y}))}}})});return()=>{$(),O(),M()}}},[P,o,f]),s.jsx("div",{...a,"aria-controls":l.valueControls,"aria-orientation":v,"aria-valuemax":l.valueMax,"aria-valuemin":l.valueMin,"aria-valuenow":l.valueNow,children:e,className:t,"data-separator":d,"data-testid":o,id:o,ref:g,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}ar.displayName="Separator";function $n({className:e,...t}){return s.jsx(rr,{"data-slot":"resizable-panel-group",className:De("h-full w-full",e),...t})}function pt({className:e,...t}){return s.jsx(ir,{"data-slot":"resizable-panel",className:De("min-w-0 min-h-0",e),...t})}function dn({withHandle:e,className:t,...n}){return s.jsx(ar,{"data-slot":"resizable-handle",className:De("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(gr,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const ei={getOptionChain:async(e,t,n,r,i)=>(await Zn.post("/optionchain",{apikey:e,underlying:t,exchange:n,expiry_date:r,strike_count:i??20})).data,getExpiries:async(e,t,n,r="options")=>(await Zn.post("/expiry",{apikey:e,symbol:t,exchange:n,instrumenttype:r})).data},ti={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:10},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}},S=Fn()(Dn(e=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,setUnderlying:t=>{const n=ti[t];e({underlying:t,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:t=>e(n=>n.expiry===t?n:{expiry:t,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:t=>e(n=>n.expiryWeek===t?n:{expiryWeek:t}),setExpiries:t=>e(n=>n.expiries.length===t.length&&n.expiries.every((r,i)=>r===t[i])?n:{expiries:t}),setChainStrikeCount:t=>e(n=>{const r=Math.max(5,t);return n.chainStrikeCount===r?n:{chainStrikeCount:r}}),setSelectedStrike:t=>e(n=>n.selectedStrike===t?n:{selectedStrike:t}),setActiveSide:t=>e({activeSide:t}),toggleActiveSide:()=>e(t=>({activeSide:t.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(t,n)=>e(r=>r.selectedCESymbol===t&&r.selectedPESymbol===n?r:{selectedCESymbol:t,selectedPESymbol:n}),setOptionChainSnapshot:(t,n,r)=>e(i=>{const a=Number.isFinite(n)?n:Date.now(),o=typeof r=="boolean"?r:i.optionChainIsStreaming;return i.optionChainData===t&&i.optionChainLastUpdate===a&&i.optionChainIsStreaming===o?i:{optionChainData:t,optionChainLastUpdate:a,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>e(t=>t.optionChainData===null&&t.optionChainLastUpdate===0&&!t.optionChainIsStreaming?t:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:t=>e({quantity:Math.max(1,t)}),incrementQuantity:()=>e(t=>({quantity:t.quantity+1})),decrementQuantity:()=>e(t=>({quantity:Math.max(1,t.quantity-1)})),setOrderType:t=>e({orderType:t,...t==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:t=>e({product:t}),setTpPoints:t=>e({tpPoints:Math.max(0,t)}),setSlPoints:t=>e({slPoints:Math.max(0,t)}),setLimitPrice:t=>e(n=>n.limitPrice===t?n:{limitPrice:t}),setPendingEntryAction:t=>e(n=>n.pendingEntryAction===t?n:{pendingEntryAction:t}),setPendingLimitPlacement:t=>e(n=>{if(t===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const r={...t,createdAt:t.createdAt??Date.now()},i=n.pendingLimitPlacement;return i&&i.symbol===r.symbol&&i.side===r.side&&i.action===r.action&&i.orderId===r.orderId&&i.quantity===r.quantity&&i.entryPrice===r.entryPrice&&i.tpPoints===r.tpPoints&&i.slPoints===r.slPoints?n:{pendingLimitPlacement:r}}),clearPendingLimitPlacement:()=>e(t=>t.pendingLimitPlacement===null?t:{pendingLimitPlacement:null}),setPaperMode:t=>e(n=>n.paperMode===t?n:{paperMode:t}),setControlTab:t=>e({controlTab:t}),setHotkeysEnabled:t=>e({hotkeysEnabled:t}),setShowFloatingWidget:t=>e({showFloatingWidget:t}),toggleFloatingWidget:()=>e(t=>({showFloatingWidget:!t.showFloatingWidget})),setFloatingWidgetMinimized:t=>e(n=>n.floatingWidgetMinimized===t?n:{floatingWidgetMinimized:t}),toggleFloatingWidgetMinimized:()=>e(t=>({floatingWidgetMinimized:!t.floatingWidgetMinimized})),setChainCollapsed:t=>e({chainCollapsed:t}),setControlCollapsed:t=>e({controlCollapsed:t}),setCeWidgetPos:t=>e({ceWidgetPos:t}),setPeWidgetPos:t=>e({peWidgetPos:t}),setLotSize:t=>e({lotSize:t}),setChartInterval:t=>e({chartInterval:t}),addSessionPnl:t=>e(n=>({sessionPnl:n.sessionPnl+t})),incrementTradeCount:()=>e(t=>({tradeCount:t.tradeCount+1})),resetSession:()=>e({sessionPnl:0,tradeCount:0})}),{name:"openalgo-scalping",partialize:e=>({underlying:e.underlying,expiryWeek:e.expiryWeek,chainStrikeCount:e.chainStrikeCount,quantity:e.quantity,orderType:e.orderType,product:e.product,tpPoints:e.tpPoints,slPoints:e.slPoints,paperMode:e.paperMode,hotkeysEnabled:e.hotkeysEnabled,showFloatingWidget:e.showFloatingWidget,floatingWidgetMinimized:e.floatingWidgetMinimized,chartInterval:e.chartInterval,ceWidgetPos:e.ceWidgetPos,peWidgetPos:e.peWidgetPos})})),ni=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],si=[10,15,20,25,30],wn="__none__";function ri(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function ii({liveOpenPnl:e,isLivePnl:t=!1}){const n=Ne(L=>L.apiKey),r=Ne(L=>L.user?.broker),i=S(L=>L.underlying),a=S(L=>L.optionExchange),o=S(L=>L.expiryWeek),l=S(L=>L.expiry),c=S(L=>L.expiries),d=S(L=>L.chainStrikeCount),p=S(L=>L.paperMode),m=S(L=>L.sessionPnl),g=S(L=>L.tradeCount),P=S(L=>L.setUnderlying),x=S(L=>L.setExpiryWeek),f=S(L=>L.setExpiry),v=S(L=>L.setExpiries),j=S(L=>L.setChainStrikeCount),E=S(L=>L.setPaperMode),M=p?m:e??m,$=l&&c.includes(l)?l:wn,{data:O}=Ds({queryKey:["scalping-expiries",i,a],queryFn:()=>ei.getExpiries(n,i,a),enabled:!!n,staleTime:300*1e3});u.useEffect(()=>{if(O?.status!=="success")return;const L=O.data??[];if(ri(c,L)||v(L),L.length===0){l&&f("");return}if(!l||!L.includes(l)){const I=o==="next"?Math.min(1,L.length-1):0,w=L[I],B=I<=0?"current":"next";l!==w&&f(w),o!==B&&x(B)}},[O,o,c,l,v,f,x]);const F=L=>{if(L===wn)return;l!==L&&f(L);const w=c.indexOf(L)<=0?"current":"next";o!==w&&x(w)};return s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(vn,{value:i,onValueChange:L=>P(L),children:[s.jsx(Sn,{className:"h-7 w-[128px] text-xs font-semibold",children:s.jsx(Pn,{})}),s.jsx(jn,{children:ni.map(L=>s.jsx(Qt,{value:L,children:L},L))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(vn,{value:$,onValueChange:F,disabled:c.length===0,children:[s.jsx(Sn,{className:"h-7 w-[122px] text-xs font-mono",children:s.jsx(Pn,{placeholder:"Select expiry"})}),s.jsxs(jn,{children:[s.jsx(Qt,{value:wn,disabled:!0,children:"Select expiry"}),c.map(L=>s.jsx(Qt,{value:L,children:L},L))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(vn,{value:String(d),onValueChange:L=>j(Number(L)),children:[s.jsx(Sn,{className:"h-7 w-[94px] text-xs",children:s.jsx(Pn,{})}),s.jsx(jn,{children:si.map(L=>s.jsx(Qt,{value:String(L),children:L},L))})]})]}),s.jsx("div",{className:"flex-1"}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>E(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${p?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>E(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),r&&s.jsx(Ce,{variant:"outline",className:"text-xs h-6",children:r}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${M>0?"text-green-500":M<0?"text-red-500":"text-foreground"}`,children:[M>=0?"+":"",M.toFixed(0)]}),!p&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),g>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",g,")"]})]})]})}function nn(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function ps({value:e,prevRef:t,className:n,format:r="price"}){const i=u.useRef(null);u.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const l=e>t.current?"flash-green":"flash-red";o.classList.add(l);const c=setTimeout(()=>o.classList.remove(l),300);return t.current=e,()=>clearTimeout(c)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:De("tabular-nums transition-colors",n),children:a})}function sn({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:De("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function ai(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const oi=u.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:l,onSelectStrike:c,onSelectCE:d,onSelectPE:p}){const m=u.useRef(n?.ltp??0),g=u.useRef(r?.ltp??0),P=Math.min(((n?.oi??0)/o+(n?.volume??0)/l)/2*100,100),x=Math.min(((r?.oi??0)/o+(r?.volume??0)/l)/2*100,100);return s.jsxs("div",{className:De("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(sn,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:nn(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(sn,{value:n?.volume??0,max:l,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:nn(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${P}%`}}),s.jsx(ps,{value:n?.ltp,prevRef:m,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:De("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>c(t,n?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${x}%`}}),s.jsx(ps,{value:r?.ltp,prevRef:g,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(sn,{value:r?.volume??0,max:l,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:nn(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(sn,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:nn(r?.oi)})]})]})},ai);function li(){const e=Ne(R=>R.apiKey),t=S(R=>R.underlying),n=S(R=>R.indexExchange),r=S(R=>R.optionExchange),i=S(R=>R.expiry),a=S(R=>R.selectedStrike),o=S(R=>R.selectedCESymbol),l=S(R=>R.selectedPESymbol),c=S(R=>R.chainStrikeCount),d=S(R=>R.setSelectedStrike),p=S(R=>R.setSelectedSymbols),m=S(R=>R.setActiveSide),g=S(R=>R.setLotSize),P=S(R=>R.setOptionChainSnapshot),x=u.useRef(null),f=u.useRef(null),v=u.useRef(!1),{data:j,isLoading:E,isStreaming:M,error:$,streamingSymbols:O,lastUpdate:F}=yr(e,t,n,r,i,c,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});u.useEffect(()=>{j&&P(j,F?.getTime()??Date.now(),M)},[j,F,M,P]),u.useEffect(()=>{if(!j?.chain?.length||v.current)return;const R=j.chain[0],U=R.ce?.lotsize??R.pe?.lotsize;U&&U>0&&(g(U),v.current=!0)},[j,g]),u.useEffect(()=>{v.current=!1},[t,i]),u.useEffect(()=>{if(j?.chain&&f.current&&x.current){const R=x.current,U=f.current,y=R.getBoundingClientRect(),k=U.getBoundingClientRect(),Z=k.top-y.top-y.height/2+k.height/2;R.scrollTop+=Z}},[j?.atm_strike]);const L=u.useCallback((R,U,y)=>{d(R),p(U,y)},[d,p]),I=u.useCallback((R,U)=>{U&&(d(R),p(U,l),m("CE"))},[l,m,d,p]),w=u.useCallback((R,U)=>{U&&(d(R),p(o,U),m("PE"))},[o,m,d,p]),{maxOI:B,maxVol:H}=u.useMemo(()=>{if(!j?.chain?.length)return{maxOI:1,maxVol:1};let R=0,U=0;for(const y of j.chain)y.ce?.oi&&y.ce.oi>R&&(R=y.ce.oi),y.pe?.oi&&y.pe.oi>R&&(R=y.pe.oi),y.ce?.volume&&y.ce.volume>U&&(U=y.ce.volume),y.pe?.volume&&y.pe.volume>U&&(U=y.pe.volume);return{maxOI:R||1,maxVol:U||1}},[j?.chain]),G=j?.underlying_ltp,Y=j?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(Ce,{variant:"outline",className:"text-[10px] h-4 px-1",children:[c," strikes"]}),G!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:G.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[M&&s.jsxs(Ce,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),O]}),E&&s.jsx(Ce,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:x,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[$&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:$}),!$&&!E&&j?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),j?.chain?.map(R=>{const U=R.strike===Y;return s.jsx("div",{ref:U?f:void 0,children:s.jsx(oi,{strike:R.strike,ce:R.ce,pe:R.pe,isATM:U,isSelected:R.strike===a,maxOI:B,maxVol:H,onSelectStrike:L,onSelectCE:I,onSelectPE:w})},R.strike)})]})]})}function ci({positions:e,totalPnl:t,isLivePnl:n}){const r=S(o=>o.activeSide),i=S(o=>o.hotkeysEnabled),a=S(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:""}),s.jsx("span",{children:"CE Mkt Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:""}),s.jsx("span",{children:"PE Mkt Buy"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const Lt=300*60+1800,ms=1440*60,Vt=540*60+900,fs=900*60+1800;function un(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function or(e){const t=un(e)+Lt,n=Math.floor(t/ms)*ms,r=t-n,i=(n-Lt)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function di(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),l=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(l))return null;const c=Date.UTC(n,r-1,i,a,o,l)-Lt*1e3;return Math.floor(c/1e3)}function ui(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-Lt*1e3;return Math.floor(a/1e3)}function Qe(e){if(typeof e=="number")return un(e);const t=ui(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return un(r);const i=di(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function Gn(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=or(e);if(r===0||r===6)return!1;const i=n>=Vt,a=t.includeClose?n<=fs:n<fs;return i&&a}function pi(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=or(e),a=i<=Vt?Vt:Vt+Math.floor((i-Vt)/n)*n;return r+a-Lt}function lr(e){const t=(un(e)+Lt)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function mi(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?pi(i,n):Math.floor(i/n)*n,l=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:l},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+l},!1]}function cr({symbol:e,exchange:t,intervalSec:n=1,enabled:r=!0,useIndiaMarketHours:i=!1,maxCandles:a=500,onCandleUpdate:o}){const l=u.useRef([]),c=u.useRef(null),d=u.useRef(null),p=u.useRef(o);p.current=o;const m=r&&e?[{symbol:e,exchange:t}]:[],{data:g,isConnected:P}=qs({symbols:m,mode:"LTP",enabled:r&&!!e});u.useEffect(()=>{if(!r||!e||g.size===0)return;const j=`${t}:${e}`,E=g.get(j);if(!E?.data?.ltp)return;const M=E.lastUpdate;if(!M||!Number.isFinite(M))return;const $=Math.floor(M/1e3);if(i&&!Gn($))return;const O=`${j}:${M}`;if(d.current===O)return;d.current=O;const F={price:E.data.ltp,volume:E.data.volume,timestamp:M},[L,I]=mi(F,c.current,n,{alignToIndiaSession:i});I&&c.current&&(l.current.push(c.current),l.current.length>a&&(l.current=l.current.slice(-a))),c.current=L,p.current?.(L,I)},[g,e,t,n,r,a,i]);const x=u.useCallback(()=>{const j=[...l.current];return c.current&&j.push(c.current),j},[]),f=u.useCallback(()=>{l.current=[],c.current=null,d.current=null},[]),v=u.useCallback(j=>{if(!j?.length){l.current=[],c.current=null;return}const E=j.slice(-a);if(E.length===1){l.current=[],c.current=E[0];return}l.current=E.slice(0,-1),c.current=E[E.length-1]},[a]);return{getCandles:x,reset:f,seed:v,isConnected:P}}function pn(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function dr(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=fi(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const l=e.length-r.length;let c=0,d=0,p=1;for(let m=0;m<r.length;m++){const g=e[l+m],P=(g.high+g.low)/2,x=r[m].value;let f=P+n*x,v=P-n*x;m>0&&(v>d||e[l+m-1].close<d||(v=d),f<c||e[l+m-1].close>c||(f=c));let j=p;m>0&&(p===1&&g.close<v?j=-1:p===-1&&g.close>f&&(j=1));const E=g.time;i.push({time:E,value:f}),a.push({time:E,value:v}),o.push({time:E,value:j===1?v:f}),c=f,d=v,p=j}return{upper:i,lower:a,trend:o}}function fi(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,l=e[a].low,c=e[a-1].close;r.push(Math.max(o-l,Math.abs(o-c),Math.abs(l-c)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function ur(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}function xi(e){return!Number.isFinite(e)||e<=0?1:e}function hi(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const n=Math.ceil(e/t)*t;return Math.max(t*2,n)}function pr(e,t){const n=xi(e),r=hi(t,n);return i=>{const a=i(),o=a?.priceRange;if(!a||!o)return a;const l=o.minValue,c=o.maxValue;if(!Number.isFinite(l)||!Number.isFinite(c))return a;const d=Math.min(l,c),p=Math.max(l,c),m=(d+p)/2;let g=p-d;(!Number.isFinite(g)||g<n)&&(g=n),g<r&&(g=r),g=Math.ceil(g/n)*n;const P=g/2,x=Math.floor((m-P)/n)*n;let f=Math.ceil((m+P)/n)*n;return f-x<g&&(f=x+g),{...a,priceRange:{minValue:x,maxValue:f}}}}const gi=120,Mt=500,yi=1,bi=50,vi=200;function rn(e){return e.map(t=>({time:t.time,value:t.value}))}function Si(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Pi(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function xs(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Le(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Wn(e){const t=Qe(e);return t??null}function ji(e){if(!e?.length)return[];const t=[];for(const a of e){const o=Qe(a.timestamp)??Qe(a.time)??Qe(a.datetime)??Qe(a.date),l=Le(a.open),c=Le(a.high),d=Le(a.low),p=Le(a.close),m=Le(a.volume)??0;o==null||l==null||c==null||d==null||p==null||t.push({time:o,open:l,high:c,low:d,close:p,volume:m})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-Mt),i=r.filter(a=>Gn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-Mt)}function wt(e){return e.map(t=>({...t}))}function Ni(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-Mt)}function Cn(e){const t=[];for(const n of e){const r=Wn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function hs(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=Wn(n.time),i=Le(n.open),a=Le(n.high),o=Le(n.low),l=Le(n.close),c=Le(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-Mt)}function wi({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=u.useRef(null),a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),d=u.useRef(null),p=u.useRef(null),m=u.useRef([]),g=u.useRef(new Map),P=u.useRef(null),x=u.useRef(0),f=u.useRef(null),v=u.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),j=Ne(y=>y.apiKey),E=Ne(y=>y.setApiKey),M=Fs(y=>y.mode==="dark"),$=S(y=>y.underlying),O=S(y=>y.indexExchange),F=S(y=>y.chartInterval),L=u.useCallback(()=>{const y=m.current,k=v.current,Z=y.map(z=>({time:z.time,value:z.close}));l.current&&l.current.setData(k.showEma9?rn(pn(Z,9)):[]),c.current&&c.current.setData(k.showEma21?rn(pn(Z,21)):[]),d.current&&d.current.setData(k.showSupertrend?rn(dr(y,10,3).trend):[]),p.current&&p.current.setData(k.showVwap?rn(ur(y)):[])},[]),I=u.useCallback(()=>{f.current===null&&(f.current=setTimeout(()=>{f.current=null,L()},gi))},[L]),w=u.useCallback(()=>{m.current=[],o.current?.setData([]),l.current?.setData([]),c.current?.setData([]),d.current?.setData([]),p.current?.setData([])},[]),B=u.useCallback(y=>{const k=hs(y);m.current=wt(k),o.current?.setData(Cn(k)),I()},[I]),H=u.useCallback(async()=>{if(j)return j;try{const k=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(k.status==="success"&&k.api_key)return E(k.api_key),k.api_key}catch{}return null},[j,E]),G=u.useCallback((y,k)=>{if(!o.current)return;const Z=Wn(y.time),z=Le(y.open),q=Le(y.high),h=Le(y.low),b=Le(y.close),C=Le(y.volume)??0;if(Z==null||z==null||q==null||h==null||b==null)return;const D={time:Z,open:z,high:q,low:h,close:b,volume:C},_=Number(D.time),X=m.current.length?Number(m.current[m.current.length-1].time):null;if(X!=null&&Number.isFinite(X)&&Number.isFinite(_)&&_<X)return;try{o.current.update({time:D.time,open:D.open,high:D.high,low:D.low,close:D.close})}catch{const ne=hs([...m.current,D]);m.current=ne,o.current.setData(Cn(ne)),I();return}k?(m.current.push(D),m.current.length>Mt&&(m.current=m.current.slice(-Mt))):m.current.length>0?m.current[m.current.length-1]=D:m.current.push(D);const ee=P.current;ee&&g.current.set(ee,wt(m.current)),I()},[I]),{isConnected:Y,reset:R,seed:U}=cr({symbol:$,exchange:O,intervalSec:F,enabled:!!$,useIndiaMarketHours:!0,onCandleUpdate:G});return u.useEffect(()=>{const y=P.current;if(y&&m.current.length>0&&g.current.set(y,wt(m.current)),!$){P.current=null,R(),w();return}const k=`${O}:${$}:${F}`;P.current=k;const Z=g.current.get(k);if(Z&&Z.length>0){R(),U(Z),B(Z);return}R(),w();const z=++x.current,q=Pi(F),h=new Date,b=new Date(h.getTime());b.setDate(b.getDate()-yi),(async()=>{const D=await H();if(!D){z===x.current&&w();return}try{const _=async()=>{try{const T=await he.getQuotes(D,$,O);if(T.status!=="success"||!T.data)return null;const se=Le(T.data.ltp);if(se==null||se<=0)return null;const Se=Math.floor(Date.now()/1e3);return{time:Math.floor(Se/F)*F,open:se,high:se,low:se,close:se,volume:Le(T.data.volume)??0}}catch{return null}},X=async T=>{try{const se=await he.getHistory(D,$,O,q,xs(b),xs(h),T);return se.status==="success"?ji(se.data):[]}catch{return[]}},ee=await X("api"),ne=ee.length>0?ee:await X("db");if(z!==x.current)return;const re=P.current===k?wt(m.current):[],ye=Ni(ne,re);if(ye.length>0){g.current.set(k,wt(ye)),U(ye),B(ye);return}const ue=await _();if(ue&&z===x.current){const T=[ue];g.current.set(k,wt(T)),U(T),B(T);return}}catch{}z===x.current&&w()})()},[$,O,F,H,R,U,w,B]),u.useEffect(()=>{v.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},l.current?.applyOptions({visible:e}),c.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),I()},[e,t,n,r,I]),u.useEffect(()=>{const y=i.current;if(!y)return;const k=Si(M),Z=pr(bi,vi),z=zs(y,{width:y.offsetWidth,height:y.offsetHeight,layout:{background:{type:_s.Solid,color:k.bg},textColor:k.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:k.grid},horzLines:{color:k.grid}},rightPriceScale:{borderColor:k.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:k.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:X=>lr(X)},crosshair:{mode:Vs.Normal,vertLine:{width:1,color:k.crosshair,style:2},horzLine:{width:1,color:k.crosshair,style:2}}}),q=z.addSeries(Bs,{upColor:k.upColor,downColor:k.downColor,borderVisible:!1,wickUpColor:k.upColor,wickDownColor:k.downColor,autoscaleInfoProvider:Z}),h=z.addSeries(it,{color:k.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showEma9,autoscaleInfoProvider:Z}),b=z.addSeries(it,{color:k.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showEma21,autoscaleInfoProvider:Z}),C=z.addSeries(it,{color:k.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showSupertrend,autoscaleInfoProvider:Z}),D=z.addSeries(it,{color:k.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:v.current.showVwap,autoscaleInfoProvider:Z});a.current=z,o.current=q,l.current=h,c.current=b,d.current=C,p.current=D,m.current.length>0&&(q.setData(Cn(m.current)),I());const _=new ResizeObserver(()=>{if(a.current&&y){const X=y.offsetWidth,ee=y.offsetHeight;X>0&&ee>0&&a.current.applyOptions({width:X,height:ee})}});return _.observe(y),()=>{f.current!==null&&(clearTimeout(f.current),f.current=null),_.disconnect(),z.remove(),a.current=null,o.current=null,l.current=null,c.current=null,d.current=null,p.current=null}},[M,I]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:$}),!Y&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const ie=Fn()(Dn((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).filter(i=>i.symbol===n).sort((i,a)=>a.createdAt-i.createdAt)[0],addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),gs=.05;function cn(e){return Math.round(e/gs)*gs}function _t(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:cn(e)}async function Rt({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=_t(n);if(a!=null)return a;const o=qt.getInstance(),l=_t(o.getCachedData(e,t)?.data?.ltp);if(l!=null)return l;const c=_t(r);if(c!=null)return c;if(i)try{const d=await he.getQuotes(i,e,t),p=_t(d.data?.ltp);if(p!=null)return p}catch{}return 0}function Ci(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Ei(e){return mn(e.orderid??e.order_id)}function Ti(e){const t=e.order_status??e.status??"";return String(t).trim().toUpperCase()}function ki(e){const t=[e.average_price,e.averageprice,e.fill_price,e.fillprice,e.traded_price,e.tradedprice,e.price];for(const n of t){const r=_t(Ci(n));if(r!=null)return r}return null}function Li(e){return new Promise(t=>{setTimeout(t,e)})}async function It({symbol:e,exchange:t,orderId:n=null,preferredPrice:r=null,fallbackPrice:i=null,apiKey:a=null,maxAttempts:o=5,retryDelayMs:l=250}){const c=mn(n);if(a&&c)for(let d=0;d<o;d+=1){try{const m=(await he.getOrders(a)).data?.orders;if(Array.isArray(m)){const g=m.find(P=>!P||typeof P!="object"?!1:Ei(P)===c);if(g&&typeof g=="object"){const P=g,x=Ti(P),f=ki(P),v=x.includes("COMPLETE")||x.includes("FILLED")||x.includes("EXECUTED")||x.includes("TRADED");if(f!=null&&(v||d===o-1))return f}}}catch{}d<o-1&&await Li(l)}return Rt({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:i,apiKey:a})}function Je({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:l,slPoints:c,createdAt:d=Date.now(),managedBy:p="manual",autoEntryScore:m,autoEntryReason:g}){const P=cn(a),x=Number(Math.max(0,l||0).toFixed(2)),f=Number(Math.max(0,c||0).toFixed(2)),v=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:P,quantity:o,tpPrice:x>0?cn(P+(v?x:-x)):null,slPrice:f>0?cn(P+(v?-f:f)):null,tpPoints:x,slPoints:f,createdAt:d,managedBy:p,autoEntryScore:m,autoEntryReason:g}}function mn(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function ht(e){if(!e||typeof e!="object")return null;const t=e,n=mn(t.orderid??t.order_id),r=t.data;if(!r||typeof r!="object")return n;const i=r;return mn(i.orderid??i.order_id)??n}const ys=.05,Mi=150;function Te(e){return Math.round(e/ys)*ys}function rt(e){return Number(Math.max(0,e).toFixed(2))}function bs(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?Te(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?Te(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function Ri({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=Ne(N=>N.apiKey),a=Ne(N=>N.setApiKey),o=S(N=>N.activeSide),l=S(N=>N.orderType),c=S(N=>N.tpPoints),d=S(N=>N.slPoints),p=S(N=>N.limitPrice),m=S(N=>N.pendingEntryAction),g=S(N=>N.pendingLimitPlacement),P=S(N=>N.quantity),x=S(N=>N.lotSize),f=S(N=>N.optionExchange),v=S(N=>N.product),j=S(N=>N.paperMode),E=S(N=>N.incrementTradeCount),M=S(N=>N.setLimitPrice),$=S(N=>N.setTpPoints),O=S(N=>N.setSlPoints),F=S(N=>N.setPendingEntryAction),L=S(N=>N.setPendingLimitPlacement),I=S(N=>N.clearPendingLimitPlacement),w=S(N=>n==="CE"?N.selectedCESymbol:N.selectedPESymbol),B=ie(N=>N.virtualTPSL),H=ie(N=>N.triggerOrders),G=ie(N=>N.addTriggerOrder),Y=ie(N=>N.updateTriggerOrder),R=ie(N=>N.removeTriggerOrder),U=ie(N=>N.setVirtualTPSL),y=ie(N=>N.clearForSymbol),k=ie(N=>N.updateVirtualTPSL),Z=u.useRef(null),z=u.useRef(null),q=u.useRef(null),h=u.useRef(null),b=u.useRef(null),C=u.useRef(null),D=u.useRef(null),_=u.useRef(null),[X,ee]=u.useState(null),[ne,re]=u.useState(null),[ye,ue]=u.useState(null),[T,se]=u.useState(null),[Se,be]=u.useState(!1),A=u.useRef(!1),fe=u.useRef(!1),Pe=u.useRef(0),Ie=u.useRef(null),Ue=u.useRef(null),tt=u.useRef(null),He=o===n,Ye=l==="LIMIT"||l==="TRIGGER",nt=u.useMemo(()=>w?Object.values(B).filter(N=>N.symbol===w).sort((N,V)=>V.createdAt-N.createdAt):[],[w,B]),K=nt[0],ae=u.useMemo(()=>w?Object.values(H).find(N=>N.symbol===w):void 0,[w,H]),Ee=!!g&&g.symbol===w&&g.side===n,yt=Ee||p!=null,bt=K?"position":ae?"trigger":He&&Ye&&yt?"pending":null,Ge=m??g?.action??"BUY";u.useEffect(()=>{if(!K){se(null);return}const N=qt.getInstance(),V=N.getCachedData(K.symbol,K.exchange)?.data?.ltp;V&&V>0&&se(V);const J=N.subscribe(K.symbol,K.exchange,"LTP",oe=>{const me=oe.data.ltp;me&&me>0&&se(me)});return()=>J()},[K]);const Ve=u.useMemo(()=>{if(!K||!T||T<=0)return null;const N=K.action==="BUY"?T-K.entryPrice:K.entryPrice-T,V=N*K.quantity;return{ltp:T,points:N,pnl:V}},[K,T]),vt=u.useMemo(()=>{if(nt.length===0)return null;const N=nt.reduce((J,oe)=>J+Math.max(oe.quantity,0),0);if(N<=0)return null;const V=nt.reduce((J,oe)=>J+oe.entryPrice*Math.max(oe.quantity,0),0)/N;return Te(V)},[nt]),xe=u.useMemo(()=>{if(!K)return"";const N=`${K.action} Fill @ ${K.entryPrice.toFixed(2)}`,V=vt!=null?` | Avg ${vt.toFixed(2)}`:"";if(!Ve)return N;const J=Ve.pnl>=0?"+":"";return`${N}${V} | PnL ${J}${Ve.pnl.toFixed(2)}`},[K,Ve,vt]),Q=u.useCallback((N,V)=>{if(N.current){const J=V.current??t.current;try{J?.removePriceLine(N.current)}catch{}N.current=null,V.current=null}},[t]),je=u.useCallback((N,V,J,oe,me,te,pe)=>{const le=t.current;if(!le)return;const we="";if(N.current&&V.current&&V.current!==le){try{V.current.removePriceLine(N.current)}catch{}N.current=null,V.current=null}N.current?N.current.applyOptions({price:J,color:oe,lineStyle:me,lineWidth:te,title:we,axisLabelVisible:!0}):(N.current=le.createPriceLine({price:J,color:oe,lineStyle:me,lineWidth:te,title:we,axisLabelVisible:!0}),V.current=le)},[t]),Ze=u.useCallback(N=>{if(!t.current)return null;const V=t.current.priceToCoordinate(N);return V??null},[t]),ke=u.useCallback(()=>{const N=(V,J)=>{if(!V.current){J(null);return}const oe=V.current.options().price,me=Ze(oe);if(me==null){J(null);return}J({y:me,price:oe})};N(z,ee),N(q,re),N(h,ue)},[Ze]),lt=u.useCallback(()=>{if(!w)return null;const V=qt.getInstance().getCachedData(w,f)?.data?.ltp;return!V||V<=0?null:V},[w,f]),st=u.useCallback(N=>N==="BUY"?"above":"below",[]),St=u.useCallback((N,V)=>{const J=lt();return J?N==="BUY"&&V<=J?{ok:!1,message:`BUY trigger must be above current price (${J.toFixed(2)})`}:N==="SELL"&&V>=J?{ok:!1,message:`SELL trigger must be below current price (${J.toFixed(2)})`}:{ok:!0}:{ok:!0}},[lt]),Pt=u.useCallback(async()=>{if(i)return i;try{const V=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(V.status==="success"&&V.api_key)return a(V.api_key),V.api_key}catch(N){console.error("[Scalping] Failed to fetch API key:",N)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[i,a]),jt=u.useCallback(async()=>{if(fe.current)return;const N=Ue.current;if(!N)return;const V=Date.now()-Pe.current,J=N.force?0:Math.max(0,Mi-V);if(J>0){if(Ie.current!=null)return;Ie.current=window.setTimeout(()=>{Ie.current=null,jt()},J);return}Ue.current=null,fe.current=!0,Pe.current=Date.now();try{if(!await Pt())return;await he.modifyOrder(N.orderId,{symbol:N.symbol,exchange:f,action:N.action,product:v,pricetype:"LIMIT",price:N.price,quantity:N.quantity,trigger_price:0,disclosed_quantity:0})}catch(oe){console.error("[Scalping] Failed to modify pending LIMIT order:",oe)}finally{fe.current=!1,Ue.current&&jt()}},[Pt,f,v]),Kt=u.useCallback((N,V,J=!1)=>{if(j||!N.orderId)return;const oe=Te(V),me=Ue.current;Ue.current={orderId:N.orderId,symbol:N.symbol,action:N.action,quantity:N.quantity,price:oe,force:J||!!me?.force},J&&Ie.current!=null&&(window.clearTimeout(Ie.current),Ie.current=null),jt()},[j,jt]);u.useEffect(()=>()=>{Ie.current!=null&&(window.clearTimeout(Ie.current),Ie.current=null)},[]);const Ut=u.useCallback(async(N,V)=>{if(!w||A.current)return!1;A.current=!0;try{if(j){const pe=await Rt({symbol:w,exchange:f,preferredPrice:N});return pe<=0?!1:(U(Je({symbol:w,exchange:f,side:n,action:V,entryPrice:pe,quantity:P*x,tpPoints:c,slPoints:d,managedBy:"manual"})),E(),I(),F(null),M(null),!0)}const J=await Pt();if(!J)return!1;const oe={apikey:J,strategy:"Scalping",exchange:f,symbol:w,action:V,quantity:P*x,pricetype:"LIMIT",product:v,price:N,trigger_price:0,disclosed_quantity:0},me=await he.placeOrder(oe);if(me.status!=="success")return console.error("[Scalping] LIMIT order rejected:",me),!1;const te=ht(me);return L({symbol:w,side:n,action:V,orderId:te,quantity:P*x,entryPrice:N,tpPoints:c,slPoints:d}),F(null),M(N),!0}catch(J){return console.error("[Scalping] LIMIT order failed:",J),!1}finally{A.current=!1}},[w,j,f,n,P,x,c,d,v,Pt,U,E,I,F,M,L]);u.useEffect(()=>{const N=e.current,V=t.current;if(!N||!V)return;if(!(He&&Ye&&!K&&!ae&&!Ee&&p==null)){Q(Z,b);return}const oe=me=>{if(!me.point){Q(Z,b);return}const te=V.coordinateToPrice(me.point.y);if(te==null){Q(Z,b);return}const pe=Te(te);je(Z,b,pe,"#a1a1aa",Xe.Dashed,1,pe.toFixed(2))};return N.subscribeCrosshairMove(oe),()=>{N.unsubscribeCrosshairMove(oe),Q(Z,b)}},[e,t,He,Ye,K,ae,Ee,p,Q,je]),u.useEffect(()=>{const N=e.current,V=t.current;if(!N||!V||!w||!He||!Ye)return;const J=oe=>{if(!oe.point)return;const me=V.coordinateToPrice(oe.point.y);if(me==null)return;const te=Te(me);if(l==="TRIGGER"){const pe=m??ae?.action;if(!pe){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const le=St(pe,te);if(!le.ok){console.warn(`[Scalping] ${le.message}`);return}const we=st(pe);ae?Y(ae.id,{triggerPrice:te,action:pe,direction:we,quantity:P*x,tpPoints:c,slPoints:d}):G({id:`trigger-${Date.now()}`,symbol:w,exchange:f,side:n,action:pe,triggerPrice:te,direction:we,quantity:P*x,tpPoints:c,slPoints:d,createdAt:Date.now()}),M(te),F(null)}else{if(Ee){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!m){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(K)return;M(te),Ut(te,m)}Q(Z,b),ke()};return N.subscribeClick(J),()=>{N.unsubscribeClick(J)}},[e,t,w,He,Ye,l,m,K,ae,Ee,P,x,c,d,f,n,G,Y,M,F,st,St,Ut,Q,ke]),u.useEffect(()=>{if(!t.current)return;const N=()=>{Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null)};if(K){const V=K.action==="BUY"?"#00ff88":"#ff4560";je(z,C,Te(K.entryPrice),V,Xe.Dotted,2,`${K.action} @ ${K.entryPrice.toFixed(2)}`),K.tpPrice!=null?je(q,D,Te(K.tpPrice),"#00ff88",Xe.Dashed,1,`TP @ ${K.tpPrice.toFixed(2)}`):Q(q,D),K.slPrice!=null?je(h,_,Te(K.slPrice),"#ff4560",Xe.Dashed,1,`SL @ ${K.slPrice.toFixed(2)}`):Q(h,_),ke();return}if(ae){const{tpPrice:V,slPrice:J}=bs(ae),oe=Te(ae.triggerPrice);je(z,C,oe,"#ffa500",Xe.Dashed,2,`TRIGGER ${ae.action} @ ${oe.toFixed(2)}`),V!=null?je(q,D,V,"#00ff88",Xe.Dashed,1,`TP @ ${V.toFixed(2)}`):Q(q,D),J!=null?je(h,_,J,"#ff4560",Xe.Dashed,1,`SL @ ${J.toFixed(2)}`):Q(h,_),ke();return}if(He&&Ye&&yt){const V=Ge,J=Ee?g?.tpPoints??c:c,oe=Ee?g?.slPoints??d:d,me=Ee?g?.entryPrice??p:p;if(me==null){N();return}const te=Te(me);if(je(z,C,te,l==="LIMIT"?"#06b6d4":"#ffa500",Xe.Dashed,2,`${l} ${V} @ ${te.toFixed(2)}`),J>0){const le=Te(te+(V==="BUY"?J:-J));je(q,D,le,"#00ff88",Xe.Dashed,1,`TP @ ${le.toFixed(2)}`)}else Q(q,D);if(oe>0){const le=Te(te+(V==="BUY"?-oe:oe));je(h,_,le,"#ff4560",Xe.Dashed,1,`SL @ ${le.toFixed(2)}`)}else Q(h,_);ke();return}N()},[t,K,ae,He,Ye,yt,p,Ge,g,Ee,l,c,d,Q,je,ke]),u.useEffect(()=>{},[K,xe]),u.useEffect(()=>{const N=e.current;if(!N)return;const V=()=>ke();N.subscribeCrosshairMove(V);const J=N.timeScale();return J.subscribeVisibleLogicalRangeChange(V),()=>{N.unsubscribeCrosshairMove(V),J.unsubscribeVisibleLogicalRangeChange(V)}},[e,ke]),u.useEffect(()=>{const N=r.current;if(!N)return;const V=()=>{!z.current&&!q.current&&!h.current||ke()},J=window.setInterval(V,100);return N.addEventListener("wheel",V,{passive:!0}),N.addEventListener("mousemove",V),window.addEventListener("resize",V),()=>{window.clearInterval(J),N.removeEventListener("wheel",V),N.removeEventListener("mousemove",V),window.removeEventListener("resize",V)}},[r,ke]),u.useEffect(()=>{K||ae||Ee||m==null&&(p==null&&!z.current&&!q.current&&!h.current||(Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null),M(null)))},[K,ae,Ee,m,p,Q,M]),u.useEffect(()=>()=>{Q(Z,b),Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null)},[w,Q]),u.useEffect(()=>{l==="MARKET"&&(K||ae||(Q(Z,b),Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null),M(null),F(null),I()))},[l,K,ae,Q,M,F,I]);const $t=u.useCallback((N,V)=>{if(V.preventDefault(),V.stopPropagation(),!bt||!(N==="entry"?z:N==="tp"?q:h).current)return;tt.current={type:N,source:bt};const oe=te=>{const pe=tt.current,le=t.current,we=r.current;if(!pe||!le||!we)return;const Oe=we.getBoundingClientRect(),Zt=te.clientY-Oe.top,Dt=le.coordinateToPrice(Zt);if(Dt==null)return;const et=Te(Dt),hn=pe.type==="entry"?z:pe.type==="tp"?q:h;if(hn.current){if(pe.type==="entry"?pe.source==="trigger"?`${ae?.action??"BUY"}${et.toFixed(2)}`:pe.source==="pending"?`${l}${Ge}${et.toFixed(2)}`:pe.source==="position"?`${K?.action??Ge}${et.toFixed(2)}`:hn.current.options().title??et.toFixed(2):pe.type==="tp"?`${et.toFixed(2)}`:`${et.toFixed(2)}`,hn.current.applyOptions({price:et,title:""}),pe.type==="entry"){const Xt=pe.source==="trigger"?ae?.action??Ge:pe.source==="position"?K?.action??Ge:Ge,gn=pe.source==="trigger"?ae?.tpPoints??0:pe.source==="position"?K?.tpPoints??0:c,yn=pe.source==="trigger"?ae?.slPoints??0:pe.source==="position"?K?.slPoints??0:d;if(gn>0&&q.current){const bn=Te(et+(Xt==="BUY"?gn:-gn));q.current.applyOptions({price:bn,title:""})}if(yn>0&&h.current){const bn=Te(et+(Xt==="BUY"?-yn:yn));h.current.applyOptions({price:bn,title:""})}}ke()}},me=()=>{const te=tt.current;if(!te)return;const le=(te.type==="entry"?z:te.type==="tp"?q:h).current?.options().price;if(le!=null){if(te.source==="position"&&K){const we=te.type==="entry"?{entryPrice:le,tpPrice:K.tpPrice!=null?Te(K.tpPrice+(le-K.entryPrice)):null,slPrice:K.slPrice!=null?Te(K.slPrice+(le-K.entryPrice)):null}:te.type==="tp"?{tpPrice:le,tpPoints:rt(Math.abs(le-K.entryPrice))}:te.type==="sl"?{slPrice:le,slPoints:rt(Math.abs(K.entryPrice-le))}:null;we&&k(K.id,we)}if(te.source==="trigger"&&ae){if(te.type==="entry"){const we=St(ae.action,le);if(we.ok)Y(ae.id,{triggerPrice:le,direction:st(ae.action)}),M(le);else{console.warn(`[Scalping] ${we.message}`);const Oe=Te(ae.triggerPrice);z.current?.applyOptions({price:Oe,title:""});const{tpPrice:Zt,slPrice:Dt}=bs(ae);q.current&&Zt!=null&&q.current.applyOptions({price:Zt,title:""}),h.current&&Dt!=null&&h.current.applyOptions({price:Dt,title:""}),M(Oe)}}te.type==="tp"&&Y(ae.id,{tpPoints:rt(Math.abs(le-ae.triggerPrice))}),te.type==="sl"&&Y(ae.id,{slPoints:rt(Math.abs(ae.triggerPrice-le))})}if(te.source==="pending"){const we=z.current?.options().price??p??le;if(Ee&&g){const Oe={...g};te.type==="entry"&&(Oe.entryPrice=le,M(le),Kt({orderId:Oe.orderId,symbol:Oe.symbol,action:Oe.action,quantity:Oe.quantity},le,!0)),te.type==="tp"&&(Oe.tpPoints=rt(Math.abs(le-we))),te.type==="sl"&&(Oe.slPoints=rt(Math.abs(we-le))),L(Oe)}else te.type==="entry"&&M(le),te.type==="tp"&&$(rt(Math.abs(le-we))),te.type==="sl"&&O(rt(Math.abs(we-le)))}}ke(),tt.current=null,document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",me)};document.addEventListener("mousemove",oe),document.addEventListener("mouseup",me)},[bt,t,r,K,ae,Ge,l,p,Ee,g,c,d,Kt,k,Y,st,St,ke,L,M,$,O]),At=u.useCallback(async()=>{if(Ee&&g?.orderId&&!j)try{const N=await he.cancelOrder(g.orderId);if(N.status!=="success"){console.error("[Scalping] Failed to cancel LIMIT order:",N);return}}catch(N){console.error("[Scalping] Failed to cancel LIMIT order:",N);return}Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null),K&&y(K.symbol),ae&&R(ae.id),Ee&&!g?.orderId&&!j&&console.warn("[Scalping] Pending LIMIT has no broker orderId; cleared local lines only."),I(),M(null),F(null)},[K,ae,Ee,g,j,Q,y,R,I,M,F]),Ot=u.useCallback(N=>{if(Q(N==="tp"?q:h,N==="tp"?D:_),N==="tp"?re(null):ue(null),K){k(K.id,N==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(ae){Y(ae.id,N==="tp"?{tpPoints:0}:{slPoints:0});return}N==="tp"?$(0):O(0)},[K,ae,Q,$,O,k,Y]),Ht=u.useCallback(async()=>{if(!(!K||Se)){be(!0);try{if(j)console.log(`[Paper] Close ${K.action} ${K.symbol}`);else{const N=await he.closePosition(K.symbol,K.exchange,v);if(N.status!=="success"){console.error("[Scalping] Close position rejected:",N);return}}y(K.symbol),Q(z,C),Q(q,D),Q(h,_),ee(null),re(null),ue(null)}catch(N){console.error("[Scalping] Close position failed:",N)}finally{be(!1)}}},[K,Se,j,v,y,Q]);if(!r.current)return null;const ct=!!K,dt=ct?K.action==="BUY"?"green":"red":l==="LIMIT"?"cyan":"orange",Yt=ct?`${K.action} @ ${X?.price.toFixed(2)??"--"}`:ae?`TRIGGER ${ae.action} @ ${X?.price.toFixed(2)??"--"}`:`${l} ${Ge} @ ${X?.price.toFixed(2)??"--"}`,xn={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[dt],de={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[dt],Ft=bt!==null;return s.jsxs(s.Fragment,{children:[X&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:X.y},children:[s.jsx("div",{className:De("absolute left-0 right-0 top-0 h-px -translate-y-1/2",de)}),s.jsx("div",{className:De("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",Ft?"cursor-ns-resize":"cursor-default"),onMouseDown:Ft?N=>$t("entry",N):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:De("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",xn),children:Yt}),ct&&Ve&&s.jsxs("span",{className:De("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Ve.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",Ve.ltp.toFixed(2)," | PnL ",Ve.pnl>=0?"+":"",Ve.pnl.toFixed(2)]}),ct&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:N=>{N.stopPropagation(),Ht()},disabled:Se,title:"Close position at market",children:Se?"...":"Close"}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:N=>{N.stopPropagation(),At()},title:ct?"Remove virtual position tracking":"Cancel pending order",children:""})]})]}),ne&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ne.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:N=>$t("tp",N)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",ne.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:N=>{N.stopPropagation(),Ot("tp")},title:"Remove TP line",children:""})]})]}),ye&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ye.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:N=>$t("sl",N)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",ye.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:N=>{N.stopPropagation(),Ot("sl")},title:"Remove SL line",children:""})]})]})]})}const Ii=120,$i=1,Ai=10,Oi=40;function an(e){return e.map(t=>({time:t.time,value:t.value}))}function Fi(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Di(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function vs(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Me(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Kn(e){const t=Qe(e);return t??null}function zi(e){if(!e?.length)return[];const t=[];for(const a of e){const o=Qe(a.timestamp)??Qe(a.time)??Qe(a.datetime)??Qe(a.date),l=Me(a.open),c=Me(a.high),d=Me(a.low),p=Me(a.close),m=Me(a.volume)??0;o==null||l==null||c==null||d==null||p==null||t.push({time:o,open:l,high:c,low:d,close:p,volume:m})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>Gn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function Ct(e){return e.map(t=>({...t}))}function Vi(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function En(e){const t=[];for(const n of e){const r=Kn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Ss(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=Kn(n.time),i=Me(n.open),a=Me(n.high),o=Me(n.low),l=Me(n.close),c=Me(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function Ps({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}){const a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),d=u.useRef(null),p=u.useRef(null),m=u.useRef(null),g=u.useRef([]),P=u.useRef(new Map),x=u.useRef(null),f=u.useRef(0),v=u.useRef(null),j=u.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),E=Ne(h=>h.apiKey),M=Ne(h=>h.setApiKey),$=Fs(h=>h.mode==="dark"),O=S(h=>h.activeSide),F=S(h=>h.setActiveSide),L=S(h=>h.optionExchange),I=S(h=>h.chartInterval),w=S(h=>e==="CE"?h.selectedCESymbol:h.selectedPESymbol),B=O===e,H=u.useCallback(()=>{const h=g.current,b=j.current,C=h.map(D=>({time:D.time,value:D.close}));c.current&&c.current.setData(b.showEma9?an(pn(C,9)):[]),d.current&&d.current.setData(b.showEma21?an(pn(C,21)):[]),p.current&&p.current.setData(b.showSupertrend?an(dr(h,10,3).trend):[]),m.current&&m.current.setData(b.showVwap?an(ur(h)):[])},[]),G=u.useCallback(()=>{v.current===null&&(v.current=setTimeout(()=>{v.current=null,H()},Ii))},[H]),Y=u.useCallback(()=>{g.current=[],l.current?.setData([]),c.current?.setData([]),d.current?.setData([]),p.current?.setData([]),m.current?.setData([])},[]),R=u.useCallback(h=>{const b=Ss(h);g.current=Ct(b),l.current?.setData(En(b)),G()},[G]),U=u.useCallback(async()=>{if(E)return E;try{const b=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(b.status==="success"&&b.api_key)return M(b.api_key),b.api_key}catch{}return null},[E,M]),y=u.useCallback(()=>{F(e)},[e,F]),k=u.useCallback((h,b)=>{if(!l.current)return;const C=Kn(h.time),D=Me(h.open),_=Me(h.high),X=Me(h.low),ee=Me(h.close),ne=Me(h.volume)??0;if(C==null||D==null||_==null||X==null||ee==null)return;const re={time:C,open:D,high:_,low:X,close:ee,volume:ne},ye=Number(re.time),ue=g.current.length?Number(g.current[g.current.length-1].time):null;if(ue!=null&&Number.isFinite(ue)&&Number.isFinite(ye)&&ye<ue)return;try{l.current.update({time:re.time,open:re.open,high:re.high,low:re.low,close:re.close})}catch{const se=Ss([...g.current,re]);g.current=se,l.current.setData(En(se)),G();return}b?(g.current.push(re),g.current.length>500&&(g.current=g.current.slice(-500))):g.current.length>0?g.current[g.current.length-1]=re:g.current.push(re);const T=x.current;T&&P.current.set(T,Ct(g.current)),G()},[G]),{isConnected:Z,reset:z,seed:q}=cr({symbol:w??"",exchange:L,intervalSec:I,enabled:!!w,useIndiaMarketHours:!0,onCandleUpdate:k});return u.useEffect(()=>{const h=x.current;if(h&&g.current.length>0&&P.current.set(h,Ct(g.current)),!w){x.current=null,z(),Y();return}const b=`${L}:${w}:${I}`;x.current=b;const C=P.current.get(b);if(C&&C.length>0){z(),q(C),R(C);return}z(),Y();const D=++f.current,_=Di(I),X=new Date,ee=new Date(X.getTime());ee.setDate(ee.getDate()-$i),(async()=>{const re=await U();if(!re){D===f.current&&Y();return}try{const ye=async()=>{try{const fe=await he.getQuotes(re,w,L);if(fe.status!=="success"||!fe.data)return null;const Pe=Me(fe.data.ltp);if(Pe==null||Pe<=0)return null;const Ie=Math.floor(Date.now()/1e3);return{time:Math.floor(Ie/I)*I,open:Pe,high:Pe,low:Pe,close:Pe,volume:Me(fe.data.volume)??0}}catch{return null}},ue=async fe=>{try{const Pe=await he.getHistory(re,w,L,_,vs(ee),vs(X),fe);return Pe.status==="success"?zi(Pe.data):[]}catch{return[]}},T=await ue("api"),se=T.length>0?T:await ue("db");if(D!==f.current)return;const Se=x.current===b?Ct(g.current):[],be=Vi(se,Se);if(be.length>0){P.current.set(b,Ct(be)),q(be),R(be);return}const A=await ye();if(A&&D===f.current){const fe=[A];P.current.set(b,Ct(fe)),q(fe),R(fe);return}}catch{}D===f.current&&Y()})()},[w,L,I,U,z,q,Y,R]),u.useEffect(()=>{j.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},c.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),m.current?.applyOptions({visible:i}),G()},[t,n,r,i,G]),u.useEffect(()=>{const h=a.current;if(!h)return;const b=Fi($),C=pr(Ai,Oi),D=zs(h,{width:h.offsetWidth,height:h.offsetHeight,layout:{background:{type:_s.Solid,color:b.bg},textColor:b.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:b.grid},horzLines:{color:b.grid}},rightPriceScale:{borderColor:b.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:b.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:ue=>lr(ue)},crosshair:{mode:Vs.Normal,vertLine:{width:1,color:b.crosshair,style:2},horzLine:{width:1,color:b.crosshair,style:2}}}),_=D.addSeries(Bs,{upColor:b.upColor,downColor:b.downColor,borderVisible:!1,wickUpColor:b.upColor,wickDownColor:b.downColor,autoscaleInfoProvider:C}),X=D.addSeries(it,{color:b.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma9,autoscaleInfoProvider:C}),ee=D.addSeries(it,{color:b.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma21,autoscaleInfoProvider:C}),ne=D.addSeries(it,{color:b.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showSupertrend,autoscaleInfoProvider:C}),re=D.addSeries(it,{color:b.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showVwap,autoscaleInfoProvider:C});o.current=D,l.current=_,c.current=X,d.current=ee,p.current=ne,m.current=re,g.current.length>0&&(_.setData(En(g.current)),G());const ye=new ResizeObserver(()=>{if(o.current&&h){const ue=h.offsetWidth,T=h.offsetHeight;ue>0&&T>0&&o.current.applyOptions({width:ue,height:T})}});return ye.observe(h),()=>{v.current!==null&&(clearTimeout(v.current),v.current=null),ye.disconnect(),D.remove(),o.current=null,l.current=null,c.current=null,d.current=null,p.current=null,m.current=null}},[$,G]),s.jsxs("div",{className:De("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",B&&"ring-1 ring-primary/40"),onClick:y,children:[s.jsx("div",{ref:a,className:"h-full w-full"}),s.jsx(Ri,{chartRef:o,seriesRef:l,side:e,containerRef:a}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:De("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),w&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:w}),!w&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),B&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),w&&!Z&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!w&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function _i(){const e=Ne(T=>T.apiKey),t=Ne(T=>T.setApiKey),n=S(T=>T.showFloatingWidget),r=S(T=>T.floatingWidgetMinimized),i=S(T=>T.setFloatingWidgetMinimized),a=S(T=>T.activeSide),o=S(T=>T.selectedCESymbol),l=S(T=>T.selectedPESymbol),c=S(T=>T.optionExchange),d=S(T=>T.quantity),p=S(T=>T.lotSize),m=S(T=>T.product),g=S(T=>T.tpPoints),P=S(T=>T.slPoints),x=S(T=>T.orderType),f=S(T=>T.limitPrice),v=S(T=>T.pendingLimitPlacement),j=S(T=>T.setLimitPrice),E=S(T=>T.setPendingEntryAction),M=S(T=>T.setPendingLimitPlacement),$=S(T=>T.clearPendingLimitPlacement),O=S(T=>T.paperMode),F=ie(T=>T.setVirtualTPSL),L=ie(T=>T.clearForSymbol),I=ie(T=>T.triggerOrders),w=ie(T=>T.removeTriggerOrder),B=S(T=>T.ceWidgetPos),H=S(T=>T.setCeWidgetPos),G=S(T=>T.incrementQuantity),Y=S(T=>T.decrementQuantity),R=S(T=>T.setTpPoints),U=S(T=>T.setSlPoints),y=S(T=>T.incrementTradeCount),k=a==="CE"?o:l,[Z,z]=u.useState(!1),[q,h]=u.useState(null),[b,C]=u.useState(null),D=u.useRef(null),_=u.useRef(null);u.useEffect(()=>{if(!k){h(null),C(null);return}const se=qt.getInstance().subscribe(k,c,"LTP",Se=>{const be=Se.data.ltp;be!=null&&be>0&&(C(q),h(be))});return()=>{se()}},[k,c]);const X=u.useCallback(T=>{if(T.target.closest("button, input"))return;T.preventDefault(),D.current={startX:T.clientX,startY:T.clientY,origX:B.x,origY:B.y};const se=be=>{if(!D.current)return;const A=be.clientX-D.current.startX,fe=be.clientY-D.current.startY;H({x:Math.max(0,D.current.origX+A),y:Math.max(0,D.current.origY+fe)})},Se=()=>{D.current=null,document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",Se)};document.addEventListener("mousemove",se),document.addEventListener("mouseup",Se)},[B,H]),ee=u.useCallback(async()=>{if(e)return e;try{const se=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(se.status==="success"&&se.api_key)return t(se.api_key),se.api_key}catch(T){console.error("[Scalping] Failed to fetch API key:",T)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),ne=u.useCallback(async T=>{if(!k||Z){k||console.warn("[Scalping] No symbol selected  click a strike first");return}if(z(!0),x==="TRIGGER"){const A=Object.values(I).find(fe=>fe.symbol===k&&fe.exchange===c&&fe.side===a);A&&w(A.id),$(),j(null),E(T),console.log(`[Scalping] TRIGGER armed (${T})  click chart to place trigger line`),z(!1);return}if(x==="LIMIT"&&!f){E(T),console.log(`[Scalping] LIMIT armed (${T})  click chart to set limit line`),z(!1);return}if(x==="LIMIT"&&v&&v.symbol===k&&v.side===a){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),z(!1);return}if(O){if(console.log(`[Paper] ${T} ${a} ${k} qty=${d*p} @ ${x}`),x==="MARKET"||x==="LIMIT"){const A=await Rt({symbol:k,exchange:c,preferredPrice:x==="LIMIT"?f??q??void 0:q??void 0});A>0&&(F(Je({symbol:k,exchange:c,side:a,action:T,entryPrice:A,quantity:d*p,tpPoints:g,slPoints:P,managedBy:"manual"})),x==="LIMIT"&&j(null))}$(),y(),z(!1);return}const se=await ee();if(!se){z(!1);return}const Se=x==="LIMIT"?"LIMIT":"MARKET",be={apikey:se,strategy:"Scalping",exchange:c,symbol:k,action:T,quantity:d*p,pricetype:Se,product:m,price:x==="LIMIT"&&f?f:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${T} ${k} qty=${d*p} ${Se}`);const A=await he.placeOrder(be);if(A.status==="success"){const fe=ht(A);if(console.log(`[Scalping] Order placed: ${T} ${k} id=${fe??"n/a"}`),E(null),Se==="LIMIT"){const Pe=f??q??0;Pe<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state."),M({symbol:k,side:a,action:T,orderId:fe,quantity:d*p,entryPrice:Pe,tpPoints:g,slPoints:P}),Pe>0&&j(Pe),z(!1);return}if($(),y(),Se==="MARKET"){const Pe=await It({symbol:k,exchange:c,orderId:fe,preferredPrice:q??void 0,apiKey:se});Pe>0&&F(Je({symbol:k,exchange:c,side:a,action:T,entryPrice:Pe,quantity:d*p,tpPoints:g,slPoints:P,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",A)}catch(A){console.error("[Scalping] Order failed:",A)}z(!1)},[k,a,d,p,c,m,x,f,v,g,P,O,L,I,Z,q,ee,y,M,F,w,j,E,$]),re=u.useCallback(async()=>{if(!k||Z)return;if(z(!0),O){console.log(`[Paper] Reversal ${a} ${k}`),y(),z(!1);return}const T=await ee();if(!T){z(!1);return}try{const se={apikey:T,strategy:"Scalping",exchange:c,symbol:k,action:"SELL",quantity:d*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await he.placeOrder(se);const Se={apikey:T,strategy:"Scalping",exchange:c,symbol:k,action:"SELL",quantity:d*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0};await he.placeOrder(Se),console.log(`[Scalping] Reversed ${a} ${k}`),y()}catch(se){console.error("[Scalping] Reversal failed:",se)}z(!1)},[k,a,d,p,c,m,O,Z,ee,y]),ye=u.useCallback(async()=>{if(k){if(O){console.log(`[Paper] Close ${a} ${k}`),L(k),j(null),E(null),$();return}try{const T=await he.closePosition(k,c,m);T.status==="success"?(console.log(`[Scalping] Closed ${a} ${k}`),L(k),j(null),E(null),$()):console.error("[Scalping] Close rejected:",T)}catch(T){console.error("[Scalping] Close failed:",T)}}},[k,a,c,m,O,L,j,E,$]);if(!n||!k)return null;const ue=q&&b?q>b?"up":q<b?"down":"flat":"flat";return r?s.jsx("div",{ref:_,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:B.x,top:B.y},children:s.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[s.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:k.slice(-10)}),s.jsx("span",{className:`text-xs font-bold tabular-nums ${ue==="up"?"text-green-500":ue==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(ge,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):s.jsxs("div",{ref:_,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:B.x,top:B.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:k.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${ue==="up"?"text-green-500":ue==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),s.jsx(ge,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(ge,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>ne("BUY"),disabled:Z,children:"BUY"}),s.jsx(ge,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>ne("SELL"),disabled:Z,children:"SELL"}),s.jsx(ge,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:re,disabled:Z,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:Y,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:d}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:G,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:g,onChange:T=>R(Number.parseFloat(T.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:P,onChange:T=>U(Number.parseFloat(T.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:ye,children:"x Close"})})]})}const Bi=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function qi({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,onToggleEma9:i,onToggleEma21:a,onToggleSupertrend:o,onToggleVwap:l}){const c=S(p=>p.chartInterval),d=S(p=>p.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Bi.map(p=>s.jsx(ge,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${c===p.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>d(p.sec),children:p.label},p.sec)),s.jsx(Gi,{intervalSec:c}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(on,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),s.jsx(on,{label:"EMA21",active:t,color:"text-violet-500",onClick:a}),s.jsx(on,{label:"ST",active:n,color:"text-cyan-500",onClick:o}),s.jsx(on,{label:"VWAP",active:r,color:"text-pink-500",onClick:l})]})}function Gi({intervalSec:e}){const[t,n]=u.useState(()=>Tn(e));u.useEffect(()=>{n(Tn(e));const i=setInterval(()=>{n(Tn(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:Wi(t,e)})}function Tn(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function Wi(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function on({label:e,active:t,color:n,onClick:r}){return s.jsx(ge,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function Ki(){const[e,t]=u.useState(!0),[n,r]=u.useState(!0),[i,a]=u.useState(!0),[o,l]=u.useState(!0),c=u.useCallback(()=>t(g=>!g),[]),d=u.useCallback(()=>r(g=>!g),[]),p=u.useCallback(()=>a(g=>!g),[]),m=u.useCallback(()=>l(g=>!g),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(qi,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,onToggleEma9:c,onToggleEma21:d,onToggleSupertrend:p,onToggleVwap:m}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs($n,{orientation:"vertical",children:[s.jsx(pt,{defaultSize:"40%",minSize:"18%",children:s.jsx(wi,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(dn,{withHandle:!0}),s.jsx(pt,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs($n,{orientation:"horizontal",children:[s.jsx(pt,{defaultSize:"50%",minSize:"20%",children:s.jsx(Ps,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(dn,{withHandle:!0}),s.jsx(pt,{defaultSize:"50%",minSize:"20%",children:s.jsx(Ps,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})})]}),s.jsx(_i,{})]})})]})})]})}function Ui(){const e=Ne(h=>h.apiKey),t=Ne(h=>h.setApiKey),n=S(h=>h.activeSide),r=S(h=>h.selectedCESymbol),i=S(h=>h.selectedPESymbol),a=S(h=>h.optionExchange),o=S(h=>h.quantity),l=S(h=>h.lotSize),c=S(h=>h.product),d=S(h=>h.orderType),p=S(h=>h.tpPoints),m=S(h=>h.slPoints),g=S(h=>h.limitPrice),P=S(h=>h.pendingLimitPlacement),x=S(h=>h.setLimitPrice),f=S(h=>h.setPendingEntryAction),v=S(h=>h.setPendingLimitPlacement),j=S(h=>h.clearPendingLimitPlacement),E=S(h=>h.paperMode),M=ie(h=>h.setVirtualTPSL),$=ie(h=>h.clearForSymbol),O=ie(h=>h.clearAll),F=ie(h=>h.triggerOrders),L=ie(h=>h.removeTriggerOrder),I=S(h=>h.setQuantity),w=S(h=>h.incrementQuantity),B=S(h=>h.decrementQuantity),H=S(h=>h.setOrderType),G=S(h=>h.setProduct),Y=S(h=>h.setTpPoints),R=S(h=>h.setSlPoints),U=S(h=>h.incrementTradeCount),y=n==="CE"?r:i,k=u.useCallback(async()=>{if(e)return e;try{const b=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(b.status==="success"&&b.api_key)return t(b.api_key),b.api_key}catch(h){console.error("[Scalping] Failed to fetch API key:",h)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),Z=u.useCallback(async h=>{if(!y){console.warn("[Scalping] No symbol selected  click a strike first");return}if(d==="TRIGGER"){const _=Object.values(F).find(X=>X.symbol===y&&X.exchange===a&&X.side===n);_&&L(_.id),j(),x(null),f(h),console.log(`[Scalping] TRIGGER armed (${h})  click chart to place trigger line`);return}if(d==="LIMIT"&&!g){f(h),console.log(`[Scalping] LIMIT armed (${h})  click chart to set limit line`);return}if(d==="LIMIT"&&P&&P.symbol===y&&P.side===n){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another.");return}if(E){if(console.log(`[Paper] ${h} ${n} ${y} qty=${o*l} @ ${d}`),d==="MARKET"||d==="LIMIT"){const _=await Rt({symbol:y,exchange:a,preferredPrice:d==="LIMIT"?g??void 0:void 0});_>0&&(M(Je({symbol:y,exchange:a,side:n,action:h,entryPrice:_,quantity:o*l,tpPoints:p,slPoints:m,managedBy:"manual"})),d==="LIMIT"&&x(null))}j(),U();return}const b=await k();if(!b)return;const C=d==="LIMIT"?"LIMIT":"MARKET",D={apikey:b,strategy:"Scalping",exchange:a,symbol:y,action:h,quantity:o*l,pricetype:C,product:c,price:d==="LIMIT"&&g?g:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${h} ${y} qty=${o*l} ${C}`);const _=await he.placeOrder(D);if(_.status==="success"){const X=ht(_);if(console.log(`[Scalping] Order placed: ${h} ${y} id=${X??"n/a"}`),f(null),C==="LIMIT"){g==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),v({symbol:y,side:n,action:h,orderId:X,quantity:o*l,entryPrice:g??0,tpPoints:p,slPoints:m}),g!=null&&x(g);return}if(j(),U(),C==="MARKET"){const ee=await It({symbol:y,exchange:a,orderId:X,preferredPrice:void 0,apiKey:b});ee>0&&M(Je({symbol:y,exchange:a,side:n,action:h,entryPrice:ee,quantity:o*l,tpPoints:p,slPoints:m,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",_)}catch(_){console.error("[Scalping] Order failed:",_)}},[y,n,o,l,a,c,d,g,P,p,m,E,$,F,k,v,j,U,M,L,x,f]),z=u.useCallback(async()=>{if(y){if(E){console.log(`[Paper] Close ${n} ${y}`),$(y),x(null),f(null),j();return}try{const h=await he.closePosition(y,a,c);h.status==="success"?(console.log(`[Scalping] Closed ${n} ${y}`),$(y),x(null),f(null),j()):console.error("[Scalping] Close rejected:",h)}catch(h){console.error("[Scalping] Close failed:",h)}}},[y,n,a,c,E,$,x,f,j]),q=u.useCallback(async()=>{if(E){console.log("[Paper] Close all positions"),O(),x(null),f(null),j();return}try{await he.closeAllPositions(),console.log("[Scalping] Closed all positions"),O(),x(null),f(null),j()}catch(h){console.error("[Scalping] Close all failed:",h)}},[E,O,x,f,j]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:y||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(ge,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>Z("BUY"),disabled:!y,children:"BUY"}),s.jsx(ge,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>Z("SELL"),disabled:!y,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(ge,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:B,children:"-"}),s.jsx(at,{type:"number",min:1,value:o,onChange:h=>I(Number.parseInt(h.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(ge,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:w,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*l," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(h=>s.jsx(ge,{variant:d===h?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>H(h),children:h},h))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(h=>s.jsx(ge,{variant:c===h?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>G(h),children:h},h))})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(at,{type:"number",min:0,step:5,value:p,onChange:h=>Y(Number.parseFloat(h.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(at,{type:"number",min:0,step:5,value:m,onChange:h=>R(Number.parseFloat(h.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(ge,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:z,disabled:!y,children:["Close ",n," Position"]}),s.jsx(ge,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:q,children:"Close All Positions"})]})]})}const kn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},mr=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],Hi=["CE","PE"];function Et(e=0){return Hi.reduce((t,n)=>(t[n]=e,t),{})}const W=Fn()(Dn(e=>({config:{...kn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Et(),sideLastExitAt:Et(),sideLossPnl:Et(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...t}})),applyPreset:t=>{const n=mr.find(r=>r.id===t);n&&e({config:{...kn,...n.config},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.accountPeakPnl,t),i=Math.max(0,r-t),a=Math.max(n.dailyPeakPnl,t),o=Math.max(0,a-t),l=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered,c=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:a,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:i,lockProfitTriggered:l,killSwitch:n.killSwitch||c||l}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,l=Math.max(n.dailyPeakPnl,o),c=Math.max(0,l-o),d=Math.max(n.autoPeakPnl,o),p=Math.max(0,d-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:l,dailyDrawdown:c,autoPeakPnl:d,autoDrawdown:p}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),l=Math.max(n.autoPeakPnl,i),c=Math.max(0,l-i),d=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,autoPeakPnl:l,autoDrawdown:c,lockProfitTriggered:d,killSwitch:n.killSwitch||d}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Et(),sideLastExitAt:Et(),sideLossPnl:Et(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const n=e??{};return{...t,...n,config:{...kn,...n.config??{}},activePresetId:n.activePresetId??t.activePresetId}}})),Yi=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Zi=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function An(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Un(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return{hours:n.getUTCHours(),minutes:n.getUTCMinutes()}}function fr(e){return e?Zi:Yi}function On(e=new Date,t=!1){const{hours:n,minutes:r}=Un(e),i=n*60+r,a=fr(t);for(const o of a){const l=An(o.start),c=An(o.end);if(i>=l&&i<c)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function js(e=new Date,t=!1){const{hours:n,minutes:r}=Un(e),i=n*60+r,a=fr(t);for(const o of a){const l=An(o.start);if(l>i)return{nextZone:o,minutesUntil:l-i}}return{nextZone:null,minutesUntil:0}}function Ns(e,t=new Date){if(!e)return!1;try{const n=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return n.getFullYear()===i.getUTCFullYear()&&n.getMonth()===i.getUTCMonth()&&n.getDate()===i.getUTCDate()}catch{return!1}}function ws(e=new Date){const{hours:t,minutes:n}=Un(e),r=t*60+n;return r>=555&&r<930}function Cs(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return`${n.getUTCHours().toString().padStart(2,"0")}:${n.getUTCMinutes().toString().padStart(2,"0")}:${n.getUTCSeconds().toString().padStart(2,"0")}`}function xr(){const e=S(r=>r.expiry),[t,n]=u.useState(()=>{const r=new Date,i=Ns(e,r),{zone:a,sensitivity:o}=On(r,i),{nextZone:l,minutesUntil:c}=js(r,i);return{currentTime:Cs(r),currentZone:a,sensitivity:o,nextZone:l,minutesToNext:c,isExpiryDay:i,isOpen:ws(r)}});return u.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Ns(e,a),{zone:l,sensitivity:c}=On(a,o),{nextZone:d,minutesUntil:p}=js(a,o);n({currentTime:Cs(a),currentZone:l,sensitivity:c,nextZone:d,minutesToNext:p,isExpiryDay:o,isOpen:ws(a)})},1e3);return()=>clearInterval(i)},[e]),t}function Xi(){const e=W(r=>r.activePresetId),t=W(r=>r.applyPreset),{isExpiryDay:n}=xr();return s.jsx("div",{className:"space-y-1.5",children:mr.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(Ce,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(Ce,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function ce({label:e,field:t,step:n}){const r=W(a=>a.config[t]),i=W(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(qe,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(at,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function _e({label:e,field:t}){const n=W(i=>i.config[t]),r=W(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(qe,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(zt,{checked:n,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function Fe({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function Qi(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(Fe,{title:"Entry Conditions",children:[s.jsx(ce,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(ce,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(ce,{label:"Min Score",field:"entryMinScore"}),s.jsx(ce,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(Fe,{title:"Volume Flow",children:[s.jsx(_e,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),s.jsx(ce,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),s.jsx(ce,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),s.jsx(ce,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),s.jsx(ce,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),s.jsx(ce,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),s.jsxs(Fe,{title:"Trailing SL (5-Stage)",children:[s.jsx(ce,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(ce,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(ce,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(ce,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(ce,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(ce,{label:"Trail Step",field:"trailStepSize"}),s.jsx(ce,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(ce,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(Fe,{title:"Breakeven",children:[s.jsx(ce,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(ce,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(Fe,{title:"Risk",children:[s.jsx(ce,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(ce,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(ce,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(ce,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(ce,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(ce,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(ce,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(ce,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(Fe,{title:"Imbalance Filter",children:[s.jsx(_e,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(ce,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(Fe,{title:"Regime Detection",children:[s.jsx(ce,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(ce,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(Fe,{title:"Index Bias",children:[s.jsx(_e,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(ce,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(Fe,{title:"Options Context",children:[s.jsx(_e,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(ce,{label:"PCR Bullish ",field:"pcrBullishThreshold",step:.1}),s.jsx(ce,{label:"PCR Bearish ",field:"pcrBearishThreshold",step:.1}),s.jsx(ce,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(_e,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(_e,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(ce,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(Fe,{title:"Time-of-Day",children:[s.jsx(_e,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(ce,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(Fe,{title:"No-Trade Zone",children:[s.jsx(_e,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(ce,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(ce,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(Fe,{title:"Re-Entry",children:[s.jsx(_e,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(ce,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(ce,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(Fe,{title:"Telegram Alerts",children:[s.jsx(_e,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(_e,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(_e,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Ji(){const e=W(r=>r.ghostSignals),t=W(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(ea,{signal:r},r.id))]})}function ea({signal:e}){const t=Ne(m=>m.apiKey),n=S(m=>m.optionExchange),r=S(m=>m.quantity),i=S(m=>m.lotSize),a=S(m=>m.product),o=S(m=>m.paperMode),l=S(m=>m.incrementTradeCount),c=u.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),l();return}if(!t)return;const m={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const g=await he.placeOrder(m);g.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${g.data?.orderid}`),l())}catch(g){console.error("[Ghost Take] Failed:",g)}},[e,t,n,r,i,a,o,l]),d=Math.round((Date.now()-e.timestamp)/1e3),p=d<60?`${d}s ago`:`${Math.round(d/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ce,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),s.jsxs(Ce,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(ge,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:c,children:"Take Trade"})]})]})}function ta(){const e=W(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(Ce,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const Hn={getBotStatus:async()=>(await We.get("/telegram/bot/status")).data.data,startBot:async()=>(await We.post("/telegram/bot/start")).data,stopBot:async()=>(await We.post("/telegram/bot/stop")).data,getConfig:async()=>(await We.get("/telegram/api/config")).data.data,updateConfig:async e=>(await We.post("/telegram/config",e)).data,getUsers:async()=>(await We.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await We.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await We.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await We.post("/telegram/test-message")).data,sendBroadcast:async e=>(await We.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await We.post("/telegram/send-message",{telegram_id:e,message:t})).data};function na(){const[e,t]=u.useState(!1),[n,r]=u.useState(null),[i,a]=u.useState(null),[o,l]=u.useState(null),c=W(x=>x.updateConfig),d=W(x=>x.config),p=S(x=>x.underlying),m=u.useCallback(async()=>{try{const x=await br();r(x.provider||"none"),x.last_run&&a(x.last_run),l(null)}catch{l("Could not reach advisor")}},[]),g=u.useCallback(async()=>{t(!0),l(null);try{const x=await vr({underlying:p});if(x.status==="success"&&x.run_id){const f=await Sr(1);f.runs?.length>0&&a(f.runs[0])}else l(x.message||"Tuning failed")}catch{l("Advisor request failed")}finally{t(!1)}},[p]),P=u.useCallback(async()=>{if(i?.run_id){t(!0);try{await Pr(i.run_id);const x=i.recommendations;if(x&&typeof x=="object"){const f={};for(const[v,j]of Object.entries(x)){if(!(v in d))continue;const E=v,M=d[E];if(typeof M=="number"){const $=typeof j=="number"?j:Number(j);Number.isFinite($)&&(f[E]=$);continue}if(typeof M=="boolean"){let $=null;if(typeof j=="boolean")$=j;else if(typeof j=="number")$=j!==0;else if(typeof j=="string"){const O=j.trim().toLowerCase();["true","1","yes","on","enabled"].includes(O)&&($=!0),["false","0","no","off","disabled"].includes(O)&&($=!1)}$!=null&&(f[E]=$)}}if(Object.keys(f).length>0&&(c(f),d.telegramAlertsTune)){const v=Object.keys(f).join(", ");Hn.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${v}`}).catch(()=>{})}}a(f=>f&&{...f,applied:!0}),l(null)}catch{l("Failed to apply recommendation")}finally{t(!1)}}},[i,c,d,p]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(Ce,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(ge,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:m,disabled:e,children:"Check Status"}),s.jsx(ge,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:g,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??""})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([x,f])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:x}),s.jsx("span",{className:"font-mono",children:typeof f=="number"?f:String(f)})]},x))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(ge,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:P,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(Ce,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function sa(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function ra(){const e=W(b=>b.enabled),t=W(b=>b.mode),n=W(b=>b.replayMode),r=W(b=>b.regime),i=W(b=>b.tradesCount),a=W(b=>b.realizedPnl),o=W(b=>b.consecutiveLosses),l=W(b=>b.killSwitch),c=W(b=>b.lockProfitEnabled),d=W(b=>b.lockProfitTriggered),p=W(b=>b.accountPeakPnl),m=W(b=>b.accountDrawdown),g=W(b=>b.autoPeakPnl),P=W(b=>b.autoDrawdown),x=W(b=>b.sideEntryCount),f=W(b=>b.sideLastExitAt),v=W(b=>b.sideLossPnl),j=W(b=>b.lastDecisionBySide),E=W(b=>b.decisionHistory),M=W(b=>b.executionSamples),$=W(b=>b.config),O=W(b=>b.setEnabled),F=W(b=>b.setMode),L=W(b=>b.setReplayMode),I=W(b=>b.setKillSwitch),w=W(b=>b.setLockProfitEnabled),B=W(b=>b.resetRuntime),H=S(b=>b.activeSide),G=S(b=>b.paperMode),Y=ie(b=>b.virtualTPSL),R=u.useMemo(()=>j[H]??E[E.length-1]??null,[H,E,j]),U=u.useMemo(()=>R?Math.max(0,Math.min(99,Math.round(R.score/Math.max(1,R.minScore)*100))):r==="UNKNOWN"?0:55,[R,r]),y=u.useMemo(()=>Object.values(Y).reduce((b,C)=>(b[C.side]+=C.quantity,b),{CE:0,PE:0}),[Y]),k=u.useMemo(()=>Object.values(Y).reduce((b,C)=>(C.managedBy!=="auto"||(b[C.side]+=C.quantity),b),{CE:0,PE:0}),[Y]),Z=u.useMemo(()=>{const b=M.slice(-10),C=b.filter(ne=>ne.status==="filled"),D=b.filter(ne=>ne.status==="rejected"),_=C.length>0?C.reduce((ne,re)=>ne+re.spread,0)/C.length:0,X=C.length>0?C.reduce((ne,re)=>ne+re.expectedSlippage,0)/C.length:0,ee=b.length>0?D.length/b.length*100:0;return{recent:b.slice().reverse(),avgSpread:_,avgSlippage:X,rejectRate:ee}},[M]),z=R?R.spread<=$.entryMaxSpread*.4?"TIGHT":R.spread<=$.entryMaxSpread?"NORMAL":"WIDE":"NA",q=f[H]>0?Math.max(0,Math.round((Date.now()-f[H])/1e3)):null,h=b=>b<=0?"0":`-${b.toFixed(0)}`;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(qe,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(zt,{checked:e,onCheckedChange:O,className:"h-5 w-9"})]}),s.jsx(Ce,{variant:e?t==="execute"?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(ge,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>F("ghost"),children:"Ghost (Signals Only)"}),s.jsx(ge,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>F("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(zt,{checked:n,onCheckedChange:L,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),t==="execute"&&!G&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(Ce,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:B,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),R?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[R.side," ",R.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${R.enter?"text-green-500":"text-red-500"}`,children:[R.score.toFixed(1)," / ",R.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:R.reason}),s.jsx("div",{className:"space-y-0.5",children:R.checks.slice(0,8).map(b=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:b.label}),s.jsxs("span",{className:`text-[10px] font-medium ${b.pass?"text-green-500":"text-red-500"}`,children:[b.pass?"PASS":"FAIL",b.value?` (${b.value})`:""]})]},b.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:sa(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[U,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:R&&!R.enter?R.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",H,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:q==null?"":`${q}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${z==="WIDE"?"text-red-500":z==="TIGHT"?"text-green-500":""}`,children:z})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(R?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:R?.depthRatio!=null?R.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:Z.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:Z.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${Z.rejectRate>30?"text-red-500":""}`,children:[Z.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[Z.recent.slice(0,5).map(b=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[b.side," ",b.symbol.slice(-10)]}),s.jsx("span",{className:b.status==="rejected"?"text-red-500":b.status==="filled"?"text-green-500":"text-muted-foreground",children:b.status})]},`${b.timestamp}-${b.symbol}`)),Z.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[l&&s.jsx(Ce,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(zt,{checked:l,onCheckedChange:I,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[d&&s.jsx(Ce,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(zt,{checked:c,onCheckedChange:w,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),s.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),s.jsx("span",{className:`font-mono ${m>0?"text-red-500":""}`,children:m.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),s.jsx("span",{className:"font-mono",children:g.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),s.jsx("span",{className:`font-mono ${P>0?"text-red-500":""}`,children:P.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),s.jsx("span",{className:"font-mono",children:y.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),s.jsx("span",{className:"font-mono",children:y.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),s.jsx("span",{className:"font-mono",children:k.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),s.jsx("span",{className:"font-mono",children:k.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:x.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:x.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsx("span",{className:`font-mono ${v.CE>0?"text-red-500":""}`,children:h(v.CE)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsx("span",{className:`font-mono ${v.PE>0?"text-red-500":""}`,children:h(v.PE)})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(ta,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Ji,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(na,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(Xi,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(Qi,{})]})]})}function ia(){const e=Ne(m=>m.apiKey),t=S(m=>m.optionExchange),n=ie(m=>m.virtualTPSL),r=ie(m=>m.triggerOrders),i=ie(m=>m.removeVirtualTPSL),a=ie(m=>m.removeTriggerOrder),o=ie(m=>m.clearAll),{data:l}=Ds({queryKey:["scalping-orders",t],queryFn:()=>he.getOrders(e),enabled:!!e,refetchInterval:5e3}),c=(l?.data?.orders??[]).filter(m=>m.exchange===t&&(m.order_status==="open"||m.order_status==="pending"||m.order_status==="trigger pending")),d=Object.values(n),p=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(Ce,{variant:"outline",className:"text-[10px] h-4",children:c.length})]}),c.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:c.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",m.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ce,{variant:"outline",className:"text-[10px] h-4",children:m.order_status}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await he.cancelOrder(m.orderid)}catch(g){console.error("Cancel failed:",g)}},children:"Cancel"})]})]},m.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(Ce,{variant:"outline",className:"text-[10px] h-4",children:d.length})]}),d.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:d.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.side==="CE"?"text-green-500":"text-red-500",children:m.side})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",m.entryPrice.toFixed(1)," |"," ",m.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",m.tpPrice.toFixed(1)]})," ",m.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",m.slPrice.toFixed(1)]})]})]}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(m.id),children:"Remove"})]},m.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(Ce,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:p.map(m=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",s.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",m.triggerPrice.toFixed(1)," (",m.direction,") | x",m.quantity]})]}),s.jsx(ge,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(m.id),children:"Remove"})]},m.id))})]}),(d.length>0||p.length>0)&&s.jsx(ge,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function aa(e,t){const n=Ne(p=>p.apiKey),[r,i]=u.useState(null),[a,o]=u.useState(!1),l=u.useRef(null),c=u.useCallback(async()=>{if(!(!e||!n)){try{const p=await he.getDepth(n,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}o(!1)}},[e,t,n]);u.useEffect(()=>{if(!e){i(null);return}return o(!0),c(),l.current=setInterval(c,2e3),()=>{l.current&&clearInterval(l.current)}},[e,c]);const d=r?oa(r):null;return{depth:r,analytics:d,levels:5,isLoading:a}}function oa(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((P,x)=>P+x.quantity,0),i=n.reduce((P,x)=>P+x.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,l=t.length>0?t.reduce((P,x)=>x.quantity>P.quantity?x:P,t[0]):null,c=l?{price:l.price,qty:l.quantity}:null,d=n.length>0?n.reduce((P,x)=>x.quantity>P.quantity?x:P,n[0]):null,p=d?{price:d.price,qty:d.quantity}:null,m=r+i,g=m>0?(r-i)/m*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:c,largestAskWall:p,imbalanceScore:g}}function la(){const e=S(l=>l.activeSide),t=S(l=>l.optionExchange),n=S(l=>l.activeSide==="CE"?l.selectedCESymbol:l.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=aa(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(Ce,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((l,c)=>{const d=r.bids?.[c],p=r.asks?.[c],m=Math.max(...r.bids?.map(g=>g.quantity)??[0],...r.asks?.map(g=>g.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:d&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${m>0?d.quantity/m*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:d.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:d?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${m>0?p.quantity/m*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},c)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Es=500;function ca(){const e=u.useRef([]),t=u.useCallback(l=>{const c={...l,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(c),e.current.length>Es&&(e.current=e.current.slice(-Es)),c},[]),n=u.useCallback(()=>[...e.current],[]),r=u.useCallback(l=>e.current.slice(-l),[]),i=u.useCallback(()=>{e.current=[]},[]),a=u.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=u.useCallback(()=>{const l=e.current;if(l.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const c=l.filter(g=>g.pnl!==void 0),d=c.filter(g=>(g.pnl??0)>0),p=c.reduce((g,P)=>g+(P.pnl??0),0),m=c.map(g=>g.pnl??0);return{count:l.length,winRate:c.length>0?d.length/c.length*100:0,avgPnl:c.length>0?p/c.length:0,totalPnl:p,bestTrade:m.length>0?Math.max(...m):0,worstTrade:m.length>0?Math.min(...m):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function da({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(E=>E.sessionPnl),r=S(E=>E.tradeCount),i=S(E=>E.paperMode),a=i?n:e??n,o=xr(),{getStats:l}=ca(),c=l(),[d,p]=u.useState(5e3),[m,g]=u.useState(500),[P,x]=u.useState(50),[f,v]=u.useState(3),j=a<0&&Math.abs(a)>=d;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(Ce,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(Ce,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),j&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(at,{type:"number",value:d,onChange:E=>p(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(at,{type:"number",value:m,onChange:E=>g(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(at,{type:"number",value:P,onChange:E=>x(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(qe,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(at,{type:"number",value:f,onChange:E=>v(Number(E.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),c.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[c.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${c.avgPnl>0?"text-green-500":c.avgPnl<0?"text-red-500":""}`,children:[c.avgPnl>=0?"+":"",c.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",c.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:c.worstTrade.toFixed(0)})]})]})]})]})]})}const ua=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function pa({liveOpenPnl:e,isLivePnl:t=!1}){const n=S(i=>i.controlTab),r=S(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:ua.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx(Ui,{}),n==="auto"&&s.jsx(ra,{}),n==="risk"&&s.jsx(da,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(la,{}),n==="orders"&&s.jsx(ia,{})]})]})}const ma=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE  PE)"},{key:"",description:"CE direct market buy (with virtual TP/SL)"},{key:"",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function fa({open:e,onClose:t}){return u.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:ma.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function xa(e={}){const t=S(y=>y.hotkeysEnabled),n=S(y=>y.activeSide),r=S(y=>y.selectedCESymbol),i=S(y=>y.selectedPESymbol),a=S(y=>y.optionExchange),o=S(y=>y.quantity),l=S(y=>y.lotSize),c=S(y=>y.product),d=S(y=>y.orderType),p=S(y=>y.limitPrice),m=S(y=>y.pendingLimitPlacement),g=S(y=>y.setLimitPrice),P=S(y=>y.setPendingLimitPlacement),x=S(y=>y.clearPendingLimitPlacement),f=S(y=>y.tpPoints),v=S(y=>y.slPoints),j=S(y=>y.setPendingEntryAction),E=S(y=>y.paperMode),M=ie(y=>y.setVirtualTPSL),$=ie(y=>y.triggerOrders),O=ie(y=>y.removeTriggerOrder),F=S(y=>y.setActiveSide),L=S(y=>y.toggleActiveSide),I=S(y=>y.toggleFloatingWidget),w=S(y=>y.setQuantity),B=Ne(y=>y.apiKey),H=Ne(y=>y.setApiKey),G=u.useCallback(()=>n==="CE"?r:i,[n,r,i]),Y=u.useCallback(y=>y==="CE"?r:i,[r,i]),R=u.useCallback(async()=>{if(B)return B;try{const k=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(k.status==="success"&&k.api_key)return H(k.api_key),k.api_key}catch(y){console.error("[Scalping] Failed to fetch API key:",y)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[B,H]),U=u.useCallback(async(y,k,Z=!1)=>{const z=k??n,q=Y(z),h=Z?"MARKET":d;if(!q){console.warn("[Scalping] No symbol selected  click a strike first");return}if(h==="TRIGGER"){const _=Object.values($).find(X=>X.symbol===q&&X.exchange===a&&X.side===z);_&&O(_.id),x(),g(null),j(y),console.log(`[Scalping] TRIGGER armed (${y})  click chart to place trigger line`);return}if(h==="LIMIT"&&!p){j(y),console.log(`[Scalping] LIMIT armed (${y})  click chart to set limit line`);return}if(h==="LIMIT"&&m&&m.symbol===q&&m.side===z){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another.");return}if(E){if(console.log(`[Paper] ${y} ${z} ${q} qty=${o*l} @ ${h}`),h==="MARKET"||h==="LIMIT"){const _=await Rt({symbol:q,exchange:a,preferredPrice:h==="LIMIT"?p??void 0:void 0});_>0&&(M(Je({symbol:q,exchange:a,side:z,action:y,entryPrice:_,quantity:o*l,tpPoints:f,slPoints:v,managedBy:"hotkey"})),h==="LIMIT"&&g(null))}x();return}const b=await R();if(!b)return;const C=h==="LIMIT"?"LIMIT":"MARKET",D={apikey:b,strategy:"Scalping",exchange:a,symbol:q,action:y,quantity:o*l,pricetype:C,product:c,price:h==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${y} ${q} qty=${o*l} ${C}`);const _=await he.placeOrder(D);if(_.status==="success"){const X=ht(_);if(console.log(`[Scalping] Order placed: ${y} ${q} id=${X??"n/a"}`),j(null),C==="LIMIT"){p==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),P({symbol:q,side:z,action:y,orderId:X,quantity:o*l,entryPrice:p??0,tpPoints:f,slPoints:v}),p!=null&&g(p);return}if(x(),C==="MARKET"){const ee=await It({symbol:q,exchange:a,orderId:X,preferredPrice:void 0,apiKey:b});ee>0&&M(Je({symbol:q,exchange:a,side:z,action:y,entryPrice:ee,quantity:o*l,tpPoints:f,slPoints:v,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",_)}catch(_){console.error("[Scalping] Order failed:",_)}},[Y,n,o,l,a,c,d,p,m,f,v,E,$,R,P,x,M,O,g,j]);u.useEffect(()=>{if(!t)return;const y=k=>{const Z=k.target?.tagName;if(Z==="INPUT"||Z==="TEXTAREA"||Z==="SELECT")return;const z=G();switch(k.key.toLowerCase()){case"b":{k.preventDefault(),z&&(U("BUY"),e.onBuy?.(n,z));break}case"s":{k.preventDefault(),z&&(U("SELL"),e.onSell?.(n,z));break}case"c":{k.preventDefault(),z&&e.onClose?.(n,z);break}case"x":{k.preventDefault(),e.onCloseAll?.();break}case"r":{k.preventDefault(),z&&e.onReversal?.(n,z);break}case"w":{k.preventDefault(),I();break}case"tab":{k.preventDefault(),L();break}case"1":{k.preventDefault(),w(1);break}case"2":{k.preventDefault(),w(2);break}case"3":{k.preventDefault(),w(3);break}case"?":{k.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{k.preventDefault(),r&&(F("CE"),U("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{k.preventDefault(),i&&(F("PE"),U("BUY","PE",!0),e.onBuy?.("PE",i));break}}};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[t,n,G,U,L,F,I,w,r,i,e])}const ha=300,Ts=2e3,ks=15,Ls=8e3,Ms=15e3;function $e(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function fn(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=$e(n,Number.NaN);return Number.isFinite(r)?r:null}function ga(e,t,n){if(!e.length)return null;const r=e.find(l=>l.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let l=1;l<e.length;l++){const c=Math.abs(e[l].strike-i);c<o&&(a=e[l],o=c)}return a}function ya(e){return $e(e.ce?.oi,0)+$e(e.pe?.oi,0)}function ba(e){return[...e].map(t=>({strike:t.strike,score:Math.abs($e(fn(t,"net_gex"),0))||ya(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function va(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const l of e){const c=l.strike,d=$e(l.ce?.oi,0),p=$e(l.pe?.oi,0);a>c?o+=(a-c)*d:a<c&&(o+=(c-a)*p)}o<r&&(r=o,n=a)}return n}function Sa(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function Rs(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!Sa(e.topGammaStrikes,t.topGammaStrikes)}function Is(e,t){const n=fn(e,"iv");return n!=null&&n>0?n:t}function Pa(e){return e.replace(/-/g,"").toUpperCase()}function $s(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=$e(e.underlying_ltp,0),a=$e(e.atm_strike,0),o=ga(r,a,i),l=r.reduce((F,L)=>(F.ceOi+=$e(L.ce?.oi,0),F.peOi+=$e(L.pe?.oi,0),F.ceVol+=$e(L.ce?.volume,0),F.peVol+=$e(L.pe?.volume,0),F),{ceOi:0,peOi:0,ceVol:0,peVol:0}),c=l.ceOi>0?l.peOi/l.ceOi:1,d=va(r,o?.strike??a),p=i-d,m=ba(r),g=fn(e,"total_net_gex"),P=g??0,x=t?.ceIV??ks,f=t?.peIV??ks,v=Is(o?.ce,x),j=Is(o?.pe,f),E=(v+j)/2,M=v-j,$=fn(e,"iv_percentile")??t?.ivPercentile??50,O=$e(o?.ce?.ltp,0)+$e(o?.pe?.ltp,0);return{pcr:c,oiChangeCE:l.ceOi,oiChangePE:l.peOi,maxPainStrike:d,spotVsMaxPain:p,topGammaStrikes:m,gexFlipZones:[],netGEX:P,atmIV:E,ivPercentile:$,ceIV:v,peIV:j,ivSkew:M,straddlePrice:O,lastUpdated:n>0?n:Date.now()}}function ja(){const e=Ne(f=>f.apiKey),t=S(f=>f.underlying),n=S(f=>f.expiry),r=S(f=>f.indexExchange),i=S(f=>f.chainStrikeCount),a=S(f=>f.optionChainData),o=S(f=>f.optionChainLastUpdate),l=S(f=>f.optionChainIsStreaming),c=W(f=>f.optionsContext),d=W(f=>f.setOptionsContext),p=u.useRef(0),m=u.useRef(!1),g=u.useRef(0),P=u.useRef(null);u.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const f=Date.now();if(f-p.current<ha)return;const v=$s(a,c,o||f);if(!v)return;const j=Rs(c,v),E=!c||f-c.lastUpdated>=Ts;!j&&!E||(d(v),p.current=f)},[a,o,c,d]);const x=u.useCallback(async()=>{if(m.current||!e||!t||!n||!r)return;const f=Date.now();if(!(f-g.current<Ms||a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||f-(o||0)<=Ls))){m.current=!0,g.current=f;try{const j=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,underlying:t,exchange:r,expiry_date:Pa(n),strike_count:i})});if(!j.ok)return;const E=await j.json();if(E.status!=="success"||!Array.isArray(E.chain)||E.chain.length===0)return;const M=$s(E,c,Date.now());if(!M)return;const $=Rs(c,M),O=!c||Date.now()-c.lastUpdated>=Ts;if(!$&&!O)return;d(M),p.current=Date.now()}catch{}finally{m.current=!1}}},[e,t,n,r,i,a,l,o,c,d]);u.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||Date.now()-(o||0)<=Ls)){P.current&&(clearInterval(P.current),P.current=null);return}return x(),P.current&&clearInterval(P.current),P.current=setInterval(()=>{x()},Ms),()=>{P.current&&(clearInterval(P.current),P.current=null)}},[a,l,o,x])}function Na(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let l=1;l<n.length;l++)n[l]>n[l-1]?r++:n[l]<n[l-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function wa(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(d=>d.high),i=n.map(d=>d.low),a=Math.max(...r)-Math.min(...i),o=n.map(d=>d.close),l=Math.abs(o[o.length-1]-o[0]),c=n.reduce((d,p)=>d+(p.high-p.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":l>a*.6?"TRENDING":c>a*.15?"VOLATILE":"RANGING"}function Ca(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function Ea(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1));const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function Ta(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function ka(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function La(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Ma(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function Ra(e,t,n,r,i,a,o,l,c,d,p,m=[],g){let P=0;const x=[],f=Date.now(),v=[],j=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,E=n.respectHotZones?c:1,M=Math.max(.25,E*Math.max(.1,n.sensitivityMultiplier)),$=Math.min(10,Math.max(1,n.entryMinScore/M)),O=(h,b,C,D)=>{v.push({id:h,label:b,pass:C,value:D})},F=(h,b)=>({enter:!1,reason:h,score:P,minScore:Number($.toFixed(2)),checks:v,blockedBy:b,spread:d,depthRatio:j,expectedSlippage:Math.max(0,d/2)}),L=r.tradesCount<n.maxTradesPerDay;if(O("daily-trades","Daily trade cap",L,`${r.tradesCount}/${n.maxTradesPerDay}`),!L)return F("Max daily trades reached","daily-trades");const I=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(O("daily-loss","Daily loss limit",I,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!I)return F("Daily loss limit reached","daily-loss");const w=r.consecutiveLosses<n.coolingOffAfterLosses;if(O("cooling-off","Consecutive-loss cooling off",w,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!w)return F(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const B=!r.killSwitch;if(O("kill-switch","Kill switch",B),!B)return F("Kill switch active","kill-switch");const H=!n.respectHotZones||E>0;if(O("hot-zone","Market hot-zone timing",H,n.respectHotZones?E.toFixed(2):"OFF"),!H)return F("Outside configured market hot-zone timing","hot-zone");const G=!r.sideOpen;if(O("side-open","No open position on side",G),!G)return F(`Position already open on ${e}`,"side-open");const Y=r.reEntryCountForSide??0,R=r.lastExitAtForSide??0;if(!n.reEntryEnabled&&Y>0)return O("reentry-enabled","Re-entry enabled",!1,"OFF"),F(`Re-entry disabled for ${e}`,"reentry-enabled");if(O("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||Y<n.reEntryMaxPerSide,`${Y}/${n.reEntryMaxPerSide}`),n.reEntryEnabled&&n.reEntryMaxPerSide>0&&Y>=n.reEntryMaxPerSide)return F(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryEnabled&&n.reEntryDelaySec>0&&R>0){const h=f-R,b=n.reEntryDelaySec*1e3,C=h>=b;if(O("reentry-delay","Re-entry delay",C,C?`${n.reEntryDelaySec}s`:`${Math.ceil((b-h)/1e3)}s left`),!C)return F(`Re-entry delay active: ${Math.ceil((b-h)/1e3)}s`,"reentry-delay")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return O("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),F(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(O("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const h=r.lastTradePnl>-n.perTradeMaxLoss;if(O("per-trade-loss","Per-trade max loss",h,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!h)return F("Last trade breached per-trade max loss","per-trade-loss")}else O("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const h=f-r.lastTradeTime,b=h>=n.minGapMs;if(O("min-gap","Minimum gap between entries",b,b?`${h}ms`:`${n.minGapMs-h}ms left`),h<n.minGapMs)return F(`Min gap: ${Math.ceil((n.minGapMs-h)/1e3)}s remaining`,"min-gap")}else O("min-gap","Minimum gap between entries",!0);if(O("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return F(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const h=f-r.lastLossTime,b=n.cooldownAfterLossSec*1e3,C=h>=b;if(O("loss-cooldown","Cooldown after loss",C,C?`${n.cooldownAfterLossSec}s`:`${Math.ceil((b-h)/1e3)}s left`),h<b)return F(`Cooldown: ${Math.ceil((b-h)/1e3)}s after loss`,"loss-cooldown")}else O("loss-cooldown","Cooldown after loss",!0);if(p){const h=Ma(p.totalBid,p.totalAsk,e,n);if(O("depth-imbalance","Depth imbalance",h.allowed,h.reason),!h.allowed)return F(h.reason,"depth-imbalance")}else O("depth-imbalance","Depth imbalance",!0,"No depth data");if(O("spread","Spread gate",d<=n.entryMaxSpread,`${d.toFixed(2)}/${n.entryMaxSpread}`),d>n.entryMaxSpread)return F(`Spread too wide: ${d.toFixed(1)}`,"spread");if(n.volumeInfluenceEnabled){const h=Math.max(.1,n.indexVolumeMinRatio||1),b=Math.max(.1,n.optionVolumeMinRatio||1),C=Math.max(.1,n.sideVolumeDominanceRatio||1),D=Math.max(0,n.volumeScoreWeight||0),_=g?.indexDeltaRatio??null,X=g?.optionDeltaRatio??null,ee=g?.sideDominanceRatio??null,ne=g?.indexDelta,re=g?.optionDelta,ye=g?.oppositeDelta,ue=_==null?!0:_>=h,T=X==null?!0:X>=b,se=ee==null?!0:ee>=C;if(O("volume-index","Index volume flow",ue,_==null?"NA":`${_.toFixed(2)}x/${h.toFixed(2)}x d:${(ne??0).toFixed(0)}`),O("volume-option",`${e} volume flow`,T,X==null?"NA":`${X.toFixed(2)}x/${b.toFixed(2)}x d:${(re??0).toFixed(0)}`),O("volume-dominance",`${e} vs opposite volume`,se,ee==null?"NA":`${ee.toFixed(2)}x/${C.toFixed(2)}x opp:${(ye??0).toFixed(0)}`),X!=null&&ee!=null&&!T&&!se)return F(`Weak ${e} volume participation`,"volume-option");_!=null&&ue&&D>0&&(P+=.5*D,x.push(`IdxVol x${_.toFixed(2)}`)),X!=null&&T&&D>0&&(P+=1*D,x.push(`${e}Vol x${X.toFixed(2)}`)),ee!=null&&se&&D>0&&(P+=.75*D,x.push(`${e}>Opp x${ee.toFixed(2)}`))}else O("volume-influence","Volume influence",!0,"OFF");const U=n.noTradeZoneEnabled&&Ca(m,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(O("no-trade-zone","No-trade zone filter",!U,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),U)return F(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const y=e==="CE"?"up":"down";O("momentum-direction","Momentum alignment",i.direction===y,`${i.direction} x${i.count}`),i.direction===y&&i.count>=n.entryMomentumCount?(P+=3,x.push(`Momentum ${i.direction} x${i.count}`)):i.direction===y&&(P+=1,x.push(`Weak momentum ${i.direction}`)),O("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(P+=2,x.push(`Velocity ${i.velocity.toFixed(1)}`));let k=!1;a.ema9!==null&&a.ema21!==null&&(k=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,k&&(P+=1,x.push("EMA aligned"))),O("ema","EMA alignment",k,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let Z=!1;a.rsi!==null&&(Z=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,Z&&(P+=1,x.push(`RSI ${a.rsi.toFixed(0)}`))),O("rsi","RSI alignment",Z,a.rsi!=null?a.rsi.toFixed(1):"NA");let z=!1;n.indexBiasEnabled&&(z=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",z&&(P+=1,x.push(`Index ${o.direction}`))),O("index-bias","Index bias alignment",n.indexBiasEnabled?z:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const q=Ta(e,l,n);return O("options-context","Options context filter",q.allowed,q.reason),q.allowed?(O("score-gate","Final score gate",P>=$,`${P.toFixed(1)}/${$.toFixed(1)}`),{enter:P>=$,reason:x.join(", ")||"No strong signals",score:P,minScore:Number($.toFixed(2)),checks:v,spread:d,depthRatio:j,expectedSlippage:Math.max(0,d/2)}):F(q.reason,"options-context")}function Ia(e,t,n,r,i,a,o){const l=i?n-t:t-n,c=i?r-t:t-r,d=ka(a.trailInitialSL,o,a);if(e==="INITIAL"){const m=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return l>=m?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-d:t+d,newStage:"INITIAL"}}return e==="BREAKEVEN"?c>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?c>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?c>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function $a(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}function As(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function Aa(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let c=1;c<=t;c++){const d=e[c]-e[c-1];d>0?n+=d:r+=-d}let i=n/t,a=r/t;for(let c=t+1;c<e.length;c++){const d=e[c]-e[c-1],p=d>0?d:0,m=d<0?-d:0;i=(i*(t-1)+p)/t,a=(a*(t-1)+m)/t}if(a===0)return 100;const l=100-100/(1+i/a);return Number.isFinite(l)?l:null}function Os(e){return{ema9:As(e,9),ema21:As(e,21),supertrend:null,rsi:Aa(e,14),vwap:null}}function Ln(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function Mn(e,t,n=360){e.push(t),e.length>n&&e.splice(0,e.length-n)}function Rn(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const n=Math.max(3,t+1),r=e.slice(-n);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const i=[];for(let d=1;d<r.length;d++){const p=r[d]-r[d-1];i.push(p>0&&Number.isFinite(p)?p:0)}if(i.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const a=i[i.length-1],o=i.slice(0,-1),l=o.length>0?o.reduce((d,p)=>d+p,0)/o.length:0,c=l>0?a/l:null;return{latestDelta:a,avgDelta:l>0?l:null,ratio:c}}function Oa(e){const n=Ne(A=>A.apiKey),r=S(A=>A.underlying),i=S(A=>A.indexExchange),a=S(A=>A.selectedCESymbol),o=S(A=>A.selectedPESymbol),l=S(A=>A.optionExchange),c=S(A=>A.quantity),d=S(A=>A.lotSize),p=S(A=>A.product),m=S(A=>A.tpPoints),g=S(A=>A.slPoints),P=S(A=>A.selectedStrike),x=S(A=>A.paperMode),f=W(A=>A.enabled),v=W(A=>A.mode),j=W(A=>A.config),E=W(A=>A.activePresetId),M=W(A=>A.optionsContext),$=W(A=>A.regime),O=W(A=>A.consecutiveLosses),F=W(A=>A.tradesCount),L=W(A=>A.realizedPnl),I=W(A=>A.lastTradePnl),w=W(A=>A.lastTradeTime),B=W(A=>A.tradesThisMinute),H=W(A=>A.lastLossTime),G=W(A=>A.sideEntryCount),Y=W(A=>A.sideLastExitAt),R=W(A=>A.replayMode),U=W(A=>A.killSwitch),y=W(A=>A.lockProfitTriggered),k=W(A=>A.setRegime),Z=W(A=>A.addGhostSignal),z=W(A=>A.recordTrade),q=W(A=>A.recordAutoEntry),h=W(A=>A.pushDecision),b=W(A=>A.pushExecutionSample),C=ie(A=>A.virtualTPSL),D=ie(A=>A.setVirtualTPSL),_=u.useRef([]),X=u.useRef([]),ee=u.useRef([]),ne=u.useRef([]),re=u.useRef([]),ye=u.useRef([]),ue=u.useRef(0),T=u.useRef(!1),se=u.useRef({CE:"",PE:""}),Se=u.useRef({CE:0,PE:0}),be=u.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}});u.useEffect(()=>{if(!f||!e)return;const A=Date.now();if(A-ue.current<100)return;ue.current=A;const fe=a,Pe=o,Ie=e.get(`${i}:${r}`)?.data?.ltp,Ue=fe?e.get(`${l}:${fe}`)?.data?.ltp:void 0,tt=Pe?e.get(`${l}:${Pe}`)?.data?.ltp:void 0,He=Ln(e.get(`${i}:${r}`)?.data?.volume),Ye=fe?Ln(e.get(`${l}:${fe}`)?.data?.volume):null,nt=Pe?Ln(e.get(`${l}:${Pe}`)?.data?.volume):null;Ie&&(_.current.push(Ie),_.current.length>300&&(_.current=_.current.slice(-300))),Ue&&(X.current.push(Ue),X.current.length>300&&(X.current=X.current.slice(-300))),tt&&(ee.current.push(tt),ee.current.length>300&&(ee.current=ee.current.slice(-300))),He!=null&&Mn(ne.current,He),Ye!=null&&Mn(re.current,Ye),nt!=null&&Mn(ye.current,nt);const K=Math.max(5,Number(j.volumeLookbackTicks)||20),ae=Rn(ne.current,K),Ee=Rn(re.current,K),yt=Rn(ye.current,K),bt=E==="expiry",{sensitivity:Ge}=On(new Date,bt),Ve=M&&A-M.lastUpdated<=2e4?M:null;for(const xe of["CE","PE"]){const Q=xe==="CE"?fe:Pe,je=xe==="CE"?Ue:tt,Ze=xe==="CE"?X.current:ee.current,ke=Object.values(C).some(V=>V.side===xe),lt=xe==="CE"?Ee:yt,st=xe==="CE"?yt:Ee,St=lt.latestDelta!=null&&st.latestDelta!=null?lt.latestDelta/Math.max(1,st.latestDelta):null,Pt={indexDelta:ae.latestDelta,indexDeltaRatio:ae.ratio,optionDelta:lt.latestDelta,optionDeltaRatio:lt.ratio,oppositeDelta:st.latestDelta,sideDominanceRatio:St};if(!Q||!je||Ze.length<5)continue;const jt=Na(Ze,j),Kt=Os(Ze),Ut=Os(_.current),$t=Ea(Ut,j),At=`${l}:${Q}`,Ot=e.get(At)?.data?.bid_price,Ht=e.get(At)?.data?.ask_price,ct=Ot&&Ht?Ht-Ot:2,dt=e.get(At)?.data?.depth;let Yt;if(dt?.buy?.length&&dt?.sell?.length){const V=dt.buy.reduce((oe,me)=>oe+(me.quantity||0),0),J=dt.sell.reduce((oe,me)=>oe+(me.quantity||0),0);V>0&&J>0&&(Yt={totalBid:V,totalAsk:J})}const xn={consecutiveLosses:O,tradesCount:F,realizedPnl:L,lastTradeTime:w,tradesThisMinute:B,lastLossTime:H,requestedLots:c,sideOpen:ke,lastExitAtForSide:Y[xe],reEntryCountForSide:G[xe],lastTradePnl:I,killSwitch:U||y},de=Ra(xe,je,j,xn,jt,Kt,$t,Ve,Ge,ct,Yt,Ze,Pt),Ft=`${de.enter}|${de.blockedBy??""}|${de.reason}|${de.score.toFixed(2)}|${de.minScore.toFixed(2)}`;(Ft!==se.current[xe]||A-Se.current[xe]>=1e3)&&(h({timestamp:A,side:xe,symbol:Q,enter:de.enter,score:de.score,minScore:de.minScore,reason:de.reason,blockedBy:de.blockedBy,spread:de.spread,depthRatio:de.depthRatio,expectedSlippage:de.expectedSlippage,checks:de.checks,regime:$}),se.current[xe]=Ft,Se.current[xe]=A);const N=$a(xe,Q,P??0,je,de,$,Ve?.pcr);if(N){const V=`${Q}|${de.reason}|${de.score.toFixed(1)}`,J=be.current[xe];(V!==J.sig||A-J.at>=2500)&&(Z(N),be.current[xe]={at:A,sig:V},hr.message(`Signal ${xe} ${Q.slice(-12)}`,{description:`${de.score.toFixed(1)} / ${de.minScore.toFixed(1)} | ${de.reason}`}))}if(v==="execute"&&!R&&de.enter&&!T.current){T.current=!0;const V="BUY",J=c*d;(async()=>{const me=()=>{const te=W.getState();return te.enabled&&te.mode==="execute"&&!te.replayMode&&!(te.killSwitch||te.lockProfitTriggered)};try{if(!me()){b({timestamp:Date.now(),side:xe,symbol:Q,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}if(!x&&!n)return;let te=null;if(!x&&n){const le={apikey:n,strategy:"Scalping-Auto",exchange:l,symbol:Q,action:V,quantity:J,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},we=await he.placeOrder(le);if(we.status!=="success"){b({timestamp:Date.now(),side:xe,symbol:Q,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Order rejected"});return}te=ht(we),console.log(`[AutoTrade] ${V} ${Q} id=${te??"n/a"} score=${de.score}`)}else console.log(`[AutoTrade Paper] ${V} ${xe} ${Q} score=${de.score}`);if(!me()){b({timestamp:Date.now(),side:xe,symbol:Q,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const pe=x?await Rt({symbol:Q,exchange:l,preferredPrice:je,apiKey:null}):await It({symbol:Q,exchange:l,orderId:te,preferredPrice:je,apiKey:n});pe>0&&D(Je({symbol:Q,exchange:l,side:xe,action:V,entryPrice:pe,quantity:J,tpPoints:m,slPoints:g,managedBy:"auto",autoEntryScore:de.score,autoEntryReason:de.reason})),z(0),q(xe),b({timestamp:Date.now(),side:xe,symbol:Q,spread:de.spread,expectedSlippage:Math.max(0,Math.abs((pe>0?pe:je)-je)),status:"filled",reason:de.reason}),j.telegramAlertsEntry&&Hn.sendBroadcast({message:`[AUTO ENTRY] ${xe} ${Q} qty=${J} score=${de.score.toFixed(1)} reason=${de.reason}`}).catch(()=>{})}catch(te){b({timestamp:Date.now(),side:xe,symbol:Q,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",te)}finally{T.current=!1}})()}}const vt=_.current.length>=j.regimeDetectionPeriod?_.current:X.current;if(vt.length>=j.regimeDetectionPeriod){const xe=vt.slice(-j.regimeDetectionPeriod).map((je,Ze,ke)=>({high:Math.max(je,ke[Math.max(0,Ze-1)]??je),low:Math.min(je,ke[Math.max(0,Ze-1)]??je),close:je})),Q=wa(xe,j);Q!==$&&k(Q)}},[f,e,v,j,E,a,o,M,$,O,F,L,w,B,H,I,G,Y,R,U,y,n,l,c,d,p,m,g,x,P,Z,z,q,h,b,k,C,D,r,i])}function Fa(e){const t=Ne(I=>I.apiKey),n=Ne(I=>I.setApiKey),r=S(I=>I.paperMode),i=S(I=>I.product),a=S(I=>I.addSessionPnl),o=S(I=>I.incrementTradeCount),l=W(I=>I.config),c=W(I=>I.optionsContext),d=W(I=>I.recordAutoExit),p=W(I=>I.recordTradeOutcome),m=W(I=>I.pushExecutionSample),g=ie(I=>I.virtualTPSL),P=ie(I=>I.triggerOrders),x=ie(I=>I.removeTriggerOrder),f=ie(I=>I.setVirtualTPSL),v=ie(I=>I.removeVirtualTPSL),j=u.useRef(t),E=u.useRef(r),M=u.useRef(i);u.useEffect(()=>{j.current=t},[t]),u.useEffect(()=>{E.current=r},[r]),u.useEffect(()=>{M.current=i},[i]);const $=u.useRef(new Set),O=u.useCallback(async()=>{if(j.current)return j.current;try{const w=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(w.status==="success"&&w.api_key)return j.current=w.api_key,n(w.api_key),w.api_key}catch(I){console.error("[Scalping] Failed to fetch API key:",I)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[n]),F=u.useCallback(async(I,w,B,H,G)=>{const Y=H==="BUY"?"SELL":"BUY";if(E.current)return console.log(`[Paper TP/SL] ${G}: ${Y} ${I} qty=${B}`),!0;const R=await O();if(!R)return!1;const U={apikey:R,strategy:"Scalping",exchange:w,symbol:I,action:Y,quantity:B,pricetype:"MARKET",product:M.current,price:0,trigger_price:0,disclosed_quantity:0};try{const y=await he.placeOrder(U);if(y.status==="success"){const k=ht(y);return console.log(`[Scalping TP/SL] ${G}: ${Y} ${I} id=${k??"n/a"}`),!0}}catch(y){console.error(`[Scalping TP/SL] ${G} order failed:`,y)}try{if((await he.closePosition(I,w,M.current)).status==="success")return console.log(`[Scalping TP/SL] ${G}: closePosition fallback ${I}`),!0}catch(y){console.error(`[Scalping TP/SL] ${G} closePosition fallback failed:`,y)}return!1},[O]),L=u.useCallback(async(I,w,B,H)=>{if(E.current)return console.log(`[Paper Trigger] Entry: ${H} ${I} qty=${B}`),{ok:!0,orderId:null};const G=await O();if(!G)return{ok:!1,orderId:null};const Y={apikey:G,strategy:"Scalping",exchange:w,symbol:I,action:H,quantity:B,pricetype:"MARKET",product:M.current,price:0,trigger_price:0,disclosed_quantity:0};try{const R=await he.placeOrder(Y);if(R.status==="success"){const U=ht(R);return console.log(`[Scalping Trigger] Entry: ${H} ${I} id=${U??"n/a"}`),{ok:!0,orderId:U}}}catch(R){console.error("[Scalping Trigger] Entry failed:",R)}return{ok:!1,orderId:null}},[O]);u.useEffect(()=>{if(!e)return;const I=(w,B,H)=>{$.current.add(w.id);const Y=w.action==="BUY"?(B-w.entryPrice)*w.quantity:(w.entryPrice-B)*w.quantity;F(w.symbol,w.exchange,w.quantity,w.action,`${H} at ${B}`).then(R=>{R&&(v(w.id),a(Y),o(),w.managedBy==="auto"&&(d(w.side,Y),p(Y),m({timestamp:Date.now(),side:w.side,symbol:w.symbol,spread:0,expectedSlippage:0,status:"exited",reason:H}),l.telegramAlertsExit&&Hn.sendBroadcast({message:`[AUTO EXIT] ${w.side} ${w.symbol} pnl=${Y.toFixed(0)} reason=${H}`}).catch(()=>{}))),$.current.delete(w.id)})};for(const w of Object.values(g)){const B=`${w.exchange}:${w.symbol}`,G=(e.get(B)??e.get(w.symbol))?.data?.ltp;if(!G||$.current.has(w.id))continue;const Y=w.action==="BUY",R=Y?(G-w.entryPrice)*w.quantity:(w.entryPrice-G)*w.quantity;if(w.managedBy==="auto"){if(l.perTradeMaxLoss>0&&R<=-l.perTradeMaxLoss){I(w,G,`Per-trade max loss ${l.perTradeMaxLoss}`);continue}const U=La(w.side,c,l);if(U.exit){I(w,G,`Options early-exit: ${U.reason}`);continue}}if(w.tpPrice!==null&&(Y?G>=w.tpPrice:G<=w.tpPrice)){I(w,G,"TP hit");continue}w.slPrice!==null&&(Y?G<=w.slPrice:G>=w.slPrice)&&I(w,G,"SL hit")}for(const w of Object.values(P)){const B=`${w.exchange}:${w.symbol}`,G=(e.get(B)??e.get(w.symbol))?.data?.ltp;if(!G||$.current.has(w.id))continue;(w.direction==="above"?G>=w.triggerPrice:G<=w.triggerPrice)&&($.current.add(w.id),L(w.symbol,w.exchange,w.quantity,w.action).then(async({ok:R,orderId:U})=>{try{if(R&&(x(w.id),o(),G>0)){const y=j.current,k=E.current?G:await It({symbol:w.symbol,exchange:w.exchange,orderId:U,preferredPrice:G,apiKey:y});k>0&&f(Je({symbol:w.symbol,exchange:w.exchange,side:w.side,action:w.action,entryPrice:k,quantity:w.quantity,tpPoints:w.tpPoints,slPoints:w.slPoints,managedBy:"trigger"}))}}finally{$.current.delete(w.id)}}))}},[e,g,P,F,L,x,f,v,a,o,l,c,d,p,m])}function Da(){const e=W(P=>P.config),t=W(P=>P.optionsContext),n=W(P=>P.setTrailStage),r=W(P=>P.setHighSinceEntry),i=ie(P=>P.virtualTPSL),a=ie(P=>P.updateVirtualTPSL),o=u.useRef(e),l=u.useRef(t),c=u.useRef({}),d=u.useRef({}),p=u.useRef({}),m=u.useRef({});u.useEffect(()=>{o.current=e},[e]),u.useEffect(()=>{l.current=t},[t]);const g=u.useMemo(()=>Object.values(i).filter(P=>P.managedBy==="auto"&&P.slPrice!=null),[i]);u.useEffect(()=>{const P=qt.getInstance(),x=new Set(g.map(f=>f.id));for(const[f,v]of Object.entries(m.current))x.has(f)||(v(),delete m.current[f],delete c.current[f],delete d.current[f],delete p.current[f]);for(const f of g)m.current[f.id]||(c.current[f.id]="INITIAL",d.current[f.id]=f.entryPrice,p.current[f.id]=f.slPrice??f.entryPrice,m.current[f.id]=P.subscribe(f.symbol,f.exchange,"LTP",v=>{const j=v.data.ltp;if(!j||j<=0)return;const E=ie.getState().virtualTPSL[f.id];if(!E||E.slPrice==null)return;const M=E.action==="BUY",$=d.current[f.id]??E.entryPrice,O=M?Math.max($,j):Math.min($,j);O!==$&&(d.current[f.id]=O,r(O));const F=c.current[f.id]??"INITIAL",L=Ia(F,E.entryPrice,j,O,M,o.current,l.current);L.newStage!==F&&(c.current[f.id]=L.newStage,n(L.newStage));const I=Math.round(L.newSL/.05)*.05,w=E.slPrice,B=p.current[f.id],H=M?Math.max(w??I,I):Math.min(w??I,I),G=w==null||Math.abs(H-w)>=.05,Y=B==null||Math.abs(H-B)>=.05;G&&Y&&(p.current[f.id]=H,a(f.id,{slPrice:H}))}));return()=>{}},[g,r,n,a]),u.useEffect(()=>()=>{for(const P of Object.values(m.current))P();m.current={},c.current={},d.current={},p.current={}},[])}const za=2500;function Yn(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function ot(e){return Yn(e)??0}function Va(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function _a(e){const t=Yn(e.pnl);if(t!==null)return t;const n=ot(e.ltp),r=ot(e.average_price),i=Math.abs(ot(e.quantity));return(ot(e.quantity)>0?n-r:r-n)*i}function Ba(){const e=Ne(v=>v.apiKey),t=Ne(v=>v.setApiKey),[n,r]=u.useState([]),[i,a]=u.useState(!1),o=u.useCallback(async()=>{if(e)return e;try{const j=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(j.status==="success"&&j.api_key)return t(j.api_key),j.api_key}catch{}return null},[e,t]),l=u.useCallback(async()=>{const v=await o();if(!v){a(!1);return}a(!0);try{const j=await he.getPositions(v);j.status==="success"&&j.data&&r(Array.isArray(j.data)?j.data:[])}catch{}finally{a(!1)}},[o]);u.useEffect(()=>{l();const v=setInterval(l,za);return()=>clearInterval(v)},[l]);const{data:c,isLive:d,isPaused:p}=jr(n,{enabled:n.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),m=u.useMemo(()=>c.flatMap(v=>{const j=Va(v.symbol);if(!j)return[];const E=ot(v.quantity),M=Math.abs(E);if(M===0)return[];const $=ot(v.ltp),O=ot(v.average_price),F=E>0,L=F?$-O:O-$,w=Yn(v.pnl)??L*M;return[{symbol:v.symbol,exchange:v.exchange,side:j,action:F?"BUY":"SELL",quantity:M,avgPrice:O,ltp:$,pnl:w,pnlPoints:L,product:v.product}]}),[c]),g=u.useMemo(()=>n.some(v=>ot(v.quantity)!==0),[n]),P=u.useMemo(()=>c.reduce((v,j)=>v+_a(j),0),[c]),x=u.useCallback(v=>m.find(j=>j.side===v),[m]),f=u.useMemo(()=>n.map(v=>({symbol:v.symbol,exchange:v.exchange})),[n]);return{positions:m,totalPnl:P,isLive:d&&g,isPaused:p,isLoading:i,refetch:l,getPositionForSide:x,positionSymbols:f}}const qa=15e3;function oo(){const[e,t]=u.useState(!1),n=u.useRef(!1),r=u.useCallback(()=>t(C=>!C),[]),i=u.useCallback(()=>t(!1),[]),a=S(C=>C.paperMode),o=S(C=>C.underlying),l=S(C=>C.indexExchange),c=S(C=>C.optionExchange),d=S(C=>C.product),p=S(C=>C.quantity),m=S(C=>C.lotSize),g=S(C=>C.incrementTradeCount),P=S(C=>C.setLimitPrice),x=S(C=>C.setPendingEntryAction),f=S(C=>C.pendingLimitPlacement),v=S(C=>C.clearPendingLimitPlacement),j=S(C=>C.selectedCESymbol),E=S(C=>C.selectedPESymbol),M=ie(C=>C.virtualTPSL),$=ie(C=>C.triggerOrders),O=ie(C=>C.clearAll),F=ie(C=>C.clearForSymbol),L=ie(C=>C.clearTriggerOrders),I=ie(C=>C.removeVirtualTPSL),w=ie(C=>C.updateVirtualTPSL),B=ie(C=>C.setVirtualTPSL),H=W(C=>C.config.imbalanceFilterEnabled),G=W(C=>C.updateRiskState),Y=Ne(C=>C.apiKey),R=Ne(C=>C.setApiKey);u.useEffect(()=>{Y||fetch("/api/websocket/apikey",{credentials:"include"}).then(C=>C.json()).then(C=>{C.status==="success"&&C.api_key&&R(C.api_key)}).catch(()=>{})},[Y,R]),u.useEffect(()=>{L()},[L]);const U=u.useCallback(async(C,D)=>{if(a){console.log(`[Paper] Close ${C} ${D}`),F(D),P(null),x(null),v();return}try{await he.closePosition(D,c,d),console.log(`[Scalping] Closed ${C} ${D}`),F(D),P(null),x(null),v()}catch(_){console.error("[Scalping] Close failed:",_)}},[a,c,d,F,P,x,v]),y=u.useCallback(async()=>{if(a){console.log("[Paper] Close all positions"),O(),P(null),x(null),v();return}try{await he.closeAllPositions(),console.log("[Scalping] Closed all positions"),O(),P(null),x(null),v()}catch(C){console.error("[Scalping] Close all failed:",C)}},[a,O,P,x,v]),k=u.useCallback(async(C,D)=>{if(a){console.log(`[Paper] Reverse ${C} ${D}`);return}if(Y)try{await he.closePosition(D,c,d),await he.placeOrder({apikey:Y,strategy:"Scalping",exchange:c,symbol:D,action:"SELL",quantity:p*m,pricetype:"MARKET",product:d,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${C} ${D}`)}catch(_){console.error("[Scalping] Reversal failed:",_)}},[a,Y,c,d,p,m]);xa({onToggleHelp:r,onClose:U,onCloseAll:y,onReversal:k}),ja();const Z=u.useMemo(()=>{const C=[];o&&l&&C.push({symbol:o,exchange:l}),j&&C.push({symbol:j,exchange:c}),E&&C.push({symbol:E,exchange:c});for(const _ of Object.values(M))C.push({symbol:_.symbol,exchange:_.exchange});for(const _ of Object.values($))C.push({symbol:_.symbol,exchange:_.exchange});const D=new Map;for(const _ of C)D.set(`${_.exchange}:${_.symbol}`,_);return Array.from(D.values())},[o,l,j,E,c,M,$]),{data:z}=qs({symbols:Z,mode:H?"Quote":"LTP",enabled:Z.length>0}),{positions:q,totalPnl:h,isLive:b}=Ba();return u.useEffect(()=>{G(h)},[h,G]),u.useEffect(()=>{if(a)return;const C=new Map(q.map(ne=>[ne.symbol,ne])),D=Object.values(M);for(const ne of D){const re=C.get(ne.symbol);if(!re){const ye=typeof ne.createdAt=="number"?ne.createdAt:0;if((ye>0?Date.now()-ye:Number.POSITIVE_INFINITY)<qa)continue;I(ne.id);continue}(re.side!==ne.side||re.action!==ne.action||ne.quantity<=0)&&I(ne.id)}const _=Object.values(ie.getState().virtualTPSL),X=new Map;for(const ne of _){const re=X.get(ne.symbol)??[];re.push(ne),X.set(ne.symbol,re)}for(const[ne,re]of X.entries()){const ye=C.get(ne);if(!ye)continue;const ue=Math.max(0,ye.quantity);let se=re.reduce((be,A)=>be+Math.max(0,A.quantity),0)-ue;if(se<=0)continue;const Se=[...re].sort((be,A)=>A.createdAt-be.createdAt);for(const be of Se){if(se<=0)break;const A=Math.max(0,be.quantity);if(A<=se+1e-6){I(be.id),se-=A;continue}const fe=Math.max(0,Number((A-se).toFixed(2)));w(be.id,{quantity:fe}),se=0}}if(!f||n.current)return;const ee=C.get(f.symbol);ee&&(ee.side!==f.side||ee.action!==f.action||(n.current=!0,(async()=>{try{const ne=await It({symbol:f.symbol,exchange:ee.exchange,orderId:f.orderId,preferredPrice:f.entryPrice,fallbackPrice:ee.avgPrice,apiKey:Y});if(ne<=0)return;B(Je({symbol:f.symbol,exchange:ee.exchange,side:f.side,action:f.action,entryPrice:ne,quantity:f.quantity,tpPoints:f.tpPoints,slPoints:f.slPoints,managedBy:"manual"})),g(),v(),P(null),x(null)}finally{n.current=!1}})()))},[a,q,M,f,Y,I,w,B,g,v,P,x]),Oa(z),Da(),Fa(z),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(ii,{liveOpenPnl:h,isLivePnl:b}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:s.jsxs($n,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(pt,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(li,{})}),s.jsx(dn,{withHandle:!0,className:"bg-border/70"}),s.jsx(pt,{defaultSize:"50%",minSize:"30%",children:s.jsx(Ki,{})}),s.jsx(dn,{withHandle:!0,className:"bg-border/70"}),s.jsx(pt,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx(pa,{liveOpenPnl:h,isLivePnl:b})})]})}),s.jsx(ci,{positions:q,totalPnl:h,isLivePnl:b}),s.jsx(fa,{open:e,onClose:i})]})}export{oo as default};
