import{r}from"./vendor-react-BsSNOS8Q.js";import{G as k,H as ee,E as te,g as he}from"./index-C51tMR0S.js";import{a as be}from"./useMarketStatus-BmaMIW4Q.js";const ge={getOptionChain:async(t,e,s,o,a)=>k()?ee("feed","optionchain",{apikey:t,underlying:e,exchange:s,expiry_date:o,strike_count:a??20}):(await te.post("/optionchain",{apikey:t,underlying:e,exchange:s,expiry_date:o,strike_count:a??20})).data,getExpiries:async(t,e,s,o="options")=>k()?ee("feed","expiry",{apikey:t,symbol:e,exchange:s,instrumenttype:o}):(await te.post("/expiry",{apikey:t,symbol:e,exchange:s,instrumenttype:o})).data};function ye(t,e,s,o,a,m={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:i,refreshInterval:d=3e4,pauseWhenHidden:p=!0}=m,{isVisible:_}=he(),T=d>0,[B,g]=r.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),y=r.useRef(null),u=r.useRef(null),S=i&&(!p||_),C=r.useCallback(async()=>{if(!(!t||!e||!s||!o)&&!u.current){g(c=>({...c,isLoading:!0}));try{const c=new AbortController;u.current=c;const I=o.replace(/-/g,"").toUpperCase(),M=await ge.getOptionChain(t,e,s,I,a);M.status==="success"?g(R=>({...R,data:M,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):g(R=>({...R,isLoading:!1,error:M.message||"Failed to fetch option chain"}))}catch(c){c instanceof Error&&(c.name==="AbortError"?u.current===null&&g(I=>({...I,isLoading:!1})):g(I=>({...I,isLoading:!1,error:c.message||"Connection error",isConnected:!1})))}finally{u.current=null}}},[t,e,s,o,a]);r.useEffect(()=>{if(!S){y.current&&(clearInterval(y.current),y.current=null),g(c=>({...c,isPaused:!!i}));return}return g(c=>({...c,isConnected:!0,isPaused:!1})),C(),T&&(y.current=setInterval(C,d)),()=>{y.current&&(clearInterval(y.current),y.current=null),u.current&&(u.current.abort(),u.current=null)}},[S,C,d,i,T]);const h=r.useCallback(()=>{C()},[C]);return{...B,refetch:h}}const Se=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),Ee=new Set(["SENSEX","BANKEX","SENSEX50"]);function ne(t,e){return Se.has(t)?"NSE_INDEX":Ee.has(t)?"BSE_INDEX":e==="BFO"?"BSE":"NSE"}function se(t,e){if(t!=null)return!e||e<=0?t:Number((Math.round(t/e)*e).toFixed(2))}function z(t){if(typeof t=="number")return Number.isFinite(t)?t:null;if(typeof t=="string"&&t.trim().length>0){const e=Number(t);return Number.isFinite(e)?e:null}return null}function ve(t){const e=(t||"").trim().toUpperCase(),s=new Set;return e&&s.add(e),e==="NSE_INDEX"?s.add("NSE"):e==="BSE_INDEX"?s.add("BSE"):e==="NSE"?s.add("NSE_INDEX"):e==="BSE"&&s.add("BSE_INDEX"),Array.from(s)}function K(t,e,s,o){const a=(s||"").trim().toUpperCase();if(!a)return;const m=ve(o);for(const d of m){const p=t.get(`${d}:${a}`);if(p)return p}const i=e.get(a);if(!(!i||i.length===0)){for(const d of m){const p=i.find(_=>_.exchange.toUpperCase()===d);if(p)return p}return i[0]}}function Ne(t,e,s){if(!t.length||e==null||e<=0)return s;let o=t[0].strike,a=Math.abs(t[0].strike-e);for(const m of t){const i=Math.abs(m.strike-e);i<a&&(o=m.strike,a=i)}return o}const Ce=100;function _e(t,e,s,o,a,m,i={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const d=o.toUpperCase(),p=e.toUpperCase(),{enabled:_,oiRefreshInterval:T=3e4,wsMode:B="LTP",pauseWhenHidden:g=!0}=i,[y,u]=r.useState(null),[S,C]=r.useState(null),{data:h,isLoading:c,isConnected:I,isPaused:M,error:R,lastUpdate:P,refetch:oe}=ye(t,e,s,a,m,{enabled:_,refreshInterval:T,pauseWhenHidden:g}),F=r.useMemo(()=>{const f=[],E=ne(e,o);if(f.push({symbol:e,exchange:E}),h?.chain)for(const b of h.chain)b.ce?.symbol&&f.push({symbol:b.ce.symbol,exchange:o}),b.pe?.symbol&&f.push({symbol:b.pe.symbol,exchange:o});return f},[h?.chain,o,e]),{data:A,isConnected:re,isAuthenticated:ae,isPaused:le}=be({symbols:F,mode:B,enabled:_&&F.length>0}),G=r.useRef(0),U=r.useRef(null),$=r.useRef(A),j=r.useRef(h);$.current=A,j.current=h;const q=r.useMemo(()=>()=>{U.current=null;const f=j.current,E=$.current;if(!f){u(null);return}if(E.size===0){u(f);return}const b=new Map;for(const[,n]of E){const v=n.symbol.toUpperCase(),N=b.get(v);N?N.push(n):b.set(v,[n])}const J=f.chain.map(n=>{let v=!1,N=!1,x=n.ce?.ltp,X=n.pe?.ltp,O=n.ce?.volume,W=n.pe?.volume,Y=n.ce?.oi,H=n.pe?.oi;if(n.ce?.symbol){const l=K(E,b,n.ce.symbol,d)?.data;if(l?.ltp!==void 0){const w=se(l.ltp,n.ce.tick_size);w!==void 0&&w!==n.ce.ltp&&(x=w,v=!0)}l?.volume!==void 0&&l.volume!==n.ce.volume&&(O=l.volume,v=!0);const D=l?.oi??l?.open_interest;D!==void 0&&D!==n.ce.oi&&(Y=D,v=!0)}if(n.pe?.symbol){const l=K(E,b,n.pe.symbol,d)?.data;if(l?.ltp!==void 0){const w=se(l.ltp,n.pe.tick_size);w!==void 0&&w!==n.pe.ltp&&(X=w,N=!0)}l?.volume!==void 0&&l.volume!==n.pe.volume&&(W=l.volume,N=!0);const D=l?.oi??l?.open_interest;D!==void 0&&D!==n.pe.oi&&(H=D,N=!0)}if(!v&&!N)return n;const V={...n};return v&&n.ce&&(V.ce={...n.ce,...x!==void 0?{ltp:x}:{},...O!==void 0?{volume:O}:{},...Y!==void 0?{oi:Y}:{}}),N&&n.pe&&(V.pe={...n.pe,...X!==void 0?{ltp:X}:{},...W!==void 0?{volume:W}:{},...H!==void 0?{oi:H}:{}}),V});let Q=!1;for(const[,n]of E)if(n.lastUpdate&&n.lastUpdate>G.current){Q=!0,G.current=n.lastUpdate;break}Q&&C(new Date);const de=ne(p,d).toUpperCase(),fe=K(E,b,p,de),Z=z(fe?.data?.ltp)??z(f.underlying_ltp)??f.underlying_ltp,pe=Ne(J,z(Z),f.atm_strike);u({...f,underlying_ltp:Z,atm_strike:pe,chain:J})},[d,p]),L=r.useCallback(()=>{U.current!==null&&(clearTimeout(U.current),U.current=null)},[]);r.useEffect(()=>{if(!h){L(),u(null);return}if(A.size===0){L(),u(h);return}U.current===null&&(U.current=setTimeout(q,Ce))},[L,h,A,q]),r.useEffect(()=>L,[L]);const ie=re&&ae&&F.length>0,ue=M||le,ce=r.useMemo(()=>!P&&!S?null:P?S&&S>P?S:P:S,[P,S]);return{data:y,isLoading:c,isConnected:I,isStreaming:ie,isPaused:ue,error:R,lastUpdate:ce,streamingSymbols:F.length,refetch:oe}}export{ge as o,_e as u};
