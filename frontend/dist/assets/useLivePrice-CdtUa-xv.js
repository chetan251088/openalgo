import{r as p}from"./vendor-react-CCyQGCED.js";import{t as z}from"./trading-DG7As-lD.js";import{u as T,a as V}from"./useMarketStatus-98g22Ryd.js";import{d as U,g as W}from"./index-Fx6nZlHZ.js";function b(e){if(typeof e=="number")return Number.isFinite(e)?e:0;if(typeof e=="string"){const o=Number(e.replace(/,/g,"").trim());return Number.isFinite(o)?o:0}return 0}function Y(e,o={}){const{enabled:n=!0,staleThreshold:l=5e3,useMultiQuotesFallback:s=!0,multiQuotesRefreshInterval:d=3e4,pauseWhenHidden:c=!0}=o,{apiKey:f}=U(),{isMarketOpen:y,isAnyMarketOpen:w}=T(),{isVisible:M,wasHidden:q,timeSinceHidden:Q}=W(),S=w(),[D,A]=p.useState(new Map),m=p.useRef(Date.now()),C=p.useMemo(()=>e.map(t=>({symbol:t.symbol,exchange:t.exchange})),[e]),{data:E,isConnected:F,isPaused:L,isFallbackMode:H}=V({symbols:C,mode:"LTP",enabled:n&&e.length>0}),I=F&&S&&!L,h=p.useCallback(async()=>{if(!(!f||e.length===0||!s))try{const t=e.map(a=>({symbol:a.symbol,exchange:a.exchange})),g=await z.getMultiQuotes(f,t);if(g.status==="success"&&g.results){const a=new Map;g.results.forEach(r=>{const u=`${r.exchange}:${r.symbol}`;r.data&&a.set(u,r.data)}),A(a)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[f,e,s]);return p.useEffect(()=>{if(!n||e.length===0||!s||c&&!M)return;h(),m.current=Date.now();const t=setInterval(()=>{h(),m.current=Date.now()},d);return()=>clearInterval(t)},[n,e.length,s,h,d,c,M]),p.useEffect(()=>{!q||!M||!s||!n||Q>d&&(h(),m.current=Date.now())},[q,M,Q,d,s,n,h]),{data:p.useMemo(()=>e.map(t=>{const g=`${t.exchange}:${t.symbol}`,a=E.get(g),r=D.get(g),u=b(t.quantity),P=b(t.average_price),O=y(t.exchange)&&a?.data?.ltp&&a.lastUpdate&&Date.now()-a.lastUpdate<l,N=!O&&r?.ltp;let i,k="rest";if(O&&a?.data?.ltp?(i=a.data.ltp,k="websocket"):N&&r?.ltp?(i=r.ltp,k="multiquotes"):(i=t.ltp,k="rest"),u===0)return{...t,_dataSource:"rest"};let v=b(t.pnl),_=b(t.pnlpercent);const $=b(t.today_realized_pnl);if(i&&P>0){let x;u>0?x=(i-P)*u:x=(P-i)*Math.abs(u),v=$+x;const R=Math.abs(P*u);_=R>0?v/R*100:0}return{...t,ltp:i,pnl:v,pnlpercent:_,_dataSource:k}}),[e,E,D,y,l]),isLive:I,isConnected:F,isPaused:L,isFallbackMode:H,isAnyMarketOpen:S,multiQuotes:D,refreshMultiQuotes:h}}function Z(e,o){if(!o)return null;let n=0,l=0,s=0;e.forEach(c=>{n+=c.pnl||0;const f=c.average_price||0,y=c.quantity||0,w=c.ltp||f;l+=f*y,s+=w*y});const d=l>0?n/l*100:0;return{...o,totalholdingvalue:s,totalinvvalue:l,totalprofitandloss:n,totalpnlpercentage:d}}export{Z as c,Y as u};
