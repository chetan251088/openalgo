import{r as s}from"./vendor-react-CCyQGCED.js";import{y as A,M as x}from"./index-FFp2KIV5.js";function L({symbols:n,mode:k="LTP",enabled:i=!0,autoReconnect:y=!0}){const f=A(),g=s.useRef(f?.manager??x.getInstance()),[a,t]=s.useState(new Map),[e,r]=s.useState({isConnected:f?.isConnected??!1,isAuthenticated:f?.isAuthenticated??!1,isPaused:f?.isPaused??!1,isFallbackMode:f?.isFallbackMode??!1,error:f?.error??null}),[o,M]=s.useState(!1),l=s.useRef(new Map),c=s.useRef(null),S=s.useMemo(()=>n.map(m=>`${m.exchange}:${m.symbol}`).sort().join(","),[n]);s.useEffect(()=>{g.current.setAutoReconnect(y)},[y]),s.useEffect(()=>g.current.addStateListener(u=>{r({isConnected:u.isConnected,isAuthenticated:u.isAuthenticated,isPaused:u.isPaused,isFallbackMode:u.isFallbackMode,error:u.error}),M(u.connectionState==="connecting"||u.connectionState==="authenticating")}),[]),s.useEffect(()=>{if(!i||n.length===0){t(new Map),l.current.clear(),c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}const m=g.current;!e.isConnected&&!e.isPaused&&m.connect();const w=()=>{c.current=null;const d=l.current;d.size!==0&&(t(p=>{const b=new Map(p);for(const[C,h]of d)b.set(C,h);return b}),d.clear())},u=[];for(const{symbol:d,exchange:p}of n){const b=m.subscribe(d,p,k,h=>{const _=`${h.exchange}:${h.symbol}`;l.current.set(_,h),c.current===null&&(c.current=requestAnimationFrame(w))});u.push(b);const C=m.getCachedData(d,p);if(C){const h=`${p}:${d}`;l.current.set(h,C)}}return l.current.size>0&&c.current===null&&(c.current=requestAnimationFrame(w)),()=>{u.forEach(d=>d()),c.current!==null&&(cancelAnimationFrame(c.current),c.current=null),l.current.clear()}},[i,S,k]);const D=s.useCallback(async()=>{await g.current.connect()},[]),F=s.useCallback(()=>{g.current.disconnect()},[]);return{data:a,isConnected:e.isConnected,isAuthenticated:e.isAuthenticated,isConnecting:o,isPaused:e.isPaused,isFallbackMode:e.isFallbackMode,error:e.error,connect:D,disconnect:F}}async function R(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function T(){const[n,k]=s.useState({timings:[],holidays:[],isLoading:!0,error:null});s.useEffect(()=>{(async()=>{try{const e={"X-CSRFToken":await R(),"Content-Type":"application/json"},[r,o]=await Promise.all([fetch("/admin/api/timings",{headers:e,credentials:"include"}),fetch("/admin/api/holidays",{headers:e,credentials:"include"})]),M=await r.json(),l=await o.json();k({timings:M.status==="success"?M.market_status||[]:[],holidays:l.status==="success"?l.data||[]:[],isLoading:!1,error:null})}catch(t){k(e=>({...e,isLoading:!1,error:`Failed to fetch market status: ${t}`}))}})()},[]);const i=s.useCallback(a=>{const t=new Date().toISOString().split("T")[0],e=n.holidays.find(r=>r.date===t);if(!e)return!1;if(e.closed_exchanges.includes(a)){const r=e.open_exchanges.find(o=>o.exchange===a);if(r){const o=Date.now();return!(o>=r.start_time&&o<=r.end_time)}return!0}return!1},[n.holidays]),y=s.useCallback(a=>{if(i(a))return!1;const t=n.timings.find(r=>r.exchange===a);if(!t)return!1;const e=Date.now();return e>=t.start_time&&e<=t.end_time},[n.timings,i]),f=s.useCallback(()=>n.timings.some(a=>{const t=Date.now();return t>=a.start_time&&t<=a.end_time&&!i(a.exchange)}),[n.timings,i]),g=s.useCallback(a=>{if(i(a))return"closed";const t=n.timings.find(o=>o.exchange===a);if(!t)return"closed";const e=Date.now(),r=900*1e3;return e<t.start_time-r?"closed":e<t.start_time?"pre-market":e<=t.end_time?"open":"post-market"},[n.timings,i]);return{isMarketOpen:y,isAnyMarketOpen:f,isHolidayForExchange:i,getMarketStatus:g,timings:n.timings,holidays:n.holidays,isLoading:n.isLoading,error:n.error}}export{L as a,T as u};
