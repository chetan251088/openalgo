import{r as u,j as s}from"./vendor-react-BsSNOS8Q.js";import{c as Xe,d as Fe,z as Kt,e as qe,M as Mt,u as ur,A as dr,C as pr,t as Ce,B as Oe,w as Pt}from"./index-Dy6kfXgl.js";import{b7 as Jr}from"./vendor-icons-BJR3KiwM.js";import{u as fr}from"./useQuery-BVCX2I2e.js";import{S as un,a as dn,b as pn,c as fn,d as en}from"./select-CXJ6Bhul.js";import{o as mr,u as ei}from"./useOptionChainLive-D56bHIX0.js";import{u as h,t as Ee}from"./trading-GdNklPxf.js";import{q as xr,K as hr,W as gr,R as yr,n as Ft,h as kt,p as ti}from"./lightweight-charts.production-C1rtC3Ze.js";import{a as Fn}from"./useMarketStatus-Cyc-5XWC.js";import{I as Lt}from"./input-DzxWI4AI.js";import{L as ft}from"./label-JYfqQfxR.js";import{S as xn}from"./switch-Cq4UTywH.js";import{a as ni,r as si,b as ri,c as ii}from"./ai-scalper-D12H5tNj.js";import{u as ai}from"./useLivePrice-BEfLZe9W.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function $e(e,t="Assertion error"){if(!e)throw Error(t)}function on({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function ts(e,t){return t.sort(e==="horizontal"?oi:li)}function oi(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function li(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function br(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function vr(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function ci({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:c,y:l}=vr(r,o),d=e==="horizontal"?c:l;d<a&&(a=d,i=o)}return $e(i,"No rect found"),i}let jn;function ui(){return jn===void 0&&(typeof matchMedia=="function"?jn=!!matchMedia("(pointer:coarse)").matches:jn=!1),jn}function Sr(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=ts(n,Array.from(t.children).filter(br).map(p=>({element:p}))).map(({element:p})=>p),o=[];let c=!1,l,d=[];for(const p of a)if(p.hasAttribute("data-panel")){const f=r.find(y=>y.element===p);if(f){if(l){const y=l.element.getBoundingClientRect(),b=p.getBoundingClientRect();let x;if(c){const m=n==="horizontal"?new DOMRect(y.right,y.top,0,y.height):new DOMRect(y.left,y.bottom,y.width,0),j=n==="horizontal"?new DOMRect(b.left,b.top,0,b.height):new DOMRect(b.left,b.top,b.width,0);switch(d.length){case 0:{x=[m,j];break}case 1:{const P=d[0],E=ci({orientation:n,rects:[y,b],targetRect:P.element.getBoundingClientRect()});x=[P,E===y?j:m];break}default:{x=d;break}}}else d.length?x=d:x=[n==="horizontal"?new DOMRect(y.right,b.top,b.left-y.right,b.height):new DOMRect(b.left,y.bottom,b.width,b.top-y.bottom)];for(const m of x){let j="width"in m?m:m.element.getBoundingClientRect();const P=ui()?37:27;if(j.width<P){const E=P-j.width;j=new DOMRect(j.x-E/2,j.y,j.width+E,j.height)}if(j.height<P){const E=P-j.height;j=new DOMRect(j.x,j.y-E/2,j.width,j.height+E)}o.push({group:e,groupSize:on({group:e}),panels:[l,f],separator:"width"in m?void 0:m,rect:j})}}c=!1,l=f,d=[]}}else if(p.hasAttribute("data-separator")){const f=i.find(y=>y.element===p);f?d.push(f):(l=void 0,d=[])}else c=!0;return o}function di(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function pi(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function fi(e){return e/100*window.innerHeight}function mi(e){return e/100*window.innerWidth}function xi(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function Nn({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=xi(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=pi(t,i);break}case"em":{r=di(t,i);break}case"vh":{r=fi(i);break}case"vw":{r=mi(i);break}}return r}function jt(e){return parseFloat(e.toFixed(3))}function ys(e){const{panels:t}=e,n=on({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=jt(p/n*100)}let c;if(a.defaultSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.defaultSize});c=jt(p/n*100)}let l=0;if(a.minSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.minSize});l=jt(p/n*100)}let d=100;if(a.maxSize!==void 0){const p=Nn({groupSize:n,panelElement:i,styleProp:a.maxSize});d=jt(p/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:c,minSize:l,maxSize:d,panelId:r.id}})}class hi{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let c=0;c<o.length;c++){const l=o[c];try{l.call(null,n)}catch(d){a===null&&(i=!0,a=d)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function ot(e,t,n=0){return Math.abs(jt(e)-jt(t))<=n}let yt={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const Wt=new hi;function mt(){return yt}function ut(e){const t=typeof e=="function"?e(yt):e;if(yt===t)return yt;const n=yt;return yt={...yt,...t},t.cursorFlags!==void 0&&Wt.emit("cursorFlagsChange",yt.cursorFlags),t.interactionState!==void 0&&Wt.emit("interactionStateChange",yt.interactionState),t.mountedGroups!==void 0&&(yt.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const c=ot(a.collapsedSize,r.layout[a.panelId]),l=ot(a.collapsedSize,o[a.panelId]);c&&!l&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),Wt.emit("mountedGroupsChange",yt.mountedGroups)),yt}function gi(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=vr(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function yi(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function bi(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:Ss(e),b:Ss(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;$e(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:vs(bs(n.a)),b:vs(bs(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let c=a.length;for(;c--;){const l=a[c];if(l===o.a)return 1;if(l===o.b)return-1}}return Math.sign(i.a-i.b)}const vi=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function Si(e){const t=getComputedStyle(Pr(e)??e).display;return t==="flex"||t==="inline-flex"}function Pi(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||Si(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||vi.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function bs(e){let t=e.length;for(;t--;){const n=e[t];if($e(n,"Missing node"),Pi(n))return n}return null}function vs(e){return e&&Number(getComputedStyle(e).zIndex)||0}function Ss(e){const t=[];for(;e;)t.push(e),e=Pr(e);return t}function Pr(e){const{parentNode:t}=e;return yi(t)?t.host:t}function ji(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function Ni({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!br(n)||n.contains(e)||e.contains(n))return!0;if(bi(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(ji(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function as(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=Sr(i),o=gi(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&Ni({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function wi(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function bn(e,t){return ot(e,t)?0:e>t?1:-1}function an({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(bn(t,a)<0)if(r){const o=(n+a)/2;bn(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=jt(t),t}function vn({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if(ot(e,0))return t;const o=Object.values(t),c=Object.values(i),l=[...o],[d,p]=r;$e(d!=null,"Invalid first pivot index"),$e(p!=null,"Invalid second pivot index");let f=0;if(a==="keyboard"){{const x=e<0?p:d,m=n[x];$e(m,`Panel constraints not found for index ${x}`);const{collapsedSize:j=0,collapsible:P,minSize:E=0}=m;if(P){const D=o[x];if($e(D!=null,`Previous layout not found for panel index ${x}`),ot(D,j)){const L=E-D;bn(L,Math.abs(e))>0&&(e=e<0?0-L:L)}}}{const x=e<0?d:p,m=n[x];$e(m,`No panel constraints found for index ${x}`);const{collapsedSize:j=0,collapsible:P,minSize:E=0}=m;if(P){const D=o[x];if($e(D!=null,`Previous layout not found for panel index ${x}`),ot(D,E)){const L=D-j;bn(L,Math.abs(e))>0&&(e=e<0?0-L:L)}}}}{const x=e<0?1:-1;let m=e<0?p:d,j=0;for(;;){const E=o[m];$e(E!=null,`Previous layout not found for panel index ${m}`);const D=an({panelConstraints:n[m],size:100})-E;if(j+=D,m+=x,m<0||m>=n.length)break}const P=Math.min(Math.abs(e),Math.abs(j));e=e<0?0-P:P}{let x=e<0?d:p;for(;x>=0&&x<n.length;){const m=Math.abs(e)-Math.abs(f),j=o[x];$e(j!=null,`Previous layout not found for panel index ${x}`);const P=j-m,E=an({panelConstraints:n[x],size:P});if(!ot(j,E)&&(f+=j-E,l[x]=E,f.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?x--:x++}}if(wi(c,l))return i;{const x=e<0?p:d,m=o[x];$e(m!=null,`Previous layout not found for panel index ${x}`);const j=m+f,P=an({panelConstraints:n[x],size:j});if(l[x]=P,!ot(P,j)){let E=j-P,D=e<0?p:d;for(;D>=0&&D<n.length;){const L=l[D];$e(L!=null,`Previous layout not found for panel index ${D}`);const k=L+E,z=an({panelConstraints:n[D],size:k});if(ot(L,z)||(E-=z-L,l[D]=z),ot(E,0))break;e>0?D--:D++}}}const y=Object.values(l).reduce((x,m)=>m+x,0);if(!ot(y,100,.1))return i;const b=Object.keys(i);return l.reduce((x,m,j)=>(x[b[j]]=m,x),{})}function Ht(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||bn(e[n],t[n])!==0)return!1;return!0}function Yt({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,c)=>o+c,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!ot(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const c=n[o];$e(c!=null,`No layout data found for index ${o}`);const l=100/r*c;n[o]=l}let i=0;for(let o=0;o<t.length;o++){const c=n[o];$e(c!=null,`No layout data found for index ${o}`);const l=an({panelConstraints:t[o],size:c});c!=l&&(i+=c-l,n[o]=l)}if(!ot(i,0))for(let o=0;o<t.length;o++){const c=n[o];$e(c!=null,`No layout data found for index ${o}`);const l=c+i,d=an({panelConstraints:t[o],size:l});if(c!==d&&(i-=d-c,n[o]=d,ot(i,0)))break}const a=Object.keys(e);return n.reduce((o,c,l)=>(o[a[l]]=c,o),{})}function jr({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:c}=mt();for(const[l,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:f,separatorToPanels:y}]of c)if(l.id===e)return{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:l,layout:f,separatorToPanels:y};throw Error(`Group ${e} not found`)},r=()=>{const c=n().derivedPanelConstraints.find(l=>l.panelId===t);if(c!==void 0)return c;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const c=n().group.panels.find(l=>l.id===t);if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const c=n().layout[t];if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},o=c=>{const l=a();if(c===l)return;const{defaultLayoutDeferred:d,derivedPanelConstraints:p,group:f,layout:y,separatorToPanels:b}=n(),x=f.panels.findIndex(E=>E.id===t),m=x===f.panels.length-1,j=vn({delta:m?l-c:c-l,initialLayout:y,panelConstraints:p,pivotIndices:m?[x-1,x]:[x,x+1],prevLayout:y,trigger:"imperative-api"}),P=Yt({layout:j,panelConstraints:p});Ht(y,P)||ut(E=>({mountedGroups:new Map(E.mountedGroups).set(f,{defaultLayoutDeferred:d,derivedPanelConstraints:p,layout:P,separatorToPanels:b})}))};return{collapse:()=>{const{collapsible:c,collapsedSize:l}=r(),{mutableValues:d}=i(),p=a();c&&p!==l&&(d.expandToSize=p,o(l))},expand:()=>{const{collapsible:c,collapsedSize:l,minSize:d}=r(),{mutableValues:p}=i(),f=a();if(c&&f===l){let y=p.expandToSize??d;y===0&&(y=1),o(y)}},getSize:()=>{const{group:c}=n(),l=a(),{element:d}=i(),p=c.orientation==="horizontal"?d.offsetWidth:d.offsetHeight;return{asPercentage:l,inPixels:p}},isCollapsed:()=>{const{collapsible:c,collapsedSize:l}=r(),d=a();return c&&ot(l,d)},resize:c=>{if(a()!==c){let l;switch(typeof c){case"number":{const{group:d}=n(),p=on({group:d});l=jt(c/p*100);break}case"string":{l=parseFloat(c);break}}o(l)}}}}function Ps(e){if(e.defaultPrevented)return;const{mountedGroups:t}=mt(),n=as(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(c=>c.panelConstraints.defaultSize!==void 0);if(o){const c=o.panelConstraints.defaultSize,l=jr({groupId:a.group.id,panelId:o.id});l&&c!==void 0&&(l.resize(c),e.preventDefault())}}})}function On(e){const{mountedGroups:t}=mt();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function Nr({groupId:e}){const t=()=>{const{mountedGroups:n}=mt();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:c}=t(),l=Yt({layout:n,panelConstraints:i});return r?o:(Ht(o,l)||ut(d=>({mountedGroups:new Map(d.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:l,separatorToPanels:c})})),l)}}}function wr(e){const{mountedGroups:t}=mt(),n=t.get(e);return $e(n,`Mounted Group ${e.id} not found`),n}function Bt(e,t){const n=On(e),r=wr(n),i=n.separators.find(p=>p.element===e);$e(i,"Matching separator not found");const a=r.separatorToPanels.get(i);$e(a,"Matching panels not found");const o=a.map(p=>n.panels.indexOf(p)),c=Nr({groupId:n.id}).getLayout(),l=vn({delta:t,initialLayout:c,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:c,trigger:"keyboard"}),d=Yt({layout:l,panelConstraints:r.derivedPanelConstraints});Ht(c,d)||ut(p=>({mountedGroups:new Map(p.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:d,separatorToPanels:r.separatorToPanels})}))}function js(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=On(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&Bt(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&Bt(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&Bt(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&Bt(t,-5);break}case"End":{e.preventDefault(),Bt(t,100);break}case"Enter":{e.preventDefault();const r=On(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=wr(r),c=r.separators.find(f=>f.element===t);$e(c,"Matching separator not found");const l=o.get(c);$e(l,"Matching panels not found");const d=l[0],p=i.find(f=>f.panelId===d.id);if($e(p,"Panel metadata not found"),p.collapsible){const f=a[d.id],y=p.collapsedSize===f?r.inMemoryLastExpandedPanelSizes[d.id]??p.minSize:p.collapsedSize;Bt(t,y-f)}break}case"F6":{e.preventDefault();const r=On(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);$e(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),Bt(t,-100);break}}}function Ns(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=mt(),n=as(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let c=!1;n.forEach(l=>{r.add(l.group),l.panels.forEach(p=>{i.add(p)}),l.separator&&(a.add(l.separator),c||(c=!0,l.separator.element.focus()));const d=t.get(l.group);d&&o.set(l.group,d.layout)}),ut({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const ki=e=>e,Gn=()=>{},kr=1,Tr=2,Er=4,Cr=8,ws=3,ks=12;let wn;function Ts(){return wn===void 0&&(wn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(wn=!0)),wn}function Ti({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&Ts()){const a=(e&kr)!==0,o=(e&Tr)!==0,c=(e&Er)!==0,l=(e&Cr)!==0;if(a)return c?"se-resize":l?"ne-resize":"e-resize";if(o)return c?"sw-resize":l?"nw-resize":"w-resize";if(c)return"s-resize";if(l)return"n-resize"}break}}return Ts()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const Es=new WeakMap;function os(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=Es.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=mt();switch(i.state){case"active":case"hover":{const a=Ti({cursorFlags:r,groups:i.hitRegions.map(c=>c.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}Es.set(e,{prevStyle:t,styleSheet:n})}function Lr({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let c=0;const l=new Map(i);n.forEach(p=>{const{group:f,groupSize:y}=p,{disableCursor:b,orientation:x,panels:m}=f;let j=0;a?x==="horizontal"?j=(t.clientX-a.x)/y*100:j=(t.clientY-a.y)/y*100:x==="horizontal"?j=t.clientX<0?-100:100:j=t.clientY<0?-100:100;const P=r.get(f),{defaultLayoutDeferred:E,derivedPanelConstraints:D,layout:L,separatorToPanels:k}=i.get(f)??{defaultLayoutDeferred:!1};if(D&&P&&L&&k){const z=vn({delta:j,initialLayout:P,panelConstraints:D,pivotIndices:p.panels.map(M=>m.indexOf(M)),prevLayout:L,trigger:"mouse-or-touch"});if(Ht(z,L)){if(j!==0&&!b)switch(x){case"horizontal":{c|=j<0?kr:Tr;break}case"vertical":{c|=j<0?Er:Cr;break}}}else{l.set(p.group,{defaultLayoutDeferred:E,derivedPanelConstraints:D,layout:z,separatorToPanels:k});const M=p.group.panels.map(({id:q})=>q).join(",");p.group.inMemoryLayouts[M]=z}}});let d=0;t.movementX===0?d|=o&ws:d|=c&ws,t.movementY===0?d|=o&ks:d|=c&ks,ut({cursorFlags:d,mountedGroups:l}),os(e)}function Cs(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=mt();n.state==="active"&&Lr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function Ls(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=mt();switch(n.state){case"active":{if(e.buttons===0){ut(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),ut(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Lr({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=as(e,r);i.length===0?n.state!=="inactive"&&ut({interactionState:{state:"inactive"}}):ut({interactionState:{hitRegions:i,state:"hover"}}),os(e.currentTarget);break}}}function Ms(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=mt();t.state==="active"&&(ut({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(os(e.currentTarget),ut(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function Is(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=jt(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=jt((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function Ei(e,t,n){if(!n[0])return;const r=e.panels.find(l=>l.element===t);if(!r||!r.onResize)return;const i=on({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,c={asPercentage:jt(a/i*100),inPixels:a};r.mutableValues.prevSize=c,r.onResize(c,r.id,o)}function Ci(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function Li(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const tn=new Map;function Mi(e){let t=!0;$e(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(x=>{for(const m of x){const{borderBoxSize:j,target:P}=m;if(P===e.element){if(t){if(on({group:e})===0)return;ut(E=>{const D=E.mountedGroups.get(e);if(D){const L=ys(e),k=D.defaultLayoutDeferred?Is(L):D.layout,z=Yt({layout:k,panelConstraints:L});return!D.defaultLayoutDeferred&&Ht(k,z)&&Ci(D.derivedPanelConstraints,L)?E:{mountedGroups:new Map(E.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:L,layout:z,separatorToPanels:D.separatorToPanels})}}return E})}}else Ei(e,P,j)}});a.observe(e.element),e.panels.forEach(x=>{$e(!r.has(x.id),`Panel ids must be unique; id "${x.id}" was used more than once`),r.add(x.id),x.onResize&&a.observe(x.element)});const o=on({group:e}),c=ys(e),l=e.panels.map(({id:x})=>x).join(",");let d=e.defaultLayout;d&&(Li(e.panels,d)||(d=void 0));const p=e.inMemoryLayouts[l]??d??Is(c),f=Yt({layout:p,panelConstraints:c}),y=Sr(e),b=e.element.ownerDocument;return ut(x=>{const m=new Map;return tn.set(b,(tn.get(b)??0)+1),y.forEach(j=>{j.separator&&m.set(j.separator,j.panels)}),{mountedGroups:new Map(x.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:c,layout:f,separatorToPanels:m})}}),e.separators.forEach(x=>{$e(!i.has(x.id),`Separator ids must be unique; id "${x.id}" was used more than once`),i.add(x.id),x.element.addEventListener("keydown",js)}),tn.get(b)===1&&(b.addEventListener("dblclick",Ps,!0),b.addEventListener("pointerdown",Ns,!0),b.addEventListener("pointerleave",Cs),b.addEventListener("pointermove",Ls),b.addEventListener("pointerup",Ms,!0)),function(){t=!1,tn.set(b,Math.max(0,(tn.get(b)??0)-1)),ut(x=>{const m=new Map(x.mountedGroups);return m.delete(e),{mountedGroups:m}}),e.separators.forEach(x=>{x.element.removeEventListener("keydown",js)}),tn.get(b)||(b.removeEventListener("dblclick",Ps,!0),b.removeEventListener("pointerdown",Ns,!0),b.removeEventListener("pointerleave",Cs),b.removeEventListener("pointermove",Ls),b.removeEventListener("pointerup",Ms,!0)),a.disconnect()}}function Mr(){const[e,t]=u.useState({}),n=u.useCallback(()=>t({}),[]);return[e,n]}function ls(e){const t=u.useId();return`${e??t}`}const Qt=typeof window<"u"?u.useLayoutEffect:u.useEffect;function gn(e){const t=u.useRef(e);return Qt(()=>{t.current=e},[e]),u.useCallback((...n)=>t.current?.(...n),[t])}function cs(...e){return gn(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function Ii(e){const t=u.useRef({...e});return Qt(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const Ir=u.createContext(null);function Ri(e,t){const n=u.useRef({getLayout:()=>({}),setLayout:ki});u.useImperativeHandle(t,()=>n.current,[]),Qt(()=>{Object.assign(n.current,Nr({groupId:e}))})}function Rr({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:c,onLayoutChange:l,onLayoutChanged:d,orientation:p="horizontal",style:f,...y}){const b=u.useRef({onLayoutChange:{},onLayoutChanged:{}}),x=gn(V=>{Ht(b.current.onLayoutChange,V)||(b.current.onLayoutChange=V,l?.(V))}),m=gn(V=>{Ht(b.current.onLayoutChanged,V)||(b.current.onLayoutChanged=V,d?.(V))}),j=ls(c),P=u.useRef(null),[E,D]=Mr(),L=u.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),k=cs(P,a);Ri(j,o);const z=gn((V,Z)=>{const{interactionState:$,mountedGroups:re}=mt();for(const I of re.keys())if(I.id===V){const N=re.get(I);if(N){let U=!1;return $.state==="active"&&(U=$.hitRegions.some(g=>g.group===I)),{flexGrow:N.layout[Z]??1,pointerEvents:U?"none":void 0}}}return{flexGrow:n?.[Z]??1}}),M=u.useMemo(()=>({getPanelStyles:z,id:j,orientation:p,registerPanel:V=>{const Z=L.current;return Z.panels=ts(p,[...Z.panels,V]),D(),()=>{Z.panels=Z.panels.filter($=>$!==V),D()}},registerSeparator:V=>{const Z=L.current;return Z.separators=ts(p,[...Z.separators,V]),D(),()=>{Z.separators=Z.separators.filter($=>$!==V),D()}}}),[z,j,D,p]),q=Ii({defaultLayout:n,disableCursor:r}),ee=u.useRef(null);return Qt(()=>{const V=P.current;if(V===null)return;const Z=L.current,$={defaultLayout:q.defaultLayout,disableCursor:!!q.disableCursor,disabled:!!i,element:V,id:j,inMemoryLastExpandedPanelSizes:L.current.lastExpandedPanelSizes,inMemoryLayouts:L.current.layouts,orientation:p,panels:Z.panels,separators:Z.separators};ee.current=$;const re=Mi($),I=mt().mountedGroups.get($);if(I){const{defaultLayoutDeferred:g,derivedPanelConstraints:S,layout:B}=I;!g&&S.length>0&&(x(B),m(B),Z.panels.forEach(A=>{A.scheduleUpdate()}))}const N=Wt.addListener("interactionStateChange",()=>{Z.panels.forEach(g=>{g.scheduleUpdate()})}),U=Wt.addListener("mountedGroupsChange",g=>{const S=g.get($);if(S){const{defaultLayoutDeferred:B,derivedPanelConstraints:A,layout:_}=S;if(B||A.length===0)return;const{interactionState:K}=mt(),C=K.state!=="active";x(_),C&&m(_),Z.panels.forEach(w=>{w.scheduleUpdate()})}});return()=>{ee.current=null,re(),N(),U()}},[i,j,m,x,p,E,q]),u.useEffect(()=>{const V=ee.current;V&&(V.defaultLayout=n,V.disableCursor=!!r)}),s.jsx(Ir.Provider,{value:M,children:s.jsx("div",{...y,"aria-orientation":p,className:t,"data-group":!0,"data-testid":j,id:j,ref:k,style:{height:"100%",width:"100%",overflow:"hidden",...f,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}Rr.displayName="Group";function us(){const e=u.useContext(Ir);return $e(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Ai(e,t){const{id:n}=us(),r=u.useRef({collapse:Gn,expand:Gn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Gn});u.useImperativeHandle(t,()=>r.current,[]),Qt(()=>{Object.assign(r.current,jr({groupId:n,panelId:e}))})}function Ar({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:c="100%",minSize:l="0%",onResize:d,panelRef:p,style:f,...y}){const b=!!o,x=ls(o),m=u.useRef(null),j=cs(m,a),[,P]=Mr(),{getPanelStyles:E,id:D,registerPanel:L}=us(),k=d!==null,z=gn((q,ee,V)=>{d?.(q,o,V)});Qt(()=>{const q=m.current;if(q!==null)return L({element:q,id:x,idIsStable:b,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:k?z:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:c,minSize:l},scheduleUpdate:P})},[n,r,i,P,k,x,b,c,l,z,L]),Ai(x,p);const M=E(D,x);return s.jsx("div",{...y,"data-panel":!0,"data-testid":x,id:x,ref:j,style:{...Fi,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...M},children:s.jsx("div",{className:t,style:{flexGrow:1,...f},children:e})})}Ar.displayName="Panel";const Fi={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function Oi({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],c=t.find(l=>l.panelId===n);if(c){const l=c.maxSize,d=a=c.collapsible?c.collapsedSize:c.minSize,p=[r,r+1];a=Yt({layout:vn({delta:d-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=Yt({layout:vn({delta:l-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function Fr({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=ls(r),[c,l]=u.useState({}),[d,p]=u.useState("inactive"),f=u.useRef(null),y=cs(f,n),{id:b,orientation:x,registerSeparator:m}=us(),j=x==="horizontal"?"vertical":"horizontal";return Qt(()=>{const P=f.current;if(P!==null){const E={element:P,id:o},D=m(E),L=Wt.addListener("interactionStateChange",z=>{p(z.state!=="inactive"&&z.hitRegions.some(M=>M.separator===E)?z.state:"inactive")}),k=Wt.addListener("mountedGroupsChange",z=>{z.forEach(({derivedPanelConstraints:M,layout:q,separatorToPanels:ee},V)=>{if(V.id===b){const Z=ee.get(E);if(Z){const $=Z[0],re=V.panels.indexOf($);l(Oi({layout:q,panelConstraints:M,panelId:$.id,panelIndex:re}))}}})});return()=>{L(),k(),D()}}},[b,o,m]),s.jsx("div",{...a,"aria-controls":c.valueControls,"aria-orientation":j,"aria-valuemax":c.valueMax,"aria-valuemin":c.valueMin,"aria-valuenow":c.valueNow,children:e,className:t,"data-separator":d,"data-testid":o,id:o,ref:y,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}Fr.displayName="Separator";function ns({className:e,...t}){return s.jsx(Rr,{"data-slot":"resizable-panel-group",className:Xe("h-full w-full",e),...t})}function Ut({className:e,...t}){return s.jsx(Ar,{"data-slot":"resizable-panel",className:Xe("min-w-0 min-h-0",e),...t})}function $n({withHandle:e,className:t,...n}){return s.jsx(Fr,{"data-slot":"resizable-handle",className:Xe("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(Jr,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Di=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],$i=[10,15,20,25,30],Wn="__none__",zi=[{value:"auto",label:"Auto (Z->D)"},{value:"zerodha",label:"Zerodha"},{value:"dhan",label:"Dhan"}],_i=[{value:"kotak",label:"Kotak"},{value:"dhan",label:"Dhan"},{value:"zerodha",label:"Zerodha"}];function Bi(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function Vi(e){const t=e.trim();return t.length<=10?t:`${t.slice(0,4)}...${t.slice(-4)}`}function qi({liveOpenPnl:e,isLivePnl:t=!1,chartFocusMode:n=!1,onToggleChartFocusMode:r}){const i=Fe(N=>N.apiKey),a=Fe(N=>N.user?.broker),o=Kt(N=>N.unifiedMode),c=Kt(N=>N.dataFeed),l=Kt(N=>N.executionBroker),d=Kt(N=>N.setDataFeed),p=Kt(N=>N.setExecutionBroker),f=h(N=>N.underlying),y=h(N=>N.optionExchange),b=h(N=>N.expiryWeek),x=h(N=>N.expiry),m=h(N=>N.expiries),j=h(N=>N.chainStrikeCount),P=h(N=>N.paperMode),E=h(N=>N.sessionPnl),D=h(N=>N.tradeCount),L=h(N=>N.lastOrderAck),k=h(N=>N.setUnderlying),z=h(N=>N.setExpiryWeek),M=h(N=>N.setExpiry),q=h(N=>N.setExpiries),ee=h(N=>N.setChainStrikeCount),V=h(N=>N.setPaperMode),Z=P?E:e??E,$=x&&m.includes(x)?x:Wn,{data:re}=fr({queryKey:["scalping-expiries",f,y],queryFn:()=>mr.getExpiries(i,f,y),enabled:!!i,staleTime:300*1e3});u.useEffect(()=>{if(re?.status!=="success")return;const N=re.data??[];if(Bi(m,N)||q(N),N.length===0){x&&M("");return}if(!x||!N.includes(x)){const U=b==="next"?Math.min(1,N.length-1):0,g=N[U],S=U<=0?"current":"next";x!==g&&M(g),b!==S&&z(S)}},[re,b,m,x,q,M,z]);const I=N=>{if(N===Wn)return;x!==N&&M(N);const g=m.indexOf(N)<=0?"current":"next";b!==g&&z(g)};return s.jsxs("div",{className:"flex flex-wrap items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0 min-w-0 overflow-hidden",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(un,{value:f,onValueChange:N=>k(N),children:[s.jsx(dn,{className:"h-7 w-[104px] lg:w-[116px] xl:w-[128px] text-xs font-semibold",children:s.jsx(pn,{})}),s.jsx(fn,{children:Di.map(N=>s.jsx(en,{value:N,children:N},N))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(un,{value:$,onValueChange:I,disabled:m.length===0,children:[s.jsx(dn,{className:"h-7 w-[108px] lg:w-[114px] xl:w-[122px] text-xs font-mono",children:s.jsx(pn,{placeholder:"Select expiry"})}),s.jsxs(fn,{children:[s.jsx(en,{value:Wn,disabled:!0,children:"Select expiry"}),m.map(N=>s.jsx(en,{value:N,children:N},N))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(un,{value:String(j),onValueChange:N=>ee(Number(N)),children:[s.jsx(dn,{className:"h-7 w-[82px] lg:w-[88px] xl:w-[94px] text-xs",children:s.jsx(pn,{})}),s.jsx(fn,{children:$i.map(N=>s.jsx(en,{value:String(N),children:N},N))})]})]}),s.jsx("div",{className:"flex-1 min-w-[12px]"}),o&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Feed"}),s.jsxs(un,{value:c,onValueChange:N=>d(N),children:[s.jsx(dn,{className:"h-7 w-[98px] lg:w-[108px] xl:w-[118px] text-xs",children:s.jsx(pn,{})}),s.jsx(fn,{children:zi.map(N=>s.jsx(en,{value:N.value,children:N.label},N.value))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Exec"}),s.jsxs(un,{value:l,onValueChange:N=>p(N),children:[s.jsx(dn,{className:"h-7 w-[84px] lg:w-[90px] xl:w-[96px] text-xs",children:s.jsx(pn,{})}),s.jsx(fn,{children:_i.map(N=>s.jsx(en,{value:N.value,children:N.label},N.value))})]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsx("button",{type:"button",onClick:r,className:`h-7 px-2 rounded-md border text-xs transition-colors shrink-0 whitespace-nowrap ${n?"border-emerald-500/60 bg-emerald-500/15 text-emerald-400":"border-border/60 bg-muted/20 text-muted-foreground hover:text-foreground"}`,title:n?"Show side panels":"Hide side panels",children:n?"Panels":"Focus"}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>V(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${P?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>V(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),o?s.jsxs(qe,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:["EXEC: ",l.toUpperCase()]}):a&&s.jsx(qe,{variant:"outline",className:"text-xs h-6 shrink-0 whitespace-nowrap",children:a}),!P&&L&&s.jsxs(qe,{variant:"outline",className:"text-xs h-6 font-mono shrink-0 whitespace-nowrap",title:`${L.broker} ${L.action} ${L.symbol}`,children:["ACK: ",Vi(L.orderId)]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5 shrink-0 whitespace-nowrap",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${Z>0?"text-green-500":Z<0?"text-red-500":"text-foreground"}`,children:[Z>=0?"+":"",Z.toFixed(0)]}),!P&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),D>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",D,")"]})]})]})}function kn(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function Rs({value:e,prevRef:t,className:n,format:r="price"}){const i=u.useRef(null);u.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const c=e>t.current?"flash-green":"flash-red";o.classList.add(c);const l=setTimeout(()=>o.classList.remove(c),300);return t.current=e,()=>clearTimeout(l)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:Xe("tabular-nums transition-colors",n),children:a})}function Tn({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:Xe("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function Ki(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Ui=u.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:c,onSelectStrike:l,onSelectCE:d,onSelectPE:p}){const f=u.useRef(n?.ltp??0),y=u.useRef(r?.ltp??0),b=Math.min(((n?.oi??0)/o+(n?.volume??0)/c)/2*100,100),x=Math.min(((r?.oi??0)/o+(r?.volume??0)/c)/2*100,100);return s.jsxs("div",{className:Xe("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(Tn,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx(Tn,{value:n?.volume??0,max:c,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>d(t,n?.symbol??null),title:n?.symbol??"Select CE",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${b}%`}}),s.jsx(Rs,{value:n?.ltp,prevRef:f,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:Xe("text-center font-bold tabular-nums px-1 cursor-pointer",i&&"text-yellow-500"),onClick:()=>l(t,n?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${x}%`}}),s.jsx(Rs,{value:r?.ltp,prevRef:y,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(Tn,{value:r?.volume??0,max:c,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[s.jsx(Tn,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:kn(r?.oi)})]})]})},Ki);function As(e){return(e??"").replace(/-/g,"").toUpperCase()}function Gi(){const e=Fe(I=>I.apiKey),t=h(I=>I.underlying),n=h(I=>I.indexExchange),r=h(I=>I.optionExchange),i=h(I=>I.expiry),a=h(I=>I.selectedStrike),o=h(I=>I.selectedCESymbol),c=h(I=>I.selectedPESymbol),l=h(I=>I.chainStrikeCount),d=h(I=>I.setSelectedStrike),p=h(I=>I.setSelectedSymbols),f=h(I=>I.setActiveSide),y=h(I=>I.setLotSize),b=h(I=>I.setOptionChainSnapshot),x=u.useRef(null),m=u.useRef(null),j=u.useRef(!1),{data:P,isLoading:E,isStreaming:D,error:L,streamingSymbols:k,lastUpdate:z}=ei(e,t,n,r,i,l,{enabled:!!e&&!!i,oiRefreshInterval:15e3,wsMode:"Quote"});u.useEffect(()=>{P&&b(P,z?.getTime()??Date.now(),D)},[P,z,D,b]),u.useEffect(()=>{if(!P?.chain?.length||(P.underlying??"").toUpperCase()!==t.toUpperCase()||i&&As(P.expiry_date)!==As(i)||j.current)return;let I=null;for(const N of P.chain){const U=Number(N.ce?.lotsize);if(Number.isFinite(U)&&U>0){I=U;break}const g=Number(N.pe?.lotsize);if(Number.isFinite(g)&&g>0){I=g;break}}I!==null&&(y(I),j.current=!0)},[P,y]),u.useEffect(()=>{j.current=!1},[t,i]),u.useEffect(()=>{if(P?.chain&&m.current&&x.current){const I=x.current,N=m.current,U=I.getBoundingClientRect(),g=N.getBoundingClientRect(),S=g.top-U.top-U.height/2+g.height/2;I.scrollTop+=S}},[P?.atm_strike]);const M=u.useCallback((I,N,U)=>{d(I),p(N,U)},[d,p]),q=u.useCallback((I,N)=>{N&&(d(I),p(N,c),f("CE"))},[c,f,d,p]),ee=u.useCallback((I,N)=>{N&&(d(I),p(o,N),f("PE"))},[o,f,d,p]),{maxOI:V,maxVol:Z}=u.useMemo(()=>{if(!P?.chain?.length)return{maxOI:1,maxVol:1};let I=0,N=0;for(const U of P.chain)U.ce?.oi&&U.ce.oi>I&&(I=U.ce.oi),U.pe?.oi&&U.pe.oi>I&&(I=U.pe.oi),U.ce?.volume&&U.ce.volume>N&&(N=U.ce.volume),U.pe?.volume&&U.pe.volume>N&&(N=U.pe.volume);return{maxOI:I||1,maxVol:N||1}},[P?.chain]),$=P?.underlying_ltp,re=P?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(qe,{variant:"outline",className:"text-[10px] h-4 px-1",children:[l," strikes"]}),$!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:$.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[D&&s.jsxs(qe,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),k]}),E&&s.jsx(qe,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:x,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[L&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:L}),!L&&!E&&P?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),P?.chain?.map(I=>{const N=I.strike===re;return s.jsx("div",{ref:N?m:void 0,children:s.jsx(Ui,{strike:I.strike,ce:I.ce,pe:I.pe,isATM:N,isSelected:I.strike===a,maxOI:V,maxVol:Z,onSelectStrike:M,onSelectCE:q,onSelectPE:ee})},I.strike)})]})]})}function Wi({positions:e,totalPnl:t,isLivePnl:n}){const r=h(o=>o.activeSide),i=h(o=>o.hotkeysEnabled),a=h(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↑"}),s.jsx("span",{children:"CE Mkt Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↓"}),s.jsx("span",{children:"PE Mkt Buy"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const ln=300*60+1800,Fs=1440*60,hn=540*60+900,Os=900*60+1800;function zn(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function Or(e){const t=zn(e)+ln,n=Math.floor(t/Fs)*Fs,r=t-n,i=(n-ln)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function Hi(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),c=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(c))return null;const l=Date.UTC(n,r-1,i,a,o,c)-ln*1e3;return Math.floor(l/1e3)}function Yi(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-ln*1e3;return Math.floor(a/1e3)}function Tt(e){if(typeof e=="number")return zn(e);const t=Yi(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return zn(r);const i=Hi(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function ds(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=Or(e);if(r===0||r===6)return!1;const i=n>=hn,a=t.includeClose?n<=Os:n<Os;return i&&a}function Zi(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=Or(e),a=i<=hn?hn:hn+Math.floor((i-hn)/n)*n;return r+a-ln}function Dr(e){const t=(zn(e)+ln)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function Qi(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?Zi(i,n):Math.floor(i/n)*n,c=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:c},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+c},!1]}const Xi=4e3,Ji=3e3;function En(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.trim());return Number.isFinite(t)?t:null}return null}function $r({symbol:e,exchange:t,intervalSec:n=1,mode:r="LTP",enabled:i=!0,useIndiaMarketHours:a=!1,maxCandles:o=500,onCandleUpdate:c}){const l=u.useRef([]),d=u.useRef(null),p=u.useRef(null),f=u.useRef(0),y=u.useRef(!1),b=u.useRef(c);b.current=c;const[x,m]=u.useState(()=>Mt.getInstance().getState().isConnected),[j,P]=u.useState(()=>Mt.getInstance().getState().isFallbackMode),E=u.useCallback(async()=>{const M=Fe.getState().apiKey;if(M)return M;try{const ee=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(ee.status==="success"&&ee.api_key)return Fe.getState().setApiKey(ee.api_key),ee.api_key}catch{}return null},[]),D=u.useCallback(M=>{if(!i||!Number.isFinite(M.ltp)||M.ltp<=0||!Number.isFinite(M.timestamp)||M.timestamp<=0)return!1;const q=Math.floor(M.timestamp/1e3);if(a&&!ds(q))return!1;const ee=`${M.sourceKey}:${M.timestamp}:${M.ltp}:${M.volume??""}`;if(p.current===ee)return!1;p.current=ee;const V={price:M.ltp,volume:M.volume??void 0,timestamp:M.timestamp},[Z,$]=Qi(V,d.current,n,{alignToIndiaSession:a});return $&&d.current&&(l.current.push(d.current),l.current.length>o&&(l.current=l.current.slice(-o))),d.current=Z,f.current=Date.now(),b.current?.(Z,$),!0},[i,n,o,a]);u.useEffect(()=>{if(!i||!e)return;const M=Mt.getInstance(),q=e.trim().toUpperCase(),ee=t.trim().toUpperCase(),V=M.getState();m(V.isConnected),P(V.isFallbackMode);const Z=M.addStateListener(I=>{m(I.isConnected),P(I.isFallbackMode)}),$=M.subscribe(q,ee,r,I=>{const N=En(I.data?.ltp);N==null||N<=0||D({ltp:N,volume:En(I.data?.volume),timestamp:I.lastUpdate??Date.now(),sourceKey:`${I.exchange.toUpperCase()}:${I.symbol.toUpperCase()}:WS`})}),re=M.getState();return!re.isConnected&&!re.isPaused&&M.connect(),()=>{Z(),$()}},[i,e,t,r,D]),u.useEffect(()=>{if(!i||!e)return;let M=!1;const q=e.trim().toUpperCase(),ee=t.trim().toUpperCase(),V=async()=>{if(M||y.current)return;const $=f.current,re=$>0?Date.now()-$:Number.POSITIVE_INFINITY;if(!x||j||re>=Xi){y.current=!0;try{const N=await E();if(!N||M)return;const U=await Ee.getQuotes(N,q,ee);if(M||U.status!=="success"||!U.data)return;const g=En(U.data.ltp);if(g==null||g<=0)return;D({ltp:g,volume:En(U.data.volume),timestamp:Date.now(),sourceKey:`${ee}:${q}:REST`})}catch{}finally{y.current=!1}}};V();const Z=setInterval(()=>{V()},Ji);return()=>{M=!0,clearInterval(Z),y.current=!1}},[i,e,t,x,j,E,D]);const L=u.useCallback(()=>{const M=[...l.current];return d.current&&M.push(d.current),M},[]),k=u.useCallback(()=>{l.current=[],d.current=null,p.current=null,f.current=0},[]),z=u.useCallback(M=>{if(!M?.length){l.current=[],d.current=null;return}const q=M.slice(-o);if(q.length===1){l.current=[],d.current=q[0];return}l.current=q.slice(0,-1),d.current=q[q.length-1]},[o]);return{getCandles:L,reset:k,seed:z,isConnected:x,isFallbackMode:j}}function _n(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function zr(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=ea(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const c=e.length-r.length;let l=0,d=0,p=1;for(let f=0;f<r.length;f++){const y=e[c+f],b=(y.high+y.low)/2,x=r[f].value;let m=b+n*x,j=b-n*x;f>0&&(j>d||e[c+f-1].close<d||(j=d),m<l||e[c+f-1].close>l||(m=l));let P=p;f>0&&(p===1&&y.close<j?P=-1:p===-1&&y.close>m&&(P=1));const E=y.time;i.push({time:E,value:m}),a.push({time:E,value:j}),o.push({time:E,value:P===1?j:m}),l=m,d=j,p=P}return{upper:i,lower:a,trend:o}}function ea(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,c=e[a].low,l=e[a-1].close;r.push(Math.max(o-c,Math.abs(o-l),Math.abs(c-l)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function _r(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}function ta(e){return!Number.isFinite(e)||e<=0?1:e}function na(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const n=Math.ceil(e/t)*t;return Math.max(t*2,n)}function Br(e,t){const n=ta(e),r=na(t,n);return i=>{const a=i(),o=a?.priceRange;if(!a||!o)return a;const c=o.minValue,l=o.maxValue;if(!Number.isFinite(c)||!Number.isFinite(l))return a;const d=Math.min(c,l),p=Math.max(c,l),f=(d+p)/2;let y=p-d;(!Number.isFinite(y)||y<n)&&(y=n),y<r&&(y=r),y=Math.ceil(y/n)*n;const b=y/2,x=Math.floor((f-b)/n)*n;let m=Math.ceil((f+b)/n)*n;return m-x<y&&(m=x+y),{...a,priceRange:{minValue:x,maxValue:m}}}}const sa=120,cn=500,ra=1,ia=50,aa=200;function Cn(e){return e.map(t=>({time:t.time,value:t.value}))}function oa(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function la(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";case 86400:return"D";default:return"1m"}}function Ds(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function rt(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function ps(e){const t=Tt(e);return t??null}function ca(e){if(!e?.length)return[];const t=[];for(const a of e){const o=Tt(a.timestamp)??Tt(a.time)??Tt(a.datetime)??Tt(a.date),c=rt(a.open),l=rt(a.high),d=rt(a.low),p=rt(a.close),f=rt(a.volume)??0;o==null||c==null||l==null||d==null||p==null||t.push({time:o,open:c,high:l,low:d,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-cn),i=r.filter(a=>ds(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-cn)}function nn(e){return e.map(t=>({...t}))}function ua(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-cn)}function Hn(e){const t=[];for(const n of e){const r=ps(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function $s(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=ps(n.time),i=rt(n.open),a=rt(n.high),o=rt(n.low),c=rt(n.close),l=rt(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-cn)}function da({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=u.useRef(null),a=u.useRef(null),o=u.useRef(null),c=u.useRef(null),l=u.useRef(null),d=u.useRef(null),p=u.useRef(null),f=u.useRef([]),y=u.useRef(new Map),b=u.useRef(null),x=u.useRef(0),m=u.useRef(null),j=u.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),P=Fe(g=>g.apiKey),E=Fe(g=>g.setApiKey),D=ur(g=>g.mode==="dark"),L=h(g=>g.underlying),k=h(g=>g.indexExchange),z=h(g=>g.chartInterval),M=u.useCallback(()=>{const g=f.current,S=j.current,B=g.map(A=>({time:A.time,value:A.close}));c.current&&c.current.setData(S.showEma9?Cn(_n(B,9)):[]),l.current&&l.current.setData(S.showEma21?Cn(_n(B,21)):[]),d.current&&d.current.setData(S.showSupertrend?Cn(zr(g,10,3).trend):[]),p.current&&p.current.setData(S.showVwap?Cn(_r(g)):[])},[]),q=u.useCallback(()=>{m.current===null&&(m.current=setTimeout(()=>{m.current=null,M()},sa))},[M]),ee=u.useCallback(()=>{f.current=[],o.current?.setData([]),c.current?.setData([]),l.current?.setData([]),d.current?.setData([]),p.current?.setData([])},[]),V=u.useCallback(g=>{const S=$s(g);f.current=nn(S),o.current?.setData(Hn(S)),q()},[q]),Z=u.useCallback(async()=>{if(P)return P;try{const S=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(S.status==="success"&&S.api_key)return E(S.api_key),S.api_key}catch{}return null},[P,E]),$=u.useCallback((g,S)=>{if(!o.current)return;const B=ps(g.time),A=rt(g.open),_=rt(g.high),K=rt(g.low),C=rt(g.close),w=rt(g.volume)??0;if(B==null||A==null||_==null||K==null||C==null)return;const J={time:B,open:A,high:_,low:K,close:C,volume:w},W=Number(J.time),ae=f.current.length?Number(f.current[f.current.length-1].time):null;if(ae!=null&&Number.isFinite(ae)&&Number.isFinite(W)&&W<ae)return;try{o.current.update({time:J.time,open:J.open,high:J.high,low:J.low,close:J.close})}catch{const T=$s([...f.current,J]);f.current=T,o.current.setData(Hn(T)),q();return}S?(f.current.push(J),f.current.length>cn&&(f.current=f.current.slice(-cn))):f.current.length>0?f.current[f.current.length-1]=J:f.current.push(J);const ne=b.current;ne&&y.current.set(ne,nn(f.current)),q()},[q]),{isConnected:re,isFallbackMode:I,reset:N,seed:U}=$r({symbol:L,exchange:k,intervalSec:z,mode:"LTP",enabled:!!L,useIndiaMarketHours:!1,onCandleUpdate:$});return u.useEffect(()=>{const g=b.current;if(g&&f.current.length>0&&y.current.set(g,nn(f.current)),!L){b.current=null,N(),ee();return}const S=`${k}:${L}:${z}`;b.current=S;const B=y.current.get(S);if(B&&B.length>0){N(),U(B),V(B);return}N(),ee();const A=++x.current,_=la(z),K=new Date,C=new Date(K.getTime());C.setDate(C.getDate()-ra),(async()=>{const J=await Z();if(!J){A===x.current&&ee();return}try{const W=async()=>{try{const ge=await Ee.getQuotes(J,L,k);if(ge.status!=="success"||!ge.data)return null;const pe=rt(ge.data.ltp);if(pe==null||pe<=0)return null;const R=Math.floor(Date.now()/1e3);return{time:Math.floor(R/z)*z,open:pe,high:pe,low:pe,close:pe,volume:rt(ge.data.volume)??0}}catch{return null}},ae=async ge=>{try{const pe=await Ee.getHistory(J,L,k,_,Ds(C),Ds(K),ge);return pe.status==="success"?ca(pe.data):[]}catch{return[]}},ne=await ae("api"),T=ne.length>0?ne:await ae("db");if(A!==x.current)return;const H=b.current===S?nn(f.current):[],ie=ua(T,H);if(ie.length>0){y.current.set(S,nn(ie)),U(ie),V(ie);return}const ve=await W();if(ve&&A===x.current){const ge=[ve];y.current.set(S,nn(ge)),U(ge),V(ge);return}}catch{}A===x.current&&ee()})()},[L,k,z,Z,N,U,ee,V]),u.useEffect(()=>{j.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},c.current?.applyOptions({visible:e}),l.current?.applyOptions({visible:t}),d.current?.applyOptions({visible:n}),p.current?.applyOptions({visible:r}),q()},[e,t,n,r,q]),u.useEffect(()=>{const g=i.current;if(!g)return;const S=oa(D),B=Br(ia,aa),A=xr(g,{width:g.offsetWidth,height:g.offsetHeight,layout:{background:{type:gr.Solid,color:S.bg},textColor:S.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:S.grid},horzLines:{color:S.grid}},rightPriceScale:{borderColor:S.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:S.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:ae=>Dr(ae)},crosshair:{mode:hr.Normal,vertLine:{width:1,color:S.crosshair,style:2},horzLine:{width:1,color:S.crosshair,style:2}}}),_=A.addSeries(yr,{upColor:S.upColor,downColor:S.downColor,borderVisible:!1,wickUpColor:S.upColor,wickDownColor:S.downColor,autoscaleInfoProvider:B}),K=A.addSeries(Ft,{color:S.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma9,autoscaleInfoProvider:B}),C=A.addSeries(Ft,{color:S.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showEma21,autoscaleInfoProvider:B}),w=A.addSeries(Ft,{color:S.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showSupertrend,autoscaleInfoProvider:B}),J=A.addSeries(Ft,{color:S.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:j.current.showVwap,autoscaleInfoProvider:B});a.current=A,o.current=_,c.current=K,l.current=C,d.current=w,p.current=J,f.current.length>0&&(_.setData(Hn(f.current)),q());const W=new ResizeObserver(()=>{if(a.current&&g){const ae=g.offsetWidth,ne=g.offsetHeight;ae>0&&ne>0&&a.current.applyOptions({width:ae,height:ne})}});return W.observe(g),()=>{m.current!==null&&(clearTimeout(m.current),m.current=null),W.disconnect(),A.remove(),a.current=null,o.current=null,c.current=null,l.current=null,d.current=null,p.current=null}},[D,q]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:L}),!re&&!I&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."}),!re&&I&&s.jsx("span",{className:"text-[10px] text-blue-500",children:"REST fallback"})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const yn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},Vr=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"adaptive-scalper",name:"Adaptive Scalper",description:"Aggressive scalping profile with lighter entry gates and faster re-entry.",config:{entryMomentumCount:3,entryMomentumVelocity:2,entryMinScore:4,entryMaxSpread:6,volumeLookbackTicks:14,indexVolumeMinRatio:1,optionVolumeMinRatio:1,sideVolumeDominanceRatio:1,volumeScoreWeight:1.25,trailInitialSL:10,trailBreakevenTrigger:6,trailLockTrigger:12,trailLockAmount:6,trailStartTrigger:15,trailStepSize:3,trailTightTrigger:24,trailTightStep:2,maxTradesPerDay:40,maxTradesPerMinute:10,minGapMs:1500,cooldownAfterLossSec:15,coolingOffAfterLosses:5,indexBiasEnabled:!0,indexBiasWeight:.2,optionsContextEnabled:!0,pcrBullishThreshold:.5,pcrBearishThreshold:1.6,maxPainProximityFilter:10,gexWallFilterEnabled:!1,ivSpikeExitEnabled:!1,respectHotZones:!1,sensitivityMultiplier:1.25,noTradeZoneEnabled:!1,reEntryEnabled:!0,reEntryDelaySec:8,reEntryMaxPerSide:6}},{id:"india-index",name:"NIFTY / SENSEX",description:"Tuned for Indian index options. Wider PCR bands, lighter max-pain gate, GEX off, volume thresholds calibrated for NSE cumulative data.",config:{entryMomentumCount:4,entryMomentumVelocity:3,entryMinScore:7,entryMaxSpread:3,volumeInfluenceEnabled:!0,volumeLookbackTicks:15,indexVolumeMinRatio:.8,optionVolumeMinRatio:.85,sideVolumeDominanceRatio:.85,volumeScoreWeight:.9,trailInitialSL:10,trailBreakevenTrigger:7,trailLockTrigger:15,trailLockAmount:7,trailStartTrigger:18,trailStepSize:4,trailTightTrigger:30,trailTightStep:2,breakevenTriggerPts:8,breakevenBuffer:1,maxTradesPerDay:25,maxTradesPerMinute:6,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:3,optionsContextEnabled:!0,pcrBullishThreshold:.5,pcrBearishThreshold:1.8,maxPainProximityFilter:20,gexWallFilterEnabled:!1,ivSpikeExitEnabled:!0,ivSpikeThreshold:8,indexBiasEnabled:!0,indexBiasWeight:.35,regimeDetectionPeriod:40,rangingThresholdPts:25,respectHotZones:!0,sensitivityMultiplier:1.1,noTradeZoneEnabled:!0,noTradeZoneRangePts:10,noTradeZonePeriod:15,reEntryEnabled:!0,reEntryDelaySec:20,reEntryMaxPerSide:3}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],pa=["CE","PE"];function sn(e=0){return pa.reduce((t,n)=>(t[n]=e,t),{})}const fa=new Set(["1","true","yes","on","enabled"]),ma=new Set(["0","false","no","off","disabled"]);function xa(e){if(typeof e=="boolean")return e;if(typeof e=="number")return Number.isFinite(e)?e!==0:null;if(typeof e=="string"){const t=e.trim().toLowerCase();if(fa.has(t))return!0;if(ma.has(t))return!1}return null}function Yn(e){if(!e||typeof e!="object")return{};const t=e,n={};for(const r of Object.keys(yn)){if(!(r in t))continue;const i=yn[r],a=t[r];if(typeof i=="boolean"){const o=xa(a);o!=null&&(n[r]=o);continue}if(typeof i=="number"){const o=typeof a=="number"?a:typeof a=="string"?Number(a):Number.NaN;Number.isFinite(o)&&(n[r]=o)}}return n}const X=dr()(pr(e=>({config:{...yn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:sn(),sideLastExitAt:sn(),sideLossPnl:sn(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,winsCount:0,lossesCount:0,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...Yn(t)}})),applyPreset:t=>{const n=Vr.find(r=>r.id===t);n&&e({config:{...yn,...Yn(n.config)},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.accountPeakPnl,t),i=Math.max(0,r-t),a=Math.max(n.dailyPeakPnl,t),o=Math.max(0,a-t),c=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered,l=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:a,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:i,lockProfitTriggered:c,killSwitch:n.killSwitch||l}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,c=Math.max(n.dailyPeakPnl,o),l=Math.max(0,c-o),d=Math.max(n.autoPeakPnl,o),p=Math.max(0,d-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:c,dailyDrawdown:l,autoPeakPnl:d,autoDrawdown:p}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),c=Math.max(n.autoPeakPnl,i),l=Math.max(0,c-i),d=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,autoPeakPnl:c,autoDrawdown:l,lockProfitTriggered:d,killSwitch:n.killSwitch,winsCount:t>=0?n.winsCount+1:n.winsCount,lossesCount:t<0?n.lossesCount+1:n.lossesCount}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:sn(),sideLastExitAt:sn(),sideLossPnl:sn(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,winsCount:0,lossesCount:0,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const n=e??{};return{...t,...n,config:{...yn,...Yn(n.config??{})},activePresetId:n.activePresetId??t.activePresetId}}})),xe=dr()(pr((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).filter(i=>i.symbol===n).sort((i,a)=>a.createdAt-i.createdAt)[0],addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),zs=.05,ha=2;function Dn(e){return Math.round(e/zs)*zs}function Gt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:Dn(e)}async function $t({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=Gt(n);if(a!=null)return a;const o=Mt.getInstance(),c=Gt(o.getCachedData(e,t)?.data?.ltp);if(c!=null)return c;const l=Gt(r);if(l!=null)return l;if(i)try{const d=await Ee.getQuotes(i,e,t),p=Gt(d.data?.ltp);if(p!=null)return p}catch{}return 0}function ga({symbol:e,exchange:t,preferredPrice:n,fallbackPrice:r}){const i=Gt(n);if(i!=null)return i;const a=Mt.getInstance(),o=Gt(a.getCachedData(e,t)?.data?.ltp);if(o!=null)return o;const c=Gt(r);return c??0}async function Xt({symbol:e,exchange:t,orderId:n=null,preferredPrice:r=null,fallbackPrice:i=null,apiKey:a=null,maxAttempts:o=5,retryDelayMs:c=250}){return ga({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:i})}function Nt({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:c,slPoints:l,trailDistancePoints:d,createdAt:p=Date.now(),managedBy:f="manual",autoEntryScore:y,autoEntryReason:b}){const x=Dn(a),m=Number(Math.max(0,c||0).toFixed(2)),j=Number(Math.max(0,l||0).toFixed(2)),P=Number(Math.max(0,d??ha).toFixed(2)),E=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:x,quantity:o,tpPrice:m>0?Dn(x+(E?m:-m)):null,slPrice:j>0?Dn(x+(E?-j:j)):null,tpPoints:m,slPoints:j,trailDistancePoints:P,trailStage:f==="auto"?"INITIAL":void 0,createdAt:p,managedBy:f,autoEntryScore:y,autoEntryReason:b}}function qr(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function Kr(e){if(typeof e=="number")return Number.isFinite(e)&&e>0?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)&&t>0?t:null}return null}function Ur(e){if(!e||typeof e!="object")return null;const t=e;return qr(t.orderid??t.order_id??t.orderId)}function Bn(e){if(!Array.isArray(e))return[];const t=[];for(const n of e){if(!n||typeof n!="object")continue;const r=n,i=String(r.status??"").trim().toUpperCase();if(i&&i!=="SUCCESS")continue;const a=Ur(r);if(!a)continue;const o=Kr(r.quantity)??0;t.push({orderId:a,quantity:o})}return t}function Sn(e){if(!e||typeof e!="object")return[];const t=e,n=[],r=new Set,i=d=>{const p=qr(d);!p||r.has(p)||(r.add(p),n.push(p))};i(t.orderid??t.order_id??t.orderId),i(t.data?.orderid);const a=t.orderids;if(Array.isArray(a))for(const d of a)i(d);const o=t.data?.orderids;if(Array.isArray(o))for(const d of o)i(d);const c=Bn(t.split_legs);for(const d of c)i(d.orderId);const l=Bn(t.results);for(const d of l)i(d.orderId);return n}function qn(e){if(!e||typeof e!="object")return[];const t=e,n=Bn(t.split_legs);if(n.length>0)return n;const r=Bn(t.results);if(r.length>0)return r;const i=Ur(t),a=Kr(t.quantity);return i&&a!=null?[{orderId:i,quantity:a}]:[]}function Zt(e){const t=Sn(e);return t.length>0?t[0]:null}const _s=.05,ya=150;function et(e){return Math.round(e/_s)*_s}function Rt(e){return Number(Math.max(0,e).toFixed(2))}function Bs(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?et(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?et(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function ba({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=Fe(v=>v.apiKey),a=Fe(v=>v.setApiKey),o=h(v=>v.activeSide),c=h(v=>v.orderType),l=h(v=>v.tpPoints),d=h(v=>v.slPoints),p=h(v=>v.trailDistancePoints),f=h(v=>v.limitPrice),y=h(v=>v.pendingEntryAction),b=h(v=>v.pendingLimitPlacement),x=h(v=>v.quantity),m=h(v=>v.lotSize),j=h(v=>v.optionExchange),P=h(v=>v.product),E=h(v=>v.paperMode),D=h(v=>v.incrementTradeCount),L=h(v=>v.setLimitPrice),k=h(v=>v.setTpPoints),z=h(v=>v.setSlPoints),M=h(v=>v.setPendingEntryAction),q=h(v=>v.setPendingLimitPlacement),ee=h(v=>v.clearPendingLimitPlacement),V=h(v=>n==="CE"?v.selectedCESymbol:v.selectedPESymbol),Z=xe(v=>v.virtualTPSL),$=xe(v=>v.triggerOrders),re=xe(v=>v.addTriggerOrder),I=xe(v=>v.updateTriggerOrder),N=xe(v=>v.removeTriggerOrder),U=xe(v=>v.setVirtualTPSL),g=xe(v=>v.clearForSymbol),S=xe(v=>v.updateVirtualTPSL),B=u.useRef(null),A=u.useRef(null),_=u.useRef(null),K=u.useRef(null),C=u.useRef(null),w=u.useRef(null),J=u.useRef(null),W=u.useRef(null),[ae,ne]=u.useState(null),[T,H]=u.useState(null),[ie,ve]=u.useState(null),[ge,pe]=u.useState(null),[R,we]=u.useState(!1),ke=u.useRef(!1),ue=u.useRef(!1),F=u.useRef(0),be=u.useRef(null),Re=u.useRef(null),Ge=u.useRef(null),De=o===n,Ue=c==="LIMIT"||c==="TRIGGER",Y=u.useMemo(()=>V?Object.values(Z).filter(v=>v.symbol===V).sort((v,G)=>G.createdAt-v.createdAt):[],[V,Z]),O=Y[0],Q=u.useMemo(()=>V?Object.values($).find(v=>v.symbol===V):void 0,[V,$]),fe=!!b&&b.symbol===V&&b.side===n,tt=fe||f!=null,ze=O?"position":Q?"trigger":De&&Ue&&tt?"pending":null,Ae=y??b?.action??"BUY";u.useEffect(()=>{if(!O){pe(null);return}const v=Mt.getInstance(),G=v.getCachedData(O.symbol,O.exchange)?.data?.ltp;G&&G>0&&pe(G);const te=v.subscribe(O.symbol,O.exchange,"LTP",ce=>{const Pe=ce.data.ltp;Pe&&Pe>0&&pe(Pe)});return()=>te()},[O]);const _e=u.useMemo(()=>{if(!O||!ge||ge<=0)return null;const v=O.action==="BUY"?ge-O.entryPrice:O.entryPrice-ge,G=v*O.quantity;return{ltp:ge,points:v,pnl:G}},[O,ge]),Se=u.useMemo(()=>{if(Y.length===0)return null;const v=Y.reduce((te,ce)=>te+Math.max(ce.quantity,0),0);if(v<=0)return null;const G=Y.reduce((te,ce)=>te+ce.entryPrice*Math.max(ce.quantity,0),0)/v;return et(G)},[Y]),Be=u.useMemo(()=>{if(!O)return"";const v=`${O.action} Fill @ ${O.entryPrice.toFixed(2)}`,G=Se!=null?` | Avg ${Se.toFixed(2)}`:"";if(!_e)return v;const te=_e.pnl>=0?"+":"";return`${v}${G} | PnL ${te}${_e.pnl.toFixed(2)}`},[O,_e,Se]),le=u.useCallback((v,G)=>{if(v.current){const te=G.current??t.current;try{te?.removePriceLine(v.current)}catch{}v.current=null,G.current=null}},[t]),se=u.useCallback((v,G,te,ce,Pe,he,Me)=>{const me=t.current;if(!me)return;const de="";if(v.current&&G.current&&G.current!==me){try{G.current.removePriceLine(v.current)}catch{}v.current=null,G.current=null}v.current?v.current.applyOptions({price:te,color:ce,lineStyle:Pe,lineWidth:he,title:de,axisLabelVisible:!0}):(v.current=me.createPriceLine({price:te,color:ce,lineStyle:Pe,lineWidth:he,title:de,axisLabelVisible:!0}),G.current=me)},[t]),je=u.useCallback(v=>{if(!t.current)return null;const G=t.current.priceToCoordinate(v);return G??null},[t]),Te=u.useCallback(()=>{const v=(G,te)=>{if(!G.current){te(null);return}const ce=G.current.options().price,Pe=je(ce);if(Pe==null){te(null);return}te({y:Pe,price:ce})};v(A,ne),v(_,H),v(K,ve)},[je]),Ke=u.useCallback(()=>{if(!V)return null;const G=Mt.getInstance().getCachedData(V,j)?.data?.ltp;return!G||G<=0?null:G},[V,j]),nt=u.useCallback(v=>v==="BUY"?"above":"below",[]),We=u.useCallback((v,G)=>{const te=Ke();return te?v==="BUY"&&G<=te?{ok:!1,message:`BUY trigger must be above current price (${te.toFixed(2)})`}:v==="SELL"&&G>=te?{ok:!1,message:`SELL trigger must be below current price (${te.toFixed(2)})`}:{ok:!0}:{ok:!0}},[Ke]),Ve=u.useCallback(async()=>{if(i)return i;try{const G=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(G.status==="success"&&G.api_key)return a(G.api_key),G.api_key}catch(v){console.error("[Scalping] Failed to fetch API key:",v)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[i,a]),it=u.useCallback(v=>{if(Array.isArray(v.splitLegs)&&v.splitLegs.length>0)return v.splitLegs.map(te=>({orderId:String(te.orderId??"").trim(),quantity:Math.max(0,Number(te.quantity)||0)})).filter(te=>te.orderId.length>0&&te.quantity>0);if(Array.isArray(v.orderIds)&&v.orderIds.length>0){const te=Array.from(new Set(v.orderIds.map(ce=>String(ce??"").trim()).filter(ce=>ce.length>0)));if(te.length>0){const ce=Math.max(1,Math.floor(Math.max(1,v.quantity)/te.length));return te.map(Pe=>({orderId:Pe,quantity:ce}))}}const G=String(v.orderId??"").trim();return G?[{orderId:G,quantity:Math.max(1,v.quantity)}]:[]},[]),bt=u.useCallback(async()=>{if(ue.current)return;const v=Re.current;if(!v)return;const G=Date.now()-F.current,te=v.force?0:Math.max(0,ya-G);if(te>0){if(be.current!=null)return;be.current=window.setTimeout(()=>{be.current=null,bt()},te);return}Re.current=null,ue.current=!0,F.current=Date.now();try{if(!await Ve())return;for(const Pe of v.legs)await Ee.modifyOrder(Pe.orderId,{symbol:v.symbol,exchange:j,action:v.action,product:P,pricetype:"LIMIT",price:v.price,quantity:Pe.quantity,trigger_price:0,disclosed_quantity:0})}catch(ce){console.error("[Scalping] Failed to modify pending LIMIT order:",ce)}finally{ue.current=!1,Re.current&&bt()}},[Ve,j,P]),Et=u.useCallback((v,G,te=!1)=>{if(E)return;const ce=it(v);if(ce.length===0)return;const Pe=et(G),he=Re.current;Re.current={legs:ce,symbol:v.symbol,action:v.action,price:Pe,force:te||!!he?.force},te&&be.current!=null&&(window.clearTimeout(be.current),be.current=null),bt()},[E,bt,it]);u.useEffect(()=>()=>{be.current!=null&&(window.clearTimeout(be.current),be.current=null)},[]);const vt=u.useCallback(async(v,G)=>{if(!V||ke.current)return!1;ke.current=!0;try{if(E){const de=await $t({symbol:V,exchange:j,preferredPrice:v});return de<=0?!1:(U(Nt({symbol:V,exchange:j,side:n,action:G,entryPrice:de,quantity:x*m,tpPoints:l,slPoints:d,trailDistancePoints:p,managedBy:"manual"})),D(),ee(),M(null),L(null),!0)}const te=await Ve();if(!te)return!1;const ce={apikey:te,strategy:"Scalping",exchange:j,symbol:V,action:G,quantity:x*m,pricetype:"LIMIT",product:P,price:v,trigger_price:0,disclosed_quantity:0},Pe=await Ee.placeOrder(ce);if(Pe.status!=="success")return console.error("[Scalping] LIMIT order rejected:",Pe),!1;const he=Zt(Pe),Me=Sn(Pe),me=qn(Pe);return q({symbol:V,side:n,action:G,orderId:he,orderIds:Me.length>0?Me:void 0,splitLegs:me.length>0?me:void 0,quantity:x*m,entryPrice:v,tpPoints:l,slPoints:d,trailDistancePoints:p}),M(null),L(v),!0}catch(te){return console.error("[Scalping] LIMIT order failed:",te),!1}finally{ke.current=!1}},[V,E,j,n,x,m,l,d,p,P,Ve,U,D,ee,M,L,q]);u.useEffect(()=>{const v=e.current,G=t.current;if(!v||!G)return;if(!(De&&Ue&&!O&&!Q&&!fe&&f==null)){le(B,C);return}const ce=Pe=>{if(!Pe.point){le(B,C);return}const he=G.coordinateToPrice(Pe.point.y);if(he==null){le(B,C);return}const Me=et(he);se(B,C,Me,"#a1a1aa",kt.Dashed,1,Me.toFixed(2))};return v.subscribeCrosshairMove(ce),()=>{v.unsubscribeCrosshairMove(ce),le(B,C)}},[e,t,De,Ue,O,Q,fe,f,le,se]),u.useEffect(()=>{const v=e.current,G=t.current;if(!v||!G||!V||!De||!Ue)return;const te=ce=>{if(!ce.point)return;const Pe=G.coordinateToPrice(ce.point.y);if(Pe==null)return;const he=et(Pe);if(c==="TRIGGER"){const Me=y??Q?.action;if(!Me){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const me=We(Me,he);if(!me.ok){console.warn(`[Scalping] ${me.message}`);return}const de=nt(Me);Q?I(Q.id,{triggerPrice:he,action:Me,direction:de,quantity:x*m,tpPoints:l,slPoints:d}):re({id:`trigger-${Date.now()}`,symbol:V,exchange:j,side:n,action:Me,triggerPrice:he,direction:de,quantity:x*m,tpPoints:l,slPoints:d,trailDistancePoints:p,createdAt:Date.now()}),L(he),M(null)}else{if(fe){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!y){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(O)return;L(he),vt(he,y)}le(B,C),Te()};return v.subscribeClick(te),()=>{v.unsubscribeClick(te)}},[e,t,V,De,Ue,c,y,O,Q,fe,x,m,l,d,p,j,n,re,I,L,M,nt,We,vt,le,Te]),u.useEffect(()=>{if(!t.current)return;const v=()=>{le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null)};if(O){const G=O.action==="BUY"?"#00ff88":"#ff4560";se(A,w,et(O.entryPrice),G,kt.Dotted,2,`${O.action} @ ${O.entryPrice.toFixed(2)}`),O.tpPrice!=null?se(_,J,et(O.tpPrice),"#00ff88",kt.Dashed,1,`TP @ ${O.tpPrice.toFixed(2)}`):le(_,J),O.slPrice!=null?se(K,W,et(O.slPrice),"#ff4560",kt.Dashed,1,`SL @ ${O.slPrice.toFixed(2)}`):le(K,W),Te();return}if(Q){const{tpPrice:G,slPrice:te}=Bs(Q),ce=et(Q.triggerPrice);se(A,w,ce,"#ffa500",kt.Dashed,2,`TRIGGER ${Q.action} @ ${ce.toFixed(2)}`),G!=null?se(_,J,G,"#00ff88",kt.Dashed,1,`TP @ ${G.toFixed(2)}`):le(_,J),te!=null?se(K,W,te,"#ff4560",kt.Dashed,1,`SL @ ${te.toFixed(2)}`):le(K,W),Te();return}if(De&&Ue&&tt){const G=Ae,te=fe?b?.tpPoints??l:l,ce=fe?b?.slPoints??d:d,Pe=fe?b?.entryPrice??f:f;if(Pe==null){v();return}const he=et(Pe);if(se(A,w,he,c==="LIMIT"?"#06b6d4":"#ffa500",kt.Dashed,2,`${c} ${G} @ ${he.toFixed(2)}`),te>0){const me=et(he+(G==="BUY"?te:-te));se(_,J,me,"#00ff88",kt.Dashed,1,`TP @ ${me.toFixed(2)}`)}else le(_,J);if(ce>0){const me=et(he+(G==="BUY"?-ce:ce));se(K,W,me,"#ff4560",kt.Dashed,1,`SL @ ${me.toFixed(2)}`)}else le(K,W);Te();return}v()},[t,O,Q,De,Ue,tt,f,Ae,b,fe,c,l,d,le,se,Te]),u.useEffect(()=>{},[O,Be]),u.useEffect(()=>{const v=e.current;if(!v)return;const G=()=>Te();v.subscribeCrosshairMove(G);const te=v.timeScale();return te.subscribeVisibleLogicalRangeChange(G),()=>{v.unsubscribeCrosshairMove(G),te.unsubscribeVisibleLogicalRangeChange(G)}},[e,Te]),u.useEffect(()=>{const v=r.current;if(!v)return;const G=()=>{!A.current&&!_.current&&!K.current||Te()},te=window.setInterval(G,100);return v.addEventListener("wheel",G,{passive:!0}),v.addEventListener("mousemove",G),window.addEventListener("resize",G),()=>{window.clearInterval(te),v.removeEventListener("wheel",G),v.removeEventListener("mousemove",G),window.removeEventListener("resize",G)}},[r,Te]),u.useEffect(()=>{O||Q||fe||y==null&&(f==null&&!A.current&&!_.current&&!K.current||(le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null),L(null)))},[O,Q,fe,y,f,le,L]),u.useEffect(()=>()=>{le(B,C),le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null)},[V,le]),u.useEffect(()=>{c==="MARKET"&&(O||Q||(le(B,C),le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null),L(null),M(null),ee()))},[c,O,Q,le,L,M,ee]);const St=u.useCallback((v,G)=>{if(G.preventDefault(),G.stopPropagation(),!ze||!(v==="entry"?A:v==="tp"?_:K).current)return;Ge.current={type:v,source:ze};const ce=he=>{const Me=Ge.current,me=t.current,de=r.current;if(!Me||!me||!de)return;const Ie=de.getBoundingClientRect(),ye=he.clientY-Ie.top,Ct=me.coordinateToPrice(ye);if(Ct==null)return;const dt=et(Ct),It=Me.type==="entry"?A:Me.type==="tp"?_:K;if(It.current){if(Me.type==="entry"?Me.source==="trigger"?`${Q?.action??"BUY"}${dt.toFixed(2)}`:Me.source==="pending"?`${c}${Ae}${dt.toFixed(2)}`:Me.source==="position"?`${O?.action??Ae}${dt.toFixed(2)}`:It.current.options().title??dt.toFixed(2):Me.type==="tp"?`${dt.toFixed(2)}`:`${dt.toFixed(2)}`,It.current.applyOptions({price:dt,title:""}),Me.type==="entry"){const xt=Me.source==="trigger"?Q?.action??Ae:Me.source==="position"?O?.action??Ae:Ae,Le=Me.source==="trigger"?Q?.tpPoints??0:Me.source==="position"?O?.tpPoints??0:l,Qe=Me.source==="trigger"?Q?.slPoints??0:Me.source==="position"?O?.slPoints??0:d;if(Le>0&&_.current){const Ye=et(dt+(xt==="BUY"?Le:-Le));_.current.applyOptions({price:Ye,title:""})}if(Qe>0&&K.current){const Ye=et(dt+(xt==="BUY"?-Qe:Qe));K.current.applyOptions({price:Ye,title:""})}}Te()}},Pe=()=>{const he=Ge.current;if(!he)return;const me=(he.type==="entry"?A:he.type==="tp"?_:K).current?.options().price;if(me!=null){if(he.source==="position"&&O){const de=he.type==="entry"?{entryPrice:me,tpPrice:O.tpPrice!=null?et(O.tpPrice+(me-O.entryPrice)):null,slPrice:O.slPrice!=null?et(O.slPrice+(me-O.entryPrice)):null}:he.type==="tp"?{tpPrice:me,tpPoints:Rt(Math.abs(me-O.entryPrice))}:he.type==="sl"?{slPrice:me,slPoints:Rt(Math.abs(O.entryPrice-me))}:null;de&&S(O.id,de)}if(he.source==="trigger"&&Q){if(he.type==="entry"){const de=We(Q.action,me);if(de.ok)I(Q.id,{triggerPrice:me,direction:nt(Q.action)}),L(me);else{console.warn(`[Scalping] ${de.message}`);const Ie=et(Q.triggerPrice);A.current?.applyOptions({price:Ie,title:""});const{tpPrice:ye,slPrice:Ct}=Bs(Q);_.current&&ye!=null&&_.current.applyOptions({price:ye,title:""}),K.current&&Ct!=null&&K.current.applyOptions({price:Ct,title:""}),L(Ie)}}he.type==="tp"&&I(Q.id,{tpPoints:Rt(Math.abs(me-Q.triggerPrice))}),he.type==="sl"&&I(Q.id,{slPoints:Rt(Math.abs(Q.triggerPrice-me))})}if(he.source==="pending"){const de=A.current?.options().price??f??me;if(fe&&b){const Ie={...b};he.type==="entry"&&(Ie.entryPrice=me,L(me),Et({orderId:Ie.orderId,orderIds:Ie.orderIds,splitLegs:Ie.splitLegs,symbol:Ie.symbol,action:Ie.action,quantity:Ie.quantity},me,!0)),he.type==="tp"&&(Ie.tpPoints=Rt(Math.abs(me-de))),he.type==="sl"&&(Ie.slPoints=Rt(Math.abs(de-me))),q(Ie)}else he.type==="entry"&&L(me),he.type==="tp"&&k(Rt(Math.abs(me-de))),he.type==="sl"&&z(Rt(Math.abs(de-me)))}}Te(),Ge.current=null,document.removeEventListener("mousemove",ce),document.removeEventListener("mouseup",Pe)};document.addEventListener("mousemove",ce),document.addEventListener("mouseup",Pe)},[ze,t,r,O,Q,Ae,c,f,fe,b,l,d,Et,S,I,nt,We,Te,q,L,k,z]),Je=u.useCallback(async()=>{if(fe&&b&&!E)try{const v=it(b);if(v.length>0){const te=(await Promise.allSettled(v.map(ce=>Ee.cancelOrder(ce.orderId)))).find(ce=>ce.status!=="fulfilled"||ce.value.status!=="success");if(te){console.error("[Scalping] Failed to cancel one or more LIMIT slice orders:",te);return}}}catch(v){console.error("[Scalping] Failed to cancel LIMIT order:",v);return}le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null),O&&g(O.symbol),Q&&N(Q.id),fe&&(b?it(b):[]).length===0&&!E&&console.warn("[Scalping] Pending LIMIT has no broker order ids; cleared local lines only."),ee(),L(null),M(null)},[O,Q,fe,b,E,it,le,g,N,ee,L,M]),Ze=u.useCallback(v=>{if(le(v==="tp"?_:K,v==="tp"?J:W),v==="tp"?H(null):ve(null),O){S(O.id,v==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(Q){I(Q.id,v==="tp"?{tpPoints:0}:{slPoints:0});return}v==="tp"?k(0):z(0)},[O,Q,le,k,z,S,I]),st=u.useCallback(async()=>{if(!(!O||R)){we(!0);try{if(E)console.log(`[Paper] Close ${O.action} ${O.symbol}`);else{const v=await Ee.closePosition(O.symbol,O.exchange,P);if(v.status!=="success"){console.error("[Scalping] Close position rejected:",v);return}}g(O.symbol),le(A,w),le(_,J),le(K,W),ne(null),H(null),ve(null)}catch(v){console.error("[Scalping] Close position failed:",v)}finally{we(!1)}}},[O,R,E,P,g,le]);if(!r.current)return null;const He=!!O,wt=He?O.action==="BUY"?"green":"red":c==="LIMIT"?"cyan":"orange",zt=He?`${O.action} @ ${ae?.price.toFixed(2)??"--"}`:Q?`TRIGGER ${Q.action} @ ${ae?.price.toFixed(2)??"--"}`:`${c} ${Ae} @ ${ae?.price.toFixed(2)??"--"}`,at={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[wt],Jt={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[wt],_t=ze!==null;return s.jsxs(s.Fragment,{children:[ae&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ae.y},children:[s.jsx("div",{className:Xe("absolute left-0 right-0 top-0 h-px -translate-y-1/2",Jt)}),s.jsx("div",{className:Xe("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",_t?"cursor-ns-resize":"cursor-default"),onMouseDown:_t?v=>St("entry",v):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:Xe("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",at),children:zt}),He&&_e&&s.jsxs("span",{className:Xe("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",_e.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",_e.ltp.toFixed(2)," | PnL ",_e.pnl>=0?"+":"",_e.pnl.toFixed(2)]}),He&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:v=>{v.stopPropagation(),st()},disabled:R,title:"Close position at market",children:R?"...":"Close"}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:v=>{v.stopPropagation(),Je()},title:He?"Remove virtual position tracking":"Cancel pending order",children:"×"})]})]}),T&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:T.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>St("tp",v)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",T.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),Ze("tp")},title:"Remove TP line",children:"×"})]})]}),ie&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ie.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>St("sl",v)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",ie.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),Ze("sl")},title:"Remove SL line",children:"×"})]})]})]})}const va=120,Sa=1,Pa=10,ja=40,Na=3e4,wa=120,ka=5e3,Ta=12e3;function Ln(e){return e.map(t=>({time:t.time,value:t.value}))}function Ea(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Ca(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";case 86400:return"D";default:return"1m"}}function Vs(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function oe(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Mn(e){if(!Number.isFinite(e))return"0";const t=Math.abs(e);return t>=1e6?`${(e/1e6).toFixed(2)}M`:t>=1e3?`${(e/1e3).toFixed(1)}K`:t>=100?e.toFixed(0):t>=10?e.toFixed(1):t>0?e.toFixed(2):"0"}const qs={buyFlow:0,sellFlow:0,delta:0,cumulativeDelta:0,dominance:"BAL",depthImbalancePct:null,spread:null,flowSource:"EST",lastUpdate:0};function La(e){return oe(e.ltp)??oe(e.last_price)??oe(e.lp)??oe(e.price)??oe(e.close)}function Ma(e){return oe(e.volume)??oe(e.total_volume)??oe(e.v)??oe(e.ttq)}function Ia(e){return oe(e.bid_price)??oe(e.bid)??oe(e.bp)??oe(e.best_bid_price)??oe(e.bp1)}function Ra(e){return oe(e.ask_price)??oe(e.ask)??oe(e.sp)??oe(e.best_ask_price)??oe(e.sp1)}function Aa(e){return oe(e.bid_size)??oe(e.bid_qty)??oe(e.total_buy_quantity)??oe(e.total_buy_qty)??oe(e.totalbuyqty)??oe(e.buy_quantity)??oe(e.tbq)??oe(e.bq1)}function Fa(e){return oe(e.ask_size)??oe(e.ask_qty)??oe(e.total_sell_quantity)??oe(e.total_sell_qty)??oe(e.totalsellqty)??oe(e.sell_quantity)??oe(e.tsq)??oe(e.sq1)}function Ks(e){if(!e||typeof e!="object")return 0;const t=e,n=oe(t.price)??oe(t.px);return n!=null&&n>0?n:0}function In(e){if(!e||typeof e!="object")return 0;const t=e,n=oe(t.quantity)??oe(t.qty)??oe(t.size)??oe(t.volume);return n!=null&&n>0?n:0}function Oa(e,t){const n=Math.max(0,t.buyFlow+t.sellFlow);if(n<=0)return{action:"HOLD",label:"HOLD FOR NOW"};const r=Math.abs(t.delta)/Math.max(1,n),i=t.delta===0?!1:Math.sign(t.delta)===Math.sign(t.cumulativeDelta)&&Math.abs(t.cumulativeDelta)>=Math.abs(t.delta)*.35,a=t.flowSource==="VOL"?1e3:250,o=t.flowSource==="VOL"?.12:.22;if(!i||n<a||r<o)return{action:"HOLD",label:"HOLD FOR NOW"};const c=t.delta>0&&t.cumulativeDelta>0,l=t.delta<0&&t.cumulativeDelta<0;return c?e==="CE"?{action:"BUY_CE",label:"BUY CE NOW"}:{action:"BUY_PE",label:"BUY PE NOW"}:l?e==="CE"?{action:"BUY_PE",label:"BUY PE NOW"}:{action:"BUY_CE",label:"BUY CE NOW"}:{action:"HOLD",label:"HOLD FOR NOW"}}function fs(e){const t=Tt(e);return t??null}function Da(e){if(!e?.length)return[];const t=[];for(const a of e){const o=Tt(a.timestamp)??Tt(a.time)??Tt(a.datetime)??Tt(a.date),c=oe(a.open),l=oe(a.high),d=oe(a.low),p=oe(a.close),f=oe(a.volume)??0;o==null||c==null||l==null||d==null||p==null||t.push({time:o,open:c,high:l,low:d,close:p,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>ds(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function rn(e){return e.map(t=>({...t}))}function $a(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function Zn(e){const t=[];for(const n of e){const r=fs(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Us(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=fs(n.time),i=oe(n.open),a=oe(n.high),o=oe(n.low),c=oe(n.close),l=oe(n.volume)??0;r==null||i==null||a==null||o==null||c==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:c,volume:l})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function Gs({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i,showOrderFlow:a}){const o=u.useRef(null),c=u.useRef(null),l=u.useRef(null),d=u.useRef(null),p=u.useRef(null),f=u.useRef(null),y=u.useRef(null),b=u.useRef([]),x=u.useRef(new Map),m=u.useRef(null),j=u.useRef(0),P=u.useRef(null),E=u.useRef({lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0}),D=u.useRef([]),L=u.useRef(null),[k,z]=u.useState(qs),[M,q]=u.useState(()=>Date.now()),ee=u.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),V=Fe(Y=>Y.apiKey),Z=Fe(Y=>Y.setApiKey),$=ur(Y=>Y.mode==="dark"),re=h(Y=>Y.activeSide),I=h(Y=>Y.setActiveSide),N=h(Y=>Y.optionExchange),U=h(Y=>Y.chartInterval),g=h(Y=>e==="CE"?Y.selectedCESymbol:Y.selectedPESymbol),S=X(Y=>Y.ghostSignals),B=X(Y=>Y.executionSamples),A=re===e,_=u.useMemo(()=>a&&g?[{symbol:g,exchange:N}]:[],[a,g,N]),{data:K,isFallbackMode:C}=Fn({symbols:_,mode:"Quote",enabled:a&&!!g}),{data:w,isFallbackMode:J}=Fn({symbols:_,mode:"LTP",enabled:a&&!!g}),{data:W,isFallbackMode:ae}=Fn({symbols:_,mode:"Depth",enabled:a&&!!g}),ne=u.useMemo(()=>a&&g?`${N.toUpperCase()}:${g.toUpperCase()}`:null,[N,a,g]),T=C||J||ae,H=u.useMemo(()=>{if(!ne)return 0;const Y=K.get(ne)?.lastUpdate??0,O=w.get(ne)?.lastUpdate??0,Q=W.get(ne)?.lastUpdate??0;return Math.max(0,Y,O,Q)},[ne,W,w,K]),ie=u.useMemo(()=>Oa(e,k),[e,k]),ve=u.useMemo(()=>{if(!a||!g||H<=0)return!1;const Y=T?Ta:ka;return M-H>Y},[M,T,H,a,g]);u.useEffect(()=>{if(!a||!g)return;const Y=setInterval(()=>q(Date.now()),1e3);return()=>clearInterval(Y)},[a,g]),u.useEffect(()=>{E.current={lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0},z(qs)},[a,g,N]),u.useEffect(()=>{if(!a||!g||!ne)return;const Y=K.get(ne),O=w.get(ne),Q=W.get(ne),fe=[Y,O,Q].filter(de=>!!de),tt=fe.reduce((de,Ie)=>de?(Ie.lastUpdate??0)>=(de.lastUpdate??0)?Ie:de:Ie,fe[0]??null);if(!Y?.data&&!O?.data&&!Q?.data)return;const ze={...Y?.data??{},...O?.data??{},...Q?.data??{}},Ae=La({...ze,...tt?.data??{}});if(Ae==null||Ae<=0)return;const _e=Math.max(Date.now(),tt?.lastUpdate??0),Se=E.current,Be=Se.lastLtp,le=_e>Se.lastTickAt,se=Ma(ze),je=Se.lastVolume;let Te=[],Ke=[];if(ze.depth&&typeof ze.depth=="object"){const de=ze.depth;Te=Array.isArray(de.buy)?de.buy:[],Ke=Array.isArray(de.sell)?de.sell:[]}const nt=Te.length>0?Ks(Te[0]):0,We=Ke.length>0?Ks(Ke[0]):0,Ve=Ia(ze)??(nt>0?nt:null),it=Ra(ze)??(We>0?We:null),bt=Te.length>0?In(Te[0]):0,Et=Ke.length>0?In(Ke[0]):0,vt=Aa(ze),St=Fa(ze),Je=vt!=null&&vt>0?vt:bt>0?bt:null,Ze=St!=null&&St>0?St:Et>0?Et:null;let st=0,He=0,wt=!1,zt=!1,at=0;if(se!=null&&je!=null&&Number.isFinite(se)&&Number.isFinite(je)&&se>=je?at=Math.max(0,se-je):se!=null&&je==null&&(at=0),at>0)if(zt=!0,Be!=null&&Ae>Be)st=at;else if(Be!=null&&Ae<Be)He=at;else if(Ve!=null&&it!=null&&it>Ve){const de=(Ve+it)/2;Ae>=de?st=at:He=at}else st=at*.5,He=at*.5,wt=!0;if(st<=0&&He<=0){const de=Se.lastBidSize,Ie=Se.lastAskSize,ye=Ie!=null&&Ze!=null?Math.max(0,Ie-Ze):0,Ct=de!=null&&Je!=null?Math.max(0,de-Je):0,dt=de!=null&&Je!=null?Math.max(0,Je-de):0,It=Ie!=null&&Ze!=null?Math.max(0,Ze-Ie):0;let xt=ye+dt*.35,Le=Ct+It*.35;Be!=null&&Ae>Be&&(xt+=1),Be!=null&&Ae<Be&&(Le+=1);const Qe=xt+Le;if(Qe>0){wt=!0;const Ye=Math.max(1,Math.min(12,Math.sqrt(Qe)));if(xt>Le)st=Ye;else if(Le>xt)He=Ye;else if(Je!=null&&Ze!=null&&Je+Ze>0){const lt=(Je-Ze)/(Je+Ze);lt>0?st=Math.max(1,Ye*Math.abs(lt)):lt<0&&(He=Math.max(1,Ye*Math.abs(lt)))}}}st<=0&&He<=0&&Be!=null&&(wt=!0,Ae>Be?st=1:Ae<Be&&(He=1)),st<=0&&He<=0&&le&&(wt=!0,st=.35,He=.35),Se.lastLtp=Ae,Se.lastTickAt=_e,se!=null&&Number.isFinite(se)&&se>=0&&(Se.lastVolume=se),Je!=null&&Number.isFinite(Je)&&Je>=0&&(Se.lastBidSize=Je),Ze!=null&&Number.isFinite(Ze)&&Ze>=0&&(Se.lastAskSize=Ze),(st>0||He>0)&&(Se.buckets.push({ts:_e,buy:st,sell:He}),Se.cumulativeDelta+=st-He);const Jt=_e-Na;Se.buckets=Se.buckets.filter(de=>de.ts>=Jt);const _t=Se.buckets.reduce((de,Ie)=>de+Ie.buy,0),v=Se.buckets.reduce((de,Ie)=>de+Ie.sell,0),G=_t-v,te=G>0?"BUY":G<0?"SELL":"BAL";let ce=0,Pe=0;Te.length||Ke.length?(ce=Te.slice(0,5).reduce((de,Ie)=>de+In(Ie),0),Pe=Ke.slice(0,5).reduce((de,Ie)=>de+In(Ie),0)):(ce=Je&&Je>0?Je:0,Pe=Ze&&Ze>0?Ze:0);const he=ce+Pe,Me=he>0?(ce-Pe)/he*100:null,me=Ve!=null&&it!=null&&it>=Ve?it-Ve:null;_e-Se.lastEmitAt<wa||(Se.lastEmitAt=_e,z({buyFlow:_t,sellFlow:v,delta:G,cumulativeDelta:Se.cumulativeDelta,dominance:te,depthImbalancePct:Me,spread:me,flowSource:zt&&!wt?"VOL":"EST",lastUpdate:_e}))},[ne,W,w,K,a,g]);const ge=u.useCallback(()=>{const Y=b.current,O=ee.current,Q=Y.map(fe=>({time:fe.time,value:fe.close}));d.current&&d.current.setData(O.showEma9?Ln(_n(Q,9)):[]),p.current&&p.current.setData(O.showEma21?Ln(_n(Q,21)):[]),f.current&&f.current.setData(O.showSupertrend?Ln(zr(Y,10,3).trend):[]),y.current&&y.current.setData(O.showVwap?Ln(_r(Y)):[])},[]),pe=u.useCallback(()=>{P.current===null&&(P.current=setTimeout(()=>{P.current=null,ge()},va))},[ge]),R=u.useCallback(()=>{b.current=[],l.current?.setData([]),d.current?.setData([]),p.current?.setData([]),f.current?.setData([]),y.current?.setData([])},[]),we=u.useCallback(()=>{try{L.current?.setMarkers(D.current)}catch{}},[]);u.useEffect(()=>{if(!g)return;const Y=e==="CE",O=[];for(const Q of S.slice(-40)){if(Q.side!==e||Q.symbol!==g)continue;const fe=Math.floor(Q.timestamp/1e3/U)*U;O.push({time:fe,position:Y?"belowBar":"aboveBar",color:Y?"#22c55e99":"#ef444499",shape:Y?"arrowUp":"arrowDown",text:Q.score.toFixed(1),size:1})}for(const Q of B.slice(-20)){if(Q.side!==e||Q.symbol!==g)continue;const fe=Math.floor(Q.timestamp/1e3/U)*U;Q.status==="filled"?O.push({time:fe,position:Y?"belowBar":"aboveBar",color:Y?"#22c55e":"#ef4444",shape:Y?"arrowUp":"arrowDown",text:"IN",size:2}):Q.status==="exited"&&O.push({time:fe,position:Y?"aboveBar":"belowBar",color:"#f59e0b",shape:"square",text:"OUT",size:1})}O.sort((Q,fe)=>Number(Q.time)-Number(fe.time)),D.current=O,we()},[S,B,e,g,U,we]);const ke=u.useCallback(Y=>{const O=Us(Y);b.current=rn(O),l.current?.setData(Zn(O)),pe()},[pe]),ue=u.useCallback(async()=>{if(V)return V;try{const O=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(O.status==="success"&&O.api_key)return Z(O.api_key),O.api_key}catch{}return null},[V,Z]),F=u.useCallback(()=>{I(e)},[e,I]),be=u.useCallback((Y,O)=>{if(!l.current)return;const Q=fs(Y.time),fe=oe(Y.open),tt=oe(Y.high),ze=oe(Y.low),Ae=oe(Y.close),_e=oe(Y.volume)??0;if(Q==null||fe==null||tt==null||ze==null||Ae==null)return;const Se={time:Q,open:fe,high:tt,low:ze,close:Ae,volume:_e},Be=Number(Se.time),le=b.current.length?Number(b.current[b.current.length-1].time):null;if(le!=null&&Number.isFinite(le)&&Number.isFinite(Be)&&Be<le)return;try{l.current.update({time:Se.time,open:Se.open,high:Se.high,low:Se.low,close:Se.close})}catch{const je=Us([...b.current,Se]);b.current=je,l.current.setData(Zn(je)),pe();return}O?(b.current.push(Se),b.current.length>500&&(b.current=b.current.slice(-500))):b.current.length>0?b.current[b.current.length-1]=Se:b.current.push(Se);const se=m.current;se&&x.current.set(se,rn(b.current)),pe()},[pe]),{isConnected:Re,isFallbackMode:Ge,reset:De,seed:Ue}=$r({symbol:g??"",exchange:N,intervalSec:U,mode:"LTP",enabled:!!g,useIndiaMarketHours:!1,onCandleUpdate:be});return u.useEffect(()=>{const Y=m.current;if(Y&&b.current.length>0&&x.current.set(Y,rn(b.current)),!g){m.current=null,De(),R(),D.current=[];return}const O=`${N}:${g}:${U}`;m.current=O;const Q=x.current.get(O);if(Q&&Q.length>0){De(),Ue(Q),ke(Q);return}De(),R();const fe=++j.current,tt=Ca(U),ze=new Date,Ae=new Date(ze.getTime());Ae.setDate(Ae.getDate()-Sa),(async()=>{const Se=await ue();if(!Se){fe===j.current&&R();return}try{const Be=async()=>{try{const We=await Ee.getQuotes(Se,g,N);if(We.status!=="success"||!We.data)return null;const Ve=oe(We.data.ltp);if(Ve==null||Ve<=0)return null;const it=Math.floor(Date.now()/1e3);return{time:Math.floor(it/U)*U,open:Ve,high:Ve,low:Ve,close:Ve,volume:oe(We.data.volume)??0}}catch{return null}},le=async We=>{try{const Ve=await Ee.getHistory(Se,g,N,tt,Vs(Ae),Vs(ze),We);return Ve.status==="success"?Da(Ve.data):[]}catch{return[]}},se=await le("api"),je=se.length>0?se:await le("db");if(fe!==j.current)return;const Te=m.current===O?rn(b.current):[],Ke=$a(je,Te);if(Ke.length>0){x.current.set(O,rn(Ke)),Ue(Ke),ke(Ke);return}const nt=await Be();if(nt&&fe===j.current){const We=[nt];x.current.set(O,rn(We)),Ue(We),ke(We);return}}catch{}fe===j.current&&R()})()},[g,N,U,ue,De,Ue,R,ke]),u.useEffect(()=>{ee.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},d.current?.applyOptions({visible:t}),p.current?.applyOptions({visible:n}),f.current?.applyOptions({visible:r}),y.current?.applyOptions({visible:i}),pe()},[t,n,r,i,pe]),u.useEffect(()=>{const Y=o.current;if(!Y)return;const O=Ea($),Q=Br(Pa,ja),fe=xr(Y,{width:Y.offsetWidth,height:Y.offsetHeight,layout:{background:{type:gr.Solid,color:O.bg},textColor:O.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:O.grid},horzLines:{color:O.grid}},rightPriceScale:{borderColor:O.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:O.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:se=>Dr(se)},crosshair:{mode:hr.Normal,vertLine:{width:1,color:O.crosshair,style:2},horzLine:{width:1,color:O.crosshair,style:2}}}),tt=fe.addSeries(yr,{upColor:O.upColor,downColor:O.downColor,borderVisible:!1,wickUpColor:O.upColor,wickDownColor:O.downColor,autoscaleInfoProvider:Q}),ze=fe.addSeries(Ft,{color:O.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:ee.current.showEma9,autoscaleInfoProvider:Q}),Ae=fe.addSeries(Ft,{color:O.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:ee.current.showEma21,autoscaleInfoProvider:Q}),_e=fe.addSeries(Ft,{color:O.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:ee.current.showSupertrend,autoscaleInfoProvider:Q}),Se=fe.addSeries(Ft,{color:O.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:ee.current.showVwap,autoscaleInfoProvider:Q});c.current=fe,l.current=tt,d.current=ze,p.current=Ae,f.current=_e,y.current=Se,b.current.length>0&&(tt.setData(Zn(b.current)),pe());const Be=ti(tt);if(L.current=Be,D.current.length>0)try{Be.setMarkers(D.current)}catch{}const le=new ResizeObserver(()=>{if(c.current&&Y){const se=Y.offsetWidth,je=Y.offsetHeight;se>0&&je>0&&c.current.applyOptions({width:se,height:je})}});return le.observe(Y),()=>{P.current!==null&&(clearTimeout(P.current),P.current=null),le.disconnect();try{L.current?.detach()}catch{}L.current=null,fe.remove(),c.current=null,l.current=null,d.current=null,p.current=null,f.current=null,y.current=null}},[$,pe]),s.jsxs("div",{className:Xe("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",A&&"ring-1 ring-primary/40"),onClick:F,children:[s.jsx("div",{ref:o,className:"h-full w-full"}),s.jsx(ba,{chartRef:c,seriesRef:l,side:e,containerRef:o}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:Xe("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),g&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:g}),!g&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),a&&g&&s.jsxs("div",{className:"absolute top-7 left-2 pointer-events-none rounded border border-border/70 bg-background/85 backdrop-blur-[1px] px-2 py-1.5 text-[10px] font-mono leading-tight",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[s.jsx("span",{className:"text-muted-foreground",children:"FLOW 30s"}),s.jsx("span",{className:Xe(k.flowSource==="VOL"?"text-emerald-500":"text-amber-500"),children:k.flowSource})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-3 gap-y-0.5",children:[s.jsxs("span",{className:"text-green-500",children:["B ",Mn(k.buyFlow)]}),s.jsxs("span",{className:"text-red-500 text-right",children:["S ",Mn(k.sellFlow)]}),s.jsxs("span",{className:Xe(k.delta>0?"text-green-500":k.delta<0?"text-red-500":"text-muted-foreground"),children:["D ",k.delta>=0?"+":"",Mn(k.delta)]}),s.jsxs("span",{className:Xe(k.cumulativeDelta>0?"text-green-500":k.cumulativeDelta<0?"text-red-500":"text-muted-foreground","text-right"),children:["CD ",k.cumulativeDelta>=0?"+":"",Mn(k.cumulativeDelta)]}),s.jsx("span",{className:Xe(k.dominance==="BUY"?"text-green-500":k.dominance==="SELL"?"text-red-500":"text-muted-foreground"),children:k.dominance}),s.jsx("span",{className:Xe(ie.action==="BUY_CE"?"text-green-500":ie.action==="BUY_PE"?"text-red-500":"text-amber-400","text-right"),children:ie.label}),(k.depthImbalancePct!=null||k.spread!=null)&&s.jsxs("span",{className:Xe(k.depthImbalancePct==null?"text-muted-foreground":k.depthImbalancePct>=0?"text-green-500":"text-red-500","text-right"),children:["DEPTH ",k.depthImbalancePct==null?"NA":`${k.depthImbalancePct>=0?"+":""}${k.depthImbalancePct.toFixed(0)}%`]}),(k.depthImbalancePct!=null||k.spread!=null)&&s.jsxs("span",{className:"text-muted-foreground col-span-2",children:["SPR ",k.spread==null?"NA":k.spread.toFixed(2)]}),k.depthImbalancePct==null&&k.spread==null&&s.jsx("span",{className:Xe("col-span-2 text-right",ve?"text-amber-500":"text-muted-foreground"),children:ve?"WS stale / no recent ticks":"No L2 quote"})]})]}),A&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),g&&!Re&&!Ge&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),g&&!Re&&Ge&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-blue-500",children:"REST fallback"})}),!g&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function Vt(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function za(){const e=Fe(R=>R.apiKey),t=Fe(R=>R.setApiKey),n=h(R=>R.showFloatingWidget),r=h(R=>R.floatingWidgetMinimized),i=h(R=>R.setFloatingWidgetMinimized),a=h(R=>R.activeSide),o=h(R=>R.selectedCESymbol),c=h(R=>R.selectedPESymbol),l=h(R=>R.optionExchange),d=h(R=>R.quantity),p=h(R=>R.lotSize),f=h(R=>R.product),y=h(R=>R.tpPoints),b=h(R=>R.slPoints),x=h(R=>R.trailDistancePoints),m=h(R=>R.orderType),j=h(R=>R.limitPrice),P=h(R=>R.pendingLimitPlacement),E=h(R=>R.setLimitPrice),D=h(R=>R.setPendingEntryAction),L=h(R=>R.setPendingLimitPlacement),k=h(R=>R.clearPendingLimitPlacement),z=h(R=>R.paperMode),M=xe(R=>R.setVirtualTPSL),q=xe(R=>R.clearForSymbol),ee=xe(R=>R.getTPSLForSymbol),V=xe(R=>R.triggerOrders),Z=xe(R=>R.removeTriggerOrder),$=h(R=>R.ceWidgetPos),re=h(R=>R.setCeWidgetPos),I=h(R=>R.incrementQuantity),N=h(R=>R.decrementQuantity),U=h(R=>R.setTpPoints),g=h(R=>R.setSlPoints),S=h(R=>R.setTrailDistancePoints),B=h(R=>R.incrementTradeCount),A=a==="CE"?o:c,[_,K]=u.useState(!1),[C,w]=u.useState(null),[J,W]=u.useState(null),ae=u.useRef(null),ne=u.useRef(null);u.useEffect(()=>{if(!A){w(null),W(null);return}const we=Mt.getInstance().subscribe(A,l,"LTP",ke=>{const ue=ke.data.ltp;ue!=null&&ue>0&&(W(C),w(ue))});return()=>{we()}},[A,l]);const T=u.useCallback(R=>{if(R.target.closest("button, input"))return;R.preventDefault(),ae.current={startX:R.clientX,startY:R.clientY,origX:$.x,origY:$.y};const we=ue=>{if(!ae.current)return;const F=ue.clientX-ae.current.startX,be=ue.clientY-ae.current.startY;re({x:Math.max(0,ae.current.origX+F),y:Math.max(0,ae.current.origY+be)})},ke=()=>{ae.current=null,document.removeEventListener("mousemove",we),document.removeEventListener("mouseup",ke)};document.addEventListener("mousemove",we),document.addEventListener("mouseup",ke)},[$,re]),H=u.useCallback(async()=>{if(e)return e;try{const we=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(we.status==="success"&&we.api_key)return t(we.api_key),we.api_key}catch(R){console.error("[Scalping] Failed to fetch API key:",R),Ce.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ce.error("API key missing. Generate one on /apikey"),null},[e,t]),ie=u.useCallback(async R=>{if(!A||_){A||(console.warn("[Scalping] No symbol selected — click a strike first"),Ce.error("Select a strike first"));return}if(K(!0),m==="TRIGGER"){const F=Object.values(V).find(be=>be.symbol===A&&be.exchange===l&&be.side===a);F&&Z(F.id),k(),E(null),D(R),console.log(`[Scalping] TRIGGER armed (${R}) — click chart to place trigger line`),K(!1);return}if(m==="LIMIT"&&!j){D(R),console.log(`[Scalping] LIMIT armed (${R}) — click chart to set limit line`),K(!1);return}if(m==="LIMIT"&&P&&P.symbol===A&&P.side===a){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ce.error("A LIMIT order is already pending for this symbol"),K(!1);return}if(z){if(console.log(`[Paper] ${R} ${a} ${A} qty=${d*p} @ ${m}`),m==="MARKET"||m==="LIMIT"){const F=await $t({symbol:A,exchange:l,preferredPrice:m==="LIMIT"?j??C??void 0:C??void 0});F>0&&(M(Nt({symbol:A,exchange:l,side:a,action:R,entryPrice:F,quantity:d*p,tpPoints:y,slPoints:b,trailDistancePoints:x,managedBy:"manual"})),m==="LIMIT"&&E(null))}k(),B(),K(!1);return}const we=await H();if(!we){K(!1);return}const ke=m==="LIMIT"?"LIMIT":"MARKET",ue={apikey:we,strategy:"Scalping",exchange:l,symbol:A,action:R,quantity:d*p,pricetype:ke,product:f,price:m==="LIMIT"&&j?j:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${R} ${A} qty=${d*p} ${ke}`);const F=await Ee.placeOrder(ue);if(F.status==="success"){const be=Zt(F);if(console.log(`[Scalping] Order placed: ${R} ${A} id=${be??"n/a"}`),D(null),ke==="LIMIT"){const Re=j??C??0;Re<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state.");const Ge=Sn(F),De=qn(F);L({symbol:A,side:a,action:R,orderId:be,orderIds:Ge.length>0?Ge:void 0,splitLegs:De.length>0?De:void 0,quantity:d*p,entryPrice:Re,tpPoints:y,slPoints:b,trailDistancePoints:x}),Re>0&&E(Re),K(!1);return}if(k(),B(),ke==="MARKET"){const Re=await $t({symbol:A,exchange:l,preferredPrice:C??void 0,apiKey:null}),Ge=await Xt({symbol:A,exchange:l,orderId:be,preferredPrice:Re>0?Re:C??void 0,apiKey:we});Ge>0&&M(Nt({symbol:A,exchange:l,side:a,action:R,entryPrice:Ge,quantity:d*p,tpPoints:y,slPoints:b,trailDistancePoints:x,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",F),Ce.error(Vt(F,"Order was rejected"))}catch(F){console.error("[Scalping] Order failed:",F),Ce.error(Vt(F,"Order placement failed"))}K(!1)},[A,a,d,p,l,f,m,j,P,y,b,x,z,q,V,_,C,H,B,L,M,Z,E,D,k]),ve=u.useCallback(async()=>{if(!A||_)return;if(K(!0),z){console.log(`[Paper] Reversal ${a} ${A}`),B(),K(!1);return}const R=await H();if(!R){K(!1);return}try{const we={apikey:R,strategy:"Scalping",exchange:l,symbol:A,action:"SELL",quantity:d*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},ke=await Ee.placeOrder(we);if(ke.status!=="success"){Ce.error(Vt(ke,"Reversal close leg failed")),K(!1);return}const ue={apikey:R,strategy:"Scalping",exchange:l,symbol:A,action:"SELL",quantity:d*p,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},F=await Ee.placeOrder(ue);if(F.status!=="success"){Ce.error(Vt(F,"Reversal open leg failed")),K(!1);return}console.log(`[Scalping] Reversed ${a} ${A}`),B()}catch(we){console.error("[Scalping] Reversal failed:",we),Ce.error(Vt(we,"Reversal failed"))}K(!1)},[A,a,d,p,l,f,z,_,H,B]),ge=u.useCallback(async()=>{if(!A)return;if(z){console.log(`[Paper] Close ${a} ${A}`),q(A),E(null),D(null),k();return}const R=await H();if(!R)return;const we=ee(A);if(we&&we.quantity>0){const ke=we.action==="BUY"?"SELL":"BUY";try{const ue=await Ee.placeOrder({apikey:R,strategy:"Scalping",exchange:l,symbol:A,action:ke,quantity:we.quantity,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0});if(ue.status==="success"){console.log(`[Scalping] Closed ${a} ${A} qty=${we.quantity} (fast path)`),q(A),E(null),D(null),k();return}console.warn("[Scalping] Fast-close rejected, falling back:",ue)}catch(ue){console.warn("[Scalping] Fast-close failed, falling back:",ue)}}try{const ke=await Ee.closePosition(A,l,f);ke.status==="success"?(console.log(`[Scalping] Closed ${a} ${A}`),q(A),E(null),D(null),k()):(console.error("[Scalping] Close rejected:",ke),Ce.error(Vt(ke,"Close position rejected")))}catch(ke){console.error("[Scalping] Close failed:",ke),Ce.error(Vt(ke,"Close position failed"))}},[A,a,l,f,z,ee,H,q,E,D,k]);if(!n||!A)return null;const pe=C&&J?C>J?"up":C<J?"down":"flat":"flat";return r?s.jsx("div",{ref:ne,onMouseDown:T,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:$.x,top:$.y},children:s.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[s.jsx("span",{className:`text-[10px] font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:A.slice(-10)}),s.jsx("span",{className:`text-xs font-bold tabular-nums ${pe==="up"?"text-green-500":pe==="down"?"text-red-500":"text-foreground"}`,children:C?.toFixed(2)??"--"}),s.jsx(Oe,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>i(!1),title:"Open trade widget",children:"Open"})]})}):s.jsxs("div",{ref:ne,onMouseDown:T,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:$.x,top:$.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${a==="CE"?"text-green-500":"text-red-500"}`,children:a}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:A.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${pe==="up"?"text-green-500":pe==="down"?"text-red-500":"text-foreground"}`,children:C?.toFixed(2)??"--"}),s.jsx(Oe,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>i(!0),title:"Minimize widget",children:"_"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(Oe,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>ie("BUY"),disabled:_,children:"BUY"}),s.jsx(Oe,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>ie("SELL"),disabled:_,children:"SELL"}),s.jsx(Oe,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:ve,disabled:_,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:N,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:d}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:I,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:y,onChange:R=>U(Number.parseFloat(R.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:b,onChange:R=>g(Number.parseFloat(R.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-amber-400",children:"TR:"}),s.jsx("input",{type:"number",min:0,step:.5,value:x,onChange:R=>S(Number.parseFloat(R.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:ge,children:"x Close"})})]})}const _a=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600},{label:"1D",sec:86400}];function Ba({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,showOrderFlow:i,onToggleEma9:a,onToggleEma21:o,onToggleSupertrend:c,onToggleVwap:l,onToggleOrderFlow:d}){const p=h(y=>y.chartInterval),f=h(y=>y.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[_a.map(y=>s.jsx(Oe,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${p===y.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>f(y.sec),children:y.label},y.sec)),s.jsx(Va,{intervalSec:p}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(mn,{label:"EMA9",active:e,color:"text-amber-500",onClick:a}),s.jsx(mn,{label:"EMA21",active:t,color:"text-violet-500",onClick:o}),s.jsx(mn,{label:"ST",active:n,color:"text-cyan-500",onClick:c}),s.jsx(mn,{label:"VWAP",active:r,color:"text-pink-500",onClick:l}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(mn,{label:"FLOW",active:i,color:"text-emerald-500",onClick:d})]})}function Va({intervalSec:e}){const[t,n]=u.useState(()=>Qn(e));u.useEffect(()=>{n(Qn(e));const i=setInterval(()=>{n(Qn(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:qa(t,e)})}function Qn(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function qa(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function mn({label:e,active:t,color:n,onClick:r}){return s.jsx(Oe,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function Ws(){const[e,t]=u.useState(!0),[n,r]=u.useState(!0),[i,a]=u.useState(!0),[o,c]=u.useState(!0),[l,d]=u.useState(!1),p=u.useCallback(()=>t(m=>!m),[]),f=u.useCallback(()=>r(m=>!m),[]),y=u.useCallback(()=>a(m=>!m),[]),b=u.useCallback(()=>c(m=>!m),[]),x=u.useCallback(()=>d(m=>!m),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(Ba,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l,onToggleEma9:p,onToggleEma21:f,onToggleSupertrend:y,onToggleVwap:b,onToggleOrderFlow:x}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs(ns,{orientation:"vertical",children:[s.jsx(Ut,{defaultSize:"40%",minSize:"18%",children:s.jsx(da,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx($n,{withHandle:!0}),s.jsx(Ut,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs(ns,{orientation:"horizontal",children:[s.jsx(Ut,{defaultSize:"50%",minSize:"20%",children:s.jsx(Gs,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l})}),s.jsx($n,{withHandle:!0}),s.jsx(Ut,{defaultSize:"50%",minSize:"20%",children:s.jsx(Gs,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,showOrderFlow:l})})]}),s.jsx(za,{})]})})]})})]})}function qt(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function Ka(){const e=Fe(w=>w.apiKey),t=Fe(w=>w.setApiKey),n=h(w=>w.activeSide),r=h(w=>w.selectedCESymbol),i=h(w=>w.selectedPESymbol),a=h(w=>w.optionExchange),o=h(w=>w.quantity),c=h(w=>w.lotSize),l=h(w=>w.product),d=h(w=>w.orderType),p=h(w=>w.tpPoints),f=h(w=>w.slPoints),y=h(w=>w.trailDistancePoints),b=h(w=>w.limitPrice),x=h(w=>w.pendingLimitPlacement),m=h(w=>w.setLimitPrice),j=h(w=>w.setPendingEntryAction),P=h(w=>w.setPendingLimitPlacement),E=h(w=>w.clearPendingLimitPlacement),D=h(w=>w.paperMode),L=xe(w=>w.setVirtualTPSL),k=xe(w=>w.clearForSymbol),z=xe(w=>w.clearAll),M=xe(w=>w.triggerOrders),q=xe(w=>w.removeTriggerOrder),ee=xe(w=>w.getTPSLForSymbol),V=h(w=>w.setQuantity),Z=h(w=>w.incrementQuantity),$=h(w=>w.decrementQuantity),re=h(w=>w.setOrderType),I=h(w=>w.setProduct),N=h(w=>w.setTpPoints),U=h(w=>w.setSlPoints),g=h(w=>w.setTrailDistancePoints),S=h(w=>w.incrementTradeCount),B=n==="CE"?r:i,A=u.useCallback(async()=>{if(e)return e;try{const J=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(J.status==="success"&&J.api_key)return t(J.api_key),J.api_key}catch(w){console.error("[Scalping] Failed to fetch API key:",w),Ce.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ce.error("API key missing. Generate one on /apikey"),null},[e,t]),_=u.useCallback(async w=>{if(!B){console.warn("[Scalping] No symbol selected — click a strike first"),Ce.error("Select a strike first");return}if(d==="TRIGGER"){const ne=Object.values(M).find(T=>T.symbol===B&&T.exchange===a&&T.side===n);ne&&q(ne.id),E(),m(null),j(w),console.log(`[Scalping] TRIGGER armed (${w}) — click chart to place trigger line`);return}if(d==="LIMIT"&&!b){j(w),console.log(`[Scalping] LIMIT armed (${w}) — click chart to set limit line`);return}if(d==="LIMIT"&&x&&x.symbol===B&&x.side===n){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ce.error("A LIMIT order is already pending for this symbol");return}if(D){if(console.log(`[Paper] ${w} ${n} ${B} qty=${o*c} @ ${d}`),d==="MARKET"||d==="LIMIT"){const ne=await $t({symbol:B,exchange:a,preferredPrice:d==="LIMIT"?b??void 0:void 0});ne>0&&(L(Nt({symbol:B,exchange:a,side:n,action:w,entryPrice:ne,quantity:o*c,tpPoints:p,slPoints:f,trailDistancePoints:y,managedBy:"manual"})),d==="LIMIT"&&m(null))}E(),S();return}const J=await A();if(!J)return;const W=d==="LIMIT"?"LIMIT":"MARKET",ae={apikey:J,strategy:"Scalping",exchange:a,symbol:B,action:w,quantity:o*c,pricetype:W,product:l,price:d==="LIMIT"&&b?b:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${w} ${B} qty=${o*c} ${W}`);const ne=await Ee.placeOrder(ae);if(ne.status==="success"){const T=Zt(ne);if(console.log(`[Scalping] Order placed: ${w} ${B} id=${T??"n/a"}`),j(null),W==="LIMIT"){b==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state.");const H=Sn(ne),ie=qn(ne);P({symbol:B,side:n,action:w,orderId:T,orderIds:H.length>0?H:void 0,splitLegs:ie.length>0?ie:void 0,quantity:o*c,entryPrice:b??0,tpPoints:p,slPoints:f,trailDistancePoints:y}),b!=null&&m(b);return}if(E(),S(),W==="MARKET"){const H=B,ie=a,ve=n,ge=o*c;(async()=>{const pe=await $t({symbol:H,exchange:ie,apiKey:null}),R=await Xt({symbol:H,exchange:ie,orderId:T,preferredPrice:pe>0?pe:void 0,apiKey:J});R>0&&L(Nt({symbol:H,exchange:ie,side:ve,action:w,entryPrice:R,quantity:ge,tpPoints:p,slPoints:f,trailDistancePoints:y,managedBy:"manual"}))})()}}else console.error("[Scalping] Order rejected:",ne),Ce.error(qt(ne,"Order was rejected"))}catch(ne){console.error("[Scalping] Order failed:",ne),Ce.error(qt(ne,"Order placement failed"))}},[B,n,o,c,a,l,d,b,x,p,f,y,D,k,M,A,P,E,S,L,q,m,j]),K=u.useCallback(async()=>{if(!B)return;if(D){console.log(`[Paper] Close ${n} ${B}`),k(B),m(null),j(null),E();return}const w=await A();if(!w)return;const J=ee(B);if(J&&J.quantity>0){const W=J.action==="BUY"?"SELL":"BUY";try{const ae=await Ee.placeOrder({apikey:w,strategy:"Scalping",exchange:a,symbol:B,action:W,quantity:J.quantity,pricetype:"MARKET",product:l,price:0,trigger_price:0,disclosed_quantity:0});if(ae.status==="success"){console.log(`[Scalping] Closed ${n} ${B} qty=${J.quantity} (fast path)`),k(B),m(null),j(null),E();return}console.warn("[Scalping] Fast-close rejected, falling back to position-fetch close:",ae)}catch(ae){console.warn("[Scalping] Fast-close failed, falling back:",ae)}}try{const W=await Ee.closePosition(B,a,l);W.status==="success"?(console.log(`[Scalping] Closed ${n} ${B}`),k(B),m(null),j(null),E()):(console.error("[Scalping] Close rejected:",W),Ce.error(qt(W,"Close position rejected")))}catch(W){console.error("[Scalping] Close failed:",W),Ce.error(qt(W,"Close position failed"))}},[B,n,a,l,D,ee,A,k,m,j,E]),C=u.useCallback(async()=>{if(D){console.log("[Paper] Close all positions"),z(),m(null),j(null),E();return}const w=Ee.cancelAllOrders().catch(J=>(console.warn("[Scalping] Cancel all orders failed:",J),{status:"error",message:qt(J,"Cancel all orders failed")}));try{const J=await Ee.closeAllPositions({verify:!1}),W=await w;J.status==="success"||J.status==="info"?(W.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",W),console.log("[Scalping] Closed all positions"),z(),m(null),j(null),E()):(console.error("[Scalping] Close all rejected:",J),Ce.error(qt(J,"Close all rejected")))}catch(J){console.error("[Scalping] Close all failed:",J),Ce.error(qt(J,"Close all failed"))}},[D,z,m,j,E]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:B||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(Oe,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>_("BUY"),disabled:!B,children:"BUY"}),s.jsx(Oe,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>_("SELL"),disabled:!B,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Oe,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:$,children:"-"}),s.jsx(Lt,{type:"number",min:1,value:o,onChange:w=>V(Number.parseInt(w.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(Oe,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:Z,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*c," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(w=>s.jsx(Oe,{variant:d===w?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>re(w),children:w},w))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(w=>s.jsx(Oe,{variant:l===w?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>I(w),children:w},w))})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(Lt,{type:"number",min:0,step:5,value:p,onChange:w=>N(Number.parseFloat(w.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(Lt,{type:"number",min:0,step:5,value:f,onChange:w=>U(Number.parseFloat(w.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-xs text-amber-400",children:"Trail SL"}),s.jsx(Lt,{type:"number",min:0,step:.5,value:y,onChange:w=>g(Number.parseFloat(w.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(Oe,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:K,disabled:!B,children:["Close ",n," Position"]}),s.jsx(Oe,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:C,children:"Close All Positions"})]})]})}const Ua="Asia/Kolkata",Ga=new Intl.DateTimeFormat("en-GB",{timeZone:Ua,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,hourCycle:"h23"}),Hs={JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12},Wa=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Ha=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function ss(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Kn(e=new Date){const t={};for(const n of Ga.formatToParts(e))n.type!=="literal"&&(t[n.type]=n.value);return{year:Number(t.year),month:Number(t.month),day:Number(t.day),hours:Number(t.hour),minutes:Number(t.minute),seconds:Number(t.second)}}function Ya(e,t=new Date){const n=e.trim().toUpperCase();if(!n)return null;const r=n.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(r)return{year:Number(r[1]),month:Number(r[2]),day:Number(r[3])};const i=n.match(/^(\d{1,2})-([A-Z]{3})-(\d{2}|\d{4})$/);if(i){const o=Hs[i[2]];if(!o)return null;const c=Number(i[1]),l=i[3];return{year:l.length===2?2e3+Number(l):Number(l),month:o,day:c}}const a=n.match(/^(\d{1,2})-([A-Z]{3})$/);if(a){const o=Hs[a[2]];if(!o)return null;const{year:c}=Kn(t);return{year:c,month:o,day:Number(a[1])}}return null}function ms(e=new Date){const{hours:t,minutes:n}=Kn(e);return{hours:t,minutes:n}}function Gr(e){return e?Ha:Wa}function rs(e=new Date,t=!1){const{hours:n,minutes:r}=ms(e),i=n*60+r,a=Gr(t);for(const o of a){const c=ss(o.start),l=ss(o.end);if(i>=c&&i<l)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function Ys(e=new Date,t=!1){const{hours:n,minutes:r}=ms(e),i=n*60+r,a=Gr(t);for(const o of a){const c=ss(o.start);if(c>i)return{nextZone:o,minutesUntil:c-i}}return{nextZone:null,minutesUntil:0}}function Zs(e,t=new Date){if(!e)return!1;try{const n=Ya(e,t);if(!n)return!1;const r=Kn(t);return n.year===r.year&&n.month===r.month&&n.day===r.day}catch{return!1}}function Qs(e=new Date){const{hours:t,minutes:n}=ms(e),r=t*60+n;return r>=555&&r<930}function Xs(e=new Date){const{hours:t,minutes:n,seconds:r}=Kn(e);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}function Wr(){const e=h(r=>r.expiry),[t,n]=u.useState(()=>{const r=new Date,i=Zs(e,r),{zone:a,sensitivity:o}=rs(r,i),{nextZone:c,minutesUntil:l}=Ys(r,i);return{currentTime:Xs(r),currentZone:a,sensitivity:o,nextZone:c,minutesToNext:l,isExpiryDay:i,isOpen:Qs(r)}});return u.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Zs(e,a),{zone:c,sensitivity:l}=rs(a,o),{nextZone:d,minutesUntil:p}=Ys(a,o);n({currentTime:Xs(a),currentZone:c,sensitivity:l,nextZone:d,minutesToNext:p,isExpiryDay:o,isOpen:Qs(a)})},1e3);return()=>clearInterval(i)},[e]),t}function Za(){const e=X(r=>r.activePresetId),t=X(r=>r.applyPreset),{isExpiryDay:n}=Wr();return s.jsx("div",{className:"space-y-1.5",children:Vr.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(qe,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(qe,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function Ne({label:e,field:t,step:n}){const r=X(a=>a.config[t]),i=X(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(ft,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(Lt,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function gt({label:e,field:t}){const n=X(i=>i.config[t]),r=X(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(ft,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(xn,{checked:n===!0,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function pt({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function Qa(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(pt,{title:"Entry Conditions",children:[s.jsx(Ne,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(Ne,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(Ne,{label:"Min Score",field:"entryMinScore"}),s.jsx(Ne,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(pt,{title:"Volume Flow",children:[s.jsx(gt,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),s.jsx(Ne,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),s.jsx(Ne,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),s.jsx(Ne,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),s.jsx(Ne,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),s.jsx(Ne,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),s.jsxs(pt,{title:"Trailing SL (5-Stage)",children:[s.jsx(Ne,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(Ne,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(Ne,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(Ne,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(Ne,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(Ne,{label:"Trail Step",field:"trailStepSize"}),s.jsx(Ne,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(Ne,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(pt,{title:"Breakeven",children:[s.jsx(Ne,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(Ne,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(pt,{title:"Risk",children:[s.jsx(Ne,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(Ne,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(Ne,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(Ne,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(Ne,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(Ne,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(Ne,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(Ne,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(pt,{title:"Imbalance Filter",children:[s.jsx(gt,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(Ne,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(pt,{title:"Regime Detection",children:[s.jsx(Ne,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(Ne,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(pt,{title:"Index Bias",children:[s.jsx(gt,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(Ne,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(pt,{title:"Options Context",children:[s.jsx(gt,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(Ne,{label:"PCR Bullish ≤",field:"pcrBullishThreshold",step:.1}),s.jsx(Ne,{label:"PCR Bearish ≥",field:"pcrBearishThreshold",step:.1}),s.jsx(Ne,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(gt,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(gt,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(Ne,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(pt,{title:"Time-of-Day",children:[s.jsx(gt,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(Ne,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(pt,{title:"No-Trade Zone",children:[s.jsx(gt,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(Ne,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(Ne,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(pt,{title:"Re-Entry",children:[s.jsx(gt,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(Ne,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(Ne,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(pt,{title:"Telegram Alerts",children:[s.jsx(gt,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(gt,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(gt,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Xa(){const e=X(r=>r.ghostSignals),t=X(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(Ja,{signal:r},r.id))]})}function Ja({signal:e}){const t=Fe(f=>f.apiKey),n=h(f=>f.optionExchange),r=h(f=>f.quantity),i=h(f=>f.lotSize),a=h(f=>f.product),o=h(f=>f.paperMode),c=h(f=>f.incrementTradeCount),l=u.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),c();return}if(!t)return;const f={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const y=await Ee.placeOrder(f);y.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${y.data?.orderid}`),c())}catch(y){console.error("[Ghost Take] Failed:",y)}},[e,t,n,r,i,a,o,c]),d=Math.round((Date.now()-e.timestamp)/1e3),p=d<60?`${d}s ago`:`${Math.round(d/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(qe,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),s.jsxs(qe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(Oe,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:l,children:"Take Trade"})]})]})}function eo(){const e=X(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(qe,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const xs={getBotStatus:async()=>(await Pt.get("/telegram/bot/status")).data.data,startBot:async()=>(await Pt.post("/telegram/bot/start")).data,stopBot:async()=>(await Pt.post("/telegram/bot/stop")).data,getConfig:async()=>(await Pt.get("/telegram/api/config")).data.data,updateConfig:async e=>(await Pt.post("/telegram/config",e)).data,getUsers:async()=>(await Pt.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await Pt.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await Pt.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await Pt.post("/telegram/test-message")).data,sendBroadcast:async e=>(await Pt.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await Pt.post("/telegram/send-message",{telegram_id:e,message:t})).data};function to(){const[e,t]=u.useState(!1),[n,r]=u.useState(null),[i,a]=u.useState(null),[o,c]=u.useState(null),l=X(x=>x.updateConfig),d=X(x=>x.config),p=h(x=>x.underlying),f=u.useCallback(async()=>{try{const x=await ni();r(x.provider||"none"),x.last_run&&a(x.last_run),c(null)}catch{c("Could not reach advisor")}},[]),y=u.useCallback(async()=>{t(!0),c(null);try{const x=await si({underlying:p});if(x.status==="success"&&x.run_id){const m=await ri(1);m.runs?.length>0&&a(m.runs[0])}else c(x.message||"Tuning failed")}catch{c("Advisor request failed")}finally{t(!1)}},[p]),b=u.useCallback(async()=>{if(i?.run_id){t(!0);try{await ii(i.run_id);const x=i.recommendations;if(x&&typeof x=="object"){const m={};for(const[j,P]of Object.entries(x)){if(!(j in d))continue;const E=j,D=d[E];if(typeof D=="number"){const L=typeof P=="number"?P:Number(P);Number.isFinite(L)&&(m[E]=L);continue}if(typeof D=="boolean"){let L=null;if(typeof P=="boolean")L=P;else if(typeof P=="number")L=P!==0;else if(typeof P=="string"){const k=P.trim().toLowerCase();["true","1","yes","on","enabled"].includes(k)&&(L=!0),["false","0","no","off","disabled"].includes(k)&&(L=!1)}L!=null&&(m[E]=L)}}if(Object.keys(m).length>0&&(l(m),d.telegramAlertsTune)){const j=Object.keys(m).join(", ");xs.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${j}`}).catch(()=>{})}}a(m=>m&&{...m,applied:!0}),c(null)}catch{c("Failed to apply recommendation")}finally{t(!1)}}},[i,l,d,p]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(qe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(Oe,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:f,disabled:e,children:"Check Status"}),s.jsx(Oe,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:y,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??"—"})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([x,m])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:x}),s.jsx("span",{className:"font-mono",children:typeof m=="number"?m:String(m)})]},x))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(Oe,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:b,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(qe,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function no(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function so(){const e=X(C=>C.enabled),t=X(C=>C.mode),n=X(C=>C.replayMode),r=X(C=>C.regime),i=X(C=>C.tradesCount),a=X(C=>C.realizedPnl),o=X(C=>C.consecutiveLosses),c=X(C=>C.killSwitch),l=X(C=>C.lockProfitEnabled),d=X(C=>C.lockProfitTriggered),p=X(C=>C.accountPeakPnl),f=X(C=>C.accountDrawdown),y=X(C=>C.autoPeakPnl),b=X(C=>C.autoDrawdown),x=X(C=>C.sideEntryCount),m=X(C=>C.sideLastExitAt),j=X(C=>C.sideLossPnl),P=X(C=>C.lastDecisionBySide),E=X(C=>C.decisionHistory),D=X(C=>C.executionSamples),L=X(C=>C.config),k=X(C=>C.setEnabled),z=X(C=>C.setMode),M=X(C=>C.setReplayMode),q=X(C=>C.setKillSwitch),ee=X(C=>C.setLockProfitEnabled),V=X(C=>C.resetRuntime),Z=h(C=>C.activeSide),$=h(C=>C.paperMode),re=xe(C=>C.virtualTPSL),I=u.useMemo(()=>P[Z]??E[E.length-1]??null,[Z,E,P]),N=u.useMemo(()=>I?Math.max(0,Math.min(99,Math.round(I.score/Math.max(1,I.minScore)*100))):r==="UNKNOWN"?0:55,[I,r]),U=u.useMemo(()=>Object.values(re).reduce((C,w)=>(C[w.side]+=w.quantity,C),{CE:0,PE:0}),[re]),g=u.useMemo(()=>Object.values(re).reduce((C,w)=>(w.managedBy!=="auto"||(C[w.side]+=w.quantity),C),{CE:0,PE:0}),[re]),S=u.useMemo(()=>{const C=D.slice(-10),w=C.filter(T=>T.status==="filled"),J=C.filter(T=>T.status==="rejected"),W=w.length>0?w.reduce((T,H)=>T+H.spread,0)/w.length:0,ae=w.length>0?w.reduce((T,H)=>T+H.expectedSlippage,0)/w.length:0,ne=C.length>0?J.length/C.length*100:0;return{recent:C.slice().reverse(),avgSpread:W,avgSlippage:ae,rejectRate:ne}},[D]),B=I?I.spread<=L.entryMaxSpread*.4?"TIGHT":I.spread<=L.entryMaxSpread?"NORMAL":"WIDE":"NA",A=m[Z]>0?Math.max(0,Math.round((Date.now()-m[Z])/1e3)):null,_=e&&t==="execute"&&n,K=C=>C<=0?"0":`-${C.toFixed(0)}`;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ft,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(xn,{checked:e,onCheckedChange:k,className:"h-5 w-9"})]}),s.jsx(qe,{variant:e?t==="execute"&&!n?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?_?"SIM (REPLAY)":t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(Oe,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>z("ghost"),children:"Ghost (Signals Only)"}),s.jsx(Oe,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>z("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(xn,{checked:n,onCheckedChange:M,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),_&&s.jsx("div",{className:"p-1 bg-amber-500/10 border border-amber-500/30 rounded text-amber-400 text-[10px] text-center font-medium",children:"EXECUTE BLOCKED - Replay/Simulator is ON"}),t==="execute"&&!$&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(qe,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:V,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),I?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[I.side," ",I.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${I.enter?"text-green-500":"text-red-500"}`,children:[I.score.toFixed(1)," / ",I.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:I.reason}),s.jsx("div",{className:"space-y-0.5",children:I.checks.slice(0,8).map(C=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:C.label}),s.jsxs("span",{className:`text-[10px] font-medium ${C.pass?"text-green-500":"text-red-500"}`,children:[C.pass?"PASS":"FAIL",C.value?` (${C.value})`:""]})]},C.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:no(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[N,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:I&&!I.enter?I.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",Z,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:A==null?"—":`${A}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${B==="WIDE"?"text-red-500":B==="TIGHT"?"text-green-500":""}`,children:B})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Execution Gate"}),s.jsx("span",{className:`font-medium ${_?"text-amber-400":t==="execute"?"text-green-500":"text-muted-foreground"}`,children:_?"BLOCKED (Replay)":t==="execute"?"OPEN":"Ghost Mode"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(I?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:I?.depthRatio!=null?I.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:S.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:S.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${S.rejectRate>30?"text-red-500":""}`,children:[S.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[S.recent.slice(0,5).map(C=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[C.side," ",C.symbol.slice(-10)]}),s.jsx("span",{className:C.status==="rejected"?"text-red-500":C.status==="filled"?"text-green-500":"text-muted-foreground",children:C.status})]},`${C.timestamp}-${C.symbol}`)),S.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[c&&s.jsx(qe,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(xn,{checked:c,onCheckedChange:q,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[d&&s.jsx(qe,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(xn,{checked:l,onCheckedChange:ee,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),s.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),s.jsx("span",{className:`font-mono ${f>0?"text-red-500":""}`,children:f.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),s.jsx("span",{className:"font-mono",children:y.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),s.jsx("span",{className:`font-mono ${b>0?"text-red-500":""}`,children:b.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),s.jsx("span",{className:"font-mono",children:U.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),s.jsx("span",{className:"font-mono",children:U.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),s.jsx("span",{className:"font-mono",children:g.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),s.jsx("span",{className:"font-mono",children:g.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:x.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:x.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsx("span",{className:`font-mono ${j.CE>0?"text-red-500":""}`,children:K(j.CE)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsx("span",{className:`font-mono ${j.PE>0?"text-red-500":""}`,children:K(j.PE)})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(eo,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(Xa,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(to,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(Za,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(Qa,{})]})]})}function ro(){const e=Fe(f=>f.apiKey),t=h(f=>f.optionExchange),n=xe(f=>f.virtualTPSL),r=xe(f=>f.triggerOrders),i=xe(f=>f.removeVirtualTPSL),a=xe(f=>f.removeTriggerOrder),o=xe(f=>f.clearAll),{data:c}=fr({queryKey:["scalping-orders",t],queryFn:()=>Ee.getOrders(e),enabled:!!e,refetchInterval:5e3}),l=(c?.data?.orders??[]).filter(f=>f.exchange===t&&(f.order_status==="open"||f.order_status==="pending"||f.order_status==="trigger pending")),d=Object.values(n),p=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(qe,{variant:"outline",className:"text-[10px] h-4",children:l.length})]}),l.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:l.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",f.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(qe,{variant:"outline",className:"text-[10px] h-4",children:f.order_status}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await Ee.cancelOrder(f.orderid)}catch(y){console.error("Cancel failed:",y)}},children:"Cancel"})]})]},f.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(qe,{variant:"outline",className:"text-[10px] h-4",children:d.length})]}),d.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:d.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.side==="CE"?"text-green-500":"text-red-500",children:f.side})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",f.entryPrice.toFixed(1)," |"," ",f.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",f.tpPrice.toFixed(1)]})," ",f.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",f.slPrice.toFixed(1)]})]})]}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(f.id),children:"Remove"})]},f.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(qe,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:p.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",f.triggerPrice.toFixed(1)," (",f.direction,") | x",f.quantity]})]}),s.jsx(Oe,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(f.id),children:"Remove"})]},f.id))})]}),(d.length>0||p.length>0)&&s.jsx(Oe,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function io(e,t){const n=Fe(p=>p.apiKey),[r,i]=u.useState(null),[a,o]=u.useState(!1),c=u.useRef(null),l=u.useCallback(async()=>{if(!(!e||!n)){try{const p=await Ee.getDepth(n,e,t);p.status==="success"&&p.data&&i(p.data)}catch{}o(!1)}},[e,t,n]);u.useEffect(()=>{if(!e){i(null);return}return o(!0),l(),c.current=setInterval(l,2e3),()=>{c.current&&clearInterval(c.current)}},[e,l]);const d=r?ao(r):null;return{depth:r,analytics:d,levels:5,isLoading:a}}function ao(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((b,x)=>b+x.quantity,0),i=n.reduce((b,x)=>b+x.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,c=t.length>0?t.reduce((b,x)=>x.quantity>b.quantity?x:b,t[0]):null,l=c?{price:c.price,qty:c.quantity}:null,d=n.length>0?n.reduce((b,x)=>x.quantity>b.quantity?x:b,n[0]):null,p=d?{price:d.price,qty:d.quantity}:null,f=r+i,y=f>0?(r-i)/f*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:l,largestAskWall:p,imbalanceScore:y}}function oo(){const e=h(c=>c.activeSide),t=h(c=>c.optionExchange),n=h(c=>c.activeSide==="CE"?c.selectedCESymbol:c.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=io(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(qe,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((c,l)=>{const d=r.bids?.[l],p=r.asks?.[l],f=Math.max(...r.bids?.map(y=>y.quantity)??[0],...r.asks?.map(y=>y.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:d&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${f>0?d.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:d.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:d?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${f>0?p.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},l)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Js=500;function lo(){const e=u.useRef([]),t=u.useCallback(c=>{const l={...c,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(l),e.current.length>Js&&(e.current=e.current.slice(-Js)),l},[]),n=u.useCallback(()=>[...e.current],[]),r=u.useCallback(c=>e.current.slice(-c),[]),i=u.useCallback(()=>{e.current=[]},[]),a=u.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=u.useCallback(()=>{const c=e.current;if(c.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const l=c.filter(y=>y.pnl!==void 0),d=l.filter(y=>(y.pnl??0)>0),p=l.reduce((y,b)=>y+(b.pnl??0),0),f=l.map(y=>y.pnl??0);return{count:c.length,winRate:l.length>0?d.length/l.length*100:0,avgPnl:l.length>0?p/l.length:0,totalPnl:p,bestTrade:f.length>0?Math.max(...f):0,worstTrade:f.length>0?Math.min(...f):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function co({liveOpenPnl:e,isLivePnl:t=!1}){const n=h(E=>E.sessionPnl),r=h(E=>E.tradeCount),i=h(E=>E.paperMode),a=i?n:e??n,o=Wr(),{getStats:c}=lo(),l=c(),[d,p]=u.useState(5e3),[f,y]=u.useState(500),[b,x]=u.useState(50),[m,j]=u.useState(3),P=a<0&&Math.abs(a)>=d;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsxs("span",{className:"font-mono text-sm font-bold tabular-nums",children:[o.currentTime," IST"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(qe,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(qe,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),P&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(Lt,{type:"number",value:d,onChange:E=>p(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(Lt,{type:"number",value:f,onChange:E=>y(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(Lt,{type:"number",value:b,onChange:E=>x(Number(E.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(ft,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(Lt,{type:"number",value:m,onChange:E=>j(Number(E.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),l.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[l.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${l.avgPnl>0?"text-green-500":l.avgPnl<0?"text-red-500":""}`,children:[l.avgPnl>=0?"+":"",l.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",l.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:l.worstTrade.toFixed(0)})]})]})]})]})]})}const uo=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function po({liveOpenPnl:e,isLivePnl:t=!1}){const n=h(i=>i.controlTab),r=h(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:uo.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx(Ka,{}),n==="auto"&&s.jsx(so,{}),n==="risk"&&s.jsx(co,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(oo,{}),n==="orders"&&s.jsx(ro,{})]})]})}const fo=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE ↔ PE)"},{key:"↑",description:"CE direct market buy (with virtual TP/SL)"},{key:"↓",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function mo({open:e,onClose:t}){return u.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:fo.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function er(e,t){if(e&&typeof e=="object"){const n=e.response?.data;if(n&&typeof n=="object"){const i=n.message;if(typeof i=="string"&&i.trim().length>0)return i.trim();const a=n.error;if(typeof a=="string"&&a.trim().length>0)return a.trim()}else if(typeof n=="string"&&n.trim().length>0)return n.trim();const r=e.message;if(typeof r=="string"&&r.trim().length>0)return r.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function xo(e={}){const t=h(g=>g.hotkeysEnabled),n=h(g=>g.activeSide),r=h(g=>g.selectedCESymbol),i=h(g=>g.selectedPESymbol),a=h(g=>g.optionExchange),o=h(g=>g.quantity),c=h(g=>g.lotSize),l=h(g=>g.product),d=h(g=>g.orderType),p=h(g=>g.limitPrice),f=h(g=>g.pendingLimitPlacement),y=h(g=>g.setLimitPrice),b=h(g=>g.setPendingLimitPlacement),x=h(g=>g.clearPendingLimitPlacement),m=h(g=>g.tpPoints),j=h(g=>g.slPoints),P=h(g=>g.trailDistancePoints),E=h(g=>g.setPendingEntryAction),D=h(g=>g.paperMode),L=xe(g=>g.setVirtualTPSL),k=xe(g=>g.triggerOrders),z=xe(g=>g.removeTriggerOrder),M=h(g=>g.setActiveSide),q=h(g=>g.toggleActiveSide),ee=h(g=>g.toggleFloatingWidget),V=h(g=>g.setQuantity),Z=Fe(g=>g.apiKey),$=Fe(g=>g.setApiKey),re=u.useCallback(()=>n==="CE"?r:i,[n,r,i]),I=u.useCallback(g=>g==="CE"?r:i,[r,i]),N=u.useCallback(async()=>{if(Z)return Z;try{const S=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(S.status==="success"&&S.api_key)return $(S.api_key),S.api_key}catch(g){console.error("[Scalping] Failed to fetch API key:",g),Ce.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ce.error("API key missing. Generate one on /apikey"),null},[Z,$]),U=u.useCallback(async(g,S,B=!1)=>{const A=S??n,_=I(A),K=B?"MARKET":d;if(!_){console.warn("[Scalping] No symbol selected — click a strike first"),Ce.error("Select a strike first");return}if(K==="TRIGGER"){const W=Object.values(k).find(ae=>ae.symbol===_&&ae.exchange===a&&ae.side===A);W&&z(W.id),x(),y(null),E(g),console.log(`[Scalping] TRIGGER armed (${g}) — click chart to place trigger line`);return}if(K==="LIMIT"&&!p){E(g),console.log(`[Scalping] LIMIT armed (${g}) — click chart to set limit line`);return}if(K==="LIMIT"&&f&&f.symbol===_&&f.side===A){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ce.error("A LIMIT order is already pending for this symbol");return}if(D){if(console.log(`[Paper] ${g} ${A} ${_} qty=${o*c} @ ${K}`),K==="MARKET"||K==="LIMIT"){const W=await $t({symbol:_,exchange:a,preferredPrice:K==="LIMIT"?p??void 0:void 0});W>0&&(L(Nt({symbol:_,exchange:a,side:A,action:g,entryPrice:W,quantity:o*c,tpPoints:m,slPoints:j,trailDistancePoints:P,managedBy:"hotkey"})),K==="LIMIT"&&y(null))}x();return}const C=await N();if(!C)return;const w=K==="LIMIT"?"LIMIT":"MARKET",J={apikey:C,strategy:"Scalping",exchange:a,symbol:_,action:g,quantity:o*c,pricetype:w,product:l,price:K==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${g} ${_} qty=${o*c} ${w}`);const W=await Ee.placeOrder(J);if(W.status==="success"){const ae=Zt(W);if(console.log(`[Scalping] Order placed: ${g} ${_} id=${ae??"n/a"}`),E(null),w==="LIMIT"){p==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state.");const ne=Sn(W),T=qn(W);b({symbol:_,side:A,action:g,orderId:ae,orderIds:ne.length>0?ne:void 0,splitLegs:T.length>0?T:void 0,quantity:o*c,entryPrice:p??0,tpPoints:m,slPoints:j,trailDistancePoints:P}),p!=null&&y(p);return}if(x(),w==="MARKET"){const ne=await $t({symbol:_,exchange:a,apiKey:null}),T=await Xt({symbol:_,exchange:a,orderId:ae,preferredPrice:ne>0?ne:void 0,apiKey:C});T>0&&L(Nt({symbol:_,exchange:a,side:A,action:g,entryPrice:T,quantity:o*c,tpPoints:m,slPoints:j,trailDistancePoints:P,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",W),Ce.error(er(W,"Order was rejected"))}catch(W){console.error("[Scalping] Order failed:",W),Ce.error(er(W,"Order placement failed"))}},[I,n,o,c,a,l,d,p,f,m,j,P,D,k,N,b,x,L,z,y,E]);u.useEffect(()=>{if(!t)return;const g=S=>{const B=S.target?.tagName;if(B==="INPUT"||B==="TEXTAREA"||B==="SELECT"||S.repeat)return;const A=re();switch(S.key.toLowerCase()){case"b":{S.preventDefault(),A&&(U("BUY"),e.onBuy?.(n,A));break}case"s":{S.preventDefault(),A&&(U("SELL"),e.onSell?.(n,A));break}case"c":{S.preventDefault(),A&&e.onClose?.(n,A);break}case"x":{S.preventDefault(),e.onCloseAll?.();break}case"r":{S.preventDefault(),A&&e.onReversal?.(n,A);break}case"w":{S.preventDefault(),ee();break}case"tab":{S.preventDefault(),q();break}case"1":{S.preventDefault(),V(1);break}case"2":{S.preventDefault(),V(2);break}case"3":{S.preventDefault(),V(3);break}case"?":{S.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{S.preventDefault(),r&&(M("CE"),U("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{S.preventDefault(),i&&(M("PE"),U("BUY","PE",!0),e.onBuy?.("PE",i));break}}};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[t,n,re,U,q,M,ee,V,r,i,e])}const ho=300,tr=2e3,nr=15,sr=8e3,rr=15e3;function ct(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function Vn(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=ct(n,Number.NaN);return Number.isFinite(r)?r:null}function go(e,t,n){if(!e.length)return null;const r=e.find(c=>c.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let c=1;c<e.length;c++){const l=Math.abs(e[c].strike-i);l<o&&(a=e[c],o=l)}return a}function yo(e){return ct(e.ce?.oi,0)+ct(e.pe?.oi,0)}function bo(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(ct(Vn(t,"net_gex"),0))||yo(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function vo(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const c of e){const l=c.strike,d=ct(c.ce?.oi,0),p=ct(c.pe?.oi,0);a>l?o+=(a-l)*d:a<l&&(o+=(l-a)*p)}o<r&&(r=o,n=a)}return n}function So(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function ir(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!So(e.topGammaStrikes,t.topGammaStrikes)}function ar(e,t){const n=Vn(e,"iv");return n!=null&&n>0?n:t}function Po(e){return e.replace(/-/g,"").toUpperCase()}function or(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=ct(e.underlying_ltp,0),a=ct(e.atm_strike,0),o=go(r,a,i),c=r.reduce((z,M)=>(z.ceOi+=ct(M.ce?.oi,0),z.peOi+=ct(M.pe?.oi,0),z.ceVol+=ct(M.ce?.volume,0),z.peVol+=ct(M.pe?.volume,0),z),{ceOi:0,peOi:0,ceVol:0,peVol:0}),l=c.ceOi>0?c.peOi/c.ceOi:1,d=vo(r,o?.strike??a),p=i-d,f=bo(r),y=Vn(e,"total_net_gex"),b=y??0,x=t?.ceIV??nr,m=t?.peIV??nr,j=ar(o?.ce,x),P=ar(o?.pe,m),E=(j+P)/2,D=j-P,L=Vn(e,"iv_percentile")??t?.ivPercentile??50,k=ct(o?.ce?.ltp,0)+ct(o?.pe?.ltp,0);return{pcr:l,oiChangeCE:c.ceOi,oiChangePE:c.peOi,maxPainStrike:d,spotVsMaxPain:p,topGammaStrikes:f,gexFlipZones:[],netGEX:b,atmIV:E,ivPercentile:L,ceIV:j,peIV:P,ivSkew:D,straddlePrice:k,lastUpdated:n>0?n:Date.now()}}function jo(){const e=Fe(m=>m.apiKey),t=h(m=>m.underlying),n=h(m=>m.expiry),r=h(m=>m.indexExchange),i=h(m=>m.chainStrikeCount),a=h(m=>m.optionChainData),o=h(m=>m.optionChainLastUpdate),c=h(m=>m.optionChainIsStreaming),l=X(m=>m.optionsContext),d=X(m=>m.setOptionsContext),p=u.useRef(0),f=u.useRef(!1),y=u.useRef(0),b=u.useRef(null);u.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const m=Date.now();if(m-p.current<ho)return;const j=or(a,l,o||m);if(!j)return;const P=ir(l,j),E=!l||m-l.lastUpdated>=tr;!P&&!E||(d(j),p.current=m)},[a,o,l,d]);const x=u.useCallback(async()=>{if(f.current||!e||!t||!n||!r)return;const m=Date.now();if(!(m-y.current<rr||a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||m-(o||0)<=sr))){f.current=!0,y.current=m;try{const P=await mr.getOptionChain(e,t,r,Po(n),i);if(P.status!=="success"||!Array.isArray(P.chain)||P.chain.length===0)return;const E=or(P,l,Date.now());if(!E)return;const D=ir(l,E),L=!l||Date.now()-l.lastUpdated>=tr;if(!D&&!L)return;d(E),p.current=Date.now()}catch{}finally{f.current=!1}}},[e,t,n,r,i,a,c,o,l,d]);u.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(c||Date.now()-(o||0)<=sr)){b.current&&(clearInterval(b.current),b.current=null);return}return x(),b.current&&clearInterval(b.current),b.current=setInterval(()=>{x()},rr),()=>{b.current&&(clearInterval(b.current),b.current=null)}},[a,c,o,x])}function No(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let c=1;c<n.length;c++)n[c]>n[c-1]?r++:n[c]<n[c-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function wo(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(d=>d.high),i=n.map(d=>d.low),a=Math.max(...r)-Math.min(...i),o=n.map(d=>d.close),c=Math.abs(o[o.length-1]-o[0]),l=n.reduce((d,p)=>d+(p.high-p.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":c>a*.6?"TRENDING":l>a*.15?"VOLATILE":"RANGING"}function ko(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function To(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1)),e.supertrend!==null&&e.ema9!==null&&(e.ema9>e.supertrend?n+=1:n-=1);const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function Eo(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function Co(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function Lo(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Mo(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function Io(e,t,n,r,i,a,o,c,l,d,p,f=[],y,b){let x=0;const m=[],j=Date.now(),P=[],E=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,D=n.respectHotZones?l:1,L=Math.max(.25,D*Math.max(.1,n.sensitivityMultiplier)),k=b==="RANGING"?1.5:b==="UNKNOWN"?.5:0,z=Math.min(10,Math.max(1,n.entryMinScore/L)+k),M=(T,H,ie,ve)=>{P.push({id:T,label:H,pass:ie,value:ve})},q=(T,H)=>({enter:!1,reason:T,score:x,minScore:Number(z.toFixed(2)),checks:P,blockedBy:H,spread:d,depthRatio:E,expectedSlippage:Math.max(0,d/2)}),ee=r.tradesCount<n.maxTradesPerDay;if(M("daily-trades","Daily trade cap",ee,`${r.tradesCount}/${n.maxTradesPerDay}`),!ee)return q("Max daily trades reached","daily-trades");const V=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(M("daily-loss","Daily loss limit",V,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!V)return q("Daily loss limit reached","daily-loss");const Z=r.consecutiveLosses<n.coolingOffAfterLosses;if(M("cooling-off","Consecutive-loss cooling off",Z,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!Z)return q(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const $=!r.killSwitch;if(M("kill-switch","Kill switch",$),!$)return q("Kill switch active","kill-switch");const re=!r.lockProfitTriggered;if(M("lock-profit","Lock-profit protection",re),!re)return q("Lock-profit triggered: new entries blocked","lock-profit");const I=!n.respectHotZones||D>0;if(M("hot-zone","Market hot-zone timing",I,n.respectHotZones?D.toFixed(2):"OFF"),!I)return q("Outside configured market hot-zone timing","hot-zone");const N=Math.max(0,r.openSideLots??0),U=r.allowEntryWithOpenSide===!0,g=!r.sideOpen||U;if(M("side-open","No open position on side",g,r.sideOpen?U?`Pyramid allowed (${N.toFixed(1)} lots open)`:`${N.toFixed(1)} lots open`:"0 lots"),!g)return q(`Position already open on ${e}`,"side-open");const S=r.reEntryCountForSide??0,B=r.lastExitAtForSide??0,A=n.reEntryEnabled===!0;if(M("reentry-setting","Re-entry",!0,A?"ON":"OFF (first entry only)"),A){if(M("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||S<n.reEntryMaxPerSide,`${S}/${n.reEntryMaxPerSide}`),n.reEntryMaxPerSide>0&&S>=n.reEntryMaxPerSide)return q(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryDelaySec>0&&B>0){const T=j-B,H=n.reEntryDelaySec*1e3,ie=T>=H;if(M("reentry-delay","Re-entry delay",ie,ie?`${n.reEntryDelaySec}s`:`${Math.ceil((H-T)/1e3)}s left`),!ie)return q(`Re-entry delay active: ${Math.ceil((H-T)/1e3)}s`,"reentry-delay")}}else{const T=S===0;if(M("reentry-first","First entry only",T,`${S}/1`),!T)return q(`Re-entry disabled for ${e}`,"reentry-first")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return M("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),q(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(M("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const T=r.lastTradePnl>-n.perTradeMaxLoss;if(M("per-trade-loss","Per-trade max loss",T,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!T)return q("Last trade breached per-trade max loss","per-trade-loss")}else M("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const T=j-r.lastTradeTime,H=T>=n.minGapMs;if(M("min-gap","Minimum gap between entries",H,H?`${T}ms`:`${n.minGapMs-T}ms left`),T<n.minGapMs)return q(`Min gap: ${Math.ceil((n.minGapMs-T)/1e3)}s remaining`,"min-gap")}else M("min-gap","Minimum gap between entries",!0);if(M("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return q(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const T=j-r.lastLossTime,H=n.cooldownAfterLossSec*1e3,ie=T>=H;if(M("loss-cooldown","Cooldown after loss",ie,ie?`${n.cooldownAfterLossSec}s`:`${Math.ceil((H-T)/1e3)}s left`),T<H)return q(`Cooldown: ${Math.ceil((H-T)/1e3)}s after loss`,"loss-cooldown")}else M("loss-cooldown","Cooldown after loss",!0);if(p){const T=Mo(p.totalBid,p.totalAsk,e,n);if(M("depth-imbalance","Depth imbalance",T.allowed,T.reason),!T.allowed)return q(T.reason,"depth-imbalance")}else M("depth-imbalance","Depth imbalance",!0,"No depth data");if(M("spread","Spread gate",d<=n.entryMaxSpread,`${d.toFixed(2)}/${n.entryMaxSpread}`),d>n.entryMaxSpread)return q(`Spread too wide: ${d.toFixed(1)}`,"spread");if(n.volumeInfluenceEnabled){const T=Math.max(.1,n.indexVolumeMinRatio||1),H=Math.max(.1,n.optionVolumeMinRatio||1),ie=Math.max(.1,n.sideVolumeDominanceRatio||1),ve=Math.max(0,n.volumeScoreWeight||0),ge=y?.indexDeltaRatio??null,pe=y?.optionDeltaRatio??null,R=y?.sideDominanceRatio??null,we=y?.indexDelta,ke=y?.optionDelta,ue=y?.oppositeDelta,F=ge==null?!0:ge>=T,be=pe==null?!0:pe>=H,Re=R==null?!0:R>=ie;if(M("volume-index","Index volume flow",F,ge==null?"NA":`${ge.toFixed(2)}x/${T.toFixed(2)}x d:${(we??0).toFixed(0)}`),M("volume-option",`${e} volume flow`,be,pe==null?"NA":`${pe.toFixed(2)}x/${H.toFixed(2)}x d:${(ke??0).toFixed(0)}`),M("volume-dominance",`${e} vs opposite volume`,Re,R==null?"NA":`${Math.min(R,20).toFixed(2)}x/${ie.toFixed(2)}x opp:${(ue??0).toFixed(0)}`),pe!=null&&pe<H*.5)return q(`Very low ${e} volume (${pe.toFixed(2)}x baseline)`,"volume-option");ge!=null&&F&&ve>0&&(x+=.5*ve,m.push(`IdxVol x${Math.min(ge,99).toFixed(2)}`)),pe!=null&&be&&ve>0&&(x+=1*ve,m.push(`${e}Vol x${Math.min(pe,99).toFixed(2)}`)),R!=null&&Re&&ve>0&&(x+=.75*ve,m.push(`${e}>Opp x${Math.min(R,20).toFixed(2)}`))}else M("volume-influence","Volume influence",!0,"OFF");const _=n.noTradeZoneEnabled&&ko(f,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(M("no-trade-zone","No-trade zone filter",!_,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),_)return q(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const K=e==="CE"?"up":"down";M("momentum-direction","Momentum alignment",i.direction===K,`${i.direction} x${i.count}`),i.direction===K&&i.count>=n.entryMomentumCount?(x+=3,m.push(`Momentum ${i.direction} x${i.count}`)):i.direction===K&&(x+=1,m.push(`Weak momentum ${i.direction}`)),M("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(x+=2,m.push(`Velocity ${i.velocity.toFixed(1)}`));let C=!1;a.ema9!==null&&a.ema21!==null&&(C=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,C&&(x+=1,m.push("EMA aligned"))),M("ema","EMA alignment",C,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let w=!1;a.rsi!==null&&(w=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,w&&(x+=1,m.push(`RSI ${a.rsi.toFixed(0)}`))),M("rsi","RSI alignment",w,a.rsi!=null?a.rsi.toFixed(1):"NA");const J=a.macdLine!=null&&Math.abs(a.macdLine)>=.1;let W=!1;J&&(W=e==="CE"&&a.macdLine>0||e==="PE"&&a.macdLine<0,W&&(x+=1,m.push(`MACD ${a.macdLine>0?"+":""}${a.macdLine.toFixed(2)}`))),M("macd","MACD alignment",W,a.macdLine!=null?a.macdLine.toFixed(2):"NA");let ae=!1;n.indexBiasEnabled&&(ae=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",ae&&(x+=1,m.push(`Index ${o.direction}`))),M("index-bias","Index bias alignment",n.indexBiasEnabled?ae:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const ne=Eo(e,c,n);return M("options-context","Options context filter",ne.allowed,ne.reason),ne.allowed?(M("score-gate","Final score gate",x>=z,`${x.toFixed(1)}/${z.toFixed(1)}`),{enter:x>=z,reason:m.join(", ")||"No strong signals",score:x,minScore:Number(z.toFixed(2)),checks:P,spread:d,depthRatio:E,expectedSlippage:Math.max(0,d/2)}):q(ne.reason,"options-context")}function Ro(e,t,n,r,i,a,o){const c=i?n-t:t-n,l=i?r-t:t-r,d=Co(a.trailInitialSL,o,a);if(e==="INITIAL"){const f=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return c>=f?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-d:t+d,newStage:"INITIAL"}}return e==="BREAKEVEN"?l>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?l>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?l>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function Ao(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}const Fo=2;function Rn(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function Oo(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let l=1;l<=t;l++){const d=e[l]-e[l-1];d>0?n+=d:r+=-d}let i=n/t,a=r/t;for(let l=t+1;l<e.length;l++){const d=e[l]-e[l-1],p=d>0?d:0,f=d<0?-d:0;i=(i*(t-1)+p)/t,a=(a*(t-1)+f)/t}if(a===0)return 100;const c=100-100/(1+i/a);return Number.isFinite(c)?c:null}function lr(e){const t=Rn(e,9),n=Rn(e,12),r=Rn(e,21),i=Rn(e,26),a=n!==null&&i!==null?n-i:null;return{ema9:t,ema21:r,supertrend:null,rsi:Oo(e,14),vwap:null,macdLine:a}}function Xn(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function Jn(e,t,n=360){e.push(t),e.length>n&&e.splice(0,e.length-n)}function es(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const n=Math.max(3,t+1),r=e.slice(-n);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const i=[];for(let d=1;d<r.length;d++){const p=r[d]-r[d-1];i.push(p>0&&Number.isFinite(p)?p:0)}if(i.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const a=i[i.length-1],o=i.slice(0,-1),c=o.length>0?o.reduce((d,p)=>d+p,0)/o.length:0,l=c>0?a/c:null;return{latestDelta:a,avgDelta:c>0?c:null,ratio:l}}function Do(e){return e==="TRAIL"||e==="TIGHT"||e==="ACCELERATED"}function $o(e){const n=Fe(F=>F.apiKey),r=Fe(F=>F.setApiKey),i=h(F=>F.underlying),a=h(F=>F.indexExchange),o=h(F=>F.selectedCESymbol),c=h(F=>F.selectedPESymbol),l=h(F=>F.optionExchange),d=h(F=>F.quantity),p=h(F=>F.lotSize),f=h(F=>F.product),y=h(F=>F.tpPoints),b=h(F=>F.slPoints),x=h(F=>F.selectedStrike),m=h(F=>F.paperMode),j=X(F=>F.enabled),P=X(F=>F.mode),E=X(F=>F.config),D=X(F=>F.activePresetId),L=X(F=>F.optionsContext),k=X(F=>F.regime),z=X(F=>F.consecutiveLosses),M=X(F=>F.tradesCount),q=X(F=>F.realizedPnl),ee=X(F=>F.lastTradePnl),V=X(F=>F.lastTradeTime),Z=X(F=>F.tradesThisMinute),$=X(F=>F.lastLossTime),re=X(F=>F.sideEntryCount),I=X(F=>F.sideLastExitAt),N=X(F=>F.replayMode),U=X(F=>F.killSwitch),g=X(F=>F.lockProfitTriggered),S=X(F=>F.setRegime),B=X(F=>F.addGhostSignal),A=X(F=>F.recordTrade),_=X(F=>F.recordAutoEntry),K=X(F=>F.pushDecision),C=X(F=>F.pushExecutionSample),w=xe(F=>F.virtualTPSL),J=xe(F=>F.setVirtualTPSL),W=u.useRef([]),ae=u.useRef([]),ne=u.useRef([]),T=u.useRef([]),H=u.useRef([]),ie=u.useRef([]),ve=u.useRef(0),ge=u.useRef({CE:!1,PE:!1}),pe=u.useRef({CE:"",PE:""}),R=u.useRef({CE:0,PE:0}),we=u.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}}),ke=u.useRef(0),ue=u.useCallback(async()=>{if(n)return n;try{const be=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(be.status==="success"&&be.api_key)return r(be.api_key),be.api_key}catch(F){console.error("[AutoTrade] Failed to fetch API key:",F)}return null},[n,r]);u.useEffect(()=>{if(!j||!e)return;const F=Date.now();if(F-ve.current<100)return;ve.current=F;const be=o,Re=c,Ge=e.get(`${a}:${i}`)?.data?.ltp,De=be?e.get(`${l}:${be}`)?.data?.ltp:void 0,Ue=Re?e.get(`${l}:${Re}`)?.data?.ltp:void 0,Y=Xn(e.get(`${a}:${i}`)?.data?.volume),O=be?Xn(e.get(`${l}:${be}`)?.data?.volume):null,Q=Re?Xn(e.get(`${l}:${Re}`)?.data?.volume):null;Ge&&(W.current.push(Ge),W.current.length>300&&(W.current=W.current.slice(-300))),De&&(ae.current.push(De),ae.current.length>300&&(ae.current=ae.current.slice(-300))),Ue&&(ne.current.push(Ue),ne.current.length>300&&(ne.current=ne.current.slice(-300))),Y!=null&&Jn(T.current,Y),O!=null&&Jn(H.current,O),Q!=null&&Jn(ie.current,Q);const fe=Math.max(5,Number(E.volumeLookbackTicks)||20),tt=es(T.current,fe),ze=es(H.current,fe),Ae=es(ie.current,fe),_e=D==="expiry",{sensitivity:Se}=rs(new Date,_e),Be=L&&F-L.lastUpdated<=2e4?L:null;for(const se of["CE","PE"]){const je=se==="CE"?be:Re,Te=se==="CE"?De:Ue,Ke=se==="CE"?ae.current:ne.current,nt=Object.values(w).filter(Le=>Le.side===se),We=nt.filter(Le=>Le.managedBy==="auto"),Ve=nt.length>0,it=nt.reduce((Le,Qe)=>Le+Math.max(0,Qe.quantity||0),0),bt=p>0?it/p:0,Et=Number.isFinite(bt)?bt:0,vt=se==="CE"?ze:Ae,St=se==="CE"?Ae:ze,Je=vt.latestDelta!=null&&St.latestDelta!=null?vt.latestDelta/Math.max(1,St.latestDelta):null,Ze={indexDelta:tt.latestDelta,indexDeltaRatio:tt.ratio,optionDelta:vt.latestDelta,optionDeltaRatio:vt.ratio,oppositeDelta:St.latestDelta,sideDominanceRatio:Je};if(!je||!Te||Ke.length<5)continue;let st=0;for(const Le of nt){const Qe=`${Le.exchange}:${Le.symbol}`,Ye=e.get(Qe)?.data?.ltp??(Le.symbol===je?Te:void 0);!Ye||Ye<=0||(st+=Le.action==="BUY"?(Ye-Le.entryPrice)*Le.quantity:(Le.entryPrice-Ye)*Le.quantity)}const He=We.some(Le=>Do(Le.trailStage)),wt=d+Fo,zt=Math.max(0,Math.floor(wt-Et+1e-6)),at=D==="adaptive-scalper"&&Ve&&We.length>0&&He&&st>0&&zt>0,Jt=at?Math.max(1,Math.min(d,zt)):d,_t=No(Ke,E),v=lr(Ke),G=lr(W.current),te=To(G,E),ce=`${l}:${je}`,Pe=e.get(ce)?.data?.bid_price,he=e.get(ce)?.data?.ask_price,Me=Pe&&he?he-Pe:2,me=e.get(ce)?.data?.depth;let de;if(me?.buy?.length&&me?.sell?.length){const Le=me.buy.reduce((Ye,lt)=>Ye+(lt.quantity||0),0),Qe=me.sell.reduce((Ye,lt)=>Ye+(lt.quantity||0),0);Le>0&&Qe>0&&(de={totalBid:Le,totalAsk:Qe})}const Ie={consecutiveLosses:z,tradesCount:M,realizedPnl:q,lastTradeTime:V,tradesThisMinute:Z,lastLossTime:$,requestedLots:at?Et+Jt:d,sideOpen:Ve,openSideLots:Et,allowEntryWithOpenSide:at,lastExitAtForSide:I[se],reEntryCountForSide:re[se],lastTradePnl:ee,killSwitch:U,lockProfitTriggered:g},ye=Io(se,Te,E,Ie,_t,v,te,Be,Se,Me,de,Ke,Ze,k),Ct=(Math.round(ye.score*2)/2).toFixed(1),dt=ye.reason.slice(0,40),It=`${ye.enter}|${ye.blockedBy??""}|${Ct}|${ye.minScore.toFixed(1)}|${dt}`;(It!==pe.current[se]||F-R.current[se]>=5e3)&&(K({timestamp:F,side:se,symbol:je,enter:ye.enter,score:ye.score,minScore:ye.minScore,reason:ye.reason,blockedBy:ye.blockedBy,spread:ye.spread,depthRatio:ye.depthRatio,expectedSlippage:ye.expectedSlippage,checks:ye.checks,regime:k}),pe.current[se]=It,R.current[se]=F);const xt=Ao(se,je,x??0,Te,ye,k,Be?.pcr);if(xt){const Le=ye.reason.slice(0,40),Qe=`${je}|${Math.round(ye.score)}|${Le}`,Ye=we.current[se],lt=F-Ye.at;(lt>=4e3||Qe!==Ye.sig&&lt>=2e3)&&(B(xt),we.current[se]={at:F,sig:Qe},Ce.message(`Signal ${se} ${je.slice(-12)}`,{description:`${ye.score.toFixed(1)} / ${ye.minScore.toFixed(1)} | ${ye.reason}`}))}if(P==="execute"&&!N&&ye.enter&&!ge.current[se]){ge.current[se]=!0;const Le="BUY",Qe=Jt*p;(async()=>{const lt=()=>{const ht=X.getState();return ht.enabled&&ht.mode==="execute"&&!ht.replayMode&&!ht.killSwitch};try{if(!lt()){C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:ye.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}const ht=m?null:await ue();if(!m&&!ht){C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:ye.expectedSlippage,status:"rejected",reason:"Missing API key"}),Date.now()-ke.current>5e3&&(ke.current=Date.now(),Ce.error("Auto execute blocked: API key missing"));return}let Un=null;if(!m&&ht){const Xr={apikey:ht,strategy:"Scalping-Auto",exchange:l,symbol:je,action:Le,quantity:Qe,pricetype:"MARKET",product:f,price:0,trigger_price:0,disclosed_quantity:0},gs=await Ee.placeOrder(Xr);if(gs.status!=="success"){C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:ye.expectedSlippage,status:"rejected",reason:"Order rejected"});return}Un=Zt(gs),console.log(`[AutoTrade] ${Le} ${je} id=${Un??"n/a"} score=${ye.score}`)}else console.log(`[AutoTrade Paper] ${Le} ${se} ${je} score=${ye.score}`);if(!lt()){C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:ye.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const Pn=m?await $t({symbol:je,exchange:l,preferredPrice:Te,apiKey:null}):await Xt({symbol:je,exchange:l,orderId:Un,preferredPrice:Te,apiKey:ht}),Hr=Math.max(2,Number(E.trailLockTrigger)||8),Yr=Math.max(2,Number(E.trailInitialSL)||5),Zr=y>0?y:Hr,Qr=b>0?b:Yr;Pn>0&&J(Nt({symbol:je,exchange:l,side:se,action:Le,entryPrice:Pn,quantity:Qe,tpPoints:Zr,slPoints:Qr,managedBy:"auto",autoEntryScore:ye.score,autoEntryReason:ye.reason})),A(0),_(se),C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:Math.max(0,Math.abs((Pn>0?Pn:Te)-Te)),status:"filled",reason:ye.reason}),E.telegramAlertsEntry&&xs.sendBroadcast({message:`[AUTO ENTRY] ${se} ${je} qty=${Qe} score=${ye.score.toFixed(1)} reason=${ye.reason}`}).catch(()=>{})}catch(ht){C({timestamp:Date.now(),side:se,symbol:je,spread:ye.spread,expectedSlippage:ye.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",ht)}finally{ge.current[se]=!1}})()}}const le=W.current.length>=E.regimeDetectionPeriod?W.current:ae.current;if(le.length>=E.regimeDetectionPeriod){const se=le.slice(-E.regimeDetectionPeriod).map((Te,Ke,nt)=>({high:Math.max(Te,nt[Math.max(0,Ke-1)]??Te),low:Math.min(Te,nt[Math.max(0,Ke-1)]??Te),close:Te})),je=wo(se,E);je!==k&&S(je)}},[j,e,P,E,D,o,c,L,k,z,M,q,V,Z,$,ee,re,I,N,U,g,ue,l,d,p,f,y,b,m,x,B,A,_,K,C,S,w,J,i,a])}const zo=3e3;function _o(e){const t=Fe($=>$.apiKey),n=Fe($=>$.setApiKey),r=h($=>$.paperMode),i=h($=>$.product),a=h($=>$.trailDistancePoints),o=h($=>$.addSessionPnl),c=h($=>$.incrementTradeCount),l=X($=>$.config),d=X($=>$.activePresetId),p=X($=>$.optionsContext),f=X($=>$.recordAutoExit),y=X($=>$.recordTradeOutcome),b=X($=>$.pushExecutionSample),x=xe($=>$.virtualTPSL),m=xe($=>$.triggerOrders),j=xe($=>$.removeTriggerOrder),P=xe($=>$.setVirtualTPSL),E=xe($=>$.removeVirtualTPSL),D=u.useRef(t),L=u.useRef(r),k=u.useRef(i);u.useEffect(()=>{D.current=t},[t]),u.useEffect(()=>{L.current=r},[r]),u.useEffect(()=>{k.current=i},[i]);const z=u.useRef(new Set),M=u.useRef(!1),q=u.useRef(""),ee=u.useCallback(async()=>{if(D.current)return D.current;try{const re=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(re.status==="success"&&re.api_key)return D.current=re.api_key,n(re.api_key),re.api_key}catch($){console.error("[Scalping] Failed to fetch API key:",$)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[n]),V=u.useCallback(async($,re,I,N,U)=>{const g=N==="BUY"?"SELL":"BUY";if(L.current)return console.log(`[Paper TP/SL] ${U}: ${g} ${$} qty=${I}`),!0;const S=await ee();if(!S)return!1;const B={apikey:S,strategy:"Scalping",exchange:re,symbol:$,action:g,quantity:I,pricetype:"MARKET",product:k.current,price:0,trigger_price:0,disclosed_quantity:0};try{const A=await Ee.placeOrder(B);if(A.status==="success"){const _=Zt(A);return console.log(`[Scalping TP/SL] ${U}: ${g} ${$} id=${_??"n/a"}`),!0}}catch(A){console.error(`[Scalping TP/SL] ${U} order failed:`,A)}try{if((await Ee.closePosition($,re,k.current)).status==="success")return console.log(`[Scalping TP/SL] ${U}: closePosition fallback ${$}`),!0}catch(A){console.error(`[Scalping TP/SL] ${U} closePosition fallback failed:`,A)}return!1},[ee]),Z=u.useCallback(async($,re,I,N)=>{if(L.current)return console.log(`[Paper Trigger] Entry: ${N} ${$} qty=${I}`),{ok:!0,orderId:null};const U=await ee();if(!U)return{ok:!1,orderId:null};const g={apikey:U,strategy:"Scalping",exchange:re,symbol:$,action:N,quantity:I,pricetype:"MARKET",product:k.current,price:0,trigger_price:0,disclosed_quantity:0};try{const S=await Ee.placeOrder(g);if(S.status==="success"){const B=Zt(S);return console.log(`[Scalping Trigger] Entry: ${N} ${$} id=${B??"n/a"}`),{ok:!0,orderId:B}}}catch(S){console.error("[Scalping Trigger] Entry failed:",S)}return{ok:!1,orderId:null}},[ee]);u.useEffect(()=>{if(!e)return;const $=(S,B,A)=>{z.current.add(S.id);const K=S.action==="BUY"?(B-S.entryPrice)*S.quantity:(S.entryPrice-B)*S.quantity;V(S.symbol,S.exchange,S.quantity,S.action,`${A} at ${B}`).then(C=>{C&&(E(S.id),o(K),c(),S.managedBy==="auto"&&(f(S.side,K),y(K),b({timestamp:Date.now(),side:S.side,symbol:S.symbol,spread:0,expectedSlippage:0,status:"exited",reason:A}),l.telegramAlertsExit&&xs.sendBroadcast({message:`[AUTO EXIT] ${S.side} ${S.symbol} pnl=${K.toFixed(0)} reason=${A}`}).catch(()=>{}))),z.current.delete(S.id)})};for(const S of Object.values(x)){const B=`${S.exchange}:${S.symbol}`,_=(e.get(B)??e.get(S.symbol))?.data?.ltp;if(!_||z.current.has(S.id))continue;const K=S.action==="BUY",C=K?(_-S.entryPrice)*S.quantity:(S.entryPrice-_)*S.quantity;if(S.managedBy==="auto"){if(l.perTradeMaxLoss>0&&C<=-l.perTradeMaxLoss){$(S,_,`Per-trade max loss ${l.perTradeMaxLoss}`);continue}if(Math.max(0,Date.now()-(S.createdAt||0))>=zo){const J=d==="adaptive-scalper"?{...l,ivSpikeExitEnabled:!1}:l,W=Lo(S.side,p,J);if(W.exit){$(S,_,`Options early-exit: ${W.reason}`);continue}}}if(S.tpPrice!==null&&(K?_>=S.tpPrice:_<=S.tpPrice)){$(S,_,"TP hit");continue}S.slPrice!==null&&(K?_<=S.slPrice:_>=S.slPrice)&&$(S,_,"SL hit")}for(const S of Object.values(m)){const B=`${S.exchange}:${S.symbol}`,_=(e.get(B)??e.get(S.symbol))?.data?.ltp;if(!_||z.current.has(S.id))continue;(S.direction==="above"?_>=S.triggerPrice:_<=S.triggerPrice)&&(z.current.add(S.id),Z(S.symbol,S.exchange,S.quantity,S.action).then(async({ok:C,orderId:w})=>{try{if(C&&(j(S.id),c(),_>0)){const J=D.current,W=L.current?_:await Xt({symbol:S.symbol,exchange:S.exchange,orderId:w,preferredPrice:_,apiKey:J});W>0&&P(Nt({symbol:S.symbol,exchange:S.exchange,side:S.side,action:S.action,entryPrice:W,quantity:S.quantity,tpPoints:S.tpPoints,slPoints:S.slPoints,trailDistancePoints:S.trailDistancePoints??a,managedBy:"trigger"}))}}finally{z.current.delete(S.id)}}))}const re=new Date,I=(re.getUTCHours()*60+re.getUTCMinutes()+330)%1440,N=new Date(re.getTime()+330*60*1e3).toISOString().slice(0,10);q.current!==N&&(q.current=N,M.current=!1);const U=d==="expiry"?885:915,g=Object.keys(x).length>0;if(!M.current&&I>=U&&g){M.current=!0;for(const S of Object.values(x))if(!z.current.has(S.id)){const B=`${S.exchange}:${S.symbol}`,A=e.get(B)?.data?.ltp??e.get(S.symbol)?.data?.ltp??S.entryPrice;$(S,A,"Auto square-off before market close")}}},[e,x,m,V,Z,j,P,E,o,c,a,l,d,p,f,y,b])}const Bo=2,Ot=.05;function is(e){return Math.round(e/Ot)*Ot}function Vo(e){return e.slPrice==null?!1:e.managedBy==="auto"||e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"}function qo(e,t){return e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"?!0:e.managedBy==="auto"&&t==="adaptive-scalper"}function cr(e,t){const n={slPrice:t};if(e.tpPrice==null||e.slPrice==null)return n;const r=t-e.slPrice;if(Math.abs(r)<Ot)return n;const i=is(e.tpPrice+r),o=e.action==="BUY"?Math.max(e.tpPrice,i):Math.min(e.tpPrice,i);return Math.abs(o-e.tpPrice)>=Ot&&(n.tpPrice=o),n}function Ko(){const e=X(m=>m.config),t=X(m=>m.activePresetId),n=X(m=>m.optionsContext),r=X(m=>m.setTrailStage),i=X(m=>m.setHighSinceEntry),a=xe(m=>m.virtualTPSL),o=xe(m=>m.updateVirtualTPSL),c=u.useRef(e),l=u.useRef(t),d=u.useRef(n),p=u.useRef({}),f=u.useRef({}),y=u.useRef({}),b=u.useRef({});u.useEffect(()=>{c.current=e},[e]),u.useEffect(()=>{l.current=t},[t]),u.useEffect(()=>{d.current=n},[n]);const x=u.useMemo(()=>Object.values(a).filter(m=>Vo(m)),[a]);u.useEffect(()=>{const m=Mt.getInstance(),j=new Set(x.map(P=>P.id));for(const[P,E]of Object.entries(b.current))j.has(P)||(E(),delete b.current[P],delete p.current[P],delete f.current[P],delete y.current[P]);for(const P of x)b.current[P.id]||(p.current[P.id]=P.trailStage??"INITIAL",f.current[P.id]=P.entryPrice,y.current[P.id]=P.slPrice??P.entryPrice,b.current[P.id]=m.subscribe(P.symbol,P.exchange,"LTP",E=>{const D=E.data.ltp;if(!D||D<=0)return;const L=xe.getState().virtualTPSL[P.id];if(!L||L.slPrice==null)return;const k=L.managedBy==="auto",z=L.action==="BUY",M=f.current[P.id]??L.entryPrice,q=z?Math.max(M,D):Math.min(M,D);if(q!==M&&(f.current[P.id]=q,k&&i(q)),qo(L,l.current)){if(!(z?D>L.entryPrice:D<L.entryPrice))return;p.current[P.id]!=="TRAIL"&&(p.current[P.id]="TRAIL",k&&r("TRAIL"),o(P.id,{trailStage:"TRAIL"}));const S=typeof L.trailDistancePoints=="number"&&L.trailDistancePoints>0?L.trailDistancePoints:Bo,B=z?D-S:D+S,A=is(B),_=L.slPrice,K=y.current[P.id],C=z?Math.max(_??A,A):Math.min(_??A,A),w=_==null||Math.abs(C-_)>=Ot,J=K==null||Math.abs(C-K)>=Ot;w&&J&&(y.current[P.id]=C,o(P.id,cr(L,C)));return}const ee=p.current[P.id]??"INITIAL",V=Ro(ee,L.entryPrice,D,q,z,c.current,d.current);V.newStage!==ee&&(p.current[P.id]=V.newStage,k&&r(V.newStage),o(P.id,{trailStage:V.newStage}));const Z=is(V.newSL),$=L.slPrice,re=y.current[P.id],I=z?Math.max($??Z,Z):Math.min($??Z,Z),N=$==null||Math.abs(I-$)>=Ot,U=re==null||Math.abs(I-re)>=Ot;N&&U&&(y.current[P.id]=I,o(P.id,cr(L,I)))}));return()=>{}},[x,i,r,o]),u.useEffect(()=>()=>{for(const m of Object.values(b.current))m();b.current={},p.current={},f.current={},y.current={}},[])}const Uo=1e3,Go=1500,Wo=3e3;function hs(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Dt(e){return hs(e)??0}function Ho(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Yo(e){const t=hs(e.pnl);if(t!==null)return t;const n=Dt(e.ltp),r=Dt(e.average_price),i=Math.abs(Dt(e.quantity));return(Dt(e.quantity)>0?n-r:r-n)*i}function Zo(){const e=Fe(k=>k.apiKey),t=Fe(k=>k.setApiKey),n=Kt(k=>k.unifiedMode),r=Kt(k=>k.executionBroker),[i,a]=u.useState([]),[o,c]=u.useState(!1),l=u.useRef(!1),d=u.useCallback(async()=>{if(e)return e;try{const z=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(z.status==="success"&&z.api_key)return t(z.api_key),z.api_key}catch{}return null},[e,t]),p=u.useCallback(async()=>{if(l.current)return;l.current=!0;const k=await d();if(!k){c(!1),l.current=!1;return}c(!0);try{const z=await Ee.getPositions(k);z.status==="success"&&z.data&&a(Array.isArray(z.data)?z.data:[])}catch{}finally{c(!1),l.current=!1}},[d]),f=u.useMemo(()=>n?r==="dhan"?Wo:Go:Uo,[n,r]);u.useEffect(()=>{p();const k=setInterval(p,f);return()=>clearInterval(k)},[p,f]);const{data:y,isLive:b,isPaused:x}=ai(i,{enabled:!n&&i.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),m=u.useMemo(()=>n?i:y,[n,i,y]),j=u.useMemo(()=>m.flatMap(k=>{const z=Ho(k.symbol);if(!z)return[];const M=Dt(k.quantity),q=Math.abs(M);if(q===0)return[];const ee=Dt(k.ltp),V=Dt(k.average_price),Z=M>0,$=Z?ee-V:V-ee,I=hs(k.pnl)??$*q;return[{symbol:k.symbol,exchange:k.exchange,side:z,action:Z?"BUY":"SELL",quantity:q,avgPrice:V,ltp:ee,pnl:I,pnlPoints:$,product:k.product}]}),[m]),P=u.useMemo(()=>i.some(k=>Dt(k.quantity)!==0),[i]),E=u.useMemo(()=>m.reduce((k,z)=>k+Yo(z),0),[m]),D=u.useCallback(k=>j.find(z=>z.side===k),[j]),L=u.useMemo(()=>i.map(k=>({symbol:k.symbol,exchange:k.exchange})),[i]);return{positions:j,totalPnl:E,isLive:!n&&b&&P,isPaused:!n&&x,isLoading:o,refetch:p,getPositionForSide:D,positionSymbols:L}}const Qo=1e3,Xo=100;function An(e){const t=Number(e);return Number.isFinite(t)&&t>0?t:null}function Jo(e){const t=String(e??"").trim().toUpperCase();return t==="BUY"||t==="SELL"?t:null}function el(e,t){const n=String(e??"").trim().toUpperCase();return n==="CE"||n==="PE"?n:t.toUpperCase().endsWith("PE")?"PE":"CE"}function tl(){const e=Fe(l=>l.apiKey),t=Fe(l=>l.setApiKey),n=h(l=>l.tpPoints),r=h(l=>l.slPoints),i=xe(l=>l.setVirtualTPSL),a=u.useRef(!1),o=u.useCallback(async()=>{if(e)return e;try{const d=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(d.status==="success"&&d.api_key)return t(d.api_key),d.api_key}catch{}return null},[e,t]),c=u.useCallback(async(l,d)=>{const p=Number(l.id);if(!Number.isInteger(p)||p<=0)return!1;const f=String(l.symbol??"").trim().toUpperCase(),y=String(l.exchange??"NFO").trim().toUpperCase(),b=Jo(l.action),x=Math.trunc(An(l.quantity)??0);if(!f||!b||x<=0)return!1;const m=`flow-${p}`;if(xe.getState().virtualTPSL[m])return!0;const P=el(l.side,f),E=An(l.tp_points)??n,D=An(l.sl_points)??r,L=An(l.entry_price),k=String(l.order_id??"").trim()||null,z=await Xt({symbol:f,exchange:y,orderId:k,preferredPrice:L,fallbackPrice:L,apiKey:d});if(!(z>0))return!1;const M=Number(l.created_at);return i(Nt({id:m,symbol:f,exchange:y,side:P,action:b,entryPrice:z,quantity:x,tpPoints:E,slPoints:D,managedBy:"flow",createdAt:Number.isFinite(M)&&M>0?M:Date.now()})),!0},[n,r,i]);u.useEffect(()=>{let l=!0,d=null;async function p(){if(!l||a.current){f();return}a.current=!0;try{const y=await o();if(!y)return;const b=await Ee.getScalpingBridgePending(y,Xo),x=Array.isArray(b.data?.entries)?b.data.entries:[];if(!x.length)return;const m=[];for(const j of x)try{await c(j,y)&&m.push(Number(j.id))}catch{}m.length&&await Ee.ackScalpingBridgeEntries(y,m)}catch{}finally{a.current=!1,f()}}function f(){l&&(d=setTimeout(p,Qo))}return p(),()=>{l=!1,d&&clearTimeout(d)}},[c,o])}const nl=15e3;function At(e,t){if(e&&typeof e=="object"){const n=e.message;if(typeof n=="string"&&n.trim().length>0)return n.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function vl(){const[e,t]=u.useState(!1),[n,r]=u.useState(!1),i=u.useRef(!1),a=u.useCallback(()=>t(T=>!T),[]),o=u.useCallback(()=>t(!1),[]),c=u.useCallback(()=>r(T=>!T),[]),l=h(T=>T.paperMode),d=h(T=>T.underlying),p=h(T=>T.indexExchange),f=h(T=>T.optionExchange),y=h(T=>T.product),b=h(T=>T.quantity),x=h(T=>T.lotSize),m=h(T=>T.tpPoints),j=h(T=>T.slPoints),P=h(T=>T.trailDistancePoints),E=h(T=>T.incrementTradeCount),D=h(T=>T.setLimitPrice),L=h(T=>T.setPendingEntryAction),k=h(T=>T.pendingLimitPlacement),z=h(T=>T.clearPendingLimitPlacement),M=h(T=>T.selectedCESymbol),q=h(T=>T.selectedPESymbol),ee=xe(T=>T.virtualTPSL),V=xe(T=>T.triggerOrders),Z=xe(T=>T.clearAll),$=xe(T=>T.clearForSymbol),re=xe(T=>T.clearTriggerOrders),I=xe(T=>T.removeVirtualTPSL),N=xe(T=>T.updateVirtualTPSL),U=xe(T=>T.setVirtualTPSL),g=X(T=>T.config.imbalanceFilterEnabled),S=X(T=>T.updateRiskState),B=Fe(T=>T.apiKey),A=Fe(T=>T.setApiKey),{positions:_,totalPnl:K,isLive:C}=Zo();u.useEffect(()=>{B||fetch("/api/websocket/apikey",{credentials:"include"}).then(T=>T.json()).then(T=>{T.status==="success"&&T.api_key&&A(T.api_key)}).catch(()=>{})},[B,A]),u.useEffect(()=>{re()},[re]);const w=u.useCallback(async(T,H)=>{if(l){console.log(`[Paper] Close ${T} ${H}`),$(H),D(null),L(null),z();return}try{const ie=_.find(ge=>ge.symbol===H&&ge.side===T),ve=await Ee.closePosition(H,f,y,{knownQuantity:ie?.quantity,knownAction:ie?.action});if(ve.status!=="success"&&ve.status!=="info"){console.error("[Scalping] Close rejected:",ve),Ce.error(At(ve,"Close position rejected"));return}console.log(`[Scalping] Closed ${T} ${H}`),$(H),D(null),L(null),z()}catch(ie){console.error("[Scalping] Close failed:",ie),Ce.error(At(ie,"Close position failed"))}},[l,f,y,_,$,D,L,z]),J=u.useCallback(async()=>{if(l){console.log("[Paper] Close all positions"),Z(),D(null),L(null),z();return}const T=Ee.cancelAllOrders().catch(H=>(console.warn("[Scalping] Cancel all orders failed:",H),{status:"error",message:At(H,"Cancel all orders failed")}));try{const H=await Ee.closeAllPositions({verify:!1}),ie=await T;if(H.status!=="success"&&H.status!=="info"){console.error("[Scalping] Close all rejected:",H),Ce.error(At(H,"Close all positions rejected"));return}ie.status==="error"&&console.warn("[Scalping] Close-all completed but cancel-all-orders failed:",ie),console.log("[Scalping] Closed all positions"),Z(),D(null),L(null),z()}catch(H){console.error("[Scalping] Close all failed:",H),Ce.error(At(H,"Close all positions failed"))}},[l,Z,D,L,z]),W=u.useCallback(async(T,H)=>{if(l){console.log(`[Paper] Reverse ${T} ${H}`);return}if(B)try{const ie=_.find(pe=>pe.symbol===H&&pe.side===T),ve=await Ee.closePosition(H,f,y,{knownQuantity:ie?.quantity,knownAction:ie?.action});if(ve.status!=="success"&&ve.status!=="info"){console.error("[Scalping] Reversal close rejected:",ve),Ce.error(At(ve,"Reversal close failed"));return}const ge=await Ee.placeOrder({apikey:B,strategy:"Scalping",exchange:f,symbol:H,action:"SELL",quantity:b*x,pricetype:"MARKET",product:y,price:0,trigger_price:0,disclosed_quantity:0});if(ge.status!=="success"){console.error("[Scalping] Reversal open rejected:",ge),Ce.error(At(ge,"Reversal open failed"));return}console.log(`[Scalping] Reversed ${T} ${H}`)}catch(ie){console.error("[Scalping] Reversal failed:",ie),Ce.error(At(ie,"Reversal failed"))}},[l,B,f,y,b,x,_]);xo({onToggleHelp:a,onClose:w,onCloseAll:J,onReversal:W}),jo();const ae=u.useMemo(()=>{const T=[];d&&p&&T.push({symbol:d,exchange:p}),M&&T.push({symbol:M,exchange:f}),q&&T.push({symbol:q,exchange:f});for(const ie of Object.values(ee))T.push({symbol:ie.symbol,exchange:ie.exchange});for(const ie of Object.values(V))T.push({symbol:ie.symbol,exchange:ie.exchange});const H=new Map;for(const ie of T)H.set(`${ie.exchange}:${ie.symbol}`,ie);return Array.from(H.values())},[d,p,M,q,f,ee,V]),{data:ne}=Fn({symbols:ae,mode:g?"Quote":"LTP",enabled:ae.length>0});return tl(),u.useEffect(()=>{S(K)},[K,S]),u.useEffect(()=>{if(l)return;const T=new Map(_.map(ue=>[ue.symbol,ue])),H=Object.values(ee);for(const ue of H){const F=T.get(ue.symbol);if(!F){const be=typeof ue.createdAt=="number"?ue.createdAt:0;if((be>0?Date.now()-be:Number.POSITIVE_INFINITY)<nl)continue;I(ue.id);continue}(F.side!==ue.side||F.action!==ue.action||ue.quantity<=0)&&I(ue.id)}const ie=Object.values(xe.getState().virtualTPSL),ve=new Map;for(const ue of ie){const F=ve.get(ue.symbol)??[];F.push(ue),ve.set(ue.symbol,F)}for(const[ue,F]of ve.entries()){const be=T.get(ue);if(!be)continue;const Re=Math.max(0,be.quantity);let De=F.reduce((Y,O)=>Y+Math.max(0,O.quantity),0)-Re;if(De<=0)continue;const Ue=[...F].sort((Y,O)=>O.createdAt-Y.createdAt);for(const Y of Ue){if(De<=0)break;const O=Math.max(0,Y.quantity);if(O<=De+1e-6){I(Y.id),De-=O;continue}const Q=Math.max(0,Number((O-De).toFixed(2)));N(Y.id,{quantity:Q}),De=0}}if(!k||i.current)return;const ge=_.filter(ue=>ue.symbol===k.symbol);if(ge.length===0)return;const pe=ge.find(ue=>ue.side===k.side&&ue.action===k.action),R=pe??ge[0],we=pe?k.side:R.side,ke=pe?k.action:R.action;i.current=!0,(async()=>{try{const ue=R.avgPrice>0?R.avgPrice:R.ltp,F=k.entryPrice>0?k.entryPrice:ue,be=k.orderId??k.orderIds?.[0]??k.splitLegs?.[0]?.orderId??null,Re=await Xt({symbol:k.symbol,exchange:R.exchange,orderId:be,preferredPrice:F,fallbackPrice:ue,apiKey:B});if(Re<=0){console.warn("[Scalping] Pending LIMIT fill attach skipped: no valid entry price",{symbol:k.symbol,orderId:be,pendingEntry:k.entryPrice,fallbackPrice:ue});return}const Ge=Math.max(0,R.quantity),De=Math.max(0,k.quantity),Ue=Ge>0?Math.max(1,Math.min(De,Ge)):De;if(Ue<=0)return;U(Nt({symbol:k.symbol,exchange:R.exchange,side:we,action:ke,entryPrice:Re,quantity:Ue,tpPoints:k.tpPoints>0?k.tpPoints:m,slPoints:k.slPoints>0?k.slPoints:j,trailDistancePoints:k.trailDistancePoints>0?k.trailDistancePoints:P,managedBy:"manual"})),console.info("[Scalping] Pending LIMIT fill attached to virtual TP/SL",{symbol:k.symbol,side:we,action:ke,quantity:Ue,entryPrice:Re,orderId:be}),E(),z(),D(null),L(null)}finally{i.current=!1}})()},[l,_,ee,k,B,I,N,U,m,j,P,E,z,D,L]),$o(ne),Ko(),_o(ne),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(qi,{liveOpenPnl:K,isLivePnl:C,chartFocusMode:n,onToggleChartFocusMode:c}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:n?s.jsx("div",{className:"h-full w-full min-w-0",children:s.jsx(Ws,{})}):s.jsxs(ns,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(Ut,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(Gi,{})}),s.jsx($n,{withHandle:!0,className:"bg-border/70"}),s.jsx(Ut,{defaultSize:"50%",minSize:"30%",children:s.jsx(Ws,{})}),s.jsx($n,{withHandle:!0,className:"bg-border/70"}),s.jsx(Ut,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx(po,{liveOpenPnl:K,isLivePnl:C})})]})}),s.jsx(Wi,{positions:_,totalPnl:K,isLivePnl:C}),s.jsx(mo,{open:e,onClose:o})]})}export{vl as default};
