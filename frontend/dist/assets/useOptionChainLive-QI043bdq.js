import{r}from"./vendor-react-BsSNOS8Q.js";import{m as j,p as q,k as J,g as ue}from"./index-DXDxuD1W.js";import{a as ie}from"./useMarketStatus-CxSKdq-S.js";const ce={getOptionChain:async(n,t,i,s,m)=>j()?q("feed","optionchain",{apikey:n,underlying:t,exchange:i,expiry_date:s,strike_count:m??20}):(await J.post("/optionchain",{apikey:n,underlying:t,exchange:i,expiry_date:s,strike_count:m??20})).data,getExpiries:async(n,t,i,s="options")=>j()?q("feed","expiry",{apikey:n,symbol:t,exchange:i,instrumenttype:s}):(await J.post("/expiry",{apikey:n,symbol:t,exchange:i,instrumenttype:s})).data};function de(n,t,i,s,m,L={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:C,refreshInterval:S=3e4,pauseWhenHidden:_=!0}=L,{isVisible:M}=ue(),D=S>0,[U,l]=r.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),a=r.useRef(null),p=r.useRef(null),c=C&&(!_||M),h=r.useCallback(async()=>{if(!(!n||!t||!i||!s)&&!p.current){l(u=>({...u,isLoading:!0}));try{const u=new AbortController;p.current=u;const v=s.replace(/-/g,"").toUpperCase(),d=await ce.getOptionChain(n,t,i,v,m);d.status==="success"?l(w=>({...w,data:d,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):l(w=>({...w,isLoading:!1,error:d.message||"Failed to fetch option chain"}))}catch(u){u instanceof Error&&(u.name==="AbortError"?p.current===null&&l(v=>({...v,isLoading:!1})):l(v=>({...v,isLoading:!1,error:u.message||"Connection error",isConnected:!1})))}finally{p.current=null}}},[n,t,i,s,m]);r.useEffect(()=>{if(!c){a.current&&(clearInterval(a.current),a.current=null),l(u=>({...u,isPaused:!!C}));return}return l(u=>({...u,isConnected:!0,isPaused:!1})),h(),D&&(a.current=setInterval(h,S)),()=>{a.current&&(clearInterval(a.current),a.current=null),p.current&&(p.current.abort(),p.current=null)}},[c,h,S,C,D]);const A=r.useCallback(()=>{h()},[h]);return{...U,refetch:A}}const fe=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),pe=new Set(["SENSEX","BANKEX","SENSEX50"]);function Q(n,t){return fe.has(n)?"NSE_INDEX":pe.has(n)?"BSE_INDEX":t==="BFO"?"BSE":"NSE"}function Z(n,t){if(n!=null)return!t||t<=0?n:Number((Math.round(n/t)*t).toFixed(2))}const me=100;function Se(n,t,i,s,m,L,C={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:S,oiRefreshInterval:_=3e4,wsMode:M="LTP",pauseWhenHidden:D=!0}=C,[U,l]=r.useState(null),[a,p]=r.useState(null),{data:c,isLoading:h,isConnected:A,isPaused:u,error:v,lastUpdate:d,refetch:w}=de(n,t,i,m,L,{enabled:S,refreshInterval:_,pauseWhenHidden:D}),R=r.useMemo(()=>{const f=[],b=Q(t,s);if(f.push({symbol:t,exchange:b}),c?.chain)for(const N of c.chain)N.ce?.symbol&&f.push({symbol:N.ce.symbol,exchange:s}),N.pe?.symbol&&f.push({symbol:N.pe.symbol,exchange:s});return f},[c?.chain,s,t]),{data:T,isConnected:k,isAuthenticated:ee,isPaused:te}=ie({symbols:R,mode:M,enabled:S&&R.length>0}),H=r.useRef(0),I=r.useRef(null),x=r.useRef(T),z=r.useRef(c);x.current=T,z.current=c;const K=r.useMemo(()=>()=>{I.current=null;const f=z.current,b=x.current;if(!f){l(null);return}if(b.size===0){l(f);return}const N=f.chain.map(e=>{let P=!1,E=!1,F=e.ce?.ltp,B=e.pe?.ltp,O=e.ce?.volume,W=e.pe?.volume,Y=e.ce?.oi,X=e.pe?.oi;if(e.ce?.symbol){const $=`${s}:${e.ce.symbol}`,o=b.get($)?.data;if(o?.ltp!==void 0){const g=Z(o.ltp,e.ce.tick_size);g!==void 0&&g!==e.ce.ltp&&(F=g,P=!0)}o?.volume!==void 0&&o.volume!==e.ce.volume&&(O=o.volume,P=!0);const y=o?.oi??o?.open_interest;y!==void 0&&y!==e.ce.oi&&(Y=y,P=!0)}if(e.pe?.symbol){const $=`${s}:${e.pe.symbol}`,o=b.get($)?.data;if(o?.ltp!==void 0){const g=Z(o.ltp,e.pe.tick_size);g!==void 0&&g!==e.pe.ltp&&(B=g,E=!0)}o?.volume!==void 0&&o.volume!==e.pe.volume&&(W=o.volume,E=!0);const y=o?.oi??o?.open_interest;y!==void 0&&y!==e.pe.oi&&(X=y,E=!0)}if(!P&&!E)return e;const V={...e};return P&&e.ce&&(V.ce={...e.ce,...F!==void 0?{ltp:F}:{},...O!==void 0?{volume:O}:{},...Y!==void 0?{oi:Y}:{}}),E&&e.pe&&(V.pe={...e.pe,...B!==void 0?{ltp:B}:{},...W!==void 0?{volume:W}:{},...X!==void 0?{oi:X}:{}}),V});let G=!1;for(const[,e]of b)if(e.lastUpdate&&e.lastUpdate>H.current){G=!0,H.current=e.lastUpdate;break}G&&p(new Date);const oe=`${Q(t,s)}:${t}`,ae=b.get(oe)?.data?.ltp??f.underlying_ltp;l({...f,underlying_ltp:ae,chain:N})},[s,t]);r.useEffect(()=>{if(!c){l(null);return}if(T.size===0){l(c);return}return I.current===null&&(I.current=setTimeout(K,me)),()=>{I.current!==null&&(clearTimeout(I.current),I.current=null)}},[c,T,K]);const ne=k&&ee&&R.length>0,se=u||te,re=r.useMemo(()=>!d&&!a?null:d?a&&a>d?a:d:a,[d,a]);return{data:U,isLoading:h,isConnected:A,isStreaming:ne,isPaused:se,error:v,lastUpdate:re,streamingSymbols:R.length,refetch:w}}export{ce as o,Se as u};
