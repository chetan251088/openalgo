import{r as d,j as n}from"./vendor-react-BsSNOS8Q.js";import{c as Ke,d as Ae,z as Zt,e as _e,u as tr,A as nr,C as sr,M as xn,t as Ie,B as Le,w as mt}from"./index-CqJWD5ZF.js";import{b7 as Br}from"./vendor-icons-BJR3KiwM.js";import{u as rr}from"./useQuery-_ljdevuW.js";import{S as sn,a as rn,b as an,c as on,d as Gt}from"./select-6tgRalFV.js";import{o as ir,u as Vr}from"./useOptionChainLive-GyaZ_KRd.js";import{u as S,t as we}from"./trading-QofSYFOO.js";import{q as ar,K as or,W as lr,R as cr,n as wt,h as gt}from"./lightweight-charts.production-fmEoZjtL.js";import{a as pn}from"./useMarketStatus-ySaLBNq7.js";import{I as Tt}from"./input-B6Wx8KAO.js";import{L as ut}from"./label-DK1yFgXx.js";import{S as cn}from"./switch-CsE_NTFL.js";import{a as qr,r as Gr,b as Kr,c as Ur}from"./ai-scalper-BoN7t6ZE.js";import{u as Wr}from"./useLivePrice-UCfIOiFt.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function Oe(e,t="Assertion error"){if(!e)throw Error(t)}function Qt({group:e}){const{orientation:t,panels:s}=e;return s.reduce((r,a)=>(r+=t==="horizontal"?a.element.offsetWidth:a.element.offsetHeight,r),0)}function Un(e,t){return t.sort(e==="horizontal"?Hr:Yr)}function Hr(e,t){const s=e.element.offsetLeft-t.element.offsetLeft;return s!==0?s:e.element.offsetWidth-t.element.offsetWidth}function Yr(e,t){const s=e.element.offsetTop-t.element.offsetTop;return s!==0?s:e.element.offsetHeight-t.element.offsetHeight}function ur(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function dr(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Zr({orientation:e,rects:t,targetRect:s}){const r={x:s.x+s.width/2,y:s.y+s.height/2};let a,i=Number.MAX_VALUE;for(const o of t){const{x:c,y:l}=dr(r,o),u=e==="horizontal"?c:l;u<i&&(i=u,a=o)}return Oe(a,"No rect found"),a}let bn;function Xr(){return bn===void 0&&(typeof matchMedia=="function"?bn=!!matchMedia("(pointer:coarse)").matches:bn=!1),bn}function pr(e){const{element:t,orientation:s,panels:r,separators:a}=e,i=Un(s,Array.from(t.children).filter(ur).map(p=>({element:p}))).map(({element:p})=>p),o=[];let c=!1,l,u=[];for(const p of i)if(p.hasAttribute("data-panel")){const m=r.find(h=>h.element===p);if(m){if(l){const h=l.element.getBoundingClientRect(),g=p.getBoundingClientRect();let x;if(c){const f=s==="horizontal"?new DOMRect(h.right,h.top,0,h.height):new DOMRect(h.left,h.bottom,h.width,0),k=s==="horizontal"?new DOMRect(g.left,g.top,0,g.height):new DOMRect(g.left,g.top,g.width,0);switch(u.length){case 0:{x=[f,k];break}case 1:{const P=u[0],j=Zr({orientation:s,rects:[h,g],targetRect:P.element.getBoundingClientRect()});x=[P,j===h?k:f];break}default:{x=u;break}}}else u.length?x=u:x=[s==="horizontal"?new DOMRect(h.right,g.top,g.left-h.right,g.height):new DOMRect(g.left,h.bottom,g.width,g.top-h.bottom)];for(const f of x){let k="width"in f?f:f.element.getBoundingClientRect();const P=Xr()?37:27;if(k.width<P){const j=P-k.width;k=new DOMRect(k.x-j/2,k.y,k.width+j,k.height)}if(k.height<P){const j=P-k.height;k=new DOMRect(k.x,k.y-j/2,k.width,k.height+j)}o.push({group:e,groupSize:Qt({group:e}),panels:[l,m],separator:"width"in f?void 0:f,rect:k})}}c=!1,l=m,u=[]}}else if(p.hasAttribute("data-separator")){const m=a.find(h=>h.element===p);m?u.push(m):(l=void 0,u=[])}else c=!0;return o}function Qr(e,t){const s=getComputedStyle(e),r=parseFloat(s.fontSize);return t*r}function Jr(e,t){const s=getComputedStyle(e.ownerDocument.body),r=parseFloat(s.fontSize);return t*r}function ei(e){return e/100*window.innerHeight}function ti(e){return e/100*window.innerWidth}function ni(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function vn({groupSize:e,panelElement:t,styleProp:s}){let r;const[a,i]=ni(s);switch(i){case"%":{r=a/100*e;break}case"px":{r=a;break}case"rem":{r=Jr(t,a);break}case"em":{r=Qr(t,a);break}case"vh":{r=ei(a);break}case"vw":{r=ti(a);break}}return r}function ft(e){return parseFloat(e.toFixed(3))}function cs(e){const{panels:t}=e,s=Qt({group:e});return s===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:a,panelConstraints:i}=r;let o=0;if(i.collapsedSize!==void 0){const p=vn({groupSize:s,panelElement:a,styleProp:i.collapsedSize});o=ft(p/s*100)}let c;if(i.defaultSize!==void 0){const p=vn({groupSize:s,panelElement:a,styleProp:i.defaultSize});c=ft(p/s*100)}let l=0;if(i.minSize!==void 0){const p=vn({groupSize:s,panelElement:a,styleProp:i.minSize});l=ft(p/s*100)}let u=100;if(i.maxSize!==void 0){const p=vn({groupSize:s,panelElement:a,styleProp:i.maxSize});u=ft(p/s*100)}return{collapsedSize:o,collapsible:i.collapsible===!0,defaultSize:c,minSize:l,maxSize:u,panelId:r.id}})}class si{#e={};addListener(t,s){const r=this.#e[t];return r===void 0?this.#e[t]=[s]:r.includes(s)||r.push(s),()=>{this.removeListener(t,s)}}emit(t,s){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,s);else{let a=!1,i=null;const o=Array.from(r);for(let c=0;c<o.length;c++){const l=o[c];try{l.call(null,s)}catch(u){i===null&&(a=!0,i=u)}}if(a)throw i}}removeAllListeners(){this.#e={}}removeListener(t,s){const r=this.#e[t];if(r!==void 0){const a=r.indexOf(s);a>=0&&r.splice(a,1)}}}function Qe(e,t,s=0){return Math.abs(ft(e)-ft(t))<=s}let ct={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const At=new si;function at(){return ct}function tt(e){const t=typeof e=="function"?e(ct):e;if(ct===t)return ct;const s=ct;return ct={...ct,...t},t.cursorFlags!==void 0&&At.emit("cursorFlagsChange",ct.cursorFlags),t.interactionState!==void 0&&At.emit("interactionStateChange",ct.interactionState),t.mountedGroups!==void 0&&(ct.mountedGroups.forEach((r,a)=>{r.derivedPanelConstraints.forEach(i=>{if(i.collapsible){const{layout:o}=s.mountedGroups.get(a)??{};if(o){const c=Qe(i.collapsedSize,r.layout[i.panelId]),l=Qe(i.collapsedSize,o[i.panelId]);c&&!l&&(a.inMemoryLastExpandedPanelSizes[i.panelId]=o[i.panelId])}}})}),At.emit("mountedGroupsChange",ct.mountedGroups)),ct}function ri(e,t,s){let r,a={x:1/0,y:1/0};for(const i of t){const o=dr(s,i.rect);switch(e){case"horizontal":{o.x<=a.x&&(r=i,a=o);break}case"vertical":{o.y<=a.y&&(r=i,a=o);break}}}return r?{distance:a,hitRegion:r}:void 0}function ii(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function ai(e,t){if(e===t)throw new Error("Cannot compare node with itself");const s={a:ps(e),b:ps(t)};let r;for(;s.a.at(-1)===s.b.at(-1);)e=s.a.pop(),t=s.b.pop(),r=e;Oe(r,"Stacking order can only be calculated for elements with a common ancestor");const a={a:ds(us(s.a)),b:ds(us(s.b))};if(a.a===a.b){const i=r.childNodes,o={a:s.a.at(-1),b:s.b.at(-1)};let c=i.length;for(;c--;){const l=i[c];if(l===o.a)return 1;if(l===o.b)return-1}}return Math.sign(a.a-a.b)}const oi=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function li(e){const t=getComputedStyle(mr(e)??e).display;return t==="flex"||t==="inline-flex"}function ci(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||li(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||oi.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function us(e){let t=e.length;for(;t--;){const s=e[t];if(Oe(s,"Missing node"),ci(s))return s}return null}function ds(e){return e&&Number(getComputedStyle(e).zIndex)||0}function ps(e){const t=[];for(;e;)t.push(e),e=mr(e);return t}function mr(e){const{parentNode:t}=e;return ii(t)?t.host:t}function ui(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function di({groupElement:e,hitRegion:t,pointerEventTarget:s}){if(!ur(s)||s.contains(e)||e.contains(s))return!0;if(ai(s,e)>0){let r=s;for(;r;){if(r.contains(e))return!0;if(ui(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function Xn(e,t){const s=[];return t.forEach((r,a)=>{if(a.disabled)return;const i=pr(a),o=ri(a.orientation,i,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&di({groupElement:a.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&s.push(o.hitRegion)}),s}function pi(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!=t[s])return!1;return!0}function hn(e,t){return Qe(e,t)?0:e>t?1:-1}function Xt({panelConstraints:e,size:t}){const{collapsedSize:s=0,collapsible:r,maxSize:a=100,minSize:i=0}=e;if(hn(t,i)<0)if(r){const o=(s+i)/2;hn(t,o)<0?t=s:t=i}else t=i;return t=Math.min(a,t),t=ft(t),t}function gn({delta:e,initialLayout:t,panelConstraints:s,pivotIndices:r,prevLayout:a,trigger:i}){if(Qe(e,0))return t;const o=Object.values(t),c=Object.values(a),l=[...o],[u,p]=r;Oe(u!=null,"Invalid first pivot index"),Oe(p!=null,"Invalid second pivot index");let m=0;if(i==="keyboard"){{const x=e<0?p:u,f=s[x];Oe(f,`Panel constraints not found for index ${x}`);const{collapsedSize:k=0,collapsible:P,minSize:j=0}=f;if(P){const w=o[x];if(Oe(w!=null,`Previous layout not found for panel index ${x}`),Qe(w,k)){const M=j-w;hn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}{const x=e<0?u:p,f=s[x];Oe(f,`No panel constraints found for index ${x}`);const{collapsedSize:k=0,collapsible:P,minSize:j=0}=f;if(P){const w=o[x];if(Oe(w!=null,`Previous layout not found for panel index ${x}`),Qe(w,j)){const M=w-k;hn(M,Math.abs(e))>0&&(e=e<0?0-M:M)}}}}{const x=e<0?1:-1;let f=e<0?p:u,k=0;for(;;){const j=o[f];Oe(j!=null,`Previous layout not found for panel index ${f}`);const w=Xt({panelConstraints:s[f],size:100})-j;if(k+=w,f+=x,f<0||f>=s.length)break}const P=Math.min(Math.abs(e),Math.abs(k));e=e<0?0-P:P}{let x=e<0?u:p;for(;x>=0&&x<s.length;){const f=Math.abs(e)-Math.abs(m),k=o[x];Oe(k!=null,`Previous layout not found for panel index ${x}`);const P=k-f,j=Xt({panelConstraints:s[x],size:P});if(!Qe(k,j)&&(m+=k-j,l[x]=j,m.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?x--:x++}}if(pi(c,l))return a;{const x=e<0?p:u,f=o[x];Oe(f!=null,`Previous layout not found for panel index ${x}`);const k=f+m,P=Xt({panelConstraints:s[x],size:k});if(l[x]=P,!Qe(P,k)){let j=k-P,w=e<0?p:u;for(;w>=0&&w<s.length;){const M=l[w];Oe(M!=null,`Previous layout not found for panel index ${w}`);const $=M+j,O=Xt({panelConstraints:s[w],size:$});if(Qe(M,O)||(j-=O-M,l[w]=O),Qe(j,0))break;e>0?w--:w++}}}const h=Object.values(l).reduce((x,f)=>f+x,0);if(!Qe(h,100,.1))return a;const g=Object.keys(a);return l.reduce((x,f,k)=>(x[g[k]]=f,x),{})}function $t(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(t[s]===void 0||hn(e[s],t[s])!==0)return!1;return!0}function Ot({layout:e,panelConstraints:t}){const s=[...Object.values(e)],r=s.reduce((o,c)=>o+c,0);if(s.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${s.map(o=>`${o}%`).join(", ")}`);if(!Qe(r,100)&&s.length>0)for(let o=0;o<t.length;o++){const c=s[o];Oe(c!=null,`No layout data found for index ${o}`);const l=100/r*c;s[o]=l}let a=0;for(let o=0;o<t.length;o++){const c=s[o];Oe(c!=null,`No layout data found for index ${o}`);const l=Xt({panelConstraints:t[o],size:c});c!=l&&(a+=c-l,s[o]=l)}if(!Qe(a,0))for(let o=0;o<t.length;o++){const c=s[o];Oe(c!=null,`No layout data found for index ${o}`);const l=c+a,u=Xt({panelConstraints:t[o],size:l});if(c!==u&&(a-=u-c,s[o]=u,Qe(a,0)))break}const i=Object.keys(e);return s.reduce((o,c,l)=>(o[i[l]]=c,o),{})}function fr({groupId:e,panelId:t}){const s=()=>{const{mountedGroups:c}=at();for(const[l,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:m,separatorToPanels:h}]of c)if(l.id===e)return{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:l,layout:m,separatorToPanels:h};throw Error(`Group ${e} not found`)},r=()=>{const c=s().derivedPanelConstraints.find(l=>l.panelId===t);if(c!==void 0)return c;throw Error(`Panel constraints not found for Panel ${t}`)},a=()=>{const c=s().group.panels.find(l=>l.id===t);if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},i=()=>{const c=s().layout[t];if(c!==void 0)return c;throw Error(`Layout not found for Panel ${t}`)},o=c=>{const l=i();if(c===l)return;const{defaultLayoutDeferred:u,derivedPanelConstraints:p,group:m,layout:h,separatorToPanels:g}=s(),x=m.panels.findIndex(j=>j.id===t),f=x===m.panels.length-1,k=gn({delta:f?l-c:c-l,initialLayout:h,panelConstraints:p,pivotIndices:f?[x-1,x]:[x,x+1],prevLayout:h,trigger:"imperative-api"}),P=Ot({layout:k,panelConstraints:p});$t(h,P)||tt(j=>({mountedGroups:new Map(j.mountedGroups).set(m,{defaultLayoutDeferred:u,derivedPanelConstraints:p,layout:P,separatorToPanels:g})}))};return{collapse:()=>{const{collapsible:c,collapsedSize:l}=r(),{mutableValues:u}=a(),p=i();c&&p!==l&&(u.expandToSize=p,o(l))},expand:()=>{const{collapsible:c,collapsedSize:l,minSize:u}=r(),{mutableValues:p}=a(),m=i();if(c&&m===l){let h=p.expandToSize??u;h===0&&(h=1),o(h)}},getSize:()=>{const{group:c}=s(),l=i(),{element:u}=a(),p=c.orientation==="horizontal"?u.offsetWidth:u.offsetHeight;return{asPercentage:l,inPixels:p}},isCollapsed:()=>{const{collapsible:c,collapsedSize:l}=r(),u=i();return c&&Qe(l,u)},resize:c=>{if(i()!==c){let l;switch(typeof c){case"number":{const{group:u}=s(),p=Qt({group:u});l=ft(c/p*100);break}case"string":{l=parseFloat(c);break}}o(l)}}}}function ms(e){if(e.defaultPrevented)return;const{mountedGroups:t}=at(),s=Xn(e,t),r=new Set,a=new Set;s.forEach(i=>{if(r.add(i.group),i.panels.forEach(o=>{a.add(o)}),i.separator){const o=i.panels.find(c=>c.panelConstraints.defaultSize!==void 0);if(o){const c=o.panelConstraints.defaultSize,l=fr({groupId:i.group.id,panelId:o.id});l&&c!==void 0&&(l.resize(c),e.preventDefault())}}})}function Cn(e){const{mountedGroups:t}=at();for(const[s]of t)if(s.separators.some(r=>r.element===e))return s;throw Error("Could not find parent Group for separator element")}function xr({groupId:e}){const t=()=>{const{mountedGroups:s}=at();for(const[r,a]of s)if(r.id===e)return{group:r,...a};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:s,layout:r}=t();return s?{}:r},setLayout(s){const{defaultLayoutDeferred:r,derivedPanelConstraints:a,group:i,layout:o,separatorToPanels:c}=t(),l=Ot({layout:s,panelConstraints:a});return r?o:($t(o,l)||tt(u=>({mountedGroups:new Map(u.mountedGroups).set(i,{defaultLayoutDeferred:r,derivedPanelConstraints:a,layout:l,separatorToPanels:c})})),l)}}}function hr(e){const{mountedGroups:t}=at(),s=t.get(e);return Oe(s,`Mounted Group ${e.id} not found`),s}function Mt(e,t){const s=Cn(e),r=hr(s),a=s.separators.find(p=>p.element===e);Oe(a,"Matching separator not found");const i=r.separatorToPanels.get(a);Oe(i,"Matching panels not found");const o=i.map(p=>s.panels.indexOf(p)),c=xr({groupId:s.id}).getLayout(),l=gn({delta:t,initialLayout:c,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:c,trigger:"keyboard"}),u=Ot({layout:l,panelConstraints:r.derivedPanelConstraints});$t(c,u)||tt(p=>({mountedGroups:new Map(p.mountedGroups).set(s,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:u,separatorToPanels:r.separatorToPanels})}))}function fs(e){if(e.defaultPrevented)return;const t=e.currentTarget,s=Cn(t);if(!s.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),s.orientation==="vertical"&&Mt(t,5);break}case"ArrowLeft":{e.preventDefault(),s.orientation==="horizontal"&&Mt(t,-5);break}case"ArrowRight":{e.preventDefault(),s.orientation==="horizontal"&&Mt(t,5);break}case"ArrowUp":{e.preventDefault(),s.orientation==="vertical"&&Mt(t,-5);break}case"End":{e.preventDefault(),Mt(t,100);break}case"Enter":{e.preventDefault();const r=Cn(t),{derivedPanelConstraints:a,layout:i,separatorToPanels:o}=hr(r),c=r.separators.find(m=>m.element===t);Oe(c,"Matching separator not found");const l=o.get(c);Oe(l,"Matching panels not found");const u=l[0],p=a.find(m=>m.panelId===u.id);if(Oe(p,"Panel metadata not found"),p.collapsible){const m=i[u.id],h=p.collapsedSize===m?r.inMemoryLastExpandedPanelSizes[u.id]??p.minSize:p.collapsedSize;Mt(t,h-m)}break}case"F6":{e.preventDefault();const r=Cn(t).separators.map(o=>o.element),a=Array.from(r).findIndex(o=>o===e.currentTarget);Oe(a!==null,"Index not found");const i=e.shiftKey?a>0?a-1:r.length-1:a+1<r.length?a+1:0;r[i].focus();break}case"Home":{e.preventDefault(),Mt(t,-100);break}}}function xs(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=at(),s=Xn(e,t),r=new Set,a=new Set,i=new Set,o=new Map;let c=!1;s.forEach(l=>{r.add(l.group),l.panels.forEach(p=>{a.add(p)}),l.separator&&(i.add(l.separator),c||(c=!0,l.separator.element.focus()));const u=t.get(l.group);u&&o.set(l.group,u.layout)}),tt({interactionState:{hitRegions:s,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),s.length&&e.preventDefault()}const mi=e=>e,Fn=()=>{},gr=1,yr=2,br=4,vr=8,hs=3,gs=12;let Sn;function ys(){return Sn===void 0&&(Sn=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(Sn=!0)),Sn}function fi({cursorFlags:e,groups:t,state:s}){let r=0,a=0;switch(s){case"active":case"hover":t.forEach(i=>{if(!i.disableCursor)switch(i.orientation){case"horizontal":{r++;break}case"vertical":{a++;break}}})}if(r===0&&a===0)return null;switch(s){case"active":{if(e&&ys()){const i=(e&gr)!==0,o=(e&yr)!==0,c=(e&br)!==0,l=(e&vr)!==0;if(i)return c?"se-resize":l?"ne-resize":"e-resize";if(o)return c?"sw-resize":l?"nw-resize":"w-resize";if(c)return"s-resize";if(l)return"n-resize"}break}}return ys()?r>0&&a>0?"move":r>0?"ew-resize":"ns-resize":r>0&&a>0?"grab":r>0?"col-resize":"row-resize"}const bs=new WeakMap;function Qn(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:s}=bs.get(e)??{};s===void 0&&(s=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(s));const{cursorFlags:r,interactionState:a}=at();switch(a.state){case"active":case"hover":{const i=fi({cursorFlags:r,groups:a.hitRegions.map(c=>c.group),state:a.state}),o=`*, *:hover {cursor: ${i} !important; ${a.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,i?s.cssRules.length===0?s.insertRule(o):s.replaceSync(o):s.cssRules.length===1&&s.deleteRule(0);break}case"inactive":{t=void 0,s.cssRules.length===1&&s.deleteRule(0);break}}bs.set(e,{prevStyle:t,styleSheet:s})}function Sr({document:e,event:t,hitRegions:s,initialLayoutMap:r,mountedGroups:a,pointerDownAtPoint:i,prevCursorFlags:o}){let c=0;const l=new Map(a);s.forEach(p=>{const{group:m,groupSize:h}=p,{disableCursor:g,orientation:x,panels:f}=m;let k=0;i?x==="horizontal"?k=(t.clientX-i.x)/h*100:k=(t.clientY-i.y)/h*100:x==="horizontal"?k=t.clientX<0?-100:100:k=t.clientY<0?-100:100;const P=r.get(m),{defaultLayoutDeferred:j,derivedPanelConstraints:w,layout:M,separatorToPanels:$}=a.get(m)??{defaultLayoutDeferred:!1};if(w&&P&&M&&$){const O=gn({delta:k,initialLayout:P,panelConstraints:w,pivotIndices:p.panels.map(H=>f.indexOf(H)),prevLayout:M,trigger:"mouse-or-touch"});if($t(O,M)){if(k!==0&&!g)switch(x){case"horizontal":{c|=k<0?gr:yr;break}case"vertical":{c|=k<0?br:vr;break}}}else{l.set(p.group,{defaultLayoutDeferred:j,derivedPanelConstraints:w,layout:O,separatorToPanels:$});const H=p.group.panels.map(({id:Y})=>Y).join(",");p.group.inMemoryLayouts[H]=O}}});let u=0;t.movementX===0?u|=o&hs:u|=c&hs,t.movementY===0?u|=o&gs:u|=c&gs,tt({cursorFlags:u,mountedGroups:l}),Qn(e)}function vs(e){const{cursorFlags:t,interactionState:s,mountedGroups:r}=at();s.state==="active"&&Sr({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function Ss(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:s,mountedGroups:r}=at();switch(s.state){case"active":{if(e.buttons===0){tt(a=>a.interactionState.state==="inactive"?a:{cursorFlags:0,interactionState:{state:"inactive"}}),tt(a=>({mountedGroups:new Map(a.mountedGroups)}));return}Sr({document:e.currentTarget,event:e,hitRegions:s.hitRegions,initialLayoutMap:s.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:s.pointerDownAtPoint,prevCursorFlags:t});break}default:{const a=Xn(e,r);a.length===0?s.state!=="inactive"&&tt({interactionState:{state:"inactive"}}):tt({interactionState:{hitRegions:a,state:"hover"}}),Qn(e.currentTarget);break}}}function Ps(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=at();t.state==="active"&&(tt({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(Qn(e.currentTarget),tt(s=>({mountedGroups:new Map(s.mountedGroups)})),e.preventDefault()))}function js(e){let t=0,s=0;const r={};for(const i of e)if(i.defaultSize!==void 0){t++;const o=ft(i.defaultSize);s+=o,r[i.panelId]=o}else r[i.panelId]=void 0;const a=e.length-t;if(a!==0){const i=ft((100-s)/a);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=i)}return r}function xi(e,t,s){if(!s[0])return;const r=e.panels.find(l=>l.element===t);if(!r||!r.onResize)return;const a=Qt({group:e}),i=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,c={asPercentage:ft(i/a*100),inPixels:i};r.mutableValues.prevSize=c,r.onResize(c,r.id,o)}function hi(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}function gi(e,t){const s=e.map(a=>a.id),r=Object.keys(t);if(s.length!==r.length)return!1;for(const a of s)if(!r.includes(a))return!1;return!0}const Kt=new Map;function yi(e){let t=!0;Oe(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const s=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,a=new Set,i=new s(x=>{for(const f of x){const{borderBoxSize:k,target:P}=f;if(P===e.element){if(t){if(Qt({group:e})===0)return;tt(j=>{const w=j.mountedGroups.get(e);if(w){const M=cs(e),$=w.defaultLayoutDeferred?js(M):w.layout,O=Ot({layout:$,panelConstraints:M});return!w.defaultLayoutDeferred&&$t($,O)&&hi(w.derivedPanelConstraints,M)?j:{mountedGroups:new Map(j.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:M,layout:O,separatorToPanels:w.separatorToPanels})}}return j})}}else xi(e,P,k)}});i.observe(e.element),e.panels.forEach(x=>{Oe(!r.has(x.id),`Panel ids must be unique; id "${x.id}" was used more than once`),r.add(x.id),x.onResize&&i.observe(x.element)});const o=Qt({group:e}),c=cs(e),l=e.panels.map(({id:x})=>x).join(",");let u=e.defaultLayout;u&&(gi(e.panels,u)||(u=void 0));const p=e.inMemoryLayouts[l]??u??js(c),m=Ot({layout:p,panelConstraints:c}),h=pr(e),g=e.element.ownerDocument;return tt(x=>{const f=new Map;return Kt.set(g,(Kt.get(g)??0)+1),h.forEach(k=>{k.separator&&f.set(k.separator,k.panels)}),{mountedGroups:new Map(x.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:c,layout:m,separatorToPanels:f})}}),e.separators.forEach(x=>{Oe(!a.has(x.id),`Separator ids must be unique; id "${x.id}" was used more than once`),a.add(x.id),x.element.addEventListener("keydown",fs)}),Kt.get(g)===1&&(g.addEventListener("dblclick",ms,!0),g.addEventListener("pointerdown",xs,!0),g.addEventListener("pointerleave",vs),g.addEventListener("pointermove",Ss),g.addEventListener("pointerup",Ps,!0)),function(){t=!1,Kt.set(g,Math.max(0,(Kt.get(g)??0)-1)),tt(x=>{const f=new Map(x.mountedGroups);return f.delete(e),{mountedGroups:f}}),e.separators.forEach(x=>{x.element.removeEventListener("keydown",fs)}),Kt.get(g)||(g.removeEventListener("dblclick",ms,!0),g.removeEventListener("pointerdown",xs,!0),g.removeEventListener("pointerleave",vs),g.removeEventListener("pointermove",Ss),g.removeEventListener("pointerup",Ps,!0)),i.disconnect()}}function Pr(){const[e,t]=d.useState({}),s=d.useCallback(()=>t({}),[]);return[e,s]}function Jn(e){const t=d.useId();return`${e??t}`}const Dt=typeof window<"u"?d.useLayoutEffect:d.useEffect;function mn(e){const t=d.useRef(e);return Dt(()=>{t.current=e},[e]),d.useCallback((...s)=>t.current?.(...s),[t])}function es(...e){return mn(t=>{e.forEach(s=>{if(s)switch(typeof s){case"function":{s(t);break}case"object":{s.current=t;break}}})})}function bi(e){const t=d.useRef({...e});return Dt(()=>{for(const s in e)t.current[s]=e[s]},[e]),t.current}const jr=d.createContext(null);function vi(e,t){const s=d.useRef({getLayout:()=>({}),setLayout:mi});d.useImperativeHandle(t,()=>s.current,[]),Dt(()=>{Object.assign(s.current,xr({groupId:e}))})}function Nr({children:e,className:t,defaultLayout:s,disableCursor:r,disabled:a,elementRef:i,groupRef:o,id:c,onLayoutChange:l,onLayoutChanged:u,orientation:p="horizontal",style:m,...h}){const g=d.useRef({onLayoutChange:{},onLayoutChanged:{}}),x=mn(E=>{$t(g.current.onLayoutChange,E)||(g.current.onLayoutChange=E,l?.(E))}),f=mn(E=>{$t(g.current.onLayoutChanged,E)||(g.current.onLayoutChanged=E,u?.(E))}),k=Jn(c),P=d.useRef(null),[j,w]=Pr(),M=d.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),$=es(P,i);vi(k,o);const O=mn((E,K)=>{const{interactionState:J,mountedGroups:T}=at();for(const L of T.keys())if(L.id===E){const D=T.get(L);if(D){let b=!1;return J.state==="active"&&(b=J.hitRegions.some(C=>C.group===L)),{flexGrow:D.layout[K]??1,pointerEvents:b?"none":void 0}}}return{flexGrow:s?.[K]??1}}),H=d.useMemo(()=>({getPanelStyles:O,id:k,orientation:p,registerPanel:E=>{const K=M.current;return K.panels=Un(p,[...K.panels,E]),w(),()=>{K.panels=K.panels.filter(J=>J!==E),w()}},registerSeparator:E=>{const K=M.current;return K.separators=Un(p,[...K.separators,E]),w(),()=>{K.separators=K.separators.filter(J=>J!==E),w()}}}),[O,k,w,p]),Y=bi({defaultLayout:s,disableCursor:r}),I=d.useRef(null);return Dt(()=>{const E=P.current;if(E===null)return;const K=M.current,J={defaultLayout:Y.defaultLayout,disableCursor:!!Y.disableCursor,disabled:!!a,element:E,id:k,inMemoryLastExpandedPanelSizes:M.current.lastExpandedPanelSizes,inMemoryLayouts:M.current.layouts,orientation:p,panels:K.panels,separators:K.separators};I.current=J;const T=yi(J),L=at().mountedGroups.get(J);if(L){const{defaultLayoutDeferred:C,derivedPanelConstraints:U,layout:_}=L;!C&&U.length>0&&(x(_),f(_),K.panels.forEach(q=>{q.scheduleUpdate()}))}const D=At.addListener("interactionStateChange",()=>{K.panels.forEach(C=>{C.scheduleUpdate()})}),b=At.addListener("mountedGroupsChange",C=>{const U=C.get(J);if(U){const{defaultLayoutDeferred:_,derivedPanelConstraints:q,layout:N}=U;if(_||q.length===0)return;const{interactionState:Q}=at(),y=Q.state!=="active";x(N),y&&f(N),K.panels.forEach(A=>{A.scheduleUpdate()})}});return()=>{I.current=null,T(),D(),b()}},[a,k,f,x,p,j,Y]),d.useEffect(()=>{const E=I.current;E&&(E.defaultLayout=s,E.disableCursor=!!r)}),n.jsx(jr.Provider,{value:H,children:n.jsx("div",{...h,"aria-orientation":p,className:t,"data-group":!0,"data-testid":k,id:k,ref:$,style:{height:"100%",width:"100%",overflow:"hidden",...m,display:"flex",flexDirection:p==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}Nr.displayName="Group";function ts(){const e=d.useContext(jr);return Oe(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function Si(e,t){const{id:s}=ts(),r=d.useRef({collapse:Fn,expand:Fn,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Fn});d.useImperativeHandle(t,()=>r.current,[]),Dt(()=>{Object.assign(r.current,fr({groupId:s,panelId:e}))})}function wr({children:e,className:t,collapsedSize:s="0%",collapsible:r=!1,defaultSize:a,elementRef:i,id:o,maxSize:c="100%",minSize:l="0%",onResize:u,panelRef:p,style:m,...h}){const g=!!o,x=Jn(o),f=d.useRef(null),k=es(f,i),[,P]=Pr(),{getPanelStyles:j,id:w,registerPanel:M}=ts(),$=u!==null,O=mn((Y,I,E)=>{u?.(Y,o,E)});Dt(()=>{const Y=f.current;if(Y!==null)return M({element:Y,id:x,idIsStable:g,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:$?O:void 0,panelConstraints:{collapsedSize:s,collapsible:r,defaultSize:a,maxSize:c,minSize:l},scheduleUpdate:P})},[s,r,a,P,$,x,g,c,l,O,M]),Si(x,p);const H=j(w,x);return n.jsx("div",{...h,"data-panel":!0,"data-testid":x,id:x,ref:k,style:{...Pi,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...H},children:n.jsx("div",{className:t,style:{flexGrow:1,...m},children:e})})}wr.displayName="Panel";const Pi={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function ji({layout:e,panelConstraints:t,panelId:s,panelIndex:r}){let a,i;const o=e[s],c=t.find(l=>l.panelId===s);if(c){const l=c.maxSize,u=i=c.collapsible?c.collapsedSize:c.minSize,p=[r,r+1];i=Ot({layout:gn({delta:u-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s],a=Ot({layout:gn({delta:l-o,initialLayout:e,panelConstraints:t,pivotIndices:p,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[s]}return{valueControls:s,valueMax:a,valueMin:i,valueNow:o}}function Tr({children:e,className:t,elementRef:s,id:r,style:a,...i}){const o=Jn(r),[c,l]=d.useState({}),[u,p]=d.useState("inactive"),m=d.useRef(null),h=es(m,s),{id:g,orientation:x,registerSeparator:f}=ts(),k=x==="horizontal"?"vertical":"horizontal";return Dt(()=>{const P=m.current;if(P!==null){const j={element:P,id:o},w=f(j),M=At.addListener("interactionStateChange",O=>{p(O.state!=="inactive"&&O.hitRegions.some(H=>H.separator===j)?O.state:"inactive")}),$=At.addListener("mountedGroupsChange",O=>{O.forEach(({derivedPanelConstraints:H,layout:Y,separatorToPanels:I},E)=>{if(E.id===g){const K=I.get(j);if(K){const J=K[0],T=E.panels.indexOf(J);l(ji({layout:Y,panelConstraints:H,panelId:J.id,panelIndex:T}))}}})});return()=>{M(),$(),w()}}},[g,o,f]),n.jsx("div",{...i,"aria-controls":c.valueControls,"aria-orientation":k,"aria-valuemax":c.valueMax,"aria-valuemin":c.valueMin,"aria-valuenow":c.valueNow,children:e,className:t,"data-separator":u,"data-testid":o,id:o,ref:h,role:"separator",style:{flexBasis:"auto",...a,flexGrow:0,flexShrink:0},tabIndex:0})}Tr.displayName="Separator";function Wn({className:e,...t}){return n.jsx(Nr,{"data-slot":"resizable-panel-group",className:Ke("h-full w-full",e),...t})}function It({className:e,...t}){return n.jsx(wr,{"data-slot":"resizable-panel",className:Ke("min-w-0 min-h-0",e),...t})}function Mn({withHandle:e,className:t,...s}){return n.jsx(Tr,{"data-slot":"resizable-handle",className:Ke("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...s,children:e&&n.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:n.jsx(Br,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Ni=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],wi=[10,15,20,25,30],Dn="__none__",Ti=[{value:"auto",label:"Auto (Z->D)"},{value:"zerodha",label:"Zerodha"},{value:"dhan",label:"Dhan"}],ki=[{value:"kotak",label:"Kotak"},{value:"dhan",label:"Dhan"},{value:"zerodha",label:"Zerodha"}];function Ei(e,t){return e.length===t.length&&e.every((s,r)=>s===t[r])}function Ci({liveOpenPnl:e,isLivePnl:t=!1}){const s=Ae(T=>T.apiKey),r=Ae(T=>T.user?.broker),a=Zt(T=>T.unifiedMode),i=Zt(T=>T.dataFeed),o=Zt(T=>T.executionBroker),c=Zt(T=>T.setDataFeed),l=Zt(T=>T.setExecutionBroker),u=S(T=>T.underlying),p=S(T=>T.optionExchange),m=S(T=>T.expiryWeek),h=S(T=>T.expiry),g=S(T=>T.expiries),x=S(T=>T.chainStrikeCount),f=S(T=>T.paperMode),k=S(T=>T.sessionPnl),P=S(T=>T.tradeCount),j=S(T=>T.lastOrderAck),w=S(T=>T.setUnderlying),M=S(T=>T.setExpiryWeek),$=S(T=>T.setExpiry),O=S(T=>T.setExpiries),H=S(T=>T.setChainStrikeCount),Y=S(T=>T.setPaperMode),I=f?k:e??k,E=h&&g.includes(h)?h:Dn,{data:K}=rr({queryKey:["scalping-expiries",u,p],queryFn:()=>ir.getExpiries(s,u,p),enabled:!!s,staleTime:300*1e3});d.useEffect(()=>{if(K?.status!=="success")return;const T=K.data??[];if(Ei(g,T)||O(T),T.length===0){h&&$("");return}if(!h||!T.includes(h)){const L=m==="next"?Math.min(1,T.length-1):0,D=T[L],b=L<=0?"current":"next";h!==D&&$(D),m!==b&&M(b)}},[K,m,g,h,O,$,M]);const J=T=>{if(T===Dn)return;h!==T&&$(T);const D=g.indexOf(T)<=0?"current":"next";m!==D&&M(D)};return n.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),n.jsxs(sn,{value:u,onValueChange:T=>w(T),children:[n.jsx(rn,{className:"h-7 w-[128px] text-xs font-semibold",children:n.jsx(an,{})}),n.jsx(on,{children:Ni.map(T=>n.jsx(Gt,{value:T,children:T},T))})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),n.jsxs(sn,{value:E,onValueChange:J,disabled:g.length===0,children:[n.jsx(rn,{className:"h-7 w-[122px] text-xs font-mono",children:n.jsx(an,{placeholder:"Select expiry"})}),n.jsxs(on,{children:[n.jsx(Gt,{value:Dn,disabled:!0,children:"Select expiry"}),g.map(T=>n.jsx(Gt,{value:T,children:T},T))]})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),n.jsxs(sn,{value:String(x),onValueChange:T=>H(Number(T)),children:[n.jsx(rn,{className:"h-7 w-[94px] text-xs",children:n.jsx(an,{})}),n.jsx(on,{children:wi.map(T=>n.jsx(Gt,{value:String(T),children:T},T))})]})]}),n.jsx("div",{className:"flex-1"}),a&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Feed"}),n.jsxs(sn,{value:i,onValueChange:T=>c(T),children:[n.jsx(rn,{className:"h-7 w-[118px] text-xs",children:n.jsx(an,{})}),n.jsx(on,{children:Ti.map(T=>n.jsx(Gt,{value:T.value,children:T.label},T.value))})]})]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Exec"}),n.jsxs(sn,{value:o,onValueChange:T=>l(T),children:[n.jsx(rn,{className:"h-7 w-[96px] text-xs",children:n.jsx(an,{})}),n.jsx(on,{children:ki.map(T=>n.jsx(Gt,{value:T.value,children:T.label},T.value))})]})]})]}),n.jsx("div",{className:"flex items-center gap-1.5",children:n.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${f?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>Y(!0),children:"Paper"}),n.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${f?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>Y(!1),children:"Live"})]})}),n.jsx("div",{className:"w-px h-5 bg-border"}),a?n.jsxs(_e,{variant:"outline",className:"text-xs h-6",children:["EXEC: ",o.toUpperCase()]}):r&&n.jsx(_e,{variant:"outline",className:"text-xs h-6",children:r}),!f&&j&&n.jsxs(_e,{variant:"outline",className:"text-xs h-6 font-mono",title:`${j.broker} ${j.action} ${j.symbol}`,children:["ACK: ",j.orderId]}),n.jsx("div",{className:"w-px h-5 bg-border"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),n.jsxs("span",{className:`text-sm font-bold tabular-nums ${I>0?"text-green-500":I<0?"text-red-500":"text-foreground"}`,children:[I>=0?"+":"",I.toFixed(0)]}),!f&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),P>0&&n.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",P,")"]})]})]})}function Pn(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function Ns({value:e,prevRef:t,className:s,format:r="price"}){const a=d.useRef(null);d.useEffect(()=>{if(e==null||e===t.current)return;const o=a.current;if(!o)return;const c=e>t.current?"flash-green":"flash-red";o.classList.add(c);const l=setTimeout(()=>o.classList.remove(c),300);return t.current=e,()=>clearTimeout(l)},[e,t]);const i=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return n.jsx("span",{ref:a,className:Ke("tabular-nums transition-colors",s),children:i})}function jn({value:e,max:t,side:s,kind:r}){if(!e||!t)return null;const a=Math.min(e/t*100,100),i=Math.min(.2+a/180,.75);return n.jsx("div",{className:Ke("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",s==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",a>72&&"animate-pulse"),style:{width:`${a}%`,opacity:i}})}function Li(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.onSelectCE!==t.onSelectCE||e.onSelectPE!==t.onSelectPE||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Mi=d.memo(function({strike:t,ce:s,pe:r,isATM:a,isSelected:i,maxOI:o,maxVol:c,onSelectStrike:l,onSelectCE:u,onSelectPE:p}){const m=d.useRef(s?.ltp??0),h=d.useRef(r?.ltp??0),g=Math.min(((s?.oi??0)/o+(s?.volume??0)/c)/2*100,100),x=Math.min(((r?.oi??0)/o+(r?.volume??0)/c)/2*100,100);return n.jsxs("div",{className:Ke("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs hover:bg-accent/50 border-b border-border/30",a&&"bg-yellow-500/10 border-y border-yellow-500/30",i&&"bg-primary/10 ring-1 ring-primary/30"),children:[n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx(jn,{value:s?.oi??0,max:o,side:"CE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Pn(s?.oi)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx(jn,{value:s?.volume??0,max:c,side:"CE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Pn(s?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>u(t,s?.symbol??null),title:s?.symbol??"Select CE",children:[n.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${g}%`}}),n.jsx(Ns,{value:s?.ltp,prevRef:m,className:"relative z-10 font-medium"})]}),n.jsx("div",{className:Ke("text-center font-bold tabular-nums px-1 cursor-pointer",a&&"text-yellow-500"),onClick:()=>l(t,s?.symbol??null,r?.symbol??null),title:"Load CE and PE for this strike",children:t}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${x}%`}}),n.jsx(Ns,{value:r?.ltp,prevRef:h,className:"relative z-10 font-medium"})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx(jn,{value:r?.volume??0,max:c,side:"PE",kind:"volume"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Pn(r?.volume)})]}),n.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden cursor-pointer",onClick:()=>p(t,r?.symbol??null),title:r?.symbol??"Select PE",children:[n.jsx(jn,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),n.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Pn(r?.oi)})]})]})},Li);function ws(e){return(e??"").replace(/-/g,"").toUpperCase()}function Ri(){const e=Ae(L=>L.apiKey),t=S(L=>L.underlying),s=S(L=>L.indexExchange),r=S(L=>L.optionExchange),a=S(L=>L.expiry),i=S(L=>L.selectedStrike),o=S(L=>L.selectedCESymbol),c=S(L=>L.selectedPESymbol),l=S(L=>L.chainStrikeCount),u=S(L=>L.setSelectedStrike),p=S(L=>L.setSelectedSymbols),m=S(L=>L.setActiveSide),h=S(L=>L.setLotSize),g=S(L=>L.setOptionChainSnapshot),x=d.useRef(null),f=d.useRef(null),k=d.useRef(!1),{data:P,isLoading:j,isStreaming:w,error:M,streamingSymbols:$,lastUpdate:O}=Vr(e,t,s,r,a,l,{enabled:!!e&&!!a,oiRefreshInterval:0,wsMode:"Quote"});d.useEffect(()=>{P&&g(P,O?.getTime()??Date.now(),w)},[P,O,w,g]),d.useEffect(()=>{if(!P?.chain?.length||(P.underlying??"").toUpperCase()!==t.toUpperCase()||a&&ws(P.expiry_date)!==ws(a)||k.current)return;let L=null;for(const D of P.chain){const b=Number(D.ce?.lotsize);if(Number.isFinite(b)&&b>0){L=b;break}const C=Number(D.pe?.lotsize);if(Number.isFinite(C)&&C>0){L=C;break}}L!==null&&(h(L),k.current=!0)},[P,h]),d.useEffect(()=>{k.current=!1},[t,a]),d.useEffect(()=>{if(P?.chain&&f.current&&x.current){const L=x.current,D=f.current,b=L.getBoundingClientRect(),C=D.getBoundingClientRect(),U=C.top-b.top-b.height/2+C.height/2;L.scrollTop+=U}},[P?.atm_strike]);const H=d.useCallback((L,D,b)=>{u(L),p(D,b)},[u,p]),Y=d.useCallback((L,D)=>{D&&(u(L),p(D,c),m("CE"))},[c,m,u,p]),I=d.useCallback((L,D)=>{D&&(u(L),p(o,D),m("PE"))},[o,m,u,p]),{maxOI:E,maxVol:K}=d.useMemo(()=>{if(!P?.chain?.length)return{maxOI:1,maxVol:1};let L=0,D=0;for(const b of P.chain)b.ce?.oi&&b.ce.oi>L&&(L=b.ce.oi),b.pe?.oi&&b.pe.oi>L&&(L=b.pe.oi),b.ce?.volume&&b.ce.volume>D&&(D=b.ce.volume),b.pe?.volume&&b.pe.volume>D&&(D=b.pe.volume);return{maxOI:L||1,maxVol:D||1}},[P?.chain]),J=P?.underlying_ltp,T=P?.atm_strike;return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-sm font-bold",children:t}),n.jsxs(_e,{variant:"outline",className:"text-[10px] h-4 px-1",children:[l," strikes"]}),J!=null&&n.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:J.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[w&&n.jsxs(_e,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[n.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),$]}),j&&n.jsx(_e,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),n.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[n.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),n.jsx("div",{className:"text-center",children:"Strike"}),n.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),n.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),n.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),n.jsxs("div",{ref:x,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[M&&n.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:M}),!M&&!j&&P?.chain?.length===0&&n.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),P?.chain?.map(L=>{const D=L.strike===T;return n.jsx("div",{ref:D?f:void 0,children:n.jsx(Mi,{strike:L.strike,ce:L.ce,pe:L.pe,isATM:D,isSelected:L.strike===i,maxOI:E,maxVol:K,onSelectStrike:H,onSelectCE:Y,onSelectPE:I})},L.strike)})]})]})}function Ii({positions:e,totalPnl:t,isLivePnl:s}){const r=S(o=>o.activeSide),a=S(o=>o.hotkeysEnabled),i=S(o=>o.paperMode);return n.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[n.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?n.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):n.jsxs(n.Fragment,{children:[e.map(o=>n.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[n.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),n.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),n.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),n.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),n.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),n.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&n.jsxs(n.Fragment,{children:[n.jsx("span",{className:"text-border",children:"|"}),n.jsx("span",{className:"text-muted-foreground",children:"Total:"}),n.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),n.jsx("span",{className:`text-[10px] ${s?"text-green-500":"text-muted-foreground"}`,children:s?"LIVE":"REST"})]})]})}),n.jsx("div",{className:"flex items-center gap-2 shrink-0",children:i&&n.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),n.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:a?n.jsxs(n.Fragment,{children:[n.jsxs("span",{children:["Active: ",n.jsx("span",{className:"text-foreground font-medium",children:r})]}),n.jsx("span",{className:"text-border",children:"|"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),n.jsx("span",{children:"Buy"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),n.jsx("span",{children:"Sell"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),n.jsx("span",{children:"Rev"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),n.jsx("span",{children:"Close"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),n.jsx("span",{children:"All"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),n.jsx("span",{children:"Widget"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),n.jsx("span",{children:"Side"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↑"}),n.jsx("span",{children:"CE Mkt Buy"}),n.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"↓"}),n.jsx("span",{children:"PE Mkt Buy"})]}):n.jsx("span",{children:"Hotkeys disabled"})})]})}const Jt=300*60+1800,Ts=1440*60,un=540*60+900,ks=900*60+1800;function Rn(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function kr(e){const t=Rn(e)+Jt,s=Math.floor(t/Ts)*Ts,r=t-s,a=(s-Jt)*1e3,i=new Date(a).getUTCDay();return{dayStartIstSeconds:s,secondsOfDay:r,dayOfWeek:i}}function Ai(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const s=Number(t[1]),r=Number(t[2]),a=Number(t[3]),i=Number(t[4]??"0"),o=Number(t[5]??"0"),c=Number(t[6]??"0");if(!Number.isFinite(s)||!Number.isFinite(r)||!Number.isFinite(a)||!Number.isFinite(i)||!Number.isFinite(o)||!Number.isFinite(c))return null;const l=Date.UTC(s,r-1,a,i,o,c)-Jt*1e3;return Math.floor(l/1e3)}function $i(e){if(!e||typeof e!="object")return null;const t=e,s=Number(t.year),r=Number(t.month),a=Number(t.day);if(!Number.isFinite(s)||!Number.isFinite(r)||!Number.isFinite(a)||s<1970||r<1||r>12||a<1||a>31)return null;const i=Date.UTC(Math.floor(s),Math.floor(r)-1,Math.floor(a),0,0,0)-Jt*1e3;return Math.floor(i/1e3)}function yt(e){if(typeof e=="number")return Rn(e);const t=$i(e);if(t!=null)return t;if(typeof e!="string")return null;const s=e.trim();if(s.length===0)return null;const r=Number(s.replace(/,/g,""));if(Number.isFinite(r))return Rn(r);const a=Ai(s);if(a!=null)return a;const i=Date.parse(s);return Number.isFinite(i)?Math.floor(i/1e3):null}function ns(e,t={}){const{secondsOfDay:s,dayOfWeek:r}=kr(e);if(r===0||r===6)return!1;const a=s>=un,i=t.includeClose?s<=ks:s<ks;return a&&i}function Oi(e,t){const s=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:a}=kr(e),i=a<=un?un:un+Math.floor((a-un)/s)*s;return r+i-Jt}function Er(e){const t=(Rn(e)+Jt)*1e3,s=new Date(t),r=s.getUTCHours().toString().padStart(2,"0"),a=s.getUTCMinutes().toString().padStart(2,"0");return`${r}:${a}`}function Fi(e,t,s,r={}){const a=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?Oi(a,s):Math.floor(a/s)*s,c=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:c},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+c},!1]}function Cr({symbol:e,exchange:t,intervalSec:s=1,mode:r="LTP",enabled:a=!0,useIndiaMarketHours:i=!1,maxCandles:o=500,onCandleUpdate:c}){const l=d.useRef([]),u=d.useRef(null),p=d.useRef(null),m=d.useRef(c);m.current=c;const h=a&&e?[{symbol:e,exchange:t}]:[],{data:g,isConnected:x}=pn({symbols:h,mode:r,enabled:a&&!!e});d.useEffect(()=>{if(!a||!e||g.size===0)return;const j=`${t.toUpperCase()}:${e.toUpperCase()}`,w=g.get(j);if(!w?.data?.ltp)return;const M=w.lastUpdate;if(!M||!Number.isFinite(M))return;const $=Math.floor(M/1e3);if(i&&!ns($))return;const O=w.data.ltp,H=w.data.volume??"",Y=`${j}:${M}:${O}:${H}`;if(p.current===Y)return;p.current=Y;const I={price:O,volume:w.data.volume,timestamp:M},[E,K]=Fi(I,u.current,s,{alignToIndiaSession:i});K&&u.current&&(l.current.push(u.current),l.current.length>o&&(l.current=l.current.slice(-o))),u.current=E,m.current?.(E,K)},[g,e,t,s,a,o,i]);const f=d.useCallback(()=>{const j=[...l.current];return u.current&&j.push(u.current),j},[]),k=d.useCallback(()=>{l.current=[],u.current=null,p.current=null},[]),P=d.useCallback(j=>{if(!j?.length){l.current=[],u.current=null;return}const w=j.slice(-o);if(w.length===1){l.current=[],u.current=w[0];return}l.current=w.slice(0,-1),u.current=w[w.length-1]},[o]);return{getCandles:f,reset:k,seed:P,isConnected:x}}function In(e,t){if(e.length<t)return[];const s=2/(t+1),r=[];let a=0;for(let o=0;o<t;o++)a+=e[o].value;let i=a/t;r.push({time:e[t-1].time,value:i});for(let o=t;o<e.length;o++)i=e[o].value*s+i*(1-s),r.push({time:e[o].time,value:i});return r}function Lr(e,t=10,s=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=Di(e,t),a=[],i=[],o=[];if(r.length===0)return{upper:a,lower:i,trend:o};const c=e.length-r.length;let l=0,u=0,p=1;for(let m=0;m<r.length;m++){const h=e[c+m],g=(h.high+h.low)/2,x=r[m].value;let f=g+s*x,k=g-s*x;m>0&&(k>u||e[c+m-1].close<u||(k=u),f<l||e[c+m-1].close>l||(f=l));let P=p;m>0&&(p===1&&h.close<k?P=-1:p===-1&&h.close>f&&(P=1));const j=h.time;a.push({time:j,value:f}),i.push({time:j,value:k}),o.push({time:j,value:P===1?k:f}),l=f,u=k,p=P}return{upper:a,lower:i,trend:o}}function Di(e,t=14){if(e.length<t+1)return[];const s=[],r=[];for(let i=1;i<e.length;i++){const o=e[i].high,c=e[i].low,l=e[i-1].close;r.push(Math.max(o-c,Math.abs(o-l),Math.abs(c-l)))}let a=0;for(let i=0;i<t;i++)a+=r[i];a/=t,s.push({time:e[t].time,value:a});for(let i=t;i<r.length;i++)a=(a*(t-1)+r[i])/t,s.push({time:e[i+1].time,value:a});return s}function Mr(e){if(e.length===0)return[];const t=[];let s=0,r=0;for(const a of e){const i=(a.high+a.low+a.close)/3,o=a.volume||1;s+=i*o,r+=o,t.push({time:a.time,value:r>0?s/r:i})}return t}function zi(e){return!Number.isFinite(e)||e<=0?1:e}function _i(e,t){if(!Number.isFinite(e)||e<=0)return t*2;const s=Math.ceil(e/t)*t;return Math.max(t*2,s)}function Rr(e,t){const s=zi(e),r=_i(t,s);return a=>{const i=a(),o=i?.priceRange;if(!i||!o)return i;const c=o.minValue,l=o.maxValue;if(!Number.isFinite(c)||!Number.isFinite(l))return i;const u=Math.min(c,l),p=Math.max(c,l),m=(u+p)/2;let h=p-u;(!Number.isFinite(h)||h<s)&&(h=s),h<r&&(h=r),h=Math.ceil(h/s)*s;const g=h/2,x=Math.floor((m-g)/s)*s;let f=Math.ceil((m+g)/s)*s;return f-x<h&&(f=x+h),{...i,priceRange:{minValue:x,maxValue:f}}}}const Bi=120,en=500,Vi=1,qi=50,Gi=200;function Nn(e){return e.map(t=>({time:t.time,value:t.value}))}function Ki(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Ui(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Es(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function Ze(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function ss(e){const t=yt(e);return t??null}function Wi(e){if(!e?.length)return[];const t=[];for(const i of e){const o=yt(i.timestamp)??yt(i.time)??yt(i.datetime)??yt(i.date),c=Ze(i.open),l=Ze(i.high),u=Ze(i.low),p=Ze(i.close),m=Ze(i.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:m})}if(t.length===0)return[];t.sort((i,o)=>Number(i.time)-Number(o.time));const s=new Map;for(const i of t)s.set(Number(i.time),i);const r=Array.from(s.values()).slice(-en),a=r.filter(i=>ns(Number(i.time),{includeClose:!0}));return(a.length>0?a:r).slice(-en)}function Ut(e){return e.map(t=>({...t}))}function Hi(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,a)=>Number(r.time)-Number(a.time)).slice(-en)}function zn(e){const t=[];for(const s of e){const r=ss(s.time);r!=null&&t.push({time:r,open:s.open,high:s.high,low:s.low,close:s.close})}return t.sort((s,r)=>Number(s.time)-Number(r.time)),t}function Cs(e){if(!e.length)return[];const t=new Map;for(const s of e){const r=ss(s.time),a=Ze(s.open),i=Ze(s.high),o=Ze(s.low),c=Ze(s.close),l=Ze(s.volume)??0;r==null||a==null||i==null||o==null||c==null||t.set(Number(r),{time:r,open:a,high:i,low:o,close:c,volume:l})}return Array.from(t.values()).sort((s,r)=>Number(s.time)-Number(r.time)).slice(-en)}function Yi({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}){const a=d.useRef(null),i=d.useRef(null),o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),m=d.useRef([]),h=d.useRef(new Map),g=d.useRef(null),x=d.useRef(0),f=d.useRef(null),k=d.useRef({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r}),P=Ae(b=>b.apiKey),j=Ae(b=>b.setApiKey),w=tr(b=>b.mode==="dark"),M=S(b=>b.underlying),$=S(b=>b.indexExchange),O=S(b=>b.chartInterval),H=d.useCallback(()=>{const b=m.current,C=k.current,U=b.map(_=>({time:_.time,value:_.close}));c.current&&c.current.setData(C.showEma9?Nn(In(U,9)):[]),l.current&&l.current.setData(C.showEma21?Nn(In(U,21)):[]),u.current&&u.current.setData(C.showSupertrend?Nn(Lr(b,10,3).trend):[]),p.current&&p.current.setData(C.showVwap?Nn(Mr(b)):[])},[]),Y=d.useCallback(()=>{f.current===null&&(f.current=setTimeout(()=>{f.current=null,H()},Bi))},[H]),I=d.useCallback(()=>{m.current=[],o.current?.setData([]),c.current?.setData([]),l.current?.setData([]),u.current?.setData([]),p.current?.setData([])},[]),E=d.useCallback(b=>{const C=Cs(b);m.current=Ut(C),o.current?.setData(zn(C)),Y()},[Y]),K=d.useCallback(async()=>{if(P)return P;try{const C=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(C.status==="success"&&C.api_key)return j(C.api_key),C.api_key}catch{}return null},[P,j]),J=d.useCallback((b,C)=>{if(!o.current)return;const U=ss(b.time),_=Ze(b.open),q=Ze(b.high),N=Ze(b.low),Q=Ze(b.close),y=Ze(b.volume)??0;if(U==null||_==null||q==null||N==null||Q==null)return;const A={time:U,open:_,high:q,low:N,close:Q,volume:y},z=Number(A.time),X=m.current.length?Number(m.current[m.current.length-1].time):null;if(X!=null&&Number.isFinite(X)&&Number.isFinite(z)&&z<X)return;try{o.current.update({time:A.time,open:A.open,high:A.high,low:A.low,close:A.close})}catch{const ue=Cs([...m.current,A]);m.current=ue,o.current.setData(zn(ue)),Y();return}C?(m.current.push(A),m.current.length>en&&(m.current=m.current.slice(-en))):m.current.length>0?m.current[m.current.length-1]=A:m.current.push(A);const se=g.current;se&&h.current.set(se,Ut(m.current)),Y()},[Y]),{isConnected:T,reset:L,seed:D}=Cr({symbol:M,exchange:$,intervalSec:O,mode:"Quote",enabled:!!M,useIndiaMarketHours:!0,onCandleUpdate:J});return d.useEffect(()=>{const b=g.current;if(b&&m.current.length>0&&h.current.set(b,Ut(m.current)),!M){g.current=null,L(),I();return}const C=`${$}:${M}:${O}`;g.current=C;const U=h.current.get(C);if(U&&U.length>0){L(),D(U),E(U);return}L(),I();const _=++x.current,q=Ui(O),N=new Date,Q=new Date(N.getTime());Q.setDate(Q.getDate()-Vi),(async()=>{const A=await K();if(!A){_===x.current&&I();return}try{const z=async()=>{try{const R=await we.getQuotes(A,M,$);if(R.status!=="success"||!R.data)return null;const B=Ze(R.data.ltp);if(B==null||B<=0)return null;const Z=Math.floor(Date.now()/1e3);return{time:Math.floor(Z/O)*O,open:B,high:B,low:B,close:B,volume:Ze(R.data.volume)??0}}catch{return null}},X=async R=>{try{const B=await we.getHistory(A,M,$,q,Es(Q),Es(N),R);return B.status==="success"?Wi(B.data):[]}catch{return[]}},se=await X("api"),ue=se.length>0?se:await X("db");if(_!==x.current)return;const fe=g.current===C?Ut(m.current):[],Se=Hi(ue,fe);if(Se.length>0){h.current.set(C,Ut(Se)),D(Se),E(Se);return}const Me=await z();if(Me&&_===x.current){const R=[Me];h.current.set(C,Ut(R)),D(R),E(R);return}}catch{}_===x.current&&I()})()},[M,$,O,K,L,D,I,E]),d.useEffect(()=>{k.current={showEma9:e,showEma21:t,showSupertrend:s,showVwap:r},c.current?.applyOptions({visible:e}),l.current?.applyOptions({visible:t}),u.current?.applyOptions({visible:s}),p.current?.applyOptions({visible:r}),Y()},[e,t,s,r,Y]),d.useEffect(()=>{const b=a.current;if(!b)return;const C=Ki(w),U=Rr(qi,Gi),_=ar(b,{width:b.offsetWidth,height:b.offsetHeight,layout:{background:{type:lr.Solid,color:C.bg},textColor:C.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:C.grid},horzLines:{color:C.grid}},rightPriceScale:{borderColor:C.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:C.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:X=>Er(X)},crosshair:{mode:or.Normal,vertLine:{width:1,color:C.crosshair,style:2},horzLine:{width:1,color:C.crosshair,style:2}}}),q=_.addSeries(cr,{upColor:C.upColor,downColor:C.downColor,borderVisible:!1,wickUpColor:C.upColor,wickDownColor:C.downColor,autoscaleInfoProvider:U}),N=_.addSeries(wt,{color:C.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:k.current.showEma9,autoscaleInfoProvider:U}),Q=_.addSeries(wt,{color:C.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:k.current.showEma21,autoscaleInfoProvider:U}),y=_.addSeries(wt,{color:C.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:k.current.showSupertrend,autoscaleInfoProvider:U}),A=_.addSeries(wt,{color:C.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:k.current.showVwap,autoscaleInfoProvider:U});i.current=_,o.current=q,c.current=N,l.current=Q,u.current=y,p.current=A,m.current.length>0&&(q.setData(zn(m.current)),Y());const z=new ResizeObserver(()=>{if(i.current&&b){const X=b.offsetWidth,se=b.offsetHeight;X>0&&se>0&&i.current.applyOptions({width:X,height:se})}});return z.observe(b),()=>{f.current!==null&&(clearTimeout(f.current),f.current=null),z.disconnect(),_.remove(),i.current=null,o.current=null,c.current=null,l.current=null,u.current=null,p.current=null}},[w,Y]),n.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[n.jsx("div",{ref:a,className:"h-full w-full"}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:"text-xs font-bold text-foreground/80",children:M}),!T&&n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),n.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),s&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const ce=nr()(sr((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:s=>e(r=>({virtualTPSL:{...r.virtualTPSL,[s.id]:s}})),removeVirtualTPSL:s=>e(r=>{const{[s]:a,...i}=r.virtualTPSL;return{virtualTPSL:i}}),updateVirtualTPSL:(s,r)=>e(a=>{const i=a.virtualTPSL[s];return i?{virtualTPSL:{...a.virtualTPSL,[s]:{...i,...r}}}:a}),getTPSLForSymbol:s=>Object.values(t().virtualTPSL).filter(a=>a.symbol===s).sort((a,i)=>i.createdAt-a.createdAt)[0],addTriggerOrder:s=>e(r=>({triggerOrders:{...r.triggerOrders,[s.id]:s}})),removeTriggerOrder:s=>e(r=>{const{[s]:a,...i}=r.triggerOrders;return{triggerOrders:i}}),updateTriggerOrder:(s,r)=>e(a=>{const i=a.triggerOrders[s];return i?{triggerOrders:{...a.triggerOrders,[s]:{...i,...r}}}:a}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:s=>e(r=>{const a=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==s)),i=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==s));return{virtualTPSL:a,triggerOrders:i}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Ls=.05;function Ln(e){return Math.round(e/Ls)*Ls}function dn(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:Ln(e)}async function tn({symbol:e,exchange:t,preferredPrice:s=null,fallbackPrice:r=null,apiKey:a=null}){const i=dn(s);if(i!=null)return i;const o=xn.getInstance(),c=dn(o.getCachedData(e,t)?.data?.ltp);if(c!=null)return c;const l=dn(r);if(l!=null)return l;if(a)try{const u=await we.getQuotes(a,e,t),p=dn(u.data?.ltp);if(p!=null)return p}catch{}return 0}function Zi(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Xi(e){return An(e.orderid??e.order_id)}function Qi(e){const t=e.order_status??e.status??"";return String(t).trim().toUpperCase()}function Ji(e){const t=[e.average_price,e.averageprice,e.fill_price,e.fillprice,e.traded_price,e.tradedprice,e.price];for(const s of t){const r=dn(Zi(s));if(r!=null)return r}return null}function ea(e){return new Promise(t=>{setTimeout(t,e)})}async function zt({symbol:e,exchange:t,orderId:s=null,preferredPrice:r=null,fallbackPrice:a=null,apiKey:i=null,maxAttempts:o=5,retryDelayMs:c=250}){const l=An(s);if(i&&l)for(let u=0;u<o;u+=1){try{const m=(await we.getOrders(i)).data?.orders;if(Array.isArray(m)){const h=m.find(g=>!g||typeof g!="object"?!1:Xi(g)===l);if(h&&typeof h=="object"){const g=h,x=Qi(g),f=Ji(g),k=x.includes("COMPLETE")||x.includes("FILLED")||x.includes("EXECUTED")||x.includes("TRADED");if(f!=null&&(k||u===o-1))return f}}}catch{}u<o-1&&await ea(c)}return tn({symbol:e,exchange:t,preferredPrice:r,fallbackPrice:a,apiKey:i})}function xt({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:s,side:r,action:a,entryPrice:i,quantity:o,tpPoints:c,slPoints:l,createdAt:u=Date.now(),managedBy:p="manual",autoEntryScore:m,autoEntryReason:h}){const g=Ln(i),x=Number(Math.max(0,c||0).toFixed(2)),f=Number(Math.max(0,l||0).toFixed(2)),k=a==="BUY";return{id:e,symbol:t,exchange:s,side:r,action:a,entryPrice:g,quantity:o,tpPrice:x>0?Ln(g+(k?x:-x)):null,slPrice:f>0?Ln(g+(k?-f:f)):null,tpPoints:x,slPoints:f,trailStage:p==="auto"?"INITIAL":void 0,createdAt:u,managedBy:p,autoEntryScore:m,autoEntryReason:h}}function An(e){if(e==null)return null;const t=String(e).trim();return t.length>0?t:null}function Ft(e){if(!e||typeof e!="object")return null;const t=e,s=An(t.orderid??t.order_id),r=t.data;if(!r||typeof r!="object")return s;const a=r;return An(a.orderid??a.order_id)??s}const Ms=.05,ta=150;function We(e){return Math.round(e/Ms)*Ms}function Nt(e){return Number(Math.max(0,e).toFixed(2))}function Rs(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?We(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?We(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function na({chartRef:e,seriesRef:t,side:s,containerRef:r}){const a=Ae(v=>v.apiKey),i=Ae(v=>v.setApiKey),o=S(v=>v.activeSide),c=S(v=>v.orderType),l=S(v=>v.tpPoints),u=S(v=>v.slPoints),p=S(v=>v.limitPrice),m=S(v=>v.pendingEntryAction),h=S(v=>v.pendingLimitPlacement),g=S(v=>v.quantity),x=S(v=>v.lotSize),f=S(v=>v.optionExchange),k=S(v=>v.product),P=S(v=>v.paperMode),j=S(v=>v.incrementTradeCount),w=S(v=>v.setLimitPrice),M=S(v=>v.setTpPoints),$=S(v=>v.setSlPoints),O=S(v=>v.setPendingEntryAction),H=S(v=>v.setPendingLimitPlacement),Y=S(v=>v.clearPendingLimitPlacement),I=S(v=>s==="CE"?v.selectedCESymbol:v.selectedPESymbol),E=ce(v=>v.virtualTPSL),K=ce(v=>v.triggerOrders),J=ce(v=>v.addTriggerOrder),T=ce(v=>v.updateTriggerOrder),L=ce(v=>v.removeTriggerOrder),D=ce(v=>v.setVirtualTPSL),b=ce(v=>v.clearForSymbol),C=ce(v=>v.updateVirtualTPSL),U=d.useRef(null),_=d.useRef(null),q=d.useRef(null),N=d.useRef(null),Q=d.useRef(null),y=d.useRef(null),A=d.useRef(null),z=d.useRef(null),[X,se]=d.useState(null),[ue,fe]=d.useState(null),[Se,Me]=d.useState(null),[R,B]=d.useState(null),[Z,re]=d.useState(!1),ee=d.useRef(!1),Ee=d.useRef(!1),F=d.useRef(0),he=d.useRef(null),$e=d.useRef(null),Te=d.useRef(null),ge=o===s,ve=c==="LIMIT"||c==="TRIGGER",Ue=d.useMemo(()=>I?Object.values(E).filter(v=>v.symbol===I).sort((v,G)=>G.createdAt-v.createdAt):[],[I,E]),V=Ue[0],ie=d.useMemo(()=>I?Object.values(K).find(v=>v.symbol===I):void 0,[I,K]),Pe=!!h&&h.symbol===I&&h.side===s,He=Pe||p!=null,Be=V?"position":ie?"trigger":ge&&ve&&He?"pending":null,ze=m??h?.action??"BUY";d.useEffect(()=>{if(!V){B(null);return}const v=xn.getInstance(),G=v.getCachedData(V.symbol,V.exchange)?.data?.ltp;G&&G>0&&B(G);const ne=v.subscribe(V.symbol,V.exchange,"LTP",ye=>{const Ne=ye.data.ltp;Ne&&Ne>0&&B(Ne)});return()=>ne()},[V]);const Ge=d.useMemo(()=>{if(!V||!R||R<=0)return null;const v=V.action==="BUY"?R-V.entryPrice:V.entryPrice-R,G=v*V.quantity;return{ltp:R,points:v,pnl:G}},[V,R]),nt=d.useMemo(()=>{if(Ue.length===0)return null;const v=Ue.reduce((ne,ye)=>ne+Math.max(ye.quantity,0),0);if(v<=0)return null;const G=Ue.reduce((ne,ye)=>ne+ye.entryPrice*Math.max(ye.quantity,0),0)/v;return We(G)},[Ue]),Ct=d.useMemo(()=>{if(!V)return"";const v=`${V.action} Fill @ ${V.entryPrice.toFixed(2)}`,G=nt!=null?` | Avg ${nt.toFixed(2)}`:"";if(!Ge)return v;const ne=Ge.pnl>=0?"+":"";return`${v}${G} | PnL ${ne}${Ge.pnl.toFixed(2)}`},[V,Ge,nt]),oe=d.useCallback((v,G)=>{if(v.current){const ne=G.current??t.current;try{ne?.removePriceLine(v.current)}catch{}v.current=null,G.current=null}},[t]),le=d.useCallback((v,G,ne,ye,Ne,ae,be)=>{const me=t.current;if(!me)return;const Re="";if(v.current&&G.current&&G.current!==me){try{G.current.removePriceLine(v.current)}catch{}v.current=null,G.current=null}v.current?v.current.applyOptions({price:ne,color:ye,lineStyle:Ne,lineWidth:ae,title:Re,axisLabelVisible:!0}):(v.current=me.createPriceLine({price:ne,color:ye,lineStyle:Ne,lineWidth:ae,title:Re,axisLabelVisible:!0}),G.current=me)},[t]),Ce=d.useCallback(v=>{if(!t.current)return null;const G=t.current.priceToCoordinate(v);return G??null},[t]),pe=d.useCallback(()=>{const v=(G,ne)=>{if(!G.current){ne(null);return}const ye=G.current.options().price,Ne=Ce(ye);if(Ne==null){ne(null);return}ne({y:Ne,price:ye})};v(_,se),v(q,fe),v(N,Me)},[Ce]),Fe=d.useCallback(()=>{if(!I)return null;const G=xn.getInstance().getCachedData(I,f)?.data?.ltp;return!G||G<=0?null:G},[I,f]),De=d.useCallback(v=>v==="BUY"?"above":"below",[]),Ve=d.useCallback((v,G)=>{const ne=Fe();return ne?v==="BUY"&&G<=ne?{ok:!1,message:`BUY trigger must be above current price (${ne.toFixed(2)})`}:v==="SELL"&&G>=ne?{ok:!1,message:`SELL trigger must be below current price (${ne.toFixed(2)})`}:{ok:!0}:{ok:!0}},[Fe]),st=d.useCallback(async()=>{if(a)return a;try{const G=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(G.status==="success"&&G.api_key)return i(G.api_key),G.api_key}catch(v){console.error("[Scalping] Failed to fetch API key:",v)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[a,i]),bt=d.useCallback(async()=>{if(Ee.current)return;const v=$e.current;if(!v)return;const G=Date.now()-F.current,ne=v.force?0:Math.max(0,ta-G);if(ne>0){if(he.current!=null)return;he.current=window.setTimeout(()=>{he.current=null,bt()},ne);return}$e.current=null,Ee.current=!0,F.current=Date.now();try{if(!await st())return;await we.modifyOrder(v.orderId,{symbol:v.symbol,exchange:f,action:v.action,product:k,pricetype:"LIMIT",price:v.price,quantity:v.quantity,trigger_price:0,disclosed_quantity:0})}catch(ye){console.error("[Scalping] Failed to modify pending LIMIT order:",ye)}finally{Ee.current=!1,$e.current&&bt()}},[st,f,k]),Xe=d.useCallback((v,G,ne=!1)=>{if(P||!v.orderId)return;const ye=We(G),Ne=$e.current;$e.current={orderId:v.orderId,symbol:v.symbol,action:v.action,quantity:v.quantity,price:ye,force:ne||!!Ne?.force},ne&&he.current!=null&&(window.clearTimeout(he.current),he.current=null),bt()},[P,bt]);d.useEffect(()=>()=>{he.current!=null&&(window.clearTimeout(he.current),he.current=null)},[]);const St=d.useCallback(async(v,G)=>{if(!I||ee.current)return!1;ee.current=!0;try{if(P){const be=await tn({symbol:I,exchange:f,preferredPrice:v});return be<=0?!1:(D(xt({symbol:I,exchange:f,side:s,action:G,entryPrice:be,quantity:g*x,tpPoints:l,slPoints:u,managedBy:"manual"})),j(),Y(),O(null),w(null),!0)}const ne=await st();if(!ne)return!1;const ye={apikey:ne,strategy:"Scalping",exchange:f,symbol:I,action:G,quantity:g*x,pricetype:"LIMIT",product:k,price:v,trigger_price:0,disclosed_quantity:0},Ne=await we.placeOrder(ye);if(Ne.status!=="success")return console.error("[Scalping] LIMIT order rejected:",Ne),!1;const ae=Ft(Ne);return H({symbol:I,side:s,action:G,orderId:ae,quantity:g*x,entryPrice:v,tpPoints:l,slPoints:u}),O(null),w(v),!0}catch(ne){return console.error("[Scalping] LIMIT order failed:",ne),!1}finally{ee.current=!1}},[I,P,f,s,g,x,l,u,k,st,D,j,Y,O,w,H]);d.useEffect(()=>{const v=e.current,G=t.current;if(!v||!G)return;if(!(ge&&ve&&!V&&!ie&&!Pe&&p==null)){oe(U,Q);return}const ye=Ne=>{if(!Ne.point){oe(U,Q);return}const ae=G.coordinateToPrice(Ne.point.y);if(ae==null){oe(U,Q);return}const be=We(ae);le(U,Q,be,"#a1a1aa",gt.Dashed,1,be.toFixed(2))};return v.subscribeCrosshairMove(ye),()=>{v.unsubscribeCrosshairMove(ye),oe(U,Q)}},[e,t,ge,ve,V,ie,Pe,p,oe,le]),d.useEffect(()=>{const v=e.current,G=t.current;if(!v||!G||!I||!ge||!ve)return;const ne=ye=>{if(!ye.point)return;const Ne=G.coordinateToPrice(ye.point.y);if(Ne==null)return;const ae=We(Ne);if(c==="TRIGGER"){const be=m??ie?.action;if(!be){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const me=Ve(be,ae);if(!me.ok){console.warn(`[Scalping] ${me.message}`);return}const Re=De(be);ie?T(ie.id,{triggerPrice:ae,action:be,direction:Re,quantity:g*x,tpPoints:l,slPoints:u}):J({id:`trigger-${Date.now()}`,symbol:I,exchange:f,side:s,action:be,triggerPrice:ae,direction:Re,quantity:g*x,tpPoints:l,slPoints:u,createdAt:Date.now()}),w(ae),O(null)}else{if(Pe){console.warn("[Scalping] LIMIT already placed for this symbol. Cancel/close it before placing another.");return}if(!m){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}if(V)return;w(ae),St(ae,m)}oe(U,Q),pe()};return v.subscribeClick(ne),()=>{v.unsubscribeClick(ne)}},[e,t,I,ge,ve,c,m,V,ie,Pe,g,x,l,u,f,s,J,T,w,O,De,Ve,St,oe,pe]),d.useEffect(()=>{if(!t.current)return;const v=()=>{oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null)};if(V){const G=V.action==="BUY"?"#00ff88":"#ff4560";le(_,y,We(V.entryPrice),G,gt.Dotted,2,`${V.action} @ ${V.entryPrice.toFixed(2)}`),V.tpPrice!=null?le(q,A,We(V.tpPrice),"#00ff88",gt.Dashed,1,`TP @ ${V.tpPrice.toFixed(2)}`):oe(q,A),V.slPrice!=null?le(N,z,We(V.slPrice),"#ff4560",gt.Dashed,1,`SL @ ${V.slPrice.toFixed(2)}`):oe(N,z),pe();return}if(ie){const{tpPrice:G,slPrice:ne}=Rs(ie),ye=We(ie.triggerPrice);le(_,y,ye,"#ffa500",gt.Dashed,2,`TRIGGER ${ie.action} @ ${ye.toFixed(2)}`),G!=null?le(q,A,G,"#00ff88",gt.Dashed,1,`TP @ ${G.toFixed(2)}`):oe(q,A),ne!=null?le(N,z,ne,"#ff4560",gt.Dashed,1,`SL @ ${ne.toFixed(2)}`):oe(N,z),pe();return}if(ge&&ve&&He){const G=ze,ne=Pe?h?.tpPoints??l:l,ye=Pe?h?.slPoints??u:u,Ne=Pe?h?.entryPrice??p:p;if(Ne==null){v();return}const ae=We(Ne);if(le(_,y,ae,c==="LIMIT"?"#06b6d4":"#ffa500",gt.Dashed,2,`${c} ${G} @ ${ae.toFixed(2)}`),ne>0){const me=We(ae+(G==="BUY"?ne:-ne));le(q,A,me,"#00ff88",gt.Dashed,1,`TP @ ${me.toFixed(2)}`)}else oe(q,A);if(ye>0){const me=We(ae+(G==="BUY"?-ye:ye));le(N,z,me,"#ff4560",gt.Dashed,1,`SL @ ${me.toFixed(2)}`)}else oe(N,z);pe();return}v()},[t,V,ie,ge,ve,He,p,ze,h,Pe,c,l,u,oe,le,pe]),d.useEffect(()=>{},[V,Ct]),d.useEffect(()=>{const v=e.current;if(!v)return;const G=()=>pe();v.subscribeCrosshairMove(G);const ne=v.timeScale();return ne.subscribeVisibleLogicalRangeChange(G),()=>{v.unsubscribeCrosshairMove(G),ne.unsubscribeVisibleLogicalRangeChange(G)}},[e,pe]),d.useEffect(()=>{const v=r.current;if(!v)return;const G=()=>{!_.current&&!q.current&&!N.current||pe()},ne=window.setInterval(G,100);return v.addEventListener("wheel",G,{passive:!0}),v.addEventListener("mousemove",G),window.addEventListener("resize",G),()=>{window.clearInterval(ne),v.removeEventListener("wheel",G),v.removeEventListener("mousemove",G),window.removeEventListener("resize",G)}},[r,pe]),d.useEffect(()=>{V||ie||Pe||m==null&&(p==null&&!_.current&&!q.current&&!N.current||(oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null),w(null)))},[V,ie,Pe,m,p,oe,w]),d.useEffect(()=>()=>{oe(U,Q),oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null)},[I,oe]),d.useEffect(()=>{c==="MARKET"&&(V||ie||(oe(U,Q),oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null),w(null),O(null),Y()))},[c,V,ie,oe,w,O,Y]);const dt=d.useCallback((v,G)=>{if(G.preventDefault(),G.stopPropagation(),!Be||!(v==="entry"?_:v==="tp"?q:N).current)return;Te.current={type:v,source:Be};const ye=ae=>{const be=Te.current,me=t.current,Re=r.current;if(!be||!me||!Re)return;const qe=Re.getBoundingClientRect(),Vt=ae.clientY-qe.top,de=me.coordinateToPrice(Vt);if(de==null)return;const ot=We(de),qt=be.type==="entry"?_:be.type==="tp"?q:N;if(qt.current){if(be.type==="entry"?be.source==="trigger"?`${ie?.action??"BUY"}${ot.toFixed(2)}`:be.source==="pending"?`${c}${ze}${ot.toFixed(2)}`:be.source==="position"?`${V?.action??ze}${ot.toFixed(2)}`:qt.current.options().title??ot.toFixed(2):be.type==="tp"?`${ot.toFixed(2)}`:`${ot.toFixed(2)}`,qt.current.applyOptions({price:ot,title:""}),be.type==="entry"){const ke=be.source==="trigger"?ie?.action??ze:be.source==="position"?V?.action??ze:ze,Ye=be.source==="trigger"?ie?.tpPoints??0:be.source==="position"?V?.tpPoints??0:l,Je=be.source==="trigger"?ie?.slPoints??0:be.source==="position"?V?.slPoints??0:u;if(Ye>0&&q.current){const ht=We(ot+(ke==="BUY"?Ye:-Ye));q.current.applyOptions({price:ht,title:""})}if(Je>0&&N.current){const ht=We(ot+(ke==="BUY"?-Je:Je));N.current.applyOptions({price:ht,title:""})}}pe()}},Ne=()=>{const ae=Te.current;if(!ae)return;const me=(ae.type==="entry"?_:ae.type==="tp"?q:N).current?.options().price;if(me!=null){if(ae.source==="position"&&V){const Re=ae.type==="entry"?{entryPrice:me,tpPrice:V.tpPrice!=null?We(V.tpPrice+(me-V.entryPrice)):null,slPrice:V.slPrice!=null?We(V.slPrice+(me-V.entryPrice)):null}:ae.type==="tp"?{tpPrice:me,tpPoints:Nt(Math.abs(me-V.entryPrice))}:ae.type==="sl"?{slPrice:me,slPoints:Nt(Math.abs(V.entryPrice-me))}:null;Re&&C(V.id,Re)}if(ae.source==="trigger"&&ie){if(ae.type==="entry"){const Re=Ve(ie.action,me);if(Re.ok)T(ie.id,{triggerPrice:me,direction:De(ie.action)}),w(me);else{console.warn(`[Scalping] ${Re.message}`);const qe=We(ie.triggerPrice);_.current?.applyOptions({price:qe,title:""});const{tpPrice:Vt,slPrice:de}=Rs(ie);q.current&&Vt!=null&&q.current.applyOptions({price:Vt,title:""}),N.current&&de!=null&&N.current.applyOptions({price:de,title:""}),w(qe)}}ae.type==="tp"&&T(ie.id,{tpPoints:Nt(Math.abs(me-ie.triggerPrice))}),ae.type==="sl"&&T(ie.id,{slPoints:Nt(Math.abs(ie.triggerPrice-me))})}if(ae.source==="pending"){const Re=_.current?.options().price??p??me;if(Pe&&h){const qe={...h};ae.type==="entry"&&(qe.entryPrice=me,w(me),Xe({orderId:qe.orderId,symbol:qe.symbol,action:qe.action,quantity:qe.quantity},me,!0)),ae.type==="tp"&&(qe.tpPoints=Nt(Math.abs(me-Re))),ae.type==="sl"&&(qe.slPoints=Nt(Math.abs(Re-me))),H(qe)}else ae.type==="entry"&&w(me),ae.type==="tp"&&M(Nt(Math.abs(me-Re))),ae.type==="sl"&&$(Nt(Math.abs(Re-me)))}}pe(),Te.current=null,document.removeEventListener("mousemove",ye),document.removeEventListener("mouseup",Ne)};document.addEventListener("mousemove",ye),document.addEventListener("mouseup",Ne)},[Be,t,r,V,ie,ze,c,p,Pe,h,l,u,Xe,C,T,De,Ve,pe,H,w,M,$]),Pt=d.useCallback(async()=>{if(Pe&&h?.orderId&&!P)try{const v=await we.cancelOrder(h.orderId);if(v.status!=="success"){console.error("[Scalping] Failed to cancel LIMIT order:",v);return}}catch(v){console.error("[Scalping] Failed to cancel LIMIT order:",v);return}oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null),V&&b(V.symbol),ie&&L(ie.id),Pe&&!h?.orderId&&!P&&console.warn("[Scalping] Pending LIMIT has no broker orderId; cleared local lines only."),Y(),w(null),O(null)},[V,ie,Pe,h,P,oe,b,L,Y,w,O]),jt=d.useCallback(v=>{if(oe(v==="tp"?q:N,v==="tp"?A:z),v==="tp"?fe(null):Me(null),V){C(V.id,v==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(ie){T(ie.id,v==="tp"?{tpPoints:0}:{slPoints:0});return}v==="tp"?M(0):$(0)},[V,ie,oe,M,$,C,T]),nn=d.useCallback(async()=>{if(!(!V||Z)){re(!0);try{if(P)console.log(`[Paper] Close ${V.action} ${V.symbol}`);else{const v=await we.closePosition(V.symbol,V.exchange,k);if(v.status!=="success"){console.error("[Scalping] Close position rejected:",v);return}}b(V.symbol),oe(_,y),oe(q,A),oe(N,z),se(null),fe(null),Me(null)}catch(v){console.error("[Scalping] Close position failed:",v)}finally{re(!1)}}},[V,Z,P,k,b,oe]);if(!r.current)return null;const rt=!!V,vt=rt?V.action==="BUY"?"green":"red":c==="LIMIT"?"cyan":"orange",_t=rt?`${V.action} @ ${X?.price.toFixed(2)??"--"}`:ie?`TRIGGER ${ie.action} @ ${X?.price.toFixed(2)??"--"}`:`${c} ${ze} @ ${X?.price.toFixed(2)??"--"}`,Bt={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[vt],Lt={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[vt],je=Be!==null;return n.jsxs(n.Fragment,{children:[X&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:X.y},children:[n.jsx("div",{className:Ke("absolute left-0 right-0 top-0 h-px -translate-y-1/2",Lt)}),n.jsx("div",{className:Ke("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",je?"cursor-ns-resize":"cursor-default"),onMouseDown:je?v=>dt("entry",v):void 0}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsx("span",{className:Ke("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Bt),children:_t}),rt&&Ge&&n.jsxs("span",{className:Ke("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Ge.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",Ge.ltp.toFixed(2)," | PnL ",Ge.pnl>=0?"+":"",Ge.pnl.toFixed(2)]}),rt&&n.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:v=>{v.stopPropagation(),nn()},disabled:Z,title:"Close position at market",children:Z?"...":"Close"}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-border/70 bg-card/95 text-foreground/90 hover:text-destructive hover:bg-destructive/10 shadow-sm",onClick:v=>{v.stopPropagation(),Pt()},title:rt?"Remove virtual position tracking":"Cancel pending order",children:"×"})]})]}),ue&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:ue.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>dt("tp",v)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",ue.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-green-500/40 bg-card/95 text-green-300 hover:text-green-200 hover:bg-green-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),jt("tp")},title:"Remove TP line",children:"×"})]})]}),Se&&n.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:Se.y},children:[n.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),n.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:v=>dt("sl",v)}),n.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[n.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",Se.price.toFixed(2)]}),n.jsx("button",{type:"button",className:"text-[11px] font-black w-5 h-5 flex items-center justify-center rounded-sm border border-red-500/40 bg-card/95 text-red-300 hover:text-red-200 hover:bg-red-500/15 shadow-sm",onClick:v=>{v.stopPropagation(),jt("sl")},title:"Remove SL line",children:"×"})]})]})]})}const sa=120,ra=1,ia=10,aa=40,oa=3e4,la=120,ca=5e3;function wn(e){return e.map(t=>({time:t.time,value:t.value}))}function ua(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function da(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Is(e){const t=e.getFullYear(),s=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${s}-${r}`}function te(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function Tn(e){if(!Number.isFinite(e))return"0";const t=Math.abs(e);return t>=1e6?`${(e/1e6).toFixed(2)}M`:t>=1e3?`${(e/1e3).toFixed(1)}K`:t>=100?e.toFixed(0):t>=10?e.toFixed(1):t>0?e.toFixed(2):"0"}const As={buyFlow:0,sellFlow:0,delta:0,cumulativeDelta:0,dominance:"BAL",depthImbalancePct:null,spread:null,flowSource:"EST",lastUpdate:0};function pa(e){return te(e.ltp)??te(e.last_price)??te(e.lp)??te(e.price)??te(e.close)}function ma(e){return te(e.volume)??te(e.total_volume)??te(e.v)??te(e.ttq)}function fa(e){return te(e.bid_price)??te(e.bid)??te(e.bp)??te(e.best_bid_price)??te(e.bp1)}function xa(e){return te(e.ask_price)??te(e.ask)??te(e.sp)??te(e.best_ask_price)??te(e.sp1)}function ha(e){return te(e.bid_size)??te(e.bid_qty)??te(e.total_buy_quantity)??te(e.total_buy_qty)??te(e.totalbuyqty)??te(e.buy_quantity)??te(e.tbq)??te(e.bq1)}function ga(e){return te(e.ask_size)??te(e.ask_qty)??te(e.total_sell_quantity)??te(e.total_sell_qty)??te(e.totalsellqty)??te(e.sell_quantity)??te(e.tsq)??te(e.sq1)}function $s(e){if(!e||typeof e!="object")return 0;const t=e,s=te(t.price)??te(t.px);return s!=null&&s>0?s:0}function kn(e){if(!e||typeof e!="object")return 0;const t=e,s=te(t.quantity)??te(t.qty)??te(t.size)??te(t.volume);return s!=null&&s>0?s:0}function ya(e,t){const s=Math.max(0,t.buyFlow+t.sellFlow);if(s<=0)return{action:"HOLD",label:"HOLD FOR NOW"};const r=Math.abs(t.delta)/Math.max(1,s),a=t.delta===0?!1:Math.sign(t.delta)===Math.sign(t.cumulativeDelta)&&Math.abs(t.cumulativeDelta)>=Math.abs(t.delta)*.35,i=t.flowSource==="VOL"?1e3:250,o=t.flowSource==="VOL"?.12:.22;if(!a||s<i||r<o)return{action:"HOLD",label:"HOLD FOR NOW"};const c=t.delta>0&&t.cumulativeDelta>0,l=t.delta<0&&t.cumulativeDelta<0;return c?e==="CE"?{action:"BUY_CE",label:"BUY CE NOW"}:{action:"BUY_PE",label:"BUY PE NOW"}:l?e==="CE"?{action:"BUY_PE",label:"BUY PE NOW"}:{action:"BUY_CE",label:"BUY CE NOW"}:{action:"HOLD",label:"HOLD FOR NOW"}}function rs(e){const t=yt(e);return t??null}function ba(e){if(!e?.length)return[];const t=[];for(const i of e){const o=yt(i.timestamp)??yt(i.time)??yt(i.datetime)??yt(i.date),c=te(i.open),l=te(i.high),u=te(i.low),p=te(i.close),m=te(i.volume)??0;o==null||c==null||l==null||u==null||p==null||t.push({time:o,open:c,high:l,low:u,close:p,volume:m})}if(t.length===0)return[];t.sort((i,o)=>Number(i.time)-Number(o.time));const s=new Map;for(const i of t)s.set(Number(i.time),i);const r=Array.from(s.values()).slice(-500),a=r.filter(i=>ns(Number(i.time),{includeClose:!0}));return(a.length>0?a:r).slice(-500)}function Wt(e){return e.map(t=>({...t}))}function va(e,t){const s=new Map;for(const r of e)s.set(Number(r.time),r);for(const r of t)s.set(Number(r.time),r);return Array.from(s.values()).sort((r,a)=>Number(r.time)-Number(a.time)).slice(-500)}function _n(e){const t=[];for(const s of e){const r=rs(s.time);r!=null&&t.push({time:r,open:s.open,high:s.high,low:s.low,close:s.close})}return t.sort((s,r)=>Number(s.time)-Number(r.time)),t}function Os(e){if(!e.length)return[];const t=new Map;for(const s of e){const r=rs(s.time),a=te(s.open),i=te(s.high),o=te(s.low),c=te(s.close),l=te(s.volume)??0;r==null||a==null||i==null||o==null||c==null||t.set(Number(r),{time:r,open:a,high:i,low:o,close:c,volume:l})}return Array.from(t.values()).sort((s,r)=>Number(s.time)-Number(r.time)).slice(-500)}function Fs({side:e,showEma9:t,showEma21:s,showSupertrend:r,showVwap:a,showOrderFlow:i}){const o=d.useRef(null),c=d.useRef(null),l=d.useRef(null),u=d.useRef(null),p=d.useRef(null),m=d.useRef(null),h=d.useRef(null),g=d.useRef([]),x=d.useRef(new Map),f=d.useRef(null),k=d.useRef(0),P=d.useRef(null),j=d.useRef({lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0}),[w,M]=d.useState(As),[$,O]=d.useState(()=>Date.now()),H=d.useRef({showEma9:t,showEma21:s,showSupertrend:r,showVwap:a}),Y=Ae(B=>B.apiKey),I=Ae(B=>B.setApiKey),E=tr(B=>B.mode==="dark"),K=S(B=>B.activeSide),J=S(B=>B.setActiveSide),T=S(B=>B.optionExchange),L=S(B=>B.chartInterval),D=S(B=>e==="CE"?B.selectedCESymbol:B.selectedPESymbol),b=K===e,C=d.useMemo(()=>i&&D?[{symbol:D,exchange:T}]:[],[i,D,T]),{data:U}=pn({symbols:C,mode:"Quote",enabled:i&&!!D}),{data:_}=pn({symbols:C,mode:"LTP",enabled:i&&!!D}),{data:q}=pn({symbols:C,mode:"Depth",enabled:i&&!!D}),N=d.useMemo(()=>ya(e,w),[e,w]),Q=d.useMemo(()=>!i||!D||w.lastUpdate<=0?!1:$-w.lastUpdate>ca,[$,w.lastUpdate,i,D]);d.useEffect(()=>{if(!i||!D)return;const B=setInterval(()=>O(Date.now()),1e3);return()=>clearInterval(B)},[i,D]),d.useEffect(()=>{j.current={lastLtp:null,lastVolume:null,lastBidSize:null,lastAskSize:null,lastTickAt:0,cumulativeDelta:0,buckets:[],lastEmitAt:0},M(As)},[i,D,T]),d.useEffect(()=>{if(!i||!D)return;const B=`${T.toUpperCase()}:${D.toUpperCase()}`,Z=U.get(B),re=_.get(B),ee=q.get(B),Ee=[Z,re,ee].filter(je=>!!je),F=Ee.reduce((je,v)=>je?(v.lastUpdate??0)>=(je.lastUpdate??0)?v:je:v,Ee[0]??null);if(!Z?.data&&!re?.data&&!ee?.data)return;const he={...Z?.data??{},...re?.data??{},...ee?.data??{}},$e=pa({...he,...F?.data??{}});if($e==null||$e<=0)return;const Te=F?.lastUpdate??Date.now(),ge=j.current,ve=ge.lastLtp,Ue=Te>ge.lastTickAt,V=ma(he),ie=ge.lastVolume;let Pe=[],He=[];if(he.depth&&typeof he.depth=="object"){const je=he.depth;Pe=Array.isArray(je.buy)?je.buy:[],He=Array.isArray(je.sell)?je.sell:[]}const Be=Pe.length>0?$s(Pe[0]):0,ze=He.length>0?$s(He[0]):0,Ge=fa(he)??(Be>0?Be:null),nt=xa(he)??(ze>0?ze:null),Ct=Pe.length>0?kn(Pe[0]):0,oe=He.length>0?kn(He[0]):0,le=ha(he),Ce=ga(he),pe=le!=null&&le>0?le:Ct>0?Ct:null,Fe=Ce!=null&&Ce>0?Ce:oe>0?oe:null;let De=0,Ve=0,st=!1,bt=!1,Xe=0;if(V!=null&&ie!=null&&Number.isFinite(V)&&Number.isFinite(ie)&&V>=ie?Xe=Math.max(0,V-ie):V!=null&&ie==null&&(Xe=0),Xe>0)if(bt=!0,ve!=null&&$e>ve)De=Xe;else if(ve!=null&&$e<ve)Ve=Xe;else if(Ge!=null&&nt!=null&&nt>Ge){const je=(Ge+nt)/2;$e>=je?De=Xe:Ve=Xe}else De=Xe*.5,Ve=Xe*.5,st=!0;if(De<=0&&Ve<=0){const je=ge.lastBidSize,v=ge.lastAskSize,G=v!=null&&Fe!=null?Math.max(0,v-Fe):0,ne=je!=null&&pe!=null?Math.max(0,je-pe):0,ye=je!=null&&pe!=null?Math.max(0,pe-je):0,Ne=v!=null&&Fe!=null?Math.max(0,Fe-v):0;let ae=G+ye*.35,be=ne+Ne*.35;ve!=null&&$e>ve&&(ae+=1),ve!=null&&$e<ve&&(be+=1);const me=ae+be;if(me>0){st=!0;const Re=Math.max(1,Math.min(12,Math.sqrt(me)));if(ae>be)De=Re;else if(be>ae)Ve=Re;else if(pe!=null&&Fe!=null&&pe+Fe>0){const qe=(pe-Fe)/(pe+Fe);qe>0?De=Math.max(1,Re*Math.abs(qe)):qe<0&&(Ve=Math.max(1,Re*Math.abs(qe)))}}}De<=0&&Ve<=0&&ve!=null&&(st=!0,$e>ve?De=1:$e<ve&&(Ve=1)),De<=0&&Ve<=0&&Ue&&(st=!0,De=.35,Ve=.35),ge.lastLtp=$e,ge.lastTickAt=Te,V!=null&&Number.isFinite(V)&&V>=0&&(ge.lastVolume=V),pe!=null&&Number.isFinite(pe)&&pe>=0&&(ge.lastBidSize=pe),Fe!=null&&Number.isFinite(Fe)&&Fe>=0&&(ge.lastAskSize=Fe),(De>0||Ve>0)&&(ge.buckets.push({ts:Te,buy:De,sell:Ve}),ge.cumulativeDelta+=De-Ve);const St=Te-oa;ge.buckets=ge.buckets.filter(je=>je.ts>=St);const dt=ge.buckets.reduce((je,v)=>je+v.buy,0),Pt=ge.buckets.reduce((je,v)=>je+v.sell,0),jt=dt-Pt,nn=jt>0?"BUY":jt<0?"SELL":"BAL";let rt=0,vt=0;Pe.length||He.length?(rt=Pe.slice(0,5).reduce((je,v)=>je+kn(v),0),vt=He.slice(0,5).reduce((je,v)=>je+kn(v),0)):(rt=pe&&pe>0?pe:0,vt=Fe&&Fe>0?Fe:0);const _t=rt+vt,Bt=_t>0?(rt-vt)/_t*100:null,Lt=Ge!=null&&nt!=null&&nt>=Ge?nt-Ge:null;Te-ge.lastEmitAt<la||(ge.lastEmitAt=Te,M({buyFlow:dt,sellFlow:Pt,delta:jt,cumulativeDelta:ge.cumulativeDelta,dominance:nn,depthImbalancePct:Bt,spread:Lt,flowSource:bt&&!st?"VOL":"EST",lastUpdate:Te}))},[q,_,U,T,i,D]);const y=d.useCallback(()=>{const B=g.current,Z=H.current,re=B.map(ee=>({time:ee.time,value:ee.close}));u.current&&u.current.setData(Z.showEma9?wn(In(re,9)):[]),p.current&&p.current.setData(Z.showEma21?wn(In(re,21)):[]),m.current&&m.current.setData(Z.showSupertrend?wn(Lr(B,10,3).trend):[]),h.current&&h.current.setData(Z.showVwap?wn(Mr(B)):[])},[]),A=d.useCallback(()=>{P.current===null&&(P.current=setTimeout(()=>{P.current=null,y()},sa))},[y]),z=d.useCallback(()=>{g.current=[],l.current?.setData([]),u.current?.setData([]),p.current?.setData([]),m.current?.setData([]),h.current?.setData([])},[]),X=d.useCallback(B=>{const Z=Os(B);g.current=Wt(Z),l.current?.setData(_n(Z)),A()},[A]),se=d.useCallback(async()=>{if(Y)return Y;try{const Z=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(Z.status==="success"&&Z.api_key)return I(Z.api_key),Z.api_key}catch{}return null},[Y,I]),ue=d.useCallback(()=>{J(e)},[e,J]),fe=d.useCallback((B,Z)=>{if(!l.current)return;const re=rs(B.time),ee=te(B.open),Ee=te(B.high),F=te(B.low),he=te(B.close),$e=te(B.volume)??0;if(re==null||ee==null||Ee==null||F==null||he==null)return;const Te={time:re,open:ee,high:Ee,low:F,close:he,volume:$e},ge=Number(Te.time),ve=g.current.length?Number(g.current[g.current.length-1].time):null;if(ve!=null&&Number.isFinite(ve)&&Number.isFinite(ge)&&ge<ve)return;try{l.current.update({time:Te.time,open:Te.open,high:Te.high,low:Te.low,close:Te.close})}catch{const V=Os([...g.current,Te]);g.current=V,l.current.setData(_n(V)),A();return}Z?(g.current.push(Te),g.current.length>500&&(g.current=g.current.slice(-500))):g.current.length>0?g.current[g.current.length-1]=Te:g.current.push(Te);const Ue=f.current;Ue&&x.current.set(Ue,Wt(g.current)),A()},[A]),{isConnected:Se,reset:Me,seed:R}=Cr({symbol:D??"",exchange:T,intervalSec:L,mode:"Quote",enabled:!!D,useIndiaMarketHours:!0,onCandleUpdate:fe});return d.useEffect(()=>{const B=f.current;if(B&&g.current.length>0&&x.current.set(B,Wt(g.current)),!D){f.current=null,Me(),z();return}const Z=`${T}:${D}:${L}`;f.current=Z;const re=x.current.get(Z);if(re&&re.length>0){Me(),R(re),X(re);return}Me(),z();const ee=++k.current,Ee=da(L),F=new Date,he=new Date(F.getTime());he.setDate(he.getDate()-ra),(async()=>{const Te=await se();if(!Te){ee===k.current&&z();return}try{const ge=async()=>{try{const Be=await we.getQuotes(Te,D,T);if(Be.status!=="success"||!Be.data)return null;const ze=te(Be.data.ltp);if(ze==null||ze<=0)return null;const Ge=Math.floor(Date.now()/1e3);return{time:Math.floor(Ge/L)*L,open:ze,high:ze,low:ze,close:ze,volume:te(Be.data.volume)??0}}catch{return null}},ve=async Be=>{try{const ze=await we.getHistory(Te,D,T,Ee,Is(he),Is(F),Be);return ze.status==="success"?ba(ze.data):[]}catch{return[]}},Ue=await ve("api"),V=Ue.length>0?Ue:await ve("db");if(ee!==k.current)return;const ie=f.current===Z?Wt(g.current):[],Pe=va(V,ie);if(Pe.length>0){x.current.set(Z,Wt(Pe)),R(Pe),X(Pe);return}const He=await ge();if(He&&ee===k.current){const Be=[He];x.current.set(Z,Wt(Be)),R(Be),X(Be);return}}catch{}ee===k.current&&z()})()},[D,T,L,se,Me,R,z,X]),d.useEffect(()=>{H.current={showEma9:t,showEma21:s,showSupertrend:r,showVwap:a},u.current?.applyOptions({visible:t}),p.current?.applyOptions({visible:s}),m.current?.applyOptions({visible:r}),h.current?.applyOptions({visible:a}),A()},[t,s,r,a,A]),d.useEffect(()=>{const B=o.current;if(!B)return;const Z=ua(E),re=Rr(ia,aa),ee=ar(B,{width:B.offsetWidth,height:B.offsetHeight,layout:{background:{type:lr.Solid,color:Z.bg},textColor:Z.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:Z.grid},horzLines:{color:Z.grid}},rightPriceScale:{borderColor:Z.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:Z.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:ve=>Er(ve)},crosshair:{mode:or.Normal,vertLine:{width:1,color:Z.crosshair,style:2},horzLine:{width:1,color:Z.crosshair,style:2}}}),Ee=ee.addSeries(cr,{upColor:Z.upColor,downColor:Z.downColor,borderVisible:!1,wickUpColor:Z.upColor,wickDownColor:Z.downColor,autoscaleInfoProvider:re}),F=ee.addSeries(wt,{color:Z.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:H.current.showEma9,autoscaleInfoProvider:re}),he=ee.addSeries(wt,{color:Z.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:H.current.showEma21,autoscaleInfoProvider:re}),$e=ee.addSeries(wt,{color:Z.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:H.current.showSupertrend,autoscaleInfoProvider:re}),Te=ee.addSeries(wt,{color:Z.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:H.current.showVwap,autoscaleInfoProvider:re});c.current=ee,l.current=Ee,u.current=F,p.current=he,m.current=$e,h.current=Te,g.current.length>0&&(Ee.setData(_n(g.current)),A());const ge=new ResizeObserver(()=>{if(c.current&&B){const ve=B.offsetWidth,Ue=B.offsetHeight;ve>0&&Ue>0&&c.current.applyOptions({width:ve,height:Ue})}});return ge.observe(B),()=>{P.current!==null&&(clearTimeout(P.current),P.current=null),ge.disconnect(),ee.remove(),c.current=null,l.current=null,u.current=null,p.current=null,m.current=null,h.current=null}},[E,A]),n.jsxs("div",{className:Ke("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",b&&"ring-1 ring-primary/40"),onClick:ue,children:[n.jsx("div",{ref:o,className:"h-full w-full"}),n.jsx(na,{chartRef:c,seriesRef:l,side:e,containerRef:o}),n.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[n.jsx("span",{className:Ke("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),D&&n.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:D}),!D&&n.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),n.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&n.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),s&&n.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&n.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),a&&n.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),i&&D&&n.jsxs("div",{className:"absolute top-7 left-2 pointer-events-none rounded border border-border/70 bg-background/85 backdrop-blur-[1px] px-2 py-1.5 text-[10px] font-mono leading-tight",children:[n.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[n.jsx("span",{className:"text-muted-foreground",children:"FLOW 30s"}),n.jsx("span",{className:Ke(w.flowSource==="VOL"?"text-emerald-500":"text-amber-500"),children:w.flowSource})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-3 gap-y-0.5",children:[n.jsxs("span",{className:"text-green-500",children:["B ",Tn(w.buyFlow)]}),n.jsxs("span",{className:"text-red-500 text-right",children:["S ",Tn(w.sellFlow)]}),n.jsxs("span",{className:Ke(w.delta>0?"text-green-500":w.delta<0?"text-red-500":"text-muted-foreground"),children:["D ",w.delta>=0?"+":"",Tn(w.delta)]}),n.jsxs("span",{className:Ke(w.cumulativeDelta>0?"text-green-500":w.cumulativeDelta<0?"text-red-500":"text-muted-foreground","text-right"),children:["CD ",w.cumulativeDelta>=0?"+":"",Tn(w.cumulativeDelta)]}),n.jsx("span",{className:Ke(w.dominance==="BUY"?"text-green-500":w.dominance==="SELL"?"text-red-500":"text-muted-foreground"),children:w.dominance}),n.jsx("span",{className:Ke(N.action==="BUY_CE"?"text-green-500":N.action==="BUY_PE"?"text-red-500":"text-amber-400","text-right"),children:N.label}),(w.depthImbalancePct!=null||w.spread!=null)&&n.jsxs("span",{className:Ke(w.depthImbalancePct==null?"text-muted-foreground":w.depthImbalancePct>=0?"text-green-500":"text-red-500","text-right"),children:["DEPTH ",w.depthImbalancePct==null?"NA":`${w.depthImbalancePct>=0?"+":""}${w.depthImbalancePct.toFixed(0)}%`]}),(w.depthImbalancePct!=null||w.spread!=null)&&n.jsxs("span",{className:"text-muted-foreground col-span-2",children:["SPR ",w.spread==null?"NA":w.spread.toFixed(2)]}),w.depthImbalancePct==null&&w.spread==null&&n.jsx("span",{className:Ke("col-span-2 text-right",Q?"text-amber-500":"text-muted-foreground"),children:Q?"WS stale / no recent ticks":"No L2 quote"})]})]}),b&&n.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),D&&!Se&&n.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:n.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!D&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:n.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}function Rt(e,t){if(e&&typeof e=="object"){const s=e.message;if(typeof s=="string"&&s.trim().length>0)return s.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function Sa(){const e=Ae(R=>R.apiKey),t=Ae(R=>R.setApiKey),s=S(R=>R.showFloatingWidget),r=S(R=>R.floatingWidgetMinimized),a=S(R=>R.setFloatingWidgetMinimized),i=S(R=>R.activeSide),o=S(R=>R.selectedCESymbol),c=S(R=>R.selectedPESymbol),l=S(R=>R.optionExchange),u=S(R=>R.quantity),p=S(R=>R.lotSize),m=S(R=>R.product),h=S(R=>R.tpPoints),g=S(R=>R.slPoints),x=S(R=>R.orderType),f=S(R=>R.limitPrice),k=S(R=>R.pendingLimitPlacement),P=S(R=>R.setLimitPrice),j=S(R=>R.setPendingEntryAction),w=S(R=>R.setPendingLimitPlacement),M=S(R=>R.clearPendingLimitPlacement),$=S(R=>R.paperMode),O=ce(R=>R.setVirtualTPSL),H=ce(R=>R.clearForSymbol),Y=ce(R=>R.triggerOrders),I=ce(R=>R.removeTriggerOrder),E=S(R=>R.ceWidgetPos),K=S(R=>R.setCeWidgetPos),J=S(R=>R.incrementQuantity),T=S(R=>R.decrementQuantity),L=S(R=>R.setTpPoints),D=S(R=>R.setSlPoints),b=S(R=>R.incrementTradeCount),C=i==="CE"?o:c,[U,_]=d.useState(!1),[q,N]=d.useState(null),[Q,y]=d.useState(null),A=d.useRef(null),z=d.useRef(null);d.useEffect(()=>{if(!C){N(null),y(null);return}const B=xn.getInstance().subscribe(C,l,"LTP",Z=>{const re=Z.data.ltp;re!=null&&re>0&&(y(q),N(re))});return()=>{B()}},[C,l]);const X=d.useCallback(R=>{if(R.target.closest("button, input"))return;R.preventDefault(),A.current={startX:R.clientX,startY:R.clientY,origX:E.x,origY:E.y};const B=re=>{if(!A.current)return;const ee=re.clientX-A.current.startX,Ee=re.clientY-A.current.startY;K({x:Math.max(0,A.current.origX+ee),y:Math.max(0,A.current.origY+Ee)})},Z=()=>{A.current=null,document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",Z)};document.addEventListener("mousemove",B),document.addEventListener("mouseup",Z)},[E,K]),se=d.useCallback(async()=>{if(e)return e;try{const B=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(B.status==="success"&&B.api_key)return t(B.api_key),B.api_key}catch(R){console.error("[Scalping] Failed to fetch API key:",R),Ie.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ie.error("API key missing. Generate one on /apikey"),null},[e,t]),ue=d.useCallback(async R=>{if(!C||U){C||(console.warn("[Scalping] No symbol selected — click a strike first"),Ie.error("Select a strike first"));return}if(_(!0),x==="TRIGGER"){const ee=Object.values(Y).find(Ee=>Ee.symbol===C&&Ee.exchange===l&&Ee.side===i);ee&&I(ee.id),M(),P(null),j(R),console.log(`[Scalping] TRIGGER armed (${R}) — click chart to place trigger line`),_(!1);return}if(x==="LIMIT"&&!f){j(R),console.log(`[Scalping] LIMIT armed (${R}) — click chart to set limit line`),_(!1);return}if(x==="LIMIT"&&k&&k.symbol===C&&k.side===i){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ie.error("A LIMIT order is already pending for this symbol"),_(!1);return}if($){if(console.log(`[Paper] ${R} ${i} ${C} qty=${u*p} @ ${x}`),x==="MARKET"||x==="LIMIT"){const ee=await tn({symbol:C,exchange:l,preferredPrice:x==="LIMIT"?f??q??void 0:q??void 0});ee>0&&(O(xt({symbol:C,exchange:l,side:i,action:R,entryPrice:ee,quantity:u*p,tpPoints:h,slPoints:g,managedBy:"manual"})),x==="LIMIT"&&P(null))}M(),b(),_(!1);return}const B=await se();if(!B){_(!1);return}const Z=x==="LIMIT"?"LIMIT":"MARKET",re={apikey:B,strategy:"Scalping",exchange:l,symbol:C,action:R,quantity:u*p,pricetype:Z,product:m,price:x==="LIMIT"&&f?f:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${R} ${C} qty=${u*p} ${Z}`);const ee=await we.placeOrder(re);if(ee.status==="success"){const Ee=Ft(ee);if(console.log(`[Scalping] Order placed: ${R} ${C} id=${Ee??"n/a"}`),j(null),Z==="LIMIT"){const F=f??q??0;F<=0&&console.warn("[Scalping] LIMIT order acknowledged without a usable entry price; keeping existing line state."),w({symbol:C,side:i,action:R,orderId:Ee,quantity:u*p,entryPrice:F,tpPoints:h,slPoints:g}),F>0&&P(F),_(!1);return}if(M(),b(),Z==="MARKET"){const F=await zt({symbol:C,exchange:l,orderId:Ee,preferredPrice:q??void 0,apiKey:B});F>0&&O(xt({symbol:C,exchange:l,side:i,action:R,entryPrice:F,quantity:u*p,tpPoints:h,slPoints:g,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",ee),Ie.error(Rt(ee,"Order was rejected"))}catch(ee){console.error("[Scalping] Order failed:",ee),Ie.error(Rt(ee,"Order placement failed"))}_(!1)},[C,i,u,p,l,m,x,f,k,h,g,$,H,Y,U,q,se,b,w,O,I,P,j,M]),fe=d.useCallback(async()=>{if(!C||U)return;if(_(!0),$){console.log(`[Paper] Reversal ${i} ${C}`),b(),_(!1);return}const R=await se();if(!R){_(!1);return}try{const B={apikey:R,strategy:"Scalping",exchange:l,symbol:C,action:"SELL",quantity:u*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0},Z=await we.placeOrder(B);if(Z.status!=="success"){Ie.error(Rt(Z,"Reversal close leg failed")),_(!1);return}const re={apikey:R,strategy:"Scalping",exchange:l,symbol:C,action:"SELL",quantity:u*p,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0},ee=await we.placeOrder(re);if(ee.status!=="success"){Ie.error(Rt(ee,"Reversal open leg failed")),_(!1);return}console.log(`[Scalping] Reversed ${i} ${C}`),b()}catch(B){console.error("[Scalping] Reversal failed:",B),Ie.error(Rt(B,"Reversal failed"))}_(!1)},[C,i,u,p,l,m,$,U,se,b]),Se=d.useCallback(async()=>{if(C){if($){console.log(`[Paper] Close ${i} ${C}`),H(C),P(null),j(null),M();return}try{const R=await we.closePosition(C,l,m);R.status==="success"?(console.log(`[Scalping] Closed ${i} ${C}`),H(C),P(null),j(null),M()):(console.error("[Scalping] Close rejected:",R),Ie.error(Rt(R,"Close position rejected")))}catch(R){console.error("[Scalping] Close failed:",R),Ie.error(Rt(R,"Close position failed"))}}},[C,i,l,m,$,H,P,j,M]);if(!s||!C)return null;const Me=q&&Q?q>Q?"up":q<Q?"down":"flat":"flat";return r?n.jsx("div",{ref:z,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-md border shadow-md backdrop-blur-sm bg-card/90 border-primary/40",style:{left:E.x,top:E.y},children:n.jsxs("div",{className:"flex items-center gap-2 px-2 py-1",children:[n.jsx("span",{className:`text-[10px] font-bold ${i==="CE"?"text-green-500":"text-red-500"}`,children:i}),n.jsx("span",{className:"text-[10px] font-mono text-muted-foreground max-w-[72px] truncate",children:C.slice(-10)}),n.jsx("span",{className:`text-xs font-bold tabular-nums ${Me==="up"?"text-green-500":Me==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),n.jsx(Le,{size:"sm",variant:"outline",className:"h-5 px-1.5 text-[10px]",onClick:()=>a(!1),title:"Open trade widget",children:"Open"})]})}):n.jsxs("div",{ref:z,onMouseDown:X,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:E.x,top:E.y,minWidth:220},children:[n.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[n.jsx("span",{className:`text-xs font-bold ${i==="CE"?"text-green-500":"text-red-500"}`,children:i}),n.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:C.slice(-10)}),n.jsx("span",{className:`text-sm font-bold tabular-nums ${Me==="up"?"text-green-500":Me==="down"?"text-red-500":"text-foreground"}`,children:q?.toFixed(2)??"--"}),n.jsx(Le,{size:"sm",variant:"ghost",className:"h-5 px-1 text-[10px]",onClick:()=>a(!0),title:"Minimize widget",children:"_"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[n.jsx(Le,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>ue("BUY"),disabled:U,children:"BUY"}),n.jsx(Le,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>ue("SELL"),disabled:U,children:"SELL"}),n.jsx(Le,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:fe,disabled:U,children:"REV"})]}),n.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:T,children:"-"}),n.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:u}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:J,children:"+"}),n.jsx("div",{className:"flex-1"}),n.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),n.jsx("input",{type:"number",value:h,onChange:R=>L(Number.parseFloat(R.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),n.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),n.jsx("input",{type:"number",value:g,onChange:R=>D(Number.parseFloat(R.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),n.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:Se,children:"x Close"})})]})}const Pa=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function ja({showEma9:e,showEma21:t,showSupertrend:s,showVwap:r,showOrderFlow:a,onToggleEma9:i,onToggleEma21:o,onToggleSupertrend:c,onToggleVwap:l,onToggleOrderFlow:u}){const p=S(h=>h.chartInterval),m=S(h=>h.setChartInterval);return n.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Pa.map(h=>n.jsx(Le,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${p===h.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>m(h.sec),children:h.label},h.sec)),n.jsx(Na,{intervalSec:p}),n.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),n.jsx(ln,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),n.jsx(ln,{label:"EMA21",active:t,color:"text-violet-500",onClick:o}),n.jsx(ln,{label:"ST",active:s,color:"text-cyan-500",onClick:c}),n.jsx(ln,{label:"VWAP",active:r,color:"text-pink-500",onClick:l}),n.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),n.jsx(ln,{label:"FLOW",active:a,color:"text-emerald-500",onClick:u})]})}function Na({intervalSec:e}){const[t,s]=d.useState(()=>Bn(e));d.useEffect(()=>{s(Bn(e));const a=setInterval(()=>{s(Bn(e))},250);return()=>clearInterval(a)},[e]);const r=t<=5;return n.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:wa(t,e)})}function Bn(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function wa(e,t){if(t>=3600){const s=Math.floor(e/3600),r=Math.floor(e%3600/60),a=e%60;return`${s}:${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}if(t>=60){const s=Math.floor(e/60),r=e%60;return`${s}:${r.toString().padStart(2,"0")}`}return`${e}s`}function ln({label:e,active:t,color:s,onClick:r}){return n.jsx(Le,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?s:"text-muted-foreground/50"}`,onClick:r,children:e})}function Ta(){const[e,t]=d.useState(!0),[s,r]=d.useState(!0),[a,i]=d.useState(!0),[o,c]=d.useState(!0),[l,u]=d.useState(!1),p=d.useCallback(()=>t(f=>!f),[]),m=d.useCallback(()=>r(f=>!f),[]),h=d.useCallback(()=>i(f=>!f),[]),g=d.useCallback(()=>c(f=>!f),[]),x=d.useCallback(()=>u(f=>!f),[]);return n.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[n.jsx(ja,{showEma9:e,showEma21:s,showSupertrend:a,showVwap:o,showOrderFlow:l,onToggleEma9:p,onToggleEma21:m,onToggleSupertrend:h,onToggleVwap:g,onToggleOrderFlow:x}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:n.jsxs(Wn,{orientation:"vertical",children:[n.jsx(It,{defaultSize:"40%",minSize:"18%",children:n.jsx(Yi,{showEma9:e,showEma21:s,showSupertrend:a,showVwap:o})}),n.jsx(Mn,{withHandle:!0}),n.jsx(It,{defaultSize:"60%",minSize:"24%",children:n.jsxs("div",{className:"relative h-full w-full",children:[n.jsxs(Wn,{orientation:"horizontal",children:[n.jsx(It,{defaultSize:"50%",minSize:"20%",children:n.jsx(Fs,{side:"CE",showEma9:e,showEma21:s,showSupertrend:a,showVwap:o,showOrderFlow:l})}),n.jsx(Mn,{withHandle:!0}),n.jsx(It,{defaultSize:"50%",minSize:"20%",children:n.jsx(Fs,{side:"PE",showEma9:e,showEma21:s,showSupertrend:a,showVwap:o,showOrderFlow:l})})]}),n.jsx(Sa,{})]})})]})})]})}function Ht(e,t){if(e&&typeof e=="object"){const s=e.message;if(typeof s=="string"&&s.trim().length>0)return s.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function ka(){const e=Ae(N=>N.apiKey),t=Ae(N=>N.setApiKey),s=S(N=>N.activeSide),r=S(N=>N.selectedCESymbol),a=S(N=>N.selectedPESymbol),i=S(N=>N.optionExchange),o=S(N=>N.quantity),c=S(N=>N.lotSize),l=S(N=>N.product),u=S(N=>N.orderType),p=S(N=>N.tpPoints),m=S(N=>N.slPoints),h=S(N=>N.limitPrice),g=S(N=>N.pendingLimitPlacement),x=S(N=>N.setLimitPrice),f=S(N=>N.setPendingEntryAction),k=S(N=>N.setPendingLimitPlacement),P=S(N=>N.clearPendingLimitPlacement),j=S(N=>N.paperMode),w=ce(N=>N.setVirtualTPSL),M=ce(N=>N.clearForSymbol),$=ce(N=>N.clearAll),O=ce(N=>N.triggerOrders),H=ce(N=>N.removeTriggerOrder),Y=S(N=>N.setQuantity),I=S(N=>N.incrementQuantity),E=S(N=>N.decrementQuantity),K=S(N=>N.setOrderType),J=S(N=>N.setProduct),T=S(N=>N.setTpPoints),L=S(N=>N.setSlPoints),D=S(N=>N.incrementTradeCount),b=s==="CE"?r:a,C=d.useCallback(async()=>{if(e)return e;try{const Q=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(Q.status==="success"&&Q.api_key)return t(Q.api_key),Q.api_key}catch(N){console.error("[Scalping] Failed to fetch API key:",N),Ie.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ie.error("API key missing. Generate one on /apikey"),null},[e,t]),U=d.useCallback(async N=>{if(!b){console.warn("[Scalping] No symbol selected — click a strike first"),Ie.error("Select a strike first");return}if(u==="TRIGGER"){const z=Object.values(O).find(X=>X.symbol===b&&X.exchange===i&&X.side===s);z&&H(z.id),P(),x(null),f(N),console.log(`[Scalping] TRIGGER armed (${N}) — click chart to place trigger line`);return}if(u==="LIMIT"&&!h){f(N),console.log(`[Scalping] LIMIT armed (${N}) — click chart to set limit line`);return}if(u==="LIMIT"&&g&&g.symbol===b&&g.side===s){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ie.error("A LIMIT order is already pending for this symbol");return}if(j){if(console.log(`[Paper] ${N} ${s} ${b} qty=${o*c} @ ${u}`),u==="MARKET"||u==="LIMIT"){const z=await tn({symbol:b,exchange:i,preferredPrice:u==="LIMIT"?h??void 0:void 0});z>0&&(w(xt({symbol:b,exchange:i,side:s,action:N,entryPrice:z,quantity:o*c,tpPoints:p,slPoints:m,managedBy:"manual"})),u==="LIMIT"&&x(null))}P(),D();return}const Q=await C();if(!Q)return;const y=u==="LIMIT"?"LIMIT":"MARKET",A={apikey:Q,strategy:"Scalping",exchange:i,symbol:b,action:N,quantity:o*c,pricetype:y,product:l,price:u==="LIMIT"&&h?h:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${N} ${b} qty=${o*c} ${y}`);const z=await we.placeOrder(A);if(z.status==="success"){const X=Ft(z);if(console.log(`[Scalping] Order placed: ${N} ${b} id=${X??"n/a"}`),f(null),y==="LIMIT"){h==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),k({symbol:b,side:s,action:N,orderId:X,quantity:o*c,entryPrice:h??0,tpPoints:p,slPoints:m}),h!=null&&x(h);return}if(P(),D(),y==="MARKET"){const se=await zt({symbol:b,exchange:i,orderId:X,preferredPrice:void 0,apiKey:Q});se>0&&w(xt({symbol:b,exchange:i,side:s,action:N,entryPrice:se,quantity:o*c,tpPoints:p,slPoints:m,managedBy:"manual"}))}}else console.error("[Scalping] Order rejected:",z),Ie.error(Ht(z,"Order was rejected"))}catch(z){console.error("[Scalping] Order failed:",z),Ie.error(Ht(z,"Order placement failed"))}},[b,s,o,c,i,l,u,h,g,p,m,j,M,O,C,k,P,D,w,H,x,f]),_=d.useCallback(async()=>{if(b){if(j){console.log(`[Paper] Close ${s} ${b}`),M(b),x(null),f(null),P();return}try{const N=await we.closePosition(b,i,l);N.status==="success"?(console.log(`[Scalping] Closed ${s} ${b}`),M(b),x(null),f(null),P()):(console.error("[Scalping] Close rejected:",N),Ie.error(Ht(N,"Close position rejected")))}catch(N){console.error("[Scalping] Close failed:",N),Ie.error(Ht(N,"Close position failed"))}}},[b,s,i,l,j,M,x,f,P]),q=d.useCallback(async()=>{if(j){console.log("[Paper] Close all positions"),$(),x(null),f(null),P();return}try{const N=await we.closeAllPositions();N.status==="success"?(console.log("[Scalping] Closed all positions"),$(),x(null),f(null),P()):(console.error("[Scalping] Close all rejected:",N),Ie.error(Ht(N,"Close all rejected")))}catch(N){console.error("[Scalping] Close all failed:",N),Ie.error(Ht(N,"Close all failed"))}},[j,$,x,f,P]);return n.jsxs("div",{className:"p-3 space-y-4",children:[n.jsxs("div",{className:"text-center",children:[n.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),n.jsxs("div",{className:"text-sm font-bold",children:[n.jsx("span",{className:s==="CE"?"text-green-500":"text-red-500",children:s})," ",n.jsx("span",{className:"text-foreground font-mono text-xs",children:b||"No strike selected"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx(Le,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>U("BUY"),disabled:!b,children:"BUY"}),n.jsx(Le,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>U("SELL"),disabled:!b,children:"SELL"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-xs",children:"Lots"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(Le,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:E,children:"-"}),n.jsx(Tt,{type:"number",min:1,value:o,onChange:N=>Y(Number.parseInt(N.target.value)||1),className:"h-7 text-center text-sm w-16"}),n.jsx(Le,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:I,children:"+"}),n.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*c," qty"]})]})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-xs",children:"Order Type"}),n.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(N=>n.jsx(Le,{variant:u===N?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>K(N),children:N},N))})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-xs",children:"Product"}),n.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(N=>n.jsx(Le,{variant:l===N?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>J(N),children:N},N))})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-xs text-green-500",children:"TP Points"}),n.jsx(Tt,{type:"number",min:0,step:5,value:p,onChange:N=>T(Number.parseFloat(N.target.value)||0),className:"h-7 text-sm"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-xs text-red-500",children:"SL Points"}),n.jsx(Tt,{type:"number",min:0,step:5,value:m,onChange:N=>L(Number.parseFloat(N.target.value)||0),className:"h-7 text-sm"})]})]}),n.jsxs("div",{className:"border-t pt-3 space-y-2",children:[n.jsxs(Le,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:_,disabled:!b,children:["Close ",s," Position"]}),n.jsx(Le,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:q,children:"Close All Positions"})]})]})}const fn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,volumeInfluenceEnabled:!0,volumeLookbackTicks:20,indexVolumeMinRatio:1.05,optionVolumeMinRatio:1.15,sideVolumeDominanceRatio:1.1,volumeScoreWeight:1,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},Ir=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"adaptive-scalper",name:"Adaptive Scalper",description:"Aggressive scalping profile with lighter entry gates and faster re-entry.",config:{entryMomentumCount:3,entryMomentumVelocity:2,entryMinScore:4,entryMaxSpread:6,volumeLookbackTicks:14,indexVolumeMinRatio:1,optionVolumeMinRatio:1,sideVolumeDominanceRatio:1,volumeScoreWeight:1.25,trailInitialSL:10,trailBreakevenTrigger:6,trailLockTrigger:12,trailLockAmount:6,trailStartTrigger:15,trailStepSize:3,trailTightTrigger:24,trailTightStep:2,maxTradesPerDay:40,maxTradesPerMinute:10,minGapMs:1500,cooldownAfterLossSec:15,coolingOffAfterLosses:5,indexBiasEnabled:!0,indexBiasWeight:.2,optionsContextEnabled:!0,pcrBullishThreshold:.5,pcrBearishThreshold:1.6,maxPainProximityFilter:10,gexWallFilterEnabled:!1,ivSpikeExitEnabled:!1,respectHotZones:!1,sensitivityMultiplier:1.25,noTradeZoneEnabled:!1,reEntryEnabled:!0,reEntryDelaySec:8,reEntryMaxPerSide:6}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],Ea=["CE","PE"];function Yt(e=0){return Ea.reduce((t,s)=>(t[s]=e,t),{})}const Ca=new Set(["1","true","yes","on","enabled"]),La=new Set(["0","false","no","off","disabled"]);function Ma(e){if(typeof e=="boolean")return e;if(typeof e=="number")return Number.isFinite(e)?e!==0:null;if(typeof e=="string"){const t=e.trim().toLowerCase();if(Ca.has(t))return!0;if(La.has(t))return!1}return null}function Vn(e){if(!e||typeof e!="object")return{};const t=e,s={};for(const r of Object.keys(fn)){if(!(r in t))continue;const a=fn[r],i=t[r];if(typeof a=="boolean"){const o=Ma(i);o!=null&&(s[r]=o);continue}if(typeof a=="number"){const o=typeof i=="number"?i:typeof i=="string"?Number(i):Number.NaN;Number.isFinite(o)&&(s[r]=o)}}return s}const W=nr()(sr(e=>({config:{...fn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Yt(),sideLastExitAt:Yt(),sideLossPnl:Yt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(s=>({config:{...s.config,...Vn(t)}})),applyPreset:t=>{const s=Ir.find(r=>r.id===t);s&&e({config:{...fn,...Vn(s.config)},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(s=>({lockProfitEnabled:t,lockProfitTriggered:t?s.lockProfitTriggered:!1})),updateRiskState:t=>e(s=>{const r=Math.max(s.accountPeakPnl,t),a=Math.max(0,r-t),i=Math.max(s.dailyPeakPnl,t),o=Math.max(0,i-t),c=s.lockProfitEnabled&&i>0?s.lockProfitTriggered||o>=i*.4:s.lockProfitTriggered,l=t<0&&Math.abs(t)>=s.config.maxDailyLoss;return{dailyPeakPnl:i,dailyDrawdown:o,accountPeakPnl:r,accountDrawdown:a,lockProfitTriggered:c,killSwitch:s.killSwitch||l}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(s=>{const r=Date.now(),a=r-s.lastMinuteReset>6e4?r:s.lastMinuteReset,i=r-s.lastMinuteReset>6e4?1:s.tradesThisMinute+1,o=s.realizedPnl+t,c=Math.max(s.dailyPeakPnl,o),l=Math.max(0,c-o),u=Math.max(s.autoPeakPnl,o),p=Math.max(0,u-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:s.tradesCount+1,consecutiveLosses:t<0?s.consecutiveLosses+1:s.consecutiveLosses,lastTradeTime:r,tradesThisMinute:i,lastMinuteReset:a,lastLossTime:t<0?r:s.lastLossTime,dailyPeakPnl:c,dailyDrawdown:l,autoPeakPnl:u,autoDrawdown:p}}),recordTradeOutcome:t=>e(s=>{const r=Date.now(),a=s.realizedPnl+t,i=Math.max(s.dailyPeakPnl,a),o=Math.max(0,i-a),c=Math.max(s.autoPeakPnl,a),l=Math.max(0,c-a),u=s.lockProfitEnabled&&i>0?s.lockProfitTriggered||o>=i*.4:s.lockProfitTriggered;return{realizedPnl:a,lastTradePnl:t,consecutiveLosses:t<0?s.consecutiveLosses+1:0,lastLossTime:t<0?r:s.lastLossTime,dailyPeakPnl:i,dailyDrawdown:o,autoPeakPnl:c,autoDrawdown:l,lockProfitTriggered:u,killSwitch:s.killSwitch}}),recordAutoEntry:t=>e(s=>({sideEntryCount:{...s.sideEntryCount,[t]:s.sideEntryCount[t]+1}})),recordAutoExit:(t,s)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:s<0?r.sideLossPnl[t]+Math.abs(s):r.sideLossPnl[t]}})),pushDecision:t=>e(s=>({decisionHistory:[...s.decisionHistory.slice(-119),t],lastDecisionBySide:{...s.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(s=>({executionSamples:[...s.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(s=>({ghostSignals:[...s.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:Yt(),sideLastExitAt:Yt(),sideLossPnl:Yt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,accountPeakPnl:0,accountDrawdown:0,autoPeakPnl:0,autoDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId}),merge:(e,t)=>{const s=e??{};return{...t,...s,config:{...fn,...Vn(s.config??{})},activePresetId:s.activePresetId??t.activePresetId}}})),Ra=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],Ia=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function Hn(e){const[t,s]=e.split(":").map(Number);return t*60+s}function is(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return{hours:s.getUTCHours(),minutes:s.getUTCMinutes()}}function Ar(e){return e?Ia:Ra}function Yn(e=new Date,t=!1){const{hours:s,minutes:r}=is(e),a=s*60+r,i=Ar(t);for(const o of i){const c=Hn(o.start),l=Hn(o.end);if(a>=c&&a<l)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function Ds(e=new Date,t=!1){const{hours:s,minutes:r}=is(e),a=s*60+r,i=Ar(t);for(const o of i){const c=Hn(o.start);if(c>a)return{nextZone:o,minutesUntil:c-a}}return{nextZone:null,minutesUntil:0}}function zs(e,t=new Date){if(!e)return!1;try{const s=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,a=new Date(r+5.5*60*60*1e3);return s.getFullYear()===a.getUTCFullYear()&&s.getMonth()===a.getUTCMonth()&&s.getDate()===a.getUTCDate()}catch{return!1}}function _s(e=new Date){const{hours:t,minutes:s}=is(e),r=t*60+s;return r>=555&&r<930}function Bs(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,s=new Date(t+5.5*60*60*1e3);return`${s.getUTCHours().toString().padStart(2,"0")}:${s.getUTCMinutes().toString().padStart(2,"0")}:${s.getUTCSeconds().toString().padStart(2,"0")}`}function $r(){const e=S(r=>r.expiry),[t,s]=d.useState(()=>{const r=new Date,a=zs(e,r),{zone:i,sensitivity:o}=Yn(r,a),{nextZone:c,minutesUntil:l}=Ds(r,a);return{currentTime:Bs(r),currentZone:i,sensitivity:o,nextZone:c,minutesToNext:l,isExpiryDay:a,isOpen:_s(r)}});return d.useEffect(()=>{const a=setInterval(()=>{const i=new Date,o=zs(e,i),{zone:c,sensitivity:l}=Yn(i,o),{nextZone:u,minutesUntil:p}=Ds(i,o);s({currentTime:Bs(i),currentZone:c,sensitivity:l,nextZone:u,minutesToNext:p,isExpiryDay:o,isOpen:_s(i)})},1e3);return()=>clearInterval(a)},[e]),t}function Aa(){const e=W(r=>r.activePresetId),t=W(r=>r.applyPreset),{isExpiryDay:s}=$r();return n.jsx("div",{className:"space-y-1.5",children:Ir.map(r=>{const a=e===r.id,i=r.id==="expiry";return n.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${a?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-xs font-medium",children:r.name}),n.jsxs("div",{className:"flex items-center gap-1",children:[i&&s&&n.jsx(_e,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),a&&n.jsx(_e,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function xe({label:e,field:t,step:s}){const r=W(i=>i.config[t]),a=W(i=>i.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(ut,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),n.jsx(Tt,{type:"number",value:r,step:s??1,onChange:i=>a({[t]:Number(i.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function lt({label:e,field:t}){const s=W(a=>a.config[t]),r=W(a=>a.updateConfig);return n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(ut,{className:"text-[10px] text-muted-foreground",children:e}),n.jsx(cn,{checked:s===!0,onCheckedChange:a=>r({[t]:a}),className:"h-4 w-7"})]})}function it({title:e,children:t}){return n.jsxs("details",{className:"group",children:[n.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),n.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function $a(){return n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs(it,{title:"Entry Conditions",children:[n.jsx(xe,{label:"Momentum Count",field:"entryMomentumCount"}),n.jsx(xe,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),n.jsx(xe,{label:"Min Score",field:"entryMinScore"}),n.jsx(xe,{label:"Max Spread",field:"entryMaxSpread"})]}),n.jsxs(it,{title:"Volume Flow",children:[n.jsx(lt,{label:"Influence Enabled",field:"volumeInfluenceEnabled"}),n.jsx(xe,{label:"Lookback Ticks",field:"volumeLookbackTicks"}),n.jsx(xe,{label:"Index Vol Min Ratio",field:"indexVolumeMinRatio",step:.05}),n.jsx(xe,{label:"Option Vol Min Ratio",field:"optionVolumeMinRatio",step:.05}),n.jsx(xe,{label:"Side Dominance Ratio",field:"sideVolumeDominanceRatio",step:.05}),n.jsx(xe,{label:"Volume Score Weight",field:"volumeScoreWeight",step:.1})]}),n.jsxs(it,{title:"Trailing SL (5-Stage)",children:[n.jsx(xe,{label:"Initial SL (pts)",field:"trailInitialSL"}),n.jsx(xe,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),n.jsx(xe,{label:"Lock Trigger",field:"trailLockTrigger"}),n.jsx(xe,{label:"Lock Amount",field:"trailLockAmount"}),n.jsx(xe,{label:"Trail Start",field:"trailStartTrigger"}),n.jsx(xe,{label:"Trail Step",field:"trailStepSize"}),n.jsx(xe,{label:"Tight Trigger",field:"trailTightTrigger"}),n.jsx(xe,{label:"Tight Step",field:"trailTightStep"})]}),n.jsxs(it,{title:"Breakeven",children:[n.jsx(xe,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),n.jsx(xe,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),n.jsxs(it,{title:"Risk",children:[n.jsx(xe,{label:"Max Daily Loss",field:"maxDailyLoss"}),n.jsx(xe,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),n.jsx(xe,{label:"Max Trades/Day",field:"maxTradesPerDay"}),n.jsx(xe,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),n.jsx(xe,{label:"Min Gap (ms)",field:"minGapMs",step:500}),n.jsx(xe,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),n.jsx(xe,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),n.jsx(xe,{label:"Max Position Size",field:"maxPositionSize"})]}),n.jsxs(it,{title:"Imbalance Filter",children:[n.jsx(lt,{label:"Enabled",field:"imbalanceFilterEnabled"}),n.jsx(xe,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),n.jsxs(it,{title:"Regime Detection",children:[n.jsx(xe,{label:"Detection Period",field:"regimeDetectionPeriod"}),n.jsx(xe,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),n.jsxs(it,{title:"Index Bias",children:[n.jsx(lt,{label:"Enabled",field:"indexBiasEnabled"}),n.jsx(xe,{label:"Weight",field:"indexBiasWeight",step:.1})]}),n.jsxs(it,{title:"Options Context",children:[n.jsx(lt,{label:"Enabled",field:"optionsContextEnabled"}),n.jsx(xe,{label:"PCR Bullish ≤",field:"pcrBullishThreshold",step:.1}),n.jsx(xe,{label:"PCR Bearish ≥",field:"pcrBearishThreshold",step:.1}),n.jsx(xe,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),n.jsx(lt,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),n.jsx(lt,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),n.jsx(xe,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),n.jsxs(it,{title:"Time-of-Day",children:[n.jsx(lt,{label:"Respect Hot Zones",field:"respectHotZones"}),n.jsx(xe,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),n.jsxs(it,{title:"No-Trade Zone",children:[n.jsx(lt,{label:"Enabled",field:"noTradeZoneEnabled"}),n.jsx(xe,{label:"Range (pts)",field:"noTradeZoneRangePts"}),n.jsx(xe,{label:"Period",field:"noTradeZonePeriod"})]}),n.jsxs(it,{title:"Re-Entry",children:[n.jsx(lt,{label:"Enabled",field:"reEntryEnabled"}),n.jsx(xe,{label:"Delay (sec)",field:"reEntryDelaySec"}),n.jsx(xe,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),n.jsxs(it,{title:"Telegram Alerts",children:[n.jsx(lt,{label:"Entry Alerts",field:"telegramAlertsEntry"}),n.jsx(lt,{label:"Exit Alerts",field:"telegramAlertsExit"}),n.jsx(lt,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function Oa(){const e=W(r=>r.ghostSignals),t=W(r=>r.clearGhostSignals);if(e.length===0)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const s=e.slice(-10).reverse();return n.jsxs("div",{className:"space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),s.map(r=>n.jsx(Fa,{signal:r},r.id))]})}function Fa({signal:e}){const t=Ae(m=>m.apiKey),s=S(m=>m.optionExchange),r=S(m=>m.quantity),a=S(m=>m.lotSize),i=S(m=>m.product),o=S(m=>m.paperMode),c=S(m=>m.incrementTradeCount),l=d.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),c();return}if(!t)return;const m={apikey:t,strategy:"Scalping-Ghost",exchange:s,symbol:e.symbol,action:e.action,quantity:r*a,pricetype:"MARKET",product:i};try{const h=await we.placeOrder(m);h.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${h.data?.orderid}`),c())}catch(h){console.error("[Ghost Take] Failed:",h)}},[e,t,s,r,a,i,o,c]),u=Math.round((Date.now()-e.timestamp)/1e3),p=u<60?`${u}s ago`:`${Math.round(u/60)}m ago`;return n.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(_e,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),n.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"text-[9px] text-muted-foreground",children:p}),n.jsxs(_e,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&n.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&n.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),n.jsx(Le,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:l,children:"Take Trade"})]})]})}function Da(){const e=W(r=>r.optionsContext);if(!e)return n.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),s=t<60?`${t}s`:`${Math.round(t/60)}m`;return n.jsxs("div",{className:"space-y-1.5 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),n.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",s," ago"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PCR"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[n.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),n.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),n.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),n.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",n.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),n.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),n.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),n.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),n.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),n.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),n.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&n.jsxs("div",{children:[n.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),n.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>n.jsx(_e,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const as={getBotStatus:async()=>(await mt.get("/telegram/bot/status")).data.data,startBot:async()=>(await mt.post("/telegram/bot/start")).data,stopBot:async()=>(await mt.post("/telegram/bot/stop")).data,getConfig:async()=>(await mt.get("/telegram/api/config")).data.data,updateConfig:async e=>(await mt.post("/telegram/config",e)).data,getUsers:async()=>(await mt.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await mt.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await mt.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await mt.post("/telegram/test-message")).data,sendBroadcast:async e=>(await mt.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await mt.post("/telegram/send-message",{telegram_id:e,message:t})).data};function za(){const[e,t]=d.useState(!1),[s,r]=d.useState(null),[a,i]=d.useState(null),[o,c]=d.useState(null),l=W(x=>x.updateConfig),u=W(x=>x.config),p=S(x=>x.underlying),m=d.useCallback(async()=>{try{const x=await qr();r(x.provider||"none"),x.last_run&&i(x.last_run),c(null)}catch{c("Could not reach advisor")}},[]),h=d.useCallback(async()=>{t(!0),c(null);try{const x=await Gr({underlying:p});if(x.status==="success"&&x.run_id){const f=await Kr(1);f.runs?.length>0&&i(f.runs[0])}else c(x.message||"Tuning failed")}catch{c("Advisor request failed")}finally{t(!1)}},[p]),g=d.useCallback(async()=>{if(a?.run_id){t(!0);try{await Ur(a.run_id);const x=a.recommendations;if(x&&typeof x=="object"){const f={};for(const[k,P]of Object.entries(x)){if(!(k in u))continue;const j=k,w=u[j];if(typeof w=="number"){const M=typeof P=="number"?P:Number(P);Number.isFinite(M)&&(f[j]=M);continue}if(typeof w=="boolean"){let M=null;if(typeof P=="boolean")M=P;else if(typeof P=="number")M=P!==0;else if(typeof P=="string"){const $=P.trim().toLowerCase();["true","1","yes","on","enabled"].includes($)&&(M=!0),["false","0","no","off","disabled"].includes($)&&(M=!1)}M!=null&&(f[j]=M)}}if(Object.keys(f).length>0&&(l(f),u.telegramAlertsTune)){const k=Object.keys(f).join(", ");as.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${p}: ${k}`}).catch(()=>{})}}i(f=>f&&{...f,applied:!0}),c(null)}catch{c("Failed to apply recommendation")}finally{t(!1)}}},[a,l,u,p]);return n.jsxs("div",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),s&&n.jsx(_e,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:s})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(Le,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:m,disabled:e,children:"Check Status"}),n.jsx(Le,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:h,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&n.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),a&&n.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Score"}),n.jsx("span",{className:"font-bold",children:a.score?.toFixed(1)??"—"})]}),a.notes&&n.jsx("p",{className:"text-muted-foreground leading-tight",children:a.notes}),Object.keys(a.recommendations||{}).length>0&&n.jsxs("div",{className:"space-y-0.5",children:[n.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(a.recommendations).map(([x,f])=>n.jsxs("div",{className:"flex justify-between pl-1",children:[n.jsx("span",{className:"text-muted-foreground",children:x}),n.jsx("span",{className:"font-mono",children:typeof f=="number"?f:String(f)})]},x))]}),!a.applied&&Object.keys(a.recommendations||{}).length>0&&n.jsx(Le,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:g,disabled:e,children:"Apply Recommendation"}),a.applied&&n.jsx(_e,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function _a(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function Ba(){const e=W(y=>y.enabled),t=W(y=>y.mode),s=W(y=>y.replayMode),r=W(y=>y.regime),a=W(y=>y.tradesCount),i=W(y=>y.realizedPnl),o=W(y=>y.consecutiveLosses),c=W(y=>y.killSwitch),l=W(y=>y.lockProfitEnabled),u=W(y=>y.lockProfitTriggered),p=W(y=>y.accountPeakPnl),m=W(y=>y.accountDrawdown),h=W(y=>y.autoPeakPnl),g=W(y=>y.autoDrawdown),x=W(y=>y.sideEntryCount),f=W(y=>y.sideLastExitAt),k=W(y=>y.sideLossPnl),P=W(y=>y.lastDecisionBySide),j=W(y=>y.decisionHistory),w=W(y=>y.executionSamples),M=W(y=>y.config),$=W(y=>y.setEnabled),O=W(y=>y.setMode),H=W(y=>y.setReplayMode),Y=W(y=>y.setKillSwitch),I=W(y=>y.setLockProfitEnabled),E=W(y=>y.resetRuntime),K=S(y=>y.activeSide),J=S(y=>y.paperMode),T=ce(y=>y.virtualTPSL),L=d.useMemo(()=>P[K]??j[j.length-1]??null,[K,j,P]),D=d.useMemo(()=>L?Math.max(0,Math.min(99,Math.round(L.score/Math.max(1,L.minScore)*100))):r==="UNKNOWN"?0:55,[L,r]),b=d.useMemo(()=>Object.values(T).reduce((y,A)=>(y[A.side]+=A.quantity,y),{CE:0,PE:0}),[T]),C=d.useMemo(()=>Object.values(T).reduce((y,A)=>(A.managedBy!=="auto"||(y[A.side]+=A.quantity),y),{CE:0,PE:0}),[T]),U=d.useMemo(()=>{const y=w.slice(-10),A=y.filter(fe=>fe.status==="filled"),z=y.filter(fe=>fe.status==="rejected"),X=A.length>0?A.reduce((fe,Se)=>fe+Se.spread,0)/A.length:0,se=A.length>0?A.reduce((fe,Se)=>fe+Se.expectedSlippage,0)/A.length:0,ue=y.length>0?z.length/y.length*100:0;return{recent:y.slice().reverse(),avgSpread:X,avgSlippage:se,rejectRate:ue}},[w]),_=L?L.spread<=M.entryMaxSpread*.4?"TIGHT":L.spread<=M.entryMaxSpread?"NORMAL":"WIDE":"NA",q=f[K]>0?Math.max(0,Math.round((Date.now()-f[K])/1e3)):null,N=e&&t==="execute"&&s,Q=y=>y<=0?"0":`-${y.toFixed(0)}`;return n.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(ut,{className:"text-xs font-medium",children:"Auto-Trade"}),n.jsx(cn,{checked:e,onCheckedChange:$,className:"h-5 w-9"})]}),n.jsx(_e,{variant:e?t==="execute"&&!s?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?N?"SIM (REPLAY)":t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(Le,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>O("ghost"),children:"Ghost (Signals Only)"}),n.jsx(Le,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>O("execute"),children:"Execute (Live)"})]}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),n.jsx(cn,{checked:s,onCheckedChange:H,className:"h-4 w-8"})]}),n.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),N&&n.jsx("div",{className:"p-1 bg-amber-500/10 border border-amber-500/30 rounded text-amber-400 text-[10px] text-center font-medium",children:"EXECUTE BLOCKED - Replay/Simulator is ON"}),t==="execute"&&!J&&!s&&n.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Regime"}),n.jsx(_e,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Auto Trades"}),n.jsx("span",{className:"font-bold",children:a})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Auto P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${i>0?"text-green-500":i<0?"text-red-500":""}`,children:[i>=0?"+":"",i.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),n.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:E,children:"Reset Runtime"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),L?n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-muted-foreground",children:[L.side," ",L.symbol.slice(-12)]}),n.jsxs("span",{className:`font-bold ${L.enter?"text-green-500":"text-red-500"}`,children:[L.score.toFixed(1)," / ",L.minScore.toFixed(1)]})]}),n.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:L.reason}),n.jsx("div",{className:"space-y-0.5",children:L.checks.slice(0,8).map(y=>n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] text-muted-foreground",children:y.label}),n.jsxs("span",{className:`text-[10px] font-medium ${y.pass?"text-green-500":"text-red-500"}`,children:[y.pass?"PASS":"FAIL",y.value?` (${y.value})`:""]})]},y.id))})]}):n.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),n.jsx("span",{className:"font-medium",children:_a(r)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),n.jsxs("span",{className:"font-bold",children:[D,"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),n.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:L&&!L.enter?L.reason:"None"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",K,")"]}),n.jsx("span",{className:"font-mono text-[10px]",children:q==null?"—":`${q}s ago`})]})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),n.jsx("span",{className:`font-medium ${_==="WIDE"?"text-red-500":_==="TIGHT"?"text-green-500":""}`,children:_})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Execution Gate"}),n.jsx("span",{className:`font-medium ${N?"text-amber-400":t==="execute"?"text-green-500":"text-muted-foreground"}`,children:N?"BLOCKED (Replay)":t==="execute"?"OPEN":"Ghost Mode"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),n.jsx("span",{className:"font-mono",children:(L?.expectedSlippage??0).toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),n.jsx("span",{className:"font-mono",children:L?.depthRatio!=null?L.depthRatio.toFixed(2):"NA"})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),n.jsx("span",{className:"font-mono",children:U.avgSpread.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),n.jsx("span",{className:"font-mono",children:U.avgSlippage.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),n.jsxs("span",{className:`font-mono ${U.rejectRate>30?"text-red-500":""}`,children:[U.rejectRate.toFixed(0),"%"]})]}),n.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[U.recent.slice(0,5).map(y=>n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[y.side," ",y.symbol.slice(-10)]}),n.jsx("span",{className:y.status==="rejected"?"text-red-500":y.status==="filled"?"text-green-500":"text-muted-foreground",children:y.status})]},`${y.timestamp}-${y.symbol}`)),U.recent.length===0&&n.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),n.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[c&&n.jsx(_e,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),n.jsx(cn,{checked:c,onCheckedChange:Y,className:"h-4 w-8"})]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[u&&n.jsx(_e,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),n.jsx(cn,{checked:l,onCheckedChange:I,className:"h-4 w-8"})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (All)"}),n.jsx("span",{className:"font-mono",children:p.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Drawdown (All)"}),n.jsx("span",{className:`font-mono ${m>0?"text-red-500":""}`,children:m.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Peak P&L (Auto)"}),n.jsx("span",{className:"font-mono",children:h.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Drawdown (Auto)"}),n.jsx("span",{className:`font-mono ${g>0?"text-red-500":""}`,children:g.toFixed(0)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Virtual)"}),n.jsx("span",{className:"font-mono",children:b.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Virtual)"}),n.jsx("span",{className:"font-mono",children:b.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure CE (Auto)"}),n.jsx("span",{className:"font-mono",children:C.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Exposure PE (Auto)"}),n.jsx("span",{className:"font-mono",children:C.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),n.jsx("span",{className:"font-mono",children:x.CE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),n.jsx("span",{className:"font-mono",children:x.PE})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),n.jsx("span",{className:`font-mono ${k.CE>0?"text-red-500":""}`,children:Q(k.CE)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),n.jsx("span",{className:`font-mono ${k.PE>0?"text-red-500":""}`,children:Q(k.PE)})]})]})]})]}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Da,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(Oa,{})}),n.jsx("section",{className:"border-t pt-2",children:n.jsx(za,{})}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),n.jsx(Aa,{})]}),n.jsxs("section",{className:"border-t pt-2",children:[n.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),n.jsx($a,{})]})]})}function Va(){const e=Ae(m=>m.apiKey),t=S(m=>m.optionExchange),s=ce(m=>m.virtualTPSL),r=ce(m=>m.triggerOrders),a=ce(m=>m.removeVirtualTPSL),i=ce(m=>m.removeTriggerOrder),o=ce(m=>m.clearAll),{data:c}=rr({queryKey:["scalping-orders",t],queryFn:()=>we.getOrders(e),enabled:!!e,refetchInterval:5e3}),l=(c?.data?.orders??[]).filter(m=>m.exchange===t&&(m.order_status==="open"||m.order_status==="pending"||m.order_status==="trigger pending")),u=Object.values(s),p=Object.values(r);return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),n.jsx(_e,{variant:"outline",className:"text-[10px] h-4",children:l.length})]}),l.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):n.jsx("div",{className:"space-y-1",children:l.map(m=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",n.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)})," ",n.jsxs("span",{className:"text-muted-foreground",children:["x",m.quantity]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(_e,{variant:"outline",className:"text-[10px] h-4",children:m.order_status}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await we.cancelOrder(m.orderid)}catch(h){console.error("Cancel failed:",h)}},children:"Cancel"})]})]},m.orderid))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),n.jsx(_e,{variant:"outline",className:"text-[10px] h-4",children:u.length})]}),u.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):n.jsx("div",{className:"space-y-1",children:u.map(m=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:m.side==="CE"?"text-green-500":"text-red-500",children:m.side})," ",n.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",m.entryPrice.toFixed(1)," |"," ",m.tpPrice!==null&&n.jsxs("span",{className:"text-green-500",children:["TP: ",m.tpPrice.toFixed(1)]})," ",m.slPrice!==null&&n.jsxs("span",{className:"text-red-500",children:["SL: ",m.slPrice.toFixed(1)]})]})]}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(m.id),children:"Remove"})]},m.id))})]}),n.jsxs("section",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),n.jsx(_e,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?n.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):n.jsx("div",{className:"space-y-1",children:p.map(m=>n.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[n.jsxs("div",{children:[n.jsx("span",{className:m.action==="BUY"?"text-green-500":"text-red-500",children:m.action})," ",n.jsx("span",{className:"font-mono",children:m.symbol.slice(-10)}),n.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",m.triggerPrice.toFixed(1)," (",m.direction,") | x",m.quantity]})]}),n.jsx(Le,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(m.id),children:"Remove"})]},m.id))})]}),(u.length>0||p.length>0)&&n.jsx(Le,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function qa(e,t){const s=Ae(p=>p.apiKey),[r,a]=d.useState(null),[i,o]=d.useState(!1),c=d.useRef(null),l=d.useCallback(async()=>{if(!(!e||!s)){try{const p=await we.getDepth(s,e,t);p.status==="success"&&p.data&&a(p.data)}catch{}o(!1)}},[e,t,s]);d.useEffect(()=>{if(!e){a(null);return}return o(!0),l(),c.current=setInterval(l,2e3),()=>{c.current&&clearInterval(c.current)}},[e,l]);const u=r?Ga(r):null;return{depth:r,analytics:u,levels:5,isLoading:i}}function Ga(e){const t=e.bids||[],s=e.asks||[],r=t.reduce((g,x)=>g+x.quantity,0),a=s.reduce((g,x)=>g+x.quantity,0),i=a>0?r/a:r>0?999:1,o=s.length>0&&t.length>0?s[0].price-t[0].price:0,c=t.length>0?t.reduce((g,x)=>x.quantity>g.quantity?x:g,t[0]):null,l=c?{price:c.price,qty:c.quantity}:null,u=s.length>0?s.reduce((g,x)=>x.quantity>g.quantity?x:g,s[0]):null,p=u?{price:u.price,qty:u.quantity}:null,m=r+a,h=m>0?(r-a)/m*100:0;return{totalBidQty:r,totalAskQty:a,bidAskRatio:i,spread:o,largestBidWall:l,largestAskWall:p,imbalanceScore:h}}function Ka(){const e=S(c=>c.activeSide),t=S(c=>c.optionExchange),s=S(c=>c.activeSide==="CE"?c.selectedCESymbol:c.selectedPESymbol),{depth:r,analytics:a,levels:i,isLoading:o}=qa(s,t);return s?n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),n.jsx("span",{className:"font-mono text-muted-foreground",children:s.slice(-10)})]}),n.jsxs(_e,{variant:"outline",className:"text-[10px] h-4",children:[i,"-Level"]})]}),o&&!r?n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[n.jsx("span",{className:"text-right",children:"Bid Qty"}),n.jsx("span",{className:"text-center",children:"Bid"}),n.jsx("span",{className:"text-center",children:"Ask"}),n.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((c,l)=>{const u=r.bids?.[l],p=r.asks?.[l],m=Math.max(...r.bids?.map(h=>h.quantity)??[0],...r.asks?.map(h=>h.quantity)??[0]);return n.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[n.jsx("div",{className:"flex items-center justify-end",children:n.jsx("div",{className:"relative h-4 w-full",children:u&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${m>0?u.quantity/m*100:0}%`}}),n.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:u.quantity.toLocaleString()})]})})}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:u?.price.toFixed(2)??"--"}),n.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:p?.price.toFixed(2)??"--"}),n.jsx("div",{className:"flex items-center",children:n.jsx("div",{className:"relative h-4 w-full",children:p&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${m>0?p.quantity/m*100:0}%`}}),n.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:p.quantity.toLocaleString()})]})})})]},l)})]}),a&&n.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),n.jsx("span",{className:`font-bold tabular-nums ${a.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:a.bidAskRatio.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Spread"}),n.jsx("span",{className:`font-bold tabular-nums ${a.spread<2?"text-green-500":a.spread<5?"text-yellow-500":"text-red-500"}`,children:a.spread.toFixed(2)})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full ${a.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(a.imbalanceScore)}%`,marginLeft:a.imbalanceScore<0?`${100-Math.abs(a.imbalanceScore)}%`:"50%"}})}),n.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${a.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[a.imbalanceScore>0?"+":"",a.imbalanceScore.toFixed(0),"%"]})]})]}),a.largestBidWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),n.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[a.largestBidWall.qty.toLocaleString()," @ ",a.largestBidWall.price.toFixed(2)]})]}),a.largestAskWall&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),n.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[a.largestAskWall.qty.toLocaleString()," @ ",a.largestAskWall.price.toFixed(2)]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsxs("span",{className:"text-green-500",children:["Total Bid: ",a.totalBidQty.toLocaleString()]}),n.jsxs("span",{className:"text-red-500",children:["Total Ask: ",a.totalAskQty.toLocaleString()]})]})]}),n.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[n.jsxs("span",{children:["LTP: ",n.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),n.jsxs("span",{children:["Vol: ",n.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),n.jsxs("span",{children:["OI: ",n.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):n.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):n.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:n.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Vs=500;function Ua(){const e=d.useRef([]),t=d.useCallback(c=>{const l={...c,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(l),e.current.length>Vs&&(e.current=e.current.slice(-Vs)),l},[]),s=d.useCallback(()=>[...e.current],[]),r=d.useCallback(c=>e.current.slice(-c),[]),a=d.useCallback(()=>{e.current=[]},[]),i=d.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=d.useCallback(()=>{const c=e.current;if(c.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const l=c.filter(h=>h.pnl!==void 0),u=l.filter(h=>(h.pnl??0)>0),p=l.reduce((h,g)=>h+(g.pnl??0),0),m=l.map(h=>h.pnl??0);return{count:c.length,winRate:l.length>0?u.length/l.length*100:0,avgPnl:l.length>0?p/l.length:0,totalPnl:p,bestTrade:m.length>0?Math.max(...m):0,worstTrade:m.length>0?Math.min(...m):0}},[]);return{logTrade:t,getTrades:s,getRecentTrades:r,clearTrades:a,exportAsJSON:i,getStats:o}}function Wa({liveOpenPnl:e,isLivePnl:t=!1}){const s=S(j=>j.sessionPnl),r=S(j=>j.tradeCount),a=S(j=>j.paperMode),i=a?s:e??s,o=$r(),{getStats:c}=Ua(),l=c(),[u,p]=d.useState(5e3),[m,h]=d.useState(500),[g,x]=d.useState(50),[f,k]=d.useState(3),P=i<0&&Math.abs(i)>=u;return n.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[n.jsxs("section",{className:"space-y-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),n.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Status"}),n.jsx(_e,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Zone"}),n.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:n.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),n.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),n.jsxs("span",{children:[o.nextZone.label," ",n.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&n.jsx(_e,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),n.jsxs("section",{className:"border-t pt-2 space-y-2",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),P&&n.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-[10px]",children:"Daily Loss Limit"}),n.jsx(Tt,{type:"number",value:u,onChange:j=>p(Number(j.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),n.jsx(Tt,{type:"number",value:m,onChange:j=>h(Number(j.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-[10px]",children:"Profit Protection (%)"}),n.jsx(Tt,{type:"number",value:g,onChange:j=>x(Number(j.target.value)||0),className:"h-6 text-xs"})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(ut,{className:"text-[10px]",children:"Cooling Off After N Losses"}),n.jsx(Tt,{type:"number",value:f,onChange:j=>k(Number(j.target.value)||0),className:"h-6 text-xs"})]})]}),n.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[n.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),n.jsx("span",{className:"font-bold",children:r})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsxs("span",{className:`font-bold tabular-nums ${i>0?"text-green-500":i<0?"text-red-500":""}`,children:[i>=0?"+":"",i.toFixed(0)]}),!a&&n.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),l.count>0&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),n.jsxs("span",{className:"font-bold",children:[l.winRate.toFixed(0),"%"]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),n.jsxs("span",{className:`font-bold tabular-nums ${l.avgPnl>0?"text-green-500":l.avgPnl<0?"text-red-500":""}`,children:[l.avgPnl>=0?"+":"",l.avgPnl.toFixed(0)]})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),n.jsxs("span",{children:[n.jsxs("span",{className:"text-green-500",children:["+",l.bestTrade.toFixed(0)]})," / ",n.jsx("span",{className:"text-red-500",children:l.worstTrade.toFixed(0)})]})]})]})]})]})}const Ha=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function Ya({liveOpenPnl:e,isLivePnl:t=!1}){const s=S(a=>a.controlTab),r=S(a=>a.setControlTab);return n.jsxs("div",{className:"flex flex-col h-full bg-card",children:[n.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:Ha.map(a=>n.jsx("button",{type:"button",onClick:()=>r(a.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${s===a.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:a.label},a.id))}),n.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[s==="manual"&&n.jsx(ka,{}),s==="auto"&&n.jsx(Ba,{}),s==="risk"&&n.jsx(Wa,{liveOpenPnl:e,isLivePnl:t}),s==="depth"&&n.jsx(Ka,{}),s==="orders"&&n.jsx(Va,{})]})]})}const Za=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE ↔ PE)"},{key:"↑",description:"CE direct market buy (with virtual TP/SL)"},{key:"↓",description:"PE direct market buy (with virtual TP/SL)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function Xa({open:e,onClose:t}){return d.useEffect(()=>{if(!e)return;const s=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[e,t]),e?n.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:n.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:s=>s.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),n.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),n.jsx("div",{className:"space-y-1",children:Za.map(({key:s,description:r})=>n.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[n.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:s}),n.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},s))}),n.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function qs(e,t){if(e&&typeof e=="object"){const s=e.response?.data;if(s&&typeof s=="object"){const a=s.message;if(typeof a=="string"&&a.trim().length>0)return a.trim();const i=s.error;if(typeof i=="string"&&i.trim().length>0)return i.trim()}else if(typeof s=="string"&&s.trim().length>0)return s.trim();const r=e.message;if(typeof r=="string"&&r.trim().length>0)return r.trim()}return typeof e=="string"&&e.trim().length>0?e.trim():t}function Qa(e={}){const t=S(b=>b.hotkeysEnabled),s=S(b=>b.activeSide),r=S(b=>b.selectedCESymbol),a=S(b=>b.selectedPESymbol),i=S(b=>b.optionExchange),o=S(b=>b.quantity),c=S(b=>b.lotSize),l=S(b=>b.product),u=S(b=>b.orderType),p=S(b=>b.limitPrice),m=S(b=>b.pendingLimitPlacement),h=S(b=>b.setLimitPrice),g=S(b=>b.setPendingLimitPlacement),x=S(b=>b.clearPendingLimitPlacement),f=S(b=>b.tpPoints),k=S(b=>b.slPoints),P=S(b=>b.setPendingEntryAction),j=S(b=>b.paperMode),w=ce(b=>b.setVirtualTPSL),M=ce(b=>b.triggerOrders),$=ce(b=>b.removeTriggerOrder),O=S(b=>b.setActiveSide),H=S(b=>b.toggleActiveSide),Y=S(b=>b.toggleFloatingWidget),I=S(b=>b.setQuantity),E=Ae(b=>b.apiKey),K=Ae(b=>b.setApiKey),J=d.useCallback(()=>s==="CE"?r:a,[s,r,a]),T=d.useCallback(b=>b==="CE"?r:a,[r,a]),L=d.useCallback(async()=>{if(E)return E;try{const C=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(C.status==="success"&&C.api_key)return K(C.api_key),C.api_key}catch(b){console.error("[Scalping] Failed to fetch API key:",b),Ie.error("Failed to fetch API key")}return console.warn("[Scalping] No API key available — generate one at /apikey"),Ie.error("API key missing. Generate one on /apikey"),null},[E,K]),D=d.useCallback(async(b,C,U=!1)=>{const _=C??s,q=T(_),N=U?"MARKET":u;if(!q){console.warn("[Scalping] No symbol selected — click a strike first"),Ie.error("Select a strike first");return}if(N==="TRIGGER"){const z=Object.values(M).find(X=>X.symbol===q&&X.exchange===i&&X.side===_);z&&$(z.id),x(),h(null),P(b),console.log(`[Scalping] TRIGGER armed (${b}) — click chart to place trigger line`);return}if(N==="LIMIT"&&!p){P(b),console.log(`[Scalping] LIMIT armed (${b}) — click chart to set limit line`);return}if(N==="LIMIT"&&m&&m.symbol===q&&m.side===_){console.warn("[Scalping] LIMIT already pending for this symbol. Wait for fill/cancel before placing another."),Ie.error("A LIMIT order is already pending for this symbol");return}if(j){if(console.log(`[Paper] ${b} ${_} ${q} qty=${o*c} @ ${N}`),N==="MARKET"||N==="LIMIT"){const z=await tn({symbol:q,exchange:i,preferredPrice:N==="LIMIT"?p??void 0:void 0});z>0&&(w(xt({symbol:q,exchange:i,side:_,action:b,entryPrice:z,quantity:o*c,tpPoints:f,slPoints:k,managedBy:"hotkey"})),N==="LIMIT"&&h(null))}x();return}const Q=await L();if(!Q)return;const y=N==="LIMIT"?"LIMIT":"MARKET",A={apikey:Q,strategy:"Scalping",exchange:i,symbol:q,action:b,quantity:o*c,pricetype:y,product:l,price:N==="LIMIT"&&p?p:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${b} ${q} qty=${o*c} ${y}`);const z=await we.placeOrder(A);if(z.status==="success"){const X=Ft(z);if(console.log(`[Scalping] Order placed: ${b} ${q} id=${X??"n/a"}`),P(null),y==="LIMIT"){p==null&&console.warn("[Scalping] LIMIT order acknowledged without a tracked limitPrice; keeping existing line state."),g({symbol:q,side:_,action:b,orderId:X,quantity:o*c,entryPrice:p??0,tpPoints:f,slPoints:k}),p!=null&&h(p);return}if(x(),y==="MARKET"){const se=await zt({symbol:q,exchange:i,orderId:X,preferredPrice:void 0,apiKey:Q});se>0&&w(xt({symbol:q,exchange:i,side:_,action:b,entryPrice:se,quantity:o*c,tpPoints:f,slPoints:k,managedBy:"hotkey"}))}}else console.error("[Scalping] Order rejected:",z),Ie.error(qs(z,"Order was rejected"))}catch(z){console.error("[Scalping] Order failed:",z),Ie.error(qs(z,"Order placement failed"))}},[T,s,o,c,i,l,u,p,m,f,k,j,M,L,g,x,w,$,h,P]);d.useEffect(()=>{if(!t)return;const b=C=>{const U=C.target?.tagName;if(U==="INPUT"||U==="TEXTAREA"||U==="SELECT")return;const _=J();switch(C.key.toLowerCase()){case"b":{C.preventDefault(),_&&(D("BUY"),e.onBuy?.(s,_));break}case"s":{C.preventDefault(),_&&(D("SELL"),e.onSell?.(s,_));break}case"c":{C.preventDefault(),_&&e.onClose?.(s,_);break}case"x":{C.preventDefault(),e.onCloseAll?.();break}case"r":{C.preventDefault(),_&&e.onReversal?.(s,_);break}case"w":{C.preventDefault(),Y();break}case"tab":{C.preventDefault(),H();break}case"1":{C.preventDefault(),I(1);break}case"2":{C.preventDefault(),I(2);break}case"3":{C.preventDefault(),I(3);break}case"?":{C.preventDefault(),e.onToggleHelp?.();break}case"arrowup":{C.preventDefault(),r&&(O("CE"),D("BUY","CE",!0),e.onBuy?.("CE",r));break}case"arrowdown":{C.preventDefault(),a&&(O("PE"),D("BUY","PE",!0),e.onBuy?.("PE",a));break}}};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[t,s,J,D,H,O,Y,I,r,a,e])}const Ja=300,Gs=2e3,Ks=15,Us=8e3,Ws=15e3;function et(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const s=Number(e);return Number.isFinite(s)?s:t}return t}function $n(e,t){if(!e||typeof e!="object")return null;const s=e[t],r=et(s,Number.NaN);return Number.isFinite(r)?r:null}function eo(e,t,s){if(!e.length)return null;const r=e.find(c=>c.strike===t);if(r)return r;const a=Number.isFinite(s)&&s>0?s:t;let i=e[0],o=Math.abs(e[0].strike-a);for(let c=1;c<e.length;c++){const l=Math.abs(e[c].strike-a);l<o&&(i=e[c],o=l)}return i}function to(e){return et(e.ce?.oi,0)+et(e.pe?.oi,0)}function no(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(et($n(t,"net_gex"),0))||to(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,s)=>s.score-t.score).slice(0,5).map(t=>t.strike)}function so(e,t){if(!e.length)return t;let s=t,r=Number.POSITIVE_INFINITY;for(const a of e){const i=a.strike;let o=0;for(const c of e){const l=c.strike,u=et(c.ce?.oi,0),p=et(c.pe?.oi,0);i>l?o+=(i-l)*u:i<l&&(o+=(l-i)*p)}o<r&&(r=o,s=i)}return s}function ro(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}function Hs(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!ro(e.topGammaStrikes,t.topGammaStrikes)}function Ys(e,t){const s=$n(e,"iv");return s!=null&&s>0?s:t}function io(e){return e.replace(/-/g,"").toUpperCase()}function Zs(e,t,s){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const a=et(e.underlying_ltp,0),i=et(e.atm_strike,0),o=eo(r,i,a),c=r.reduce((O,H)=>(O.ceOi+=et(H.ce?.oi,0),O.peOi+=et(H.pe?.oi,0),O.ceVol+=et(H.ce?.volume,0),O.peVol+=et(H.pe?.volume,0),O),{ceOi:0,peOi:0,ceVol:0,peVol:0}),l=c.ceOi>0?c.peOi/c.ceOi:1,u=so(r,o?.strike??i),p=a-u,m=no(r),h=$n(e,"total_net_gex"),g=h??0,x=t?.ceIV??Ks,f=t?.peIV??Ks,k=Ys(o?.ce,x),P=Ys(o?.pe,f),j=(k+P)/2,w=k-P,M=$n(e,"iv_percentile")??t?.ivPercentile??50,$=et(o?.ce?.ltp,0)+et(o?.pe?.ltp,0);return{pcr:l,oiChangeCE:c.ceOi,oiChangePE:c.peOi,maxPainStrike:u,spotVsMaxPain:p,topGammaStrikes:m,gexFlipZones:[],netGEX:g,atmIV:j,ivPercentile:M,ceIV:k,peIV:P,ivSkew:w,straddlePrice:$,lastUpdated:s>0?s:Date.now()}}function ao(){const e=Ae(f=>f.apiKey),t=S(f=>f.underlying),s=S(f=>f.expiry),r=S(f=>f.indexExchange),a=S(f=>f.chainStrikeCount),i=S(f=>f.optionChainData),o=S(f=>f.optionChainLastUpdate),c=S(f=>f.optionChainIsStreaming),l=W(f=>f.optionsContext),u=W(f=>f.setOptionsContext),p=d.useRef(0),m=d.useRef(!1),h=d.useRef(0),g=d.useRef(null);d.useEffect(()=>{if(!i||!Array.isArray(i.chain)||i.chain.length===0)return;const f=Date.now();if(f-p.current<Ja)return;const k=Zs(i,l,o||f);if(!k)return;const P=Hs(l,k),j=!l||f-l.lastUpdated>=Gs;!P&&!j||(u(k),p.current=f)},[i,o,l,u]);const x=d.useCallback(async()=>{if(m.current||!e||!t||!s||!r)return;const f=Date.now();if(!(f-h.current<Ws||i&&Array.isArray(i.chain)&&i.chain.length>0&&(c||f-(o||0)<=Us))){m.current=!0,h.current=f;try{const P=await ir.getOptionChain(e,t,r,io(s),a);if(P.status!=="success"||!Array.isArray(P.chain)||P.chain.length===0)return;const j=Zs(P,l,Date.now());if(!j)return;const w=Hs(l,j),M=!l||Date.now()-l.lastUpdated>=Gs;if(!w&&!M)return;u(j),p.current=Date.now()}catch{}finally{m.current=!1}}},[e,t,s,r,a,i,c,o,l,u]);d.useEffect(()=>{if(!!i&&Array.isArray(i.chain)&&i.chain.length>0&&(c||Date.now()-(o||0)<=Us)){g.current&&(clearInterval(g.current),g.current=null);return}return x(),g.current&&clearInterval(g.current),g.current=setInterval(()=>{x()},Ws),()=>{g.current&&(clearInterval(g.current),g.current=null)}},[i,c,o,x])}function oo(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const s=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,a=0;for(let c=1;c<s.length;c++)s[c]>s[c-1]?r++:s[c]<s[c-1]&&a++;const i=r>a?"up":a>r?"down":"flat",o=s.length>=2?Math.abs(s[s.length-1]-s[0]):0;return{direction:i,count:Math.max(r,a),velocity:o}}function lo(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const s=e.slice(-t.regimeDetectionPeriod),r=s.map(u=>u.high),a=s.map(u=>u.low),i=Math.max(...r)-Math.min(...a),o=s.map(u=>u.close),c=Math.abs(o[o.length-1]-o[0]),l=s.reduce((u,p)=>u+(p.high-p.low),0)/s.length;return i<t.rangingThresholdPts?"RANGING":c>i*.6?"TRENDING":l>i*.15?"VOLATILE":"RANGING"}function co(e,t,s){if(e.length<s)return!1;const r=e.slice(-s);return Math.max(...r)-Math.min(...r)<t}function uo(e,t){let s=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?s+=1:s-=1),e.rsi!==null&&(e.rsi>60?s+=1:e.rsi<40&&(s-=1));const r=s*t.indexBiasWeight,a=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:a}}function po(e,t,s){return!s.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>s.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<s.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<s.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:s.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function mo(e,t,s){if(!s.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function fo(e,t,s){if(!s.optionsContextEnabled||!t)return{exit:!1,reason:""};if(s.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>s.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${s.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>s.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<s.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function xo(e,t,s,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const a=s==="CE"?e/t:t/e;return a<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${a.toFixed(2)} < ${r.imbalanceThreshold} (${s==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function ho(e,t,s,r,a,i,o,c,l,u,p,m=[],h){let g=0;const x=[],f=Date.now(),k=[],P=p&&p.totalBid>0&&p.totalAsk>0?e==="CE"?p.totalBid/p.totalAsk:p.totalAsk/p.totalBid:null,j=s.respectHotZones?l:1,w=Math.max(.25,j*Math.max(.1,s.sensitivityMultiplier)),M=Math.min(10,Math.max(1,s.entryMinScore/w)),$=(A,z,X,se)=>{k.push({id:A,label:z,pass:X,value:se})},O=(A,z)=>({enter:!1,reason:A,score:g,minScore:Number(M.toFixed(2)),checks:k,blockedBy:z,spread:u,depthRatio:P,expectedSlippage:Math.max(0,u/2)}),H=r.tradesCount<s.maxTradesPerDay;if($("daily-trades","Daily trade cap",H,`${r.tradesCount}/${s.maxTradesPerDay}`),!H)return O("Max daily trades reached","daily-trades");const Y=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=s.maxDailyLoss);if($("daily-loss","Daily loss limit",Y,`${r.realizedPnl.toFixed(0)}/${-s.maxDailyLoss}`),!Y)return O("Daily loss limit reached","daily-loss");const I=r.consecutiveLosses<s.coolingOffAfterLosses;if($("cooling-off","Consecutive-loss cooling off",I,`${r.consecutiveLosses}/${s.coolingOffAfterLosses}`),!I)return O(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const E=!r.killSwitch;if($("kill-switch","Kill switch",E),!E)return O("Kill switch active","kill-switch");const K=!s.respectHotZones||j>0;if($("hot-zone","Market hot-zone timing",K,s.respectHotZones?j.toFixed(2):"OFF"),!K)return O("Outside configured market hot-zone timing","hot-zone");const J=Math.max(0,r.openSideLots??0),T=r.allowEntryWithOpenSide===!0,L=!r.sideOpen||T;if($("side-open","No open position on side",L,r.sideOpen?T?`Pyramid allowed (${J.toFixed(1)} lots open)`:`${J.toFixed(1)} lots open`:"0 lots"),!L)return O(`Position already open on ${e}`,"side-open");const D=r.reEntryCountForSide??0,b=r.lastExitAtForSide??0,C=s.reEntryEnabled===!0;if($("reentry-setting","Re-entry",!0,C?"ON":"OFF (first entry only)"),C){if($("reentry-count","Re-entry cap",s.reEntryMaxPerSide<=0||D<s.reEntryMaxPerSide,`${D}/${s.reEntryMaxPerSide}`),s.reEntryMaxPerSide>0&&D>=s.reEntryMaxPerSide)return O(`Re-entry cap reached for ${e}`,"reentry-count");if(s.reEntryDelaySec>0&&b>0){const A=f-b,z=s.reEntryDelaySec*1e3,X=A>=z;if($("reentry-delay","Re-entry delay",X,X?`${s.reEntryDelaySec}s`:`${Math.ceil((z-A)/1e3)}s left`),!X)return O(`Re-entry delay active: ${Math.ceil((z-A)/1e3)}s`,"reentry-delay")}}else{const A=D===0;if($("reentry-first","First entry only",A,`${D}/1`),!A)return O(`Re-entry disabled for ${e}`,"reentry-first")}if(s.maxPositionSize>0&&(r.requestedLots??0)>s.maxPositionSize)return $("max-position-size","Max position size",!1,`${r.requestedLots}/${s.maxPositionSize}`),O(`Requested lots ${r.requestedLots} exceeds max ${s.maxPositionSize}`,"max-position-size");if($("max-position-size","Max position size",!0,`${r.requestedLots??0}/${s.maxPositionSize}`),s.perTradeMaxLoss>0&&r.lastTradePnl!=null){const A=r.lastTradePnl>-s.perTradeMaxLoss;if($("per-trade-loss","Per-trade max loss",A,`${r.lastTradePnl.toFixed(0)}/${-s.perTradeMaxLoss}`),!A)return O("Last trade breached per-trade max loss","per-trade-loss")}else $("per-trade-loss","Per-trade max loss",!0);if(s.minGapMs>0&&r.lastTradeTime>0){const A=f-r.lastTradeTime,z=A>=s.minGapMs;if($("min-gap","Minimum gap between entries",z,z?`${A}ms`:`${s.minGapMs-A}ms left`),A<s.minGapMs)return O(`Min gap: ${Math.ceil((s.minGapMs-A)/1e3)}s remaining`,"min-gap")}else $("min-gap","Minimum gap between entries",!0);if($("per-minute-rate","Per-minute trade rate",s.maxTradesPerMinute<=0||r.tradesThisMinute<s.maxTradesPerMinute,`${r.tradesThisMinute}/${s.maxTradesPerMinute}`),s.maxTradesPerMinute>0&&r.tradesThisMinute>=s.maxTradesPerMinute)return O(`Rate limit: ${r.tradesThisMinute}/${s.maxTradesPerMinute} trades/min`,"per-minute-rate");if(s.cooldownAfterLossSec>0&&r.lastLossTime>0){const A=f-r.lastLossTime,z=s.cooldownAfterLossSec*1e3,X=A>=z;if($("loss-cooldown","Cooldown after loss",X,X?`${s.cooldownAfterLossSec}s`:`${Math.ceil((z-A)/1e3)}s left`),A<z)return O(`Cooldown: ${Math.ceil((z-A)/1e3)}s after loss`,"loss-cooldown")}else $("loss-cooldown","Cooldown after loss",!0);if(p){const A=xo(p.totalBid,p.totalAsk,e,s);if($("depth-imbalance","Depth imbalance",A.allowed,A.reason),!A.allowed)return O(A.reason,"depth-imbalance")}else $("depth-imbalance","Depth imbalance",!0,"No depth data");if($("spread","Spread gate",u<=s.entryMaxSpread,`${u.toFixed(2)}/${s.entryMaxSpread}`),u>s.entryMaxSpread)return O(`Spread too wide: ${u.toFixed(1)}`,"spread");if(s.volumeInfluenceEnabled){const A=Math.max(.1,s.indexVolumeMinRatio||1),z=Math.max(.1,s.optionVolumeMinRatio||1),X=Math.max(.1,s.sideVolumeDominanceRatio||1),se=Math.max(0,s.volumeScoreWeight||0),ue=h?.indexDeltaRatio??null,fe=h?.optionDeltaRatio??null,Se=h?.sideDominanceRatio??null,Me=h?.indexDelta,R=h?.optionDelta,B=h?.oppositeDelta,Z=ue==null?!0:ue>=A,re=fe==null?!0:fe>=z,ee=Se==null?!0:Se>=X;if($("volume-index","Index volume flow",Z,ue==null?"NA":`${ue.toFixed(2)}x/${A.toFixed(2)}x d:${(Me??0).toFixed(0)}`),$("volume-option",`${e} volume flow`,re,fe==null?"NA":`${fe.toFixed(2)}x/${z.toFixed(2)}x d:${(R??0).toFixed(0)}`),$("volume-dominance",`${e} vs opposite volume`,ee,Se==null?"NA":`${Se.toFixed(2)}x/${X.toFixed(2)}x opp:${(B??0).toFixed(0)}`),fe!=null&&Se!=null&&!re&&!ee)return O(`Weak ${e} volume participation`,"volume-option");ue!=null&&Z&&se>0&&(g+=.5*se,x.push(`IdxVol x${ue.toFixed(2)}`)),fe!=null&&re&&se>0&&(g+=1*se,x.push(`${e}Vol x${fe.toFixed(2)}`)),Se!=null&&ee&&se>0&&(g+=.75*se,x.push(`${e}>Opp x${Se.toFixed(2)}`))}else $("volume-influence","Volume influence",!0,"OFF");const U=s.noTradeZoneEnabled&&co(m,s.noTradeZoneRangePts,s.noTradeZonePeriod);if($("no-trade-zone","No-trade zone filter",!U,s.noTradeZoneEnabled?`${s.noTradeZonePeriod} bars/${s.noTradeZoneRangePts}pts`:"OFF"),U)return O(`No-trade zone (${s.noTradeZonePeriod} candles in ${s.noTradeZoneRangePts} pts range)`,"no-trade-zone");const _=e==="CE"?"up":"down";$("momentum-direction","Momentum alignment",a.direction===_,`${a.direction} x${a.count}`),a.direction===_&&a.count>=s.entryMomentumCount?(g+=3,x.push(`Momentum ${a.direction} x${a.count}`)):a.direction===_&&(g+=1,x.push(`Weak momentum ${a.direction}`)),$("velocity","Velocity threshold",a.velocity>=s.entryMomentumVelocity,`${a.velocity.toFixed(2)}/${s.entryMomentumVelocity}`),a.velocity>=s.entryMomentumVelocity&&(g+=2,x.push(`Velocity ${a.velocity.toFixed(1)}`));let q=!1;i.ema9!==null&&i.ema21!==null&&(q=e==="CE"&&i.ema9>i.ema21||e==="PE"&&i.ema9<i.ema21,q&&(g+=1,x.push("EMA aligned"))),$("ema","EMA alignment",q,i.ema9!=null&&i.ema21!=null?`${i.ema9.toFixed(2)}/${i.ema21.toFixed(2)}`:"NA");let N=!1;i.rsi!==null&&(N=e==="CE"&&i.rsi>50&&i.rsi<80||e==="PE"&&i.rsi<50&&i.rsi>20,N&&(g+=1,x.push(`RSI ${i.rsi.toFixed(0)}`))),$("rsi","RSI alignment",N,i.rsi!=null?i.rsi.toFixed(1):"NA");let Q=!1;s.indexBiasEnabled&&(Q=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",Q&&(g+=1,x.push(`Index ${o.direction}`))),$("index-bias","Index bias alignment",s.indexBiasEnabled?Q:!0,s.indexBiasEnabled?`${o.direction}`:"OFF");const y=po(e,c,s);return $("options-context","Options context filter",y.allowed,y.reason),y.allowed?($("score-gate","Final score gate",g>=M,`${g.toFixed(1)}/${M.toFixed(1)}`),{enter:g>=M,reason:x.join(", ")||"No strong signals",score:g,minScore:Number(M.toFixed(2)),checks:k,spread:u,depthRatio:P,expectedSlippage:Math.max(0,u/2)}):O(y.reason,"options-context")}function go(e,t,s,r,a,i,o){const c=a?s-t:t-s,l=a?r-t:t-r,u=mo(i.trailInitialSL,o,i);if(e==="INITIAL"){const m=i.breakevenTriggerPts>0?i.breakevenTriggerPts:i.trailBreakevenTrigger;return c>=m?{newSL:t+(a?i.breakevenBuffer:-i.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:a?t-u:t+u,newStage:"INITIAL"}}return e==="BREAKEVEN"?l>=i.trailLockTrigger?{newSL:a?t+i.trailLockAmount:t-i.trailLockAmount,newStage:"LOCK"}:{newSL:t+(a?i.breakevenBuffer:-i.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?l>=i.trailStartTrigger?{newSL:a?r-i.trailStepSize:r+i.trailStepSize,newStage:"TRAIL"}:{newSL:a?t+i.trailLockAmount:t-i.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?l>=i.trailTightTrigger?{newSL:a?r-i.trailTightStep:r+i.trailTightStep,newStage:"TIGHT"}:{newSL:a?r-i.trailStepSize:r+i.trailStepSize,newStage:"TRAIL"}:{newSL:a?r-i.trailTightStep:r+i.trailTightStep,newStage:"TIGHT"}}function yo(e,t,s,r,a,i,o){return!a.enter||a.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:s,score:a.score,reason:a.reason,regime:i,pcr:o}}const bo=2;function Xs(e,t){if(e.length<t)return null;const s=2/(t+1);let r=e.slice(0,t).reduce((a,i)=>a+i,0)/t;for(let a=t;a<e.length;a++)r=e[a]*s+r*(1-s);return Number.isFinite(r)?r:null}function vo(e,t=14){if(e.length<t+1)return null;let s=0,r=0;for(let l=1;l<=t;l++){const u=e[l]-e[l-1];u>0?s+=u:r+=-u}let a=s/t,i=r/t;for(let l=t+1;l<e.length;l++){const u=e[l]-e[l-1],p=u>0?u:0,m=u<0?-u:0;a=(a*(t-1)+p)/t,i=(i*(t-1)+m)/t}if(i===0)return 100;const c=100-100/(1+a/i);return Number.isFinite(c)?c:null}function Qs(e){return{ema9:Xs(e,9),ema21:Xs(e,21),supertrend:null,rsi:vo(e,14),vwap:null}}function qn(e){return typeof e!="number"||!Number.isFinite(e)||e<0?null:e}function Gn(e,t,s=360){e.push(t),e.length>s&&e.splice(0,e.length-s)}function Kn(e,t){if(e.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const s=Math.max(3,t+1),r=e.slice(-s);if(r.length<3)return{latestDelta:null,avgDelta:null,ratio:null};const a=[];for(let u=1;u<r.length;u++){const p=r[u]-r[u-1];a.push(p>0&&Number.isFinite(p)?p:0)}if(a.length<2)return{latestDelta:null,avgDelta:null,ratio:null};const i=a[a.length-1],o=a.slice(0,-1),c=o.length>0?o.reduce((u,p)=>u+p,0)/o.length:0,l=c>0?i/c:null;return{latestDelta:i,avgDelta:c>0?c:null,ratio:l}}function So(e){return e==="TRAIL"||e==="TIGHT"||e==="ACCELERATED"}function Po(e){const s=Ae(F=>F.apiKey),r=Ae(F=>F.setApiKey),a=S(F=>F.underlying),i=S(F=>F.indexExchange),o=S(F=>F.selectedCESymbol),c=S(F=>F.selectedPESymbol),l=S(F=>F.optionExchange),u=S(F=>F.quantity),p=S(F=>F.lotSize),m=S(F=>F.product),h=S(F=>F.tpPoints),g=S(F=>F.slPoints),x=S(F=>F.selectedStrike),f=S(F=>F.paperMode),k=W(F=>F.enabled),P=W(F=>F.mode),j=W(F=>F.config),w=W(F=>F.activePresetId),M=W(F=>F.optionsContext),$=W(F=>F.regime),O=W(F=>F.consecutiveLosses),H=W(F=>F.tradesCount),Y=W(F=>F.realizedPnl),I=W(F=>F.lastTradePnl),E=W(F=>F.lastTradeTime),K=W(F=>F.tradesThisMinute),J=W(F=>F.lastLossTime),T=W(F=>F.sideEntryCount),L=W(F=>F.sideLastExitAt),D=W(F=>F.replayMode),b=W(F=>F.killSwitch),C=W(F=>F.setRegime),U=W(F=>F.addGhostSignal),_=W(F=>F.recordTrade),q=W(F=>F.recordAutoEntry),N=W(F=>F.pushDecision),Q=W(F=>F.pushExecutionSample),y=ce(F=>F.virtualTPSL),A=ce(F=>F.setVirtualTPSL),z=d.useRef([]),X=d.useRef([]),se=d.useRef([]),ue=d.useRef([]),fe=d.useRef([]),Se=d.useRef([]),Me=d.useRef(0),R=d.useRef(!1),B=d.useRef({CE:"",PE:""}),Z=d.useRef({CE:0,PE:0}),re=d.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}}),ee=d.useRef(0),Ee=d.useCallback(async()=>{if(s)return s;try{const he=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(he.status==="success"&&he.api_key)return r(he.api_key),he.api_key}catch(F){console.error("[AutoTrade] Failed to fetch API key:",F)}return null},[s,r]);d.useEffect(()=>{if(!k||!e)return;const F=Date.now();if(F-Me.current<100)return;Me.current=F;const he=o,$e=c,Te=e.get(`${i}:${a}`)?.data?.ltp,ge=he?e.get(`${l}:${he}`)?.data?.ltp:void 0,ve=$e?e.get(`${l}:${$e}`)?.data?.ltp:void 0,Ue=qn(e.get(`${i}:${a}`)?.data?.volume),V=he?qn(e.get(`${l}:${he}`)?.data?.volume):null,ie=$e?qn(e.get(`${l}:${$e}`)?.data?.volume):null;Te&&(z.current.push(Te),z.current.length>300&&(z.current=z.current.slice(-300))),ge&&(X.current.push(ge),X.current.length>300&&(X.current=X.current.slice(-300))),ve&&(se.current.push(ve),se.current.length>300&&(se.current=se.current.slice(-300))),Ue!=null&&Gn(ue.current,Ue),V!=null&&Gn(fe.current,V),ie!=null&&Gn(Se.current,ie);const Pe=Math.max(5,Number(j.volumeLookbackTicks)||20),He=Kn(ue.current,Pe),Be=Kn(fe.current,Pe),ze=Kn(Se.current,Pe),Ge=w==="expiry",{sensitivity:nt}=Yn(new Date,Ge),Ct=M&&F-M.lastUpdated<=2e4?M:null;for(const le of["CE","PE"]){const Ce=le==="CE"?he:$e,pe=le==="CE"?ge:ve,Fe=le==="CE"?X.current:se.current,De=Object.values(y).filter(ke=>ke.side===le),Ve=De.filter(ke=>ke.managedBy==="auto"),st=De.length>0,bt=De.reduce((ke,Ye)=>ke+Math.max(0,Ye.quantity||0),0),Xe=p>0?bt/p:0,St=Number.isFinite(Xe)?Xe:0,dt=le==="CE"?Be:ze,Pt=le==="CE"?ze:Be,jt=dt.latestDelta!=null&&Pt.latestDelta!=null?dt.latestDelta/Math.max(1,Pt.latestDelta):null,nn={indexDelta:He.latestDelta,indexDeltaRatio:He.ratio,optionDelta:dt.latestDelta,optionDeltaRatio:dt.ratio,oppositeDelta:Pt.latestDelta,sideDominanceRatio:jt};if(!Ce||!pe||Fe.length<5)continue;let rt=0;for(const ke of De){const Ye=`${ke.exchange}:${ke.symbol}`,Je=e.get(Ye)?.data?.ltp??(ke.symbol===Ce?pe:void 0);!Je||Je<=0||(rt+=ke.action==="BUY"?(Je-ke.entryPrice)*ke.quantity:(ke.entryPrice-Je)*ke.quantity)}const vt=Ve.some(ke=>So(ke.trailStage)),_t=u+bo,Bt=Math.max(0,Math.floor(_t-St+1e-6)),Lt=w==="adaptive-scalper"&&st&&Ve.length>0&&vt&&rt>0&&Bt>0,je=Lt?Math.max(1,Math.min(u,Bt)):u,v=oo(Fe,j),G=Qs(Fe),ne=Qs(z.current),ye=uo(ne,j),Ne=`${l}:${Ce}`,ae=e.get(Ne)?.data?.bid_price,be=e.get(Ne)?.data?.ask_price,me=ae&&be?be-ae:2,Re=e.get(Ne)?.data?.depth;let qe;if(Re?.buy?.length&&Re?.sell?.length){const ke=Re.buy.reduce((Je,ht)=>Je+(ht.quantity||0),0),Ye=Re.sell.reduce((Je,ht)=>Je+(ht.quantity||0),0);ke>0&&Ye>0&&(qe={totalBid:ke,totalAsk:Ye})}const Vt={consecutiveLosses:O,tradesCount:H,realizedPnl:Y,lastTradeTime:E,tradesThisMinute:K,lastLossTime:J,requestedLots:Lt?St+je:u,sideOpen:st,openSideLots:St,allowEntryWithOpenSide:Lt,lastExitAtForSide:L[le],reEntryCountForSide:T[le],lastTradePnl:I,killSwitch:b},de=ho(le,pe,j,Vt,v,G,ye,Ct,nt,me,qe,Fe,nn),ot=`${de.enter}|${de.blockedBy??""}|${de.reason}|${de.score.toFixed(2)}|${de.minScore.toFixed(2)}`;(ot!==B.current[le]||F-Z.current[le]>=1e3)&&(N({timestamp:F,side:le,symbol:Ce,enter:de.enter,score:de.score,minScore:de.minScore,reason:de.reason,blockedBy:de.blockedBy,spread:de.spread,depthRatio:de.depthRatio,expectedSlippage:de.expectedSlippage,checks:de.checks,regime:$}),B.current[le]=ot,Z.current[le]=F);const qt=yo(le,Ce,x??0,pe,de,$,Ct?.pcr);if(qt){const ke=`${Ce}|${de.reason}|${de.score.toFixed(1)}`,Ye=re.current[le];(ke!==Ye.sig||F-Ye.at>=2500)&&(U(qt),re.current[le]={at:F,sig:ke},Ie.message(`Signal ${le} ${Ce.slice(-12)}`,{description:`${de.score.toFixed(1)} / ${de.minScore.toFixed(1)} | ${de.reason}`}))}if(P==="execute"&&!D&&de.enter&&!R.current){R.current=!0;const ke="BUY",Ye=je*p;(async()=>{const ht=()=>{const pt=W.getState();return pt.enabled&&pt.mode==="execute"&&!pt.replayMode&&!pt.killSwitch};try{if(!ht()){Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Execution skipped: mode/risk changed"});return}const pt=f?null:await Ee();if(!f&&!pt){Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Missing API key"}),Date.now()-ee.current>5e3&&(ee.current=Date.now(),Ie.error("Auto execute blocked: API key missing"));return}let On=null;if(!f&&pt){const _r={apikey:pt,strategy:"Scalping-Auto",exchange:l,symbol:Ce,action:ke,quantity:Ye,pricetype:"MARKET",product:m,price:0,trigger_price:0,disclosed_quantity:0},ls=await we.placeOrder(_r);if(ls.status!=="success"){Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Order rejected"});return}On=Ft(ls),console.log(`[AutoTrade] ${ke} ${Ce} id=${On??"n/a"} score=${de.score}`)}else console.log(`[AutoTrade Paper] ${ke} ${le} ${Ce} score=${de.score}`);if(!ht()){Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Execution skipped before virtual attach: mode/risk changed"});return}const yn=f?await tn({symbol:Ce,exchange:l,preferredPrice:pe,apiKey:null}):await zt({symbol:Ce,exchange:l,orderId:On,preferredPrice:pe,apiKey:pt}),Or=Math.max(2,Number(j.trailLockTrigger)||8),Fr=Math.max(2,Number(j.trailInitialSL)||5),Dr=h>0?h:Or,zr=g>0?g:Fr;yn>0&&A(xt({symbol:Ce,exchange:l,side:le,action:ke,entryPrice:yn,quantity:Ye,tpPoints:Dr,slPoints:zr,managedBy:"auto",autoEntryScore:de.score,autoEntryReason:de.reason})),_(0),q(le),Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:Math.max(0,Math.abs((yn>0?yn:pe)-pe)),status:"filled",reason:de.reason}),j.telegramAlertsEntry&&as.sendBroadcast({message:`[AUTO ENTRY] ${le} ${Ce} qty=${Ye} score=${de.score.toFixed(1)} reason=${de.reason}`}).catch(()=>{})}catch(pt){Q({timestamp:Date.now(),side:le,symbol:Ce,spread:de.spread,expectedSlippage:de.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",pt)}finally{R.current=!1}})()}}const oe=z.current.length>=j.regimeDetectionPeriod?z.current:X.current;if(oe.length>=j.regimeDetectionPeriod){const le=oe.slice(-j.regimeDetectionPeriod).map((pe,Fe,De)=>({high:Math.max(pe,De[Math.max(0,Fe-1)]??pe),low:Math.min(pe,De[Math.max(0,Fe-1)]??pe),close:pe})),Ce=lo(le,j);Ce!==$&&C(Ce)}},[k,e,P,j,w,o,c,M,$,O,H,Y,E,K,J,I,T,L,D,b,Ee,l,u,p,m,h,g,f,x,U,_,q,N,Q,C,y,A,a,i])}const jo=3e3;function No(e){const t=Ae(I=>I.apiKey),s=Ae(I=>I.setApiKey),r=S(I=>I.paperMode),a=S(I=>I.product),i=S(I=>I.addSessionPnl),o=S(I=>I.incrementTradeCount),c=W(I=>I.config),l=W(I=>I.activePresetId),u=W(I=>I.optionsContext),p=W(I=>I.recordAutoExit),m=W(I=>I.recordTradeOutcome),h=W(I=>I.pushExecutionSample),g=ce(I=>I.virtualTPSL),x=ce(I=>I.triggerOrders),f=ce(I=>I.removeTriggerOrder),k=ce(I=>I.setVirtualTPSL),P=ce(I=>I.removeVirtualTPSL),j=d.useRef(t),w=d.useRef(r),M=d.useRef(a);d.useEffect(()=>{j.current=t},[t]),d.useEffect(()=>{w.current=r},[r]),d.useEffect(()=>{M.current=a},[a]);const $=d.useRef(new Set),O=d.useCallback(async()=>{if(j.current)return j.current;try{const E=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(E.status==="success"&&E.api_key)return j.current=E.api_key,s(E.api_key),E.api_key}catch(I){console.error("[Scalping] Failed to fetch API key:",I)}return console.warn("[Scalping] No API key available — generate one at /apikey"),null},[s]),H=d.useCallback(async(I,E,K,J,T)=>{const L=J==="BUY"?"SELL":"BUY";if(w.current)return console.log(`[Paper TP/SL] ${T}: ${L} ${I} qty=${K}`),!0;const D=await O();if(!D)return!1;const b={apikey:D,strategy:"Scalping",exchange:E,symbol:I,action:L,quantity:K,pricetype:"MARKET",product:M.current,price:0,trigger_price:0,disclosed_quantity:0};try{const C=await we.placeOrder(b);if(C.status==="success"){const U=Ft(C);return console.log(`[Scalping TP/SL] ${T}: ${L} ${I} id=${U??"n/a"}`),!0}}catch(C){console.error(`[Scalping TP/SL] ${T} order failed:`,C)}try{if((await we.closePosition(I,E,M.current)).status==="success")return console.log(`[Scalping TP/SL] ${T}: closePosition fallback ${I}`),!0}catch(C){console.error(`[Scalping TP/SL] ${T} closePosition fallback failed:`,C)}return!1},[O]),Y=d.useCallback(async(I,E,K,J)=>{if(w.current)return console.log(`[Paper Trigger] Entry: ${J} ${I} qty=${K}`),{ok:!0,orderId:null};const T=await O();if(!T)return{ok:!1,orderId:null};const L={apikey:T,strategy:"Scalping",exchange:E,symbol:I,action:J,quantity:K,pricetype:"MARKET",product:M.current,price:0,trigger_price:0,disclosed_quantity:0};try{const D=await we.placeOrder(L);if(D.status==="success"){const b=Ft(D);return console.log(`[Scalping Trigger] Entry: ${J} ${I} id=${b??"n/a"}`),{ok:!0,orderId:b}}}catch(D){console.error("[Scalping Trigger] Entry failed:",D)}return{ok:!1,orderId:null}},[O]);d.useEffect(()=>{if(!e)return;const I=(E,K,J)=>{$.current.add(E.id);const L=E.action==="BUY"?(K-E.entryPrice)*E.quantity:(E.entryPrice-K)*E.quantity;H(E.symbol,E.exchange,E.quantity,E.action,`${J} at ${K}`).then(D=>{D&&(P(E.id),i(L),o(),E.managedBy==="auto"&&(p(E.side,L),m(L),h({timestamp:Date.now(),side:E.side,symbol:E.symbol,spread:0,expectedSlippage:0,status:"exited",reason:J}),c.telegramAlertsExit&&as.sendBroadcast({message:`[AUTO EXIT] ${E.side} ${E.symbol} pnl=${L.toFixed(0)} reason=${J}`}).catch(()=>{}))),$.current.delete(E.id)})};for(const E of Object.values(g)){const K=`${E.exchange}:${E.symbol}`,T=(e.get(K)??e.get(E.symbol))?.data?.ltp;if(!T||$.current.has(E.id))continue;const L=E.action==="BUY",D=L?(T-E.entryPrice)*E.quantity:(E.entryPrice-T)*E.quantity;if(E.managedBy==="auto"){if(c.perTradeMaxLoss>0&&D<=-c.perTradeMaxLoss){I(E,T,`Per-trade max loss ${c.perTradeMaxLoss}`);continue}if(Math.max(0,Date.now()-(E.createdAt||0))>=jo){const C=l==="adaptive-scalper"?{...c,ivSpikeExitEnabled:!1}:c,U=fo(E.side,u,C);if(U.exit){I(E,T,`Options early-exit: ${U.reason}`);continue}}}if(E.tpPrice!==null&&(L?T>=E.tpPrice:T<=E.tpPrice)){I(E,T,"TP hit");continue}E.slPrice!==null&&(L?T<=E.slPrice:T>=E.slPrice)&&I(E,T,"SL hit")}for(const E of Object.values(x)){const K=`${E.exchange}:${E.symbol}`,T=(e.get(K)??e.get(E.symbol))?.data?.ltp;if(!T||$.current.has(E.id))continue;(E.direction==="above"?T>=E.triggerPrice:T<=E.triggerPrice)&&($.current.add(E.id),Y(E.symbol,E.exchange,E.quantity,E.action).then(async({ok:D,orderId:b})=>{try{if(D&&(f(E.id),o(),T>0)){const C=j.current,U=w.current?T:await zt({symbol:E.symbol,exchange:E.exchange,orderId:b,preferredPrice:T,apiKey:C});U>0&&k(xt({symbol:E.symbol,exchange:E.exchange,side:E.side,action:E.action,entryPrice:U,quantity:E.quantity,tpPoints:E.tpPoints,slPoints:E.slPoints,managedBy:"trigger"}))}}finally{$.current.delete(E.id)}}))}},[e,g,x,H,Y,f,k,P,i,o,c,l,u,p,m,h])}const Js=2,kt=.05;function Zn(e){return Math.round(e/kt)*kt}function wo(e){return e.slPrice==null?!1:e.managedBy==="auto"||e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"}function To(e,t){return e.managedBy==="manual"||e.managedBy==="hotkey"||e.managedBy==="trigger"?!0:e.managedBy==="auto"&&t==="adaptive-scalper"}function er(e,t){const s={slPrice:t};if(e.tpPrice==null||e.slPrice==null)return s;const r=t-e.slPrice;if(Math.abs(r)<kt)return s;const a=Zn(e.tpPrice+r),o=e.action==="BUY"?Math.max(e.tpPrice,a):Math.min(e.tpPrice,a);return Math.abs(o-e.tpPrice)>=kt&&(s.tpPrice=o),s}function ko(){const e=W(f=>f.config),t=W(f=>f.activePresetId),s=W(f=>f.optionsContext),r=W(f=>f.setTrailStage),a=W(f=>f.setHighSinceEntry),i=ce(f=>f.virtualTPSL),o=ce(f=>f.updateVirtualTPSL),c=d.useRef(e),l=d.useRef(t),u=d.useRef(s),p=d.useRef({}),m=d.useRef({}),h=d.useRef({}),g=d.useRef({});d.useEffect(()=>{c.current=e},[e]),d.useEffect(()=>{l.current=t},[t]),d.useEffect(()=>{u.current=s},[s]);const x=d.useMemo(()=>Object.values(i).filter(f=>wo(f)),[i]);d.useEffect(()=>{const f=xn.getInstance(),k=new Set(x.map(P=>P.id));for(const[P,j]of Object.entries(g.current))k.has(P)||(j(),delete g.current[P],delete p.current[P],delete m.current[P],delete h.current[P]);for(const P of x)g.current[P.id]||(p.current[P.id]=P.trailStage??"INITIAL",m.current[P.id]=P.entryPrice,h.current[P.id]=P.slPrice??P.entryPrice,g.current[P.id]=f.subscribe(P.symbol,P.exchange,"LTP",j=>{const w=j.data.ltp;if(!w||w<=0)return;const M=ce.getState().virtualTPSL[P.id];if(!M||M.slPrice==null)return;const $=M.managedBy==="auto",O=M.action==="BUY",H=m.current[P.id]??M.entryPrice,Y=O?Math.max(H,w):Math.min(H,w);if(Y!==H&&(m.current[P.id]=Y,$&&a(Y)),To(M,l.current)){if(!(O?w>M.entryPrice:w<M.entryPrice))return;p.current[P.id]!=="TRAIL"&&(p.current[P.id]="TRAIL",$&&r("TRAIL"),o(P.id,{trailStage:"TRAIL"}));const U=O?w-Js:w+Js,_=Zn(U),q=M.slPrice,N=h.current[P.id],Q=O?Math.max(q??_,_):Math.min(q??_,_),y=q==null||Math.abs(Q-q)>=kt,A=N==null||Math.abs(Q-N)>=kt;y&&A&&(h.current[P.id]=Q,o(P.id,er(M,Q)));return}const I=p.current[P.id]??"INITIAL",E=go(I,M.entryPrice,w,Y,O,c.current,u.current);E.newStage!==I&&(p.current[P.id]=E.newStage,$&&r(E.newStage),o(P.id,{trailStage:E.newStage}));const K=Zn(E.newSL),J=M.slPrice,T=h.current[P.id],L=O?Math.max(J??K,K):Math.min(J??K,K),D=J==null||Math.abs(L-J)>=kt,b=T==null||Math.abs(L-T)>=kt;D&&b&&(h.current[P.id]=L,o(P.id,er(M,L)))}));return()=>{}},[x,a,r,o]),d.useEffect(()=>()=>{for(const f of Object.values(g.current))f();g.current={},p.current={},m.current={},h.current={}},[])}const Eo=2500;function os(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Et(e){return os(e)??0}function Co(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Lo(e){const t=os(e.pnl);if(t!==null)return t;const s=Et(e.ltp),r=Et(e.average_price),a=Math.abs(Et(e.quantity));return(Et(e.quantity)>0?s-r:r-s)*a}function Mo(){const e=Ae(j=>j.apiKey),t=Ae(j=>j.setApiKey),s=Zt(j=>j.unifiedMode),[r,a]=d.useState([]),[i,o]=d.useState(!1),c=d.useCallback(async()=>{if(e)return e;try{const w=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(w.status==="success"&&w.api_key)return t(w.api_key),w.api_key}catch{}return null},[e,t]),l=d.useCallback(async()=>{const j=await c();if(!j){o(!1);return}o(!0);try{const w=await we.getPositions(j);w.status==="success"&&w.data&&a(Array.isArray(w.data)?w.data:[])}catch{}finally{o(!1)}},[c]);d.useEffect(()=>{l();const j=setInterval(l,Eo);return()=>clearInterval(j)},[l]);const{data:u,isLive:p,isPaused:m}=Wr(r,{enabled:!s&&r.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),h=d.useMemo(()=>s?r:u,[s,r,u]),g=d.useMemo(()=>h.flatMap(j=>{const w=Co(j.symbol);if(!w)return[];const M=Et(j.quantity),$=Math.abs(M);if($===0)return[];const O=Et(j.ltp),H=Et(j.average_price),Y=M>0,I=Y?O-H:H-O,K=os(j.pnl)??I*$;return[{symbol:j.symbol,exchange:j.exchange,side:w,action:Y?"BUY":"SELL",quantity:$,avgPrice:H,ltp:O,pnl:K,pnlPoints:I,product:j.product}]}),[h]),x=d.useMemo(()=>r.some(j=>Et(j.quantity)!==0),[r]),f=d.useMemo(()=>h.reduce((j,w)=>j+Lo(w),0),[h]),k=d.useCallback(j=>g.find(w=>w.side===j),[g]),P=d.useMemo(()=>r.map(j=>({symbol:j.symbol,exchange:j.exchange})),[r]);return{positions:g,totalPnl:f,isLive:!s&&p&&x,isPaused:!s&&m,isLoading:i,refetch:l,getPositionForSide:k,positionSymbols:P}}const Ro=1e3,Io=100;function En(e){const t=Number(e);return Number.isFinite(t)&&t>0?t:null}function Ao(e){const t=String(e??"").trim().toUpperCase();return t==="BUY"||t==="SELL"?t:null}function $o(e,t){const s=String(e??"").trim().toUpperCase();return s==="CE"||s==="PE"?s:t.toUpperCase().endsWith("PE")?"PE":"CE"}function Oo(){const e=Ae(l=>l.apiKey),t=Ae(l=>l.setApiKey),s=S(l=>l.tpPoints),r=S(l=>l.slPoints),a=ce(l=>l.setVirtualTPSL),i=d.useRef(!1),o=d.useCallback(async()=>{if(e)return e;try{const u=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(u.status==="success"&&u.api_key)return t(u.api_key),u.api_key}catch{}return null},[e,t]),c=d.useCallback(async(l,u)=>{const p=Number(l.id);if(!Number.isInteger(p)||p<=0)return!1;const m=String(l.symbol??"").trim().toUpperCase(),h=String(l.exchange??"NFO").trim().toUpperCase(),g=Ao(l.action),x=Math.trunc(En(l.quantity)??0);if(!m||!g||x<=0)return!1;const f=`flow-${p}`;if(ce.getState().virtualTPSL[f])return!0;const P=$o(l.side,m),j=En(l.tp_points)??s,w=En(l.sl_points)??r,M=En(l.entry_price),$=String(l.order_id??"").trim()||null,O=await zt({symbol:m,exchange:h,orderId:$,preferredPrice:M,fallbackPrice:M,apiKey:u});if(!(O>0))return!1;const H=Number(l.created_at);return a(xt({id:f,symbol:m,exchange:h,side:P,action:g,entryPrice:O,quantity:x,tpPoints:j,slPoints:w,managedBy:"flow",createdAt:Number.isFinite(H)&&H>0?H:Date.now()})),!0},[s,r,a]);d.useEffect(()=>{let l=!0,u=null;async function p(){if(!l||i.current){m();return}i.current=!0;try{const h=await o();if(!h)return;const g=await we.getScalpingBridgePending(h,Io),x=Array.isArray(g.data?.entries)?g.data.entries:[];if(!x.length)return;const f=[];for(const k of x)try{await c(k,h)&&f.push(Number(k.id))}catch{}f.length&&await we.ackScalpingBridgeEntries(h,f)}catch{}finally{i.current=!1,m()}}function m(){l&&(u=setTimeout(p,Ro))}return p(),()=>{l=!1,u&&clearTimeout(u)}},[c,o])}const Fo=15e3;function tl(){const[e,t]=d.useState(!1),s=d.useRef(!1),r=d.useCallback(()=>t(y=>!y),[]),a=d.useCallback(()=>t(!1),[]),i=S(y=>y.paperMode),o=S(y=>y.underlying),c=S(y=>y.indexExchange),l=S(y=>y.optionExchange),u=S(y=>y.product),p=S(y=>y.quantity),m=S(y=>y.lotSize),h=S(y=>y.incrementTradeCount),g=S(y=>y.setLimitPrice),x=S(y=>y.setPendingEntryAction),f=S(y=>y.pendingLimitPlacement),k=S(y=>y.clearPendingLimitPlacement),P=S(y=>y.selectedCESymbol),j=S(y=>y.selectedPESymbol),w=ce(y=>y.virtualTPSL),M=ce(y=>y.triggerOrders),$=ce(y=>y.clearAll),O=ce(y=>y.clearForSymbol),H=ce(y=>y.clearTriggerOrders),Y=ce(y=>y.removeVirtualTPSL),I=ce(y=>y.updateVirtualTPSL),E=ce(y=>y.setVirtualTPSL),K=W(y=>y.config.imbalanceFilterEnabled),J=W(y=>y.updateRiskState),T=Ae(y=>y.apiKey),L=Ae(y=>y.setApiKey);d.useEffect(()=>{T||fetch("/api/websocket/apikey",{credentials:"include"}).then(y=>y.json()).then(y=>{y.status==="success"&&y.api_key&&L(y.api_key)}).catch(()=>{})},[T,L]),d.useEffect(()=>{H()},[H]);const D=d.useCallback(async(y,A)=>{if(i){console.log(`[Paper] Close ${y} ${A}`),O(A),g(null),x(null),k();return}try{await we.closePosition(A,l,u),console.log(`[Scalping] Closed ${y} ${A}`),O(A),g(null),x(null),k()}catch(z){console.error("[Scalping] Close failed:",z)}},[i,l,u,O,g,x,k]),b=d.useCallback(async()=>{if(i){console.log("[Paper] Close all positions"),$(),g(null),x(null),k();return}try{await we.closeAllPositions(),console.log("[Scalping] Closed all positions"),$(),g(null),x(null),k()}catch(y){console.error("[Scalping] Close all failed:",y)}},[i,$,g,x,k]),C=d.useCallback(async(y,A)=>{if(i){console.log(`[Paper] Reverse ${y} ${A}`);return}if(T)try{await we.closePosition(A,l,u),await we.placeOrder({apikey:T,strategy:"Scalping",exchange:l,symbol:A,action:"SELL",quantity:p*m,pricetype:"MARKET",product:u,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${y} ${A}`)}catch(z){console.error("[Scalping] Reversal failed:",z)}},[i,T,l,u,p,m]);Qa({onToggleHelp:r,onClose:D,onCloseAll:b,onReversal:C}),ao();const U=d.useMemo(()=>{const y=[];o&&c&&y.push({symbol:o,exchange:c}),P&&y.push({symbol:P,exchange:l}),j&&y.push({symbol:j,exchange:l});for(const z of Object.values(w))y.push({symbol:z.symbol,exchange:z.exchange});for(const z of Object.values(M))y.push({symbol:z.symbol,exchange:z.exchange});const A=new Map;for(const z of y)A.set(`${z.exchange}:${z.symbol}`,z);return Array.from(A.values())},[o,c,P,j,l,w,M]),{data:_}=pn({symbols:U,mode:K?"Quote":"LTP",enabled:U.length>0}),{positions:q,totalPnl:N,isLive:Q}=Mo();return Oo(),d.useEffect(()=>{J(N)},[N,J]),d.useEffect(()=>{if(i)return;const y=new Map(q.map(ue=>[ue.symbol,ue])),A=Object.values(w);for(const ue of A){const fe=y.get(ue.symbol);if(!fe){const Se=typeof ue.createdAt=="number"?ue.createdAt:0;if((Se>0?Date.now()-Se:Number.POSITIVE_INFINITY)<Fo)continue;Y(ue.id);continue}(fe.side!==ue.side||fe.action!==ue.action||ue.quantity<=0)&&Y(ue.id)}const z=Object.values(ce.getState().virtualTPSL),X=new Map;for(const ue of z){const fe=X.get(ue.symbol)??[];fe.push(ue),X.set(ue.symbol,fe)}for(const[ue,fe]of X.entries()){const Se=y.get(ue);if(!Se)continue;const Me=Math.max(0,Se.quantity);let B=fe.reduce((re,ee)=>re+Math.max(0,ee.quantity),0)-Me;if(B<=0)continue;const Z=[...fe].sort((re,ee)=>ee.createdAt-re.createdAt);for(const re of Z){if(B<=0)break;const ee=Math.max(0,re.quantity);if(ee<=B+1e-6){Y(re.id),B-=ee;continue}const Ee=Math.max(0,Number((ee-B).toFixed(2)));I(re.id,{quantity:Ee}),B=0}}if(!f||s.current)return;const se=y.get(f.symbol);se&&(se.side!==f.side||se.action!==f.action||(s.current=!0,(async()=>{try{const ue=await zt({symbol:f.symbol,exchange:se.exchange,orderId:f.orderId,preferredPrice:f.entryPrice,fallbackPrice:se.avgPrice,apiKey:T});if(ue<=0)return;E(xt({symbol:f.symbol,exchange:se.exchange,side:f.side,action:f.action,entryPrice:ue,quantity:f.quantity,tpPoints:f.tpPoints,slPoints:f.slPoints,managedBy:"manual"})),h(),k(),g(null),x(null)}finally{s.current=!1}})()))},[i,q,w,f,T,Y,I,E,h,k,g,x]),Po(_),ko(),No(_),n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsx(Ci,{liveOpenPnl:N,isLivePnl:Q}),n.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:n.jsxs(Wn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[n.jsx(It,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:n.jsx(Ri,{})}),n.jsx(Mn,{withHandle:!0,className:"bg-border/70"}),n.jsx(It,{defaultSize:"50%",minSize:"30%",children:n.jsx(Ta,{})}),n.jsx(Mn,{withHandle:!0,className:"bg-border/70"}),n.jsx(It,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:n.jsx(Ya,{liveOpenPnl:N,isLivePnl:Q})})]})}),n.jsx(Ii,{positions:q,totalPnl:N,isLivePnl:Q}),n.jsx(Xa,{open:e,onClose:a})]})}export{tl as default};
