import{A as L,C as z,E as c,G as r,H as l,w as h,d as A,z as _}from"./index-kkbtP63P.js";const M={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:20},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}};function q(t){if(typeof t=="string"){const e=t.toUpperCase();if(e in M)return e}return"NIFTY"}const T=L()(z(t=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,trailDistancePoints:2,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,lastOrderAck:null,setUnderlying:e=>{const n=M[e];t({underlying:e,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:e=>t(n=>n.expiry===e?n:{expiry:e,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:e=>t(n=>n.expiryWeek===e?n:{expiryWeek:e}),setExpiries:e=>t(n=>n.expiries.length===e.length&&n.expiries.every((s,i)=>s===e[i])?n:{expiries:e}),setChainStrikeCount:e=>t(n=>{const s=Math.max(5,e);return n.chainStrikeCount===s?n:{chainStrikeCount:s}}),setSelectedStrike:e=>t(n=>n.selectedStrike===e?n:{selectedStrike:e}),setActiveSide:e=>t({activeSide:e}),toggleActiveSide:()=>t(e=>({activeSide:e.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(e,n)=>t(s=>s.selectedCESymbol===e&&s.selectedPESymbol===n?s:{selectedCESymbol:e,selectedPESymbol:n}),setOptionChainSnapshot:(e,n,s)=>t(i=>{const o=Number.isFinite(n)?n:Date.now(),p=typeof s=="boolean"?s:i.optionChainIsStreaming;return i.optionChainData===e&&i.optionChainLastUpdate===o&&i.optionChainIsStreaming===p?i:{optionChainData:e,optionChainLastUpdate:o,optionChainIsStreaming:p}}),clearOptionChainSnapshot:()=>t(e=>e.optionChainData===null&&e.optionChainLastUpdate===0&&!e.optionChainIsStreaming?e:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:e=>t({quantity:Math.max(1,e)}),incrementQuantity:()=>t(e=>({quantity:e.quantity+1})),decrementQuantity:()=>t(e=>({quantity:Math.max(1,e.quantity-1)})),setOrderType:e=>t({orderType:e,...e==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:e=>t({product:e}),setTpPoints:e=>t({tpPoints:Math.max(0,e)}),setSlPoints:e=>t({slPoints:Math.max(0,e)}),setTrailDistancePoints:e=>t({trailDistancePoints:Math.max(0,e)}),setLimitPrice:e=>t(n=>n.limitPrice===e?n:{limitPrice:e}),setPendingEntryAction:e=>t(n=>n.pendingEntryAction===e?n:{pendingEntryAction:e}),setPendingLimitPlacement:e=>t(n=>{if(e===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const s={...e,trailDistancePoints:Math.max(0,Number(e.trailDistancePoints)||0),createdAt:e.createdAt??Date.now()},i=n.pendingLimitPlacement;return i&&i.symbol===s.symbol&&i.side===s.side&&i.action===s.action&&i.orderId===s.orderId&&i.quantity===s.quantity&&i.entryPrice===s.entryPrice&&i.tpPoints===s.tpPoints&&i.slPoints===s.slPoints&&i.trailDistancePoints===s.trailDistancePoints?n:{pendingLimitPlacement:s}}),clearPendingLimitPlacement:()=>t(e=>e.pendingLimitPlacement===null?e:{pendingLimitPlacement:null}),setPaperMode:e=>t(n=>n.paperMode===e?n:{paperMode:e}),setControlTab:e=>t({controlTab:e}),setHotkeysEnabled:e=>t({hotkeysEnabled:e}),setShowFloatingWidget:e=>t({showFloatingWidget:e}),toggleFloatingWidget:()=>t(e=>({showFloatingWidget:!e.showFloatingWidget})),setFloatingWidgetMinimized:e=>t(n=>n.floatingWidgetMinimized===e?n:{floatingWidgetMinimized:e}),toggleFloatingWidgetMinimized:()=>t(e=>({floatingWidgetMinimized:!e.floatingWidgetMinimized})),setChainCollapsed:e=>t({chainCollapsed:e}),setControlCollapsed:e=>t({controlCollapsed:e}),setCeWidgetPos:e=>t({ceWidgetPos:e}),setPeWidgetPos:e=>t({peWidgetPos:e}),setLotSize:e=>t({lotSize:e}),setChartInterval:e=>t({chartInterval:e}),addSessionPnl:e=>t(n=>({sessionPnl:n.sessionPnl+e})),incrementTradeCount:()=>t(e=>({tradeCount:e.tradeCount+1})),setLastOrderAck:e=>t(n=>{if(e===null)return n.lastOrderAck===null?n:{lastOrderAck:null};const s={...e,timestamp:e.timestamp??Date.now()},i=n.lastOrderAck;return i&&i.orderId===s.orderId&&i.broker===s.broker&&i.symbol===s.symbol&&i.action===s.action?n:{lastOrderAck:s}}),clearLastOrderAck:()=>t(e=>e.lastOrderAck===null?e:{lastOrderAck:null}),resetSession:()=>t({sessionPnl:0,tradeCount:0,lastOrderAck:null})}),{name:"openalgo-scalping",partialize:t=>({underlying:t.underlying,expiryWeek:t.expiryWeek,chainStrikeCount:t.chainStrikeCount,quantity:t.quantity,orderType:t.orderType,product:t.product,tpPoints:t.tpPoints,slPoints:t.slPoints,trailDistancePoints:t.trailDistancePoints,paperMode:t.paperMode,hotkeysEnabled:t.hotkeysEnabled,showFloatingWidget:t.showFloatingWidget,floatingWidgetMinimized:t.floatingWidgetMinimized,chartInterval:t.chartInterval,ceWidgetPos:t.ceWidgetPos,peWidgetPos:t.peWidgetPos}),merge:(t,e)=>{const n=t??{},s=q(n.underlying??e.underlying),i=M[s];return{...e,...n,underlying:s,optionExchange:i.optionExchange,indexExchange:i.indexExchange,lotSize:i.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,lastOrderAck:null}}}));function P(t){const e=String(t??"").toUpperCase();return e==="MIS"||e==="NRML"||e==="CNC"?e:"MIS"}function x(t){return String(t??"").trim().toUpperCase()}function C(t){if(typeof t=="number")return Number.isFinite(t)?t:0;if(typeof t=="string"){const e=Number(t.replace(/,/g,"").trim());return Number.isFinite(e)?e:0}return 0}function g(t){return t==="success"||t==="info"}async function S(){const t=A.getState().apiKey;if(t)return t;try{const n=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(n.status==="success"&&n.api_key)return A.getState().setApiKey(n.api_key),n.api_key}catch{}return null}function R(t){const e=t.orderid;if(typeof e=="string"&&e.trim().length>0)return e.trim();const n=t.data?.orderid;return typeof n=="string"&&n.trim().length>0?n.trim():""}function U(t,e){const n=R(e);if(!n)return;const i=r()?_.getState().executionBroker:A.getState().user?.broker??"unknown";T.getState().setLastOrderAck({orderId:n,broker:String(i).toUpperCase(),symbol:t.symbol,action:t.action,timestamp:Date.now()})}const E={getQuotes:async(t,e,n)=>r()?l("feed","quotes",{apikey:t,symbol:e,exchange:n}):(await c.post("/quotes",{apikey:t,symbol:e,exchange:n})).data,getMultiQuotes:async(t,e)=>r()?l("feed","multiquotes",{apikey:t,symbols:e}):(await c.post("/multiquotes",{apikey:t,symbols:e})).data,getHistory:async(t,e,n,s,i,o,p="api")=>r()?l("feed","history",{apikey:t,symbol:e,exchange:n,interval:s,start_date:i,end_date:o,source:p}):(await c.post("/history",{apikey:t,symbol:e,exchange:n,interval:s,start_date:i,end_date:o,source:p})).data,getDepth:async(t,e,n)=>r()?l("feed","depth",{apikey:t,symbol:e,exchange:n}):(await c.post("/depth",{apikey:t,symbol:e,exchange:n})).data,getFunds:async t=>r()?l("execution","funds",{apikey:t}):(await c.post("/funds",{apikey:t})).data,getPositions:async t=>r()?l("execution","positionbook",{apikey:t}):(await c.post("/positionbook",{apikey:t})).data,getOrders:async t=>r()?l("execution","orderbook",{apikey:t}):(await c.post("/orderbook",{apikey:t})).data,getTrades:async t=>r()?l("execution","tradebook",{apikey:t}):(await c.post("/tradebook",{apikey:t})).data,getHoldings:async t=>r()?l("execution","holdings",{apikey:t}):(await c.post("/holdings",{apikey:t})).data,placeOrder:async t=>{let e;return r()?e=await l("execution","placeorder",t):e=(await c.post("/placeorder",t)).data,e.status==="success"&&U(t,e),e},modifyOrder:async(t,e)=>{if(r()){const s=await S();return s?l("execution","modifyorder",{apikey:s,strategy:"Scalping",orderid:t,symbol:e.symbol,exchange:e.exchange,action:e.action,product:e.product,pricetype:e.pricetype,price:e.price,quantity:e.quantity,disclosed_quantity:e.disclosed_quantity??0,trigger_price:e.trigger_price??0}):{status:"error",message:"Missing API key"}}return(await h.post("/modify_order",{orderid:t,...e})).data},cancelOrder:async t=>{if(r()){const n=await S();return n?l("execution","cancelorder",{apikey:n,strategy:"Scalping",orderid:t}):{status:"error",message:"Missing API key"}}return(await h.post("/cancel_order",{orderid:t})).data},closePosition:async(t,e,n)=>{if(r()){const i=await S();if(!i)return{status:"error",message:"Missing API key"};const o=await E.getPositions(i);if(!g(o.status))return{status:"error",message:o.message??"Failed to fetch positions before close"};const u=(Array.isArray(o.data)?o.data:[]).filter(a=>C(a.quantity)!==0),b=x(t),y=x(e),d=P(n),m=u.filter(a=>x(a.symbol)===b),f=m.filter(a=>x(a.exchange)===y),k=f.filter(a=>P(a.product)===d),I=k.length>0?k:f.length>0?f:m;if(!I.length)return{status:"success",message:"No open position to close"};const W=await Promise.allSettled(I.map(a=>{const N=C(a.quantity),O=Math.abs(N),F=N>0?"SELL":"BUY";return E.placeOrder({apikey:i,strategy:"Scalping",exchange:a.exchange||e,symbol:a.symbol||t,action:F,quantity:O,pricetype:"MARKET",product:P(a.product??n),price:0,trigger_price:0,disclosed_quantity:0})}));let w=0;for(const a of W)(a.status!=="fulfilled"||!g(a.value.status))&&(w+=1);return w>0?{status:"error",message:`Failed to close ${w} position leg(s)`}:{status:"success",message:"Position closed"}}return(await h.post("/close_position",{symbol:t,exchange:e,product:n})).data},closeAllPositions:async()=>{if(r()){const e=await S();if(!e)return{status:"error",message:"Missing API key"};const n=async()=>{const o=await E.getPositions(e);if(!g(o.status))return{status:"error",message:o.message??"Failed to fetch positions before close-all"};const u=(Array.isArray(o.data)?o.data:[]).filter(d=>C(d.quantity)!==0);if(!u.length)return{status:"success",message:"No open positions to close"};const b=await Promise.allSettled(u.map(d=>{const m=C(d.quantity),f=Math.abs(m),k=m>0?"SELL":"BUY";return E.placeOrder({apikey:e,strategy:"Scalping",exchange:d.exchange,symbol:d.symbol,action:k,quantity:f,pricetype:"MARKET",product:P(d.product),price:0,trigger_price:0,disclosed_quantity:0})}));let y=0;for(const d of b)(d.status!=="fulfilled"||!g(d.value.status))&&(y+=1);return y>0?{status:"error",message:`Failed to close ${y} position(s)`}:{status:"success",message:"All positions closed"}};let s="";try{const o=await l("execution","closeposition",{apikey:e,strategy:"Scalping"});if(g(o.status)){await new Promise(u=>setTimeout(u,120));const p=await n();return g(p.status)?{status:"success",message:o.message??p.message??"All positions closed"}:p}s=String(o.message??"").trim()}catch(o){o instanceof Error&&(s=o.message)}const i=await n();return g(i.status)?i:s&&i.message?{status:"error",message:`${s}. ${i.message}`}:i}return(await h.post("/close_all_positions",{})).data},cancelAllOrders:async()=>{if(r()){const e=await S();return e?l("execution","cancelallorder",{apikey:e,strategy:"Scalping"}):{status:"error",message:"Missing API key"}}return(await h.post("/cancel_all_orders",{})).data},getScalpingBridgePending:async(t,e=50)=>(await c.post("/scalpingbridge/pending",{apikey:t,limit:e})).data,ackScalpingBridgeEntries:async(t,e)=>{const n=e.map(i=>Number(i)).filter(i=>Number.isInteger(i)&&i>0);return(await c.post("/scalpingbridge/ack",{apikey:t,ids:n})).data}};export{E as t,T as u};
