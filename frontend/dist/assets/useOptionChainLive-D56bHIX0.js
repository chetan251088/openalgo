import{r}from"./vendor-react-BsSNOS8Q.js";import{G as k,H as ee,E as te,g as be}from"./index-Dy6kfXgl.js";import{a as ge}from"./useMarketStatus-Cyc-5XWC.js";const ne=2500,ye={getOptionChain:async(t,e,s,o,a)=>k()?ee("feed","optionchain",{apikey:t,underlying:e,exchange:s,expiry_date:o,strike_count:a??20},"POST",{timeoutMs:ne}):(await te.post("/optionchain",{apikey:t,underlying:e,exchange:s,expiry_date:o,strike_count:a??20})).data,getExpiries:async(t,e,s,o="options")=>k()?ee("feed","expiry",{apikey:t,symbol:e,exchange:s,instrumenttype:o},"POST",{timeoutMs:ne}):(await te.post("/expiry",{apikey:t,symbol:e,exchange:s,instrumenttype:o})).data};function Se(t,e,s,o,a,m={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:i,refreshInterval:d=3e4,pauseWhenHidden:p=!0}=m,{isVisible:D}=be(),L=d>0,[A,g]=r.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),y=r.useRef(null),u=r.useRef(null),S=i&&(!p||D),C=r.useCallback(async()=>{if(!(!t||!e||!s||!o)&&!u.current){g(c=>({...c,isLoading:!0}));try{const c=new AbortController;u.current=c;const I=o.replace(/-/g,"").toUpperCase(),T=await ye.getOptionChain(t,e,s,I,a);T.status==="success"?g(U=>({...U,data:T,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):g(U=>({...U,isLoading:!1,error:T.message||"Failed to fetch option chain"}))}catch(c){c instanceof Error&&(c.name==="AbortError"?u.current===null&&g(I=>({...I,isLoading:!1})):g(I=>({...I,isLoading:!1,error:c.message||"Connection error",isConnected:!1})))}finally{u.current=null}}},[t,e,s,o,a]);r.useEffect(()=>{if(!S){y.current&&(clearInterval(y.current),y.current=null),g(c=>({...c,isPaused:!!i}));return}return g(c=>({...c,isConnected:!0,isPaused:!1})),C(),L&&(y.current=setInterval(C,d)),()=>{y.current&&(clearInterval(y.current),y.current=null),u.current&&(u.current.abort(),u.current=null)}},[S,C,d,i,L]);const h=r.useCallback(()=>{C()},[C]);return{...A,refetch:h}}const Ee=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),Ne=new Set(["SENSEX","BANKEX","SENSEX50"]);function se(t,e){return Ee.has(t)?"NSE_INDEX":Ne.has(t)?"BSE_INDEX":e==="BFO"?"BSE":"NSE"}function oe(t,e){if(t!=null)return!e||e<=0?t:Number((Math.round(t/e)*e).toFixed(2))}function z(t){if(typeof t=="number")return Number.isFinite(t)?t:null;if(typeof t=="string"&&t.trim().length>0){const e=Number(t);return Number.isFinite(e)?e:null}return null}function ve(t){const e=(t||"").trim().toUpperCase(),s=new Set;return e&&s.add(e),e==="NSE_INDEX"?s.add("NSE"):e==="BSE_INDEX"?s.add("BSE"):e==="NSE"?s.add("NSE_INDEX"):e==="BSE"&&s.add("BSE_INDEX"),Array.from(s)}function K(t,e,s,o){const a=(s||"").trim().toUpperCase();if(!a)return;const m=ve(o);for(const d of m){const p=t.get(`${d}:${a}`);if(p)return p}const i=e.get(a);if(!(!i||i.length===0)){for(const d of m){const p=i.find(D=>D.exchange.toUpperCase()===d);if(p)return p}return i[0]}}function Ce(t,e,s){if(!t.length||e==null||e<=0)return s;let o=t[0].strike,a=Math.abs(t[0].strike-e);for(const m of t){const i=Math.abs(m.strike-e);i<a&&(o=m.strike,a=i)}return o}const Ie=100;function we(t,e,s,o,a,m,i={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const d=o.toUpperCase(),p=e.toUpperCase(),{enabled:D,oiRefreshInterval:L=3e4,wsMode:A="LTP",pauseWhenHidden:g=!0}=i,[y,u]=r.useState(null),[S,C]=r.useState(null),{data:h,isLoading:c,isConnected:I,isPaused:T,error:U,lastUpdate:w,refetch:re}=Se(t,e,s,a,m,{enabled:D,refreshInterval:L,pauseWhenHidden:g}),F=r.useMemo(()=>{const f=[],E=se(e,o);if(f.push({symbol:e,exchange:E}),h?.chain)for(const b of h.chain)b.ce?.symbol&&f.push({symbol:b.ce.symbol,exchange:o}),b.pe?.symbol&&f.push({symbol:b.pe.symbol,exchange:o});return f},[h?.chain,o,e]),{data:O,isConnected:ae,isAuthenticated:le,isPaused:ie}=ge({symbols:F,mode:A,enabled:D&&F.length>0}),G=r.useRef(0),M=r.useRef(null),$=r.useRef(O),j=r.useRef(h);$.current=O,j.current=h;const q=r.useMemo(()=>()=>{M.current=null;const f=j.current,E=$.current;if(!f){u(null);return}if(E.size===0){u(f);return}const b=new Map;for(const[,n]of E){const N=n.symbol.toUpperCase(),v=b.get(N);v?v.push(n):b.set(N,[n])}const J=f.chain.map(n=>{let N=!1,v=!1,B=n.ce?.ltp,x=n.pe?.ltp,X=n.ce?.volume,W=n.pe?.volume,Y=n.ce?.oi,H=n.pe?.oi;if(n.ce?.symbol){const l=K(E,b,n.ce.symbol,d)?.data;if(l?.ltp!==void 0){const P=oe(l.ltp,n.ce.tick_size);P!==void 0&&P!==n.ce.ltp&&(B=P,N=!0)}l?.volume!==void 0&&l.volume!==n.ce.volume&&(X=l.volume,N=!0);const _=l?.oi??l?.open_interest;_!==void 0&&_!==n.ce.oi&&(Y=_,N=!0)}if(n.pe?.symbol){const l=K(E,b,n.pe.symbol,d)?.data;if(l?.ltp!==void 0){const P=oe(l.ltp,n.pe.tick_size);P!==void 0&&P!==n.pe.ltp&&(x=P,v=!0)}l?.volume!==void 0&&l.volume!==n.pe.volume&&(W=l.volume,v=!0);const _=l?.oi??l?.open_interest;_!==void 0&&_!==n.pe.oi&&(H=_,v=!0)}if(!N&&!v)return n;const V={...n};return N&&n.ce&&(V.ce={...n.ce,...B!==void 0?{ltp:B}:{},...X!==void 0?{volume:X}:{},...Y!==void 0?{oi:Y}:{}}),v&&n.pe&&(V.pe={...n.pe,...x!==void 0?{ltp:x}:{},...W!==void 0?{volume:W}:{},...H!==void 0?{oi:H}:{}}),V});let Q=!1;for(const[,n]of E)if(n.lastUpdate&&n.lastUpdate>G.current){Q=!0,G.current=n.lastUpdate;break}Q&&C(new Date);const fe=se(p,d).toUpperCase(),pe=K(E,b,p,fe),Z=z(pe?.data?.ltp)??z(f.underlying_ltp)??f.underlying_ltp,me=Ce(J,z(Z),f.atm_strike);u({...f,underlying_ltp:Z,atm_strike:me,chain:J})},[d,p]),R=r.useCallback(()=>{M.current!==null&&(clearTimeout(M.current),M.current=null)},[]);r.useEffect(()=>{if(!h){R(),u(null);return}if(O.size===0){R(),u(h);return}M.current===null&&(M.current=setTimeout(q,Ie))},[R,h,O,q]),r.useEffect(()=>R,[R]);const ue=ae&&le&&F.length>0,ce=T||ie,de=r.useMemo(()=>!w&&!S?null:w?S&&S>w?S:w:S,[w,S]);return{data:y,isLoading:c,isConnected:I,isStreaming:ue,isPaused:ce,error:U,lastUpdate:de,streamingSymbols:F.length,refetch:re}}export{ye as o,we as u};
