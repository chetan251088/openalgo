import{r as i,j as e}from"./vendor-react-BsSNOS8Q.js";import{t as v}from"./tomic-DFTKXRhI.js";import{s as $,B as J,e as y}from"./index-CqJWD5ZF.js";import{C as r,a as l,b as c,d,c as k}from"./card-Cne1e1p9.js";import{T as D,a as L,b as p,c as h,d as E,e as o}from"./table-B0jmSfkx.js";import{i as K,R as V,T as X}from"./vendor-icons-BJR3KiwM.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-b1Q1Drqs.js";import"./vendor-radix-DB8xhlcH.js";function u(n){return n.toLocaleString("en-IN",{maximumFractionDigits:2})}function a(n){return n==null?"—":typeof n=="number"||typeof n=="boolean"||typeof n=="string"?String(n):JSON.stringify(n)}function le(){const[n,T]=i.useState(!0),[O,P]=i.useState(!1),[F,z]=i.useState(null),[g,H]=i.useState(null),[Q,U]=i.useState(null),[S,W]=i.useState(null),N=i.useCallback(async(s=!1)=>{s?P(!0):T(!0);try{const[t,x,m,A]=await Promise.allSettled([v.getPositions(),v.getMetrics(),v.getStatus(),v.getSignalQuality(!1)]);t.status==="fulfilled"&&z(t.value),x.status==="fulfilled"&&H(x.value),m.status==="fulfilled"&&U(m.value),A.status==="fulfilled"&&W(A.value)}catch{s||$.error("Failed to load TOMIC risk cockpit","monitoring")}finally{s?P(!1):T(!1)}},[]);i.useEffect(()=>{N(!1);const s=setInterval(()=>{N(!0)},5e3);return()=>clearInterval(s)},[N]);const _=F?.positions??[],j=i.useMemo(()=>{const s=new Map;for(const t of _){const x=t.instrument||"UNKNOWN",m=s.get(x)??{instrument:x,quantity:0,notional:0,pnl:0,strategies:new Set};m.quantity+=Number(t.quantity)||0,m.notional+=Math.abs((Number(t.quantity)||0)*(Number(t.avg_price)||0)),m.pnl+=Number(t.pnl)||0,t.strategy_id&&m.strategies.add(t.strategy_id),s.set(x,m)}return Array.from(s.values()).sort((t,x)=>x.notional-t.notional)},[_]),G=i.useMemo(()=>j.reduce((s,t)=>s+t.notional,0),[j]),b=i.useMemo(()=>j.reduce((s,t)=>s+t.pnl,0),[j]),q=g?.data?.circuit_breakers??{},M=g?.data?.freshness??{},B=g?.data?.ws_data??{},C=g?.data?.market_bridge??{},R=Q?.data?.signal_loop,w=S?.data?.signals,f=S?.data?.risk?.counters??{},I=S?.data?.risk?.recent_evaluations??[];return n?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6 py-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(K,{className:"h-6 w-6"}),"TOMIC Risk Cockpit"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Circuit breaker state, feed freshness, and live portfolio exposure."})]}),e.jsxs(J,{variant:"outline",onClick:()=>{N(!0)},disabled:O,children:[e.jsx(V,{className:`h-4 w-4 mr-2 ${O?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Gross Notional"})}),e.jsx(d,{children:e.jsx("p",{className:"text-2xl font-bold",children:u(G)})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Open Positions"})}),e.jsx(d,{children:e.jsx("p",{className:"text-2xl font-bold",children:_.length})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Portfolio P&L"})}),e.jsx(d,{children:e.jsxs("p",{className:`text-2xl font-bold ${b<0?"text-red-500":b>0?"text-green-500":""}`,children:[b>=0?"+":"",u(b)]})})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Signal Loop State"})}),e.jsxs(d,{className:"space-y-1",children:[e.jsx(y,{variant:R?.running?"default":"secondary",children:R?.running?"RUNNING":"STOPPED"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["last error: ",R?.last_error||"none"]})]})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Enqueued / Dedupe"})}),e.jsxs(d,{children:[e.jsx("p",{className:"text-2xl font-bold",children:u(Number(w?.enqueued_count??0))}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["dedupe skips: ",u(Number(w?.dedupe_skipped_count??0))]})]})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(c,{className:"text-sm",children:"Bridge Tick Age"})}),e.jsx(d,{children:e.jsxs("p",{className:"text-2xl font-bold",children:[a(C.last_tick_age_s??"—"),"s"]})})]})]}),e.jsxs(r,{children:[e.jsxs(l,{children:[e.jsx(c,{children:"Risk Pipeline Counters"}),e.jsx(k,{children:"Latest outcome counts from Risk Agent evaluation loop."})]}),e.jsxs(d,{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsxs("div",{children:["evaluated: ",a(f.evaluated)]}),e.jsxs("div",{children:["blocked_regime: ",a(f.blocked_regime)]}),e.jsxs("div",{children:["rejected_sizing: ",a(f.rejected_sizing)]}),e.jsxs("div",{children:["enqueued: ",a(f.enqueued)]}),e.jsxs("div",{children:["duplicate: ",a(f.duplicate)]}),e.jsxs("div",{children:["latest_result: ",a(I[0]?.result)]}),e.jsxs("div",{children:["latest_reason: ",a(I[0]?.reason)]})]})]}),e.jsxs("div",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs(r,{children:[e.jsxs(l,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Circuit Breakers"]}),e.jsx(k,{children:"Supervisor-level hard stops and thresholds."})]}),e.jsx(d,{children:e.jsx("div",{className:"border rounded-md",children:e.jsxs(D,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(h,{children:"Breaker"}),e.jsx(h,{children:"State"})]})}),e.jsxs(E,{children:[Object.entries(q).map(([s,t])=>e.jsxs(p,{children:[e.jsx(o,{children:s}),e.jsx(o,{children:a(t)})]},s)),Object.keys(q).length===0&&e.jsx(p,{children:e.jsx(o,{colSpan:2,className:"text-muted-foreground",children:"No circuit breaker metrics available."})})]})]})})})]}),e.jsxs(r,{children:[e.jsxs(l,{children:[e.jsx(c,{children:"Feed & Freshness"}),e.jsx(k,{children:"Market-data and analytics staleness diagnostics."})]}),e.jsxs(d,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Freshness"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.entries(M).map(([s,t])=>e.jsxs(y,{variant:"outline",children:[s,": ",a(t)]},s)),Object.keys(M).length===0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"No freshness diagnostics available."})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"WS Data"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.entries(B).map(([s,t])=>e.jsxs(y,{variant:"secondary",children:[s,": ",a(t)]},s)),Object.keys(B).length===0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"No WebSocket status available."})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Market Bridge"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.entries(C).map(([s,t])=>e.jsxs(y,{variant:"secondary",children:[s,": ",a(t)]},s)),Object.keys(C).length===0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"No market bridge status available."})]})]})]})]})]}),e.jsxs(r,{children:[e.jsxs(l,{children:[e.jsx(c,{children:"Exposure by Instrument"}),e.jsx(k,{children:"Aggregated notional and P&L across active positions."})]}),e.jsx(d,{children:e.jsx("div",{className:"border rounded-md",children:e.jsxs(D,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(h,{children:"Instrument"}),e.jsx(h,{children:"Quantity"}),e.jsx(h,{children:"Notional"}),e.jsx(h,{children:"P&L"}),e.jsx(h,{children:"Strategies"})]})}),e.jsxs(E,{children:[j.map(s=>e.jsxs(p,{children:[e.jsx(o,{className:"font-medium",children:s.instrument}),e.jsx(o,{children:u(s.quantity)}),e.jsx(o,{children:u(s.notional)}),e.jsxs(o,{className:s.pnl<0?"text-red-500":s.pnl>0?"text-green-500":"",children:[s.pnl>=0?"+":"",u(s.pnl)]}),e.jsx(o,{children:s.strategies.size>0?Array.from(s.strategies).slice(0,2).join(", "):"—"})]},s.instrument)),j.length===0&&e.jsx(p,{children:e.jsx(o,{colSpan:5,className:"text-muted-foreground",children:"No open positions."})})]})]})})})]})]})}export{le as default};
