import{r as u,j as s}from"./vendor-react-CCyQGCED.js";import{c as Re,v as yn,$ as rn,a3 as an,d as ge,e as ve,u as is,M as jt,B as de,w as De,t as Fs}from"./index-D1Y9pl7A.js";import{aU as zs}from"./vendor-icons-CCn_k3dF.js";import{u as as}from"./useQuery-GXzA0MPk.js";import{S as Kt,a as Wt,b as Ut,c as Ht,d as Et}from"./select-BpDgUHpw.js";import{u as Ds}from"./useOptionChainLive-D-PnD1aP.js";import{q as os,K as ls,W as cs,R as ds,n as Ze,h as Ge}from"./lightweight-charts.production-fmEoZjtL.js";import{t as fe}from"./trading-DfP-7YtK.js";import{a as us}from"./useMarketStatus-DwZVpzMD.js";import{I as Xe}from"./input-CnMxg_uF.js";import{L as Fe}from"./label-B6ThgUMK.js";import{S as bt}from"./switch-BNqZR4u4.js";import{f as Vs,r as Bs,a as _s,b as Gs}from"./ai-scalper-B11twfI1.js";import{u as qs}from"./useLivePrice-DQ_BNONR.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";function pe(e,t="Assertion error"){if(!e)throw Error(t)}function mt({group:e}){const{orientation:t,panels:n}=e;return n.reduce((r,i)=>(r+=t==="horizontal"?i.element.offsetWidth:i.element.offsetHeight,r),0)}function en(e,t){return t.sort(e==="horizontal"?Ks:Ws)}function Ks(e,t){const n=e.element.offsetLeft-t.element.offsetLeft;return n!==0?n:e.element.offsetWidth-t.element.offsetWidth}function Ws(e,t){const n=e.element.offsetTop-t.element.offsetTop;return n!==0?n:e.element.offsetHeight-t.element.offsetHeight}function ps(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.ELEMENT_NODE}function fs(e,t){return{x:e.x>=t.left&&e.x<=t.right?0:Math.min(Math.abs(e.x-t.left),Math.abs(e.x-t.right)),y:e.y>=t.top&&e.y<=t.bottom?0:Math.min(Math.abs(e.y-t.top),Math.abs(e.y-t.bottom))}}function Us({orientation:e,rects:t,targetRect:n}){const r={x:n.x+n.width/2,y:n.y+n.height/2};let i,a=Number.MAX_VALUE;for(const o of t){const{x:l,y:c}=fs(r,o),p=e==="horizontal"?l:c;p<a&&(a=p,i=o)}return pe(i,"No rect found"),i}let kt;function Hs(){return kt===void 0&&(typeof matchMedia=="function"?kt=!!matchMedia("(pointer:coarse)").matches:kt=!1),kt}function ms(e){const{element:t,orientation:n,panels:r,separators:i}=e,a=en(n,Array.from(t.children).filter(ps).map(x=>({element:x}))).map(({element:x})=>x),o=[];let l=!1,c,p=[];for(const x of a)if(x.hasAttribute("data-panel")){const f=r.find(y=>y.element===x);if(f){if(c){const y=c.element.getBoundingClientRect(),N=x.getBoundingClientRect();let g;if(l){const h=n==="horizontal"?new DOMRect(y.right,y.top,0,y.height):new DOMRect(y.left,y.bottom,y.width,0),b=n==="horizontal"?new DOMRect(N.left,N.top,0,N.height):new DOMRect(N.left,N.top,N.width,0);switch(p.length){case 0:{g=[h,b];break}case 1:{const P=p[0],C=Us({orientation:n,rects:[y,N],targetRect:P.element.getBoundingClientRect()});g=[P,C===y?b:h];break}default:{g=p;break}}}else p.length?g=p:g=[n==="horizontal"?new DOMRect(y.right,N.top,N.left-y.right,N.height):new DOMRect(N.left,y.bottom,N.width,N.top-y.bottom)];for(const h of g){let b="width"in h?h:h.element.getBoundingClientRect();const P=Hs()?37:27;if(b.width<P){const C=P-b.width;b=new DOMRect(b.x-C/2,b.y,b.width+C,b.height)}if(b.height<P){const C=P-b.height;b=new DOMRect(b.x,b.y-C/2,b.width,b.height+C)}o.push({group:e,groupSize:mt({group:e}),panels:[c,f],separator:"width"in h?void 0:h,rect:b})}}l=!1,c=f,p=[]}}else if(x.hasAttribute("data-separator")){const f=i.find(y=>y.element===x);f?p.push(f):(c=void 0,p=[])}else l=!0;return o}function Ys(e,t){const n=getComputedStyle(e),r=parseFloat(n.fontSize);return t*r}function Zs(e,t){const n=getComputedStyle(e.ownerDocument.body),r=parseFloat(n.fontSize);return t*r}function Xs(e){return e/100*window.innerHeight}function Qs(e){return e/100*window.innerWidth}function Js(e){switch(typeof e){case"number":return[e,"px"];case"string":{const t=parseFloat(e);return e.endsWith("%")?[t,"%"]:e.endsWith("px")?[t,"px"]:e.endsWith("rem")?[t,"rem"]:e.endsWith("em")?[t,"em"]:e.endsWith("vh")?[t,"vh"]:e.endsWith("vw")?[t,"vw"]:[t,"%"]}}}function Lt({groupSize:e,panelElement:t,styleProp:n}){let r;const[i,a]=Js(n);switch(a){case"%":{r=i/100*e;break}case"px":{r=i;break}case"rem":{r=Zs(t,i);break}case"em":{r=Ys(t,i);break}case"vh":{r=Xs(i);break}case"vw":{r=Qs(i);break}}return r}function Be(e){return parseFloat(e.toFixed(3))}function bn(e){const{panels:t}=e,n=mt({group:e});return n===0?t.map(r=>({collapsedSize:0,collapsible:r.panelConstraints.collapsible===!0,defaultSize:void 0,minSize:0,maxSize:100,panelId:r.id})):t.map(r=>{const{element:i,panelConstraints:a}=r;let o=0;if(a.collapsedSize!==void 0){const x=Lt({groupSize:n,panelElement:i,styleProp:a.collapsedSize});o=Be(x/n*100)}let l;if(a.defaultSize!==void 0){const x=Lt({groupSize:n,panelElement:i,styleProp:a.defaultSize});l=Be(x/n*100)}let c=0;if(a.minSize!==void 0){const x=Lt({groupSize:n,panelElement:i,styleProp:a.minSize});c=Be(x/n*100)}let p=100;if(a.maxSize!==void 0){const x=Lt({groupSize:n,panelElement:i,styleProp:a.maxSize});p=Be(x/n*100)}return{collapsedSize:o,collapsible:a.collapsible===!0,defaultSize:l,minSize:c,maxSize:p,panelId:r.id}})}class er{#e={};addListener(t,n){const r=this.#e[t];return r===void 0?this.#e[t]=[n]:r.includes(n)||r.push(n),()=>{this.removeListener(t,n)}}emit(t,n){const r=this.#e[t];if(r!==void 0)if(r.length===1)r[0].call(null,n);else{let i=!1,a=null;const o=Array.from(r);for(let l=0;l<o.length;l++){const c=o[l];try{c.call(null,n)}catch(p){a===null&&(i=!0,a=p)}}if(i)throw a}}removeAllListeners(){this.#e={}}removeListener(t,n){const r=this.#e[t];if(r!==void 0){const i=r.indexOf(n);i>=0&&r.splice(i,1)}}}function Te(e,t,n=0){return Math.abs(Be(e)-Be(t))<=n}let Ie={cursorFlags:0,interactionState:{state:"inactive"},mountedGroups:new Map};const nt=new er;function $e(){return Ie}function Me(e){const t=typeof e=="function"?e(Ie):e;if(Ie===t)return Ie;const n=Ie;return Ie={...Ie,...t},t.cursorFlags!==void 0&&nt.emit("cursorFlagsChange",Ie.cursorFlags),t.interactionState!==void 0&&nt.emit("interactionStateChange",Ie.interactionState),t.mountedGroups!==void 0&&(Ie.mountedGroups.forEach((r,i)=>{r.derivedPanelConstraints.forEach(a=>{if(a.collapsible){const{layout:o}=n.mountedGroups.get(i)??{};if(o){const l=Te(a.collapsedSize,r.layout[a.panelId]),c=Te(a.collapsedSize,o[a.panelId]);l&&!c&&(i.inMemoryLastExpandedPanelSizes[a.panelId]=o[a.panelId])}}})}),nt.emit("mountedGroupsChange",Ie.mountedGroups)),Ie}function tr(e,t,n){let r,i={x:1/0,y:1/0};for(const a of t){const o=fs(n,a.rect);switch(e){case"horizontal":{o.x<=i.x&&(r=a,i=o);break}case"vertical":{o.y<=i.y&&(r=a,i=o);break}}}return r?{distance:i,hitRegion:r}:void 0}function nr(e){return e!==null&&typeof e=="object"&&"nodeType"in e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE}function sr(e,t){if(e===t)throw new Error("Cannot compare node with itself");const n={a:jn(e),b:jn(t)};let r;for(;n.a.at(-1)===n.b.at(-1);)e=n.a.pop(),t=n.b.pop(),r=e;pe(r,"Stacking order can only be calculated for elements with a common ancestor");const i={a:Sn(vn(n.a)),b:Sn(vn(n.b))};if(i.a===i.b){const a=r.childNodes,o={a:n.a.at(-1),b:n.b.at(-1)};let l=a.length;for(;l--;){const c=a[l];if(c===o.a)return 1;if(c===o.b)return-1}}return Math.sign(i.a-i.b)}const rr=/\b(?:position|zIndex|opacity|transform|webkitTransform|mixBlendMode|filter|webkitFilter|isolation)\b/;function ir(e){const t=getComputedStyle(xs(e)??e).display;return t==="flex"||t==="inline-flex"}function ar(e){const t=getComputedStyle(e);return!!(t.position==="fixed"||t.zIndex!=="auto"&&(t.position!=="static"||ir(e))||+t.opacity<1||"transform"in t&&t.transform!=="none"||"webkitTransform"in t&&t.webkitTransform!=="none"||"mixBlendMode"in t&&t.mixBlendMode!=="normal"||"filter"in t&&t.filter!=="none"||"webkitFilter"in t&&t.webkitFilter!=="none"||"isolation"in t&&t.isolation==="isolate"||rr.test(t.willChange)||t.webkitOverflowScrolling==="touch")}function vn(e){let t=e.length;for(;t--;){const n=e[t];if(pe(n,"Missing node"),ar(n))return n}return null}function Sn(e){return e&&Number(getComputedStyle(e).zIndex)||0}function jn(e){const t=[];for(;e;)t.push(e),e=xs(e);return t}function xs(e){const{parentNode:t}=e;return nr(t)?t.host:t}function or(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function lr({groupElement:e,hitRegion:t,pointerEventTarget:n}){if(!ps(n)||n.contains(e)||e.contains(n))return!0;if(sr(n,e)>0){let r=n;for(;r;){if(r.contains(e))return!0;if(or(r.getBoundingClientRect(),t))return!1;r=r.parentElement}}return!0}function on(e,t){const n=[];return t.forEach((r,i)=>{if(i.disabled)return;const a=ms(i),o=tr(i.orientation,a,{x:e.clientX,y:e.clientY});o&&o.distance.x<=0&&o.distance.y<=0&&lr({groupElement:i.element,hitRegion:o.hitRegion.rect,pointerEventTarget:e.target})&&n.push(o.hitRegion)}),n}function cr(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function Nt(e,t){return Te(e,t)?0:e>t?1:-1}function ft({panelConstraints:e,size:t}){const{collapsedSize:n=0,collapsible:r,maxSize:i=100,minSize:a=0}=e;if(Nt(t,a)<0)if(r){const o=(n+a)/2;Nt(t,o)<0?t=n:t=a}else t=a;return t=Math.min(i,t),t=Be(t),t}function Pt({delta:e,initialLayout:t,panelConstraints:n,pivotIndices:r,prevLayout:i,trigger:a}){if(Te(e,0))return t;const o=Object.values(t),l=Object.values(i),c=[...o],[p,x]=r;pe(p!=null,"Invalid first pivot index"),pe(x!=null,"Invalid second pivot index");let f=0;if(a==="keyboard"){{const g=e<0?x:p,h=n[g];pe(h,`Panel constraints not found for index ${g}`);const{collapsedSize:b=0,collapsible:P,minSize:C=0}=h;if(P){const M=o[g];if(pe(M!=null,`Previous layout not found for panel index ${g}`),Te(M,b)){const k=C-M;Nt(k,Math.abs(e))>0&&(e=e<0?0-k:k)}}}{const g=e<0?p:x,h=n[g];pe(h,`No panel constraints found for index ${g}`);const{collapsedSize:b=0,collapsible:P,minSize:C=0}=h;if(P){const M=o[g];if(pe(M!=null,`Previous layout not found for panel index ${g}`),Te(M,C)){const k=M-b;Nt(k,Math.abs(e))>0&&(e=e<0?0-k:k)}}}}{const g=e<0?1:-1;let h=e<0?x:p,b=0;for(;;){const C=o[h];pe(C!=null,`Previous layout not found for panel index ${h}`);const M=ft({panelConstraints:n[h],size:100})-C;if(b+=M,h+=g,h<0||h>=n.length)break}const P=Math.min(Math.abs(e),Math.abs(b));e=e<0?0-P:P}{let g=e<0?p:x;for(;g>=0&&g<n.length;){const h=Math.abs(e)-Math.abs(f),b=o[g];pe(b!=null,`Previous layout not found for panel index ${g}`);const P=b-h,C=ft({panelConstraints:n[g],size:P});if(!Te(b,C)&&(f+=b-C,c[g]=C,f.toFixed(3).localeCompare(Math.abs(e).toFixed(3),void 0,{numeric:!0})>=0))break;e<0?g--:g++}}if(cr(l,c))return i;{const g=e<0?x:p,h=o[g];pe(h!=null,`Previous layout not found for panel index ${g}`);const b=h+f,P=ft({panelConstraints:n[g],size:b});if(c[g]=P,!Te(P,b)){let C=b-P,M=e<0?x:p;for(;M>=0&&M<n.length;){const k=c[M];pe(k!=null,`Previous layout not found for panel index ${M}`);const F=k+C,V=ft({panelConstraints:n[M],size:F});if(Te(k,V)||(C-=V-k,c[M]=V),Te(C,0))break;e>0?M--:M++}}}const y=Object.values(c).reduce((g,h)=>h+g,0);if(!Te(y,100,.1))return i;const N=Object.keys(i);return c.reduce((g,h,b)=>(g[N[b]]=h,g),{})}function st(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(t[n]===void 0||Nt(e[n],t[n])!==0)return!1;return!0}function rt({layout:e,panelConstraints:t}){const n=[...Object.values(e)],r=n.reduce((o,l)=>o+l,0);if(n.length!==t.length)throw Error(`Invalid ${t.length} panel layout: ${n.map(o=>`${o}%`).join(", ")}`);if(!Te(r,100)&&n.length>0)for(let o=0;o<t.length;o++){const l=n[o];pe(l!=null,`No layout data found for index ${o}`);const c=100/r*l;n[o]=c}let i=0;for(let o=0;o<t.length;o++){const l=n[o];pe(l!=null,`No layout data found for index ${o}`);const c=ft({panelConstraints:t[o],size:l});l!=c&&(i+=l-c,n[o]=c)}if(!Te(i,0))for(let o=0;o<t.length;o++){const l=n[o];pe(l!=null,`No layout data found for index ${o}`);const c=l+i,p=ft({panelConstraints:t[o],size:c});if(l!==p&&(i-=p-l,n[o]=p,Te(i,0)))break}const a=Object.keys(e);return n.reduce((o,l,c)=>(o[a[c]]=l,o),{})}function hs({groupId:e,panelId:t}){const n=()=>{const{mountedGroups:l}=$e();for(const[c,{defaultLayoutDeferred:p,derivedPanelConstraints:x,layout:f,separatorToPanels:y}]of l)if(c.id===e)return{defaultLayoutDeferred:p,derivedPanelConstraints:x,group:c,layout:f,separatorToPanels:y};throw Error(`Group ${e} not found`)},r=()=>{const l=n().derivedPanelConstraints.find(c=>c.panelId===t);if(l!==void 0)return l;throw Error(`Panel constraints not found for Panel ${t}`)},i=()=>{const l=n().group.panels.find(c=>c.id===t);if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},a=()=>{const l=n().layout[t];if(l!==void 0)return l;throw Error(`Layout not found for Panel ${t}`)},o=l=>{const c=a();if(l===c)return;const{defaultLayoutDeferred:p,derivedPanelConstraints:x,group:f,layout:y,separatorToPanels:N}=n(),g=f.panels.findIndex(C=>C.id===t),h=g===f.panels.length-1,b=Pt({delta:h?c-l:l-c,initialLayout:y,panelConstraints:x,pivotIndices:h?[g-1,g]:[g,g+1],prevLayout:y,trigger:"imperative-api"}),P=rt({layout:b,panelConstraints:x});st(y,P)||Me(C=>({mountedGroups:new Map(C.mountedGroups).set(f,{defaultLayoutDeferred:p,derivedPanelConstraints:x,layout:P,separatorToPanels:N})}))};return{collapse:()=>{const{collapsible:l,collapsedSize:c}=r(),{mutableValues:p}=i(),x=a();l&&x!==c&&(p.expandToSize=x,o(c))},expand:()=>{const{collapsible:l,collapsedSize:c,minSize:p}=r(),{mutableValues:x}=i(),f=a();if(l&&f===c){let y=x.expandToSize??p;y===0&&(y=1),o(y)}},getSize:()=>{const{group:l}=n(),c=a(),{element:p}=i(),x=l.orientation==="horizontal"?p.offsetWidth:p.offsetHeight;return{asPercentage:c,inPixels:x}},isCollapsed:()=>{const{collapsible:l,collapsedSize:c}=r(),p=a();return l&&Te(c,p)},resize:l=>{if(a()!==l){let c;switch(typeof l){case"number":{const{group:p}=n(),x=mt({group:p});c=Be(l/x*100);break}case"string":{c=parseFloat(l);break}}o(c)}}}}function Nn(e){if(e.defaultPrevented)return;const{mountedGroups:t}=$e(),n=on(e,t),r=new Set,i=new Set;n.forEach(a=>{if(r.add(a.group),a.panels.forEach(o=>{i.add(o)}),a.separator){const o=a.panels.find(l=>l.panelConstraints.defaultSize!==void 0);if(o){const l=o.panelConstraints.defaultSize,c=hs({groupId:a.group.id,panelId:o.id});c&&l!==void 0&&(c.resize(l),e.preventDefault())}}})}function zt(e){const{mountedGroups:t}=$e();for(const[n]of t)if(n.separators.some(r=>r.element===e))return n;throw Error("Could not find parent Group for separator element")}function gs({groupId:e}){const t=()=>{const{mountedGroups:n}=$e();for(const[r,i]of n)if(r.id===e)return{group:r,...i};throw Error(`Could not find Group with id "${e}"`)};return{getLayout(){const{defaultLayoutDeferred:n,layout:r}=t();return n?{}:r},setLayout(n){const{defaultLayoutDeferred:r,derivedPanelConstraints:i,group:a,layout:o,separatorToPanels:l}=t(),c=rt({layout:n,panelConstraints:i});return r?o:(st(o,c)||Me(p=>({mountedGroups:new Map(p.mountedGroups).set(a,{defaultLayoutDeferred:r,derivedPanelConstraints:i,layout:c,separatorToPanels:l})})),c)}}}function ys(e){const{mountedGroups:t}=$e(),n=t.get(e);return pe(n,`Mounted Group ${e.id} not found`),n}function et(e,t){const n=zt(e),r=ys(n),i=n.separators.find(x=>x.element===e);pe(i,"Matching separator not found");const a=r.separatorToPanels.get(i);pe(a,"Matching panels not found");const o=a.map(x=>n.panels.indexOf(x)),l=gs({groupId:n.id}).getLayout(),c=Pt({delta:t,initialLayout:l,panelConstraints:r.derivedPanelConstraints,pivotIndices:o,prevLayout:l,trigger:"keyboard"}),p=rt({layout:c,panelConstraints:r.derivedPanelConstraints});st(l,p)||Me(x=>({mountedGroups:new Map(x.mountedGroups).set(n,{defaultLayoutDeferred:r.defaultLayoutDeferred,derivedPanelConstraints:r.derivedPanelConstraints,layout:p,separatorToPanels:r.separatorToPanels})}))}function Pn(e){if(e.defaultPrevented)return;const t=e.currentTarget,n=zt(t);if(!n.disabled)switch(e.key){case"ArrowDown":{e.preventDefault(),n.orientation==="vertical"&&et(t,5);break}case"ArrowLeft":{e.preventDefault(),n.orientation==="horizontal"&&et(t,-5);break}case"ArrowRight":{e.preventDefault(),n.orientation==="horizontal"&&et(t,5);break}case"ArrowUp":{e.preventDefault(),n.orientation==="vertical"&&et(t,-5);break}case"End":{e.preventDefault(),et(t,100);break}case"Enter":{e.preventDefault();const r=zt(t),{derivedPanelConstraints:i,layout:a,separatorToPanels:o}=ys(r),l=r.separators.find(f=>f.element===t);pe(l,"Matching separator not found");const c=o.get(l);pe(c,"Matching panels not found");const p=c[0],x=i.find(f=>f.panelId===p.id);if(pe(x,"Panel metadata not found"),x.collapsible){const f=a[p.id],y=x.collapsedSize===f?r.inMemoryLastExpandedPanelSizes[p.id]??x.minSize:x.collapsedSize;et(t,y-f)}break}case"F6":{e.preventDefault();const r=zt(t).separators.map(o=>o.element),i=Array.from(r).findIndex(o=>o===e.currentTarget);pe(i!==null,"Index not found");const a=e.shiftKey?i>0?i-1:r.length-1:i+1<r.length?i+1:0;r[a].focus();break}case"Home":{e.preventDefault(),et(t,-100);break}}}function wn(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{mountedGroups:t}=$e(),n=on(e,t),r=new Set,i=new Set,a=new Set,o=new Map;let l=!1;n.forEach(c=>{r.add(c.group),c.panels.forEach(x=>{i.add(x)}),c.separator&&(a.add(c.separator),l||(l=!0,c.separator.element.focus()));const p=t.get(c.group);p&&o.set(c.group,p.layout)}),Me({interactionState:{hitRegions:n,initialLayoutMap:o,pointerDownAtPoint:{x:e.clientX,y:e.clientY},state:"active"}}),n.length&&e.preventDefault()}const dr=e=>e,Yt=()=>{},bs=1,vs=2,Ss=4,js=8,Cn=3,Tn=12;let Mt;function En(){return Mt===void 0&&(Mt=!1,typeof window<"u"&&(window.navigator.userAgent.includes("Chrome")||window.navigator.userAgent.includes("Firefox"))&&(Mt=!0)),Mt}function ur({cursorFlags:e,groups:t,state:n}){let r=0,i=0;switch(n){case"active":case"hover":t.forEach(a=>{if(!a.disableCursor)switch(a.orientation){case"horizontal":{r++;break}case"vertical":{i++;break}}})}if(r===0&&i===0)return null;switch(n){case"active":{if(e&&En()){const a=(e&bs)!==0,o=(e&vs)!==0,l=(e&Ss)!==0,c=(e&js)!==0;if(a)return l?"se-resize":c?"ne-resize":"e-resize";if(o)return l?"sw-resize":c?"nw-resize":"w-resize";if(l)return"s-resize";if(c)return"n-resize"}break}}return En()?r>0&&i>0?"move":r>0?"ew-resize":"ns-resize":r>0&&i>0?"grab":r>0?"col-resize":"row-resize"}const kn=new WeakMap;function ln(e){if(e.defaultView===null||e.defaultView===void 0)return;let{prevStyle:t,styleSheet:n}=kn.get(e)??{};n===void 0&&(n=new e.defaultView.CSSStyleSheet,e.adoptedStyleSheets.push(n));const{cursorFlags:r,interactionState:i}=$e();switch(i.state){case"active":case"hover":{const a=ur({cursorFlags:r,groups:i.hitRegions.map(l=>l.group),state:i.state}),o=`*, *:hover {cursor: ${a} !important; ${i.state==="active"?"touch-action: none;":""} }`;if(t===o)return;t=o,a?n.cssRules.length===0?n.insertRule(o):n.replaceSync(o):n.cssRules.length===1&&n.deleteRule(0);break}case"inactive":{t=void 0,n.cssRules.length===1&&n.deleteRule(0);break}}kn.set(e,{prevStyle:t,styleSheet:n})}function Ns({document:e,event:t,hitRegions:n,initialLayoutMap:r,mountedGroups:i,pointerDownAtPoint:a,prevCursorFlags:o}){let l=0;const c=new Map(i);n.forEach(x=>{const{group:f,groupSize:y}=x,{disableCursor:N,orientation:g,panels:h}=f;let b=0;a?g==="horizontal"?b=(t.clientX-a.x)/y*100:b=(t.clientY-a.y)/y*100:g==="horizontal"?b=t.clientX<0?-100:100:b=t.clientY<0?-100:100;const P=r.get(f),{defaultLayoutDeferred:C,derivedPanelConstraints:M,layout:k,separatorToPanels:F}=i.get(f)??{defaultLayoutDeferred:!1};if(M&&P&&k&&F){const V=Pt({delta:b,initialLayout:P,panelConstraints:M,pivotIndices:x.panels.map(T=>h.indexOf(T)),prevLayout:k,trigger:"mouse-or-touch"});if(st(V,k)){if(b!==0&&!N)switch(g){case"horizontal":{l|=b<0?bs:vs;break}case"vertical":{l|=b<0?Ss:js;break}}}else{c.set(x.group,{defaultLayoutDeferred:C,derivedPanelConstraints:M,layout:V,separatorToPanels:F});const T=x.group.panels.map(({id:K})=>K).join(",");x.group.inMemoryLayouts[T]=V}}});let p=0;t.movementX===0?p|=o&Cn:p|=l&Cn,t.movementY===0?p|=o&Tn:p|=l&Tn,Me({cursorFlags:p,mountedGroups:c}),ln(e)}function Ln(e){const{cursorFlags:t,interactionState:n,mountedGroups:r}=$e();n.state==="active"&&Ns({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,prevCursorFlags:t})}function Mn(e){if(e.defaultPrevented)return;const{cursorFlags:t,interactionState:n,mountedGroups:r}=$e();switch(n.state){case"active":{if(e.buttons===0){Me(i=>i.interactionState.state==="inactive"?i:{cursorFlags:0,interactionState:{state:"inactive"}}),Me(i=>({mountedGroups:new Map(i.mountedGroups)}));return}Ns({document:e.currentTarget,event:e,hitRegions:n.hitRegions,initialLayoutMap:n.initialLayoutMap,mountedGroups:r,pointerDownAtPoint:n.pointerDownAtPoint,prevCursorFlags:t});break}default:{const i=on(e,r);i.length===0?n.state!=="inactive"&&Me({interactionState:{state:"inactive"}}):Me({interactionState:{hitRegions:i,state:"hover"}}),ln(e.currentTarget);break}}}function Rn(e){if(e.defaultPrevented||e.pointerType==="mouse"&&e.button>0)return;const{interactionState:t}=$e();t.state==="active"&&(Me({cursorFlags:0,interactionState:{state:"inactive"}}),t.hitRegions.length>0&&(ln(e.currentTarget),Me(n=>({mountedGroups:new Map(n.mountedGroups)})),e.preventDefault()))}function $n(e){let t=0,n=0;const r={};for(const a of e)if(a.defaultSize!==void 0){t++;const o=Be(a.defaultSize);n+=o,r[a.panelId]=o}else r[a.panelId]=void 0;const i=e.length-t;if(i!==0){const a=Be((100-n)/i);for(const o of e)o.defaultSize===void 0&&(r[o.panelId]=a)}return r}function pr(e,t,n){if(!n[0])return;const r=e.panels.find(c=>c.element===t);if(!r||!r.onResize)return;const i=mt({group:e}),a=e.orientation==="horizontal"?r.element.offsetWidth:r.element.offsetHeight,o=r.mutableValues.prevSize,l={asPercentage:Be(a/i*100),inPixels:a};r.mutableValues.prevSize=l,r.onResize(l,r.id,o)}function fr(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function mr(e,t){const n=e.map(i=>i.id),r=Object.keys(t);if(n.length!==r.length)return!1;for(const i of n)if(!r.includes(i))return!1;return!0}const lt=new Map;function xr(e){let t=!0;pe(e.element.ownerDocument.defaultView,"Cannot register an unmounted Group");const n=e.element.ownerDocument.defaultView.ResizeObserver,r=new Set,i=new Set,a=new n(g=>{for(const h of g){const{borderBoxSize:b,target:P}=h;if(P===e.element){if(t){if(mt({group:e})===0)return;Me(C=>{const M=C.mountedGroups.get(e);if(M){const k=bn(e),F=M.defaultLayoutDeferred?$n(k):M.layout,V=rt({layout:F,panelConstraints:k});return!M.defaultLayoutDeferred&&st(F,V)&&fr(M.derivedPanelConstraints,k)?C:{mountedGroups:new Map(C.mountedGroups).set(e,{defaultLayoutDeferred:!1,derivedPanelConstraints:k,layout:V,separatorToPanels:M.separatorToPanels})}}return C})}}else pr(e,P,b)}});a.observe(e.element),e.panels.forEach(g=>{pe(!r.has(g.id),`Panel ids must be unique; id "${g.id}" was used more than once`),r.add(g.id),g.onResize&&a.observe(g.element)});const o=mt({group:e}),l=bn(e),c=e.panels.map(({id:g})=>g).join(",");let p=e.defaultLayout;p&&(mr(e.panels,p)||(p=void 0));const x=e.inMemoryLayouts[c]??p??$n(l),f=rt({layout:x,panelConstraints:l}),y=ms(e),N=e.element.ownerDocument;return Me(g=>{const h=new Map;return lt.set(N,(lt.get(N)??0)+1),y.forEach(b=>{b.separator&&h.set(b.separator,b.panels)}),{mountedGroups:new Map(g.mountedGroups).set(e,{defaultLayoutDeferred:o===0,derivedPanelConstraints:l,layout:f,separatorToPanels:h})}}),e.separators.forEach(g=>{pe(!i.has(g.id),`Separator ids must be unique; id "${g.id}" was used more than once`),i.add(g.id),g.element.addEventListener("keydown",Pn)}),lt.get(N)===1&&(N.addEventListener("dblclick",Nn,!0),N.addEventListener("pointerdown",wn,!0),N.addEventListener("pointerleave",Ln),N.addEventListener("pointermove",Mn),N.addEventListener("pointerup",Rn,!0)),function(){t=!1,lt.set(N,Math.max(0,(lt.get(N)??0)-1)),Me(g=>{const h=new Map(g.mountedGroups);return h.delete(e),{mountedGroups:h}}),e.separators.forEach(g=>{g.element.removeEventListener("keydown",Pn)}),lt.get(N)||(N.removeEventListener("dblclick",Nn,!0),N.removeEventListener("pointerdown",wn,!0),N.removeEventListener("pointerleave",Ln),N.removeEventListener("pointermove",Mn),N.removeEventListener("pointerup",Rn,!0)),a.disconnect()}}function Ps(){const[e,t]=u.useState({}),n=u.useCallback(()=>t({}),[]);return[e,n]}function cn(e){const t=u.useId();return`${e??t}`}const at=typeof window<"u"?u.useLayoutEffect:u.useEffect;function St(e){const t=u.useRef(e);return at(()=>{t.current=e},[e]),u.useCallback((...n)=>t.current?.(...n),[t])}function dn(...e){return St(t=>{e.forEach(n=>{if(n)switch(typeof n){case"function":{n(t);break}case"object":{n.current=t;break}}})})}function hr(e){const t=u.useRef({...e});return at(()=>{for(const n in e)t.current[n]=e[n]},[e]),t.current}const ws=u.createContext(null);function gr(e,t){const n=u.useRef({getLayout:()=>({}),setLayout:dr});u.useImperativeHandle(t,()=>n.current,[]),at(()=>{Object.assign(n.current,gs({groupId:e}))})}function Cs({children:e,className:t,defaultLayout:n,disableCursor:r,disabled:i,elementRef:a,groupRef:o,id:l,onLayoutChange:c,onLayoutChanged:p,orientation:x="horizontal",style:f,...y}){const N=u.useRef({onLayoutChange:{},onLayoutChanged:{}}),g=St(I=>{st(N.current.onLayoutChange,I)||(N.current.onLayoutChange=I,c?.(I))}),h=St(I=>{st(N.current.onLayoutChanged,I)||(N.current.onLayoutChanged=I,p?.(I))}),b=cn(l),P=u.useRef(null),[C,M]=Ps(),k=u.useRef({lastExpandedPanelSizes:{},layouts:{},panels:[],separators:[]}),F=dn(P,a);gr(b,o);const V=St((I,z)=>{const{interactionState:w,mountedGroups:m}=$e();for(const v of m.keys())if(v.id===I){const W=m.get(v);if(W){let A=!1;return w.state==="active"&&(A=w.hitRegions.some(O=>O.group===v)),{flexGrow:W.layout[z]??1,pointerEvents:A?"none":void 0}}}return{flexGrow:n?.[z]??1}}),T=u.useMemo(()=>({getPanelStyles:V,id:b,orientation:x,registerPanel:I=>{const z=k.current;return z.panels=en(x,[...z.panels,I]),M(),()=>{z.panels=z.panels.filter(w=>w!==I),M()}},registerSeparator:I=>{const z=k.current;return z.separators=en(x,[...z.separators,I]),M(),()=>{z.separators=z.separators.filter(w=>w!==I),M()}}}),[V,b,M,x]),K=hr({defaultLayout:n,disableCursor:r}),R=u.useRef(null);return at(()=>{const I=P.current;if(I===null)return;const z=k.current,w={defaultLayout:K.defaultLayout,disableCursor:!!K.disableCursor,disabled:!!i,element:I,id:b,inMemoryLastExpandedPanelSizes:k.current.lastExpandedPanelSizes,inMemoryLayouts:k.current.layouts,orientation:x,panels:z.panels,separators:z.separators};R.current=w;const m=xr(w),v=$e().mountedGroups.get(w);if(v){const{defaultLayoutDeferred:O,derivedPanelConstraints:d,layout:$}=v;!O&&d.length>0&&(g($),h($),z.panels.forEach(_=>{_.scheduleUpdate()}))}const W=nt.addListener("interactionStateChange",()=>{z.panels.forEach(O=>{O.scheduleUpdate()})}),A=nt.addListener("mountedGroupsChange",O=>{const d=O.get(w);if(d){const{defaultLayoutDeferred:$,derivedPanelConstraints:_,layout:D}=d;if($||_.length===0)return;const{interactionState:G}=$e(),H=G.state!=="active";g(D),H&&h(D),z.panels.forEach(U=>{U.scheduleUpdate()})}});return()=>{R.current=null,m(),W(),A()}},[i,b,h,g,x,C,K]),u.useEffect(()=>{const I=R.current;I&&(I.defaultLayout=n,I.disableCursor=!!r)}),s.jsx(ws.Provider,{value:T,children:s.jsx("div",{...y,"aria-orientation":x,className:t,"data-group":!0,"data-testid":b,id:b,ref:F,style:{height:"100%",width:"100%",overflow:"hidden",...f,display:"flex",flexDirection:x==="horizontal"?"row":"column",flexWrap:"nowrap"},children:e})})}Cs.displayName="Group";function un(){const e=u.useContext(ws);return pe(e,"Group Context not found; did you render a Panel or Separator outside of a Group?"),e}function yr(e,t){const{id:n}=un(),r=u.useRef({collapse:Yt,expand:Yt,getSize:()=>({asPercentage:0,inPixels:0}),isCollapsed:()=>!1,resize:Yt});u.useImperativeHandle(t,()=>r.current,[]),at(()=>{Object.assign(r.current,hs({groupId:n,panelId:e}))})}function Ts({children:e,className:t,collapsedSize:n="0%",collapsible:r=!1,defaultSize:i,elementRef:a,id:o,maxSize:l="100%",minSize:c="0%",onResize:p,panelRef:x,style:f,...y}){const N=!!o,g=cn(o),h=u.useRef(null),b=dn(h,a),[,P]=Ps(),{getPanelStyles:C,id:M,registerPanel:k}=un(),F=p!==null,V=St((K,R,I)=>{p?.(K,o,I)});at(()=>{const K=h.current;if(K!==null)return k({element:K,id:g,idIsStable:N,mutableValues:{expandToSize:void 0,prevSize:void 0},onResize:F?V:void 0,panelConstraints:{collapsedSize:n,collapsible:r,defaultSize:i,maxSize:l,minSize:c},scheduleUpdate:P})},[n,r,i,P,F,g,N,l,c,V,k]),yr(g,x);const T=C(M,g);return s.jsx("div",{...y,"data-panel":!0,"data-testid":g,id:g,ref:b,style:{...br,display:"flex",flexBasis:0,flexShrink:1,overflow:"hidden",...T},children:s.jsx("div",{className:t,style:{flexGrow:1,...f},children:e})})}Ts.displayName="Panel";const br={minHeight:0,maxHeight:"100%",height:"auto",minWidth:0,maxWidth:"100%",width:"auto",border:"none",borderWidth:0,padding:0,margin:0};function vr({layout:e,panelConstraints:t,panelId:n,panelIndex:r}){let i,a;const o=e[n],l=t.find(c=>c.panelId===n);if(l){const c=l.maxSize,p=a=l.collapsible?l.collapsedSize:l.minSize,x=[r,r+1];a=rt({layout:Pt({delta:p-o,initialLayout:e,panelConstraints:t,pivotIndices:x,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n],i=rt({layout:Pt({delta:c-o,initialLayout:e,panelConstraints:t,pivotIndices:x,prevLayout:e,trigger:"keyboard"}),panelConstraints:t})[n]}return{valueControls:n,valueMax:i,valueMin:a,valueNow:o}}function Es({children:e,className:t,elementRef:n,id:r,style:i,...a}){const o=cn(r),[l,c]=u.useState({}),[p,x]=u.useState("inactive"),f=u.useRef(null),y=dn(f,n),{id:N,orientation:g,registerSeparator:h}=un(),b=g==="horizontal"?"vertical":"horizontal";return at(()=>{const P=f.current;if(P!==null){const C={element:P,id:o},M=h(C),k=nt.addListener("interactionStateChange",V=>{x(V.state!=="inactive"&&V.hitRegions.some(T=>T.separator===C)?V.state:"inactive")}),F=nt.addListener("mountedGroupsChange",V=>{V.forEach(({derivedPanelConstraints:T,layout:K,separatorToPanels:R},I)=>{if(I.id===N){const z=R.get(C);if(z){const w=z[0],m=I.panels.indexOf(w);c(vr({layout:K,panelConstraints:T,panelId:w.id,panelIndex:m}))}}})});return()=>{k(),F(),M()}}},[N,o,h]),s.jsx("div",{...a,"aria-controls":l.valueControls,"aria-orientation":b,"aria-valuemax":l.valueMax,"aria-valuemin":l.valueMin,"aria-valuenow":l.valueNow,children:e,className:t,"data-separator":p,"data-testid":o,id:o,ref:y,role:"separator",style:{flexBasis:"auto",...i,flexGrow:0,flexShrink:0},tabIndex:0})}Es.displayName="Separator";function tn({className:e,...t}){return s.jsx(Cs,{"data-slot":"resizable-panel-group",className:Re("h-full w-full",e),...t})}function tt({className:e,...t}){return s.jsx(Ts,{"data-slot":"resizable-panel",className:Re("min-w-0 min-h-0",e),...t})}function Vt({withHandle:e,className:t,...n}){return s.jsx(Es,{"data-slot":"resizable-handle",className:Re("relative flex shrink-0 touch-none select-none items-center justify-center bg-border/50 transition-colors hover:bg-primary/20 focus-visible:ring-ring focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden cursor-col-resize data-[panel-group-direction=vertical]:cursor-row-resize data-[panel-group-direction=horizontal]:h-full data-[panel-group-direction=horizontal]:w-px data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",e&&"data-[panel-group-direction=horizontal]:w-2 data-[panel-group-direction=vertical]:h-2 data-[panel-group-direction=horizontal]:after:absolute data-[panel-group-direction=horizontal]:after:inset-y-0 data-[panel-group-direction=horizontal]:after:left-1/2 data-[panel-group-direction=horizontal]:after:w-px data-[panel-group-direction=horizontal]:after:-translate-x-1/2 data-[panel-group-direction=horizontal]:after:bg-border/70 data-[panel-group-direction=vertical]:after:absolute data-[panel-group-direction=vertical]:after:inset-x-0 data-[panel-group-direction=vertical]:after:top-1/2 data-[panel-group-direction=vertical]:after:h-px data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:bg-border/70",t),...n,children:e&&s.jsx("div",{className:"bg-border z-10 flex h-4 w-4 items-center justify-center rounded-sm border shadow-sm pointer-events-none",children:s.jsx(zs,{className:"size-2.5 data-[panel-group-direction=vertical]:rotate-90"})})})}const Sr={getOptionChain:async(e,t,n,r,i)=>(await yn.post("/optionchain",{apikey:e,underlying:t,exchange:n,expiry_date:r,strike_count:i??20})).data,getExpiries:async(e,t,n,r="options")=>(await yn.post("/expiry",{apikey:e,symbol:t,exchange:n,instrumenttype:r})).data},jr={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:10},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}},j=rn()(an(e=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,limitPrice:null,pendingEntryAction:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,setUnderlying:t=>{const n=jr[t];e({underlying:t,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:t=>e(n=>n.expiry===t?n:{expiry:t,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:t=>e(n=>n.expiryWeek===t?n:{expiryWeek:t}),setExpiries:t=>e(n=>n.expiries.length===t.length&&n.expiries.every((r,i)=>r===t[i])?n:{expiries:t}),setChainStrikeCount:t=>e(n=>{const r=Math.max(5,t);return n.chainStrikeCount===r?n:{chainStrikeCount:r}}),setSelectedStrike:t=>e(n=>n.selectedStrike===t?n:{selectedStrike:t}),setActiveSide:t=>e({activeSide:t}),toggleActiveSide:()=>e(t=>({activeSide:t.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(t,n)=>e(r=>r.selectedCESymbol===t&&r.selectedPESymbol===n?r:{selectedCESymbol:t,selectedPESymbol:n}),setOptionChainSnapshot:(t,n,r)=>e(i=>{const a=Number.isFinite(n)?n:Date.now(),o=typeof r=="boolean"?r:i.optionChainIsStreaming;return i.optionChainData===t&&i.optionChainLastUpdate===a&&i.optionChainIsStreaming===o?i:{optionChainData:t,optionChainLastUpdate:a,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>e(t=>t.optionChainData===null&&t.optionChainLastUpdate===0&&!t.optionChainIsStreaming?t:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:t=>e({quantity:Math.max(1,t)}),incrementQuantity:()=>e(t=>({quantity:t.quantity+1})),decrementQuantity:()=>e(t=>({quantity:Math.max(1,t.quantity-1)})),setOrderType:t=>e({orderType:t,...t==="MARKET"?{limitPrice:null,pendingEntryAction:null}:{}}),setProduct:t=>e({product:t}),setTpPoints:t=>e({tpPoints:Math.max(0,t)}),setSlPoints:t=>e({slPoints:Math.max(0,t)}),setLimitPrice:t=>e(n=>n.limitPrice===t?n:{limitPrice:t}),setPendingEntryAction:t=>e(n=>n.pendingEntryAction===t?n:{pendingEntryAction:t}),setPaperMode:t=>e(n=>n.paperMode===t?n:{paperMode:t}),setControlTab:t=>e({controlTab:t}),setHotkeysEnabled:t=>e({hotkeysEnabled:t}),setShowFloatingWidget:t=>e({showFloatingWidget:t}),toggleFloatingWidget:()=>e(t=>({showFloatingWidget:!t.showFloatingWidget})),setChainCollapsed:t=>e({chainCollapsed:t}),setControlCollapsed:t=>e({controlCollapsed:t}),setCeWidgetPos:t=>e({ceWidgetPos:t}),setPeWidgetPos:t=>e({peWidgetPos:t}),setLotSize:t=>e({lotSize:t}),setChartInterval:t=>e({chartInterval:t}),addSessionPnl:t=>e(n=>({sessionPnl:n.sessionPnl+t})),incrementTradeCount:()=>e(t=>({tradeCount:t.tradeCount+1})),resetSession:()=>e({sessionPnl:0,tradeCount:0})}),{name:"openalgo-scalping",partialize:e=>({underlying:e.underlying,expiryWeek:e.expiryWeek,chainStrikeCount:e.chainStrikeCount,quantity:e.quantity,orderType:e.orderType,product:e.product,tpPoints:e.tpPoints,slPoints:e.slPoints,paperMode:e.paperMode,hotkeysEnabled:e.hotkeysEnabled,showFloatingWidget:e.showFloatingWidget,chartInterval:e.chartInterval,ceWidgetPos:e.ceWidgetPos,peWidgetPos:e.peWidgetPos})})),Nr=["NIFTY","SENSEX","BANKNIFTY","FINNIFTY"],Pr=[10,15,20,25,30],Zt="__none__";function wr(e,t){return e.length===t.length&&e.every((n,r)=>n===t[r])}function Cr({liveOpenPnl:e,isLivePnl:t=!1}){const n=ge(T=>T.apiKey),r=ge(T=>T.user?.broker),i=j(T=>T.underlying),a=j(T=>T.optionExchange),o=j(T=>T.expiryWeek),l=j(T=>T.expiry),c=j(T=>T.expiries),p=j(T=>T.chainStrikeCount),x=j(T=>T.paperMode),f=j(T=>T.sessionPnl),y=j(T=>T.tradeCount),N=j(T=>T.setUnderlying),g=j(T=>T.setExpiryWeek),h=j(T=>T.setExpiry),b=j(T=>T.setExpiries),P=j(T=>T.setChainStrikeCount),C=j(T=>T.setPaperMode),M=x?f:e??f,k=l&&c.includes(l)?l:Zt,{data:F}=as({queryKey:["scalping-expiries",i,a],queryFn:()=>Sr.getExpiries(n,i,a),enabled:!!n,staleTime:300*1e3});u.useEffect(()=>{if(F?.status!=="success")return;const T=F.data??[];if(wr(c,T)||b(T),T.length===0){l&&h("");return}if(!l||!T.includes(l)){const K=o==="next"?Math.min(1,T.length-1):0,R=T[K],I=K<=0?"current":"next";l!==R&&h(R),o!==I&&g(I)}},[F,o,c,l,b,h,g]);const V=T=>{if(T===Zt)return;l!==T&&h(T);const R=c.indexOf(T)<=0?"current":"next";o!==R&&g(R)};return s.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 border-b bg-card shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Index"}),s.jsxs(Kt,{value:i,onValueChange:T=>N(T),children:[s.jsx(Wt,{className:"h-7 w-[128px] text-xs font-semibold",children:s.jsx(Ut,{})}),s.jsx(Ht,{children:Nr.map(T=>s.jsx(Et,{value:T,children:T},T))})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Expiry"}),s.jsxs(Kt,{value:k,onValueChange:V,disabled:c.length===0,children:[s.jsx(Wt,{className:"h-7 w-[122px] text-xs font-mono",children:s.jsx(Ut,{placeholder:"Select expiry"})}),s.jsxs(Ht,{children:[s.jsx(Et,{value:Zt,disabled:!0,children:"Select expiry"}),c.map(T=>s.jsx(Et,{value:T,children:T},T))]})]})]}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:"Strikes"}),s.jsxs(Kt,{value:String(p),onValueChange:T=>P(Number(T)),children:[s.jsx(Wt,{className:"h-7 w-[94px] text-xs",children:s.jsx(Ut,{})}),s.jsx(Ht,{children:Pr.map(T=>s.jsx(Et,{value:String(T),children:T},T))})]})]}),s.jsx("div",{className:"flex-1"}),s.jsx("div",{className:"flex items-center gap-1.5",children:s.jsxs("div",{className:"inline-flex rounded-md border border-border/60 bg-muted/30 p-0.5",children:[s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${x?"bg-blue-500/20 text-blue-400":"text-muted-foreground hover:text-foreground"}`,onClick:()=>C(!0),children:"Paper"}),s.jsx("button",{type:"button",className:`h-6 px-2 text-xs rounded-sm ${x?"text-muted-foreground hover:text-foreground":"bg-green-500/20 text-green-400"}`,onClick:()=>C(!1),children:"Live"})]})}),s.jsx("div",{className:"w-px h-5 bg-border"}),r&&s.jsx(ve,{variant:"outline",className:"text-xs h-6",children:r}),s.jsx("div",{className:"w-px h-5 bg-border"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"P&L:"}),s.jsxs("span",{className:`text-sm font-bold tabular-nums ${M>0?"text-green-500":M<0?"text-red-500":"text-foreground"}`,children:[M>=0?"+":"",M.toFixed(0)]}),!x&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"}),y>0&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",y,")"]})]})]})}function Rt(e){if(e==null||e===0)return"-";const t=Math.abs(e);return t>=1e5?t>=1e6?`${(e/1e5).toFixed(1)}L`:`${(e/1e5).toFixed(2)}L`:t>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString("en-IN")}function An({value:e,prevRef:t,className:n,format:r="price"}){const i=u.useRef(null);u.useEffect(()=>{if(e==null||e===t.current)return;const o=i.current;if(!o)return;const l=e>t.current?"flash-green":"flash-red";o.classList.add(l);const c=setTimeout(()=>o.classList.remove(l),300);return t.current=e,()=>clearTimeout(c)},[e,t]);const a=e==null?"-":r==="int"?e.toLocaleString("en-IN"):e.toFixed(2);return s.jsx("span",{ref:i,className:Re("tabular-nums transition-colors",n),children:a})}function $t({value:e,max:t,side:n,kind:r}){if(!e||!t)return null;const i=Math.min(e/t*100,100),a=Math.min(.2+i/180,.75);return s.jsx("div",{className:Re("absolute inset-y-0 pointer-events-none transition-[width,opacity] duration-200",n==="CE"?r==="oi"?"right-0 bg-gradient-to-l from-emerald-500 to-transparent":"right-0 bg-gradient-to-l from-teal-500 to-transparent":r==="oi"?"left-0 bg-gradient-to-r from-rose-500 to-transparent":"left-0 bg-gradient-to-r from-orange-500 to-transparent",i>72&&"animate-pulse"),style:{width:`${i}%`,opacity:a}})}function Tr(e,t){return!(e.strike!==t.strike||e.isATM!==t.isATM||e.isSelected!==t.isSelected||e.maxOI!==t.maxOI||e.maxVol!==t.maxVol||e.onSelectStrike!==t.onSelectStrike||e.ce?.ltp!==t.ce?.ltp||e.ce?.oi!==t.ce?.oi||e.ce?.volume!==t.ce?.volume||e.pe?.ltp!==t.pe?.ltp||e.pe?.oi!==t.pe?.oi||e.pe?.volume!==t.pe?.volume)}const Er=u.memo(function({strike:t,ce:n,pe:r,isATM:i,isSelected:a,maxOI:o,maxVol:l,onSelectStrike:c}){const p=u.useRef(n?.ltp??0),x=u.useRef(r?.ltp??0),f=Math.min(((n?.oi??0)/o+(n?.volume??0)/l)/2*100,100),y=Math.min(((r?.oi??0)/o+(r?.volume??0)/l)/2*100,100);return s.jsxs("div",{className:Re("grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 h-7 text-xs cursor-pointer hover:bg-accent/50 border-b border-border/30",i&&"bg-yellow-500/10 border-y border-yellow-500/30",a&&"bg-primary/10 ring-1 ring-primary/30"),onClick:()=>c(t,n?.symbol??null,r?.symbol??null),children:[s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[s.jsx($t,{value:n?.oi??0,max:o,side:"CE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Rt(n?.oi)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[s.jsx($t,{value:n?.volume??0,max:l,side:"CE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Rt(n?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-end h-full px-1.5 overflow-hidden",children:[s.jsx("div",{className:"absolute inset-y-0 right-0 bg-gradient-to-l from-emerald-500/35 to-transparent transition-[width] duration-200",style:{width:`${f}%`}}),s.jsx(An,{value:n?.ltp,prevRef:p,className:"relative z-10 font-medium"})]}),s.jsx("div",{className:Re("text-center font-bold tabular-nums px-1",i&&"text-yellow-500"),children:t}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[s.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-rose-500/35 to-transparent transition-[width] duration-200",style:{width:`${y}%`}}),s.jsx(An,{value:r?.ltp,prevRef:x,className:"relative z-10 font-medium"})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[s.jsx($t,{value:r?.volume??0,max:l,side:"PE",kind:"volume"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Rt(r?.volume)})]}),s.jsxs("div",{className:"relative flex items-center justify-start h-full px-1.5 overflow-hidden",children:[s.jsx($t,{value:r?.oi??0,max:o,side:"PE",kind:"oi"}),s.jsx("span",{className:"relative z-10 tabular-nums text-muted-foreground",children:Rt(r?.oi)})]})]})},Tr);function kr(){const e=ge(R=>R.apiKey),t=j(R=>R.underlying),n=j(R=>R.indexExchange),r=j(R=>R.optionExchange),i=j(R=>R.expiry),a=j(R=>R.selectedStrike),o=j(R=>R.chainStrikeCount),l=j(R=>R.setSelectedStrike),c=j(R=>R.setSelectedSymbols),p=j(R=>R.setLotSize),x=j(R=>R.setOptionChainSnapshot),f=u.useRef(null),y=u.useRef(null),N=u.useRef(!1),{data:g,isLoading:h,isStreaming:b,error:P,streamingSymbols:C,lastUpdate:M}=Ds(e,t,n,r,i,o,{enabled:!!e&&!!i,oiRefreshInterval:0,wsMode:"Quote"});u.useEffect(()=>{g&&x(g,M?.getTime()??Date.now(),b)},[g,M,b,x]),u.useEffect(()=>{if(!g?.chain?.length||N.current)return;const R=g.chain[0],I=R.ce?.lotsize??R.pe?.lotsize;I&&I>0&&(p(I),N.current=!0)},[g,p]),u.useEffect(()=>{N.current=!1},[t,i]),u.useEffect(()=>{if(g?.chain&&y.current&&f.current){const R=f.current,I=y.current,z=R.getBoundingClientRect(),w=I.getBoundingClientRect(),m=w.top-z.top-z.height/2+w.height/2;R.scrollTop+=m}},[g?.atm_strike]);const k=u.useCallback((R,I,z)=>{l(R),c(I,z)},[l,c]),{maxOI:F,maxVol:V}=u.useMemo(()=>{if(!g?.chain?.length)return{maxOI:1,maxVol:1};let R=0,I=0;for(const z of g.chain)z.ce?.oi&&z.ce.oi>R&&(R=z.ce.oi),z.pe?.oi&&z.pe.oi>R&&(R=z.pe.oi),z.ce?.volume&&z.ce.volume>I&&(I=z.ce.volume),z.pe?.volume&&z.pe.volume>I&&(I=z.pe.volume);return{maxOI:R||1,maxVol:I||1}},[g?.chain]),T=g?.underlying_ltp,K=g?.atm_strike;return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:"text-sm font-bold",children:t}),s.jsxs(ve,{variant:"outline",className:"text-[10px] h-4 px-1",children:[o," strikes"]}),T!=null&&s.jsx("span",{className:"text-sm tabular-nums font-mono text-muted-foreground",children:T.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[b&&s.jsxs(ve,{variant:"outline",className:"text-[10px] h-4 px-1 gap-0.5 text-green-500 border-green-500/30",children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),C]}),h&&s.jsx(ve,{variant:"outline",className:"text-[10px] h-4 px-1",children:"Loading..."})]})]}),s.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr_50px_1fr_1fr_1fr] items-center gap-0 px-0 py-0.5 text-[10px] text-muted-foreground font-medium border-b bg-muted/30 shrink-0",children:[s.jsx("div",{className:"text-right px-1.5",children:"OI (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-right px-1.5",children:"CE LTP"}),s.jsx("div",{className:"text-center",children:"Strike"}),s.jsx("div",{className:"text-left px-1.5",children:"PE LTP"}),s.jsx("div",{className:"text-left px-1.5",children:"Vol (L)"}),s.jsx("div",{className:"text-left px-1.5",children:"OI (L)"})]}),s.jsxs("div",{ref:f,className:"flex-1 overflow-y-auto overflow-x-hidden",children:[P&&s.jsx("div",{className:"p-4 text-center text-sm text-destructive",children:P}),!P&&!h&&g?.chain?.length===0&&s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No data available"}),g?.chain?.map(R=>{const I=R.strike===K;return s.jsx("div",{ref:I?y:void 0,children:s.jsx(Er,{strike:R.strike,ce:R.ce,pe:R.pe,isATM:I,isSelected:R.strike===a,maxOI:F,maxVol:V,onSelectStrike:k})},R.strike)})]})]})}function Lr({positions:e,totalPnl:t,isLivePnl:n}){const r=j(o=>o.activeSide),i=j(o=>o.hotkeysEnabled),a=j(o=>o.paperMode);return s.jsxs("div",{className:"flex items-center justify-between px-3 py-1 border-t bg-card text-xs shrink-0",children:[s.jsx("div",{className:"flex items-center gap-3 overflow-x-auto min-w-0",children:e.length===0?s.jsx("span",{className:"text-muted-foreground",children:"No open positions"}):s.jsxs(s.Fragment,{children:[e.map(o=>s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx("span",{className:o.side==="CE"?"text-green-500":"text-red-500",children:o.side}),s.jsx("span",{className:"font-mono",children:o.symbol.slice(-10)}),s.jsxs("span",{className:"text-muted-foreground",children:["x",o.quantity]}),s.jsxs("span",{className:"text-muted-foreground",children:["@",o.avgPrice.toFixed(1)]}),s.jsxs("span",{className:`font-bold tabular-nums ${o.pnl>0?"text-green-500":o.pnl<0?"text-red-500":"text-foreground"}`,children:[o.pnl>=0?"+":"",o.pnl.toFixed(0),s.jsxs("span",{className:"text-muted-foreground font-normal",children:["(",o.pnlPoints>=0?"+":"",o.pnlPoints.toFixed(1),"pts)"]})]})]},o.symbol)),e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-border",children:"|"}),s.jsx("span",{className:"text-muted-foreground",children:"Total:"}),s.jsxs("span",{className:`font-bold tabular-nums ${t>0?"text-green-500":t<0?"text-red-500":"text-foreground"}`,children:[t>=0?"+":"",t.toFixed(0)]}),s.jsx("span",{className:`text-[10px] ${n?"text-green-500":"text-muted-foreground"}`,children:n?"LIVE":"REST"})]})]})}),s.jsx("div",{className:"flex items-center gap-2 shrink-0",children:a&&s.jsx("span",{className:"text-blue-400 font-medium",children:"PAPER MODE"})}),s.jsx("div",{className:"flex items-center gap-2 text-muted-foreground shrink-0",children:i?s.jsxs(s.Fragment,{children:[s.jsxs("span",{children:["Active: ",s.jsx("span",{className:"text-foreground font-medium",children:r})]}),s.jsx("span",{className:"text-border",children:"|"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"B"}),s.jsx("span",{children:"Buy"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"S"}),s.jsx("span",{children:"Sell"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"R"}),s.jsx("span",{children:"Rev"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"C"}),s.jsx("span",{children:"Close"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"X"}),s.jsx("span",{children:"All"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"W"}),s.jsx("span",{children:"Widget"}),s.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded text-[10px]",children:"Tab"}),s.jsx("span",{children:"Side"})]}):s.jsx("span",{children:"Hotkeys disabled"})})]})}const xt=300*60+1800,On=1440*60,vt=540*60+900,In=900*60+1800;function Bt(e){return Number.isFinite(e)?e>1e12||e>1e10?Math.floor(e/1e3):Math.floor(e):0}function ks(e){const t=Bt(e)+xt,n=Math.floor(t/On)*On,r=t-n,i=(n-xt)*1e3,a=new Date(i).getUTCDay();return{dayStartIstSeconds:n,secondsOfDay:r,dayOfWeek:a}}function Mr(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.\d{1,3})?)?)?$/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]??"0"),o=Number(t[5]??"0"),l=Number(t[6]??"0");if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(l))return null;const c=Date.UTC(n,r-1,i,a,o,l)-xt*1e3;return Math.floor(c/1e3)}function Rr(e){if(!e||typeof e!="object")return null;const t=e,n=Number(t.year),r=Number(t.month),i=Number(t.day);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)||n<1970||r<1||r>12||i<1||i>31)return null;const a=Date.UTC(Math.floor(n),Math.floor(r)-1,Math.floor(i),0,0,0)-xt*1e3;return Math.floor(a/1e3)}function qe(e){if(typeof e=="number")return Bt(e);const t=Rr(e);if(t!=null)return t;if(typeof e!="string")return null;const n=e.trim();if(n.length===0)return null;const r=Number(n.replace(/,/g,""));if(Number.isFinite(r))return Bt(r);const i=Mr(n);if(i!=null)return i;const a=Date.parse(n);return Number.isFinite(a)?Math.floor(a/1e3):null}function pn(e,t={}){const{secondsOfDay:n,dayOfWeek:r}=ks(e);if(r===0||r===6)return!1;const i=n>=vt,a=t.includeClose?n<=In:n<In;return i&&a}function $r(e,t){const n=Math.max(1,Math.floor(t)),{dayStartIstSeconds:r,secondsOfDay:i}=ks(e),a=i<=vt?vt:vt+Math.floor((i-vt)/n)*n;return r+a-xt}function Ls(e){const t=(Bt(e)+xt)*1e3,n=new Date(t),r=n.getUTCHours().toString().padStart(2,"0"),i=n.getUTCMinutes().toString().padStart(2,"0");return`${r}:${i}`}function Ar(e,t,n,r={}){const i=Math.floor(e.timestamp/1e3),o=r.alignToIndiaSession?$r(i,n):Math.floor(i/n)*n,l=e.volume??0;return!t||t.time!==o?[{time:o,open:e.price,high:e.price,low:e.price,close:e.price,volume:l},!0]:[{...t,high:Math.max(t.high,e.price),low:Math.min(t.low,e.price),close:e.price,volume:t.volume+l},!1]}function Ms({symbol:e,exchange:t,intervalSec:n=1,enabled:r=!0,useIndiaMarketHours:i=!1,maxCandles:a=500,onCandleUpdate:o}){const l=u.useRef([]),c=u.useRef(null),p=u.useRef(null),x=u.useRef(o);x.current=o;const f=r&&e?[{symbol:e,exchange:t}]:[],{data:y,isConnected:N}=us({symbols:f,mode:"LTP",enabled:r&&!!e});u.useEffect(()=>{if(!r||!e||y.size===0)return;const P=`${t}:${e}`,C=y.get(P);if(!C?.data?.ltp)return;const M=C.lastUpdate;if(!M||!Number.isFinite(M))return;const k=Math.floor(M/1e3);if(i&&!pn(k))return;const F=`${P}:${M}`;if(p.current===F)return;p.current=F;const V={price:C.data.ltp,volume:C.data.volume,timestamp:M},[T,K]=Ar(V,c.current,n,{alignToIndiaSession:i});K&&c.current&&(l.current.push(c.current),l.current.length>a&&(l.current=l.current.slice(-a))),c.current=T,x.current?.(T,K)},[y,e,t,n,r,a,i]);const g=u.useCallback(()=>{const P=[...l.current];return c.current&&P.push(c.current),P},[]),h=u.useCallback(()=>{l.current=[],c.current=null,p.current=null},[]),b=u.useCallback(P=>{if(!P?.length){l.current=[],c.current=null;return}const C=P.slice(-a);if(C.length===1){l.current=[],c.current=C[0];return}l.current=C.slice(0,-1),c.current=C[C.length-1]},[a]);return{getCandles:g,reset:h,seed:b,isConnected:N}}function _t(e,t){if(e.length<t)return[];const n=2/(t+1),r=[];let i=0;for(let o=0;o<t;o++)i+=e[o].value;let a=i/t;r.push({time:e[t-1].time,value:a});for(let o=t;o<e.length;o++)a=e[o].value*n+a*(1-n),r.push({time:e[o].time,value:a});return r}function Rs(e,t=10,n=3){if(e.length<t+1)return{upper:[],lower:[],trend:[]};const r=Or(e,t),i=[],a=[],o=[];if(r.length===0)return{upper:i,lower:a,trend:o};const l=e.length-r.length;let c=0,p=0,x=1;for(let f=0;f<r.length;f++){const y=e[l+f],N=(y.high+y.low)/2,g=r[f].value;let h=N+n*g,b=N-n*g;f>0&&(b>p||e[l+f-1].close<p||(b=p),h<c||e[l+f-1].close>c||(h=c));let P=x;f>0&&(x===1&&y.close<b?P=-1:x===-1&&y.close>h&&(P=1));const C=y.time;i.push({time:C,value:h}),a.push({time:C,value:b}),o.push({time:C,value:P===1?b:h}),c=h,p=b,x=P}return{upper:i,lower:a,trend:o}}function Or(e,t=14){if(e.length<t+1)return[];const n=[],r=[];for(let a=1;a<e.length;a++){const o=e[a].high,l=e[a].low,c=e[a-1].close;r.push(Math.max(o-l,Math.abs(o-c),Math.abs(l-c)))}let i=0;for(let a=0;a<t;a++)i+=r[a];i/=t,n.push({time:e[t].time,value:i});for(let a=t;a<r.length;a++)i=(i*(t-1)+r[a])/t,n.push({time:e[a+1].time,value:i});return n}function $s(e){if(e.length===0)return[];const t=[];let n=0,r=0;for(const i of e){const a=(i.high+i.low+i.close)/3,o=i.volume||1;n+=a*o,r+=o,t.push({time:i.time,value:r>0?n/r:a})}return t}const Ir=120,ht=500,Fr=1;function At(e){return e.map(t=>({time:t.time,value:t.value}))}function zr(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.08)":"rgba(0, 0, 0, 0.06)",border:e?"rgba(161, 161, 170, 0.15)":"rgba(0, 0, 0, 0.1)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Dr(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Fn(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Ne(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function fn(e){const t=qe(e);return t??null}function Vr(e){if(!e?.length)return[];const t=[];for(const a of e){const o=qe(a.timestamp)??qe(a.time)??qe(a.datetime)??qe(a.date),l=Ne(a.open),c=Ne(a.high),p=Ne(a.low),x=Ne(a.close),f=Ne(a.volume)??0;o==null||l==null||c==null||p==null||x==null||t.push({time:o,open:l,high:c,low:p,close:x,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-ht),i=r.filter(a=>pn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-ht)}function ct(e){return e.map(t=>({...t}))}function Br(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-ht)}function Xt(e){const t=[];for(const n of e){const r=fn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function zn(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=fn(n.time),i=Ne(n.open),a=Ne(n.high),o=Ne(n.low),l=Ne(n.close),c=Ne(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-ht)}function _r({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}){const i=u.useRef(null),a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),p=u.useRef(null),x=u.useRef(null),f=u.useRef([]),y=u.useRef(new Map),N=u.useRef(null),g=u.useRef(0),h=u.useRef(null),b=u.useRef({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r}),P=ge(A=>A.apiKey),C=ge(A=>A.setApiKey),M=is(A=>A.mode==="dark"),k=j(A=>A.underlying),F=j(A=>A.indexExchange),V=j(A=>A.chartInterval),T=u.useCallback(()=>{const A=f.current,O=b.current,d=A.map($=>({time:$.time,value:$.close}));l.current&&l.current.setData(O.showEma9?At(_t(d,9)):[]),c.current&&c.current.setData(O.showEma21?At(_t(d,21)):[]),p.current&&p.current.setData(O.showSupertrend?At(Rs(A,10,3).trend):[]),x.current&&x.current.setData(O.showVwap?At($s(A)):[])},[]),K=u.useCallback(()=>{h.current===null&&(h.current=setTimeout(()=>{h.current=null,T()},Ir))},[T]),R=u.useCallback(()=>{f.current=[],o.current?.setData([]),l.current?.setData([]),c.current?.setData([]),p.current?.setData([]),x.current?.setData([])},[]),I=u.useCallback(A=>{const O=zn(A);f.current=ct(O),o.current?.setData(Xt(O)),K()},[K]),z=u.useCallback(async()=>{if(P)return P;try{const O=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(O.status==="success"&&O.api_key)return C(O.api_key),O.api_key}catch{}return null},[P,C]),w=u.useCallback((A,O)=>{if(!o.current)return;const d=fn(A.time),$=Ne(A.open),_=Ne(A.high),D=Ne(A.low),G=Ne(A.close),H=Ne(A.volume)??0;if(d==null||$==null||_==null||D==null||G==null)return;const U={time:d,open:$,high:_,low:D,close:G,volume:H},le=Number(U.time),J=f.current.length?Number(f.current[f.current.length-1].time):null;if(J!=null&&Number.isFinite(J)&&Number.isFinite(le)&&le<J)return;try{o.current.update({time:U.time,open:U.open,high:U.high,low:U.low,close:U.close})}catch{const S=zn([...f.current,U]);f.current=S,o.current.setData(Xt(S)),K();return}O?(f.current.push(U),f.current.length>ht&&(f.current=f.current.slice(-ht))):f.current.length>0?f.current[f.current.length-1]=U:f.current.push(U);const se=N.current;se&&y.current.set(se,ct(f.current)),K()},[K]),{isConnected:m,reset:v,seed:W}=Ms({symbol:k,exchange:F,intervalSec:V,enabled:!!k,useIndiaMarketHours:!0,onCandleUpdate:w});return u.useEffect(()=>{const A=N.current;if(A&&f.current.length>0&&y.current.set(A,ct(f.current)),!k){N.current=null,v(),R();return}const O=`${F}:${k}:${V}`;N.current=O;const d=y.current.get(O);if(d&&d.length>0){v(),W(d),I(d);return}v(),R();const $=++g.current,_=Dr(V),D=new Date,G=new Date(D.getTime());G.setDate(G.getDate()-Fr),(async()=>{const U=await z();if(!U){$===g.current&&R();return}try{const le=async()=>{try{const X=await fe.getQuotes(U,k,F);if(X.status!=="success"||!X.data)return null;const re=Ne(X.data.ltp);if(re==null||re<=0)return null;const E=Math.floor(Date.now()/1e3);return{time:Math.floor(E/V)*V,open:re,high:re,low:re,close:re,volume:Ne(X.data.volume)??0}}catch{return null}},J=async X=>{try{const re=await fe.getHistory(U,k,F,_,Fn(G),Fn(D),X);return re.status==="success"?Vr(re.data):[]}catch{return[]}},se=await J("api"),S=se.length>0?se:await J("db");if($!==g.current)return;const B=N.current===O?ct(f.current):[],Q=Br(S,B);if(Q.length>0){y.current.set(O,ct(Q)),W(Q),I(Q);return}const ne=await le();if(ne&&$===g.current){const X=[ne];y.current.set(O,ct(X)),W(X),I(X);return}}catch{}$===g.current&&R()})()},[k,F,V,z,v,W,R,I]),u.useEffect(()=>{b.current={showEma9:e,showEma21:t,showSupertrend:n,showVwap:r},l.current?.applyOptions({visible:e}),c.current?.applyOptions({visible:t}),p.current?.applyOptions({visible:n}),x.current?.applyOptions({visible:r}),K()},[e,t,n,r,K]),u.useEffect(()=>{const A=i.current;if(!A)return;const O=zr(M),d=os(A,{width:A.offsetWidth,height:A.offsetHeight,layout:{background:{type:cs.Solid,color:O.bg},textColor:O.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:11},grid:{vertLines:{color:O.grid},horzLines:{color:O.grid}},rightPriceScale:{borderColor:O.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:O.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:le=>Ls(le)},crosshair:{mode:ls.Normal,vertLine:{width:1,color:O.crosshair,style:2},horzLine:{width:1,color:O.crosshair,style:2}}}),$=d.addSeries(ds,{upColor:O.upColor,downColor:O.downColor,borderVisible:!1,wickUpColor:O.upColor,wickDownColor:O.downColor}),_=d.addSeries(Ze,{color:O.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:b.current.showEma9}),D=d.addSeries(Ze,{color:O.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:b.current.showEma21}),G=d.addSeries(Ze,{color:O.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:b.current.showSupertrend}),H=d.addSeries(Ze,{color:O.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:b.current.showVwap});a.current=d,o.current=$,l.current=_,c.current=D,p.current=G,x.current=H,f.current.length>0&&($.setData(Xt(f.current)),K());const U=new ResizeObserver(()=>{if(a.current&&A){const le=A.offsetWidth,J=A.offsetHeight;le>0&&J>0&&a.current.applyOptions({width:le,height:J})}});return U.observe(A),()=>{h.current!==null&&(clearTimeout(h.current),h.current=null),U.disconnect(),d.remove(),a.current=null,o.current=null,l.current=null,c.current=null,p.current=null,x.current=null}},[M,K]),s.jsxs("div",{className:"relative h-full w-full min-w-0 min-h-0 overflow-hidden",children:[s.jsx("div",{ref:i,className:"h-full w-full"}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:"text-xs font-bold text-foreground/80",children:k}),!m&&s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})]}),s.jsxs("div",{className:"absolute top-1 right-2 flex items-center gap-1 pointer-events-none",children:[e&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),t&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),n&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),r&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]})]})}const Z=rn()(an((e,t)=>({virtualTPSL:{},triggerOrders:{},setVirtualTPSL:n=>e(r=>({virtualTPSL:{...r.virtualTPSL,[n.id]:n}})),removeVirtualTPSL:n=>e(r=>{const{[n]:i,...a}=r.virtualTPSL;return{virtualTPSL:a}}),updateVirtualTPSL:(n,r)=>e(i=>{const a=i.virtualTPSL[n];return a?{virtualTPSL:{...i.virtualTPSL,[n]:{...a,...r}}}:i}),getTPSLForSymbol:n=>Object.values(t().virtualTPSL).find(i=>i.symbol===n),addTriggerOrder:n=>e(r=>({triggerOrders:{...r.triggerOrders,[n.id]:n}})),removeTriggerOrder:n=>e(r=>{const{[n]:i,...a}=r.triggerOrders;return{triggerOrders:a}}),updateTriggerOrder:(n,r)=>e(i=>{const a=i.triggerOrders[n];return a?{triggerOrders:{...i.triggerOrders,[n]:{...a,...r}}}:i}),clearTriggerOrders:()=>e({triggerOrders:{}}),clearAll:()=>e({virtualTPSL:{},triggerOrders:{}}),clearForSymbol:n=>e(r=>{const i=Object.fromEntries(Object.entries(r.virtualTPSL).filter(([,o])=>o.symbol!==n)),a=Object.fromEntries(Object.entries(r.triggerOrders).filter(([,o])=>o.symbol!==n));return{virtualTPSL:i,triggerOrders:a}})}),{name:"openalgo-scalping-orders",version:2,partialize:e=>({virtualTPSL:e.virtualTPSL}),migrate:e=>({virtualTPSL:(e??{}).virtualTPSL??{},triggerOrders:{}})})),Dn=.05;function Ce(e){return Math.round(e/Dn)*Dn}function dt(e){return Number(Math.max(0,e).toFixed(2))}function Gr(e){const t=e.action==="BUY";return{tpPrice:e.tpPoints>0?Ce(e.triggerPrice+(t?e.tpPoints:-e.tpPoints)):null,slPrice:e.slPoints>0?Ce(e.triggerPrice+(t?-e.slPoints:e.slPoints)):null}}function qr({chartRef:e,seriesRef:t,side:n,containerRef:r}){const i=j(L=>L.activeSide),a=j(L=>L.orderType),o=j(L=>L.tpPoints),l=j(L=>L.slPoints),c=j(L=>L.limitPrice),p=j(L=>L.pendingEntryAction),x=j(L=>L.quantity),f=j(L=>L.lotSize),y=j(L=>L.optionExchange),N=j(L=>L.product),g=j(L=>L.paperMode),h=j(L=>L.setLimitPrice),b=j(L=>L.setTpPoints),P=j(L=>L.setSlPoints),C=j(L=>L.setPendingEntryAction),M=j(L=>n==="CE"?L.selectedCESymbol:L.selectedPESymbol),k=Z(L=>L.virtualTPSL),F=Z(L=>L.triggerOrders),V=Z(L=>L.addTriggerOrder),T=Z(L=>L.updateTriggerOrder),K=Z(L=>L.removeTriggerOrder),R=Z(L=>L.updateVirtualTPSL),I=Z(L=>L.removeVirtualTPSL),z=u.useRef(null),w=u.useRef(null),m=u.useRef(null),v=u.useRef(null),[W,A]=u.useState(null),[O,d]=u.useState(null),[$,_]=u.useState(null),[D,G]=u.useState(null),[H,U]=u.useState(!1),le=u.useRef(null),J=i===n,se=a==="LIMIT"||a==="TRIGGER",S=u.useMemo(()=>M?Object.values(k).find(L=>L.symbol===M):void 0,[M,k]),B=u.useMemo(()=>M?Object.values(F).find(L=>L.symbol===M):void 0,[M,F]),Q=S?"position":B?"trigger":J&&se&&c!=null?"pending":null,ne=p??"BUY";u.useEffect(()=>{if(!S){G(null);return}const L=jt.getInstance(),Y=L.getCachedData(S.symbol,S.exchange)?.data?.ltp;Y&&Y>0&&G(Y);const oe=L.subscribe(S.symbol,S.exchange,"LTP",he=>{const ue=he.data.ltp;ue&&ue>0&&G(ue)});return()=>oe()},[S]);const X=u.useMemo(()=>{if(!S||!D||D<=0)return null;const L=S.action==="BUY"?D-S.entryPrice:S.entryPrice-D,Y=L*S.quantity;return{ltp:D,points:L,pnl:Y}},[S,D]),re=u.useMemo(()=>{if(!S)return"";const L=`${S.action} @ ${S.entryPrice.toFixed(2)}`;if(!X)return L;const Y=X.pnl>=0?"+":"";return`${L} | PnL ${Y}${X.pnl.toFixed(2)}`},[S,X]),E=u.useCallback(L=>{if(L.current&&t.current){try{t.current.removePriceLine(L.current)}catch{}L.current=null}},[t]),ye=u.useCallback((L,Y,oe,he,ue,ie)=>{t.current&&(L.current?L.current.applyOptions({price:Y,color:oe,lineStyle:he,lineWidth:ue,title:ie,axisLabelVisible:!0}):L.current=t.current.createPriceLine({price:Y,color:oe,lineStyle:he,lineWidth:ue,title:ie,axisLabelVisible:!0}))},[t]),Ke=u.useCallback(L=>{if(!t.current)return null;const Y=t.current.priceToCoordinate(L);return Y??null},[t]),me=u.useCallback(()=>{const L=(Y,oe)=>{if(!Y.current){oe(null);return}const he=Y.current.options().price,ue=Ke(he);if(ue==null){oe(null);return}oe({y:ue,price:he})};L(w,A),L(m,d),L(v,_)},[Ke]),Se=u.useCallback(L=>{if(!M)return"above";const oe=jt.getInstance().getCachedData(M,y)?.data?.ltp;return!oe||oe<=0||L>=oe?"above":"below"},[M,y]);u.useEffect(()=>{const L=e.current,Y=t.current;if(!L||!Y)return;if(!(J&&se&&!S&&!B&&c==null)){E(z);return}const he=ue=>{if(!ue.point){E(z);return}const ie=Y.coordinateToPrice(ue.point.y);if(ie==null){E(z);return}const xe=Ce(ie);ye(z,xe,"#a1a1aa",Ge.Dashed,1,xe.toFixed(2))};return L.subscribeCrosshairMove(he),()=>{L.unsubscribeCrosshairMove(he),E(z)}},[e,t,J,se,S,B,c,E,ye]),u.useEffect(()=>{const L=e.current,Y=t.current;if(!L||!Y||!M||!J||!se)return;const oe=he=>{if(!he.point)return;const ue=Y.coordinateToPrice(he.point.y);if(ue==null)return;const ie=Ce(ue);if(a==="TRIGGER"){const xe=p??B?.action;if(!xe){console.warn("[Scalping] Select BUY/SELL first, then click chart to place TRIGGER line");return}const ce=Se(ie);B?T(B.id,{triggerPrice:ie,action:xe,direction:ce,quantity:x*f,tpPoints:o,slPoints:l}):V({id:`trigger-${Date.now()}`,symbol:M,exchange:y,side:n,action:xe,triggerPrice:ie,direction:ce,quantity:x*f,tpPoints:o,slPoints:l,createdAt:Date.now()}),h(ie),C(null)}else{if(!p&&c==null){console.warn("[Scalping] Select BUY/SELL first, then click chart to place LIMIT line");return}h(ie),p||C("BUY")}E(z),me()};return L.subscribeClick(oe),()=>{L.unsubscribeClick(oe)}},[e,t,M,J,se,a,p,c,B,x,f,o,l,y,n,V,T,h,C,Se,E,me]),u.useEffect(()=>{if(!t.current)return;const L=()=>{E(w),E(m),E(v),A(null),d(null),_(null)};if(S){const Y=S.action==="BUY"?"#00ff88":"#ff4560";ye(w,Ce(S.entryPrice),Y,Ge.Dotted,2,`${S.action} @ ${S.entryPrice.toFixed(2)}`),S.tpPrice!=null?ye(m,Ce(S.tpPrice),"#00ff88",Ge.Dashed,1,`TP @ ${S.tpPrice.toFixed(2)}`):E(m),S.slPrice!=null?ye(v,Ce(S.slPrice),"#ff4560",Ge.Dashed,1,`SL @ ${S.slPrice.toFixed(2)}`):E(v),me();return}if(B){const{tpPrice:Y,slPrice:oe}=Gr(B),he=Ce(B.triggerPrice);ye(w,he,"#ffa500",Ge.Dashed,2,`TRIGGER ${B.action} @ ${he.toFixed(2)}`),Y!=null?ye(m,Y,"#00ff88",Ge.Dashed,1,`TP @ ${Y.toFixed(2)}`):E(m),oe!=null?ye(v,oe,"#ff4560",Ge.Dashed,1,`SL @ ${oe.toFixed(2)}`):E(v),me();return}if(J&&se&&c!=null){const Y=ne,oe=Ce(c);if(ye(w,oe,a==="LIMIT"?"#06b6d4":"#ffa500",Ge.Dashed,2,`${a} ${Y} @ ${oe.toFixed(2)}`),o>0){const ue=Ce(oe+(Y==="BUY"?o:-o));ye(m,ue,"#00ff88",Ge.Dashed,1,`TP @ ${ue.toFixed(2)}`)}else E(m);if(l>0){const ue=Ce(oe+(Y==="BUY"?-l:l));ye(v,ue,"#ff4560",Ge.Dashed,1,`SL @ ${ue.toFixed(2)}`)}else E(v);me();return}L()},[t,S,B,J,se,c,ne,a,o,l,E,ye,me]),u.useEffect(()=>{!S||!w.current||w.current.applyOptions({title:re})},[S,re]),u.useEffect(()=>{const L=e.current;if(!L)return;const Y=()=>me();L.subscribeCrosshairMove(Y);const oe=L.timeScale();return oe.subscribeVisibleLogicalRangeChange(Y),()=>{L.unsubscribeCrosshairMove(Y),oe.unsubscribeVisibleLogicalRangeChange(Y)}},[e,me]),u.useEffect(()=>()=>{E(z),E(w),E(m),E(v),A(null),d(null),_(null)},[M,E]),u.useEffect(()=>{a==="MARKET"&&(S||B||(E(z),E(w),E(m),E(v),A(null),d(null),_(null),h(null),C(null)))},[a,S,B,E,h,C]);const We=u.useCallback((L,Y)=>{if(Y.preventDefault(),Y.stopPropagation(),!Q||!(L==="entry"?w:L==="tp"?m:v).current)return;le.current={type:L,source:Q};const he=ie=>{const xe=le.current,ce=t.current,ze=r.current;if(!xe||!ce||!ze)return;const qt=ze.getBoundingClientRect(),ee=ie.clientY-qt.top,yt=ce.coordinateToPrice(ee);if(yt==null)return;const Ae=Ce(yt),we=xe.type==="entry"?w:xe.type==="tp"?m:v;if(!we.current)return;let je="";if(xe.type==="entry"?xe.source==="trigger"?je=`TRIGGER ${B?.action??"BUY"} @ ${Ae.toFixed(2)}`:xe.source==="pending"?je=`${a} ${ne} @ ${Ae.toFixed(2)}`:xe.source==="position"?je=`${S?.action??ne} @ ${Ae.toFixed(2)}`:je=we.current.options().title??Ae.toFixed(2):xe.type==="tp"?je=`TP @ ${Ae.toFixed(2)}`:je=`SL @ ${Ae.toFixed(2)}`,we.current.applyOptions({price:Ae,title:je}),xe.type==="entry"){const _e=xe.source==="trigger"?B?.action??ne:xe.source==="position"?S?.action??ne:ne,ke=xe.source==="trigger"?B?.tpPoints??0:xe.source==="position"?S?.tpPoints??0:o,He=xe.source==="trigger"?B?.slPoints??0:xe.source==="position"?S?.slPoints??0:l;if(ke>0&&m.current){const Ye=Ce(Ae+(_e==="BUY"?ke:-ke));m.current.applyOptions({price:Ye,title:`TP @ ${Ye.toFixed(2)}`})}if(He>0&&v.current){const Ye=Ce(Ae+(_e==="BUY"?-He:He));v.current.applyOptions({price:Ye,title:`SL @ ${Ye.toFixed(2)}`})}}me()},ue=()=>{const ie=le.current;if(!ie)return;const ce=(ie.type==="entry"?w:ie.type==="tp"?m:v).current?.options().price;if(ce!=null){if(ie.source==="position"&&S){const ze=ie.type==="entry"?{entryPrice:ce,tpPrice:S.tpPrice!=null?Ce(S.tpPrice+(ce-S.entryPrice)):null,slPrice:S.slPrice!=null?Ce(S.slPrice+(ce-S.entryPrice)):null}:ie.type==="tp"?{tpPrice:ce,tpPoints:dt(Math.abs(ce-S.entryPrice))}:ie.type==="sl"?{slPrice:ce,slPoints:dt(Math.abs(S.entryPrice-ce))}:null;ze&&R(S.id,ze)}if(ie.source==="trigger"&&B&&(ie.type==="entry"&&(T(B.id,{triggerPrice:ce,direction:Se(ce)}),h(ce)),ie.type==="tp"&&T(B.id,{tpPoints:dt(Math.abs(ce-B.triggerPrice))}),ie.type==="sl"&&T(B.id,{slPoints:dt(Math.abs(B.triggerPrice-ce))})),ie.source==="pending"){const ze=w.current?.options().price??c??ce;ie.type==="entry"&&h(ce),ie.type==="tp"&&b(dt(Math.abs(ce-ze))),ie.type==="sl"&&P(dt(Math.abs(ze-ce)))}}me(),le.current=null,document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ue)};document.addEventListener("mousemove",he),document.addEventListener("mouseup",ue)},[Q,t,r,S,B,ne,a,c,o,l,R,T,Se,me,h,b,P]),wt=u.useCallback(()=>{E(w),E(m),E(v),A(null),d(null),_(null),S&&I(S.id),B&&K(B.id),h(null),C(null)},[S,B,E,I,K,h,C]),gt=u.useCallback(L=>{if(E(L==="tp"?m:v),L==="tp"?d(null):_(null),S){R(S.id,L==="tp"?{tpPrice:null,tpPoints:0}:{slPrice:null,slPoints:0});return}if(B){T(B.id,L==="tp"?{tpPoints:0}:{slPoints:0});return}L==="tp"?b(0):P(0)},[S,B,E,b,P,R,T]),Ct=u.useCallback(async()=>{if(!(!S||H)){U(!0);try{if(g)console.log(`[Paper] Close ${S.action} ${S.symbol}`);else{const L=await fe.closePosition(S.symbol,S.exchange,N);if(L.status!=="success"){console.error("[Scalping] Close position rejected:",L);return}}I(S.id),E(w),E(m),E(v),A(null),d(null),_(null)}catch(L){console.error("[Scalping] Close position failed:",L)}finally{U(!1)}}},[S,H,g,N,I,E]);if(!r.current)return null;const ae=!!S,be=ae?S.action==="BUY"?"green":"red":a==="LIMIT"?"cyan":"orange",Ee=ae?`${S.action} @ ${W?.price.toFixed(2)??"--"}`:B?`TRIGGER ${B.action} @ ${W?.price.toFixed(2)??"--"}`:`${a} ${ne} @ ${W?.price.toFixed(2)??"--"}`,Ue={green:"bg-green-500/15 text-green-400 border-green-500/30",red:"bg-red-500/15 text-red-400 border-red-500/30",cyan:"bg-cyan-500/15 text-cyan-400 border-cyan-500/30",orange:"bg-orange-500/15 text-orange-400 border-orange-500/30"}[be],ot={green:"bg-green-400/50",red:"bg-red-400/50",cyan:"bg-cyan-400/50",orange:"bg-orange-400/50"}[be],Tt=Q!==null;return s.jsxs(s.Fragment,{children:[W&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:W.y},children:[s.jsx("div",{className:Re("absolute left-0 right-0 top-0 h-px -translate-y-1/2",ot)}),s.jsx("div",{className:Re("absolute left-0 right-0 -top-3 h-6 pointer-events-auto",Tt?"cursor-ns-resize":"cursor-default"),onMouseDown:Tt?L=>We("entry",L):void 0}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsx("span",{className:Re("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",Ue),children:Ee}),ae&&X&&s.jsxs("span",{className:Re("text-[10px] font-mono px-1.5 py-0.5 rounded-sm border",X.pnl>=0?"bg-green-500/15 text-green-400 border-green-500/30":"bg-red-500/15 text-red-400 border-red-500/30"),children:["LTP ",X.ltp.toFixed(2)," | PnL ",X.pnl>=0?"+":"",X.pnl.toFixed(2)]}),ae&&s.jsx("button",{type:"button",className:"text-[10px] font-semibold h-5 px-1.5 rounded-sm border border-destructive/40 text-destructive/80 hover:text-destructive hover:bg-destructive/10 disabled:opacity-50",onClick:L=>{L.stopPropagation(),Ct()},disabled:H,title:"Close position at market",children:H?"...":"Close"}),s.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-foreground/60 hover:text-foreground hover:bg-muted/50",onClick:L=>{L.stopPropagation(),wt()},title:ae?"Remove virtual position tracking":"Cancel pending order",children:"x"})]})]}),O&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:O.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-green-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:L=>We("tp",L)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-green-500/15 text-green-400 border-green-500/30",children:["TP @ ",O.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-green-400/60 hover:text-green-400 hover:bg-muted/50",onClick:L=>{L.stopPropagation(),gt("tp")},title:"Remove TP line",children:"x"})]})]}),$&&s.jsxs("div",{className:"absolute left-0 right-0 z-[14] pointer-events-none",style:{top:$.y},children:[s.jsx("div",{className:"absolute left-0 right-0 top-0 h-px -translate-y-1/2 bg-red-400/50"}),s.jsx("div",{className:"absolute left-0 right-0 -top-3 h-6 cursor-ns-resize pointer-events-auto",onMouseDown:L=>We("sl",L)}),s.jsxs("div",{className:"absolute right-[62px] top-0 -translate-y-1/2 z-[15] flex items-center gap-1 pointer-events-auto",children:[s.jsxs("span",{className:"text-[10px] font-mono px-1.5 py-0.5 rounded-sm border bg-red-500/15 text-red-400 border-red-500/30",children:["SL @ ",$.price.toFixed(2)]}),s.jsx("button",{type:"button",className:"text-xs font-bold w-4 h-4 flex items-center justify-center rounded-sm text-red-400/60 hover:text-red-400 hover:bg-muted/50",onClick:L=>{L.stopPropagation(),gt("sl")},title:"Remove SL line",children:"x"})]})]})]})}const Kr=120,Wr=1;function Ot(e){return e.map(t=>({time:t.time,value:t.value}))}function Ur(e){return{bg:"transparent",text:e?"#a1a1aa":"#71717a",grid:e?"rgba(161, 161, 170, 0.06)":"rgba(0, 0, 0, 0.04)",border:e?"rgba(161, 161, 170, 0.12)":"rgba(0, 0, 0, 0.08)",crosshair:e?"rgba(161, 161, 170, 0.4)":"rgba(0, 0, 0, 0.3)",upColor:"#22c55e",downColor:"#ef4444",ema9:"#f59e0b",ema21:"#8b5cf6",supertrend:"#06b6d4",vwap:"#ec4899"}}function Hr(e){switch(e){case 30:return"1m";case 60:return"1m";case 180:return"3m";case 300:return"5m";case 900:return"15m";case 1800:return"30m";case 3600:return"1h";default:return"1m"}}function Vn(e){const t=e.getFullYear(),n=`${e.getMonth()+1}`.padStart(2,"0"),r=`${e.getDate()}`.padStart(2,"0");return`${t}-${n}-${r}`}function Pe(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}function mn(e){const t=qe(e);return t??null}function Yr(e){if(!e?.length)return[];const t=[];for(const a of e){const o=qe(a.timestamp)??qe(a.time)??qe(a.datetime)??qe(a.date),l=Pe(a.open),c=Pe(a.high),p=Pe(a.low),x=Pe(a.close),f=Pe(a.volume)??0;o==null||l==null||c==null||p==null||x==null||t.push({time:o,open:l,high:c,low:p,close:x,volume:f})}if(t.length===0)return[];t.sort((a,o)=>Number(a.time)-Number(o.time));const n=new Map;for(const a of t)n.set(Number(a.time),a);const r=Array.from(n.values()).slice(-500),i=r.filter(a=>pn(Number(a.time),{includeClose:!0}));return(i.length>0?i:r).slice(-500)}function ut(e){return e.map(t=>({...t}))}function Zr(e,t){const n=new Map;for(const r of e)n.set(Number(r.time),r);for(const r of t)n.set(Number(r.time),r);return Array.from(n.values()).sort((r,i)=>Number(r.time)-Number(i.time)).slice(-500)}function Qt(e){const t=[];for(const n of e){const r=mn(n.time);r!=null&&t.push({time:r,open:n.open,high:n.high,low:n.low,close:n.close})}return t.sort((n,r)=>Number(n.time)-Number(r.time)),t}function Bn(e){if(!e.length)return[];const t=new Map;for(const n of e){const r=mn(n.time),i=Pe(n.open),a=Pe(n.high),o=Pe(n.low),l=Pe(n.close),c=Pe(n.volume)??0;r==null||i==null||a==null||o==null||l==null||t.set(Number(r),{time:r,open:i,high:a,low:o,close:l,volume:c})}return Array.from(t.values()).sort((n,r)=>Number(n.time)-Number(r.time)).slice(-500)}function _n({side:e,showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}){const a=u.useRef(null),o=u.useRef(null),l=u.useRef(null),c=u.useRef(null),p=u.useRef(null),x=u.useRef(null),f=u.useRef(null),y=u.useRef([]),N=u.useRef(new Map),g=u.useRef(null),h=u.useRef(0),b=u.useRef(null),P=u.useRef({showEma9:t,showEma21:n,showSupertrend:r,showVwap:i}),C=ge(D=>D.apiKey),M=ge(D=>D.setApiKey),k=is(D=>D.mode==="dark"),F=j(D=>D.activeSide),V=j(D=>D.setActiveSide),T=j(D=>D.optionExchange),K=j(D=>D.chartInterval),R=j(D=>e==="CE"?D.selectedCESymbol:D.selectedPESymbol),I=F===e,z=u.useCallback(()=>{const D=y.current,G=P.current,H=D.map(U=>({time:U.time,value:U.close}));c.current&&c.current.setData(G.showEma9?Ot(_t(H,9)):[]),p.current&&p.current.setData(G.showEma21?Ot(_t(H,21)):[]),x.current&&x.current.setData(G.showSupertrend?Ot(Rs(D,10,3).trend):[]),f.current&&f.current.setData(G.showVwap?Ot($s(D)):[])},[]),w=u.useCallback(()=>{b.current===null&&(b.current=setTimeout(()=>{b.current=null,z()},Kr))},[z]),m=u.useCallback(()=>{y.current=[],l.current?.setData([]),c.current?.setData([]),p.current?.setData([]),x.current?.setData([]),f.current?.setData([])},[]),v=u.useCallback(D=>{const G=Bn(D);y.current=ut(G),l.current?.setData(Qt(G)),w()},[w]),W=u.useCallback(async()=>{if(C)return C;try{const G=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(G.status==="success"&&G.api_key)return M(G.api_key),G.api_key}catch{}return null},[C,M]),A=u.useCallback(()=>{V(e)},[e,V]),O=u.useCallback((D,G)=>{if(!l.current)return;const H=mn(D.time),U=Pe(D.open),le=Pe(D.high),J=Pe(D.low),se=Pe(D.close),S=Pe(D.volume)??0;if(H==null||U==null||le==null||J==null||se==null)return;const B={time:H,open:U,high:le,low:J,close:se,volume:S},Q=Number(B.time),ne=y.current.length?Number(y.current[y.current.length-1].time):null;if(ne!=null&&Number.isFinite(ne)&&Number.isFinite(Q)&&Q<ne)return;try{l.current.update({time:B.time,open:B.open,high:B.high,low:B.low,close:B.close})}catch{const re=Bn([...y.current,B]);y.current=re,l.current.setData(Qt(re)),w();return}G?(y.current.push(B),y.current.length>500&&(y.current=y.current.slice(-500))):y.current.length>0?y.current[y.current.length-1]=B:y.current.push(B);const X=g.current;X&&N.current.set(X,ut(y.current)),w()},[w]),{isConnected:d,reset:$,seed:_}=Ms({symbol:R??"",exchange:T,intervalSec:K,enabled:!!R,useIndiaMarketHours:!0,onCandleUpdate:O});return u.useEffect(()=>{const D=g.current;if(D&&y.current.length>0&&N.current.set(D,ut(y.current)),!R){g.current=null,$(),m();return}const G=`${T}:${R}:${K}`;g.current=G;const H=N.current.get(G);if(H&&H.length>0){$(),_(H),v(H);return}$(),m();const U=++h.current,le=Hr(K),J=new Date,se=new Date(J.getTime());se.setDate(se.getDate()-Wr),(async()=>{const B=await W();if(!B){U===h.current&&m();return}try{const Q=async()=>{try{const me=await fe.getQuotes(B,R,T);if(me.status!=="success"||!me.data)return null;const Se=Pe(me.data.ltp);if(Se==null||Se<=0)return null;const We=Math.floor(Date.now()/1e3);return{time:Math.floor(We/K)*K,open:Se,high:Se,low:Se,close:Se,volume:Pe(me.data.volume)??0}}catch{return null}},ne=async me=>{try{const Se=await fe.getHistory(B,R,T,le,Vn(se),Vn(J),me);return Se.status==="success"?Yr(Se.data):[]}catch{return[]}},X=await ne("api"),re=X.length>0?X:await ne("db");if(U!==h.current)return;const E=g.current===G?ut(y.current):[],ye=Zr(re,E);if(ye.length>0){N.current.set(G,ut(ye)),_(ye),v(ye);return}const Ke=await Q();if(Ke&&U===h.current){const me=[Ke];N.current.set(G,ut(me)),_(me),v(me);return}}catch{}U===h.current&&m()})()},[R,T,K,W,$,_,m,v]),u.useEffect(()=>{P.current={showEma9:t,showEma21:n,showSupertrend:r,showVwap:i},c.current?.applyOptions({visible:t}),p.current?.applyOptions({visible:n}),x.current?.applyOptions({visible:r}),f.current?.applyOptions({visible:i}),w()},[t,n,r,i,w]),u.useEffect(()=>{const D=a.current;if(!D)return;const G=Ur(k),H=os(D,{width:D.offsetWidth,height:D.offsetHeight,layout:{background:{type:cs.Solid,color:G.bg},textColor:G.text,fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:10},grid:{vertLines:{color:G.grid},horzLines:{color:G.grid}},rightPriceScale:{borderColor:G.border,scaleMargins:{top:.08,bottom:.08}},timeScale:{borderColor:G.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:Q=>Ls(Q)},crosshair:{mode:ls.Normal,vertLine:{width:1,color:G.crosshair,style:2},horzLine:{width:1,color:G.crosshair,style:2}}}),U=H.addSeries(ds,{upColor:G.upColor,downColor:G.downColor,borderVisible:!1,wickUpColor:G.upColor,wickDownColor:G.downColor}),le=H.addSeries(Ze,{color:G.ema9,lineWidth:1,title:"EMA9",lastValueVisible:!1,priceLineVisible:!1,visible:P.current.showEma9}),J=H.addSeries(Ze,{color:G.ema21,lineWidth:1,title:"EMA21",lastValueVisible:!1,priceLineVisible:!1,visible:P.current.showEma21}),se=H.addSeries(Ze,{color:G.supertrend,lineWidth:2,title:"ST",lastValueVisible:!1,priceLineVisible:!1,visible:P.current.showSupertrend}),S=H.addSeries(Ze,{color:G.vwap,lineWidth:1,lineStyle:2,title:"VWAP",lastValueVisible:!1,priceLineVisible:!1,visible:P.current.showVwap});o.current=H,l.current=U,c.current=le,p.current=J,x.current=se,f.current=S,y.current.length>0&&(U.setData(Qt(y.current)),w());const B=new ResizeObserver(()=>{if(o.current&&D){const Q=D.offsetWidth,ne=D.offsetHeight;Q>0&&ne>0&&o.current.applyOptions({width:Q,height:ne})}});return B.observe(D),()=>{b.current!==null&&(clearTimeout(b.current),b.current=null),B.disconnect(),H.remove(),o.current=null,l.current=null,c.current=null,p.current=null,x.current=null,f.current=null}},[k,w]),s.jsxs("div",{className:Re("relative h-full w-full min-w-0 min-h-0 overflow-hidden cursor-pointer",I&&"ring-1 ring-primary/40"),onClick:A,children:[s.jsx("div",{ref:a,className:"h-full w-full"}),s.jsx(qr,{chartRef:o,seriesRef:l,side:e,containerRef:a}),s.jsxs("div",{className:"absolute top-1 left-2 flex items-center gap-1.5 pointer-events-none",children:[s.jsx("span",{className:Re("text-xs font-bold",e==="CE"?"text-green-500":"text-red-500"),children:e}),R&&s.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:R}),!R&&s.jsx("span",{className:"text-[10px] text-muted-foreground/50",children:"Select a strike"})]}),s.jsxs("div",{className:"absolute top-5 right-2 flex items-center gap-1 pointer-events-none",children:[t&&s.jsx("span",{className:"text-[9px] text-amber-500 font-mono",children:"E9"}),n&&s.jsx("span",{className:"text-[9px] text-violet-500 font-mono",children:"E21"}),r&&s.jsx("span",{className:"text-[9px] text-cyan-500 font-mono",children:"ST"}),i&&s.jsx("span",{className:"text-[9px] text-pink-500 font-mono",children:"VW"})]}),I&&s.jsx("div",{className:"absolute top-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] font-medium text-primary",children:"ACTIVE"})}),R&&!d&&s.jsx("div",{className:"absolute bottom-1 right-2 pointer-events-none",children:s.jsx("span",{className:"text-[10px] text-yellow-500",children:"Connecting..."})}),!R&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:"text-xs text-muted-foreground/40",children:"Click a strike in the chain"})})]})}const Gn=.05;function Dt(e){return Math.round(e/Gn)*Gn}function It(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:Dt(e)}async function it({symbol:e,exchange:t,preferredPrice:n=null,fallbackPrice:r=null,apiKey:i=null}){const a=It(n);if(a!=null)return a;const o=jt.getInstance(),l=It(o.getCachedData(e,t)?.data?.ltp);if(l!=null)return l;const c=It(r);if(c!=null)return c;if(i)try{const p=await fe.getQuotes(i,e,t),x=It(p.data?.ltp);if(x!=null)return x}catch{}return 0}function Je({id:e=`tpsl-${Date.now()}`,symbol:t,exchange:n,side:r,action:i,entryPrice:a,quantity:o,tpPoints:l,slPoints:c,createdAt:p=Date.now(),managedBy:x="manual",autoEntryScore:f,autoEntryReason:y}){const N=Dt(a),g=Number(Math.max(0,l||0).toFixed(2)),h=Number(Math.max(0,c||0).toFixed(2)),b=i==="BUY";return{id:e,symbol:t,exchange:n,side:r,action:i,entryPrice:N,quantity:o,tpPrice:g>0?Dt(N+(b?g:-g)):null,slPrice:h>0?Dt(N+(b?-h:h)):null,tpPoints:g,slPoints:h,createdAt:p,managedBy:x,autoEntryScore:f,autoEntryReason:y}}function Xr(){const e=ge(S=>S.apiKey),t=ge(S=>S.setApiKey),n=j(S=>S.showFloatingWidget),r=j(S=>S.activeSide),i=j(S=>S.selectedCESymbol),a=j(S=>S.selectedPESymbol),o=j(S=>S.optionExchange),l=j(S=>S.quantity),c=j(S=>S.lotSize),p=j(S=>S.product),x=j(S=>S.tpPoints),f=j(S=>S.slPoints),y=j(S=>S.orderType),N=j(S=>S.limitPrice),g=j(S=>S.setLimitPrice),h=j(S=>S.setPendingEntryAction),b=j(S=>S.paperMode),P=Z(S=>S.setVirtualTPSL),C=Z(S=>S.getTPSLForSymbol),M=Z(S=>S.removeVirtualTPSL),k=Z(S=>S.triggerOrders),F=Z(S=>S.removeTriggerOrder),V=j(S=>S.ceWidgetPos),T=j(S=>S.setCeWidgetPos),K=j(S=>S.incrementQuantity),R=j(S=>S.decrementQuantity),I=j(S=>S.setTpPoints),z=j(S=>S.setSlPoints),w=j(S=>S.incrementTradeCount),m=r==="CE"?i:a,[v,W]=u.useState(!1),[A,O]=u.useState(null),[d,$]=u.useState(null),_=u.useRef(null),D=u.useRef(null);u.useEffect(()=>{if(!m){O(null),$(null);return}const B=jt.getInstance().subscribe(m,o,"LTP",Q=>{const ne=Q.data.ltp;ne!=null&&ne>0&&($(A),O(ne))});return()=>{B()}},[m,o]);const G=u.useCallback(S=>{if(S.target.closest("button, input"))return;S.preventDefault(),_.current={startX:S.clientX,startY:S.clientY,origX:V.x,origY:V.y};const B=ne=>{if(!_.current)return;const X=ne.clientX-_.current.startX,re=ne.clientY-_.current.startY;T({x:Math.max(0,_.current.origX+X),y:Math.max(0,_.current.origY+re)})},Q=()=>{_.current=null,document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",Q)};document.addEventListener("mousemove",B),document.addEventListener("mouseup",Q)},[V,T]),H=u.useCallback(async()=>{if(e)return e;try{const B=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(B.status==="success"&&B.api_key)return t(B.api_key),B.api_key}catch(S){console.error("[Scalping] Failed to fetch API key:",S)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),U=u.useCallback(async S=>{if(!m||v){m||console.warn("[Scalping] No symbol selected  click a strike first");return}if(W(!0),y==="TRIGGER"){const X=Object.values(k).find(re=>re.symbol===m&&re.exchange===o&&re.side===r);X&&F(X.id),g(null),h(S),console.log(`[Scalping] TRIGGER armed (${S})  click chart to place trigger line`),W(!1);return}if(y==="LIMIT"&&!N){h(S),console.log(`[Scalping] LIMIT armed (${S})  click chart to set limit line`),W(!1);return}if(b){if(console.log(`[Paper] ${S} ${r} ${m} qty=${l*c} @ ${y}`),y==="MARKET"){const X=await it({symbol:m,exchange:o,preferredPrice:A});if(X>0){const re=C(m);re&&M(re.id),P(Je({symbol:m,exchange:o,side:r,action:S,entryPrice:X,quantity:l*c,tpPoints:x,slPoints:f}))}}w(),W(!1);return}const B=await H();if(!B){W(!1);return}const Q=y==="LIMIT"?"LIMIT":"MARKET",ne={apikey:B,strategy:"Scalping",exchange:o,symbol:m,action:S,quantity:l*c,pricetype:Q,product:p,price:y==="LIMIT"&&N?N:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${S} ${m} qty=${l*c} ${Q}`);const X=await fe.placeOrder(ne);if(X.status==="success"){if(console.log(`[Scalping] Order placed: ${S} ${m} id=${X.data?.orderid}`),h(null),w(),Q==="MARKET"){const re=await it({symbol:m,exchange:o,preferredPrice:A,apiKey:B});if(re>0){const E=C(m);E&&M(E.id),P(Je({symbol:m,exchange:o,side:r,action:S,entryPrice:re,quantity:l*c,tpPoints:x,slPoints:f}))}}}else console.error("[Scalping] Order rejected:",X)}catch(X){console.error("[Scalping] Order failed:",X)}W(!1)},[m,r,l,c,o,p,y,N,x,f,b,C,M,k,v,A,H,w,P,F,g,h]),le=u.useCallback(async()=>{if(!m||v)return;if(W(!0),b){console.log(`[Paper] Reversal ${r} ${m}`),w(),W(!1);return}const S=await H();if(!S){W(!1);return}try{const B={apikey:S,strategy:"Scalping",exchange:o,symbol:m,action:"SELL",quantity:l*c,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0};await fe.placeOrder(B);const Q={apikey:S,strategy:"Scalping",exchange:o,symbol:m,action:"SELL",quantity:l*c,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0};await fe.placeOrder(Q),console.log(`[Scalping] Reversed ${r} ${m}`),w()}catch(B){console.error("[Scalping] Reversal failed:",B)}W(!1)},[m,r,l,c,o,p,b,v,H,w]),J=u.useCallback(async()=>{if(!m)return;if(b){console.log(`[Paper] Close ${r} ${m}`);return}const S=await H();if(S)try{const B={apikey:S,strategy:"Scalping",exchange:o,symbol:m,action:"SELL",quantity:l*c,pricetype:"MARKET",product:p,price:0,trigger_price:0,disclosed_quantity:0},Q=await fe.placeOrder(B);Q.status==="success"?console.log(`[Scalping] Closed ${r} ${m} id=${Q.data?.orderid}`):console.error("[Scalping] Close rejected:",Q)}catch(B){console.error("[Scalping] Close failed:",B)}},[m,r,l,c,o,p,b,H]);if(!n||!m)return null;const se=A&&d?A>d?"up":A<d?"down":"flat":"flat";return s.jsxs("div",{ref:D,onMouseDown:G,className:"absolute z-20 select-none cursor-move rounded-lg border shadow-lg backdrop-blur-sm bg-card/90 border-primary/40",style:{left:V.x,top:V.y,minWidth:220},children:[s.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b border-border/30",children:[s.jsx("span",{className:`text-xs font-bold ${r==="CE"?"text-green-500":"text-red-500"}`,children:r}),s.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate mx-1 max-w-[100px]",children:m.slice(-10)}),s.jsx("span",{className:`text-sm font-bold tabular-nums ${se==="up"?"text-green-500":se==="down"?"text-red-500":"text-foreground"}`,children:A?.toFixed(2)??"--"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1.5",children:[s.jsx(de,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white flex-1",onClick:()=>U("BUY"),disabled:v,children:"BUY"}),s.jsx(de,{size:"sm",className:"h-6 px-2 text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white flex-1",onClick:()=>U("SELL"),disabled:v,children:"SELL"}),s.jsx(de,{size:"sm",variant:"outline",className:"h-6 px-2 text-[10px] font-bold flex-1",onClick:le,disabled:v,children:"REV"})]}),s.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 border-t border-border/30",children:[s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:R,children:"-"}),s.jsx("span",{className:"text-xs font-bold tabular-nums w-4 text-center",children:l}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 text-xs",onClick:K,children:"+"}),s.jsx("div",{className:"flex-1"}),s.jsx("span",{className:"text-[10px] text-green-500",children:"TP:"}),s.jsx("input",{type:"number",value:x,onChange:S=>I(Number.parseFloat(S.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"}),s.jsx("span",{className:"text-[10px] text-red-500",children:"SL:"}),s.jsx("input",{type:"number",value:f,onChange:S=>z(Number.parseFloat(S.target.value)||0),className:"w-10 h-5 text-[10px] text-center bg-transparent border rounded px-0.5"})]}),s.jsx("div",{className:"px-2 py-1 border-t border-border/30",children:s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 w-full text-[10px] text-muted-foreground hover:text-destructive",onClick:J,children:"x Close"})})]})}const Qr=[{label:"30s",sec:30},{label:"1m",sec:60},{label:"3m",sec:180},{label:"5m",sec:300},{label:"15m",sec:900},{label:"30m",sec:1800},{label:"1h",sec:3600}];function Jr({showEma9:e,showEma21:t,showSupertrend:n,showVwap:r,onToggleEma9:i,onToggleEma21:a,onToggleSupertrend:o,onToggleVwap:l}){const c=j(x=>x.chartInterval),p=j(x=>x.setChartInterval);return s.jsxs("div",{className:"flex items-center gap-0.5 px-1 py-0.5 border-b bg-card/50 shrink-0",children:[Qr.map(x=>s.jsx(de,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${c===x.sec?"text-foreground bg-muted":"text-muted-foreground/50"}`,onClick:()=>p(x.sec),children:x.label},x.sec)),s.jsx(ei,{intervalSec:c}),s.jsx("div",{className:"w-px h-3 bg-border/50 mx-0.5"}),s.jsx(Ft,{label:"EMA9",active:e,color:"text-amber-500",onClick:i}),s.jsx(Ft,{label:"EMA21",active:t,color:"text-violet-500",onClick:a}),s.jsx(Ft,{label:"ST",active:n,color:"text-cyan-500",onClick:o}),s.jsx(Ft,{label:"VWAP",active:r,color:"text-pink-500",onClick:l})]})}function ei({intervalSec:e}){const[t,n]=u.useState(()=>Jt(e));u.useEffect(()=>{n(Jt(e));const i=setInterval(()=>{n(Jt(e))},250);return()=>clearInterval(i)},[e]);const r=t<=5;return s.jsx("span",{className:`ml-1 text-[10px] font-mono tabular-nums ${r?"text-orange-400":"text-muted-foreground/70"}`,children:ti(t,e)})}function Jt(e){const t=Date.now()/1e3,r=Math.floor(t/e)*e+e;return Math.max(0,Math.ceil(r-t))}function ti(e,t){if(t>=3600){const n=Math.floor(e/3600),r=Math.floor(e%3600/60),i=e%60;return`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}if(t>=60){const n=Math.floor(e/60),r=e%60;return`${n}:${r.toString().padStart(2,"0")}`}return`${e}s`}function Ft({label:e,active:t,color:n,onClick:r}){return s.jsx(de,{variant:"ghost",size:"sm",className:`h-5 px-1.5 text-[10px] font-medium ${t?n:"text-muted-foreground/50"}`,onClick:r,children:e})}function ni(){const[e,t]=u.useState(!0),[n,r]=u.useState(!0),[i,a]=u.useState(!0),[o,l]=u.useState(!0),c=u.useCallback(()=>t(y=>!y),[]),p=u.useCallback(()=>r(y=>!y),[]),x=u.useCallback(()=>a(y=>!y),[]),f=u.useCallback(()=>l(y=>!y),[]);return s.jsxs("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[s.jsx(Jr,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o,onToggleEma9:c,onToggleEma21:p,onToggleSupertrend:x,onToggleVwap:f}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0 overflow-hidden",children:s.jsxs(tn,{orientation:"vertical",children:[s.jsx(tt,{defaultSize:"40%",minSize:"18%",children:s.jsx(_r,{showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(Vt,{withHandle:!0}),s.jsx(tt,{defaultSize:"60%",minSize:"24%",children:s.jsxs("div",{className:"relative h-full w-full",children:[s.jsxs(tn,{orientation:"horizontal",children:[s.jsx(tt,{defaultSize:"50%",minSize:"20%",children:s.jsx(_n,{side:"CE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})}),s.jsx(Vt,{withHandle:!0}),s.jsx(tt,{defaultSize:"50%",minSize:"20%",children:s.jsx(_n,{side:"PE",showEma9:e,showEma21:n,showSupertrend:i,showVwap:o})})]}),s.jsx(Xr,{})]})})]})})]})}function si(){const e=ge(d=>d.apiKey),t=ge(d=>d.setApiKey),n=j(d=>d.activeSide),r=j(d=>d.selectedCESymbol),i=j(d=>d.selectedPESymbol),a=j(d=>d.optionExchange),o=j(d=>d.quantity),l=j(d=>d.lotSize),c=j(d=>d.product),p=j(d=>d.orderType),x=j(d=>d.tpPoints),f=j(d=>d.slPoints),y=j(d=>d.limitPrice),N=j(d=>d.setLimitPrice),g=j(d=>d.setPendingEntryAction),h=j(d=>d.paperMode),b=Z(d=>d.setVirtualTPSL),P=Z(d=>d.getTPSLForSymbol),C=Z(d=>d.removeVirtualTPSL),M=Z(d=>d.triggerOrders),k=Z(d=>d.removeTriggerOrder),F=j(d=>d.setQuantity),V=j(d=>d.incrementQuantity),T=j(d=>d.decrementQuantity),K=j(d=>d.setOrderType),R=j(d=>d.setProduct),I=j(d=>d.setTpPoints),z=j(d=>d.setSlPoints),w=j(d=>d.incrementTradeCount),m=n==="CE"?r:i,v=u.useCallback(async()=>{if(e)return e;try{const $=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if($.status==="success"&&$.api_key)return t($.api_key),$.api_key}catch(d){console.error("[Scalping] Failed to fetch API key:",d)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[e,t]),W=u.useCallback(async d=>{if(!m){console.warn("[Scalping] No symbol selected  click a strike first");return}if(p==="TRIGGER"){const G=Object.values(M).find(H=>H.symbol===m&&H.exchange===a&&H.side===n);G&&k(G.id),N(null),g(d),console.log(`[Scalping] TRIGGER armed (${d})  click chart to place trigger line`);return}if(p==="LIMIT"&&!y){g(d),console.log(`[Scalping] LIMIT armed (${d})  click chart to set limit line`);return}if(h){if(console.log(`[Paper] ${d} ${n} ${m} qty=${o*l} @ ${p}`),p==="MARKET"){const G=await it({symbol:m,exchange:a});if(G>0){const H=P(m);H&&C(H.id),b(Je({symbol:m,exchange:a,side:n,action:d,entryPrice:G,quantity:o*l,tpPoints:x,slPoints:f}))}}w();return}const $=await v();if(!$)return;const _=p==="LIMIT"?"LIMIT":"MARKET",D={apikey:$,strategy:"Scalping",exchange:a,symbol:m,action:d,quantity:o*l,pricetype:_,product:c,price:p==="LIMIT"&&y?y:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${d} ${m} qty=${o*l} ${_}`);const G=await fe.placeOrder(D);if(G.status==="success"){if(console.log(`[Scalping] Order placed: ${d} ${m} id=${G.data?.orderid}`),g(null),w(),_==="MARKET"){const H=await it({symbol:m,exchange:a,apiKey:$});if(H>0){const U=P(m);U&&C(U.id),b(Je({symbol:m,exchange:a,side:n,action:d,entryPrice:H,quantity:o*l,tpPoints:x,slPoints:f}))}}}else console.error("[Scalping] Order rejected:",G)}catch(G){console.error("[Scalping] Order failed:",G)}},[m,n,o,l,a,c,p,y,x,f,h,P,C,M,v,w,b,k,N,g]),A=u.useCallback(async()=>{if(!m)return;if(h){console.log(`[Paper] Close ${n} ${m}`);return}const d=await v();if(d)try{const $={apikey:d,strategy:"Scalping",exchange:a,symbol:m,action:"SELL",quantity:o*l,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0},_=await fe.placeOrder($);_.status==="success"?console.log(`[Scalping] Closed ${n} ${m} id=${_.data?.orderid}`):console.error("[Scalping] Close rejected:",_)}catch($){console.error("[Scalping] Close failed:",$)}},[m,n,o,l,a,c,h,v]),O=u.useCallback(async()=>{if(h){console.log("[Paper] Close all positions");return}try{await fe.closeAllPositions(),console.log("[Scalping] Closed all positions")}catch(d){console.error("[Scalping] Close all failed:",d)}},[h]);return s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Active Side"}),s.jsxs("div",{className:"text-sm font-bold",children:[s.jsx("span",{className:n==="CE"?"text-green-500":"text-red-500",children:n})," ",s.jsx("span",{className:"text-foreground font-mono text-xs",children:m||"No strike selected"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsx(de,{size:"sm",className:"bg-green-600 hover:bg-green-700 text-white font-bold",onClick:()=>W("BUY"),disabled:!m,children:"BUY"}),s.jsx(de,{size:"sm",className:"bg-red-600 hover:bg-red-700 text-white font-bold",onClick:()=>W("SELL"),disabled:!m,children:"SELL"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Lots"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(de,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:T,children:"-"}),s.jsx(Xe,{type:"number",min:1,value:o,onChange:d=>F(Number.parseInt(d.target.value)||1),className:"h-7 text-center text-sm w-16"}),s.jsx(de,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",onClick:V,children:"+"}),s.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["= ",o*l," qty"]})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Order Type"}),s.jsx("div",{className:"flex gap-1",children:["MARKET","LIMIT","TRIGGER"].map(d=>s.jsx(de,{variant:p===d?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>K(d),children:d},d))})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs",children:"Product"}),s.jsx("div",{className:"flex gap-1",children:["MIS","NRML"].map(d=>s.jsx(de,{variant:c===d?"secondary":"ghost",size:"sm",className:"h-7 text-xs flex-1",onClick:()=>R(d),children:d},d))})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs text-green-500",children:"TP Points"}),s.jsx(Xe,{type:"number",min:0,step:5,value:x,onChange:d=>I(Number.parseFloat(d.target.value)||0),className:"h-7 text-sm"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-xs text-red-500",children:"SL Points"}),s.jsx(Xe,{type:"number",min:0,step:5,value:f,onChange:d=>z(Number.parseFloat(d.target.value)||0),className:"h-7 text-sm"})]})]}),s.jsxs("div",{className:"border-t pt-3 space-y-2",children:[s.jsxs(de,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:A,disabled:!m,children:["Close ",n," Position"]}),s.jsx(de,{variant:"destructive",size:"sm",className:"w-full text-xs",onClick:O,children:"Close All Positions"})]})]})}const qn={entryMomentumCount:5,entryMomentumVelocity:3,entryMinScore:6,entryMaxSpread:5,trailInitialSL:15,trailBreakevenTrigger:10,trailLockTrigger:20,trailLockAmount:10,trailStartTrigger:25,trailStepSize:5,trailTightTrigger:40,trailTightStep:3,breakevenTriggerPts:10,breakevenBuffer:1,maxDailyLoss:5e3,perTradeMaxLoss:500,maxTradesPerDay:20,maxTradesPerMinute:5,minGapMs:4e3,cooldownAfterLossSec:45,coolingOffAfterLosses:3,maxPositionSize:3,imbalanceFilterEnabled:!1,imbalanceThreshold:1.8,telegramAlertsEntry:!1,telegramAlertsExit:!1,telegramAlertsTune:!1,regimeDetectionPeriod:50,rangingThresholdPts:20,indexBiasEnabled:!0,indexBiasWeight:.3,optionsContextEnabled:!0,pcrBullishThreshold:.7,pcrBearishThreshold:1.3,maxPainProximityFilter:50,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,ivSpikeThreshold:5,respectHotZones:!0,sensitivityMultiplier:1,noTradeZoneEnabled:!0,noTradeZoneRangePts:15,noTradeZonePeriod:20,reEntryEnabled:!1,reEntryDelaySec:30,reEntryMaxPerSide:2},As=[{id:"sniper",name:"Sniper Quality",description:"Tight entry, wider SL. For sideways/quiet days.",config:{entryMomentumCount:7,entryMinScore:8,trailInitialSL:20,trailBreakevenTrigger:15,maxTradesPerDay:10,minGapMs:6e3,noTradeZoneRangePts:20}},{id:"momentum",name:"Momentum Scalper",description:"Fast entry, tight SL. For trending days.",config:{entryMomentumCount:3,entryMomentumVelocity:5,entryMinScore:5,trailInitialSL:10,trailBreakevenTrigger:7,trailStepSize:3,maxTradesPerDay:30,noTradeZoneEnabled:!1}},{id:"balanced",name:"Balanced Trader",description:"Default middle ground. Good for most days.",config:{}},{id:"adaptive",name:"Auto-Adaptive",description:"Uses options context + regime detection. Adjusts dynamically.",config:{optionsContextEnabled:!0,indexBiasEnabled:!0,indexBiasWeight:.4,respectHotZones:!0,gexWallFilterEnabled:!0,ivSpikeExitEnabled:!0,reEntryEnabled:!0}},{id:"expiry",name:"Expiry Day",description:"Post-13:30 surprise watch, tighter risk, faster exits.",config:{entryMomentumCount:3,entryMinScore:5,trailInitialSL:8,trailBreakevenTrigger:5,trailStepSize:2,trailTightStep:1,maxDailyLoss:3e3,perTradeMaxLoss:300,maxTradesPerDay:15,maxTradesPerMinute:8,minGapMs:3e3,cooldownAfterLossSec:30,coolingOffAfterLosses:2,sensitivityMultiplier:1.5,noTradeZoneEnabled:!1}}],ri=["CE","PE"];function pt(e=0){return ri.reduce((t,n)=>(t[n]=e,t),{})}const q=rn()(an(e=>({config:{...qn},activePresetId:"balanced",enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:pt(),sideLastExitAt:pt(),sideLossPnl:pt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[],updateConfig:t=>e(n=>({config:{...n.config,...t}})),applyPreset:t=>{const n=As.find(r=>r.id===t);n&&e({config:{...qn,...n.config},activePresetId:t})},setEnabled:t=>e({enabled:t}),setMode:t=>e({mode:t}),setReplayMode:t=>e({replayMode:t}),setKillSwitch:t=>e({killSwitch:t}),setLockProfitEnabled:t=>e(n=>({lockProfitEnabled:t,lockProfitTriggered:t?n.lockProfitTriggered:!1})),updateRiskState:t=>e(n=>{const r=Math.max(n.dailyPeakPnl,t),i=Math.max(0,r-t),a=n.lockProfitEnabled&&r>0?n.lockProfitTriggered||i>=r*.4:n.lockProfitTriggered,o=t<0&&Math.abs(t)>=n.config.maxDailyLoss;return{dailyPeakPnl:r,dailyDrawdown:i,lockProfitTriggered:a,killSwitch:n.killSwitch||o||a}}),setRegime:t=>e({regime:t}),setTrailStage:t=>e({trailStage:t}),setHighSinceEntry:t=>e({highSinceEntry:t}),setOptionsContext:t=>e({optionsContext:t}),recordTrade:t=>e(n=>{const r=Date.now(),i=r-n.lastMinuteReset>6e4?r:n.lastMinuteReset,a=r-n.lastMinuteReset>6e4?1:n.tradesThisMinute+1,o=n.realizedPnl+t,l=Math.max(n.dailyPeakPnl,o),c=Math.max(0,l-o);return{realizedPnl:o,lastTradePnl:t,tradesCount:n.tradesCount+1,consecutiveLosses:t<0?n.consecutiveLosses+1:n.consecutiveLosses,lastTradeTime:r,tradesThisMinute:a,lastMinuteReset:i,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:l,dailyDrawdown:c}}),recordTradeOutcome:t=>e(n=>{const r=Date.now(),i=n.realizedPnl+t,a=Math.max(n.dailyPeakPnl,i),o=Math.max(0,a-i),l=n.lockProfitEnabled&&a>0?n.lockProfitTriggered||o>=a*.4:n.lockProfitTriggered;return{realizedPnl:i,lastTradePnl:t,consecutiveLosses:t<0?n.consecutiveLosses+1:0,lastLossTime:t<0?r:n.lastLossTime,dailyPeakPnl:a,dailyDrawdown:o,lockProfitTriggered:l,killSwitch:n.killSwitch||l}}),recordAutoEntry:t=>e(n=>({sideEntryCount:{...n.sideEntryCount,[t]:n.sideEntryCount[t]+1}})),recordAutoExit:(t,n)=>e(r=>({sideLastExitAt:{...r.sideLastExitAt,[t]:Date.now()},sideLossPnl:{...r.sideLossPnl,[t]:n<0?r.sideLossPnl[t]+Math.abs(n):r.sideLossPnl[t]}})),pushDecision:t=>e(n=>({decisionHistory:[...n.decisionHistory.slice(-119),t],lastDecisionBySide:{...n.lastDecisionBySide,[t.side]:t}})),pushExecutionSample:t=>e(n=>({executionSamples:[...n.executionSamples.slice(-59),t]})),addGhostSignal:t=>e(n=>({ghostSignals:[...n.ghostSignals.slice(-49),t]})),clearGhostSignals:()=>e({ghostSignals:[]}),resetRuntime:()=>e({enabled:!1,mode:"ghost",replayMode:!1,realizedPnl:0,lastTradePnl:null,regime:"UNKNOWN",consecutiveLosses:0,tradesCount:0,trailStage:"INITIAL",highSinceEntry:0,ghostSignals:[],optionsContext:null,lastTradeTime:0,tradesThisMinute:0,lastMinuteReset:0,lastLossTime:0,sideEntryCount:pt(),sideLastExitAt:pt(),sideLossPnl:pt(),killSwitch:!1,lockProfitEnabled:!1,lockProfitTriggered:!1,dailyPeakPnl:0,dailyDrawdown:0,decisionHistory:[],lastDecisionBySide:{},executionSamples:[]})}),{name:"openalgo-scalping-autotrade",partialize:e=>({config:e.config,activePresetId:e.activePresetId})})),ii=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Opening Momentum",start:"09:15",end:"09:30",sensitivity:1.5},{label:"Morning Session",start:"09:30",end:"11:30",sensitivity:1},{label:"Quiet Zone",start:"11:30",end:"12:30",sensitivity:.5},{label:"Afternoon Action",start:"12:30",end:"13:00",sensitivity:1.2},{label:"Afternoon",start:"13:00",end:"14:00",sensitivity:.8},{label:"Closing Rally",start:"14:00",end:"15:00",sensitivity:1.3},{label:"Final Push",start:"15:00",end:"15:30",sensitivity:1.5}],ai=[{label:"Pre-Open",start:"09:00",end:"09:15",sensitivity:0},{label:"Expiry Open",start:"09:15",end:"09:30",sensitivity:1.8},{label:"Morning Expiry",start:"09:30",end:"11:30",sensitivity:1.2},{label:"Expiry Quiet",start:"11:30",end:"13:00",sensitivity:.6},{label:"Surprise Zone",start:"13:00",end:"14:00",sensitivity:1.5},{label:"Panic Zone",start:"14:00",end:"15:00",sensitivity:2},{label:"Expiry Close",start:"15:00",end:"15:30",sensitivity:2}];function nn(e){const[t,n]=e.split(":").map(Number);return t*60+n}function xn(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return{hours:n.getUTCHours(),minutes:n.getUTCMinutes()}}function Os(e){return e?ai:ii}function sn(e=new Date,t=!1){const{hours:n,minutes:r}=xn(e),i=n*60+r,a=Os(t);for(const o of a){const l=nn(o.start),c=nn(o.end);if(i>=l&&i<c)return{zone:o,sensitivity:o.sensitivity}}return{zone:null,sensitivity:0}}function Kn(e=new Date,t=!1){const{hours:n,minutes:r}=xn(e),i=n*60+r,a=Os(t);for(const o of a){const l=nn(o.start);if(l>i)return{nextZone:o,minutesUntil:l-i}}return{nextZone:null,minutesUntil:0}}function Wn(e,t=new Date){if(!e)return!1;try{const n=new Date(e),r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+5.5*60*60*1e3);return n.getFullYear()===i.getUTCFullYear()&&n.getMonth()===i.getUTCMonth()&&n.getDate()===i.getUTCDate()}catch{return!1}}function Un(e=new Date){const{hours:t,minutes:n}=xn(e),r=t*60+n;return r>=555&&r<930}function Hn(e=new Date){const t=e.getTime()+e.getTimezoneOffset()*6e4,n=new Date(t+5.5*60*60*1e3);return`${n.getUTCHours().toString().padStart(2,"0")}:${n.getUTCMinutes().toString().padStart(2,"0")}:${n.getUTCSeconds().toString().padStart(2,"0")}`}function Is(){const e=j(r=>r.expiry),[t,n]=u.useState(()=>{const r=new Date,i=Wn(e,r),{zone:a,sensitivity:o}=sn(r,i),{nextZone:l,minutesUntil:c}=Kn(r,i);return{currentTime:Hn(r),currentZone:a,sensitivity:o,nextZone:l,minutesToNext:c,isExpiryDay:i,isOpen:Un(r)}});return u.useEffect(()=>{const i=setInterval(()=>{const a=new Date,o=Wn(e,a),{zone:l,sensitivity:c}=sn(a,o),{nextZone:p,minutesUntil:x}=Kn(a,o);n({currentTime:Hn(a),currentZone:l,sensitivity:c,nextZone:p,minutesToNext:x,isExpiryDay:o,isOpen:Un(a)})},1e3);return()=>clearInterval(i)},[e]),t}function oi(){const e=q(r=>r.activePresetId),t=q(r=>r.applyPreset),{isExpiryDay:n}=Is();return s.jsx("div",{className:"space-y-1.5",children:As.map(r=>{const i=e===r.id,a=r.id==="expiry";return s.jsxs("button",{type:"button",onClick:()=>t(r.id),className:`w-full text-left p-2 rounded border transition-colors ${i?"border-primary bg-primary/10":"border-border hover:border-primary/40 hover:bg-accent/30"}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs font-medium",children:r.name}),s.jsxs("div",{className:"flex items-center gap-1",children:[a&&n&&s.jsx(ve,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"SUGGESTED"}),i&&s.jsx(ve,{variant:"default",className:"text-[9px] h-3.5 px-1",children:"ACTIVE"})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-0.5",children:r.description})]},r.id)})})}function te({label:e,field:t,step:n}){const r=q(a=>a.config[t]),i=q(a=>a.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Fe,{className:"text-[10px] text-muted-foreground shrink-0",children:e}),s.jsx(Xe,{type:"number",value:r,step:n??1,onChange:a=>i({[t]:Number(a.target.value)||0}),className:"h-5 w-16 text-[10px] text-right"})]})}function Ve({label:e,field:t}){const n=q(i=>i.config[t]),r=q(i=>i.updateConfig);return s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsx(Fe,{className:"text-[10px] text-muted-foreground",children:e}),s.jsx(bt,{checked:n,onCheckedChange:i=>r({[t]:i}),className:"h-4 w-7"})]})}function Oe({title:e,children:t}){return s.jsxs("details",{className:"group",children:[s.jsx("summary",{className:"cursor-pointer text-[10px] font-medium uppercase text-muted-foreground hover:text-foreground py-1 border-b",children:e}),s.jsx("div",{className:"py-1.5 space-y-1",children:t})]})}function li(){return s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs(Oe,{title:"Entry Conditions",children:[s.jsx(te,{label:"Momentum Count",field:"entryMomentumCount"}),s.jsx(te,{label:"Momentum Velocity",field:"entryMomentumVelocity"}),s.jsx(te,{label:"Min Score",field:"entryMinScore"}),s.jsx(te,{label:"Max Spread",field:"entryMaxSpread"})]}),s.jsxs(Oe,{title:"Trailing SL (5-Stage)",children:[s.jsx(te,{label:"Initial SL (pts)",field:"trailInitialSL"}),s.jsx(te,{label:"Breakeven Trigger",field:"trailBreakevenTrigger"}),s.jsx(te,{label:"Lock Trigger",field:"trailLockTrigger"}),s.jsx(te,{label:"Lock Amount",field:"trailLockAmount"}),s.jsx(te,{label:"Trail Start",field:"trailStartTrigger"}),s.jsx(te,{label:"Trail Step",field:"trailStepSize"}),s.jsx(te,{label:"Tight Trigger",field:"trailTightTrigger"}),s.jsx(te,{label:"Tight Step",field:"trailTightStep"})]}),s.jsxs(Oe,{title:"Breakeven",children:[s.jsx(te,{label:"Trigger (pts)",field:"breakevenTriggerPts"}),s.jsx(te,{label:"Buffer",field:"breakevenBuffer",step:.5})]}),s.jsxs(Oe,{title:"Risk",children:[s.jsx(te,{label:"Max Daily Loss",field:"maxDailyLoss"}),s.jsx(te,{label:"Per-Trade Max Loss",field:"perTradeMaxLoss"}),s.jsx(te,{label:"Max Trades/Day",field:"maxTradesPerDay"}),s.jsx(te,{label:"Max Trades/Min",field:"maxTradesPerMinute"}),s.jsx(te,{label:"Min Gap (ms)",field:"minGapMs",step:500}),s.jsx(te,{label:"Cooldown After Loss (s)",field:"cooldownAfterLossSec"}),s.jsx(te,{label:"Cool Off After Losses",field:"coolingOffAfterLosses"}),s.jsx(te,{label:"Max Position Size",field:"maxPositionSize"})]}),s.jsxs(Oe,{title:"Imbalance Filter",children:[s.jsx(Ve,{label:"Enabled",field:"imbalanceFilterEnabled"}),s.jsx(te,{label:"Threshold Ratio",field:"imbalanceThreshold",step:.1})]}),s.jsxs(Oe,{title:"Regime Detection",children:[s.jsx(te,{label:"Detection Period",field:"regimeDetectionPeriod"}),s.jsx(te,{label:"Ranging Threshold (pts)",field:"rangingThresholdPts"})]}),s.jsxs(Oe,{title:"Index Bias",children:[s.jsx(Ve,{label:"Enabled",field:"indexBiasEnabled"}),s.jsx(te,{label:"Weight",field:"indexBiasWeight",step:.1})]}),s.jsxs(Oe,{title:"Options Context",children:[s.jsx(Ve,{label:"Enabled",field:"optionsContextEnabled"}),s.jsx(te,{label:"PCR Bullish ",field:"pcrBullishThreshold",step:.1}),s.jsx(te,{label:"PCR Bearish ",field:"pcrBearishThreshold",step:.1}),s.jsx(te,{label:"Max Pain Proximity",field:"maxPainProximityFilter"}),s.jsx(Ve,{label:"GEX Wall Filter",field:"gexWallFilterEnabled"}),s.jsx(Ve,{label:"IV Spike Exit",field:"ivSpikeExitEnabled"}),s.jsx(te,{label:"IV Spike Threshold %",field:"ivSpikeThreshold"})]}),s.jsxs(Oe,{title:"Time-of-Day",children:[s.jsx(Ve,{label:"Respect Hot Zones",field:"respectHotZones"}),s.jsx(te,{label:"Sensitivity Multiplier",field:"sensitivityMultiplier",step:.1})]}),s.jsxs(Oe,{title:"No-Trade Zone",children:[s.jsx(Ve,{label:"Enabled",field:"noTradeZoneEnabled"}),s.jsx(te,{label:"Range (pts)",field:"noTradeZoneRangePts"}),s.jsx(te,{label:"Period",field:"noTradeZonePeriod"})]}),s.jsxs(Oe,{title:"Re-Entry",children:[s.jsx(Ve,{label:"Enabled",field:"reEntryEnabled"}),s.jsx(te,{label:"Delay (sec)",field:"reEntryDelaySec"}),s.jsx(te,{label:"Max Per Side",field:"reEntryMaxPerSide"})]}),s.jsxs(Oe,{title:"Telegram Alerts",children:[s.jsx(Ve,{label:"Entry Alerts",field:"telegramAlertsEntry"}),s.jsx(Ve,{label:"Exit Alerts",field:"telegramAlertsExit"}),s.jsx(Ve,{label:"Tune Alerts",field:"telegramAlertsTune"})]})]})}function ci(){const e=q(r=>r.ghostSignals),t=q(r=>r.clearGhostSignals);if(e.length===0)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"No ghost signals yet. Engine is analyzing..."});const n=e.slice(-10).reverse();return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground",children:["Ghost Signals (",e.length,")"]}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-4 text-[9px] px-1",onClick:t,children:"Clear"})]}),n.map(r=>s.jsx(di,{signal:r},r.id))]})}function di({signal:e}){const t=ge(f=>f.apiKey),n=j(f=>f.optionExchange),r=j(f=>f.quantity),i=j(f=>f.lotSize),a=j(f=>f.product),o=j(f=>f.paperMode),l=j(f=>f.incrementTradeCount),c=u.useCallback(async()=>{if(o){console.log(`[Ghost Take] ${e.action} ${e.side} ${e.symbol}`),l();return}if(!t)return;const f={apikey:t,strategy:"Scalping-Ghost",exchange:n,symbol:e.symbol,action:e.action,quantity:r*i,pricetype:"MARKET",product:a};try{const y=await fe.placeOrder(f);y.status==="success"&&(console.log(`[Ghost Take] ${e.action} ${e.symbol} id=${y.data?.orderid}`),l())}catch(y){console.error("[Ghost Take] Failed:",y)}},[e,t,n,r,i,a,o,l]),p=Math.round((Date.now()-e.timestamp)/1e3),x=p<60?`${p}s ago`:`${Math.round(p/60)}m ago`;return s.jsxs("div",{className:"p-1.5 rounded border border-border/50 bg-muted/30 space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(ve,{variant:e.side==="CE"?"default":"destructive",className:"text-[9px] h-3.5 px-1",children:e.side}),s.jsx("span",{className:"text-[10px] font-mono",children:e.symbol.slice(-10)})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-[9px] text-muted-foreground",children:x}),s.jsxs(ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:[e.score,"/10"]})]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground",children:e.reason}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-muted-foreground",children:[e.regime&&s.jsxs("span",{children:["Regime: ",e.regime]}),e.pcr!==void 0&&s.jsxs("span",{children:["PCR: ",e.pcr.toFixed(2)]})]}),s.jsx(de,{size:"sm",variant:"outline",className:"h-5 text-[9px] px-1.5",onClick:c,children:"Take Trade"})]})]})}function ui(){const e=q(r=>r.optionsContext);if(!e)return s.jsx("div",{className:"text-center text-[10px] text-muted-foreground py-2",children:"Options context loading..."});const t=Math.round((Date.now()-e.lastUpdated)/1e3),n=t<60?`${t}s`:`${Math.round(t/60)}m`;return s.jsxs("div",{className:"space-y-1.5 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Options Context"}),s.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Updated ",n," ago"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PCR"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden relative",children:[s.jsx("div",{className:`absolute top-0 h-full rounded ${e.pcr>1?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(100,e.pcr/2*100)}%`}}),s.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-foreground/30"})]}),s.jsx("span",{className:`font-bold tabular-nums ${e.pcr>1.2?"text-red-500":e.pcr<.8?"text-green-500":"text-foreground"}`,children:e.pcr.toFixed(2)})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Max Pain"}),s.jsxs("span",{className:"font-mono tabular-nums",children:[e.maxPainStrike.toFixed(0)," ",s.jsxs("span",{className:`text-[10px] ${e.spotVsMaxPain>0?"text-green-500":"text-red-500"}`,children:["(",e.spotVsMaxPain>0?"+":"",e.spotVsMaxPain.toFixed(0),")"]})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Net GEX"}),s.jsxs("span",{className:`font-bold tabular-nums ${e.netGEX>50?"text-green-500":e.netGEX<-50?"text-red-500":"text-foreground"}`,children:[e.netGEX>0?"+":"",e.netGEX.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"ATM IV"}),s.jsxs("span",{className:"font-bold tabular-nums",children:[e.atmIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV Skew"}),s.jsxs("span",{className:`tabular-nums ${e.ivSkew>2?"text-green-500":e.ivSkew<-2?"text-red-500":"text-foreground"}`,children:[e.ivSkew>0?"+":"",e.ivSkew.toFixed(1)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["CE IV: ",e.ceIV.toFixed(1),"%"]}),s.jsxs("span",{className:"text-red-500",children:["PE IV: ",e.peIV.toFixed(1),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Straddle"}),s.jsx("span",{className:"font-mono tabular-nums",children:e.straddlePrice.toFixed(1)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"IV %ile"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${e.ivPercentile>70?"bg-red-500":e.ivPercentile>30?"bg-yellow-500":"bg-green-500"}`,style:{width:`${e.ivPercentile}%`}})}),s.jsx("span",{className:"tabular-nums",children:e.ivPercentile.toFixed(0)})]})]}),e.topGammaStrikes.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Top Gamma:"}),s.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5",children:e.topGammaStrikes.slice(0,5).map(r=>s.jsx(ve,{variant:"outline",className:"text-[9px] h-3.5 px-1 font-mono",children:r},r))})]})]})}const hn={getBotStatus:async()=>(await De.get("/telegram/bot/status")).data.data,startBot:async()=>(await De.post("/telegram/bot/start")).data,stopBot:async()=>(await De.post("/telegram/bot/stop")).data,getConfig:async()=>(await De.get("/telegram/api/config")).data.data,updateConfig:async e=>(await De.post("/telegram/config",e)).data,getUsers:async()=>(await De.get("/telegram/api/users")).data.data,unlinkUser:async e=>(await De.post(`/telegram/user/${e}/unlink`)).data,getAnalytics:async()=>(await De.get("/telegram/api/analytics")).data.data,sendTestMessage:async()=>(await De.post("/telegram/test-message")).data,sendBroadcast:async e=>(await De.post("/telegram/broadcast",e)).data,sendMessage:async(e,t)=>(await De.post("/telegram/send-message",{telegram_id:e,message:t})).data};function pi(){const[e,t]=u.useState(!1),[n,r]=u.useState(null),[i,a]=u.useState(null),[o,l]=u.useState(null),c=q(g=>g.updateConfig),p=q(g=>g.config),x=j(g=>g.underlying),f=u.useCallback(async()=>{try{const g=await Vs();r(g.provider||"none"),g.last_run&&a(g.last_run),l(null)}catch{l("Could not reach advisor")}},[]),y=u.useCallback(async()=>{t(!0),l(null);try{const g=await Bs({underlying:x});if(g.status==="success"&&g.run_id){const h=await _s(1);h.runs?.length>0&&a(h.runs[0])}else l(g.message||"Tuning failed")}catch{l("Advisor request failed")}finally{t(!1)}},[x]),N=u.useCallback(async()=>{if(i?.run_id){t(!0);try{await Gs(i.run_id);const g=i.recommendations;if(g&&typeof g=="object"){const h={};for(const[b,P]of Object.entries(g)){if(!(b in p))continue;const C=b,M=p[C];if(typeof M=="number"){const k=typeof P=="number"?P:Number(P);Number.isFinite(k)&&(h[C]=k);continue}if(typeof M=="boolean"){let k=null;if(typeof P=="boolean")k=P;else if(typeof P=="number")k=P!==0;else if(typeof P=="string"){const F=P.trim().toLowerCase();["true","1","yes","on","enabled"].includes(F)&&(k=!0),["false","0","no","off","disabled"].includes(F)&&(k=!1)}k!=null&&(h[C]=k)}}if(Object.keys(h).length>0&&(c(h),p.telegramAlertsTune)){const b=Object.keys(h).join(", ");hn.sendBroadcast({message:`[AUTO TUNE] Applied recommendations for ${x}: ${b}`}).catch(()=>{})}}a(h=>h&&{...h,applied:!0}),l(null)}catch{l("Failed to apply recommendation")}finally{t(!1)}}},[i,c,p,x]);return s.jsxs("div",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"LLM Advisor"}),n&&s.jsx(ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:n})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(de,{variant:"outline",size:"sm",className:"h-5 text-[9px] flex-1",onClick:f,disabled:e,children:"Check Status"}),s.jsx(de,{variant:"secondary",size:"sm",className:"h-5 text-[9px] flex-1",onClick:y,disabled:e,children:e?"Running...":"Tune Config"})]}),o&&s.jsx("div",{className:"text-[9px] text-red-500 px-1",children:o}),i&&s.jsxs("div",{className:"p-1.5 bg-muted/50 rounded text-[9px] space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Score"}),s.jsx("span",{className:"font-bold",children:i.score?.toFixed(1)??""})]}),i.notes&&s.jsx("p",{className:"text-muted-foreground leading-tight",children:i.notes}),Object.keys(i.recommendations||{}).length>0&&s.jsxs("div",{className:"space-y-0.5",children:[s.jsx("span",{className:"text-muted-foreground",children:"Changes:"}),Object.entries(i.recommendations).map(([g,h])=>s.jsxs("div",{className:"flex justify-between pl-1",children:[s.jsx("span",{className:"text-muted-foreground",children:g}),s.jsx("span",{className:"font-mono",children:typeof h=="number"?h:String(h)})]},g))]}),!i.applied&&Object.keys(i.recommendations||{}).length>0&&s.jsx(de,{variant:"default",size:"sm",className:"h-5 text-[9px] w-full",onClick:N,disabled:e,children:"Apply Recommendation"}),i.applied&&s.jsx(ve,{variant:"default",className:"text-[9px] h-3.5",children:"Applied"})]})]})}function fi(e){return e==="TRENDING"?"Trend Breakout":e==="RANGING"?"Mean Reversion":e==="VOLATILE"?"Vol Expansion":"Standby / No-Trade"}function mi(){const e=q(d=>d.enabled),t=q(d=>d.mode),n=q(d=>d.replayMode),r=q(d=>d.regime),i=q(d=>d.tradesCount),a=q(d=>d.realizedPnl),o=q(d=>d.consecutiveLosses),l=q(d=>d.killSwitch),c=q(d=>d.lockProfitEnabled),p=q(d=>d.lockProfitTriggered),x=q(d=>d.dailyPeakPnl),f=q(d=>d.dailyDrawdown),y=q(d=>d.sideEntryCount),N=q(d=>d.sideLastExitAt),g=q(d=>d.sideLossPnl),h=q(d=>d.lastDecisionBySide),b=q(d=>d.decisionHistory),P=q(d=>d.executionSamples),C=q(d=>d.config),M=q(d=>d.setEnabled),k=q(d=>d.setMode),F=q(d=>d.setReplayMode),V=q(d=>d.setKillSwitch),T=q(d=>d.setLockProfitEnabled),K=q(d=>d.resetRuntime),R=j(d=>d.activeSide),I=j(d=>d.paperMode),z=Z(d=>d.virtualTPSL),w=u.useMemo(()=>h[R]??b[b.length-1]??null,[R,b,h]),m=u.useMemo(()=>w?Math.max(0,Math.min(99,Math.round(w.score/Math.max(1,w.minScore)*100))):r==="UNKNOWN"?0:55,[w,r]),v=u.useMemo(()=>Object.values(z).reduce((d,$)=>(d[$.side]+=$.quantity,d),{CE:0,PE:0}),[z]),W=u.useMemo(()=>{const d=P.slice(-10),$=d.filter(U=>U.status==="filled"),_=d.filter(U=>U.status==="rejected"),D=$.length>0?$.reduce((U,le)=>U+le.spread,0)/$.length:0,G=$.length>0?$.reduce((U,le)=>U+le.expectedSlippage,0)/$.length:0,H=d.length>0?_.length/d.length*100:0;return{recent:d.slice().reverse(),avgSpread:D,avgSlippage:G,rejectRate:H}},[P]),A=w?w.spread<=C.entryMaxSpread*.4?"TIGHT":w.spread<=C.entryMaxSpread?"NORMAL":"WIDE":"NA",O=N[R]>0?Math.max(0,Math.round((Date.now()-N[R])/1e3)):null;return s.jsxs("div",{className:"p-2 space-y-3 text-xs overflow-y-auto",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Fe,{className:"text-xs font-medium",children:"Auto-Trade"}),s.jsx(bt,{checked:e,onCheckedChange:M,className:"h-5 w-9"})]}),s.jsx(ve,{variant:e?t==="execute"?"default":"secondary":"outline",className:"text-[10px] h-4",children:e?t==="execute"?"EXECUTING":"GHOST":"OFF"})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(de,{variant:t==="ghost"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>k("ghost"),children:"Ghost (Signals Only)"}),s.jsx(de,{variant:t==="execute"?"secondary":"ghost",size:"sm",className:"h-6 text-[10px] flex-1",onClick:()=>k("execute"),children:"Execute (Live)"})]}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:"Replay / Simulator"}),s.jsx(bt,{checked:n,onCheckedChange:F,className:"h-4 w-8"})]}),s.jsx("p",{className:"text-[9px] text-muted-foreground",children:"When enabled, execute mode is blocked and engine runs as simulation-only diagnostics."})]}),t==="execute"&&!I&&!n&&s.jsx("div",{className:"p-1 bg-red-500/10 border border-red-500/30 rounded text-red-500 text-[10px] text-center font-medium",children:"LIVE EXECUTION MODE - Real orders will be placed"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Status"}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Regime"}),s.jsx(ve,{variant:"outline",className:"text-[9px] h-3.5 px-1",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades"}),s.jsx("span",{className:"font-bold",children:i})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Consec. Losses"}),s.jsx("span",{className:`font-bold ${o>=3?"text-red-500":""}`,children:o})]})]}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 text-[9px] w-full",onClick:K,children:"Reset Runtime"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Why Trade?"}),w?s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:[w.side," ",w.symbol.slice(-12)]}),s.jsxs("span",{className:`font-bold ${w.enter?"text-green-500":"text-red-500"}`,children:[w.score.toFixed(1)," / ",w.minScore.toFixed(1)]})]}),s.jsx("p",{className:"text-[10px] text-muted-foreground leading-tight",children:w.reason}),s.jsx("div",{className:"space-y-0.5",children:w.checks.slice(0,8).map(d=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-[10px] text-muted-foreground",children:d.label}),s.jsxs("span",{className:`text-[10px] font-medium ${d.pass?"text-green-500":"text-red-500"}`,children:[d.pass?"PASS":"FAIL",d.value?` (${d.value})`:""]})]},d.id))})]}):s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Waiting for first decision snapshot..."})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Regime Router"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Playbook"}),s.jsx("span",{className:"font-medium",children:fi(r)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Confidence"}),s.jsxs("span",{className:"font-bold",children:[m,"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Block Reason"}),s.jsx("span",{className:"text-[10px] text-right max-w-[70%] truncate",children:w&&!w.enter?w.reason:"None"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-muted-foreground",children:["Last Exit (",R,")"]}),s.jsx("span",{className:"font-mono text-[10px]",children:O==null?"":`${O}s ago`})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Execution"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread State"}),s.jsx("span",{className:`font-medium ${A==="WIDE"?"text-red-500":A==="TIGHT"?"text-green-500":""}`,children:A})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Expected Slippage"}),s.jsx("span",{className:"font-mono",children:(w?.expectedSlippage??0).toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Depth Ratio"}),s.jsx("span",{className:"font-mono",children:w?.depthRatio!=null?w.depthRatio.toFixed(2):"NA"})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Spread"}),s.jsx("span",{className:"font-mono",children:W.avgSpread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Last 10 Avg Slip"}),s.jsx("span",{className:"font-mono",children:W.avgSlippage.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Reject Rate"}),s.jsxs("span",{className:`font-mono ${W.rejectRate>30?"text-red-500":""}`,children:[W.rejectRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"space-y-0.5 pt-1 border-t",children:[W.recent.slice(0,5).map(d=>s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-muted-foreground truncate max-w-[65%]",children:[d.side," ",d.symbol.slice(-10)]}),s.jsx("span",{className:d.status==="rejected"?"text-red-500":d.status==="filled"?"text-green-500":"text-muted-foreground",children:d.status})]},`${d.timestamp}-${d.symbol}`)),W.recent.length===0&&s.jsx("div",{className:"text-[10px] text-muted-foreground",children:"No execution samples yet."})]})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Risk Cockpit"}),s.jsxs("div",{className:"rounded border border-border/60 p-1.5 space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Kill Switch"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[l&&s.jsx(ve,{variant:"destructive",className:"text-[9px] h-3.5 px-1",children:"ON"}),s.jsx(bt,{checked:l,onCheckedChange:V,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Lock-Profit"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[p&&s.jsx(ve,{variant:"secondary",className:"text-[9px] h-3.5 px-1",children:"TRIGGERED"}),s.jsx(bt,{checked:c,onCheckedChange:T,className:"h-4 w-8"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Peak P&L"}),s.jsx("span",{className:"font-mono",children:x.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Drawdown"}),s.jsx("span",{className:`font-mono ${f>0?"text-red-500":""}`,children:f.toFixed(0)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure CE"}),s.jsx("span",{className:"font-mono",children:v.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Exposure PE"}),s.jsx("span",{className:"font-mono",children:v.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Entries"}),s.jsx("span",{className:"font-mono",children:y.CE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Entries"}),s.jsx("span",{className:"font-mono",children:y.PE})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"CE Loss"}),s.jsxs("span",{className:"font-mono text-red-500",children:["-",g.CE.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"PE Loss"}),s.jsxs("span",{className:"font-mono text-red-500",children:["-",g.PE.toFixed(0)]})]})]})]})]}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(ui,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(ci,{})}),s.jsx("section",{className:"border-t pt-2",children:s.jsx(pi,{})}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Presets"}),s.jsx(oi,{})]}),s.jsxs("section",{className:"border-t pt-2",children:[s.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase block mb-1",children:"Configuration"}),s.jsx(li,{})]})]})}function xi(){const e=ge(f=>f.apiKey),t=j(f=>f.optionExchange),n=Z(f=>f.virtualTPSL),r=Z(f=>f.triggerOrders),i=Z(f=>f.removeVirtualTPSL),a=Z(f=>f.removeTriggerOrder),o=Z(f=>f.clearAll),{data:l}=as({queryKey:["scalping-orders",t],queryFn:()=>fe.getOrders(e),enabled:!!e,refetchInterval:5e3}),c=(l?.data?.orders??[]).filter(f=>f.exchange===t&&(f.order_status==="open"||f.order_status==="pending"||f.order_status==="trigger pending")),p=Object.values(n),x=Object.values(r);return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Broker Orders"}),s.jsx(ve,{variant:"outline",className:"text-[10px] h-4",children:c.length})]}),c.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No open broker orders"}):s.jsx("div",{className:"space-y-1",children:c.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)})," ",s.jsxs("span",{className:"text-muted-foreground",children:["x",f.quantity]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(ve,{variant:"outline",className:"text-[10px] h-4",children:f.order_status}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:async()=>{try{await fe.cancelOrder(f.orderid)}catch(y){console.error("Cancel failed:",y)}},children:"Cancel"})]})]},f.orderid))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Virtual TP/SL"}),s.jsx(ve,{variant:"outline",className:"text-[10px] h-4",children:p.length})]}),p.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No virtual TP/SL orders"}):s.jsx("div",{className:"space-y-1",children:p.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.side==="CE"?"text-green-500":"text-red-500",children:f.side})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Entry: ",f.entryPrice.toFixed(1)," |"," ",f.tpPrice!==null&&s.jsxs("span",{className:"text-green-500",children:["TP: ",f.tpPrice.toFixed(1)]})," ",f.slPrice!==null&&s.jsxs("span",{className:"text-red-500",children:["SL: ",f.slPrice.toFixed(1)]})]})]}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>i(f.id),children:"Remove"})]},f.id))})]}),s.jsxs("section",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Trigger Orders"}),s.jsx(ve,{variant:"outline",className:"text-[10px] h-4",children:x.length})]}),x.length===0?s.jsx("p",{className:"text-muted-foreground",children:"No trigger orders"}):s.jsx("div",{className:"space-y-1",children:x.map(f=>s.jsxs("div",{className:"flex items-center justify-between p-1.5 rounded bg-muted/50",children:[s.jsxs("div",{children:[s.jsx("span",{className:f.action==="BUY"?"text-green-500":"text-red-500",children:f.action})," ",s.jsx("span",{className:"font-mono",children:f.symbol.slice(-10)}),s.jsxs("div",{className:"text-muted-foreground",children:["Trigger: ",f.triggerPrice.toFixed(1)," (",f.direction,") | x",f.quantity]})]}),s.jsx(de,{variant:"ghost",size:"sm",className:"h-5 px-1 text-[10px] text-destructive",onClick:()=>a(f.id),children:"Remove"})]},f.id))})]}),(p.length>0||x.length>0)&&s.jsx(de,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:o,children:"Clear All Virtual Orders"})]})}function hi(e,t){const n=ge(x=>x.apiKey),[r,i]=u.useState(null),[a,o]=u.useState(!1),l=u.useRef(null),c=u.useCallback(async()=>{if(!(!e||!n)){try{const x=await fe.getDepth(n,e,t);x.status==="success"&&x.data&&i(x.data)}catch{}o(!1)}},[e,t,n]);u.useEffect(()=>{if(!e){i(null);return}return o(!0),c(),l.current=setInterval(c,2e3),()=>{l.current&&clearInterval(l.current)}},[e,c]);const p=r?gi(r):null;return{depth:r,analytics:p,levels:5,isLoading:a}}function gi(e){const t=e.bids||[],n=e.asks||[],r=t.reduce((N,g)=>N+g.quantity,0),i=n.reduce((N,g)=>N+g.quantity,0),a=i>0?r/i:r>0?999:1,o=n.length>0&&t.length>0?n[0].price-t[0].price:0,l=t.length>0?t.reduce((N,g)=>g.quantity>N.quantity?g:N,t[0]):null,c=l?{price:l.price,qty:l.quantity}:null,p=n.length>0?n.reduce((N,g)=>g.quantity>N.quantity?g:N,n[0]):null,x=p?{price:p.price,qty:p.quantity}:null,f=r+i,y=f>0?(r-i)/f*100:0;return{totalBidQty:r,totalAskQty:i,bidAskRatio:a,spread:o,largestBidWall:c,largestAskWall:x,imbalanceScore:y}}function yi(){const e=j(l=>l.activeSide),t=j(l=>l.optionExchange),n=j(l=>l.activeSide==="CE"?l.selectedCESymbol:l.selectedPESymbol),{depth:r,analytics:i,levels:a,isLoading:o}=hi(n,t);return n?s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("span",{className:e==="CE"?"text-green-500 font-bold":"text-red-500 font-bold",children:e}),s.jsx("span",{className:"font-mono text-muted-foreground",children:n.slice(-10)})]}),s.jsxs(ve,{variant:"outline",className:"text-[10px] h-4",children:[a,"-Level"]})]}),o&&!r?s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"Loading depth..."}):r?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 text-[10px] text-muted-foreground font-medium mb-1",children:[s.jsx("span",{className:"text-right",children:"Bid Qty"}),s.jsx("span",{className:"text-center",children:"Bid"}),s.jsx("span",{className:"text-center",children:"Ask"}),s.jsx("span",{children:"Ask Qty"})]}),Array.from({length:Math.max(r.bids?.length??0,r.asks?.length??0)}).map((l,c)=>{const p=r.bids?.[c],x=r.asks?.[c],f=Math.max(...r.bids?.map(y=>y.quantity)??[0],...r.asks?.map(y=>y.quantity)??[0]);return s.jsxs("div",{className:"grid grid-cols-[1fr_60px_60px_1fr] gap-0.5 items-center",children:[s.jsx("div",{className:"flex items-center justify-end",children:s.jsx("div",{className:"relative h-4 w-full",children:p&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute right-0 top-0 h-full bg-green-500/20 rounded-l",style:{width:`${f>0?p.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute right-1 top-0 h-full flex items-center text-[10px] tabular-nums text-green-600",children:p.quantity.toLocaleString()})]})})}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-green-500",children:p?.price.toFixed(2)??"--"}),s.jsx("span",{className:"text-center text-[10px] font-mono tabular-nums text-red-500",children:x?.price.toFixed(2)??"--"}),s.jsx("div",{className:"flex items-center",children:s.jsx("div",{className:"relative h-4 w-full",children:x&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-0 h-full bg-red-500/20 rounded-r",style:{width:`${f>0?x.quantity/f*100:0}%`}}),s.jsx("span",{className:"absolute left-1 top-0 h-full flex items-center text-[10px] tabular-nums text-red-600",children:x.quantity.toLocaleString()})]})})})]},c)})]}),i&&s.jsxs("div",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("div",{className:"text-[10px] font-medium text-muted-foreground uppercase",children:"Analytics"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid/Ask Ratio"}),s.jsx("span",{className:`font-bold tabular-nums ${i.bidAskRatio>1?"text-green-500":"text-red-500"}`,children:i.bidAskRatio.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Spread"}),s.jsx("span",{className:`font-bold tabular-nums ${i.spread<2?"text-green-500":i.spread<5?"text-yellow-500":"text-red-500"}`,children:i.spread.toFixed(2)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Imbalance"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-16 h-2 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full ${i.imbalanceScore>0?"bg-green-500":"bg-red-500"}`,style:{width:`${Math.abs(i.imbalanceScore)}%`,marginLeft:i.imbalanceScore<0?`${100-Math.abs(i.imbalanceScore)}%`:"50%"}})}),s.jsxs("span",{className:`text-[10px] font-bold tabular-nums ${i.imbalanceScore>0?"text-green-500":"text-red-500"}`,children:[i.imbalanceScore>0?"+":"",i.imbalanceScore.toFixed(0),"%"]})]})]}),i.largestBidWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Bid Wall"}),s.jsxs("span",{className:"text-green-500 font-mono text-[10px]",children:[i.largestBidWall.qty.toLocaleString()," @ ",i.largestBidWall.price.toFixed(2)]})]}),i.largestAskWall&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Ask Wall"}),s.jsxs("span",{className:"text-red-500 font-mono text-[10px]",children:[i.largestAskWall.qty.toLocaleString()," @ ",i.largestAskWall.price.toFixed(2)]})]}),s.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[s.jsxs("span",{className:"text-green-500",children:["Total Bid: ",i.totalBidQty.toLocaleString()]}),s.jsxs("span",{className:"text-red-500",children:["Total Ask: ",i.totalAskQty.toLocaleString()]})]})]}),s.jsxs("div",{className:"border-t pt-2 flex items-center justify-between text-[10px]",children:[s.jsxs("span",{children:["LTP: ",s.jsx("span",{className:"font-bold",children:r.ltp?.toFixed(2)})]}),s.jsxs("span",{children:["Vol: ",s.jsx("span",{className:"font-bold",children:r.volume?.toLocaleString()})]}),s.jsxs("span",{children:["OI: ",s.jsx("span",{className:"font-bold",children:r.oi?.toLocaleString()})]})]})]}):s.jsx("div",{className:"text-muted-foreground text-center py-4",children:"No depth data"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:s.jsx("span",{className:"text-xs text-muted-foreground",children:"Select a strike to view depth"})})}const Yn=500;function bi(){const e=u.useRef([]),t=u.useCallback(l=>{const c={...l,id:`t-${Date.now()}-${Math.random().toString(36).slice(2,6)}`};return e.current.push(c),e.current.length>Yn&&(e.current=e.current.slice(-Yn)),c},[]),n=u.useCallback(()=>[...e.current],[]),r=u.useCallback(l=>e.current.slice(-l),[]),i=u.useCallback(()=>{e.current=[]},[]),a=u.useCallback(()=>JSON.stringify(e.current,null,2),[]),o=u.useCallback(()=>{const l=e.current;if(l.length===0)return{count:0,winRate:0,avgPnl:0,totalPnl:0,bestTrade:0,worstTrade:0};const c=l.filter(y=>y.pnl!==void 0),p=c.filter(y=>(y.pnl??0)>0),x=c.reduce((y,N)=>y+(N.pnl??0),0),f=c.map(y=>y.pnl??0);return{count:l.length,winRate:c.length>0?p.length/c.length*100:0,avgPnl:c.length>0?x/c.length:0,totalPnl:x,bestTrade:f.length>0?Math.max(...f):0,worstTrade:f.length>0?Math.min(...f):0}},[]);return{logTrade:t,getTrades:n,getRecentTrades:r,clearTrades:i,exportAsJSON:a,getStats:o}}function vi({liveOpenPnl:e,isLivePnl:t=!1}){const n=j(C=>C.sessionPnl),r=j(C=>C.tradeCount),i=j(C=>C.paperMode),a=i?n:e??n,o=Is(),{getStats:l}=bi(),c=l(),[p,x]=u.useState(5e3),[f,y]=u.useState(500),[N,g]=u.useState(50),[h,b]=u.useState(3),P=a<0&&Math.abs(a)>=p;return s.jsxs("div",{className:"p-2 space-y-3 text-xs",children:[s.jsxs("section",{className:"space-y-1.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Market Clock"}),s.jsx("span",{className:"font-mono text-sm font-bold tabular-nums",children:o.currentTime})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Status"}),s.jsx(ve,{variant:o.isOpen?"default":"secondary",className:"text-[10px] h-4",children:o.isOpen?"OPEN":"CLOSED"})]}),o.currentZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Zone"}),s.jsx("span",{className:"font-medium",children:o.currentZone.label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Sensitivity"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-12 h-1.5 bg-muted rounded overflow-hidden",children:s.jsx("div",{className:`h-full rounded ${o.sensitivity>=1.5?"bg-red-500":o.sensitivity>=1?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,o.sensitivity*50)}%`}})}),s.jsxs("span",{className:"tabular-nums",children:[o.sensitivity.toFixed(1),"x"]})]})]}),o.nextZone&&s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Next Zone"}),s.jsxs("span",{children:[o.nextZone.label," ",s.jsxs("span",{className:"text-muted-foreground",children:["in ",o.minutesToNext,"m"]})]})]}),o.isExpiryDay&&s.jsx(ve,{variant:"destructive",className:"text-[10px] h-4",children:"EXPIRY DAY"})]}),s.jsxs("section",{className:"border-t pt-2 space-y-2",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Risk Limits"}),P&&s.jsx("div",{className:"p-1.5 bg-red-500/10 border border-red-500/30 rounded text-red-500 font-medium",children:"Daily loss limit reached! Trading disabled."}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Daily Loss Limit"}),s.jsx(Xe,{type:"number",value:p,onChange:C=>x(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Max Loss Per Trade (pts)"}),s.jsx(Xe,{type:"number",value:f,onChange:C=>y(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Profit Protection (%)"}),s.jsx(Xe,{type:"number",value:N,onChange:C=>g(Number(C.target.value)||0),className:"h-6 text-xs"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Fe,{className:"text-[10px]",children:"Cooling Off After N Losses"}),s.jsx(Xe,{type:"number",value:h,onChange:C=>b(Number(C.target.value)||0),className:"h-6 text-xs"})]})]}),s.jsxs("section",{className:"border-t pt-2 space-y-1.5",children:[s.jsx("span",{className:"font-medium text-foreground",children:"Session Stats"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Trades Today"}),s.jsx("span",{className:"font-bold",children:r})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Session P&L"}),s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsxs("span",{className:`font-bold tabular-nums ${a>0?"text-green-500":a<0?"text-red-500":""}`,children:[a>=0?"+":"",a.toFixed(0)]}),!i&&s.jsx("span",{className:`text-[10px] ${t?"text-green-500":"text-muted-foreground"}`,children:t?"LIVE":"REST"})]})]}),c.count>0&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),s.jsxs("span",{className:"font-bold",children:[c.winRate.toFixed(0),"%"]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Avg P&L"}),s.jsxs("span",{className:`font-bold tabular-nums ${c.avgPnl>0?"text-green-500":c.avgPnl<0?"text-red-500":""}`,children:[c.avgPnl>=0?"+":"",c.avgPnl.toFixed(0)]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Best / Worst"}),s.jsxs("span",{children:[s.jsxs("span",{className:"text-green-500",children:["+",c.bestTrade.toFixed(0)]})," / ",s.jsx("span",{className:"text-red-500",children:c.worstTrade.toFixed(0)})]})]})]})]})]})}const Si=[{id:"manual",label:"Manual"},{id:"auto",label:"Auto"},{id:"risk",label:"Risk"},{id:"depth",label:"Depth"},{id:"orders",label:"Orders"}];function ji({liveOpenPnl:e,isLivePnl:t=!1}){const n=j(i=>i.controlTab),r=j(i=>i.setControlTab);return s.jsxs("div",{className:"flex flex-col h-full bg-card",children:[s.jsx("div",{className:"flex items-center gap-0.5 px-1.5 py-1 border-b shrink-0",children:Si.map(i=>s.jsx("button",{type:"button",onClick:()=>r(i.id),className:`px-2 py-1 text-xs rounded-sm transition-colors ${n===i.id?"text-foreground bg-accent font-medium":"text-muted-foreground hover:text-foreground hover:bg-accent/50"}`,children:i.label},i.id))}),s.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[n==="manual"&&s.jsx(si,{}),n==="auto"&&s.jsx(mi,{}),n==="risk"&&s.jsx(vi,{liveOpenPnl:e,isLivePnl:t}),n==="depth"&&s.jsx(yi,{}),n==="orders"&&s.jsx(xi,{})]})]})}const Ni=[{key:"B",description:"Buy on active side (CE/PE)"},{key:"S",description:"Sell on active side"},{key:"R",description:"Reversal (close + enter opposite)"},{key:"C",description:"Close active side position"},{key:"X",description:"Close ALL positions"},{key:"W",description:"Toggle floating trade widget"},{key:"Tab",description:"Toggle active side (CE  PE)"},{key:"1",description:"Set quantity to 1 lot"},{key:"2",description:"Set quantity to 2 lots"},{key:"3",description:"Set quantity to 3 lots"},{key:"?",description:"Toggle this help overlay"},{key:"Esc",description:"Close this overlay"}];function Pi({open:e,onClose:t}){return u.useEffect(()=>{if(!e)return;const n=r=>{r.key==="Escape"&&(r.preventDefault(),t())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[e,t]),e?s.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",onClick:t,children:s.jsxs("div",{className:"bg-card border rounded-lg shadow-xl p-4 max-w-sm w-full mx-4",onClick:n=>n.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-bold",children:"Keyboard Shortcuts"}),s.jsx("button",{type:"button",onClick:t,className:"text-muted-foreground hover:text-foreground text-xs",children:"ESC"})]}),s.jsx("div",{className:"space-y-1",children:Ni.map(({key:n,description:r})=>s.jsxs("div",{className:"flex items-center gap-3 py-0.5",children:[s.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted rounded text-xs font-mono min-w-[2.5rem] text-center shrink-0",children:n}),s.jsx("span",{className:"text-xs text-muted-foreground",children:r})]},n))}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-3 border-t pt-2",children:"Hotkeys are disabled when typing in input fields. Click on CE/PE chart to set active side."})]})}):null}function wi(e={}){const t=j(m=>m.hotkeysEnabled),n=j(m=>m.activeSide),r=j(m=>m.selectedCESymbol),i=j(m=>m.selectedPESymbol),a=j(m=>m.optionExchange),o=j(m=>m.quantity),l=j(m=>m.lotSize),c=j(m=>m.product),p=j(m=>m.orderType),x=j(m=>m.limitPrice),f=j(m=>m.setLimitPrice),y=j(m=>m.tpPoints),N=j(m=>m.slPoints),g=j(m=>m.setPendingEntryAction),h=j(m=>m.paperMode),b=Z(m=>m.setVirtualTPSL),P=Z(m=>m.getTPSLForSymbol),C=Z(m=>m.removeVirtualTPSL),M=Z(m=>m.triggerOrders),k=Z(m=>m.removeTriggerOrder),F=j(m=>m.toggleActiveSide),V=j(m=>m.toggleFloatingWidget),T=j(m=>m.setQuantity),K=ge(m=>m.apiKey),R=ge(m=>m.setApiKey),I=u.useCallback(()=>n==="CE"?r:i,[n,r,i]),z=u.useCallback(async()=>{if(K)return K;try{const v=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(v.status==="success"&&v.api_key)return R(v.api_key),v.api_key}catch(m){console.error("[Scalping] Failed to fetch API key:",m)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[K,R]),w=u.useCallback(async m=>{const v=I();if(!v){console.warn("[Scalping] No symbol selected  click a strike first");return}if(p==="TRIGGER"){const d=Object.values(M).find($=>$.symbol===v&&$.exchange===a&&$.side===n);d&&k(d.id),f(null),g(m),console.log(`[Scalping] TRIGGER armed (${m})  click chart to place trigger line`);return}if(p==="LIMIT"&&!x){g(m),console.log(`[Scalping] LIMIT armed (${m})  click chart to set limit line`);return}if(h){if(console.log(`[Paper] ${m} ${n} ${v} qty=${o*l} @ ${p}`),p==="MARKET"){const d=await it({symbol:v,exchange:a});if(d>0){const $=P(v);$&&C($.id),b(Je({symbol:v,exchange:a,side:n,action:m,entryPrice:d,quantity:o*l,tpPoints:y,slPoints:N}))}}return}const W=await z();if(!W)return;const A=p==="LIMIT"?"LIMIT":"MARKET",O={apikey:W,strategy:"Scalping",exchange:a,symbol:v,action:m,quantity:o*l,pricetype:A,product:c,price:p==="LIMIT"&&x?x:0,trigger_price:0,disclosed_quantity:0};try{console.log(`[Scalping] Placing ${m} ${v} qty=${o*l} ${A}`);const d=await fe.placeOrder(O);if(d.status==="success"){if(console.log(`[Scalping] Order placed: ${m} ${v} id=${d.data?.orderid}`),g(null),A==="MARKET"){const $=await it({symbol:v,exchange:a,apiKey:W});if($>0){const _=P(v);_&&C(_.id),b(Je({symbol:v,exchange:a,side:n,action:m,entryPrice:$,quantity:o*l,tpPoints:y,slPoints:N}))}}}else console.error("[Scalping] Order rejected:",d)}catch(d){console.error("[Scalping] Order failed:",d)}},[I,n,o,l,a,c,p,x,y,N,h,P,C,M,z,b,k,f,g]);u.useEffect(()=>{if(!t)return;const m=v=>{const W=v.target?.tagName;if(W==="INPUT"||W==="TEXTAREA"||W==="SELECT")return;const A=I();switch(v.key.toLowerCase()){case"b":{v.preventDefault(),A&&(w("BUY"),e.onBuy?.(n,A));break}case"s":{v.preventDefault(),A&&(w("SELL"),e.onSell?.(n,A));break}case"c":{v.preventDefault(),A&&e.onClose?.(n,A);break}case"x":{v.preventDefault(),e.onCloseAll?.();break}case"r":{v.preventDefault(),A&&e.onReversal?.(n,A);break}case"w":{v.preventDefault(),V();break}case"tab":{v.preventDefault(),F();break}case"1":{v.preventDefault(),T(1);break}case"2":{v.preventDefault(),T(2);break}case"3":{v.preventDefault(),T(3);break}case"?":{v.preventDefault(),e.onToggleHelp?.();break}}};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[t,n,I,w,F,V,T,e])}const Ci=300,Zn=2e3,Xn=15,Qn=8e3,Jn=15e3;function Le(e,t=0){if(typeof e=="number")return Number.isFinite(e)?e:t;if(typeof e=="string"&&e.trim().length>0){const n=Number(e);return Number.isFinite(n)?n:t}return t}function Gt(e,t){if(!e||typeof e!="object")return null;const n=e[t],r=Le(n,Number.NaN);return Number.isFinite(r)?r:null}function Ti(e,t,n){if(!e.length)return null;const r=e.find(l=>l.strike===t);if(r)return r;const i=Number.isFinite(n)&&n>0?n:t;let a=e[0],o=Math.abs(e[0].strike-i);for(let l=1;l<e.length;l++){const c=Math.abs(e[l].strike-i);c<o&&(a=e[l],o=c)}return a}function Ei(e){return Le(e.ce?.oi,0)+Le(e.pe?.oi,0)}function ki(e){return[...e].map(t=>({strike:t.strike,score:Math.abs(Le(Gt(t,"net_gex"),0))||Ei(t)})).filter(t=>Number.isFinite(t.strike)&&t.score>0).sort((t,n)=>n.score-t.score).slice(0,5).map(t=>t.strike)}function Li(e,t){if(!e.length)return t;let n=t,r=Number.POSITIVE_INFINITY;for(const i of e){const a=i.strike;let o=0;for(const l of e){const c=l.strike,p=Le(l.ce?.oi,0),x=Le(l.pe?.oi,0);a>c?o+=(a-c)*p:a<c&&(o+=(c-a)*x)}o<r&&(r=o,n=a)}return n}function Mi(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function es(e,t){return!e||Math.abs(e.pcr-t.pcr)>=.01||Math.abs(e.maxPainStrike-t.maxPainStrike)>=1||Math.abs(e.spotVsMaxPain-t.spotVsMaxPain)>=1||Math.abs(e.straddlePrice-t.straddlePrice)>=.1||Math.abs(e.netGEX-t.netGEX)>=1||Math.abs(e.ceIV-t.ceIV)>=.1||Math.abs(e.peIV-t.peIV)>=.1||Math.abs(e.ivPercentile-t.ivPercentile)>=.5||!Mi(e.topGammaStrikes,t.topGammaStrikes)}function ts(e,t){const n=Gt(e,"iv");return n!=null&&n>0?n:t}function Ri(e){return e.replace(/-/g,"").toUpperCase()}function ns(e,t,n){const r=Array.isArray(e.chain)?e.chain:[];if(!r.length)return null;const i=Le(e.underlying_ltp,0),a=Le(e.atm_strike,0),o=Ti(r,a,i),l=r.reduce((V,T)=>(V.ceOi+=Le(T.ce?.oi,0),V.peOi+=Le(T.pe?.oi,0),V.ceVol+=Le(T.ce?.volume,0),V.peVol+=Le(T.pe?.volume,0),V),{ceOi:0,peOi:0,ceVol:0,peVol:0}),c=l.ceOi>0?l.peOi/l.ceOi:1,p=Li(r,o?.strike??a),x=i-p,f=ki(r),y=Gt(e,"total_net_gex"),N=y??0,g=t?.ceIV??Xn,h=t?.peIV??Xn,b=ts(o?.ce,g),P=ts(o?.pe,h),C=(b+P)/2,M=b-P,k=Gt(e,"iv_percentile")??t?.ivPercentile??50,F=Le(o?.ce?.ltp,0)+Le(o?.pe?.ltp,0);return{pcr:c,oiChangeCE:l.ceOi,oiChangePE:l.peOi,maxPainStrike:p,spotVsMaxPain:x,topGammaStrikes:f,gexFlipZones:[],netGEX:N,atmIV:C,ivPercentile:k,ceIV:b,peIV:P,ivSkew:M,straddlePrice:F,lastUpdated:n>0?n:Date.now()}}function $i(){const e=ge(h=>h.apiKey),t=j(h=>h.underlying),n=j(h=>h.expiry),r=j(h=>h.indexExchange),i=j(h=>h.chainStrikeCount),a=j(h=>h.optionChainData),o=j(h=>h.optionChainLastUpdate),l=j(h=>h.optionChainIsStreaming),c=q(h=>h.optionsContext),p=q(h=>h.setOptionsContext),x=u.useRef(0),f=u.useRef(!1),y=u.useRef(0),N=u.useRef(null);u.useEffect(()=>{if(!a||!Array.isArray(a.chain)||a.chain.length===0)return;const h=Date.now();if(h-x.current<Ci)return;const b=ns(a,c,o||h);if(!b)return;const P=es(c,b),C=!c||h-c.lastUpdated>=Zn;!P&&!C||(p(b),x.current=h)},[a,o,c,p]);const g=u.useCallback(async()=>{if(f.current||!e||!t||!n||!r)return;const h=Date.now();if(!(h-y.current<Jn||a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||h-(o||0)<=Qn))){f.current=!0,y.current=h;try{const P=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:e,underlying:t,exchange:r,expiry_date:Ri(n),strike_count:i})});if(!P.ok)return;const C=await P.json();if(C.status!=="success"||!Array.isArray(C.chain)||C.chain.length===0)return;const M=ns(C,c,Date.now());if(!M)return;const k=es(c,M),F=!c||Date.now()-c.lastUpdated>=Zn;if(!k&&!F)return;p(M),x.current=Date.now()}catch{}finally{f.current=!1}}},[e,t,n,r,i,a,l,o,c,p]);u.useEffect(()=>{if(!!a&&Array.isArray(a.chain)&&a.chain.length>0&&(l||Date.now()-(o||0)<=Qn)){N.current&&(clearInterval(N.current),N.current=null);return}return g(),N.current&&clearInterval(N.current),N.current=setInterval(()=>{g()},Jn),()=>{N.current&&(clearInterval(N.current),N.current=null)}},[a,l,o,g])}function Ai(e,t){if(e.length<2)return{direction:"flat",count:0,velocity:0};const n=e.slice(-Math.max(t.entryMomentumCount,2));let r=0,i=0;for(let l=1;l<n.length;l++)n[l]>n[l-1]?r++:n[l]<n[l-1]&&i++;const a=r>i?"up":i>r?"down":"flat",o=n.length>=2?Math.abs(n[n.length-1]-n[0]):0;return{direction:a,count:Math.max(r,i),velocity:o}}function Oi(e,t){if(e.length<t.regimeDetectionPeriod)return"UNKNOWN";const n=e.slice(-t.regimeDetectionPeriod),r=n.map(p=>p.high),i=n.map(p=>p.low),a=Math.max(...r)-Math.min(...i),o=n.map(p=>p.close),l=Math.abs(o[o.length-1]-o[0]),c=n.reduce((p,x)=>p+(x.high-x.low),0)/n.length;return a<t.rangingThresholdPts?"RANGING":l>a*.6?"TRENDING":c>a*.15?"VOLATILE":"RANGING"}function Ii(e,t,n){if(e.length<n)return!1;const r=e.slice(-n);return Math.max(...r)-Math.min(...r)<t}function Fi(e,t){let n=0;e.ema9!==null&&e.ema21!==null&&(e.ema9>e.ema21?n+=1:n-=1),e.rsi!==null&&(e.rsi>60?n+=1:e.rsi<40&&(n-=1));const r=n*t.indexBiasWeight,i=r>.3?"bullish":r<-.3?"bearish":"neutral";return{score:r,direction:i}}function zi(e,t,n){return!n.optionsContextEnabled||!t?{allowed:!0,reason:"Context disabled"}:e==="CE"&&t.pcr>n.pcrBearishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too high for CE buy`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{allowed:!1,reason:`PCR ${t.pcr.toFixed(2)} too low for PE buy`}:Math.abs(t.spotVsMaxPain)<n.maxPainProximityFilter?{allowed:!1,reason:`Too close to max pain (${t.spotVsMaxPain.toFixed(0)} pts)`}:n.gexWallFilterEnabled&&t.topGammaStrikes.length>0&&t.netGEX>100?{allowed:!1,reason:`High positive GEX (${t.netGEX.toFixed(0)}) - mean reversion likely`}:{allowed:!0,reason:"Context OK"}}function Di(e,t,n){if(!n.optionsContextEnabled||!t)return e;let r=e;return t.atmIV>20&&(r*=1+(t.atmIV-20)*.02),Math.abs(t.spotVsMaxPain)<100&&(r*=.85),Math.max(2,Math.round(r*10)/10)}function Vi(e,t,n){if(!n.optionsContextEnabled||!t)return{exit:!1,reason:""};if(n.ivSpikeExitEnabled){const r=e==="CE"?t.ceIV:t.peIV;if(r>n.ivSpikeThreshold)return{exit:!0,reason:`IV spike: ${r.toFixed(1)}% (threshold: ${n.ivSpikeThreshold}%)`}}return e==="CE"&&t.pcr>n.pcrBearishThreshold?{exit:!0,reason:`PCR flipped bearish: ${t.pcr.toFixed(2)}`}:e==="PE"&&t.pcr<n.pcrBullishThreshold?{exit:!0,reason:`PCR flipped bullish: ${t.pcr.toFixed(2)}`}:{exit:!1,reason:""}}function Bi(e,t,n,r){if(!r.imbalanceFilterEnabled)return{allowed:!0,reason:"Imbalance filter off"};if(e<=0||t<=0)return{allowed:!0,reason:"No depth data"};const i=n==="CE"?e/t:t/e;return i<r.imbalanceThreshold?{allowed:!1,reason:`Depth imbalance ${i.toFixed(2)} < ${r.imbalanceThreshold} (${n==="CE"?"weak bid":"weak ask"})`}:{allowed:!0,reason:"Depth OK"}}function _i(e,t,n,r,i,a,o,l,c,p,x,f=[]){let y=0;const N=[],g=Date.now(),h=[],b=x&&x.totalBid>0&&x.totalAsk>0?e==="CE"?x.totalBid/x.totalAsk:x.totalAsk/x.totalBid:null,P=n.respectHotZones?c:1,C=Math.max(.1,P*Math.max(.1,n.sensitivityMultiplier)),M=n.entryMinScore/C,k=($,_,D,G)=>{h.push({id:$,label:_,pass:D,value:G})},F=($,_)=>({enter:!1,reason:$,score:y,minScore:Number(M.toFixed(2)),checks:h,blockedBy:_,spread:p,depthRatio:b,expectedSlippage:Math.max(0,p/2)}),V=r.tradesCount<n.maxTradesPerDay;if(k("daily-trades","Daily trade cap",V,`${r.tradesCount}/${n.maxTradesPerDay}`),!V)return F("Max daily trades reached","daily-trades");const T=!(r.realizedPnl<0&&Math.abs(r.realizedPnl)>=n.maxDailyLoss);if(k("daily-loss","Daily loss limit",T,`${r.realizedPnl.toFixed(0)}/${-n.maxDailyLoss}`),!T)return F("Daily loss limit reached","daily-loss");const K=r.consecutiveLosses<n.coolingOffAfterLosses;if(k("cooling-off","Consecutive-loss cooling off",K,`${r.consecutiveLosses}/${n.coolingOffAfterLosses}`),!K)return F(`Cooling off (${r.consecutiveLosses} losses)`,"cooling-off");const R=!r.killSwitch;if(k("kill-switch","Kill switch",R),!R)return F("Kill switch active","kill-switch");const I=!r.sideOpen;if(k("side-open","No open position on side",I),!I)return F(`Position already open on ${e}`,"side-open");const z=r.reEntryCountForSide??0,w=r.lastExitAtForSide??0;if(!n.reEntryEnabled&&z>0)return k("reentry-enabled","Re-entry enabled",!1,"OFF"),F(`Re-entry disabled for ${e}`,"reentry-enabled");if(k("reentry-count","Re-entry cap",n.reEntryMaxPerSide<=0||z<n.reEntryMaxPerSide,`${z}/${n.reEntryMaxPerSide}`),n.reEntryEnabled&&n.reEntryMaxPerSide>0&&z>=n.reEntryMaxPerSide)return F(`Re-entry cap reached for ${e}`,"reentry-count");if(n.reEntryEnabled&&n.reEntryDelaySec>0&&w>0){const $=g-w,_=n.reEntryDelaySec*1e3,D=$>=_;if(k("reentry-delay","Re-entry delay",D,D?`${n.reEntryDelaySec}s`:`${Math.ceil((_-$)/1e3)}s left`),!D)return F(`Re-entry delay active: ${Math.ceil((_-$)/1e3)}s`,"reentry-delay")}if(n.maxPositionSize>0&&(r.requestedLots??0)>n.maxPositionSize)return k("max-position-size","Max position size",!1,`${r.requestedLots}/${n.maxPositionSize}`),F(`Requested lots ${r.requestedLots} exceeds max ${n.maxPositionSize}`,"max-position-size");if(k("max-position-size","Max position size",!0,`${r.requestedLots??0}/${n.maxPositionSize}`),n.perTradeMaxLoss>0&&r.lastTradePnl!=null){const $=r.lastTradePnl>-n.perTradeMaxLoss;if(k("per-trade-loss","Per-trade max loss",$,`${r.lastTradePnl.toFixed(0)}/${-n.perTradeMaxLoss}`),!$)return F("Last trade breached per-trade max loss","per-trade-loss")}else k("per-trade-loss","Per-trade max loss",!0);if(n.minGapMs>0&&r.lastTradeTime>0){const $=g-r.lastTradeTime,_=$>=n.minGapMs;if(k("min-gap","Minimum gap between entries",_,_?`${$}ms`:`${n.minGapMs-$}ms left`),$<n.minGapMs)return F(`Min gap: ${Math.ceil((n.minGapMs-$)/1e3)}s remaining`,"min-gap")}else k("min-gap","Minimum gap between entries",!0);if(k("per-minute-rate","Per-minute trade rate",n.maxTradesPerMinute<=0||r.tradesThisMinute<n.maxTradesPerMinute,`${r.tradesThisMinute}/${n.maxTradesPerMinute}`),n.maxTradesPerMinute>0&&r.tradesThisMinute>=n.maxTradesPerMinute)return F(`Rate limit: ${r.tradesThisMinute}/${n.maxTradesPerMinute} trades/min`,"per-minute-rate");if(n.cooldownAfterLossSec>0&&r.lastLossTime>0){const $=g-r.lastLossTime,_=n.cooldownAfterLossSec*1e3,D=$>=_;if(k("loss-cooldown","Cooldown after loss",D,D?`${n.cooldownAfterLossSec}s`:`${Math.ceil((_-$)/1e3)}s left`),$<_)return F(`Cooldown: ${Math.ceil((_-$)/1e3)}s after loss`,"loss-cooldown")}else k("loss-cooldown","Cooldown after loss",!0);if(x){const $=Bi(x.totalBid,x.totalAsk,e,n);if(k("depth-imbalance","Depth imbalance",$.allowed,$.reason),!$.allowed)return F($.reason,"depth-imbalance")}else k("depth-imbalance","Depth imbalance",!0,"No depth data");if(k("spread","Spread gate",p<=n.entryMaxSpread,`${p.toFixed(2)}/${n.entryMaxSpread}`),p>n.entryMaxSpread)return F(`Spread too wide: ${p.toFixed(1)}`,"spread");const m=n.noTradeZoneEnabled&&Ii(f,n.noTradeZoneRangePts,n.noTradeZonePeriod);if(k("no-trade-zone","No-trade zone filter",!m,n.noTradeZoneEnabled?`${n.noTradeZonePeriod} bars/${n.noTradeZoneRangePts}pts`:"OFF"),m)return F(`No-trade zone (${n.noTradeZonePeriod} candles in ${n.noTradeZoneRangePts} pts range)`,"no-trade-zone");const v=e==="CE"?"up":"down";k("momentum-direction","Momentum alignment",i.direction===v,`${i.direction} x${i.count}`),i.direction===v&&i.count>=n.entryMomentumCount?(y+=3,N.push(`Momentum ${i.direction} x${i.count}`)):i.direction===v&&(y+=1,N.push(`Weak momentum ${i.direction}`)),k("velocity","Velocity threshold",i.velocity>=n.entryMomentumVelocity,`${i.velocity.toFixed(2)}/${n.entryMomentumVelocity}`),i.velocity>=n.entryMomentumVelocity&&(y+=2,N.push(`Velocity ${i.velocity.toFixed(1)}`));let W=!1;a.ema9!==null&&a.ema21!==null&&(W=e==="CE"&&a.ema9>a.ema21||e==="PE"&&a.ema9<a.ema21,W&&(y+=1,N.push("EMA aligned"))),k("ema","EMA alignment",W,a.ema9!=null&&a.ema21!=null?`${a.ema9.toFixed(2)}/${a.ema21.toFixed(2)}`:"NA");let A=!1;a.rsi!==null&&(A=e==="CE"&&a.rsi>50&&a.rsi<80||e==="PE"&&a.rsi<50&&a.rsi>20,A&&(y+=1,N.push(`RSI ${a.rsi.toFixed(0)}`))),k("rsi","RSI alignment",A,a.rsi!=null?a.rsi.toFixed(1):"NA");let O=!1;n.indexBiasEnabled&&(O=e==="CE"&&o.direction==="bullish"||e==="PE"&&o.direction==="bearish",O&&(y+=1,N.push(`Index ${o.direction}`))),k("index-bias","Index bias alignment",n.indexBiasEnabled?O:!0,n.indexBiasEnabled?`${o.direction}`:"OFF");const d=zi(e,l,n);return k("options-context","Options context filter",d.allowed,d.reason),d.allowed?(k("score-gate","Final score gate",y>=M,`${y.toFixed(1)}/${M.toFixed(1)}`),{enter:y>=M,reason:N.join(", ")||"No strong signals",score:y,minScore:Number(M.toFixed(2)),checks:h,spread:p,depthRatio:b,expectedSlippage:Math.max(0,p/2)}):F(d.reason,"options-context")}function Gi(e,t,n,r,i,a,o){const l=i?n-t:t-n,c=i?r-t:t-r,p=Di(a.trailInitialSL,o,a);if(e==="INITIAL"){const f=a.breakevenTriggerPts>0?a.breakevenTriggerPts:a.trailBreakevenTrigger;return l>=f?{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:{newSL:i?t-p:t+p,newStage:"INITIAL"}}return e==="BREAKEVEN"?c>=a.trailLockTrigger?{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:{newSL:t+(i?a.breakevenBuffer:-a.breakevenBuffer),newStage:"BREAKEVEN"}:e==="LOCK"?c>=a.trailStartTrigger?{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?t+a.trailLockAmount:t-a.trailLockAmount,newStage:"LOCK"}:e==="TRAIL"?c>=a.trailTightTrigger?{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}:{newSL:i?r-a.trailStepSize:r+a.trailStepSize,newStage:"TRAIL"}:{newSL:i?r-a.trailTightStep:r+a.trailTightStep,newStage:"TIGHT"}}function qi(e,t,n,r,i,a,o){return!i.enter||i.score<4?null:{id:`ghost-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now(),side:e,action:"BUY",symbol:t,strike:n,score:i.score,reason:i.reason,regime:a,pcr:o}}function ss(e,t){if(e.length<t)return null;const n=2/(t+1);let r=e.slice(0,t).reduce((i,a)=>i+a,0)/t;for(let i=t;i<e.length;i++)r=e[i]*n+r*(1-n);return Number.isFinite(r)?r:null}function Ki(e,t=14){if(e.length<t+1)return null;let n=0,r=0;for(let c=1;c<=t;c++){const p=e[c]-e[c-1];p>0?n+=p:r+=-p}let i=n/t,a=r/t;for(let c=t+1;c<e.length;c++){const p=e[c]-e[c-1],x=p>0?p:0,f=p<0?-p:0;i=(i*(t-1)+x)/t,a=(a*(t-1)+f)/t}if(a===0)return 100;const l=100-100/(1+i/a);return Number.isFinite(l)?l:null}function rs(e){return{ema9:ss(e,9),ema21:ss(e,21),supertrend:null,rsi:Ki(e,14),vwap:null}}function Wi(e){const n=ge(E=>E.apiKey),r=j(E=>E.underlying),i=j(E=>E.indexExchange),a=j(E=>E.selectedCESymbol),o=j(E=>E.selectedPESymbol),l=j(E=>E.optionExchange),c=j(E=>E.quantity),p=j(E=>E.lotSize),x=j(E=>E.product),f=j(E=>E.tpPoints),y=j(E=>E.slPoints),N=j(E=>E.selectedStrike),g=j(E=>E.paperMode),h=q(E=>E.enabled),b=q(E=>E.mode),P=q(E=>E.config),C=q(E=>E.optionsContext),M=q(E=>E.regime),k=q(E=>E.consecutiveLosses),F=q(E=>E.tradesCount),V=q(E=>E.realizedPnl),T=q(E=>E.lastTradePnl),K=q(E=>E.lastTradeTime),R=q(E=>E.tradesThisMinute),I=q(E=>E.lastLossTime),z=q(E=>E.sideEntryCount),w=q(E=>E.sideLastExitAt),m=q(E=>E.replayMode),v=q(E=>E.killSwitch),W=q(E=>E.lockProfitTriggered),A=q(E=>E.setRegime),O=q(E=>E.addGhostSignal),d=q(E=>E.recordTrade),$=q(E=>E.recordAutoEntry),_=q(E=>E.pushDecision),D=q(E=>E.pushExecutionSample),G=Z(E=>E.virtualTPSL),H=Z(E=>E.setVirtualTPSL),U=Z(E=>E.getTPSLForSymbol),le=Z(E=>E.removeVirtualTPSL),J=u.useRef([]),se=u.useRef([]),S=u.useRef([]),B=u.useRef(0),Q=u.useRef(!1),ne=u.useRef({CE:"",PE:""}),X=u.useRef({CE:0,PE:0}),re=u.useRef({CE:{at:0,sig:""},PE:{at:0,sig:""}});u.useEffect(()=>{if(!h||!e)return;const E=Date.now();if(E-B.current<100)return;B.current=E;const ye=a,Ke=o,me=e.get(`${i}:${r}`)?.data?.ltp,Se=ye?e.get(`${l}:${ye}`)?.data?.ltp:void 0,We=Ke?e.get(`${l}:${Ke}`)?.data?.ltp:void 0;me&&(J.current.push(me),J.current.length>300&&(J.current=J.current.slice(-300))),Se&&(se.current.push(Se),se.current.length>300&&(se.current=se.current.slice(-300))),We&&(S.current.push(We),S.current.length>300&&(S.current=S.current.slice(-300)));const{sensitivity:wt}=sn(new Date,!1),gt=C&&E-C.lastUpdated<=2e4?C:null;for(const ae of["CE","PE"]){const be=ae==="CE"?ye:Ke,Ee=ae==="CE"?Se:We,Ue=ae==="CE"?se.current:S.current,ot=Object.values(G).some(we=>we.side===ae);if(!be||!Ee||Ue.length<5)continue;const Tt=Ai(Ue,P),L=rs(Ue),Y=rs(J.current),oe=Fi(Y,P),he=`${l}:${be}`,ue=e.get(he)?.data?.bid_price,ie=e.get(he)?.data?.ask_price,xe=ue&&ie?ie-ue:2,ce=e.get(he)?.data?.depth;let ze;if(ce?.buy?.length&&ce?.sell?.length){const we=ce.buy.reduce((_e,ke)=>_e+(ke.quantity||0),0),je=ce.sell.reduce((_e,ke)=>_e+(ke.quantity||0),0);we>0&&je>0&&(ze={totalBid:we,totalAsk:je})}const qt={consecutiveLosses:k,tradesCount:F,realizedPnl:V,lastTradeTime:K,tradesThisMinute:R,lastLossTime:I,requestedLots:c,sideOpen:ot,lastExitAtForSide:w[ae],reEntryCountForSide:z[ae],lastTradePnl:T,killSwitch:v||W},ee=_i(ae,Ee,P,qt,Tt,L,oe,gt,wt,xe,ze,Ue),yt=`${ee.enter}|${ee.blockedBy??""}|${ee.reason}|${ee.score.toFixed(2)}|${ee.minScore.toFixed(2)}`;(yt!==ne.current[ae]||E-X.current[ae]>=1e3)&&(_({timestamp:E,side:ae,symbol:be,enter:ee.enter,score:ee.score,minScore:ee.minScore,reason:ee.reason,blockedBy:ee.blockedBy,spread:ee.spread,depthRatio:ee.depthRatio,expectedSlippage:ee.expectedSlippage,checks:ee.checks,regime:M}),ne.current[ae]=yt,X.current[ae]=E);const Ae=qi(ae,be,N??0,Ee,ee,M,gt?.pcr);if(Ae){const we=`${be}|${ee.reason}|${ee.score.toFixed(1)}`,je=re.current[ae];(we!==je.sig||E-je.at>=2500)&&(O(Ae),re.current[ae]={at:E,sig:we},Fs.message(`Signal ${ae} ${be.slice(-12)}`,{description:`${ee.score.toFixed(1)} / ${ee.minScore.toFixed(1)} | ${ee.reason}`}))}if(b==="execute"&&!m&&ee.enter&&!Q.current){Q.current=!0;const we="BUY",je=c*p;(async()=>{try{if(!g&&!n)return;if(!g&&n){const He={apikey:n,strategy:"Scalping-Auto",exchange:l,symbol:be,action:we,quantity:je,pricetype:"MARKET",product:x,price:0,trigger_price:0,disclosed_quantity:0},Ye=await fe.placeOrder(He);if(Ye.status!=="success"){D({timestamp:Date.now(),side:ae,symbol:be,spread:ee.spread,expectedSlippage:ee.expectedSlippage,status:"rejected",reason:"Order rejected"});return}console.log(`[AutoTrade] ${we} ${be} id=${Ye.data?.orderid} score=${ee.score}`)}else console.log(`[AutoTrade Paper] ${we} ${ae} ${be} score=${ee.score}`);const ke=await it({symbol:be,exchange:l,preferredPrice:Ee,apiKey:g?null:n});if(ke>0){const He=U(be);He&&le(He.id),H(Je({symbol:be,exchange:l,side:ae,action:we,entryPrice:ke,quantity:je,tpPoints:f,slPoints:y,managedBy:"auto",autoEntryScore:ee.score,autoEntryReason:ee.reason}))}d(0),$(ae),D({timestamp:Date.now(),side:ae,symbol:be,spread:ee.spread,expectedSlippage:Math.max(0,Math.abs((ke>0?ke:Ee)-Ee)),status:"filled",reason:ee.reason}),P.telegramAlertsEntry&&hn.sendBroadcast({message:`[AUTO ENTRY] ${ae} ${be} qty=${je} score=${ee.score.toFixed(1)} reason=${ee.reason}`}).catch(()=>{})}catch(ke){D({timestamp:Date.now(),side:ae,symbol:be,spread:ee.spread,expectedSlippage:ee.expectedSlippage,status:"rejected",reason:"Order request failed"}),console.error("[AutoTrade] Order failed:",ke)}finally{Q.current=!1}})()}}const Ct=J.current.length>=P.regimeDetectionPeriod?J.current:se.current;if(Ct.length>=P.regimeDetectionPeriod){const ae=Ct.slice(-P.regimeDetectionPeriod).map((Ee,Ue,ot)=>({high:Math.max(Ee,ot[Math.max(0,Ue-1)]??Ee),low:Math.min(Ee,ot[Math.max(0,Ue-1)]??Ee),close:Ee})),be=Oi(ae,P);be!==M&&A(be)}},[h,e,b,P,a,o,C,M,k,F,V,K,R,I,T,z,w,m,v,W,n,l,c,p,x,f,y,g,N,O,d,$,_,D,A,G,H,U,le,r,i])}function Ui(e){const t=ge(m=>m.apiKey),n=ge(m=>m.setApiKey),r=j(m=>m.paperMode),i=j(m=>m.optionExchange),a=j(m=>m.product),o=j(m=>m.lotSize),l=j(m=>m.addSessionPnl),c=j(m=>m.incrementTradeCount),p=q(m=>m.config),x=q(m=>m.optionsContext),f=q(m=>m.recordAutoExit),y=q(m=>m.recordTradeOutcome),N=q(m=>m.pushExecutionSample),g=Z(m=>m.virtualTPSL),h=Z(m=>m.triggerOrders),b=Z(m=>m.getTPSLForSymbol),P=Z(m=>m.removeVirtualTPSL),C=Z(m=>m.removeTriggerOrder),M=Z(m=>m.setVirtualTPSL),k=u.useRef(t),F=u.useRef(r),V=u.useRef(i),T=u.useRef(a),K=u.useRef(o);u.useEffect(()=>{k.current=t},[t]),u.useEffect(()=>{F.current=r},[r]),u.useEffect(()=>{V.current=i},[i]),u.useEffect(()=>{T.current=a},[a]),u.useEffect(()=>{K.current=o},[o]);const R=u.useRef(new Set),I=u.useCallback(async()=>{if(k.current)return k.current;try{const v=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(v.status==="success"&&v.api_key)return k.current=v.api_key,n(v.api_key),v.api_key}catch(m){console.error("[Scalping] Failed to fetch API key:",m)}return console.warn("[Scalping] No API key available  generate one at /apikey"),null},[n]),z=u.useCallback(async(m,v,W,A)=>{const O=W==="BUY"?"SELL":"BUY";if(F.current)return console.log(`[Paper TP/SL] ${A}: ${O} ${m} qty=${v}`),!0;const d=await I();if(!d)return!1;const $={apikey:d,strategy:"Scalping",exchange:V.current,symbol:m,action:O,quantity:v,pricetype:"MARKET",product:T.current,price:0,trigger_price:0,disclosed_quantity:0};try{const _=await fe.placeOrder($);if(_.status==="success")return console.log(`[Scalping TP/SL] ${A}: ${O} ${m} id=${_.data?.orderid}`),!0}catch(_){console.error(`[Scalping TP/SL] ${A} order failed:`,_)}return!1},[I]),w=u.useCallback(async(m,v,W)=>{if(F.current)return console.log(`[Paper Trigger] Entry: ${W} ${m} qty=${v}`),!0;const A=await I();if(!A)return!1;const O={apikey:A,strategy:"Scalping",exchange:V.current,symbol:m,action:W,quantity:v,pricetype:"MARKET",product:T.current,price:0,trigger_price:0,disclosed_quantity:0};try{const d=await fe.placeOrder(O);if(d.status==="success")return console.log(`[Scalping Trigger] Entry: ${W} ${m} id=${d.data?.orderid}`),!0}catch(d){console.error("[Scalping Trigger] Entry failed:",d)}return!1},[I]);u.useEffect(()=>{if(!e)return;const m=(v,W,A)=>{R.current.add(v.id);const d=v.action==="BUY"?(W-v.entryPrice)*v.quantity:(v.entryPrice-W)*v.quantity;z(v.symbol,v.quantity,v.action,`${A} at ${W}`).then($=>{$&&(P(v.id),l(d),c(),v.managedBy==="auto"&&(f(v.side,d),y(d),N({timestamp:Date.now(),side:v.side,symbol:v.symbol,spread:0,expectedSlippage:0,status:"exited",reason:A}),p.telegramAlertsExit&&hn.sendBroadcast({message:`[AUTO EXIT] ${v.side} ${v.symbol} pnl=${d.toFixed(0)} reason=${A}`}).catch(()=>{}))),R.current.delete(v.id)})};for(const v of Object.values(g)){const W=`${v.exchange}:${v.symbol}`,O=(e.get(W)??e.get(v.symbol))?.data?.ltp;if(!O||R.current.has(v.id))continue;const d=v.action==="BUY",$=d?(O-v.entryPrice)*v.quantity:(v.entryPrice-O)*v.quantity;if(v.managedBy==="auto"){if(p.perTradeMaxLoss>0&&$<=-p.perTradeMaxLoss){m(v,O,`Per-trade max loss ${p.perTradeMaxLoss}`);continue}const _=Vi(v.side,x,p);if(_.exit){m(v,O,`Options early-exit: ${_.reason}`);continue}}if(v.tpPrice!==null&&(d?O>=v.tpPrice:O<=v.tpPrice)){m(v,O,"TP hit");continue}v.slPrice!==null&&(d?O<=v.slPrice:O>=v.slPrice)&&m(v,O,"SL hit")}for(const v of Object.values(h)){const W=`${v.exchange}:${v.symbol}`,O=(e.get(W)??e.get(v.symbol))?.data?.ltp;if(!O||R.current.has(v.id))continue;(v.direction==="above"?O>=v.triggerPrice:O<=v.triggerPrice)&&(R.current.add(v.id),w(v.symbol,v.quantity,v.action).then($=>{if($&&(C(v.id),c(),O>0)){const _=b(v.symbol);_&&P(_.id),M(Je({symbol:v.symbol,exchange:v.exchange,side:v.side,action:v.action,entryPrice:O,quantity:v.quantity,tpPoints:v.tpPoints,slPoints:v.slPoints,managedBy:"trigger"}))}R.current.delete(v.id)}))}},[e,g,h,z,w,b,P,C,M,l,c,p,x,f,y,N])}function Hi(){const e=q(N=>N.config),t=q(N=>N.optionsContext),n=q(N=>N.setTrailStage),r=q(N=>N.setHighSinceEntry),i=Z(N=>N.virtualTPSL),a=Z(N=>N.updateVirtualTPSL),o=u.useRef(e),l=u.useRef(t),c=u.useRef({}),p=u.useRef({}),x=u.useRef({}),f=u.useRef({});u.useEffect(()=>{o.current=e},[e]),u.useEffect(()=>{l.current=t},[t]);const y=u.useMemo(()=>Object.values(i).filter(N=>N.slPrice!=null),[i]);u.useEffect(()=>{const N=jt.getInstance(),g=new Set(y.map(h=>h.id));for(const[h,b]of Object.entries(f.current))g.has(h)||(b(),delete f.current[h],delete c.current[h],delete p.current[h],delete x.current[h]);for(const h of y)f.current[h.id]||(c.current[h.id]="INITIAL",p.current[h.id]=h.entryPrice,x.current[h.id]=h.slPrice??h.entryPrice,f.current[h.id]=N.subscribe(h.symbol,h.exchange,"LTP",b=>{const P=b.data.ltp;if(!P||P<=0)return;const C=Z.getState().virtualTPSL[h.id];if(!C||C.slPrice==null)return;const M=C.action==="BUY",k=p.current[h.id]??C.entryPrice,F=M?Math.max(k,P):Math.min(k,P);F!==k&&(p.current[h.id]=F,r(F));const V=c.current[h.id]??"INITIAL",T=Gi(V,C.entryPrice,P,F,M,o.current,l.current);T.newStage!==V&&(c.current[h.id]=T.newStage,n(T.newStage));const K=Math.round(T.newSL/.05)*.05,R=C.slPrice,I=x.current[h.id],z=R==null||Math.abs(K-R)>=.05,w=I==null||Math.abs(K-I)>=.05;z&&w&&(x.current[h.id]=K,a(h.id,{slPrice:K}))}));return()=>{}},[y,r,n,a]),u.useEffect(()=>()=>{for(const N of Object.values(f.current))N();f.current={},c.current={},p.current={},x.current={}},[])}function gn(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=Number(e.replace(/,/g,"").trim());return Number.isFinite(t)?t:null}return null}function Qe(e){return gn(e)??0}function Yi(e){const t=(e??"").trim().toUpperCase().match(/(CE|PE)$/);return t?t[1]:null}function Zi(e){const t=gn(e.pnl);if(t!==null)return t;const n=Qe(e.ltp),r=Qe(e.average_price),i=Math.abs(Qe(e.quantity));return(Qe(e.quantity)>0?n-r:r-n)*i}function Xi(){const e=ge(b=>b.apiKey),t=ge(b=>b.setApiKey),[n,r]=u.useState([]),[i,a]=u.useState(!1),o=u.useCallback(async()=>{if(e)return e;try{const P=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(P.status==="success"&&P.api_key)return t(P.api_key),P.api_key}catch{}return null},[e,t]),l=u.useCallback(async()=>{const b=await o();if(!b){a(!1);return}a(!0);try{const P=await fe.getPositions(b);P.status==="success"&&P.data&&r(Array.isArray(P.data)?P.data:[])}catch{}finally{a(!1)}},[o]);u.useEffect(()=>{l();const b=setInterval(l,1e4);return()=>clearInterval(b)},[l]);const{data:c,isLive:p,isPaused:x}=qs(n,{enabled:n.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0}),f=u.useMemo(()=>c.flatMap(b=>{const P=Yi(b.symbol);if(!P)return[];const C=Qe(b.quantity),M=Math.abs(C);if(M===0)return[];const k=Qe(b.ltp),F=Qe(b.average_price),V=C>0,T=V?k-F:F-k,R=gn(b.pnl)??T*M;return[{symbol:b.symbol,exchange:b.exchange,side:P,action:V?"BUY":"SELL",quantity:M,avgPrice:F,ltp:k,pnl:R,pnlPoints:T,product:b.product}]}),[c]),y=u.useMemo(()=>n.some(b=>Qe(b.quantity)!==0),[n]),N=u.useMemo(()=>c.reduce((b,P)=>b+Zi(P),0),[c]),g=u.useCallback(b=>f.find(P=>P.side===b),[f]),h=u.useMemo(()=>n.map(b=>({symbol:b.symbol,exchange:b.exchange})),[n]);return{positions:f,totalPnl:N,isLive:p&&y,isPaused:x,isLoading:i,refetch:l,getPositionForSide:g,positionSymbols:h}}function xa(){const[e,t]=u.useState(!1),n=u.useCallback(()=>t(w=>!w),[]),r=u.useCallback(()=>t(!1),[]),i=j(w=>w.paperMode),a=j(w=>w.underlying),o=j(w=>w.indexExchange),l=j(w=>w.optionExchange),c=j(w=>w.product),p=j(w=>w.quantity),x=j(w=>w.lotSize),f=j(w=>w.selectedCESymbol),y=j(w=>w.selectedPESymbol),N=Z(w=>w.virtualTPSL),g=Z(w=>w.triggerOrders),h=Z(w=>w.clearTriggerOrders),b=q(w=>w.config.imbalanceFilterEnabled),P=q(w=>w.updateRiskState),C=ge(w=>w.apiKey),M=ge(w=>w.setApiKey);u.useEffect(()=>{C||fetch("/api/websocket/apikey",{credentials:"include"}).then(w=>w.json()).then(w=>{w.status==="success"&&w.api_key&&M(w.api_key)}).catch(()=>{})},[C,M]),u.useEffect(()=>{h()},[h]);const k=u.useCallback(async(w,m)=>{if(i){console.log(`[Paper] Close ${w} ${m}`);return}try{await fe.closePosition(m,l,c),console.log(`[Scalping] Closed ${w} ${m}`)}catch(v){console.error("[Scalping] Close failed:",v)}},[i,l,c]),F=u.useCallback(async()=>{if(i){console.log("[Paper] Close all positions");return}try{await fe.closeAllPositions(),console.log("[Scalping] Closed all positions")}catch(w){console.error("[Scalping] Close all failed:",w)}},[i]),V=u.useCallback(async(w,m)=>{if(i){console.log(`[Paper] Reverse ${w} ${m}`);return}if(C)try{await fe.closePosition(m,l,c),await fe.placeOrder({apikey:C,strategy:"Scalping",exchange:l,symbol:m,action:"SELL",quantity:p*x,pricetype:"MARKET",product:c,price:0,trigger_price:0,disclosed_quantity:0}),console.log(`[Scalping] Reversed ${w} ${m}`)}catch(v){console.error("[Scalping] Reversal failed:",v)}},[i,C,l,c,p,x]);wi({onToggleHelp:n,onClose:k,onCloseAll:F,onReversal:V}),$i();const T=u.useMemo(()=>{const w=[];a&&o&&w.push({symbol:a,exchange:o}),f&&w.push({symbol:f,exchange:l}),y&&w.push({symbol:y,exchange:l});for(const v of Object.values(N))w.push({symbol:v.symbol,exchange:v.exchange});for(const v of Object.values(g))w.push({symbol:v.symbol,exchange:v.exchange});const m=new Map;for(const v of w)m.set(`${v.exchange}:${v.symbol}`,v);return Array.from(m.values())},[a,o,f,y,l,N,g]),{data:K}=us({symbols:T,mode:b?"Quote":"LTP",enabled:T.length>0}),{positions:R,totalPnl:I,isLive:z}=Xi();return u.useEffect(()=>{P(I)},[I,P]),Wi(K),Hi(),Ui(K),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx(Cr,{liveOpenPnl:I,isLivePnl:z}),s.jsx("div",{className:"flex-1 min-h-0 min-w-0",children:s.jsxs(tn,{orientation:"horizontal",className:"h-full w-full min-w-0",children:[s.jsx(tt,{defaultSize:"20%",minSize:"12%",maxSize:"36%",children:s.jsx(kr,{})}),s.jsx(Vt,{withHandle:!0,className:"bg-border/70"}),s.jsx(tt,{defaultSize:"50%",minSize:"30%",children:s.jsx(ni,{})}),s.jsx(Vt,{withHandle:!0,className:"bg-border/70"}),s.jsx(tt,{defaultSize:"30%",minSize:"18%",maxSize:"42%",children:s.jsx(ji,{liveOpenPnl:I,isLivePnl:z})})]})}),s.jsx(Lr,{positions:R,totalPnl:I,isLivePnl:z}),s.jsx(Pi,{open:e,onClose:r})]})}export{xa as default};
