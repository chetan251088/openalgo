import{A as H,C as G,E as y,G as d,H as g,w as A,d as W,z as V}from"./index-Dy6kfXgl.js";const U={NIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65},SENSEX:{optionExchange:"BFO",indexExchange:"BSE_INDEX",lotSize:20},BANKNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:30},FINNIFTY:{optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:25}};function Z(t){if(typeof t=="string"){const e=t.toUpperCase();if(e in U)return e}return"NIFTY"}const R=H()(G(t=>({underlying:"NIFTY",expiry:"",expiryWeek:"current",expiries:[],chainStrikeCount:15,optionExchange:"NFO",indexExchange:"NSE_INDEX",lotSize:65,selectedStrike:null,activeSide:"CE",selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,quantity:1,orderType:"MARKET",product:"MIS",tpPoints:8,slPoints:5,trailDistancePoints:2,limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null,paperMode:!0,controlTab:"manual",hotkeysEnabled:!0,showFloatingWidget:!0,floatingWidgetMinimized:!0,chainCollapsed:!1,controlCollapsed:!1,ceWidgetPos:{x:8,y:8},peWidgetPos:{x:8,y:8},chartInterval:60,sessionPnl:0,tradeCount:0,lastOrderAck:null,setUnderlying:e=>{const n=U[e];t({underlying:e,optionExchange:n.optionExchange,indexExchange:n.indexExchange,lotSize:n.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1})},setExpiry:e=>t(n=>n.expiry===e?n:{expiry:e,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setExpiryWeek:e=>t(n=>n.expiryWeek===e?n:{expiryWeek:e}),setExpiries:e=>t(n=>n.expiries.length===e.length&&n.expiries.every((i,s)=>i===e[s])?n:{expiries:e}),setChainStrikeCount:e=>t(n=>{const i=Math.max(5,e);return n.chainStrikeCount===i?n:{chainStrikeCount:i}}),setSelectedStrike:e=>t(n=>n.selectedStrike===e?n:{selectedStrike:e}),setActiveSide:e=>t({activeSide:e}),toggleActiveSide:()=>t(e=>({activeSide:e.activeSide==="CE"?"PE":"CE"})),setSelectedSymbols:(e,n)=>t(i=>i.selectedCESymbol===e&&i.selectedPESymbol===n?i:{selectedCESymbol:e,selectedPESymbol:n}),setOptionChainSnapshot:(e,n,i)=>t(s=>{const r=Number.isFinite(n)?n:Date.now(),o=typeof i=="boolean"?i:s.optionChainIsStreaming;return s.optionChainData===e&&s.optionChainLastUpdate===r&&s.optionChainIsStreaming===o?s:{optionChainData:e,optionChainLastUpdate:r,optionChainIsStreaming:o}}),clearOptionChainSnapshot:()=>t(e=>e.optionChainData===null&&e.optionChainLastUpdate===0&&!e.optionChainIsStreaming?e:{optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1}),setQuantity:e=>t({quantity:Math.max(1,e)}),incrementQuantity:()=>t(e=>({quantity:e.quantity+1})),decrementQuantity:()=>t(e=>({quantity:Math.max(1,e.quantity-1)})),setOrderType:e=>t({orderType:e,...e==="MARKET"?{limitPrice:null,pendingEntryAction:null,pendingLimitPlacement:null}:{}}),setProduct:e=>t({product:e}),setTpPoints:e=>t({tpPoints:Math.max(0,e)}),setSlPoints:e=>t({slPoints:Math.max(0,e)}),setTrailDistancePoints:e=>t({trailDistancePoints:Math.max(0,e)}),setLimitPrice:e=>t(n=>n.limitPrice===e?n:{limitPrice:e}),setPendingEntryAction:e=>t(n=>n.pendingEntryAction===e?n:{pendingEntryAction:e}),setPendingLimitPlacement:e=>t(n=>{if(e===null)return n.pendingLimitPlacement===null?n:{pendingLimitPlacement:null};const i=Array.isArray(e.orderIds)&&e.orderIds.length>0?Array.from(new Set(e.orderIds.map(c=>String(c??"").trim()).filter(c=>c.length>0))):void 0,s=Array.isArray(e.splitLegs)&&e.splitLegs.length>0?e.splitLegs.map(c=>{const f=String(c.orderId??"").trim(),k=Math.max(0,Number(c.quantity)||0);return!f||k<=0?null:{orderId:f,quantity:k}}).filter(c=>c!==null):void 0,r={...e,orderIds:i,splitLegs:s,trailDistancePoints:Math.max(0,Number(e.trailDistancePoints)||0),createdAt:e.createdAt??Date.now()},o=n.pendingLimitPlacement,l=o?.orderIds??[],a=r.orderIds??[],u=o?.splitLegs??[],h=r.splitLegs??[],C=l.length===a.length&&l.every((c,f)=>c===a[f]),E=u.length===h.length&&u.every((c,f)=>c.orderId===h[f].orderId&&c.quantity===h[f].quantity);return o&&o.symbol===r.symbol&&o.side===r.side&&o.action===r.action&&o.orderId===r.orderId&&C&&E&&o.quantity===r.quantity&&o.entryPrice===r.entryPrice&&o.tpPoints===r.tpPoints&&o.slPoints===r.slPoints&&o.trailDistancePoints===r.trailDistancePoints?n:{pendingLimitPlacement:r}}),clearPendingLimitPlacement:()=>t(e=>e.pendingLimitPlacement===null?e:{pendingLimitPlacement:null}),setPaperMode:e=>t(n=>n.paperMode===e?n:{paperMode:e}),setControlTab:e=>t({controlTab:e}),setHotkeysEnabled:e=>t({hotkeysEnabled:e}),setShowFloatingWidget:e=>t({showFloatingWidget:e}),toggleFloatingWidget:()=>t(e=>({showFloatingWidget:!e.showFloatingWidget})),setFloatingWidgetMinimized:e=>t(n=>n.floatingWidgetMinimized===e?n:{floatingWidgetMinimized:e}),toggleFloatingWidgetMinimized:()=>t(e=>({floatingWidgetMinimized:!e.floatingWidgetMinimized})),setChainCollapsed:e=>t({chainCollapsed:e}),setControlCollapsed:e=>t({controlCollapsed:e}),setCeWidgetPos:e=>t({ceWidgetPos:e}),setPeWidgetPos:e=>t({peWidgetPos:e}),setLotSize:e=>t({lotSize:e}),setChartInterval:e=>t({chartInterval:e}),addSessionPnl:e=>t(n=>({sessionPnl:n.sessionPnl+e})),incrementTradeCount:()=>t(e=>({tradeCount:e.tradeCount+1})),setLastOrderAck:e=>t(n=>{if(e===null)return n.lastOrderAck===null?n:{lastOrderAck:null};const i={...e,timestamp:e.timestamp??Date.now()},s=n.lastOrderAck;return s&&s.orderId===i.orderId&&s.broker===i.broker&&s.symbol===i.symbol&&s.action===i.action?n:{lastOrderAck:i}}),clearLastOrderAck:()=>t(e=>e.lastOrderAck===null?e:{lastOrderAck:null}),resetSession:()=>t({sessionPnl:0,tradeCount:0,lastOrderAck:null})}),{name:"openalgo-scalping",partialize:t=>({underlying:t.underlying,expiryWeek:t.expiryWeek,chainStrikeCount:t.chainStrikeCount,quantity:t.quantity,orderType:t.orderType,product:t.product,tpPoints:t.tpPoints,slPoints:t.slPoints,trailDistancePoints:t.trailDistancePoints,paperMode:t.paperMode,hotkeysEnabled:t.hotkeysEnabled,showFloatingWidget:t.showFloatingWidget,floatingWidgetMinimized:t.floatingWidgetMinimized,chartInterval:t.chartInterval,ceWidgetPos:t.ceWidgetPos,peWidgetPos:t.peWidgetPos}),merge:(t,e)=>{const n=t??{},i=Z(n.underlying??e.underlying),s=U[i];return{...e,...n,underlying:i,optionExchange:s.optionExchange,indexExchange:s.indexExchange,lotSize:s.lotSize,selectedStrike:null,selectedCESymbol:null,selectedPESymbol:null,expiry:"",expiries:[],optionChainData:null,optionChainLastUpdate:0,optionChainIsStreaming:!1,lastOrderAck:null}}})),m=2,Q=10,T=2e3,J=4500,Y=700,ee=5e3,P=new Map,M=new Map,te=["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","SENSEX","BANKEX","SENSEX50"];function w(t){const e=String(t??"").toUpperCase();return e==="MIS"||e==="NRML"||e==="CNC"?e:"MIS"}function S(t){return String(t??"").trim().toUpperCase()}function _(t){if(typeof t=="number")return Number.isFinite(t)?t:0;if(typeof t=="string"){const e=Number(t.replace(/,/g,"").trim());return Number.isFinite(e)?e:0}return 0}function x(t){if(typeof t=="number"){if(!Number.isFinite(t))return null;const e=Math.floor(t);return e>0?e:null}if(typeof t=="string"){const e=Number(t.replace(/,/g,"").trim());if(!Number.isFinite(e))return null;const n=Math.floor(e);return n>0?n:null}return null}function v(t,e){return`${S(e)}:${S(t)}`}function I(t){const e=S(t);return e?te.some(n=>e.startsWith(n)):!1}function ne(t,e){const n=x(e?.lotsize);if(n==null||n<m||!(I(t.symbol)||I(e?.symbol)||I(e?.name)))return null;const s=n*Q;return s>=m?s:null}function X(t){const e=R.getState(),n=x(e.lotSize);if(n==null||n<m||!(I(t.symbol)||I(e.underlying)))return null;const s=n*Q;return s>=m?s:null}function ie(t,e){const n=x(e?.lotsize);if(n!=null&&n>0)return n;const i=x(R.getState().lotSize);return i!=null&&i>0&&I(t.symbol)?i:null}function N(t,e,n){const i=ie(t,n);if(i==null||i<=1)return e;const s=Math.floor(e/i)*i;return s>=i?s:i}function se(t){if(!t||typeof t!="object")return null;const e=t,n=S(e.status);if(n&&n!=="SUCCESS")return null;const i=String(e.orderid??"").trim();if(!i)return null;const s=x(e.quantity)??0;return{orderId:i,quantity:s}}function re(t){if(!t||typeof t!="object")return[];const n=t.results;if(!Array.isArray(n))return[];const i=[];for(const s of n){const r=se(s);r&&i.push(r)}return i}function oe(t){if(!t||typeof t!="object")return[];const n=t.results;if(!Array.isArray(n))return[];const i=[];for(const s of n){if(!s||typeof s!="object")continue;const r=s;if(S(r.status)==="SUCCESS")continue;const l=String(r.message??"").trim();l&&i.push(l)}return i}function B(t,e,n){if(!t||typeof t!="object")return{status:"error",message:"Invalid splitorder response"};const i=t;if(String(i.status??"").trim().toLowerCase()==="error")return{status:"error",message:String(i.message??"Split order failed")};const r=re(t);if(r.length===0){const a=oe(t),u=a.length>0?`: ${a[0]}`:"";return{status:"error",message:String(i.message??`Split order returned no successful child orders${u}`)}}const o=r.map(a=>a.orderId),l=o[0];return{status:"success",message:String(i.message??`Split order placed (${r.length} slices of ${e})`),data:{orderid:l},orderid:l,orderids:o,split:!0,split_size:e,split_legs:r,total_quantity:n}}function ae(t){return S(t).startsWith("SCALPING")}function le(t){if(!ae(t.strategy))return!1;const e=Number(t.quantity);if(!Number.isFinite(e)||e<=1)return!1;const n=P.get(v(t.symbol,t.exchange));if(n!=null&&e<=n)return!1;const i=X(t);if(i!=null){const s=N(t,i);if(s>=m&&e<=s)return!1}return!0}async function ce(t){const e=v(t.symbol,t.exchange);if(P.has(e))return P.get(e)??null;const n=X(t),i=Date.now();if((M.get(e)??0)>i){if(n!=null){const r=N(t,n);if(r>=m)return P.set(e,r),r}return null}try{const r={apikey:t.apikey,symbol:t.symbol,exchange:t.exchange};let o;d()?o=await g("execution","symbol",r,"POST",{timeoutMs:Y}):o=(await y.post("/symbol",r,{timeout:Y})).data;const l=x(o.data?.freeze_qty);if(l!=null&&l>=m){const u=N(t,l,o.data);if(u>=m)return M.delete(e),P.set(e,u),u}const a=ne(t,o.data);if(a!=null){const u=N(t,a,o.data);if(u>=m)return M.delete(e),P.set(e,u),u}}catch(r){M.set(e,Date.now()+ee),console.warn("[Scalping] Auto-slice freeze lookup failed; using local fallback if available.",{symbol:t.symbol,exchange:t.exchange,error:r})}if(n!=null){const r=N(t,n);if(r>=m)return M.delete(e),P.set(e,r),r}return null}function b(t){return t==="success"||t==="info"}async function z(){const t=W.getState().apiKey;if(t)return t;try{const n=await(await fetch("/api/websocket/apikey",{credentials:"include"})).json();if(n.status==="success"&&n.api_key)return W.getState().setApiKey(n.api_key),n.api_key}catch{}return null}function ue(t){const e=t.orderid;if(typeof e=="string"&&e.trim().length>0)return e.trim();const n=t.orderids;if(Array.isArray(n)){const r=n.find(o=>typeof o=="string"&&o.trim().length>0);if(typeof r=="string")return r.trim()}const i=t.split_legs;if(Array.isArray(i)){const r=i.find(o=>{if(!o||typeof o!="object")return!1;const l=o.orderId;return typeof l=="string"&&l.trim().length>0});if(r?.orderId)return r.orderId.trim()}const s=t.data?.orderid;return typeof s=="string"&&s.trim().length>0?s.trim():""}function de(t,e){const n=ue(e);if(!n)return;const s=d()?V.getState().executionBroker:W.getState().user?.broker??"unknown";R.getState().setLastOrderAck({orderId:n,broker:String(s).toUpperCase(),symbol:t.symbol,action:t.action,timestamp:Date.now()})}const L={getQuotes:async(t,e,n)=>d()?g("feed","quotes",{apikey:t,symbol:e,exchange:n},"POST",{timeoutMs:T}):(await y.post("/quotes",{apikey:t,symbol:e,exchange:n})).data,getMultiQuotes:async(t,e)=>d()?g("feed","multiquotes",{apikey:t,symbols:e},"POST",{timeoutMs:T}):(await y.post("/multiquotes",{apikey:t,symbols:e})).data,getHistory:async(t,e,n,i,s,r,o="api")=>d()?g("feed","history",{apikey:t,symbol:e,exchange:n,interval:i,start_date:s,end_date:r,source:o},"POST",{timeoutMs:J}):(await y.post("/history",{apikey:t,symbol:e,exchange:n,interval:i,start_date:s,end_date:r,source:o})).data,getDepth:async(t,e,n)=>d()?g("feed","depth",{apikey:t,symbol:e,exchange:n},"POST",{timeoutMs:T}):(await y.post("/depth",{apikey:t,symbol:e,exchange:n})).data,getFunds:async t=>d()?g("execution","funds",{apikey:t}):(await y.post("/funds",{apikey:t})).data,getPositions:async t=>d()?g("execution","positionbook",{apikey:t}):(await y.post("/positionbook",{apikey:t})).data,getOrders:async t=>d()?g("execution","orderbook",{apikey:t}):(await y.post("/orderbook",{apikey:t})).data,getTrades:async t=>d()?g("execution","tradebook",{apikey:t}):(await y.post("/tradebook",{apikey:t})).data,getHoldings:async t=>d()?g("execution","holdings",{apikey:t}):(await y.post("/holdings",{apikey:t})).data,placeOrder:async t=>{let e=null;if(le(t)){const n=await ce(t);if(n!=null&&n>=m&&Number(t.quantity)>n){const i={...t,splitsize:n};try{if(console.info("[Scalping] Auto-slice splitorder route",{symbol:t.symbol,exchange:t.exchange,quantity:Number(t.quantity),splitSize:n}),d()){const s=await g("execution","splitorder",i);e=B(s,n,Number(t.quantity))}else{const s=await y.post("/splitorder",i);e=B(s.data,n,Number(t.quantity))}}catch{console.warn("[Scalping] Auto-slice splitorder failed; falling back to placeorder.",{symbol:t.symbol,exchange:t.exchange,quantity:Number(t.quantity),splitSize:n}),e=null}}}return e==null&&(d()?e=await g("execution","placeorder",t):e=(await y.post("/placeorder",t)).data),e.status==="success"&&de(t,e),e},modifyOrder:async(t,e)=>{if(d()){const i=await z();return i?g("execution","modifyorder",{apikey:i,strategy:"Scalping",orderid:t,symbol:e.symbol,exchange:e.exchange,action:e.action,product:e.product,pricetype:e.pricetype,price:e.price,quantity:e.quantity,disclosed_quantity:e.disclosed_quantity??0,trigger_price:e.trigger_price??0}):{status:"error",message:"Missing API key"}}return(await A.post("/modify_order",{orderid:t,...e})).data},cancelOrder:async t=>{if(d()){const n=await z();return n?g("execution","cancelorder",{apikey:n,strategy:"Scalping",orderid:t}):{status:"error",message:"Missing API key"}}return(await A.post("/cancel_order",{orderid:t})).data},closePosition:async(t,e,n,i)=>{if(d()){const r=await z();if(!r)return{status:"error",message:"Missing API key"};const o=x(i?.knownQuantity),l=S(i?.knownAction);if(o!=null&&(l==="BUY"||l==="SELL")){const p=l==="BUY"?"SELL":"BUY",F=await L.placeOrder({apikey:r,strategy:"Scalping",exchange:e,symbol:t,action:p,quantity:o,pricetype:"MARKET",product:w(n),price:0,trigger_price:0,disclosed_quantity:0});if(b(F.status))return{status:"success",message:"Position closed"}}const a=await L.getPositions(r);if(!b(a.status))return{status:"error",message:a.message??"Failed to fetch positions before close"};const h=(Array.isArray(a.data)?a.data:[]).filter(p=>_(p.quantity)!==0),C=S(t),E=S(e),c=w(n),f=h.filter(p=>S(p.symbol)===C),k=f.filter(p=>S(p.exchange)===E),O=k.filter(p=>w(p.product)===c),D=O.length>0?O:k.length>0?k:f;if(!D.length)return{status:"success",message:"No open position to close"};const K=await Promise.allSettled(D.map(p=>{const F=_(p.quantity),$=Math.abs(F),j=F>0?"SELL":"BUY";return L.placeOrder({apikey:r,strategy:"Scalping",exchange:p.exchange||e,symbol:p.symbol||t,action:j,quantity:$,pricetype:"MARKET",product:w(p.product??n),price:0,trigger_price:0,disclosed_quantity:0})}));let q=0;for(const p of K)(p.status!=="fulfilled"||!b(p.value.status))&&(q+=1);return q>0?{status:"error",message:`Failed to close ${q} position leg(s)`}:{status:"success",message:"Position closed"}}return(await A.post("/close_position",{symbol:t,exchange:e,product:n})).data},closeAllPositions:async t=>{if(d()){const n=await z();if(!n)return{status:"error",message:"Missing API key"};const i=t?.verify!==!1,s=typeof t?.verifyDelayMs=="number"&&Number.isFinite(t.verifyDelayMs)?Math.max(0,Math.floor(t.verifyDelayMs)):120,r=async()=>{const a=await L.getPositions(n);if(!b(a.status))return{status:"error",message:a.message??"Failed to fetch positions before close-all"};const h=(Array.isArray(a.data)?a.data:[]).filter(c=>_(c.quantity)!==0);if(!h.length)return{status:"success",message:"No open positions to close"};const C=await Promise.allSettled(h.map(c=>{const f=_(c.quantity),k=Math.abs(f),O=f>0?"SELL":"BUY";return L.placeOrder({apikey:n,strategy:"Scalping",exchange:c.exchange,symbol:c.symbol,action:O,quantity:k,pricetype:"MARKET",product:w(c.product),price:0,trigger_price:0,disclosed_quantity:0})}));let E=0;for(const c of C)(c.status!=="fulfilled"||!b(c.value.status))&&(E+=1);return E>0?{status:"error",message:`Failed to close ${E} position(s)`}:{status:"success",message:"All positions closed"}};let o="";try{const a=await g("execution","closeposition",{apikey:n,strategy:"Scalping"});if(b(a.status)){if(!i)return{status:"success",message:a.message??"Close-all request submitted"};await new Promise(h=>setTimeout(h,s));const u=await r();return b(u.status)?{status:"success",message:a.message??u.message??"All positions closed"}:u}o=String(a.message??"").trim()}catch(a){a instanceof Error&&(o=a.message)}const l=await r();return b(l.status)?l:o&&l.message?{status:"error",message:`${o}. ${l.message}`}:l}return(await A.post("/close_all_positions",{})).data},cancelAllOrders:async()=>{if(d()){const e=await z();return e?g("execution","cancelallorder",{apikey:e,strategy:"Scalping"}):{status:"error",message:"Missing API key"}}return(await A.post("/cancel_all_orders",{})).data},getScalpingBridgePending:async(t,e=50)=>(await y.post("/scalpingbridge/pending",{apikey:t,limit:e})).data,ackScalpingBridgeEntries:async(t,e)=>{const n=e.map(s=>Number(s)).filter(s=>Number.isInteger(s)&&s>0);return(await y.post("/scalpingbridge/ack",{apikey:t,ids:n})).data}};export{L as t,R as u};
